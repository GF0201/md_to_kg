连续发送出去， 而不需要等待对方的确认。 这样， 信 道利 用率就 提高了。

在讨 论 滑 动 窗 口时， 我们应当注 意 到 ， 图中还有一个时间坐 标 （ 但以后 往 往 省 略 这样
是 指 “ 向着时间增大的方向
向着时

的时间坐标）。 按照习惯，

向前

， 而

则是

向后

“

“

“

“

”

”

间 减少的方向

”
。 分组发送是按照分组序 号从小到大发送的。

分

组

的 序 号

送 窗 口二二I

I

发

I 6  |  7  |  8  |  9  | 1 0 | l l  I 1 2  |

(a)

发

送 窗 口 是 5

送 窗 口 一 向 前
7
5

4

6

发
3

2

8

9
  1 0

1 1

1 2

伽 t

(b) 收 到

个确 认 后

送 窗 口 向 前滑动

发

图 5- 1 2

一
连续 ARQ 协议 的 工 作 原理

连续 A RQ 协 议 规 定 ， 发送方每收到 一个确认， 就把发送窗口向前滑动 一个分组的位置。
图 5-1 2( b )表示发送方 收到了对第 1 个分组的确认， 千是把发送窗 口 向前移动 一个分组的位
置。 如果 原 来 已经发送 了前5个分组， 那么现在就可以发送窗口内 的第 6个分组了。

接收 方 一 (cid:7183) 都 是 采用 累 积 确 认的方 式。 这 就是说， 接收 方 不必对收 到的分组逐个发送
确认， 而是在收到 几个分组后 ， 对按 序 到 达 的 最 后—个分组发送确认， 这 就表示： 到 这个分
组为止的所有分组都 已 正 确 收到了。

累 积确认有优点也有缺点。 优点是 容 易 实现， 即 使确认丢 失也不必重传 ； 但缺点是不

(cid:7126)向发送方及时反 映 接收 方 已 经 正 确收到 所有分组的信 息。

例如， 如果发送方发送了前 5 个分组， 而中间的第 3 个分组丢 失 了。 这 时接收方只(cid:7126)

对前两个分组发出确认。 发送方无法知 道后 面三个分组的下落， 而只好把后 面的三个分组都
再重传一次。 这 就 叫作 Go-back-N （ 回 退 N)， 表示需要再退 回 来 重传已发送过的 N 个分组。
可见当通信线路质 量 不好时， 连续A RQ 协 议会带 来 负 面的影 响。

在深入讨 论 TCP的可靠传输问题之前， 必须先了解 TCP的报文段首部的格式。

5.5  TCP 报文段 的 首 部格式

TCP 虽然 是 面向字(cid:7188)流的， 但 TCP传送的数据单元 却 是 报文 段。 一个
TCP 报 文 段分为首部和数据 两部分， 而 TCP的全部功(cid:7126)都体现在它首部中

各 字段的作用。 因此， 只有弄清 TCP首部各 字段的作用才(cid:7126)掌握 TCP的工

作 原理。 下面讨 论 TCP报 文段的首部格 式。

TCP报文段首部的前 20 个字(cid:7188)是 固定的（ 如图 5- 13 所 示）， 后 面有4n 字(cid:7188)是 根据需要

而增加的选项 ( n 是 整数）。 因此 TCP首部的最小长度是 20 字(cid:7188)。

首部固定部分各 字 段的意 义如下：

(

) 源端 口 和 目 的 端 口

各 占 2个字(cid:7188)， 分别 写入源端口号和目的端口号。 和前面图

5-5 所示的 UDP的分用相 似， TC P 的分用功(cid:7126)也是 通过端口实现的。

( 2) 序号

号 增加到 232 -1 后 ， 下一个序 号 就 又 回 到0 。 也就是 说， 序 号使用 mod 232

占4 字(cid:7188)。 序 号 范 围是 [O, 232 — l ]， 共 232（即4 294  967  296) 个序 号。 序
运算。 TCP是 面

•  225 •

1
向字(cid:7188)流的。 在一个 TCP 连接中传送的字(cid:7188)流 中 的 每 一个字(cid:7195) 都按顺序编号。 整个要传送
的字(cid:7188)流的起始序 号 必须在连接建 立时设置。 首部中的序 号字段值则指的是本报文段所发送
的数据的第 一个字(cid:7188)的序 号 。 例如， 一报文段的序 号 字段值是 30 1, 而携 带的数据共有100
字(cid:7188)。 这 就表明： 本报文 段的数据的第 一个字(cid:7188)的序 号是 30 1, 最后一个字(cid:7188)的序 号 是 400 。
显 然 ， 下 一个报文段（如果还有的话） 的数据序 号 应 当从40 1 开 始 ， 即 下 一个报文 段的序 号
字 段值应为40 1 。 这个字段的名 称也叫作

报文段序号

。

“

”

8

位 0

T: 源 端 口
』偏 移

TCP
首 部 数 据

RU AC SPSR
G K H T N N

检 验 和

保 留

S
Y

序 号

确 认 号
F I

1 6

24

目 的 端 口

3 1

愚

20
固

字
定

节
首

的
部

窗 门

紧 急 拒 针

曹

发 送在前

IP 首 部

IP 数 据 报 的数 据 部 分

图 5- 1 3TCP报 文 段 的 首 部格 式

(3) 确认号

占 4 字(cid:7188) ， 是期望收到对方下 一个报文段 的 第一个数据字(cid:7195) 的序号。 例
如 ， B 正确收到了A 发送过来 的一个报文 段 ， 其序 号字段值是 50 1, 而数据长度是 200 字(cid:7188)
（序 号 501 ~  700) ， 这 表明 B 正 确收到了A 发送的到序 号 700 为止的数据。 因此， B 期 望
收到 A 的下 一 个 数据序号是 70 1, 千是 B 在发送给A 的确认报文 段中把确认号置为 701 。
请 注 意 ， 现在的确认号不是 50 1, 也不是 700, 而是 70 1 。

总 之 ， 应当记住：

若确认号 ＝ N， 则表明： 到 序 号 N - 1 为止的所有数据 都 已 正确收到 。

由千序 号 字段有32 位长 ， 可对4 GB（即4 千 兆字(cid:7188)） 的数据进行编号。 在一 (cid:7183)情况 下

可保证 当 序 号重复使用时 ， 旧 序 号的数据早 已通过网络到达 终 点 了。

(4) 数据偏移

占 4 位 ， 它 指出 TCP报文 段的数据起始处距 离 TCP报文段的起始处

项字段 ， 因此数据偏 移 字段是必要的。 但应 注 意 ， “ 数据偏移

有 多 远 。 这个字 段 实 际上是指出 TCP 报 文 段的首部长度。 由千首部中还有长度不确定的选
＂ 的单位是32位字（即 以4 字
(cid:7188)长 的 字 为计算单位）。 由千4 位二 进制数(cid:7137)够表示的最 大 十 进 制数字是 1 5, 因此数据偏 移
的最大值是 60 字(cid:7188) ， 这 也是 TCP首部的最大长度（即 选 项 长度不(cid:7126)超过40 字(cid:7188)）。

(5) 保 留
占 6位 ， 保 留 为今后使用 ， 但目前应置为0 。
下 面有 6 个控制位 ， 用来说明本报文段 的性 质 ， 它们的意 义 见 下 面的( 6)~(

1)。

( 6) 紧急 U RG ( URGent )

当 U RG =  1 时， 表明紧 急 指 针字段有效。 它告诉 系 统此报

•  226  •

1
文 段中有紧 急 数据 ， 应尽 快传 送 （相当千高优先级的数据 ） ， 而不要按 原 来 的排 队 顺序 传 送 。
例如， 已经发送了很长的一个程序要在远地的主机上运行 。 但后来 发现了一 些问题 ， 需要取
消 该程序的运行 。 因此用户 从键盘发出中断命 令 (C ontrol-C ) 。 如果不使用紧 急数据 ， 那么

这 两个字符将存储在接收 TCP 的缓存末尾 。 只有在所有的数据被 处理完 毕后这 两个字符才

被 交付接收方的应用进程 。 这样做就浪 费了许多时间 。

当 U RG 置1 时 ， 发送应用进程就告诉发送方的 TCP有紧 急数据要传送 。 于是发送方

TCP 就把紧 急数据插入到本报文 段数据的最 前面 ， 而在紧 急数据后面的数据仍是普 通数据 。
这 时要与首部中紧急指针(Urge ntPointe r)字段配合使用 。

然 而在 紧 急指针字段的具 体 实现上 ， 由于过去的有些 文 档 有 错 误或有不太明确的地方 ，
这 就导 (cid:7175)人们对有关的 RFC 文 档 产 生 了 不 同的理解 。 于是 ， 2011 年 公布的建 议 标 准 R FC
60 93, 对紧 急指针字段的使用方法做出了更加明确的解 释 ， 并更新 了 几个重要的 RFC 文 档 ，
如 RFC 793,  RFC 1011 ,  RFC 11 2 2等 。

( 7) 确认AC K (AC Knowle dgme nt)  仅当AC K =1 时确认号字段 才有效。 当AC K =0

时 ， 确认号无效。 TCP规 定 ， 在连接建立后所有传送的报文 段都必须把AC K 置为1 。

( 8) 推送 PSH (PuSH )  当两个应用进程进行交互式的通信 时 ， 有时在一端的应用进程
希 望在键入一个命 令后立即 就(cid:7126)够收到对方的响 应 。 在这种情况下 ， TCP 就可 以使用推送
(pus h)操 作 。 这 时 ， 发送方 TCP 把 PSH 置 l ， 并立即 创 建 一个报文 段发送出去 。 接收方
“ 向前 ） 交付接收应用进程， 而不再等到
TCP收到 PSH =1 的报文 段 ， 就尽 快地 （即

“ 推送

整个缓存都填满了后再向上交付 。

虽 然 应用程序 可 以 选 择推送操 作 ， 但推送操作很少使用。
(9) 复位 RST ( Re Se T)  当 RST =  1时， 表明 TCP连接中出现严重差错 （ 如主机崩 溃
或 其他原 因）， 必须释放连接， 然后再重新 建立运输连接。 将 RST 置为1 还用来 拒 绝一个非
法的报文 段或 拒 绝 打 开一个连接。 RST 也可称为 重 建位或 重置位 。

(10 ) 同 步 SYN (SY N chronization )  在连接建立时用来 同 步序 号 。 当 SY N =1 而AC K
= 0 时 ， 表明这 是一个 连接请 求报 文 段 。 对方若 同 意 建 立 连接 ， 则应在 响 应的报文 段中使
SYN = 1 和AC K =1 。 因此 ， SYN 置为1 就表示这 是 一个连接请求或连接接受报 文 。 关千连
接的建立和释放 ， 在后面的 5.9 (cid:7188)还要进行详细讨 论 。

(11 ) 终止 FI N (FI N  is h, 意 思是 “

完了

” “ 终止 ”

)

用来 释放一个连接。 当 FI N =1 时 ，

表明此报文 段的发送方的数据 已发送完 毕 ， 并要求释放运输连接。

(1 2

) 窗 口

占2 字(cid:7188) 。 窗口值 是 [O, 2 1 6 — l ] 之间的整数 。 窗口指的是发送本报文 段的
一方的接收窗 口 （而不是 (cid:7151) 己的发送窗 口 ） 。 窗口值告诉对方： 从本报文 段首部中的确认号
算起 ， 接收方目前允 许对方发送的数据量（ 以字(cid:7188)为单位 ） 。 之 所 以要有这个限 制 ， 是 因 为

接收方的数据缓 存 空 间 是 有 限 的 。 总 之 ， 窗 口 值 作 为 接 收 方 让 发 送 方 设 置 其 发 送 窗 口 的
依 据 。

：�

＇

字
厂言二：：：一

：；二二勹立

是告
气
间 还可接收 l000 个字(cid:7188)数据 （ 字(cid:7188)序 号 是 701 ~1 700 ) ， 你在给我发送数据 回
息
视 频 讲 解

：飞勹二二

逑

”

时， 必须考虑到 我的接收缓存容最 。

瞿

总之 ， 应当记住：

窗口字段明确指出了现在允 许对方发送的数据量 。 窗口值经常在动 态 变化 着 。

•  22 7 •

(13) 检验和

占 2 字节。 检验和字段检验的范围 包括 首部和数据 这 两部分。 和 UDP
用户 数据 报 一样 ， 在计算检验和时， 要 在 TCP报文 段的前 面加上 12 字节的伪 首部。 伪 首部
的格式与图5-5 中 UDP用户 数据 报的伪 首部一样。 但应把伪 首部第4个字段中的 17 改为6
(TCP的协议号是 6) ， 把第5 字段中的 UDP长 度 改为 TCP长度。 接收方收到此报文段后，

仍要加上这个伪 首部来计 算检验和。 若 使用 1Pv6, 则相应的伪 首部也 要 改变。

(14) 紧急指针

占 2 字节。 紧 急指针仅 在 URG =  1 时才 有意 义 ， 它指出本报 文段中
的紧急 数据 的字节 数（ 紧 急 数据 结束后就是普 通 数据 ）。 因此 ， 紧 急指针指出了紧 急 数据 的
末 尾 在报 文段中的位置。 当所有紧 急 数据 都 处理完时， TCP就告 诉 应用 程序恢 复到正常操
作。 值 得注意的是， 即 使窗 口 为零时也可发送紧 急 数据 。

(15) 选项

长 度 可变 ， 最长可达 40 字节。 当没有 使用 ” 选项” 时， TCP的首部长度

是20 字节。 最后的填 充字段仅仅是为了 使整个 TCP首部长度是4 字节的整 数倍。

TCP最初只规 定了一种选项， 即最大报文段长度 M SS (M axim um  Segm ent  S ize)  [RFC
6691]。 请注意 M SS 这个名 词的含义。 M SS 是每一个 TCP报 文 段中的数据字段的最大长度。
数据 字段加上 TCP首部才等于整个的 TCP报文段。 所以 M SS 并 不是整个 TCP报文 段的最
大长度 ， 而是 “ TCP报 文 段长 度减去 TCP首部长度 ”。

为什么 要规 定一个最大报文段长度 M SS 呢？这 并 不是考 虑 接收方的接收 缓存可能放 不
下 TCP报文 段中的数据 。 实际上 ， M SS 与 接收 窗 口值 没有关 系。 我们知道， TCP报文 段的
数据 部分， 至少 要加上 40 字节的首部 (TCP首部 20 字节 和 IP首部 20 字节 ， 这 里都 还没有
考 虑 首部中的选项部分） ， 才 能组装成一个 IP数据 报。 若 选择较小的 M SS 长 度 ， 网络的利
用率就降低了。 设想 在极端 的情 况 下 ， 当 TCP报 文 段只含 有 1 字节的数据时， 在 IP层传 输
的数据 报的开销至少 有 40 字节（ 包括 TCP报 文 段的首部和 IP数据报的首部）。 这 样 ， 对网
络的利用率就 不会超过 1/41。 到了 数据 链路 层还要加上 一些开销。 但反过来， 若 TCP报文
段非常长 ， 那么 在 IP 层传输时就 有可能 要分解成多个短数据 报片。 在终点 要把收到的各个短
数据 报 片装配成原来的 TCP报文段。 当传输出错时 还 要进行重传。 这些也都会 使开销增大。

因此 ， 从提高网络传输效率考 虑 ， M SS 应尽可能大些， 只要 在 IP层传 输时 不需 要再分

片 就行。 由千 IP数据 报所经历的路径是动 态变化的， 因此 在 某 条 路径上确 定的 不需 要 分片
的M SS, 如果改走另一 条 路径就可能需 要进行分片。 因此最佳的M SS 实际上是很 难确 定的。
在连接建立的过程中 ， 双 方 都把 自 己能够 支持的 M SS 写入这 一字段 ， 以 后就按照这个数值
传送 数据 ， 两个传送方 向 可 以 有 不 同的M SS 值 气 若 主机未填 写 这 一项， 则M SS 的默认值
是536字节 （这个 数值来自 576字节的 IP数据报总长度减去 TCP和 IP的固 定首部）。 因此，
所有互联网上的 主机都应能接受的报 文 段长度是536+ 20（ 固 定首部长度） ＝ 556字节。

随 着互 联网的发 展 ， 又 陆 续增加了 几个选项， 如窗 口 扩大 选项、 时 间 戳 选项等（ 见建
议标准 RFC 7323 )。 以 后又增加了 有关选择确认(SACK) 选项（ 见建议标准 RFC 2018)。 这
些选项的位置都 在图5-13 所 示的选项字段中。

窗 口扩 大 选项是为了扩大 窗 口。 我们知道， TCP首部中窗 口 字段长度是 16位 ， 因此最
大的窗 口大小为 64 KB（ 见下一 节）。 虽 然 这 对早 期的网络是足够用的， 但对千包含卫 星 信

心 注 ： 流 行 的

一

种 说 法 ， 在 TCP 连接 建立阶段

“

双方协商 MSS 值

”

， 但这 是 错 误 的 ， 因 为这 里 并 不 存 在 任 何 的 协 商 ， 而

一

只 是

方把 MSS 值 设 定 好 以 后 再 通 知 另

一

方 而 已 。

•  228 •

道的网络 气 其传播时延 和带 宽 都很大， 要获得高吞 吐率需要更大的窗口大小。

窗口扩大选项 占 3 字(cid:7194) ， 其中有一个字(cid:7194)表示移位值 S。 新的窗口值等千 TCP首部中
1 6 +  S )。 移位值 允 许使用的最大值是1 4 , 相当千窗口最大值增大

的窗口位数从1 6 增大到(
到 i l 6 + 1 4) _  l  =  230 _ 1 。

窗口扩大选项可以在双方初始建 立 TCP 连接时进行协 商。 如果连接的某 一 端 实现了窗

口扩大， 当它不再需要扩大其窗口时 ， 可发送 S = O 的选项， 使窗口大小 回到1 6。

时 间 戳选项 占 10 字(cid:7194) ， 其中最主要的字段是 时 间 戳值字段 (4 字(cid:7194)） 和时间戳 回 送 回

答字段 (4 字(cid:7194)）。 时间 戳选项有以下两个功(cid:7126)：

第 一 ， 用来 计算往返时间 RTT（见后 面的 5.6.2 (cid:7194) ）。 发送方在发送报文 段时把当前时

钟的时间值放入时间戳字段 ， 接收方在确认该报 文 段时把时间戳字段值复制到时间戳回送回

答字段。 因此， 发送方在收到 确认报文后 ， 可以准确 地计算出 RTT。

Agains t  Wrappe d  Se que nce  numbe rs

第 二 ， 用 于处理 TCP 序 号 超过 232 的情况 ， 这 又 称 为 防 止 序 号 绕 回 PAWS (Prote ct
)。 我们知道， TCP 报文 段的序 号只有 32位， 而每增加
232
个序 号 就会 重复使用原 来 用 过的序 号。 当使用高速网络时 ， 在一次 TCP连接的数据传送
中序 号很可(cid:7126)会 被 重 复使用。 例如， 当使用1 .5 Mbit/s 的速率发送报文 段时， 序 号重复要 6
小时以上。 但若用2 .5 Gbit/s 的速率发送报文 段 ， 则不到1 4 秒序 号就会 重复。 为了使接收方

(cid:7126)够把新的报文 段和迟到很久的报文段 区分开 ， 可以在报文 段中加上这种时间 戳。

我们将在后 面的5.6.3 (cid:7194) 介 绍 选择确认选项。

5. 6  TC P 可靠传输 的 实现

本(cid:7194)讨 论 TCP可 靠传输的实现。

我们首先 介 绍以字(cid:7188)为单位的滑 动 窗 口。 为了讲 述可靠传输 原理的方便 ， 我们假 定 数
据传输只在一个 方 向 进行 ， 即 A 发送数据 ， B 给出确认。 这样的好处是使讨 论 限千两个窗

口， 即发送方A 的发送窗口和接收方 B 的接收窗口。 如果再考虑 B 也向A 发送数据 ， 那 么

还要增加A 的接收窗口和 B 的发送窗口， 这样总 共有4 个都不断在变化 大小的窗口。 这 对

讲述可靠传输的原理并没有多少 帮 助 ， 反 而会使问题变得更加烦 琐。

5

．

6

l

以

字

为节

单

位

的

滑

动

口窗

、
、

c
p

T

,

的

滑

窗动

是口

以

字

(cid:7194)

为

位单

。的

为

了

便

说千

明

滑

动

窗

口

的

工

作

原

、

理

，

我

1
1

故

意

把

后

面

图

5

l
4

(cid:7169)

图

－

5

17

中

的

字

(cid:7188)

编

号

都

取

得

很

、

iJ

（

实

际

的

窗

小

多

为

数

千

字

(cid:7194)

儿

I
见

假

定

A

欠
4

到

了

B

发

来

的

石
角

认

报

文

段

，

其

中

窗

口

是

欠L

到
欠L

＿

下

个

字

(cid:7194)

序

号

是

31

（

请

注

的

＿

(cid:7172)
了
1

°）

根

据

这

两

数个

据

A

就

构

口

大
o
字

2

(cid:7194)

，

而

确

认

号

是

3

l
（

这

表

明

B

期

望

组

的

序

号

）

而

(cid:7172)

序
lj

号

3

O

为

止

的

数

据

已

经

送窗口， 如图 5-1 4 所 示。

CD 注 ： 这种信道常称为长粗管道(long fat pipe)。

扫 一扫

颖
二意

•  229  •

