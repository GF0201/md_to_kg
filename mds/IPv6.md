路由器 凡 时， 路由器 R 1 先收下它 ， 接着把 TTL 的值减 1
把P1 丢 弃 ， 并向源主机发送一个I CMP时间超过差错 报告报文 。

。 由千 TTL 等千零了， 因此 凡 就

源主机接着 发 送第二个数据报 P2, 并把 TTL 设置为 2。 贮 先到达路由器 R 1, R 1 收下后

把 TTL 减 l 再转发给路由器 R2 。 民 收到 P2 时 TTL 为1 , 但减 l后 TTL 变为零了。 民 就丢
弃 P2, 并向源主机发 送一个 I CMP 时间 超过 差 错 报告报 文 。 这样一 直 继 续下去 。 当最后 一
个数据报刚 刚 到达目的主机时 ， 数据报的 TTL 是1 。 主机不转发数据报 ， 也不把 TTL 值减

l 。 但 因 IP数据报中封装的是 无 法交付的运输层的 UDP用户 数据报 ， 因此目的主机要向源

主机发送I CMP终 点 不 可达 差错 报告报 文（见5. 2. 2(cid:7188)）。

这样 ， 源主机达到了 (cid:7151) 己的 目 的 ， 因 为这 些路由器 和 最后 目 的主机 发 来 的IC MP报文 正
好给出了源主机想 知 道的路由信 息 一一到 达目的主机所经过的路由器的 IP 地址 ， 以及到 达
其中的每 一个路由器 的 往 返 时间 。 图 4-31 是 从 南 京 的 一个 PC 向新 浪 网 的 邮 件 服 务器
ina.com.cn 发出 tracert 命 令后所获 得的结果。 图 中 每一行有 三个时间出现 ， 是 因为对

mai l.s
应于每一个 TTL 值 ， 源 主机要发送三 次 同样的IP数据报 。

我们还应注 意 到 ， 从 原则上 讲 ，

I P 数据报经过的路由器越多 ， 所 花 费的时间也会 越 长 。

但 从图 4-31 可看出， 有时正好相 反 。 这 是 因 为互(cid:7110)网的拥 塞 程度随时都在变化 ， 也很难 预

料到 。 因此， 完 全有这样的可 (cid:7127) ： 经过更多的路由器反而花 费 更短的时间 。

C :寸ocuAentsand Set tings \X l.: R)t1•ace:rt flld i l. s ina. co111. e n

Tracing .ro,,te to f!la. il . s in a. co111. c n  [202. 1 08 . 43 .23 0 1
ovet· a Sti.axi111uflt of 3 0  hops:

1  24”$  24”$  23 ns 222. 95. 1 ?2 . 1
2  2 3  AS  24 lllS  22 ns 221. 23 1. 204. 129
3  23 !TIS  22 IIIS  23 AS 221. 23 1. 2部 ． 9
4  24 AS  23 lllS  24 ns 2 02 .9?. 2 ?. 3 ?
5  22 FlS  23 fllS  24 ns 202. 9 7 . 4 1 .226
6  28 MS  28 m$  28 ns 2 02 .9 ? . 3 5. 2 5

50 l'IIS  58 m$  S1 AS 202. 9 ? . 36噜 86

？
8  308 ns 311 n$ 3 1 0  AS 2 1 9. 15 8. 32 . 1
9  38? ms 305”$ 385 ns 219. 158 . 13 .1 ?
1 0  1 6 4  FIS 1 6 4  IIIS 1 65 ns 202 .96. 1 2. 15 4
1 1  3 22 ms 320 111:: 2988 ns 61.135. 148 .  50
1 2  3 2 1  lllS 322"'s 3 20 ns fl•eenail4

3-230. s in d.con [202.108. 43. 2 30 1

T.race c omple te.

图 4-31 用 trace1i命 令 获 得 目 的 主 机 的 路 由 信 息

4.5

1 Pv6

协 议IP是 互(cid:7110)网的核 心 协 议 。 现在使用的协 议IP（即 1Pv4) 是 在 20 世纪 70 年代 末 期

设计的。 互 (cid:7110) 网 经过几 十 年的飞速发 展 ， 在 20 1

1 年 2 月 3 日 ， IANA 开始停 止向地区 互 (cid:7111)

网 注册机构 RI R 分配 1Pv4 地址 ， 因 为 1Pv4 地址 已 经 全 部 (cid:7106)尽 了。 不久 ， 各 地区 互(cid:7110)网地址
分配机构也相 继 宣 布 地址(cid:7106)尽 。 我 国 在 201 4 年(cid:7168) 20 1 5 年也逐步停 止了向新用户 和应用分配

1Pv4 地址 ， 同 时全面开始 商用部署 1Pv6 。

解 决IP地址(cid:7107) 尽的根 本 措 施就是采用具有更 大地址空 间 的新版本的IP, 即 1Pv6 。 经过

多年的研究和试验 ， 20 1 7年 7月 终于发布了 1Pv6 的正 式 标 准 [ RFC 8 200 ,  STD86] 。

• 149 •

4.5 . 1

1Pv6 的基本首部

1Pv6 仍支持无连接的传送， 但将 协议 数据 单元 PDU 称为分组(packet)， 而 不是 1Pv4 的
数据 报(datagram )。 为方便起 见， 本书 仍采用 数据 报 这 一 名 词 ( [KUR017] 和 [TANEll] 也是
这 样做的）。 实 际上， 在本书中一直把分组和 数据 报看成是 同义词 。

1Pv6所引 进 的 主要变化 如下 ：
(1) 更大的地址空间。 1Pv6把地址从 1Pv4 的 32位增大到 4 倍， 即增大到128位， 使地

址空间增大了2

96 倍。 这 样大的地址空间在可 预 见的将来是不会用完的。

(2) 扩展的地址层次结构。 1Pv6由 千地址空间很大， 因此可 以划分为更 多 的 层次。

(3) 灵活的首部格式。 1Pv6 数据 报的首部和 1Pv4 的并 不兼容。 1Pv6 定义了 许 多 可 选的

扩展首部， 不仅可提供 比 1Pv4 更 多 的功 能， 而且 还可提 高 路由 器的处理效率， 这 是 因为路

由 器对扩展首部 不进行 处理 （除 逐 跳扩 展 首部外）。

(4) 改进的选项。 1Pv6 允 许 数据 报包含 有选项的控制信 息， 因 而可 以包含一些新的选项。

但 1Pv6 的首部长度 是固定的， 其 选项放在 有效载荷中。 我们知道， 1Pv4 所规 定的选项是 固

定 不变的， 其 选项放在首部的可变部分。

(5) 允许协议继续扩充。 这 一点 很重 要， 因为技 术 总是在 不断 地发展的 （ 如网络硬件的

更新）， 而新的应用也 还会出现。 但我们知道， 1Pv4 的功能是固 定 不变的。
(6) 支 持 即 插 即 用 （即 自 动配置）。 因 此 1Pv6 不需 要 使用 DHCP。
(7) 支持资源的预分配。 1Pv6支 持 实时视像等 要求保证一 定的带 宽 和 时 延的应用。
(8)  1Pv6首部改为8 字节对齐 （即首部长度必须是8 字节的整 数倍）。 原来的 1Pv4 首部

是4 字节 对齐。

1Pv6 数据 报 由 两大部分组成， 即基本 首部(base header) 和后面的有效载荷(payload)。 有
效 载 荷 也 称为净负 荷。 有效载荷 允 许 有零个或多个扩展首部(extension header)， 再后面是数
据 部分 （如图4-32 所 示）。 但 请注意 ， 所有的扩展首部并 不属 千 1Pv6数据 报的基本首部。

IPv6 数据报

发

送在前 '－三 有
矗气I …IJ``1

40 字 节 l

◄

I
，

选 项

，

效 载 荷

不 超过 6 5 5 3 5 字 节

数 据 部 分

，俨

＇

，
＇
，

图 4-3 2 具 有 多 个可选扩展首部 的 1Pv6 数据报 的 一般形式

与 1Pv4 相比， 1Pv6对首部中的某 些字段进行了 如下的更改：
•  取 消了首 部长度 字段， 因为它的首部长度是固 定的 (40 字节）。

•  取消 了服务 类 型 字段， 因为优先级 和 流 标 号 字段实现了服务类 型 字段的功 能。

•  取消 了总 长度 字 段， 改用 有效载荷长度 字段。
•  取 消了标识 、 标 志 和 片 偏 移 字段， 因为这 些功 能已包含在分片 扩 展首部中。
•  把 TTL 字段 改 称为跳数限制字段， 但作用是一样的 （名 称与作用更加一致）。
•  取消 了协议字段， 改用下一个首部字段。
•  取消 了检验和 字段， 这 样就加快了路由 器 处理数据 报的速度。 我们知道， 在 数据 链

•  1 50 •

路 层对检测出 有差错的帧就丢 弃 。 在运输 层， 当 使用 UDP时， 若检测出 有差错的

用户 数据 报就丢 弃 。 当 使用 TCP时， 对检测出 有差错的报文 段就重传， 直到 正确

传送到目的进 程为止 。 因此在网络 层的差错检测可 以精简 掉 。

•  取 消了选项字段， 而用扩展首部来实现选项功能。
由于把首部中 不必要的功 能取 消 了， 使得 1Pv6 首部的字段 数减少到只有 8 个 （虽 然首

部长度增大了一倍）。

下面解释 1Pv6基本首部中各字段的作用 （参见 图 4-33 ) 。

4

12

16

24

3 1

位 0
—

1 版 本 1 通 信 量 类

流 标 号

有 效 载 荷 长 度

跳 数 限 制

1Pv6 的
基本首部
( 40 B )

目 的 地 址 ( 128 位 ）

首 部 长 度

首 部 长 度

扩 展 首 部 l

扩 展 首 部 2

图4-33
(1) 版本(version)
(2) 通信量 类(traffic class)

1Pv6 基本首 部和有效载荷 （ 这 里 画 出 了 两个扩 展 首 部 作 为例 子 ）

占 4位 。 它指明了协议的版本， 对 1Pv6该字段是6。

占 8 位 。 这 是为了区分 不 同的 1Pv6 数据 报的类别或优先

级， 和 1Pv4 的区分服务字段的作 用相 似 。 目前 正 在进行 不同的通信 量类性能的实验 。

占 20 位 。

(3) 流标号(flow label)

1Pv6 的一个新的 机制是支 持 资源预 分配， 并 且 允
许 路由器把每 一个数据 报与一个给 定的资源分配相 联 系 。
1Pv6 提出流(flow)的抽 象概念 。 所
谓 “ 流 ” 就是互联网络上从 特定源点到 特定终点 （ 单播或 多 播 ） 的一系 列 数据报 （ 如 实时音
频或视频传 输 ） ， 而在 这 个 “ 流 ” 所 经过的路径上的路由器都保证指 明 的服务质 量 。 所有属
千同一个流的数据 报 都具 有同样的流标 号 。 因此， 流 标 号 对实时音 频／视频 数据 的传送特别
有用。 对千传 统的电 子邮件或非实时数据 ， 流标 号 则 没有用 处， 把它置为0 即可 。 关 千 流 标
号 的规约可参考建 议标准 [RFC6437] 。

(4) 有效载荷长度(payload length)  占 16位 。 它指明 1Pv6数据 报 除基本首部 以外的字

节 数（ 所有扩展 首部都算 在 有效载荷 之 内 ） 。 这个字段的最大值是64 KB  (65535 字节） 。

(5) 下一个首部(next header)
•  当 1Pv6 数据 报 没有扩 展首部时， 下一个首部字段的作用和 1Pv4 的协议字段一样，

占 8位 。 它 相 当 千 1Pv4 的协议字段或可 选字段 。

它 的值指出了基本首 部后面的数据 应 交付 IP层上面的哪一个高 层协 议 （例如： 6
或 17 分别表示应 交付运输 层 TCP或 UDP) 。

•  当 出现扩 展 首部时， 下 一个首部字段的值就标识后面第一个扩展首部的类 型 。

•  151  •

( 6 ) 跳数 限制( hop limit )

占 8 位。 用 来 防 止 数据报在 网 络中无限期地存在 。 和 IPv4
的生存时间字 段相 似。 源点在每个数据报发 出 时即 设 定 某个跳数 限制（最大为 255 跳） 。 每

个路由器在转发数据报时 ， 要先把跳数限制字段中的值减 l 。 当 跳数限制的值为零时 ， 就要

把这个数据报丢弃。
( 7) 源地址

占 128 位。 是数据 报的发送端的 I P 地址。

占 128位。 是数据报的接 收端的 I P 地址。

( 8 ) 目 的 地址
下面我们简 单 介 绍 一下 IPv6 的扩 展 首 部。
在 RFC 8 200 中定 义 了以下六种扩 展 首 部：

（ 1
（6 ) 目 的站 选 项 。

鉴 别 ；

（5) 封 装 安 全有 效载荷 ；

) 逐跳选项 ；

（ 2) 路 由 选择 ；

（3) 分 片；（4 )

每 一个扩 展 首部都由若 干个字 段组成 ， 它们的长度也各 不 同 。 但所有 扩 展 首部的第 一
字段。 此字 段的值 指 出了在 该扩 展 首 部后面的扩 展首部是

个 字段 都是 8 位的 “
什么。 当使用多个扩展 首部时， 应按以上 的 先后顺 序 出 现。 高 层 首 部总 是 放在最后面 。

”
下一个首部

大家 知 道， I Pv4 的 数据报若在 其首部中使用了选项 ， 则 在数据报转发路径中的每一个
路由器 ， 都必须检查首部中的所有选 项 ， 看是 否与本路由 器 相 关。 这 必然要花 费 相 当 的时 间 。

IPv6 把原 来 IPv4 首部中选 项的功 (cid:7128) 都放在 扩 展 首部中 。
其基本首部的 “
”
下一个首部
所有扩 展 首部的第 一 个 字 段都 是 “
使得路由器(cid:7126)够迅速判 断待转发的 IPv6 数据报有无 需 要 本路 由 器 处理的选项 。

字段会指 出 ， 在 “
“
下一个首部

有效载 荷

IPv6 数据报若使用了扩展 首部， 则
”

字段中使用了何种 扩 展 首部。而

， 用来 指 出 在后面 还有何种 扩 展 首部。 这 就

扫 一扫

4.5 .2

1Pv6 的 地 址

一(cid:7183) 来讲 ， 一个 I Pv6 数据报的目的地址可以是以下三种基 本类型地址

之 一 ：

( 1) 单播( unicast )
( 2) 多 播( multicast ) 多播是 一点对 多 点的通信 ， 数据 报 发 送到 一组计算机中的每一个。

单播就是 传 统的点对点通信 。

视 频 讲 解

IPv6 没有采用广 播的术语 ， 而 是 将 广 播 看 作多播的一个特例。

(3) 任播( anycast )

这 是 IPv6 增 加的一种类型 。 任播的终点是一组计算机 ， 但数据报

只交付其中的一个 ， 通常是按照路由算法得 出 的距 离 最 近的一个。

IPv6 把实现 1Pv6 的主机和路 由器均称为(cid:7195) 点 。 由千一个(cid:7188)点可(cid:7126)会使用多条链路与其
他的一 些(cid:7188)点相 连， 因此一 个(cid:7188)点可(cid:7126)有 多个与链路相 连的接口。 这样 ， IPv6 给(cid:7188)点的每
一个接 口 （ 请注 意 ， 不 是给某个(cid:7195)点 ） 指派 一个 IPv6 地址。 一个具有 多个接 口 的(cid:7188)点可以
有 多个 单播地址 ， 而其中任 何 一个地址都可当作 到达该(cid:7188)点的 目 的地址 。 不过有 时为了方便，
若不会 引 起误解 ， 也常说某个(cid:7188)点的I Pv6 地址 ， 而把某个接 口 省 略掉。

在 IPv6 中 ， 每个地址 占1 28 位 ， 地址空间大于3.4 x l0 38。 如果 整个地球表面（ 包 括陆
个IP地址。 如果地址分配

地和水 面） 都覆 盖 着 计算机 ， 那么 IPv6 允 许每平方米拥 有 7x 10 23
速率是每微秒分配 100 万个地址 ， 则 需要 10

年的时间才(cid:7126)将所有 可(cid:7126)的地址分配完 毕 。

1 9

可见在想 象到的将 来 ， IPv6 的地址空间是不可(cid:7126)用完的。

为了体会 一下 IPv6 的地址有 多 大 ， 可以看一下目前 已经分配出去的最大的地址块。 法
国 电信 France Te le com 和德 国 电 信 De uts che Te le kom 各 分配到 一个/ 1 9 地址块 ， 相当千各有
35  X  10 1 2个地址 ， 远 远大于全部的 IPv4 地址 (IPv4 地址还不到4.3 X  10 9

个）。

巨大的地址范 围 还必须使维 护 互 (cid:7110)网的人 易于 阅 读和操 纵这 些地址。IPv4 所用的点分

十进制记法现在 也不够方便 了 。 例如， 一个用点分十 进制记法的1 28 位的地址为：

•  1 52 •

1 0 4 . 2 3 0 . 1 4 0 . 1 0 0 . 2 5 5 . 2 5 5 . 2 5 5 . 2 5 5 . 0 . 0 . 1 7 . 1 2 8 . 1 5 0 . 1 0 . 2 5 5 . 2 5 5

为 了 使地址再 稍 简洁 些 ，

I Pv6 使用 冒 号十六进制记法 (colon he xade cimal  notation, 简写
为 colon he x) ， 它 把每个 1 6 位 的 值 用 十 六 进 制值表示 ， 各 值之 间 用 冒 号分隔 。 例如， 如果前

面所给的点分十进制数记法的值 改 为 冒 号 十 六进制记法 ， 就变成 了 ：

6 8 E 6 : 8 C 6 4 : FFFF : FFFF : 0 : 1 1 8 0 : 9 6 0A : FFFF

在十六进制记法中， 允 许 把数字前面的0 省 略 。 上 面 就把0000 中的前三个0 省 略了 。

冒 号 十 六 进 制 记法还 包含两个技 术 使它 尤 其有 用 。 首先 ， 冒 号 十 六 进制记法可以允 许

零压缩(ze ro compre s sion) ， 即 一 连 串 连续的零可 以 为一对冒 号所取代 ， 例如：

可压缩为：

F F O S : 0 : 0 : 0 : 0 : 0 : 0 : B 3

FFO S :

:  B 3

为 了 保 证 零 压 缩 有 一个 不含混的解 释 ， 规 定 在 任 一 地址中只(cid:7126) 使用 一次零 压缩 。 该 技

术 对 已 建议 的分配策略特 别 有 用 ， 因 为 会有 许多地址包 含较长连续的零 串 。

其次， 冒 号 十 六 进 制记 法 可 结 合 使 用 点 分十进制记法的后 缀 。 我们下面会 看到 这种结

合 在 1Pv4 向 1Pv6 的转换 阶 段特 别有用 。 例如， 下面的 串 是 一个合法的 冒 号 十 六进 制记法：

0 : 0 : 0 : 0 : 0 : 0 : 1 2 8 . 1 0 . 2 . 1

请 注 意 ， 在 这种记法中 ， 冒 号 所 分 隔的每个值是 两个字(cid:7188) (1 6 位） 的值 ， 但点分十进

制每个部分 的 值 是 一个字 (cid:7196) ( 8 位 ） 的 值 。 再使用零 压缩即 可得 出 ：

:  : 1 2 8 . 1 0 . 2 . 1

下面再给出 几个使用零压缩的例子 。
1 0 8 0 : 0 : 0 : 0 : 8 : 8 0 0 : 2 0 0 C : 4 1 7 A

记为 1 0 8 0 :  : 8 : 8 0 0 : 2 0 0 C : 4 1 7 A

F F O l : 0 : 0 : 0 : 0 : 0 : 0 : 1 0 1 （多播地址） 记为 F F O l :  : 1 0 1

0 : 0 : 0 : 0 : 0 : 0 : 0 : 1 （环回 地址）
0 : 0 : 0 : 0 : 0 : 0 : 0 : 0 （ 未指明地址）

记为 ：  ： 1
记 为 ．

．

CID R 的斜线表示法仍然 可用 。 例如 ， 60 位的前缀 1 2 AB O O O O O O O O C D 3（ 十 六进制表

示的1 5 个字符， 每个字符代表4 位二 进制数字） 可记为：

1 2 AB : 0 0 0 0 : 0 0 0 0 : C D 3 0 : 0 0 0 0 : 0 0 0 0 : 0 0 0 0 : 0 0 0 0 / 6 0

或 1 2AB :
或 1 2 AB : 0 : 0 : C D 3 0 :

: C D 3 0 : 0 : 0 : 0 : 0 / 6 0

: / 6 0

但不允许记 为：

1 2AB : 0 : 0 : C D 3 / 6 0 （ 不(cid:7126)把1 6位地址 C D 3 0 块中的最后的 0 省 略）

或 1 2  AB :  : C D  3 0 / 6 0 （这 表示 1 2AB : 0 : 0 : 0 : 0 : 0 : 0 : CD 3 0 / 6 0)
或 1 2  AB :  : C D  3 / 6 0 （这表示 1 2AB : 0 : 0 : 0 : 0 : 0 : 0 : 0 C D 3 / 6 0)

但是 ，

1Pv6 取 消 了子 网掩码 。

斜 线的意 思和 1Pv4 的情况相 似 。 例如，

• 1 53  •

C IDR 记法 的 2 0 0 1 : 0 DB 8 : 0 : C D 3 0 : 1 2 3 : 4 5 6 7 : 8 9AB : C DE F / 6 0 , 表示

1Pv6的 地址是： 2 0 0 1 : 0 DB 8 : 0 : C D 3 0 : 1 2 3 : 4 5 6 7 : 8 9AB : C DE F
而其子网号是： 2 0 0 1 : 0 DB 8 : 0 : C D 3 0 :
1Pv6的地址分类 如表 4-7 所示[RFC4291] 。

: / 6 0

表 4-7

1 Pv6 的 常 用 地址分类

地址类型

未指 明 地址

环 回 地址

多 播地址

本 地 站 点 单播地址

本地链路单播地址

全球单播地址

地址块前缀
00 . .  ·0  ( 1 28 位 ）

00· · · 1  ( 1 28 位 ）

1 1 1 1 1 1 1 1

l I I I l I I O I  I

1 1 1 1 1 1 1 0 1 0

见 图 4-34

前缀的 CIDR 记法

./ 1 28

1 / 1 28

FFOO /8

FECO / 1 0

FE80 /1 0

对表 4-7 所列举的几种常用 地址简 单解释 如下。
未指 明 地址

： ＂。 这 个 地 址不能用
这是 16 字节的 全 0 地 址， 可缩 写为两 个 冒 号 ” :
作目的地址， 而只 能将 某 台主机当作源地址 使用 ， 条件是这 台主机 还没有配置到一个标准 的
IP地址。 这类地址仅此一个。

环 回 地 址

1Pv6 的环 回 地址 是 0 : 0 : 0 : 0 : 0 : 0 : 0 : 1 , 可缩 写 为：

： 1 。 它 的作用 和

1Pv4 的环 回 地 址一样。 这类地址也是仅此一个。

多播地址
本地站点单播地址(cite-local unicast  address)

功 能和 1Pv4 的一样。 这类地址 占 1Pv6地址总 数的 1/256。

有些单位的内 部网络 使用 TCP/ IP协议，

但并 没有连接到 互联网上。 连接在这样的内 部网络上的主 机都可以 使用这种本地站 点 地址进
行通信 ， 但 不能和互联网上的其他 主机通信。 这类地址 占 1Pv6 地址总 数的 1/1024, 其用途
和和 1Pv4 的专用地址是一样的。

本地链路单播地址(link-local unicast address)  这种地址是在单一链路上 使用 的。 当 一
个节 点 启 用 1Pv6 时就 自 动生成本地链路地 址 （请注意 ， 这 个 节 点 现在 并 没有连接在 某 个网
络上）。 当需要把分组发 往 单一链路的设 备而 不希 望 该 分组被转发 到此链路范围 以 外的地方
时， 就可以 使用这种特殊地址。 这类地址 占 1Pv6地址总 数的 1/1024。

全球单播地址 1Pv6 的这 一类单播地址是使用 得最多 的一类。 曾 提出过多种方案来进
一 步划分这 128位的单播地址。 根据 2006年发 布的草 案标准 RFC 4291 的建议， 1Pv6单播
地址的划分方法非常灵 活， 可 以是如图 4-34 所示的任何一种。 这 就是 说， 可把整个的 128
位都作为一 个 节 点 的地址。 也可用 n位作为子网前缀， 用 剩 下的(128 — n )位作为接口标 识 符
（相当于 1Pv4 的 主机 号）。 当 然也可以划分为三级， 用 n 位作为 全球 路由选择前缀， 用 m

位作为子网前缀， 而用 剩 下 的(128 - n - m ) 位作为接口标识符。

节 点 地 址 ( 1 28 bit)

子 网 前 缀 ( n bit)

接 口 标 识 符 ( I 2 8  - n )

全 球 路 由 选 择 前 缀 ( 11 bit )

I 子 网 标 识 符 C m bit)  I 接 口 标 识 符

图 4-34

1Pv6 的 单播地址 的 几种划 分方法

• 154 •

扫 一扫

｀

翌
詈

Q

卧
背耘
睬

视 频 讲 解

4.5 . 3

IPv4 向 IPv6

从

过渡

由 千现 在 整个互(cid:7110)网的规 模 太 大 ， 因 此 ， ”规 定 一个 日 期 ， 从这 一 天 起
所有的路 由 器 一 律都改用 IPv6 " ， 显然是 不可行的。 这 样 ， 向 IPv6 过渡 只
(cid:7129) 采 用 逐 步演进 的 办法 ， 同 时 ， 还必须使新安装的 IPv6 系 统(cid:7126)够 向 后兼 容。
这 就是说 ，

1Pv6 系 统必须(cid:7126)够接收 和转发 IPv4 分组 ， 并且(cid:7126)够为 IPv4 分组选择 路 由 。
下 面介 绍 两种向 1Pv6 过渡 的 策 略 ， 即使用双 协 议 栈 和 使用 隧 道技 术 [RFC 2473,  2529,

3056, 403 8, 42 1 3 ]。

1 . 双协议栈

双协议栈(dual stack) 是指 在 完 全过渡到 1Pv6 之前 ， 使一部分主机（或路 由 器） 同 时装
有 1Pv4 和 1Pv6 这 两种 协 议栈。 因此双 协 议 栈主机（或 路 由 器） 既(cid:7126)够和 IPv6 的系 统通信 ，
又(cid:7126)够和 IPv4 的系 统通信。 双 协 议 栈的主机（或路由 器 ） 记为 IPv6/IPv4 , 表明它 同 时 具有
IPv6 地址和 1Pv4 地址（如图 4-3 5 所示）。

应 用 层

运输层

．“..．．`

链路层 和 以 下
·矗.-一丘＾～－
I.

到 IPv4 系 统

J

到 IPv6 系 统

图4-35 使 用 双 协 议 栈进行从 IPv4 到 1Pv6 的过渡

双 协 议 栈 的主机在和 1Pv6 主 机 通信 时采用 1Pv6 地址 ， 而和 1Pv4 主机通信 时则采用
1Pv4 地址。 但 双 协 议 栈 主机 怎 样 知 道目的主机是 采 用 哪 一种地址 呢 ？ 它 是 使用域 名 系 统
DNS 来 查询 的。若 DNS 返 回的是 1Pv4 地址 ， 则双 协 议 栈的源主机就使用 1Pv4 地址。 但 当
DNS 返回的是 1Pv6 地址 ， 源主机就使用 1Pv6 地址。

双 协 议栈需要付出的代价 太 大 ， 因 为要 安 装上两 套 协 议。 因 此在过渡时期 ， 最好采用

下面的隧道技 术。

2 . 隧道技术

向 1Pv6 过渡的另 一种方法是 隧道技术(tunneling)。 图 4-36 给出了隧道技 术的工作 原理。

这种方法的要点 就是 在 1Pv6 数据报要进入 1Pv4 网络时， 把 1Pv6 数据报封装成为 1Pv4 数据
报。 现在整个的 IPv6 数据报变成了 IPv4 数据报的数据部分。 这样的 IPv4 数据报从路 由 器
B 经过路 由 器 C 和 D , 传送到 E , 而原 来 的 1Pv6 数据报就好像在 1Pv4 网络的隧道中传输 ，
什么都没有变化 。 当 1Pv4 数据 报离开 1Pv4 网络中的隧道时 ， 再把数据部分（即 原 来 的 1Pv6
数据报） 交给主机的 1Pv6 协议栈。 图中的一条粗线表示在 1Pv4 网络中好像有一个从 B 到 E
”， 路 由 器 B 是 隧道的入口而 E 是出口。 请 注 意 ， 在 隧 道中传送的数据报的源
的 “

1Pv6 隧道

地址是 B 而目的地址是 E。

•  1 55  •

A

[Pv6

_ 流标号 ： X

源 地 址 ： A
目 的地 址 ： F

双 协 议栈

LPv4 网络

双 协 议 栈

IPv6

F

一千

流标 号 ： X
源地 址 ： A
目 的地 址 ： F

） ＇

,  l

数 据 部分

,/ :

IPv4 数据报

IPv4 数据报

数据部分

TPv6 数据报

f----- 1Pv4 网 络

IPv6 数据报

要使双 协 议栈的主机知道 IPv4 数据报里面封装的数据是 一个 IPv6 数据报， 就必须把

图 4-36 使 用 隧道技 术进 行 从 I Pv4 到 IPv6 的 过渡

IPv4 首部的协议字段的值设置为4 1

(41 表示数据报的数据部分是 1Pv6 数据报）。

4.5.4

ICMPv6

和 IPv4 一样， 1Pv6 也不保证数据报的可靠交付， 因 为 互 (cid:7110) 网中的路由器可(cid:7126)会丢弃数
据报。 因 此 IPv6 也需要使用 IC MP 来 反 馈 一 些 差 错信 息。 新的版本称为 IC MPv6 , 它 比

IC MPv4 要复杂得多。 地址解析协议 ARP和网 际组管理协议I GMP的功(cid:7126)都已被合并到 IC M氏6

中（如图4-37所示）。

ICM P

!GMP

ICMPv6

1Pv4

1Pv6

ARP

版 本 4 中 的 网络层

版本 6 中 的 网络层

图 4-37 新 旧 版本 中 的 网 络层 的 比较

IC MPv6 是 面向报文 的协 议 ， 它利用报文 来 报告 差错， 获取信 息 ， 探 测 邻 站或 管理多播

通信。 IC MPv6 还增加了几个定义报文功(cid:7126)及含义的其他协议。 在对 IC MPv6 报文进行 归类
时， 不 同的文献和 RFC 文档使用了不 同的策略， 有的把其中的一 些报文定义为IC MPv6 报
文 ， 而把 另 一 些 报 文定义 为 邻 站 发 现 ND( N e ighbor-Dis cove ry )报 文或 多 播 听 众 交 付 MLD
( Multicas t  Lis te ne r De live ry )报文。 其实所有这 些报文都应当是IC MPv6 报文， 只是 功(cid:7126)和作

用不 同 而 已。 因此我们把这 些报文都列入IC MPv6 的不 同 类别 。 使用 这种分类方法的原 因 是

所有这 些报文都具有相 同的格式 ， 并且所有报文类型 都由IC MPv6 协 议处理。 其实， 像 ND

和 MLD 这样的协议 都是运行在 IC MPv6 协 议之下的。 基于这样的考虑 ， 可把IC MPv6 报文

分类， 如图4-38 所示。 请 注 意 ， 邻 站发现报文和组成员 关系报 文 分 别 是 在 ND 协 议和 MLD

协 议的控制下进行发送和接 收的。

• 1 56  •

组成 员 关 系 报 文

| ___＿_

_

MLD 协 议

~' 」、 l4」 .

- .L Ll

ND 协 议

关千 IC MPv6 的进一 步 讨 论可参 阅 [FO RO I O] ， 这 里从略。

图4-3 8

ICMPv6 报 文的分类

4 . 6   互联 网 的 路 由 选择协议

本(cid:7188)将 讨 论 几种常用的路由选 择 协 议 ， 也就是 要 讨 论转发表中的路由是 怎样得出的。

按照4 .1 . 2(cid:7188)所 述的观点 ， 路由选 择 协 议 属 于 网络 层 控制层 面的 内 容。 不过本(cid:7188)仍然 按传统

的思路进行讨 论 ， 也就是 说 ， 路由选 择 协 议规定 了互(cid:7110) 网中有关的路由器应如何相 互交换信

息并生成出路由表。

4.6. 1  有关路 由 选择 协 议 的 几 个基本概念

1 . 理想 的 路 由 算法

路由选 择 协 议的核 心 就是 路由算法 ， 即 需要 何种算法来 获得路由表中的各 项目。 一个

理想的路由算法应具有如下的一 些特 点[BELL86] :

(1 ) 算 法 必 须 是 正 确 的 和 完 整 的 。 这 里 ， “ 正 确 ＂

的含 义 是 ： 沿 着 各 路由表所 指 引 的路

由 ， 分组一定(cid:7126)够最终到达目的网络和目的主机。

( 2) 算法在计算上应 简 单。 路由选择的计算不应使网络 通信 量 增加太多的额外开销。

(3) 算 法 应 (cid:7129) 适 应通信量和 网络拓扑 的 变 化 ， 这 就是说 ， 要有 (cid:7152) 适应 性。 当网络中的通

信 量发生变化 时， 算法(cid:7126)(cid:7149)适应地改变路由以均衡 各 链路的 负 载。 当某个或某些(cid:7188)点、 链路

发生 故 障不(cid:7126)工作 ， 或者 修理好了再投入运行时， 算法也(cid:7126)及时地改变路由。 有时称这种(cid:7149)
适应性为 ＂

稳健性 ”

(robus tne s

)。 3

(4 ) 算法应 具有稳定性 。 在网络 通信 量和网络 拓 扑相对稳定 的情况下 ， 路由算法应收敛

于 一个可以接受的解 ， 而不应使得出的路由不停地变化 。

( 5 ) 算 法 应 是 公 平 的 。 路由选择算法应对所有用户 （ 除对少数优 先级高的用户 ） 都是 平
等的。 例如， 若仅仅使某 一对用户 的端到 端时延 为最小 ， 但 却 不考 虑 其 他的广大用户 ， 这 就
明显地不符合 公平性的要求。

而网络的吞 吐 量最大。 虽 然 我们希 望得到

( 6 ) 算法 应 是最 佳 的 。 路由选择算法应当(cid:7126)够找出最好的路由 ， 使得分组平均时延最小
最佳 ＂ 的算法， 但 这 并不总是最重要的。 对于 某
些 网络 ， 网络的可 靠 性 有时要比最小 的分组平均时延 或 最大 吞 吐 量更加重要。 因此 ， 所 谓

“

“

“ 最 佳

只 (cid:7129) 是相对于某一种特定要求 下 得 出 的 较 为 合理的 选择而 已。

一个实 际的路由选择算法 ， 应尽可(cid:7126)接近 于 理想 的算法。 在不 同 的应用条件 下 ， 对以

CD 注 ： robustness 一 词 在 自 动 控 制 界 的 标 准 译 名 是

“

鲁 棒 性

”

， 但在 [MlNGCI94] 则 译 为

＂

稳健性

”

。

•  1 57  •

s
