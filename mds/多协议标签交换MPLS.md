全球 IP地址。

显 然， 通过 NAT 路由器的通信 必 须 由专用网内的 主机发起。 设 想 如果有专用网 上外面
的 主机要发起 通信， 当IP数据 报到达 NAT 路 由器时， NAT 路由器就不知道应当把 目 的IP
地址转换成专用网内的哪一个本地 IP地址。 这 就表 明 ， 专用网 内 部的 主机不 能直接充 当 服
务 器用。

为了 更加有效地利用 NAT 路 由器上的 全球IP地址， 现在常用的 NAT 转换 表把运输层
的端 口号也利用上 。 这 样， 就可以使 多个 拥有本地地址的 主机， 共用 NAT 路由 器上的一个
全球IP地址， 因而可 以同时和互联网上的不 同 主机进行 通信 [COM E06]。

由千运输 层的端 口号将在 下一 章 5.1.3 节讨论， 因此 ， 建议在 学 完 运输层的有 关内容后 ，

再学 习 下 面的内容。 但从系 统性方 面考虑， 把下 面的这 部 分内容放 在本 章中 介 绍 较 为合适。

使用端 口 号的 NAT 也 叫 作网 络 地址 与 端 口 号转换 NAPT (Network Address  and  Port
Translation)， 而 不 使用端 口 号的 NAT 就叫 作 传 统 的 NAT (traditional  NAT) 。 但在 许 多 文 献 中
并 没 有 这 样区分， 而 是不加区分地都 使 用 NAT 这个更加简 洁 的缩 写 词 。 表 4-9 说 明 了
NAPT 的地址转换 机制。

表 4-9 NAPT 地址转换表举例

方 向

字 段

原先的 I P 地址和端 口 号

转换后的 I P 地址和端 口 号

从专用 网 发 往 互联 网

源 IP 地址TCP 源喘 口

1 92. 1 68.0.3 30000

从专用 网 发往互联网

源 IP 地址TCP 源端 口

I 92 1 68 0 4 30000

从互联 网 发 往专用 网

目 的 IP 地址TCP 目 的 端 口

1 72 38. 1 5 -4000 I

从互联网 发 往专用 网

目 的 IP 地址TCP 目 的瑞 口

1 72 38. 1 5 40002

1 72 38 I 5 .4000 1

1 72.38. 1 5 40002

1 92 1 68.0 3 30000

I 92 1 68 0 4 30000

从表 4-9 可 以看 出， 在专用网内 主机 192.168.0.3 向互联网发送 IP 数据 报 ， 其 TCP 端 口
号选择为30000。 NAPT 把源IP地址和 TCP端 口号都进行转换（ 如果 使用 UDP, 则 对 UDP
的端 口号进行转换 。 原理是一样的） 。 另 一 台主机 1 92. 1 68.0.4 也 选择了同样的 TCP端 口 号
30000 。 这 纯属巧合 （端 口号仅 在 本 主机中才 有意 义） 。 现在 NAPT 把专用网内不 同的源 IP

地址都转换为同样的 全球 IP地址。 但 对源主机所采用的 TCP端 口号 （ 不 管 相同 或 不 同 ），
则 转换为不 同的新的端 口号 。 因 此 ， 当 NAPT 路由器收到从 互 联网发来的应答时， 就可 以

从 IP数据 报的数据 部 分找出运输 层的端 口 号， 然后根据 不 同的目的端 口号， 从 NAPT 转换
表中找到正确的 目的 主机 。

应当指出， 从 层次的角 度 看， NAPT 的 机制有些特 殊。 普 通 路由 器 在转发 IP 数据报时，

对于源 IP地址或 目的 IP地址都是不改变的。 但 NAT 路 由器在转发 IP数据报时， 一 定要 更
换 其 IP地址（ 转换源 IP地址或 目的 IP地址）。 其 次， 普 通 路由 器 在转发 分组时是工作在网
络 层的。 但 NAPT 路由器还要 查 看 和转换 运输层的端 口号 ， 而 这 本来应 当 属 于 运 输 层 的范
畴。 也 正 因为这 样， NAPT 曾 遭 受 了一 些 人的批评 ， 认为NAPT 的操作没有严格 按 照 层 次的
关 系 。 但 不管怎样， NAT （包括 NAPT ) 已成为互联网的一个重 要 构 件 [RFC3022] 。

4 . 9   多协议标签交换 M PLS

IETF 于1997 年成立 了M PLS 工 作 组， 为的是开发出一种新的协议。 这种新的协议就是
多协议标签交换M PLS (M ultiProtocol Label  Switching) 。 “ 多 协议 ” 表示 在M PLS 的上层 可 以

• 189  •

采用 多 种 协议 。 IETF 还综合了许 多 公司的类似技术， 如思科公司的标签交换(Tag Switching),
以及 Ipsilon 公司的 IP 交换(IPSwitching)等。 2001 年 1 月 M PLS 终于成为互联网的建议标准
[RFC 3031, 3032] 。

M PLS 利用 面 向 连接技术 ， 使每个分组携 带一个叫作标签(label)CD的小整 数 （这 叫作打
上标签） 。 当 分组到达 交换 机 （即标签 交换 路由 器） 时， 交换 机读取 分组的标签， 并 用 标签
值来检 索 分组转发表 。 这 样就 比 查找 路由表来转发 分组 要快得 多 。

人们经常把M PLS 与 异 步传递方式ATM (Asynchronous  Transfer M ode)联系起来， 这 仅
仅 是 因 为它 们 都采用 了 面 向 连接的工 作方式 。 以前 很 多 人 都 曾 认为网络的发 展 方 向 是以
ATM 为核 心的宽 带综合业务 数字 B-ISDN 。 然而价格低廉 得 多 的高速 IP路由 器 仍然 占 领 了
市场， 最终导致ATM 技术 和 B- ISDN 未能够成为网络的发展方 向 。 M PLS 并 没有取代IP,
而是作为一种IP增强技术， 被广泛地应用 在互联网中。

M PLS 具 有 以下三个方 面的特点 ：

（1) 支 持 面 向 连接的服务质 量 。

(2) 支 持 流 量 工 程，

均 衡网络 负 载 。

(3) 有 效地支持虚拟专用 网 VPN 。

下 面讨论M PLS 的基本工作原理。

4 . 9 . 1  MPLS

的 工 作 原 理

1 ． 基本工作过程

在传 统的 IP网络中， 分组每到达 一个 路由 器， 都必须 查 找 转发表， 并
按照 “ 最长 前缀匹配 ＂ 的原则找到下一跳的 IP地址 （请注意 ， 前缀的长度
是 不确定 的 ） 。 当 网络 很大时， 查找含 有大量项目的转发表 要花 费 很 多 的时间。 在出现突发

视 频 讲 解

性的通 信 量时， 往往 还会 使缓存溢出， 这 就会引 起 分组丢 失 、 传输时延增大和服务质 量 下 降 。
MPLS 的一个重 要特点就是在 M PLS 域的入口处， 给每 一个 IP 数据 报打上 固 定长度
” 标签 ＂， 然后对打上标签的 IP数据报用 硬件进行转发， 这 就 使得 IP数据报转发的过程大
大地加快了 气 采用 硬件 技 术 对打上标签的IP数据 报进行转发就称为标签交 换 。 “ 交换 ” 也
表 示 在转发时 不再上升到第三 层 查找转发表， 而是根据标签在第二层 （ 链路层 ） 用 硬件进行
转发 。 M PLS 可 使用 多 种链路层协议， 如 PPP、 以太 网 、 ATM 以及帧中继等。 图 4-66 是
M PLS 协议的基本原理的示意图。

M PLS 域(M PLS domain)是指该域 中 有 许 多 彼此相邻的路由 器， 并 且所有的 路由 器都是
支 持M PLS 技术的标签交换路由器 LSR (Label  Switching Router) 。 LSR 同时具有标签 交换 和
路由 选择这 两 种 功 能， 标 签 交换 功能是为了快速转发， 但 在这 之前 LSR 需 要 使用 路由 选择
功能构造转发 表。

CD 江 ：

label 的 标 准 译 名 本来 是

献 中 的 译 名

“

标 签

＂

。

“

“

标 号

”

”

＠ 注 ： 有 的 公 司 愿 意 用

第三层交换

因 而 编 者 小 主 张 使 用 这

一

术 语 。

• 190 •

[MJNGCI94] ， 但此译名 未被普遍接 受 。 本书 曾 采用 译 名

＂

“

标 记

， 现 在 改 用 多 数 文

“

＂

表 示

第 三 层 的 路 由 选择 功 能 加 上第 二 层 的 交 换 功 能

。 但这 样 的 术 语 不 够 明 确 ，

- － - - - - - - - - - -
- ·   MPLS 域

－ －

、

、 、

一

一

J

二

二

MPLS
入 口 节 点

A

少

｀

、

、

、

、

、

、

 灶

f
\J

Jr

f[
 誓

rJ

的／

}

一

，

上
分

 签
和
五
组

/

- - - - - - - - - - - - -

/

LS

，

/

点

节靠
Eg 标签交换路 由 器 LSR

二 普通 IP 分 组 二项 打上标签 的 分组

己已 普通路 由 器

图4-66 MPLS 协 议的基本原 理

图4-66中给出 了 M PLS 的基本工 作过程， 解释 如下 ：
(1) M PLS 域中的各 LSR 使用专门的标签分配协议 LDP (Label Distribution Protocol) 交换
报文， 并 找出和特定标签 相对 应的路径， 即标签交换路径 LSP(Label  Switched  Path)。 例如
在图中的路径 A-B-C-D。 各 LSR 根据 这 些 路径 构造出转发 表。 这个过程和 路由器构造
自 己的路由表相似[RFC 3031]， 限 千 篇 幅， 这 里 不讨论转发 表构造的详细步骤。 但应注意的
是 ，M PLS 是面向连接的， 因 为在标签 交换 路径 LSP上的第一个 LSR 就根据 IP数据 报的初
始标签确 定 了 整个的标签 交换 路径， 就像一 条虚连接一样。

(2) 当 一个 IP数据 报进入到M PLS 域时，M PLS 入 口 节点(ingress node)就给它 打上标签
（ 后面我们就会知道， 这 实际上是插入一个 M PLS 首部）， 并 按照转发 表把它 转发给下 一个
LSR。 以后的所有 LSR 都按照标 签进 行转发。

给IP数据 报 打标签的过程叫作分类(classification)。 严格的第三层 （ 网络层 ） 分类只使用

了 IP首部中的字段， 如源 IP地址和目的IP地址等。 大多 数运营 商 实现了第四层 （ 运输层 ）

分类 （ 除 了 要检 查IP首部外，运输层 还要检查TCP或 UDP首部中的协议端 口号）， 而有些运
营 商则实现了 第五层 （ 应用 层 ） 分类 （更进 一 步地检 查数据 报的内 部 并 考虑其有效载荷）。

(3) 由千在 全网内统 一 分配 全局 标 签 数 值是非常困 难的， 因此一个标签仅仅在 两个标签
交换路由器 LSR 之 间 才有意义。 分组每经过一个 LSR, LSR 就 要做 两件 事 ： 一是转发， 二
是 更换 新的标签， 即把入标签更换成为出 标签。 这 就叫作标签对换(label swapping)＠。 做这
两 件 事 所需的数据 都已清 楚地写 在转发 表中。 例如， 图 4-66中的标签 交换 路由器 B 从入接
口 0 收到一个入标 签 为 3 的IP数据 报， 查找了如下的转发 表：

|  入尸 I  入尸 I  出尸 I  出＊尸 I

标签 交换 路由器B就知道应当把该 IP数据报从出接口1 转发出去， 同时把标签对换为1。
当 IP数据 报进入下一个 LSR 时， 这时的入标签就是刚 才 得到的出标签。 因此， 标签 交

换 路由器 C 接着 在转发该 IP数据 报时， 又把入标签l对换为出标 签 2。

CD 汁 ： 这里使用 [RFC 303 1 ] 中 的 标 准 词 汇 。 ” 对换

和

交换

的 意 思 相 近 ， 但

对 换

更 强调 两 个 标 签 互 相 对 换 （ 把 入

标 签 更 换 为 出 标签 ） 。 虽 然 MPLS 中 的 LS 是表示

标 签 交 换

”

， 但标签交换路 由 器 LSR 实 现 的 功 能 是
“

”

＂

“

“

＂

标签对换

。

“

”

• 191  •

(4) 当 IP 数据报离开 MPLS 域时， MPLS 出 口 (cid:7195) 点( e gre s

node)就把 MPLS 的标签去除 ，

把 I P 数据报交付非 MPLS 的主机或路 由 器 ， 以后就按照普通的转发方法进行转发。

上述的这种 “ 由入口 LSR 确定进入 MPLS 域 以 后 的转发路径

”

称 为显 式 路 由 选 择

( explicit  routing)， 它和互(cid:7110)网中通常使用 的 “
区 别。

下面再讨 论 MPLS 中 的几个重要概念。

2 . 转发等价类 FEC

每一个路 由器逐跳进行路由 选择

“

有着很大的

MPLS 有个很 重 要的概念就是 转 发 等 价 类 FEC ( Forwarding  Equivale nce C las

s )。 所 谓

“ 转发 等 价 类 ” 就是 路由器按 照 同 样 方式对待的 I P 数据报的集合。 这 里 ”
待

按照 同样方式对
表 示从 同样接 口 转发到 同样的下一 跳地址 ， 并且 具有同样服 务 类 别 和 同样丢弃优先级等 。

”

FEC 的例 子是：

( 1 ) 目 的 IP地址与某 一个特定 I P 地址的前缀 匹配的 I P 数据报（ 这 就相当于普通的IP

路 由 器 ）；

(2) 所有源地址与 目 的地址都相 同的IP数据报；

(3) 具有某种服 务 质 量需求的 I P 数据报。

总 之 ， 划分 FEC 的 方法不受 什么限制 ， 这 都由网络管理员 来 控制， 因此非常灵活。 入
口 节 点并不是给每 一个IP数据报指派一个不 同的标签， 而是将 属于同样 FEC 的IP数据报
都指 派 同样的标签。 FEC 和 标签是 一 一对应的关系。

图 4-6 7给出一个把 FEC 用 千 负 载均衡的例子。 图 4-6 7( a)的主机 凡 和 H2 分别向 压 和
儿 发送大量数据。 路由器A 和 C 是数据传输必 须经过的。 但传统的路由选择 协议只(cid:7126)选择

最短 路 径A- B -C ， 这 就可 (cid:7130) 导 (cid:7175)这 段最短路径过载。

H

1三、 八一 c/三 凡
H2 ＝厂＼占一一只三 H4

(a) 传 统路 由 选 择 协 议 使 最短路径A一B-C过载

三 H4

( b ) 利 用 FEC 使 通 信 擢 较 为 均衡

图 4-67

FEC 用 千 负 载均 衡

图 4-6 7( b) 表示在 MPLS 的情况下， 入口(cid:7188)点A 可设置 两 种 FEC : “ 源地址为 凡 而目的
地址为 H产 和 ＂
源地址为 压 而 目 的地址为 H4 "， 把前一种 FEC 的路径设置为 H ！ -A- B ­
C - H 3, 而后 一种的路径设置为 H2-A-D- E-C - H4。 这样可使 网络的负 载较为均衡。 网
络 管 理 员 采 用 (cid:7149)定义的 FEC 就可 以 更 好 地管理网络的资源。 这种均衡 网 络 负 载的做法也称

为流量工程 TE (Traffic Engine e ring广或通信量工程。

CD 许 ： 流 量 工 程 是 对 网 络 上 的 通 估 屉进 行 测 星 、 建 模 和 控 制 ， 使 网 络 运 行 的 性 能 得 到 最优 化 。

•  1 92  •

s
4.9.2  MPLS 首部 的位置与格式

M PLS 并 不 要求 下层的网络都 使用面 向 连接的技术。 因此一 对M PLS 路由 器之间的物理
连接， 既可 以 由一个专用电 路组成， 如 OC-48 线 路， 也可 以使用像 以太网这样的网络 。 但
是这些网络 并 不提供打标签的手段， 而 IPv4 数据 报 首部也 没有多 余的位置存放 M PLS 标签。
这就需要 使用一种封装技术： 在把 IP数据报封装成以太网帧之前， 先 要插入一个 MPLS 首
部。 从层 次的角 度看，M PLS 首部就 处 在第二层 和第三层之间 （如图4-68 所 示 ） 。 在把加 上

M PLS 首 部的 IP 数据 报 封装成 以太网帧时， 以太网的类 型 字段 在单播 的情况 下 设 置 为
884716 （下标 16表示这是十六进制的数字）， 而在多 播 的情 况 下为 88481 6。 这样， 接收方可
以用帧的类型来判 决这个帧是携 带了M PLS 标 签 还是一个常规的 IP数据 报。

尸:匕插入

M
数据链路层

图 4-68 MPLS 首 部 的 位置

图4-69 给出了M PLS 首部的格式。 可见 “ 给 IP数据 报 打上标签 “ 其实就是在 以太网的
帧首部和 IP数据报的首部之间插入一个 4 字节的 MPLS 首部。 具体的标签就 在 “ 标签值 ”
这个字段中。

位

以 太 网 帧I 帧 首 部1 MPLS 首 部I IP 首 部 I

IP  数 据 部 分

1 帕 尾 部 1

发送在前

I

IP 数据报

I

图 4-69 MPLS 首部的格式

M PLS 首部共包括 以下四个字段：
(1) 标签 值

占 20 位。 由于 一个 M PLS 标 签 占 20 位， 因此从理论上讲， 在 设 置

M PLS 时可以 使用标签的所有 20 位， 因而可 以同时容纳高达 220个流 （即 1048576 个流 ）。
但是， 实际上几乎 没有哪个 M PLS 实例 会 使用很大数目的流， 因为通常需要管理员 人 工 管
理和设置每条 交换 路径。

(2) 试验
(3)  S
(4) 生 存 时 间 TTL

占 3位， 目前保 留 用 千试验。

占 1位， S (Stack)表 示栈， 在 有 “ 标签栈 ” 时 使用。

占 8位， 用来防 止M PLS 分组 在M PLS 域中兜 圈 子。

一

4.9.3  新

代 的 MPLS

M PLS 问世后就 在互联网中得到了大量的部署。 虽然M PLS 能够 更快地 转发 分组， 但其
有关的 控制协议 （ 如 LDP) 却 比 较 复 杂 ，其扩展性差，运行维护也较 困 难。 协议 LDP 也无
法做到基 千时延或带宽等 要求的流量调度。 为了根据需要 灵 活 地 选择流量的 转发 路径 ， 就还
需要再 使用资源预 留协议 RSVP（见 8.4.3 节 ）。 但RSVP的信 令非常复 杂 ， 每个节 点 都要 维
护 一个庞大的链路信 息 数据 库。 此外，RSVP不支持等价 多路径路由选择 ECM P(Equal-Cost
M ultipath Routing)， 而只会选择一 条最优 路径进行 转发 。

• 193  •

为了解决上述问题， 一种保 留 了 MPLS 的主要特 点， 但 更加简单的新的源路由选择 协
议出现了。 这 就是 段 路 由 选择协议( Se gme nt Routing )， 简称为 S R。 但不少人都使用 ＂
段路
由协议 ” 这样更加简单的名 称。 在 S R 中， ＂ 段( s
e gme nt ) " 就是 标 签， 也就是转发指令的一
种标 识 符 。 S R 的工作原理仍然 是 基于标签交换的， 不过现在不需要使用协议 LDP, 因此简

化 了设备运行的协 议数量。 S R 由源(cid:7188)点为发送的报文指定 路径， 并将路径转换成有序的段

列 表( Se gme nt Lis t )， 即 MPLS 标 签 栈， 它 被 封 装在分组首部。 网络中的其他(cid:7188)点就执行首

部中的指令（即 标签） 进行转发。

整个网络设有控制器， 也就是 SDN 控 制器（见 4 .10 (cid:7188)）。 控 制器收集并掌 握 全 网的拓

扑 信 息和链路状 态 信 息， 计算出分组应传送的整个路径。 控 制器 负 责 给分组分配 S R 标签，

这 些标 签指明了分组从源点到终点的路径。 当分组到达某个网络(cid:7188)点时， (cid:7188)点就根据分组携
带的标签转发到下 一个(cid:7188)点。

现在 S R 还 向IPv6 演进， 这 就是 S Rv6。 它直接利用IPv6 字段作为标签 寻 址。而前面介

绍的在 MPLS 基础 上的 S R 则称为 S R-MPLS。

4 . 1 0   软件定 义 网 络 S DN 简 介

SDN 的概念最初由斯坦福大学 N . McKe own 于 200 9 年首先 提出。 当时还只是在学术 界
进行探讨的一种新的网络体系结构。 但随后几年发展很 快， 不少 企业相 继采用。 其中最成功
的案例就是 谷 歌 建于 2010 ~  201 2年的数据中心 网络 B4 。 几 年 来 网络 B4 运行的结果证明，

基千 SDN 的专用广域网确 实可以大大 提高网络 带 宽 利 用率， 网络运行更加稳定， 管理更加

高效简化 ， 运行费用也明显 降 低了。 目前， SDN 已经 引 起人们的密 切 关注 。

在本章 开始的 4 .1 . 2 (cid:7188)， 我们初 步介绍 了网络层数据层面和控制层面的基本概 念 。 现在

有关 SDN 的资 料 已相 当丰 富 。 限千篇 幅， 下 面我们只(cid:7126)对 SDN 进行简单的介 绍 。

我们知道， 在 SDN 中， 数据层面中的交换机是由控制层面进行控制的， 图4-70 表明这
种控制是 通过协 议 Ope nFlow 来 实现的。 协议 Ope nFlow 是 一个得到高度认可的标 准， 在讨
论 SDN 时往往与 Ope nF low 一起 讨 论。 因此， 有人会误认为 SDN 就是 Ope nFlow。 其实 这
二者 有着很大的 区 别 。 SDN 不是 协 议， 更 不是 一种产 品 。 SDN 是 一个体系结构， 是 一种设
计 、 构建和管理网络的新方法或新概 念， 其要点就是 把网络的控 制层面和数据层面分离， 而

让 控 制层面 利用软件 来 控 制数据层面中的许多设备。 可以把协 议 Ope nFlow 看成是在 SDN

体系结构中控制层面和数据层面之 间 的通信 接口， 它使得控 制层面的控制器可以对数据层面

中的物理设备或 虚拟设备， 进行直接访问和操 纵。 这种控制在逻辑上是集 中 式 的， 是 基千 流

的控制。

AP 1

AP2

控制层面 （ 网 络操作 系 统 ）

协议 OpenFlow

数据层面

图 4-70 协议 OpenFlow 是控制 层 面 和 数据 层 面 的 接 口

协 议 Ope nFlow 1 .0 是 200 9 年底发表的最早的版本， 之后每年都进行更新， 经过1 2次

• 1 94  •

