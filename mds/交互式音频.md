此 后 ， 音 频／视 频 文 件 被 下 载 ， 所 用 的 协 议 是 运 行 在 UDP 上 的 。 可 以 是 后 面要 介绍 的

RTP , 也 可 以 是 其 他 专 用 的 协 议 。 在 音 频／视频 流 播 放 的 过 程 中 ， 媒 体 播 放 器 可 以 随 时 暂 停

（ 利 用 PAUSE 报 文 ） 和 继 续播放 （ 利 用 PLAY 报 文 ） ， 也 可 以 快进或快退 。

© 用 户 在 不 想 继续 观看 时 ， 可 以 由 RTSP 客 户 发送 TEARDOWN 报 文 断开连接 。
0 媒体服务器 的 RTSP 服务器发送响应 RESPONSE 报 文 。
请 注 意 ， 以 上 编 号 的 步 骤 0 至 0 都使 用 实 时 流 协 议 RTSP 。 在 图 8-8 中 步骤 ＠ 后 面 没 有
则 使 用 另 外 的 传 送 音 频／视频数据 的 协 议 ， 如 RTP 。

“

”

编 号 的
音 频／视频流
8 . 3   交互式音频／视频

限 千 篇 幅 ， 在 本 节 中 我们 只 介 绍 交 互式音频 ， 即 IP 电 话 。

IP 电 话 是 在 互 联 网 上传 送 多
个 例 子 。 通过 IP 电 话 的 讨 论 ， 可 以 有 助 千 了 解 在 互 联 网 上传 送 多 媒 体信 息 应

一

媒 体 信 息 的
当 解 决好哪些 问 题 。
8.3. 1

IP 电 话概述

1 . 狭 义 的 和 广 义 的 I P 电话

IP 电话有 多 个英 文 同 义词 。 常 见 的 有 VoIP (Voice  over  IP),  Internet  Telephony 和 VON

“

”

“

(Voice On the Net) 。 但 IP 电 话 的 含 义 却 有 不 同 的解释 。
狭义 的 IP 电话就是指在 IP 网 络上 打 电话 。 所谓

”

交 换 网
不过 在互联 网 中 至 少 要 有

一

个 IP 网 络 。

的 简 称 。 这 里 的 网 络可 以 是 互 联 网 ， 也 可 以 是包含有传 统 的 电 路 交换 网 的 互联 网 ，

IP 网 络

就是

使用 IP 协 议 的 分 组

广义 的 IP 电 话 则 不仅仅是 电话通信 ， 而 且 还 可 以 是在 IP 网络上进行 交 互 式 多 媒体 实 时
通 信 （ 包括话音 、 视像等 ） ， 甚 至 还 包 括 即 时传信 IM (Instant  Messaging) 。 即 时传 信 是在 上

网 时 就 能 从屏幕上 得 知 有 哪 些朋 友 也 正 在 上 网 。 若有 ， 则 彼此可在 网 上 即 时 交换信 息 （ 文 字

的 或 声 音 的 ） ， 也 包 括 使 用
Skype 、 QQ 和 MSN Messenger [CHEN07] ， 很 受 网 民 的 欢迎 。
的 多 媒体服务平 台 ， 是 话 音 、 视像 、 数据综合 的 基础 结 构 。 在 某 些 条件 下 （ 例 如 使 用 宽 带 的

点 对 多 点 的 多 播 技 术 。 目 前 流 行 的 即 时 传 信 应 用 程 序 有 微 信 、

IP 电话可看成是

个 正 在 演 进

一

一

一

局 域 网 ） ，

IP 电 话 的 话 音 质 量甚至还优千普通 电话 。

下 面讨 论狭 义 的 IP 电话 [COLLO l ] ， 而广 义 的 IP 电话在原理上是

样 的 。

其 实 IP 电 话 并 非新概念 。 早在 20 世 纪 70 年代初期 ARPANET 刚开始运行 不 久 ， 美 国

一

即 着手 研 究 如 何在计算机 网 络上传送 电话信 息 ， 即 所 谓 的 分组话音通信 。 但在很长
里 ， 分组话音通 信 发 展 得 并 不 快 。 主 要 的 原 因 是 ：

段 时 间

( 1 ) 缺 少 廉价 的 高质 量 、 低速率 的 话 音 信 号编解码软件和 相 应 的 芯 片 。

(2) 计算机 网 络 的 传输速率和 路 山 器处理速率均 不 够 快 ， 因 而 导致传输时 延 过 大 。
(3) 没 有 保 证 实 时通信服务质量 QoS (Quality of Service) 的 网 络协议 。
(4) 计 算机 网 络 的 规模较 小 ， 而通信 网 只 有在 具 有

定规模后 才 能产 生经济效 益 。

一

2.  I P 电话 网 关

然 而 到 了 20 世 纪 90 年代 中 期 ， 上述 的 几 个 问 题 才 相 继 得 到 了 较好 的 解 决 。 千 是美 国 的

•  379 •

Voc alTec 公司在19 9 5年初率先推 出了实用 化的IP电话。 但是这种 IP电话必须使用PC。 19 9 6
个转 折 点 ： Voc al Tec 公司成功地推 出了 IP 电 话网关 C IP Te lep hon y

年 3 月， IP电话进入 了

一

Gate way)， 它是公用电话网

＠

与 I P 网络 的接 口 设 备。 IP 电话网关的作用就是：

( 1 ) 在电话呼叫阶段和呼叫释放阶段进行 电 话 信 令的转换。

( 2) 在通话期间进行话音编码的转换。

有 了 这 种 IP 电话网关， 就 可实现PC 用户 到固定 电话用户 打 IP 电话（仅需经过IP电话
一

次）， 以及固定电话用 户之间打 IP电话（需要经过I P 电话网关两次）。

网关

图 8 -9 画 出了IP电话几 种不同的连接方式。 图中最上面 的情 况最简单， 是两个PC 用户

之间的通话。 这当然不需要经过 IP 电话 网关 ， 但必须是双 方都同时上网才能进行通话。 图

8 -9 中间的

一

种情况是PC 到固定 电话之间的通话。 最后

一

种情况是两个固定电话之间 打IP

电话， 这 当然是最方便的。 读者应当特别注 意在哪

一

部分是使用 电路交换还是分组交换。

_ - － - －三 － － 、、

互联 网 u

＼

- - - - - - - - - - - - - - - - - - -,  " .  �-

| PC 到 固 定 电话 「 － ～ ～ - - - - - -

少 ，

：＼』

IP 电话

I

、 、

J
公用 电 话网

/i-—

网 关

1

- - - － － - － - - - ＿ ＿ ＿:＿ _ ＿ 一 一 」 固 定 电 话到 固 定 电话 f - － － － － － － - － － 上 ＿ ＿ － － － － - -

�, .

i  I P 电话

公用 电话网 心 觅了/:尸酰

j  ： 网 关

LP 电话 ：

l-－－－－、二：二：

网 关 ：

．  电路交换

分组交换

电路交换

图 8-9

IP 电 话 的 几种连接方法

3.

I P 电 话的通话 质 量

IP 电话的通话质量与电路交换 电 话网的通话质量有 很 大 差别。 在 电路交换电话网中，

任何两端之间的通话质量都是有保证的。 但 IP 电话 则不然。 I P 电话的通话质量主 要 由 两个

因素 决定， 一 个是通话双方端到端的时延和时延抖动， 另

一

个是话音 分组的丢失率。 但 这 两

个因素都是不确 定的， 而是取决千 当 时网络上的通 信 量 。 若网络上的通信 量 非常大以致发生

了 网络拥 塞， 那么 端到端时延和时 延 抖动以 及分组丢 失率都会 很高， 这就 导 致 IP 电话的通

话质量 下 降。 因此， 一个用户使用 IP 电话的通话 质 量 取决于 当 时其他许 多用户的行为。 请
注意， 电路交换电话网 的情 况 则 完 全 不是这样。 当 电 路交换 电 话网的通信量太 大时， 往往使

我们无法拨通电话（听到的是忙音）， 即 电话 网 拒 绝 对 正在 拨 号的用户提供接通服务。 但是

O 注 ： 公用 电话网即 公用 电路交换 电话网 ， 又称 为传统 电话 网 或 电信 网 。

•  380  •

只 要 我们拨通 了 电 话 ， 那 么 电信 公 司 就 能 保证让用 户 享 受满 意 的 通话质 量 。

一

经验证 明 ， 在 电 话 交 谈 中 ， 端 到 端 的 时 延 不 应 超 过 250 ms , 否 则 交 谈 者 就会感 到 不 自
般 只 有 50~70 ms 。 但 经 过 同 步 卫 星 的 电 话 端 到 端 时 延 就超 过

然 。 陆 地 公 用 电话 网 的 时 延
2 5 0   ms , 一般人都不太适应经过卫星传送 的 过长 的 时 延 。
因 此 IP 电 话 必 须 努 力 减 小 端 到 端 的 时延 。 当 通信 线 路产生 回 声 时 ， 则 容许 的 端 到 端 时 延 就
更 小 些 （ 有 时 甚 至 只 容许几十毫秒 的 时 延 ） 。

IP 电 话 的 时 延 有 时会超过 250 ms ,

IP 电 话 端 到 端 时 延 是 由 以 下 几个 因 素造成 的 ：
( 1 ) 话 音 信 号 进 行模数转换要 产 生 时 延 。

一

一

(2) 已 经 数 字 化 的 话 音 比特流要 积 累 到

定 的 数 量 才 能够 装配成

个 话 音 分组 ， 这 也 会

产 生 时 延 。

(3) 话 音 分 组 的 发 送 需 要 时 间 ， 此 时 间 等 千 话 音 分 组 长 度 与 通信 线 路 的 数据 率之 比 。
(4) 话 音 分组 在 互联 网 中 经过许 多 路 由 器 的存储转发时 延 。
(5) 话音分组到达接 收端在缓存 中 暂存所 引 起 的 时 延 。
(6) 将话音分组还原成模拟话音信 号 的 数模转换也要产生

定 的 时 延 。

一

(7) 话 音 信 号在通信线路上 的 传 播 时 延 。

(8) 山 终端 设 备 的 硬 件 和 操 作 系 统产 生 的 接 入 时 延 。 由 IP 电 话 网 关 引 起 的 接 入 时 延 约
为 20~40 ms , 而 用 户 PC 声 卡 引 起 的接入时延为 20~ 1 80 ms 。 有 的 调 制 解调 器 （ 如 V.34 ) 还
会 再 增 加 20 ~ 40 ms 的 时 延 （ 由 千进 行 数 字信 号 处理 、 均衡等 ） 。

一

话 音 信 号 在 通 信 线 路 上 的 传 播 时 延

般 都 很 小 （ 卫 星 通 信 除 外 ） ， 通 常 可 不 予考虑 。 当

一

采 用 高速光纤主干 网 时 ， 上 述 的 第 三项 时 延 也 不 大 。

一

第

、 第 二 和 第 六 项 时 延 取 决 千 话 音 编 码 的 方 法 。 很 明 显 ， 在 保 证 话 音 质 量 的 前 提 下 ，
话 音信 号 的 数码 率 应 尽 可 能低 些 。 为 了 能 够 在 世 界 范 围 提供 IP 电话服务 ， 话 音 编 码 就 必 须
ITU-T 己 制 定 出 不 少 话 音 质 量 不 错 的低速率话音 编 码 的 标准 。 目 前适

的 国 际标 准 。

采 用 统
合 IP 电话使用 的 ITU-T 标 准 主 要 有 以 下 两 种 ：

( 1 )   G.729  话 音 速率 为 8 kbit/s 的 共辅结构代数码激励线性预测 CS-ACELP (Conjugate­

Structure Algebraic-Code-Excited Linear Prediction) 声码器 。

(2)  G.723 . 1   话音速率为 5 .3/6.3 kbit/s 的线性预测编码 LPC (Linear Prediction Coding)声

码 器 。

这两种标准 的 比较 见 表 8 - 1 。

标准 I 比特率 ( kbit/s )

I  帧大小 ( ms )

1  帧长 （ 字节 ）
1 处理 时 延 ( ms )
表 8-1 G.729 和 G.723. 1 的主要性 能比较

数字信号处理 M I PS

4

20

1 6

一

一

表 中 的 比特率是输入为 64 kbit/s 标准 PCM 信 号 时 在编码器输 出 的 数据 率 。 帧 大 小 是压
一
缩 到 每
个 帧运行编码算法所 需 的 时 间 。 帧

个 分组 中 的 话 音信 号 时 间 长度 。 处理时 间 是对

长 是

个 已 编 码 的 帧 的 字 节 数 （ 不 包 括 首 部 ） 。 数 字 信 号 处 理 MIPS （ 每 秒 百 万 指 令 ） 是 用

数 字信 号 处 理 芯 片 实 现 编 码 所 需 的 最 小 处 理 机 速 率 （ 以 每 秒 百 万 指 令 为 单 位 ） 。 如 使 用 PC
的 通 用 处 理机 ， 则 所 需 的 处理机 MIPS 还 要 高些 。 不 难看 出 ， G.723 . 1 标 准 虽然可得到更低
的 数据 率 ， 但 其 时 延 也 更 大些 。

•  3 8 1   •

要减少 上 述第四和第五项时 延较为 困 难 。 当网络发生拥 塞 而产生话音分组丢 失时， 还
”
) 对 丢失的话音分组进行处理 。 例如， 可使用

定的策 略（称为

丢失掩蔽算法

一

＂

必须采用
前

一

个话音分组来填补 丢失的话音分组的间 隙 。

接收端 缓 存 空间和播放时 延的大 小 对话音分组丢 失率和 端到端时 延也 有 很大的影响 。

图 8 - 10 说明了这
量） 、

良好

” “

“

一

问题 。 话音质量可分为 四个级别， 即

长途电话质量

”

“

基本可用

和

不 好

”
， 各对应千图 8 -10 中的

一

个区域。 越接近 坐标 原点，

”
（这是最好的质

“

话音质量就越好 。 我们假定某IP 电话的通话质量处在 图中 B 点的位置。 若增大接收端 缓 存

空间并增大播放时延， 则话音分组丢失率将减小， 但端到端的时 延将增大（如 图中的C 点） 。
继 续增大播放时延， 则话音分组丢失率将继 续减小， 趋 向 千网络所引起的丢失率（如图中的

D 点）， 但 D 点的端到端时延 很大， 话音质量很不好 。 反之， 若 将接收端缓存做得很小 并减
小 播放时延， 则端到端时延 将减小， 趋向于网络所引起的端到端时延（如图中的A 点）， 但

话音分组丢失率将会大大增加， 话音质量也不好 。

分 组
丢 失率

20 %

1 0 %

5 %

长 途 电 话
质 晕

，

良
� :

0 多 一 一

1 00 ms

400 ms
1 50 ms
图 8- 1 0 播 放 时 延 有 一 个 最 佳 值

端 到 端 时 延

可见接收端的播放时延 有

一

个最佳值 。 图中有

一

个点N , 相当千 端到端时延和话音分组

丢 失率都是最小的， 但实 际 上并不可能工作在这个点上 。

据统计， 当通话双方相距 3200 km 时， 互联网上的时 延 约 为30 ~100 ms （ 传播和排队），
而所有各 环 节的时 延 总和约为100 ~262 ms （在 两个IP 电话网关之间） 或170 ~562 ms （在两
个PC 之间） ［KAST 9 8] 。 可见为了减小时延， 应尽可能不要直接用PC 打 IP 电话 。

提高路 由 器的转发分组的速率对提高IP 电话的质量也是很重要的 。 据统计，

一

个跨大

西洋的 IP 电话

一

般要经过20 ~30 个路 由 器 。 现在

一

个普通路 由 器每秒可转发50 ~100 万个分

组 。 若能改用吉比特路 由 器 （ 又称为线速路 由 器）， 则每秒可转发 500 万 至 6000 万个分组
一

（ 即 交换速率达 60Gb it

/s 左 右） 。 这样还可进

步减少 由网络造成的 时 延 。

近 几年来， IP 电话的质量得到了很大的提高 。 现在许 多 IP 电话的话音质量已经优千固定

电话的话音质量 。

一

些电信运营商还建造了自己专用的IP 电话线路， 以便保证更好的通话质

提的就是S kyp eIP 电话， 它给全世界的广大用户带来了高
量 。 在 IP 电话领 域里， 最值得
品 质并且廉价的通话服务 。 S kyp e 使用了Glob al IP Sou n d 公 司 开发的互联网低比特率编解码

一

器 iLBC (i nt ernet Low  B it
质量优于传统的公用电话网（采用电路交换） 的话音质量 。 S kyp e 支持两种帧长 ： 20 ms （速
个话音分组块为304 bit ) 和30 ms （速率为 13.33 kbi t
率为15. 2 kbit

rat e Co dec ) [ RFC 3951 , 39 5 2]， 进行话音的编解码和压缩， 使其话音

个话音分组

/s ,

/s,

一

一

块为 400 b it )。 S kyp e 的 另

一

个特点是对话音分组的丢失进行 了特殊的处理， 因而能够容忍高

达30 ％的话音分组丢失率， 通话的用户

一

般感觉不到话音的断 续或迟 延， 杂音也 很 小 。

• 38 2  •

Skype 采用 了 P2P （ 见第 6 章 6.9 节 的 介 绍 ） 和 全球索 引 C Global  Index ) 技 术 提供快速
路 由 选择机制 （ 而 不 是 单 纯 依 靠 服 务 器 来 完 成 这 些 工 作 ） ， 因 而 其 管 理成本 大 大 降低 ， 在 用
户 呼 叫 时 ， 由 千 用 户 路 由 信 息 分 布 式 存储 千 互 联 网 的 节 点 中 ， 因 此 呼 叫 连 接 完 成 得 很 快 。
Skype 还采用 了 端 对端 的 加 密 方 式 ， 保证信 息 的 安 全 性 。 Skype 在 信 息 发送之前进行加 密 ，
在 接 收 时 进 行解密 ， 在 数据 传输过程 中 完 全 没 有 可 能 在 中 途被窃 听 。

由 千 Skype 使用 的 是 P2P 的 技 术 ， 用 户 数据主要存储在 P2P 网 络 中 ， 因 此必 须保证存
储 在 公 共 网 络 中 的 数据 是 可 靠 的 和 没有被篡 改 的 。 Skype 对 公 共 目 录 中 存储 的 和 用 户 相 关 的
数据 都采用 了 数字 签 名 ， 保证 了 数据无法被篡改 。

自 2003 年 8 月 Skype 推 出 以 来 ， 在 短 短 1 5 个 月 内 ， Skype 已拥有超过 5000 万 次 的 下
一

载量 ， 注 册量超过 2000 万用 户 ， 并且还在 以每 天超过 1 5 万 用 户 的 速度 增 长 。 在 20 1 1 年 ，
时 间 使用 Skype 的 用 户 数 已 经 突 破 了 3000 万 大 关 。 据 统 计 ， 在 20 1 4 年 的 国 际长 途 电
在 同
话 的 市场份额 中 ， Skype 已经 占 据 了 40% 。 Skype 的 问 世给全球 信 息 技术 和 通 信 产 业 带 来深
远 的 影 响 ， 也给每
8.3.2

IP 电话所 需 要 的 几种 应 用 协议

位 网 络 使用 者带来 生活方 式 的 改 变 。

一

Q)

一

在 IP 电话 的 通信 中 ， 我 们 至 少 需 要 两种 应 用 协议 。 一种 是 信 令 协 议 ， 它 使我们 能够在
种 是 话 音 分 组 的 传送 协议 ， 它 使 我们 用 来进行 电 话通信 的 话
互 联 网 上 找 到 被 叫 用 户
音 数 据 能够 以 时 延 敏感属 性 在 互 联 网 中 传 送 。 这样 ， 为 了 在 互 联 网 中 提供 实 时 交 互 式 的 音 频
／视频服务 ， 我们 需 要新 的 多 媒体 体 系 结 构 。

。 另

一

图 8- 1 1 给 出 了 在这 样 的 体 系 结 构 中 的 三 种 应 用 层 协议 。 第

种 协 议 是 与 信 令有 关 的 ，

如 H.323 和 SIP （ 画 在 最 左 边 ） ； 第 二 种 协议是直接传送音频／视频数据 的 ， 如 RTP （ 画 在 最
右边 ） ； 第 三种 协 议是 为 了 提 高 服务质 量 ， 如 RSVP 和 RTCP （ 画 在 中 间 ） 。
信 令

音 频／视频

应 用 层协议

服 务 质 鼠

UDP

IPv4/IPv6

底 层 网 络

图 8- 1 1 提 供 实 时 交 互 式 音 频／视频服务所 需 的 应 用 层 协 议

下 面 先 介 绍 实 时运输协议 RTP 及其配套 的 协 议

实时运输控制协议 RTCP , 然 后 再 介

CD 注 ： 在 公 用 电 话 网 中 ， 电 话 交换 机 根据 用 户 所拨 打 的 号码就能够通过 合 适 的 路 由 找 到 被 叫 用 户 ， 并 在 主 叫 和 被 叫 之 间 建
一

一

(signaling)

立起

条 电 路连接 。 这 些 都 依 靠 电话信令

完成 。 我 们 听 到 的 振 铃 声 、 忙 音 或

些 录 音 提 示 ， 以 及 打 完 电 话挂 机释放连

接 ， 也 都 是 由 电话信 令 来 处 理 的 。 现在 电话 网 使 用 的 信 令就 是

7

某 种信 令 ， 但 由 千

IP

电 话 往往 要 经 过 已有 的 公 用 电话 网 ， 因 此

号 信 令
IP

SS7

IP

。 利 用

网 络 打 电 话 同 样 也 需 要

IP

网 络 能够识别 的

电话 的 信 令 必须 在 所 有 的 功 能 上 与 原 有 的 7 号 信 令相 兼 容 ， 这

样 才能 使

IP

网 络 和 公 用 电 话 网 上 的 两 种 信 令 能 够 互相转换 ， 因 而 能够做到互操作 。

•  3 83  •

绍 IP 电话的信令协议 H.323 和会话发 起协议 S IP 。

8 . 3 . 3   实 时运输协议 RTP

实 时运输协议 RT P ( R eal-tim e  T ran sp o rt  P rot oc ol) 是 IETF 的AVT 工 作组(Audi o Ni d eo

T ran sp o rt  WG)开发的协议， 现已成为互联网标准[ RFC 3550 ,  ST D64 ]  [ RFC  3551 , ST D65]。

RT P 为 实 时应用提 供 端 到 端的运 输， 但 不 提供任何服 务 质 量的保证。 需要发送的多 媒

体数据块（音频／视频） 经过 压缩编码处理后， 先送给 RT P 封装成为 RT P 分组（也 可称为

R TP 报 文

CD

)。 RT P 分组装入运 输层的 UDP 用户数据报 后， 再向 下 递交给 IP 层。 RT P 现已

成为互联网正式标准， 并且已被广泛使用。 RT P 同时也是 IT U -T 的标准 (H. 225. 0 )。 实 际上，
些共同功能 。 R 'fP 自己并不对多媒体

个协议 框 架， 因为它只包含了实时应用的

RTP 是

一

一

数据块做任何处理， 而 只是向应用层提供

一

些附加的信息， 让应用层知道应当如何进行处理。

图8 -11 把 RT P 协议 画在应用层。 这是因为从应用开发者的角度看， RT P 应当是应用层

一

的

部 分。 在应用程 序的发送端， 开发者必须编 写用 RT P 封装分组的程 序 代码， 然后把

RT P 分组交给 UDP 套接字接 口 。 在接收端， RT P 分组通过 UDP 套接字接 口 进入 应用层后，

还要利用开发者编 写的程序代码从 RT P 分组中把应用数据块提取出来。

然 而 RT P 的名称 又 隐含地表示它是

一

个运输层协议 。 这样划分也是可以的， 因为 RT P

封装了多媒体应用的数据块， 并且由 千 RT P 向多媒体应用程 序 提供了服务（如时间戳和序

号）， 因此也可以把 RT P 看成是在 UDP 之上的

一

个运输层子层的协议 。

R TP 还有两点值得注意。 首先， RT P 分组只包含 RT P 数据， 而控制是 由 另

用的 RTCP 协议 提供的（这在下

一

节 介 绍）。 其次，

个配套使
RT P 在端 口 号 10 25 到 655 35 之间选择

一

一个未使用的偶数 UDP 端 口 号， 而在同

一

次会话中的 RTCP 则使用 下

一

个奇数 UDP 端 口 号。

但端 口 号 5004 和5005 则分别用作 R TP 和 RTCP 的默认端 口 号。

图8 -1 2 给出了 RT P 分组的首部格式， 下面进行简单的介 绍 。

位 0 I

3

版对 叫对 参 与原数1Mi 有 效载荷类型 l

1 6

8

序

号

时 间 戳

同 步 源 标 识 符 (SSRC)

参 与 源 标 识 符 (CSRC) [O. . 1 5]
． ． ．

3

丁

12

上

发送

IP 首 部 I UDP 首 部 j -RTP 首 部 I RTP 数据 部 分 （ 应 用 层 数据 ）

|

RTP 分 组
UDP 用 户 数据 报

IP 数 据 报

图 8- 1 2 RTP 分 组 的 首 部格 式

＠ 注： 按惯例 ， 在运输层或应 用 层 的 协 议 数 据 单 元应 当 叫 作 报 文 。 但 相 关 RFC 文 档 中 都 是 使 用 RTP packet 这

一

名 词 的 。

为 了 和 RFC 文 档

一

致 ， 这 里 也 使 用 “

RTP 分组

”

。 下

一

节 的 RTCP 也 按 同 样 方法处理 。

•  384  •

在 RT P 分组的首部 中 ， 前 12 个字节是必需的， 而 1 2 字节以后的部分则是可选 的。 下

面按照各字段重要性的顺序来进行介绍。

(1) 有效载荷类 型( payl oad t ype )

占7 位。 这 个字段指出后面的 RT P 数据属 千何种格

式的应用 。 收到 RT P 分组的应用层就根据此字段指出的类型进行处理。 例如， 对千音频有

效载荷 （ 每

一

种格式后面括 弧中的数字就表 示其有 效载 荷类型的编码） ： µ律PCM (0), GSM
 A 律PCM ( 8 )

 G.7 22  (9 ) , G.72 8  (15 )等。 对千视频有效载 荷 ： 活动JPE G ( 26) ,

(7 )

(3) , LPC
H. 261  (3 1), MPE G  I  (32) , MP EG2  (33)等。

( 2) 序号

占 16 位。 对每

一

个发送出的 RT P 分组， 其序号加 1 。 在

一

次 RT P 会话开

始 时的初始 序 号是随机选 择的。 序 号使接 收 端 能够发 现 丢 失的分组， 同时也 能将失序的

RT P 分组重新按序排列好。 例如， 在收到序 号为 60 的 RT P 分组后又 收到 了 序号为 65 的

RTP 分组。 那么 就可推断 出 ， 中间还缺少 序号为61 至 64 的4 个 RT P 分组。

(3) 时间 戳

占32 位。 时间戳反 映 了 RT P 分组中数据的第

一

个字节的采样时刻。 在

一

次会话开始时时间戳的初始值也是随机选 择的。 即使在 没有信 号发送时， 时间戳的数值也

要随时间而不断地增加。 接收端使用 时间戳可准确知道应 当在什么 时间还原哪

一

个数据块，

从而 消 除时延的抖动。 时间戳还可以用来使视频应用中 声音和图像同步。 在 RT P 协议 中并

没有规 定时 间 戳的粒度， 这取决于有 效载 荷的类型。 因此 RT P 的时间戳又称为媒体时 间 戳 ，

以 强 调 这种时间 戳的粒 度取决千信号的类型。 例如， 对千 8 kHz 采样的话音信号， 若每 隔

一

个数据块， 则

一

个数据块中包含有160 个样本 (0. 02 X  8000  =  }60 )。 因此发送

20 ms 构成
一

端每发送

个 RTP 分组， 其时间戳的值就增加160 。

(4) 同 步源标识符

占32 位。 同 步源标识符SS RC (S ync hron ous S ou RCe id ent i fier)是
一个数， 用来标志 RT P 流(stream )的来源。 SS RC 与IP 地址无关， 在新的 RT P 流开始时随机

地产生。 山于 RT P 使用 UDP 传送， 因此可以有 多个 RT P 流 （ 例如， 使用几 个 摄 像机从不

同角 度 拍摄同

一

个 节目所产生 的 多 个 RTP 流 ） 复 用到

一

个 UDP 用户数据报 中。 SS RC 可使

接收端的 UDP 能够将收到的 RTP 流送到 各 自 的终点。 两 个 RTP 流恰好都选 择同

的概率是极小的 。 若发生 这种情况， 这两 个源就都重新选 择 另

一

个SS RC。

一

个SS RC

(5) 参 与 源标识符

这是选项 ， 最 多可有 15 个。 参 与 源标识符CS RC (Contributi n g

S ou RCe id enti fier)也是

一

个32 位数， 用来标志来源千不同地点的 RTP 流。 在 多 播环 境中，

可以用 中间的

一

个站 （ 叫作混 合 站 mixer ) 把 发往 同

一

个地点的多 个 RT P 流混合成

一

个流

（ 可节 省通信 资源）， 在目的站再根据CS RC 的数值把不同的 RT P 流分开。

(6) 参 与 源数

占 4 位。 这 个字段给出后面 的 参与源标识符的数目。

(7) 版本
( 8 ) 填 充 P

占2 位。 当前 使用的 是版本2 。

占 1 位。 在 某些特殊情 况 下需 要 对 应用数据块 加 密， 这往往要求每

一

个

数据块有确定的长度。 如不满 足 这种长度要求， 就需要进行填充。 这时就把P 位置 1 ， 表示

这个 RTP 分组的数据有 若干填充字节。 在数据部分的 最 后

一

个字节用来表示所填充的字节

数。

(9) 扩展 X

占 1 位。 X 置1 表示在此 RT P 首部后面还有扩展首部。 扩展首部很少使

用， 这 里不再讨论。

(10) 标记M

占 1 位。 M 置l表示这 个 RT P 分组具有特殊意义。 例如， 在传送视频

流时用来表示每

一

帧的开始 。

• 385  •

,
,
8.3 .4  实 时 运输控制 协 议 RTCP

RTCP (RTP  Control  Protocol)

RTP

[RFC 3 550,

355 1 ]

RTCP
实时运输控制协议

RTP

是 与

RTCP
， 实 际上 ，

协议也是

协议不 可分割 的 部 分 。

配合使用 的协议
一

协议 的 主 要 功 能 是 ： 服务质 量 的 监视 与 反 馈 、 媒 体 间 的 同 步 （ 如 某

RTCP

RTCP
个

RTP

发 送

UDP

RTCP
的 声 音 和 图 像 的 配 合 ） ， 以 及 多 播组 中 成 员 的 标 志 。
一

分 组 （ 也 可 称 为

RTCP

报 文 ） 也

使 用

RTCP

来传送 ， 但

并 不对 音 频／视频分组进行封装 。 由 于

RTCP

UDP

分 组 很 短 ， 因 此可

把 多 个

分组封装在

个

用 户 数据报 中 。

分组周 期 性地在 网 上传送 ， 它 带

有发送端和 接收端对服务 质 量 的 统计信 息报告 （ 例 如 ， 已 发 送 的 分组数和字节 数 、 分 组 丢 失

RTCP
率 、 分 组 到 达 时 间 间 隔 的 抖 动 等 ） 。

8-2

表

是

使 用 的 五种 分组类型 ， 它 们都使用 同 样 的 格 式 。

表 8-2 RTCP 的 五种分组类型

类 型
200

2O l

202

203

204

缩 写 表 示

SR

RR

SDES

BYE

APP

意义

发送端报告

接收端报告

源 点 描述
结 束

特 定 应 用

BYE

一

结束分组

APP
表 示 关 闭

个数据 流 。

特定应 用 分组
一
一
RTP
接收端报告分组

收 到

个

流 （

RR

使应用 程序能够 定 义 新 的 分 组 类 型 。

一

用 来使接收端周 期 性地 向 所有 的 点 用 多 播方式进行报 告 。 接收端每

RTP

RR

RR

组 的 内 容有 ： 所 收 到 的

流 的

该

RTP

次会话包含 有 许 多 的

S SRC ;

RTP

RTP

流 ） 就产生

个接收端报 告 分 组
RTP
流 的 分组 丢 失 率 （ 若 分组丢 失 率太 高 ， 发

分

一

。

送端就应 当 适 当 降低发送 分 组 的 速率 ） ； 在 该

流 中 的 最 后

个

分 组 的 序 号 ； 分 组

RR
到 达 时 间 间 隔 的 抖动 等 。

一

发送

分组有两个 目 的 ： 第

RTCP

， 可 以 使所有 的接收端和 发送端 了 解 当 前 网 络 的状 态 ；

RTCP

第 二 ， 可 以 使所有发送

RTCP

分 组 的 站 点 自 适应地调 整 自 已发送

RTP

分 组 的 速 率 ， 使得起

控 制 作 用 的
RTCP

分 组不 要 过 多 地影 响 传送应用 数据 的

5%

分组在 网 络 中 的 传 输 。 通 常 是

分 组 的 通信 量不超过 网 络 中 数 据 分 组 的 通信 量 的

RTCP

75%

， 而接收端报 告 分组 的 通信 量

使
又应小 千所有
一

SR
分 组 的 通信 量 的

。

一

发送端报告分组

RTP

SR
用 来使发送端周 期性地 向 所有接收端用 多 播 方式进行报 告 。 发送端

RTP

SR

每发送

个

SSRC ;
流 ， 就要发送

RTP

个发送端 报 告 分 组

RTP

的 同 步源标识符

wall clock time )
该

上 时 钟 时 间

； 该

RTP
流 中 最新产生 的
一

RTP

流包含 的 分组数 ； 该

分 组 的 主要 内 容 有 ： 该

流
。
分组 的 时 间 戳和 绝对 时 钟 时 间 （ 或墙

RTP

一
流 包 含 的 字 节 数 。

绝对 时钟 时 间 是 必 要 的 。 因 为

要 求 每

种媒体使用

像 和 相 应 的 声 音就 需 要传送两个流 。 有 了 绝对 时 钟 时 间 就可进行 图 像和 声 音 的 同 步 。

SDES

(Canonical NAME)

源 点 描 述 分 组

给 出 会 话 中 参 加 者 的 描 述 ， 它 包 含 参 加 者 的 规 范 名

。 规 范 名 是 参加 者 的 电子 邮件地址 的 字 符 串 。

•  3 86  •

个流 。 例 如 ， 要传送视频 图
CNAME

8.3 .5  H.323

一

一

现 在 IP 电 话 有 两 套 信 令标 准 ：

套 是 ITU-T 定 义 的 H.323 协 议 ， 另
的 会话发起协议 SIP (Session Initiation Protocol) 。 我们 先 介 绍 H.323 协 议 。

“

”

套 是 IETF 提 出

H.323 是 ITU-T 千 1 996 年 制 定 的 为在 局 域 网 上传 送话音信 息 的 建 议 书 。

1 998 年 H.323

基千分组 的 多 媒体通信系统

的 第 二个版本改用 的 名 称 是
基 千 分组 的 网 络包括互联 网 、 局 域 网 、 企业 网 、 城域 网 和 广 域 网 。 H.323 是 互联 网 的 端 系 统
之 间 进 行 实 时 声 音 和 视频会 议 的 标准 。 请注意 ， H.323 不 是
H.323 包 括 系 统 和 构 件 的 描 述 、 呼 叫 模 型 的 描 述 、 呼 叫 信 令过程 、 控制 报 文 、 复 用 、 话音编
解码器 、 视像编解码 器 ， 以 及 数据协议等 。 图 8- 1 3 示 意 了 连接在分组交换 网 上 的 H.323 终
端使用 H.323 协议进行 多 媒 体通信 。

。 在 2009 年 已 更 新 到 H.323v7 。
一

个单独 的 协议而是

组协议 。

一

图 8- 1 3 H.323 终 端 使 用 H.323 协议 进 行 多 媒体通信

H.323 标 准指 明 了 四 种 构 件 ， 使 用 这些构件 连 网 就 可 以 进 行 点 对 点 或

一

体通信 。

一

点 对 多 点 的 多 媒

个 PC , 也 可 以 是运 行 H. 323 程序 的 单个设备 。

( l ) H.323 终端
(2) 网 关

这 可 以 是
一

网 关连接到两 种 不 同 的 网 络 ， 使得 H.323 网 络 可 以 和 非 H.323 网 络 （ 如 公

用 电话 网 ） 进行通信 。 仅 在
(3) 网 闸(gatekeeper)

个 H.323 网 络 上通信 的 两 个终端 当 然就不 需 要使用 网 关 。
网 闸 相 当 千 整 个 H.323 网 络 的 大脑 。 所 有 的 呼 叫 都要通过 网 闸 ，
因 为 网 闸 提供地址转换 、 授权 、 带 宽 管理 和 计 费 功 能 。 网 闸 还 可 以 帮 助 H.323 终端找 到 距 离
公 用 电 话 网 上 的 被 叫 用 户 最近 的

个 网 关 。

一

(4) 多 点控制 单 元 MCU (Multipoint  Control  Unit)

MCU 支持三个 或更 多 的 H.323 终

端 的 音 频或视频会 议 。 MCU 管理会议 资 源 、 确 定 使用 的 音频 或视频编解码 器 。

一

网 关 、 网 闸 和 MCU 在 逻 辑 上 是 分 开 的 构 件 ， 但 它 们 可 实 现 在
H.323 标准 中 ， 将 H.323 终端 、 网 关和 MCU 都称为 H.323 端点(end point) 。
图 8- 1 4 表 示 了 利 用 H.323 网 关 使 互联 网 能够 和 公 用 电 话 网 进 行连接 。

个 物 理 设 备 中 。 在

＼

公用 电 话 网

渲

图 8- 1 4 H.323 网 关 用 来和 非 H.323 网 络进行连接

一

图 8- 1 5 给 出 了 H.323 的 体 系 结 构 。 可 以 看 出 ， H.323 是

一

个协议族 ， 它 可 以 使用 不 同

的 运输协议 。 H.323 包括 以 下

些组成 部 分 ：

•  3 87  •

音 频／视频 应 用口编 解 码 编 解 码 R TCP

RTP

UDP

数 据 应 用

T. 1 20
数据

信 令 和 控制

H .225.0 I H .225.0 I  H . 245

登记
信 令

呼 叫
信 令

控制
信 令

IP

TCP

图 8- 1 5 H.323 的 协 议 体 系 结 构

( 1 ) 音 频编解码器 H.323 要求 至少要支持 G. 711 ( 64  kbit/s 的 PCM )。 建议 支持如

G. 722  C 16  kbit/s 的A DPCM ) ,G.7 23. 1  ( 5. 3/6.3 的LPC) ,G.728  C 16  kbit/s 的低时延CE LP )

和G. 7 29

( 8  kbit/s 的CS -ACE LP ) 等。

( 2) 视频编解码器 H. 323 要求必须 支持H. 261 标准 C I76  x 144 像素）。
(3)  H. 2 5 5. 0 登 记 信 令 ， 即 登 记 ／ 接 纳 ／ 状 态 RAS ( R egist ration / Admissi on/St atus ) 。

H.323 终端和网 闸 使用 R AS 来完成登记、 接纳控制和 带 宽 转换等功能 。
( 4 )  H. 22 5. 0 呼 叫 信 令 用来在两个H.323 端点之间 建立连接。
( 5) H. 24 5 控制 信 令 用来交换端到端的控制报 文， 以便管理H. 323 端点的运行。
( 6 )   T. 1 20 数据传送协议

这是与呼叫相关联的数据交换协议 。 用户在参加音频／视频

会议时， 可以和其他与会用户共享屏 幕上的 臼板。 由 千使用 TCP 协议， 因此能够保证数据

传送的正确（在传送音频／视频文件时使用的是 UDP , 因此不能保证服务质量）。

(7) 实 时运输协议 RT P 和实 时运输控制协议 RTCP

这 两个协议前面已 讨论。

H.323 的出发点是以已 有的电路交换 电话网为基础， 增加了I P 电话的功能（即远距离

传输采用IP 网络）。 H.323 的信 令也 沿 用 原有电话网的信令模式， 因此与原有电话网的连接

比较容 易 。

8.3.6  会话 发起协议 SIP

虽然H.323 系列现在 已被大 部分生产IP 电话的厂商采用， 但 由 千H.323 过千复 杂（整
个 文档多达 736 页）， 不便千发展基千IP 的新业务， 因此IE TF 的MM USIC 工作组制定了 另
一 套较为简单且实用的标准， 即会话发 起协议 SIP (S essi on I niti ati on P rot oc ol )  [ RFC 3261 -

3264]， 目前已成为互联网的 建议 标准 。 SIP 使用 了 KI SS 原 则 ： 即
( Keep  It  Simp l e  and  Stup id)。

“

保持简单、 傻 瓜

”

SIP 协议的出发点是以互联网为基础， 而把IP 电话视为互联网上的新应用。 因此 SIP
协议只涉及IP 电话所需的信令和有关服务质量的问题， 而没有提供 像H.323 那样多 的功能。

SIP 没有 强制使用特定的编解码器， 也不强制使用 R TP 协议 。 然而， 实 际上大家还是选 用

RT P 和 R TCP 作为配合使用的协议。

SIP 使用文本方式的客户－服务器协议 。 SIP 系统只有两种构件， 即用户代理(us er agent )

和网络服 务器( netw o rk s erver) 。 用户代理包括 两 个 程 序， 即用户代理客户 UAC ( Us er A gent

Cli ent )和用户代理服 务器 UAS ( Us er A gent  S erver) ， 前者用来发起呼叫， 后者用来接受呼叫 。
网络服务器 分为代理服 务器(p rox y s erver)和 重定 向服 务器( redi rect s erver)。 代理服务器接受

来自主叫用户的 呼叫请 求（实 际上是来自用户代理客户的 呼叫请 求 ）， 并将其转发给被叫用

一

户或 下

跳代理服务器， 然后下

一

跳代 理服务器 再把 呼叫请求转发给被叫用户（实 际上是转

发给用户代 理服务器）。 重定向 服务器不接受呼叫， 它通过响应告诉客户 下

一

跳代理服务器

• 388  •

一

的地址 ， 由 客户 按此地址 向 下

跳代理服务器重新发送 呼 叫 请 求 。

一

SIP 的地址十 分灵活 。 它 可 以 是 电话 号码 ， 也 可 以 是 电 子 邮件地址 、

IP 地址或其他类型

的地址 。 但

定 要 使 用 SIP 的地址格式 ， 例 如 ：

•  电 话 号 码

•

1Pv4 地址

sip:zhangsan@8625-87 65432 1
sip:zhangsan@20 1 . 1 2.34.56

•  电 子 邮件地址

sip :zhangsan@ l 63.com

一

和 HTTP 相 似 ， SIP 是 基 千 报 文 的 协 议 。 SIP 使 用 了 HTTP 的 许 多 首 部 、 编 码规 则 、 差

错码 以 及

些 鉴 别 机制 。 它 比 H.323 具有更好 的 可扩缩性 。

一

SIP 的 会话共有三个 阶 段 ： 建立会话 、 通 信 和 终止会话 。 图 8- 1 6 给 出 了

个 简 单 的 SIP

会 话 的 例 子 。 图 中 的 建立会话阶段和 终止会话阶段 ， 都是使用 SIP 协议 ， 而 中 间 的 通 信 阶 段 ，

则 使用 如 RTP 这样 的 传 送 实 时 话 音 分 组 的 协 议 。

被 叫 方

主 叫 方＼三

建立
会 话

通 信

终 止
会 话

INVITE: 地址 ， 选项

OK： 地址

ACK

电话交谈

BYE

图 8-1 6一个简 单 的 SIP会 话 的 例 子

一

在 图 8- 1 6 中 ， 主 叫 方 先 向 被 叫 方 发 出 INVITE 报 文 ， 这个报 文 中 含 有 双 方 的地址信 息

以及 其他

些信 息 （ 如 通话 时 话音编码方式等 ） 。 被 叫 方 如 接 受 呼 叫 ， 则 发 回 OK 响 应 ， 而

主 叫 方 再 发送 ACK 报 文 作 为 确 认 （ 这 和 建立 TCP 连接 的 三报 文 握 手 相 似 ） 。 然 后 双 方 就 可

一

以 通话 了 。 当 通话 完 毕 时 ， 双 方 中 的任何

一

方 都 可 以 发送 BYE 报 文 以 终止 这 次 的 会 话 。

SIP 有

种 跟 踪 用 户 的 机制 ， 可 以 找 出 被 叫 方使用 的 PC 的 IP 地址 （ 例 如 ， 被 叫 方使 用
一

一

DHCP , 因 而 没 有 固 定 的 IP 地址 ） 。 为 了 实现跟踪 ， SIP 使用 登 记 的 概念 。 SIP 定 义

些服务

一

器作 为 SIP 登记器(registrar) 。 每

个 SIP 用 户 都有

一

个 相 关 联 的 SIP 登记器 。 用 户 在任 何 时

候 发 起 SIP 应 用 时 ， 都 应 当 给 SIP 登记器发送

个 SIP REGISTER 报 文 ， 向 登记器报告现在

一

使 用 的 IP 地址 。 SIP 登记器和 SIP 代理服务器通常运行在 同

台 主机上 。

图 8- 1 7 说 明 了 SIP 登记 器 的 用 途 。 主 叫 方 把 INVITE 报 文 发送给 SIP 代理服务器 。 这

个 INVITE 报 文 中 只 有被 叫 方 的 电 子 邮件地址 而 没 有 其 IP 地址 。 SIP 代理服务器 就 向 SIP 登

记 器 发送域名 系 统 DNS 查 询 （ 这 个查 找 报 文 不 是 SIP 的 报 文 ） ， 然 后 从 回 答 报 文 得 到 了 被 叫

方 的 IP 地址 。 代理服务器把得到 的被 叫 方 的 IP 地址插入到主 叫 方发 送 的 INVITE 报 文 中 ，

转发给被 叫 方 。 被 叫 方发送 OK 响 应 ， 然 后 主 叫 方发送 ACK 报 文 ， 完 成 了 会话 的 建 立 。

•  389 •

｀

被叫方

SIP

代理
服务器

主叫方

INVITE

OK

ACK

- I

SIP

登记器

圣

i t

INVITE

OK

ACK

查找

回答

电话交谈
BYE

图8-17 跟踪被叫方的机制

如果被叫没 有在这个 SIP登记器进行过登记， 那么这个 SIP登记器就发回重定向报(cid:4825)，

指示SIP代理服务器向另

一

个 SIP登记器重(cid:4842)进行DNS查询， 直到找到被叫为止。 图 8-17

给出了这种情况下主叫(cid:4851)发出确认之前的呼叫过程。

SIP还有

一

个配套协议是会话描述协议SDP( S essio n  D es cripti o n  P roto col)。 SDP在电话

会议的情况下特别重要， 因为电话会议的参加者应当能够动态地加入和退出。 SDP详细地

指明了媒体编码、 协议的端口号以及多播地址。 SDP现在也是互联网建议标准[RFC 8866]。

由于 SIP问世较晚， 因此它现在比H.3 23占有的市场份额要小。 对今后作为IETF标准

的SIP协议的进展情况应当引起我们的注意。

8.4  改进

“

尽最大努力交付

＂

的服务

使互联网更好地传送多媒体信息的另

一

种(cid:4851)法， 是改变互联网平等对待所有分组的思

想， 使得对时延有较严格要求的实时音频／视频分组， 能够从网络得到更好的服务质量QoS。

下面我们先介绍提供服务质量的

一

般(cid:4852)法。

8.4.1  使互联网提供服务质量

根据ITU-T在建议书 E .800 中 给出的定义， 服务质量QoS是服务性能的总效果， 此效
果决定了 一个用户对服务的满意程度。 因此在最简单的意义上， 有服务质量的服务就是能够
满足用户的应用需求的服务， 或者说， 可提供

致的、 可预计的数据交付服务。

一

在涉及

一

些具体问题时， 服务质量可用若干基本的性能指标来描述， 包括可用性、 差

错率、 响应时间、 吞吐量、 分组丢失率、 连接建立时间、 故障检测和改正时间等。 服务提供

者可向其用户保证某

一

种等级的服务质晕。

我们已多次强调过， 互联网的网络本身只能提供

“

＂
尽最大努力交付

的服务。 而要传

送多媒体信息， 网络又必须具有

一

定的服务质量。 下 面 通过图 8-18的例子说明应从哪些(cid:4851)

面 入手使互联网具有

一

定的服务质量[KUR017]。 图中 表示局域网上的两台主机凡和H2 通

•  3 90 •

