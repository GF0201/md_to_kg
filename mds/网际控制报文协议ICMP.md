4 .4  网 际控制报文协议 I C M P

为了更有效地转发 IP数据报和 提高交付成功的机 会 ， 在网际层使用了网 际控制报文协
s age Protocol)  [RFC  792,  STD5] 。IC MP允 许主机或 路由器报
议 ICMP (I nte rne t C ontrol  Me s
告差错情况和 提供有关异 常情况的报告。IC MP是 互(cid:7110)网的标 准 协 议 。 但IC MP不是高层协
议（ 看起来 好像是高层协议 ， 因 为IC MP报文 装 在IP数据报 中 ， 作为其中 的数据部分）， 而
是IP层的协议。IC MP报文作为IP层数据报的数据 ， 加上数据报的首部， 组成IP数据报发

送出去。IC MP报文 格 式 如 图4-28 所示。

前 4 个字节

是 统

的 格 式

位 0

类型
（ 这

4

一

ICMP

8

1 6

3 1

代码

检验和

个字节取决千

报 文 的 类 型 ）

ICMP
的 数 据 部 分 （ 长度取决于类型 ）

首 部

,

数 据 报

IP

•

图 4-28

ICMP 报文的格式

4.4. 1

ICMP 报 文 的 种 类

IC MP报文 有两种 ， 即 ICMP 差错报告报文和 ICMP 询 问 报文。
IC MP报 文的前4 字(cid:7188)是 统 一的格 式 ， 共有三个字段： 类型 、 代码和检
验和。 接着的 4 字(cid:7188)的 内 容 与 IC MP 的类型有关 。 最后面是数据字段 ， 其

扫 一 扫

视频讲解

长度取决于IC MP 的类型 。 表4-6 给出了几种常用的IC MP报文类型 。

表 4-6 几种常用 的 I CM P 报文类型

报 文 种 类

类型的值

ICMP

报 文 的 类型

ICMP

差错报告报文

询 问 报 文

3

I I

12

5

终 点 不可达

时 间 超过

参数 问 题

改变路 由 (Redirect)

8 或 0

回 送(Echo)请求或 回 送 回 答

1 3 或 1 4

时 间 戳(Timestamp)请求或时 间 戳 回 答

IC MP标准在不断更新。 已 不再使用 的IC MP报文有：

“ 信 息请 求与回答报 文

” “ 地址掩

码请求与回答报文 ” “

路由器请 求与通告报文 ”

以及

“ 源 点 抑 制报文 ” [RFC 6633] 。

IC MP 报文的代码字段用于进一 步 区分某种类型中的几种不 同情况。 检验和字段用 来 检

验 整 个IC MP报文 。 我们应当还记得 ， IP数据报首部的检验和并不检验IP数据报的 内 容 ，

因此不(cid:7126)保证经过传输的IC MP报文不产 生 差 错。

表4-6 给出的IC MP差错报告报文共有四种 ， 即 ：

(1 ) 终 点 不 可达 当路由器或 主机不(cid:7126)交付数据报时就向源 点发送终点 不可达报文 。

• 1 46  •

(2

) 时间 超 过 当路由器收到 生存时间为零的数据报时 ， 除丢弃该数据报外 ， 还要向
源点发送时间超过报文 。 当终点在预先规定的时间 内 不(cid:7126)收到 一个数据报的全部数据报 片时 ，
就把 已收到的数据报片 都丢弃， 并向源点发送时间 超过报文 。

(3) 参数 问 题 当路由器或目的主机收到的数据报的首部中有的字段的值 不正 确 时，

就丢弃该数据报 ， 并向源点发送参数问题报文 。

(4 ) 改 变 路 由 （ 重定 向 ）

路由器把 改 变 路由报文发送给主机 ， 让主机知道下次应将

数据报发送给另 外的路由器 （ 也就是说 ， 找到了更好的路由）。

下 面对 改变 路由报文进行简短的解释 。 我们知道 ， 在互 (cid:7110) 网的主机中也要有一个转发
表。 当主机要发送数据报时， 首先查找主机 (cid:7151) 己的转发表， 看应当从哪 一个接口把数据报发
送出去。 在互(cid:7110)网中主机的数量远大于路由器的数量 ， 出 于效率的考虑 ， 这 些主机不和 连接
在网络上的路由器定 期 交换路由信 息 。 在主机 刚 开始工作时 ， 一 (cid:7182)都在转发表中设置一个默
认路由器的 IP 地址。 不管数据报要发送到哪个目的地址 ， 都一 律 先把数据报传送给这个默
认路由器 ， 而这个默认路由器知道到 每一个目的网络的最佳路由（通过和 其他路由器交换路

由信 息）。 如果默认路由器发现主机发往某个目的地址的数据报的最佳路由应当经过网络 上
的另 一个路由器 R , 就用改变路由报文把这 情况告诉主机。 千是 ， 该主机就在其转发表中增
加一个项目： 到 某 某目的地址应经过路由器 R（而不是 默认路由器）。

所有的IC MP差错报告报文中的数据字段都具有同样的格式（如图4-2 9 所示）。 把收到
的需要进行差 错报告的IP数据报的首部和数据字段的前 8 个字(cid:7194) 提取出来 ， 作为IC MP报
文的数据字段。 再加上相 应的IC MP差错报告报文的前 8个字(cid:7188) ， 就构成了IC MP差 错报告

报 文 。 提取收到的数据报的数据字段前 8 个字(cid:7194)是 为了得到运输层的端 口 号（对千 TCP和

UDP) 以及 运 输层 报 文 的发送序 号 （ 对千 TCP)。 这 些 信 息对源点通知高层 协 议是 有用的

（ 端口的作用将 在 5 .1 .3 (cid:7194)中介 绍）。 整个IC MP报 文 作为IP数据报的数据字段发送给源点。

IP 数据 报 的数据字段

首 部

,

IP 数 据 报

，

装入 ICMP 报 文 的 IP 数 据 报

图 4-29
下面是 不应发送IC MP差错报告报文的几种情况：

ICMP 差 错 报 告 报 文 的 数据 字 段 的 内 容

•  对IC MP差错报告报文 ， 不再发送IC MP差 错报告报文 。
•  对第 一个分片的数据报片 的所有后续数据报片 ， 都不发送IC MP差错报告报文。

•  对具有多播地址的数据报 ， 都不发送IC MP差错报告报文。

•  对具有特殊地址（ 如 1 2 7.0 .0 .0 或0 .0 .0 .0) 的数据报 ， 不发送IC MP差错报告报文。

常用的IC MP询问报文 有两种 ， 即：
(1 ) 回 送请 求 或 回 送 回 答 IC MP 回送请 求报文是 由主机或 路由器向一个特定的 目 的

• 1 4 7 •

主机发出的询问 。 收到此报 文的主机必须给源主机或 路 由 器发送 IC MP 回 送回 答 报文 。 这

种询问报文用来 测 试目的站是 否可达以及 了 解 其有 关状 态 。

( 2) 时间 戳请求或 时 间 戳 回 答

在 IC MP时间戳请求报文发出后， 就(cid:7126)够收到对方响

应的 IC MP 时间 戳 回 答 报 文 。 利用在报文中记录的时 间戳 （ 如 报 文的发送时间和接收时间） ，

发送方很容易 计算出当前网络的往返 时延 。

4.4.2

ICMP 的应用举例

IC MP 的一个重要应用就是分组 网间探测 PING ( Packet I nterN e t  Groper ) ， 用来 测 试两台
主机之间的连通性 。 PI N G 使用了 IC MP 回送请求与回送回答 报 文 。 PING 是 应用层直接使
用网络 层IC MP 的一个例子。 它没有通过运输 层的 TC P 或 UDP。

Windows 操 作系统的用户 可在接入互 (cid:7110)网后转入 MS DOS（ 点击 “ 开始 ” ， 点击 “ 运
“ cmd ”) 。 看见屏 幕 上的 提示符后， 就键入 “ ping hos tname " （ 这 里的 hos tname
， 再键入

“

行

是要测 试连通性的主机名或 它的 IP 地址 ） ， 按 回车键后就可看到 结 果 。
图 4-30 给出了从南 京的一 台 PC 到新浪 网 的邮件服务器 mail.s
试结果 。 PC 一 连发出4 个IC MP 回 送请求报文 。 如果邮 件 服 务器 mail.s
而且 响应这个IC MP回送请 求报文（ 有的主机为了防 止 恶 意 攻击就不理睬外 界 发送过来 的这

ina.com.cn 的连通 性的测

ina.com.cn 正 常工 作

种报文） ， 那么它就发回IC MP 回 送 回答报文 。 由 于往返的 JC MP报 文 上 都有时间戳 ， 因此

很容易得出往返时间。 最后显示出的是 统计结果 ： 发送到哪个机器 ( Ip 地址 ）， 发送的、 收

到的和 丢 失 的分组数（ 但不给出分组丢 失的原 因 ） ， 以及往返时间的最小 值 、 最 大值和平均

值 。 从得到的结果可以看出， 第三个测 试分组丢 失 了 。

c ： 寸ocurqents and  Set t ings -...XXR}ping  mail . s ina . com . cn

Ping ing  A.a i l 申 s in a J CO门 ．en [ 202 . 108 警 43 . 230 1 with  32  bytes  of  data :

Reply  f i-otr1  202 . 108 . 43 . 23 0 :   byt es =32  t ill'le =368As  TTL=-242
Rep ly  f 1地Off\ 202 心 108 岭 43 . 2 3 0 :   bytes .:.J2  t i1Tte ""3?4As  TTL.:::242
Request  t if!led  out 畴
Rep ly  f 1物om 202 蟾 108 噶 43 . 2 3 0 : byt es =32  t illle ""3?4ms  TTL=242

P ing  stat ist ic s   fol"  202 . 1 08 . 43 .230 :

Pac kets :  Sent 笾 4 步 Re ce ived 笠 3 ,. Lost 立 1 (25z  l0$s ) ，

n PPI..oxiAate  1冯oun d t ｀噜 ip t iA

s in  111illi-s

conds :

Hin inum  =  368ms ,. Maximum =  374111s 鼻 Avel'age =  3?2As

七

仑

图 4-30 用 PING 测 试主 机 的 连通 性

另 一个非常有用的应用是 traceroute（ 这是 U NI X 操作系统中的命 令 ） ， 用 来 跟踪 一个分
组从源点到终点的路径。 在 Windows 操 作系统中这个 命 令是 tracert 。 下 面简单 介 绍 这个命

令的工 作 原理 。

trace route 从源主机向目的主机发送一连串 的I P 数 据 报 ， 数据 报中封 装的是无法交付的
。 当 E 到达路径上的第 一个

UDP用户 数据 报 也 。 第 一个数据 报 P 1 的生存时间 TTL 设置为 1

也 注 ： 无法交付 的 UDP 用 户 数据报 使用 了 非法 的 端 口 号 （ 见下

音 5 .2.2 节 ） 。

• 1 4 8  •

一

路由器 凡 时， 路由器 R 1 先收下它 ， 接着把 TTL 的值减 1
把P1 丢 弃 ， 并向源主机发送一个I CMP时间超过差错 报告报文 。

。 由千 TTL 等千零了， 因此 凡 就

源主机接着 发 送第二个数据报 P2, 并把 TTL 设置为 2。 贮 先到达路由器 R 1, R 1 收下后

把 TTL 减 l 再转发给路由器 R2 。 民 收到 P2 时 TTL 为1 , 但减 l后 TTL 变为零了。 民 就丢
弃 P2, 并向源主机发 送一个 I CMP 时间 超过 差 错 报告报 文 。 这样一 直 继 续下去 。 当最后 一
个数据报刚 刚 到达目的主机时 ， 数据报的 TTL 是1 。 主机不转发数据报 ， 也不把 TTL 值减

l 。 但 因 IP数据报中封装的是 无 法交付的运输层的 UDP用户 数据报 ， 因此目的主机要向源

主机发送I CMP终 点 不 可达 差错 报告报 文（见5. 2. 2(cid:7188)）。

这样 ， 源主机达到了 (cid:7151) 己的 目 的 ， 因 为这 些路由器 和 最后 目 的主机 发 来 的IC MP报文 正
好给出了源主机想 知 道的路由信 息 一一到 达目的主机所经过的路由器的 IP 地址 ， 以及到 达
其中的每 一个路由器 的 往 返 时间 。 图 4-31 是 从 南 京 的 一个 PC 向新 浪 网 的 邮 件 服 务器
ina.com.cn 发出 tracert 命 令后所获 得的结果。 图 中 每一行有 三个时间出现 ， 是 因为对

mai l.s
应于每一个 TTL 值 ， 源 主机要发送三 次 同样的IP数据报 。

我们还应注 意 到 ， 从 原则上 讲 ，

I P 数据报经过的路由器越多 ， 所 花 费的时间也会 越 长 。

但 从图 4-31 可看出， 有时正好相 反 。 这 是 因 为互(cid:7110)网的拥 塞 程度随时都在变化 ， 也很难 预

料到 。 因此， 完 全有这样的可 (cid:7127) ： 经过更多的路由器反而花 费 更短的时间 。

C :寸ocuAentsand Set tings \X l.: R)t1•ace:rt flld i l. s ina. co111. e n

Tracing .ro,,te to f!la. il . s in a. co111. c n  [202. 1 08 . 43 .23 0 1
ovet· a Sti.axi111uflt of 3 0  hops:

1  24”$  24”$  23 ns 222. 95. 1 ?2 . 1
2  2 3  AS  24 lllS  22 ns 221. 23 1. 204. 129
3  23 !TIS  22 IIIS  23 AS 221. 23 1. 2部 ． 9
4  24 AS  23 lllS  24 ns 2 02 .9?. 2 ?. 3 ?
5  22 FlS  23 fllS  24 ns 202. 9 7 . 4 1 .226
6  28 MS  28 m$  28 ns 2 02 .9 ? . 3 5. 2 5

50 l'IIS  58 m$  S1 AS 202. 9 ? . 36噜 86

？
8  308 ns 311 n$ 3 1 0  AS 2 1 9. 15 8. 32 . 1
9  38? ms 305”$ 385 ns 219. 158 . 13 .1 ?
1 0  1 6 4  FIS 1 6 4  IIIS 1 65 ns 202 .96. 1 2. 15 4
1 1  3 22 ms 320 111:: 2988 ns 61.135. 148 .  50
1 2  3 2 1  lllS 322"'s 3 20 ns fl•eenail4

3-230. s in d.con [202.108. 43. 2 30 1

T.race c omple te.

图 4-31 用 trace1i命 令 获 得 目 的 主 机 的 路 由 信 息

4.5

1 Pv6

协 议IP是 互(cid:7110)网的核 心 协 议 。 现在使用的协 议IP（即 1Pv4) 是 在 20 世纪 70 年代 末 期

设计的。 互 (cid:7110) 网 经过几 十 年的飞速发 展 ， 在 20 1

1 年 2 月 3 日 ， IANA 开始停 止向地区 互 (cid:7111)

网 注册机构 RI R 分配 1Pv4 地址 ， 因 为 1Pv4 地址 已 经 全 部 (cid:7106)尽 了。 不久 ， 各 地区 互(cid:7110)网地址
分配机构也相 继 宣 布 地址(cid:7106)尽 。 我 国 在 201 4 年(cid:7168) 20 1 5 年也逐步停 止了向新用户 和应用分配

1Pv4 地址 ， 同 时全面开始 商用部署 1Pv6 。

解 决IP地址(cid:7107) 尽的根 本 措 施就是采用具有更 大地址空 间 的新版本的IP, 即 1Pv6 。 经过

多年的研究和试验 ， 20 1 7年 7月 终于发布了 1Pv6 的正 式 标 准 [ RFC 8 200 ,  STD86] 。

• 149 •

