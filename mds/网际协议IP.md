属 千控制层 面的各种路 由 选择协议 。
4.2  网 际协议 I P

网 际 协 议 IP (Internet  Protocol)是 TCP/IP 体系中 两 个 最主要的协议之

一

[STEV94]

[COME0 6][ FORO 10 ]， 也是最重要的 互联网标准协议之

[RFC 791 ,  STD5] 。 网 际协议 IP 又

一

称为 Kahn-Cerf协议， 因为这个重要协议 正是 Robert Kahn和 Vint Cerf 二人 共同 研发的 。 这

“

”

两位 学者在 20 0 4 年 获 得图灵 奖 （ 其地位相当于计算机 科 学 领域的

诺 贝 尔 奖

) 。 严格来说，

这里所 讲的 I P 其实是 IP的 第 4个 版本， 记为 IPv4 。 但在 讲述协议 IP的各种原 理时， 常 省
略 IP后 面的 版本号 。 在后 面的 4.5 节我们 再介绍较 新的 版本 IPv6（ 版本 1 ~  3和 版本 5都 未

一

曾使用过 。 顺便指出， 所 谓的 IPv9 只不过是某些人 故意的 炒作 而 已， 不 值

提） 。

与协议 I P 配套使 用的还有 三个协议：

•  地址解析协议 ARP (Address Resolution Protocol)
•  网际控制 报文协议 ICMP ( Internet Control Message Protocol)
•  网际组管理协议 IGMP (Internet Group Management Protocol)

一

本来还 有

个协议 叫作 逆地址解析协议 RARP
( Reverse  Address  Resolution  Protocol)， 是和协议

ARP 配 合使 用的， 但现在 已被 淘 汰不使用了 。

一

图 4-4 画出了这 三个协议和网 际协议 I P的关
层中， ARP 画在最 下 面 勹 因为 IP经

一

系 。 在这

常要使用这个协议 。

ICMP和 I GMP 画在 这

层的

上部， 因为它们 要使 用协议 IP 。 这三个协议将在

后面 陆 续介绍 。 由于网 际协议 I P 是用来使 互连 起

来 的 许 多 计 算 机 网 络 能够 进 行 通 信 的 ， 因此
“
TCP/IP体系中的网络 层常常被称为网际层 (internet
这 个名词的好处

layer)， 或 IP 层 。 使 用

网 际层

”

应 用 层

各 种 应 用 层 协 议

(HTTP,  FTP,  SMTP 等 ）

TCP, U DP

运输层

网 络 层

l  压三
（ 网 际 层 ）l

IP

网 络 接 口 层

与 各 种 网 络接 口

三

物理硬件
，
:_ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - _ _  :

图 4-4 网 际协 议 IP 及 其 配 套 协 议

“

”

是强调了 这是 由很多网 络 构 成的 互连网 络 。 目前比较普 遍使用

网络层

这个名词 。

在讨论网 际协议 IP之前， 必须了 解什 么是 虚拟 互连网络 。

4 .2. 1  虚拟互连 网 络

我们知道， 如 果要在 全 世 界 范 围内把数以 百 万计的网络都 互连 起来， 并

一

且能够 互相通信， 那么这样的任务

定非常复杂 。 其中 会 遇 到许多需要解 决

视 频 讲 解

的 问题， 如 ：

句 注 ： 在 互 联 网 标 准 中 ， A RP 彶 列 入 链 路 层 协 议 [ RFC 1 1 22 ,  STD3 ] ， 因 此 有 些 教 科 书 就 把 ARP 放 在 链 路 层 中 介 绍

[COME06]  [STEV94]  [ K U RO l  7] 。 但 是 A R P 并 不 知 道 自 己 是 处 在 协议 栈 的 哪 一 层 。 从 程序 调 用 的 关 系 看 ， AR P 实 际 上 处 在 链路

层 和 网 络 层 之 间 [ KOZI05 ] ， 但 不 少 著 名 教材 都 是 把 ARP 放 在 网 络 层 中 讲授 的 [TAN E I I ]  [PETE 1 2]  [FORO I O]  [STAL I O] 。 从 教学 的

观 点 看 ， 如 果 从 协 议 的 底 层 自 卜 往上讲授 ， 那 么 在 学 习 链 路 层 时 就 讲 解 ARP 的 工 作 原 理 ， 因 涉 及 到 I P 地 址 的 转 换 ， 似 不 易 理解 。

编 者 的 意 见 是 ， 既 然 协议 ARP 实 际 上 处 于 链 路层 和 网 络 层 之 间 ， 从 教 学法 的 角 度 考 虑 ， 对 千 自 底 层 计始 讲 的 教材 ， 放 在 网 络层

讲述似较为方便 。 实 际 上 ， 重 要 的 是 搞 沽 A R P 的 工 作 原 理 ， 不 必 过 千 纠 缠 ARP 究竟属 于 哪 一 层 。

• 1 19 •

•  不 同 的 寻 址方 案 ；

•  不 同的 最 大分 组长度 ；

•  不 同的网 络接 入机制 ；

•  不 同 的 超时 控制 ；

•  不 同的差错恢 复 方 法 ；

•  不 同的状 态报 告方 法 ；

•  不 同 的 路 由 选择技术 ：

•  不 同 的用 户接 入控制 ：

•  不 同的服务（ 面 向连接服务和 无连接服务） ；

•  不 同 的 管 理 与 控 制方式 ； 等 等。
一

一

能 不能让 大 家都 使 用 相同的 网 络， 这样可 使网 络 互 连 变得比 较 简 单。 答 案是不行的。

因 为 用 户 的需 求 是多种 多 样的， 没有

种单

的网络 能 够适应所有用 户 的 需求。 另外， 网络

技术 是 不 断 发 展 的， 网 络 的制 造 厂家 也要 经常 推出 新的 网络， 在 竞 争中 求生 存。 因此 客 观 讲

在 市 场 上 总 是 有很 多种 不 同性能、 不同网 络协议的网 络， 供不同的用户 选 用。

一

一

从

般 的概 念来 讲， 将网络 互 相 连接 起来要使 用

些 中 间 设 备。 根据 中间设 备 所在的

层 次， 可以 有 以 下 四种 不同的 中间设 备：

(1 )物理 层使 用的 中间设备 叫 作 转发器(repeater)。
(2) 数据链路 层使 用的中间设备 叫作网桥或 桥接器(bridge)， 以 及交换机(switch)。
(3)网络层使用的中间设备 叫 作 路 由器(router) 气
(4)在网 络层以 上 使 用的中 间设 备 叫作网关(gateway)。 用 网关连接两个不 兼容 的系统 需

要 在高层进行协议的转换。

一

一

当中间设 备 是 转 发 器或 网 桥 时， 这仅仅 是 把

个网络 扩 大 了， 而从网 络层的 角 度看，
一

这仍然 是

个 网 络， 一 般 并不 称之 为网 络互连。 网关 由于比 较复杂， 目 前使用 得较 少。因此

现在我们讨论网 络 互 连时， 都是指 用路 由器进行 网络 互连 和路 由 选 择。 路 由器 其实就是

台

专 用计算机， 用来在 互 联网中进行路 由 选择。 由 千历 史的 原 因 ， 许 多 有 关 TCP/IP 的 文献 曾

经把网络 层 使用 的 路 由器称为网关（本 书有 时 也这样用）， 对此 请读者 加 以注意 。

一

图 4-5(a) 表 示 有许 多 计算机网络通过

些路 由器进行 互连。 由 千参 加互连的计算机网络

都使用 相同的网际协议 IP(Internet  Protocol)，因此可以把 互连以后的计算机网络看 成为如

一

图 4-5(b)所 示的

个 虚 拟 互连网络(internet)。 所 谓 虚拟 互连 网 络也就 是逻辑互连网 络， 它的

意 思就 是互 连 起 来的 各种 物理 网 络的 异 构性本来是 客 观存在的， 但 是 我 们 利用协议 IP就可

一

一

以使这些性能 各 异 的 网 络在网络 层 上看起来好像 是
拟 互连网络可简称 为 IP网 ( Ip网是 虚拟的， 但 平常不必 每 次都强调

个统

一

的网络。 这种 使 用协议 IP的 虚

“

“

虚拟

一

二字）。使 用

IP网的 好处是： 当 IP 网 上 的主机进行通信时， 就 好像在

个 单个网络 上通信

样， 它们看

不见 互连 的 各网 络的 具 体异 构 细 节（如 具体的 编 址 方 案 、 路 由 选 择协议， 等等）。 如 果在这

种 覆 盖 全 球的 I P网的 上 层使用 TCP 协议， 那么就是现 在的 互 联 网(Internet)。

＄ 注 ： 还 有 一 种 网 桥 和 路 由 器 的 混 合物桥路器(brouter) ， 它 是 兼 有 网 桥 和 路 由 器 的 功 能 的 产 品 U 实 际 上 ， 严 格 的 网 桥 或 尹

格 的 路 巾 器 产 品 是较 少 见 的 。 不过桥路器 名 词 用 得 不 普遍 。 请 注 意 router 的 读 音 是 [rautar] 。

•  1 20  •

—

虚拟的 1P 网
（ 互联网 ）

＼

—

二一

二

／

）

三，

一」
.

＿＿二才

:1 -，

-l

＿＿二二l

(a) 实 际的互连 网 络

(b) 虚拟的IP网

图 4-5

IP 网 的概念

当 很多异构网络通过路 由 器互连起来时 ， 如果所 有的网络都使用相同的协议 IP, 那么

在网络层讨论问题就 显 得 很方便 。 现在用一个例子来说明 。

在图4-6 所 示的互联网中的源主 机 凡 要把一个 IP数据报发送给 目 的主机 H2 。 根据第1
章中讲过的分组交换的存储转发概念 ， 主机 凡 先 要 查 找 自 己的转发表 ， 看目的主机 H2 是否
就在本网络上 。 如是 ， 则 不需要经过任何路 由 器而是直接交 付 ， 任务就完成 了 。 如不是 ， 则
必须把 IP 数据报发送给某个路 由 器 （ 图中的 R 1 ) 。 凡 在 查找 了 自 己的转发表后 ， 知 道应 当
把数据报转发给 民 进行 间 接交付 。 这样 一 直转发下 去 ， 最后 由 路 由 器 民 知 道 自 己是和 H2
连接在同一个网络上， 不需要再使用别的路 由 器转发了 ， 于 是就把数据报直接交 付目的主机
H2 。 总之 ， 分组从源节点 A 发送到目的节点 B, 若中间必须 经过一个或几个路 由 器 （ 这表
示 A和B 不在 同 一个网络上） ， 则 是间接交付 。 但 若不需要经过路 由 器 （ 这表示 A 和B 在
同 一个网络上）， 则 是直接交付 。

＼  R 1

R2

R3

主机 、I
r-;,;:
H 1 俨 」 三

R

1.-
、
1

三 I
I
三 三 三 / /
厂 心

l

I

I

`三 \

I

l

全

D （灼

三 间接交付

R4

r

歹
3.-

户

(`

矿
＼

3
 H

f`
.
f、

 I

$

＞

,`

，

`

2

«
（

｀
肆

图 中 的 协议栈 中 的 数 字 1 ~5 分别 表示物理层 、 数据链路层 、 网 络 层 、 运输层和 应 用 层

图 4-6 分组在互联 网 中 的 传送

• 121  •

在图中 画出了 源 主机 、 目的 主机以及各路 由器的协议 栈。 我们 注意 到， 主机的协议 栈

共有五层， 但路 由器的协议 栈 只有 下 三层。图中还 画出了数据在各协议 栈中流 动的方向（用

黑 色 粗线 表示）。 我们还可 注意到， 在 凡和 民之间 使用了 卫 星链路， 而 凡所连接的是个 无

]

一

线 局域网 （ 民和 主机 压都在 同

个 局域网 中）。 在 R

到 凡之间 的 三 个网 络则可以是任意类

型的网 络 。 总之， 这里强调的是： 互联网可 以 由 多种异构网络 互连组成。

有 时可以把 问题简化。 我们可以 想 象 IP数据 报就 在网 络层 中传送， 传输路 径可 省略路

由器之间的网 络以及连接在这 些网 络上的许 多 无关 主机。图4-7 表示了这样的传输路 径。

／ 跳 ＼ ／ 跳

跳 '

/ 跳 ＇

＼

跳

/ 跳

汕 主机 H 1 - R1- Rz----:-- R3- 凡

三 厂／

t

间 按 交 付 /

// 直接 交 付

一一一

R5

－

比 目 的 主 机

图 4-7 源 主 机 H ] 向 目 的主 机 儿 发 送 分 组

一

一

“

”

“
在互 联网的 词 汇 中， 分 组 在传 送 途 中的 每

一
次转发都称 为

跳(hop)

一
。 也有人把 hop
1

一
译 为 跃点。 路 由 器在转 发分 组时也常常使用

2

5

下

跳(next hop) "的说法。 例 如， R

的 下

一
跳是R

, 而 凡 的 下

跳是R

一
。 对千本例， 凡向 儿发送 分 组需 要经过 6跳。 我们还 注意到，

一

每

跳 两端的两个 节 点都必定 直接 连接在 同

一
个网 络 上。 例如， 在 图 4-7 中从 民到 民的

跳， 其 两端 的两个 节点 民和 民都 是连 接在同

一

个 网 络 上 的。 在上 面所 举 的 例 子 中， 前 5 跳

都 是间接 交 付， 只有最后
IP 地址
4.2.2

跳是 直接 交 付。

一

一

在 TCP/IP体系 中， I P地 址 是

个最 基本 的 概念。

个连接 在互 联网 上的设备， 如 果没

有 IP地 址， 就 无法和 网上的 其 他 设备进 行通信。 因此 应 当 首先学 好有 关 I P地 址的内容。

1 .   I P 地址及其表 示方法

一

一

整个的 互 联网 就是

一

个单

的 、 抽 象的网络。 IP地 址就 是给连 接到 互 联网上的 每

一

一

一

台

主 机（或路 由器） 的 每

个接 口 ， 分 配

个在 全 世 界 范 围内是 唯

的 32 位的 标识 符。 IP地

址的结 构 使我们可以在 互 联网上 很方 便地进行 寻 址。 IP地 址 现在 由 互联网名 字 和 数字 分配
机构 ICANN(Internet Corporation for Assigned Names and Numbers)进行 分配 气

对主机或路 由器来说， IP地 址都是 32位的 二进制 代码。 为了 提高可读性， 我们常常把

一

3 2 位 的 IP地 址 中的 每 隔 8 位插入

个 空格（ 但在机器 中 并 没 有 这 样 的 空格）。 为了 便千人

一

们 书 写和 记忆， 常 用 其等效的 十进制数字 表示， 并 且 在 每段数字之间 加 上

一

个 小数点。 这就

叫伲点分十进制 记法(dotted decimal  notation)。图4-8 是

个 IP地 址 表示 方法 的例 子。 显 然，

把 IP 地址用 4段 十进制数字来 表 示 是个很 好的方 法。

O 注 ：

I P 地 圳 婓 按 级 申 请 分 配 。 互 联 网 号 码 分配机构 JA NA 把 大 块 I P 地址妆 地 区 先 分 配给 全 球 五 个 信 息 中 心 。 中 国 互联

网 信息 中 心 CNN IC 再 向 其 中 的 亚 太 网络信息 中 心 APNIC (Asia  Pacific  Network  I nfom1ation  Center) 申 请地址 。 我 旧 的 I S P 则 必 须

向 CNNIC 申 请地址 。

I P 地址 都 是 有 怯 租 用 的 。

• 122  •

机器 中 存放的 IP 地址 是连续的二进制代码

一

—- I l OOOOOOOOOOO l O l l OOOOOO l l OOO l l l l l  |

每 隔 8 位插入

个 空 格 能够提高可读性 - 1 0000000 0000 I O  1 1  000000 1 1  000 1 1 1 1 1
仁— 飞一— 丿 一 —~－- ＼——丫＿ ＿

把 8 位的二进制数转换为 十进制数

1 1
3
\ ＼   ／
采用 4 段十进制数字的点分十进制记法 一__.,. 1 28. 1 1 .3.3 1

1 28

'

3 1

/

图4-8 采用 点 分十进制记法能够提高可读性

前 面 所讲的给每个主机（或路 由 器） 的接 口 分配一个IP地址， 其含义就是这个IP地址
不 但标志 了 这个主机（或路 由 器）， 而 且还标志 了 此接 口 所连接的网络。 因 此， 32 位 的 IP
地址采用两 级 结构， 由 两个字段组成。 第一个字段是网络号， 它标志 主机（或路 由 器） 所连
接到的网络。 一个网络号 在整个互联网范 围内必须 是唯 一的。 第二 个字段是主机号， 它标志
该主机（对路 由 器 来 说， 就是标志该路 由 器）。 一个主机号 在所连接的网络（即前面 的网络
号 所指明 的网络） 中必须 是唯 一的。 由 此可见， 一个 IP 地址在整个互联 网 范 围 内 是唯一 的 。
因 此， IP地址可以记为：

IP地址 ： ： ＝ ｛  ＜网络号＞， ＜主机号＞｝

（4-1)

式(4-1)中的符 号 ” : ： = ” 表示 “ 定 义 为 "。 IP 地址中包含网络号 就表明 ， 不 连网的主机就
没有 IP 地址。 一定要记 住， IP 地址指明 了 连接到 某个网络上的 一个主机（或路 由 器）。 为
简单起见， 当 不涉及 路 由 器 时， 后面我们都以主机为例来介绍 IP地址。

图4-9 表示 IP地址中的网络号和主机号的位置。 具体的规定是 ： IP地址中的前 n 位是
主机所连接的网络号， 而 IP地址中后面的(32 - n)位是主机号。 现在的问题是， 当 我们看到
一个IP地址时， 怎样知道它的网 络号的位数 n 是多少？下面 我们就来讨论这个问题。

IP 地址 1

网 络 号

l- n 位

32 位

1

1

1

王 机 号
( 32 — n ) 位 ------,

图4-9

IP 地址 中的网 络 号和 主 机 号 字 段

2 . 分 类 的 IP 地址

扫 一扫

在互联网发展 早期采用的是分类的 IP 地址， 也就是在图4-9 中的 n 是
固 定的几个数之一 。 分类的方法如图 4- l O( a)所示。 分类的方法 非常简单。
这里 A 类 ( n =  8 )、 B类 ( n = 16 ) 和C 类 ( n = 24 ) 地址都是单播地址
（一对一 通信）， 是最常用的。 D 类是多播地址（一对多通信， 我们将在4.7 节讨论IP多播），
而 E 类是保 留 地址。

视频讲解

32 位的IP地址 空间共有232（即4294967296 , 接近43 亿） 个地址。 A类地址 空间共有
2“ 个地址， 占整个IP地址空间的 50%。 B类地址 空间共有 230个地址， 占整个IP地址 空间
的 25%。 整个C 类地址空间共有 229个地址， 占整个 IP地址的 12.5%。 D 类和 E 类地址各
占 整个IP地址的 6.25%。 图4-lO(b)给出了 各类地址 占 IP地址总数的比例。

从图 4-lO( a)可以看出， 如果给出一个 二 进制数表示的 IP单播地址， 那么就可以很 容 易

知 道是哪类地址， 并且 也 能看出这个二进制数表示的网络号 和主机号。

例如， 给出一个IP地址10000000 00001110  00100011  00000111。 对比一下图4-lO( a),

不难看出， 这是一个B类地址， 前 16 位 是网络号， 后16 位是主机号。

• 123  •

l---- 32 {立

－

1
尸
A 类地址 10 } 网络号 1
8 位
一一一

B 类地址 ＼汇

网 络号
1 6 1了

——

_/二[
I

1

j机 号
24 伈

C 类地址 丿凹二＿一
I

D 类地址 I l l l 0
-,---

网 络 号
—- 24 位

多五一地 址

E 类地址 ［三厂

保 留 为 今 后 使 用

—

j机号 --－－-』
1
1
1 6 1[  -1
—_＿ ＿＿＿-尸
1
8 位 一|
二

主机号

(a)

(b)

图 4- 1 0 分类的 IP 地址(a) 以 及 各类地址所 占 的 比例(b)

A 类地址的网络 号字 段 占 1个 字 节 ， 只 有 7位可 供使用（ 该字段 的 第

一

“

一

”

位 已 固 定为 0 )。

但 要 注 意， 第

， 网 络号为 全 0 的 I P 地叮 有 特 殊 的 用 途， 它表示

本网络

； 第 二， 网 络号

为 127 （ 即 （）1111111 ) 保 留 作为 本地软件环 回 测 试(loopback test) 本主机的进程之间的通 信之

一

用 。 若 主机 发送

个目 的 地 址 为 环 回 地址 （ 例如 1 27.0 .0 .l)的 JP数据 报 ， 则本 主机中的协

议 软 件 就处理数 据 报 中的数据 ， 而 不 会把 数 据 报 发 送到任何网络。 因此 A类 地址可 指 派的

7

网 络 号 是 126个 （ 即 2
”

“

— 2 )。

一

A 类地址的 主机 号 占 3 个字节。 但 全 0 和 全 l的 主 机号

般 不指 派。 全0 的 主 机号表示

该 I P 地址 是

本 主 机

所 连接到的单个网络 地址（例如， 若 主机的 IP 地址为 5 .6.7.8

“

主 机 所 在的网络的网络号 是 5, 而 该 网络 的网络 地址就 是 5 .0 .0 .0 )。 全 ］表 示

一

所有的

＂

, 则 该
24
， 因

此 全 1的 主 机 号字段 表 示 该网络 上的 所 有 主 机。 因 此每

个 A类网络中的 最大 主机数 是 2

- 2 , 即 1 6777214。

B 类地址的网 络号字段有 2个 字 节 。 因此 B类 地址可指 派的网络数为 2

一

1 6

1 4

， 即 1638 4 。 B

类地址的 每

个网络上的 最 大 主机数 是 2

- 2， 即 65534。 这里需要 减 2是因为要 扣 除 全 0

和 全 l 的主 机 号 。

2 1

8
C 类 地 址有 3 个字 节的 网络 号字 段 。 因此 C 类 地 址 可指 派的 网络 总数 是 2

一

' 即

20 97152。 每

个 C类 地址的 最大 主机数 是 2

- 2 ， 即 254。

本 书的前几个 版本 曾 提到 ， B 类地址 中的 网 络地址 128

.0 .0 .0 和 C类 地址中的网络 地址

192 .0 .0 .0 都 是规 定不指 派的。 但现在 这 两个 网 络地址 都 已经 可以指 派 了 [RFC 68 90 ]。

一

表 4-2给出 了

般不 指 派的 特殊 IP 地址 ， 这些 地址 只能在特定 的情 况下使用。

网络号

。 。
。

主机号

令 l
y
1
27

X
全 1
全 l
非全 0 或全 1 的任何数

表 4-2 一般不指派 的特殊 I P 地址

源地址使用
可 以
可 以
不 可
不 可
1-1
［ 以

目 的地址使用
个 可
不 可
可 以
可 LA
司 以

代表的意思

DHCP

协议 ）

在 本 网络上的本主机 （ 见 66 节
在本网络上主机 号 为 X 的主机
只 在 本 网络上进 行广播 （ 各路 由 器均 不转发 ）
对网络号为 Y 的 网络上的所有主机进行广播
用 千 本地软件环 回测试

这 里 要指 出， 由于 近年来 已经 广 泛 使用 无 分类 IP 地址进行路 由 选择， A类、 B类和 C

• 124  •

类这种分类地 址 已成为 历 史 [RFC 1 8 1 2]。 由千很多 文 献和 资 料现在都仍然 引用传 统 的分类 的

IP地 址， 因此我 们 对分类的 IP地 址还要进 行简 单的 叙述。

把 IP地 址划分为 A类 、 B类 、 C类三个类别， 当初是这样考虑 的： 各种网络 的差异 很

大， 有的网络 拥有很多 主机， 而有的网络上的主机 则很 少 。 把 IP地 址划分为 A类 、 B类和

C类是为了更好地 满 足不同用 户的需 求。

这种分类的 IP地 址 由千网络 号的位数是 固定的， 因此 管 理 简 单 、 使用方 便 、 转发分 组

迅速， 完 全可以 满 足 当时 互联网 在 美 国的 科研需 求。 后来， 为了更 加 灵 活地使用 IP 地 址，

一

出 现了划分子网的方 法， 在 IP 地址的主机 号中， 插入

个子网 号， 把两 级的 IP地 址 变为 三

级的 IP地 址。 但是 ， 谁也没有 预 料到， 互 联网在 20 世 纪 90 年代 突 然 迅速地发 展起来了 。

互 联网从 美 国 专用的 科 研实 验网 演 变到 世 界范围开放的 商 用网 ！ 互 联网用 户的 猛 增， 使 得

IP地 址的数量 面 临 枯竭的 危 险。 这时， 人们才 注意到原来分类的 IP地 址在 设计上确 实 有 很
个 A类网络地 址 块的主 机 号数目 超过了 1 677 万个 ！ 当初美 国的很

不合 理的地方。 例如，

一

一

多 大学都可以 分 配到

个 A类网络 地址 块 。 一个 大学 怎 么 会需要这样多的 IP地 址 ？ 但 在 互
联网出现 早期， 人们就是 认为 IP地 址是用 不完 的， 不需要 精 打细算地分 配。 又 如， 一个 C

类网络地 址块可指 派的 主机号 只有 254个。 但不 少 单位需要有 30 0 个 以上的 IP 地址 ， 那么

一

干脆 申 请

个 B类网络地 址块（可以指 派的主机 号有 65534个 ）， 宁可多要些 IP 地址 ， 把

多 余的地 址 保 留 以后 慢慢用 。 这样就 浪 费了 不少的地 址 资源。 即使后来 采用了划分 子 网的方

法， 也 无法解 决 IP地 址枯竭的 问题

千是， 在 20 世 纪 90 年代， 当发 现 IP地 址在 不 久后 将 会枯竭时， 一种 新的 无分类编 址

方 法就 问 世了。 这种方 法 虽然也 无法解 决 IP地 址枯竭的 问题， 但可以 推迟 IP地 址用 尽的 日

一

子。 下

节就介绍 现 在 已普 遍采用的这种编址方 法 。

3 . 无分类编 址 C I DR

二勹厂言言勹厂勹c路

Routi

( 1 ) 网络 前缀
C IDR把图 4-9中的网络 号 改称为

尸言言勹尸勹

4?3

“

r

网络 前缀 "(netwo

k-prefix)（或 简称为

前缀 " ) ,

用来指明网络， 剩下的后 面部分仍然是主机 号， 用来指明 主机。 在有 些 文 献中也把 主机 号 字

段称为 后缀(suffix)。 C IDR的 记法是：

＝

＜

＜

IP地 址 ： ：

｛

网络 前 缀＞，

主机 号＞｝

(4-2)

“

“

“

＂

图 4- 1 1说明了 C IDR的网 络 前 缀和主机 号的位 置。 看 起来， 这和 图 4-9也 没有 什么不
。 其实 不 然。 这 里 最大的 区别就 是网络 前 缀的位

网络 前 缀

网络号

换成为

同， 只是把

数 n 不是 固定的数， 而是可以在 0 ~32之间 选取任意的 值。

32 位

IP 地址 |

网 络 前 缀

l- n 位

主 机 号
l
(32 - n) 位 一一一

图 4- 1 1 CIDR 表示的 IP 地址

＂

”

CIDR使用

斜线记法

(slash notation)， 或称为 CIDR 记法， 即在 IP地 址 后 面 加上 斜

•  1 25  •

回芯妒粗

-Domain 兽磨

r

视肺 讲 娇

“

�

”

一

线

I "， 斜线后面是网络前 缀所 占的位数。 例如， CIDR表示的

个 IP地 址 128

.14.3 5 . 7/20 ,

二进制 IP地 址的前 20 位是网络 前缀（相 当于原来的网络号）， 剩 下后 面 1 2位是 主机号。

(2) 地址块
CIDR把网络 前缀都相 同的所有连 续的 I P地 址 组成

一

“

＂

一

个

C IDR 地址块

。

个 CIDR

一

地 址 块包含的 IP地 址数目， 取 决 千网络前 缀的位数。 我 们 只要知道 CIDR地 址 块中的任何

个地 址， 就可以知道这个地 址块的 起始地 址（ 即最 小地 址） 和最 大地 址， 以及地 址 块中的

一

地 址数。 例如， 已知 IP地 址 128

.14.35.7/20 是某 C IDR地 址 块中的

个地 址， 现在把它 写成

二进制表示形式， 其中的前 20 位是网络前 缀（用 粗体和 下划线表示 出）， 而前 缀后面的 1 2

位是 主机号 ：

1 28

.14.35. 7 /20  = 100__0__0_000___0__0__0__0_ 00100 0 1 1  0 0 0 0 0 1 1 1

可以很方 便地 得出这个地 址所在的地 址块中的最 小地 址和最 大地 址 ：

10000000 00001110 00100000 00000000

最小地址

最大地址

1

1 28 1 4320
1 28. 14.47.255

1

10000000 00001 1 10 00101111 1 1 1 1 1 1 1 1

这个地 址块的 IP地 址 共有 2

一

址 ） 后， 可指 派的地 址数是 2

1 2

2个， 扣 除 主机号为 全 0 和 全l的地 址（ 最 小地 址和最 大地
- 2个。 我 们常使用地 址块 中的最 小地 址和网络前 缀的位数

指明

个 地址 块（不必 每 次都 减 2 算出可指 派的地 址数， 这样 做太麻烦）。 显 然， 上面 导出

的 最 小地 址 并不是 该地 址块 128

.14.32.0 /20 的网络地 址。

也可以用 二进制代 码简要地表示此地 址块 ： 10 0 0 0 0 0 0 0 0 0 0 1110  0 0 10 *。 这 里的 星号 ＊代

表了 主机号字段的所有的 0。 星号前的 二进制代 码的个数， 就是网 络前 缀的位数。

“

”

在不 需要指明网络地 址时， 也可把这样的 地址块简称为

/20 地 址块

。

请读者 注意：

1 28

. 1 4.32.7是 IP地 址， 但 未 指明网络前 缀 长 度， 因此不知道网络地 址是 什 么。

128

.14.32.7/20 也是 IP地 址， 但同 时 指明了网络前 缀为 20 位， 由此可 导出网络地 址。
.14. 32.0 /20 是包含 多个 IP地 址的 地址块或网络 前缀， 或 更 简单些， 就称为 前缀， 同
时也 是这个地 址块中 主机号为 全0 的地 址。 请注意， 上面 地址块中 4段 十进制数字 最后的 O

1 28

有时可 以 省略， 即简 写为 128

.14.32/20。

一

.14.32.0 来 指明

个网络地 址， 因为 无法 知道网络 前缀是 多 少。 例如

一

我 们 不能仅用 128
.14.32.0 /19或 128

128
派的 IP地 址（如 果网 络前 缀的位数 不超过 18 )。

.14.3 2.0 /21, 也都是有 效的网络地 址。 128

.14.3 2.0 也可能是

个可以指

早期使用分类的 IP地 址时， A类网络的前 缀是 8 位， B类网络的前 缀是 1 6位， 而 C类
一

网络的前 缀是 24位， 都是 固定 值， 因此不 需要重复 指明 其网络前 缀。 例如在使用分类地 址

时，

看 15 . 3 .4.5就知道是个 A类地 址， 其网络地 址为 15 .0 .0 .0。 但在使用 CIDR 记法时，
一

个很 小的地 址块 15 . 3 .4.4/30 中的 、 不属 于任何类别的

15 . 3 .4.5/30 则是

一

一

总之， 无分类编址 CIDR具有很多 优点， 但

一

定要 记住， 采用 CIDR后， 仅从 斜线 左边

一

扫

个 IP地 址。
扫

的 I P地 址已 无法知道 其网络地 址了。 在这

点上， 原来的分类地 址还 是比

较方 便的。

｀心勹勹戌 记法可以 让我 们 知道 网络前 缀的 数值。 但是计算机 看不 售兽

视频讲解

匣芯妇

见 斜 线记法， 而是使用 二进制来进行各 种计算时就必须使用 32位的 地址掩

• 126  •

码( add ress mask )能够从IP 地址迅速算出网络地址。

地址掩码（常简称为掩码） 由 一连串 l 和接着的一 连 串 0 组成， 而 l 的个数就是网络
前 缀的长度。 地址掩码又称为子网掩码 气 在CIDR 记 法 中， 斜线后 面 的 数 字就 是地址掩码
中 1 的 个数。 例如，
连续的1 和接着的12 个连续的 0)。 这个掩码用CIDR 记 法表示就是255.255.24 0. 0/2 0。

／2 0 地址块的地址掩码是： 1111111111111111 11110000 00000000  C 2 0个

对于 早 期使用的分类IP 地址， 其地址掩码是固定的， 常常不用专 门 指出。 例如：
A类网络， 地址掩码为255. 0. 0. 0 或255. 0. 0. 0/8。
B类 网 络， 地址掩码为255.255. 0. 0 或255.255. 0. 0/16 。

C 类网络， 地址掩码为255.255.255. 0 或255.255.255. 0/24。

把二进制的 IP 地址和地址掩码进行按位 AND 运算， 即可得 出网络地址。 图4-12 说明
了 AND 运算的过程。 AND 运算就是逻辑乘法运算， 其规则 是： 1AND  I  = 1 ,   1 AND  O = O ,
0 AND O =  0。 点分十进制的IP 地址是128.14.35.7 /20, 前 缀 长度是2 0（见图中的灰色背景）。

请 注 意 ， 从点分十进制的 IP 地址并不容 易 看 出 其 网络地址。 要使用二进制地址来运算。 在

本例中把二 进制IP 地址的前 2 0 位 保 留 不变， 剩 下的12 位全 写为 0, 即可得 出网络地址。

二进制 lP 地址

地址掩码
按位 AND运算
网 络地址

.

14

1 2 8

.
10000000 0000 1 1 1 0  0 0 1 0 0 0 1 1  00000 1 1 1
1 1 1 1 1 1 1 1 1 11 1 1 1 1 1 1 1 1 10000 00000000

3 5

7

.

10000000 0000 1 1 10 00100000 00000000
.

1 2 8

14

3 2

0

.

.

/20

•

前缀 2 0 位 ——一

图 4- 1 2 从 IP 地址算 出 网 络地址

从上面的运算结果可以知 道， IP 地址 128.14.35.7 /2 0 所在的网络地址是128.14.32. 0/2 0。
表4-3 给出了 最常用的CIDR 地址块。 表中的 K 表示 2 ” 即 1024。 网络前缀长度在 13

到27 之间是最常用的。 在 “ 包含的地址数 ” 中把全 l 和全 0 的主机号都计算在内 了 。

网 络前缀长度

/ 1 3

/ 1 4

/ ]  5

/ 1 6

/ 1 7

/ 1 8

/ 1 9

/20

/2 1

/22

/23

点分十进制

255 248 0 0

255 252 0 0

255 254 0 0

255 2 5 5  0 0

255 255 1 28 0

255 255 1 92 0

255 255 224 0

255 255 240 0

255 255 248 0

255 255 252 0

255 255 254 0

表 4-3 常用 的 CIDR 地址块

包含的地址数

5 1 2 K

256  K

1 28 K

64 K

32 K

1 6  K

8 k

4 K

2 K

I K

5 1 2

相 当 千包含分

的 网 络数

类

8 个 B 类或 2048 个 C 类

4 个 B 类或 1 024 个 C 类

2 个 B 类或 5 1 2 个 C 类

l 个 B 类或 256 个 C 类

1 28 个 C 类

64 个 C 类

3 2 个 C 类

1 6 个 C 类

8 个 C 类

4 个 C 类

2 个 C 类

＄ 注 ： 子 网 (subnet 或 subnetwork ) 是 很 常 用 的 一 个 名 词 。 某个 网 络 的 一部 分就可 以称为其子 网 。 一 个 网 络 对 整 个 互 联 网 来

说 ， 就 可 以 看 成 是 一 个 子 网 。 在 本 书 中 ， “ 子 网

”

和 “ 网 络 “ 常常被认为是 同 义 词 ， 经常混用 。

• 127  •

网 络前缀长度

点分十进 制

包 含 的地址数

相 当 于包含分类 的 网 络数

续表

/24

/25

/26

/27

2 5 5  255 255 0

255 2 5 5 .255 1 28

2 5 5  255 255 1 92

255 2 5 5  255 224

256

1 28

64

32

CIDR地 址中 还有三 个特 殊地址块， 即：

1 个 C 类

1 /2 个 C 类

1 /4 个 C 类

1 /8 个 C 类

一

( 1 ) 前 缀 n =  3 2， 即 3 2位 I P地 址都是前 缀， 没有 主机号。 这 其实就是

个 IP地 址。 这

个特 殊地 址 用于 主机路 由（ 见 4.3 .2 节）。

(2) 前 缀 n =  31 , 这个地 址 块中 只有两个 IP地 址， 其 主机号分别为 0 和 l。 这个地 址 块

用 千点 对点 链路（见后面的 第 4 小 节）。

=

(3 ) 前 缀 n

O 同时 IP地 址也是 全 O , 即 0 .0 .0 .0 /0。 这 用于 默认路 由（ 见 4.3 .2 节）。

一

一

从 表 4-3可看出， 每

个 CI DR地 址 块中的地 址数

一

”

定 是 2的 整数次幕。 除最后几 行外 ，

CIDR地 址 块都包含了 多 个 C类地 址（是
一

有时称 CIDR编址为

构造超网

。

“

”

个 C类地 址的 2

倍， n 是 整数 ）， 因此在 文 献中

使 用 CIDR的

一
个好 处就是 可以 更加有 效地分 配 IP地 址空间， 可 根据 客 户的需要 分 配

适 当 大 小的 CIDR地 址 块。 然 而在使用分类 地址时， 向

个部 门分 配 IP地 址， 就 只 能以 ／8

,

/1 6 或／24为单位来分 配。 这显 然 是很 不 灵 活的。

一

的

一个 大的 CIDR地 址块中往往包 含很多 小地 址块， 所以在路 由器的转发表中就利用较 大

个 CI DR地 址块来代 替许多较 小的地 址块。 这种方 法称为 路 由 聚合(route aggregation) ,
个 项目就 可以表示 原来传 统分类地 址的很多个（例如上 千个） 路 由 项

它 使 得转发 表 中 只用

一

目， 因 而 大 大压 缩 了转发表所 占的 空间， 减 少 了 查找转发表所需的时间。

图 4-1 3给出的是 CIDR地 址 块 灵 活分 配的 例子。 假定某 ISP 已 拥有地 址块 20 6.0 .64.0 / 1 8

一

（ 相 当 千有 64个 C类网 络）。 现 在某 大 学需要 80 0 个 IP地 址。 I S P可以给 该大学 分 配

1 0

个

地址 块 20 6.0 .68

.0 /22 , 它包括 10 24（ 即 2

) 个 IP地 址， 相 当 千 4个 连续的 C类 ／24地 址 块，

占 该 I SP 拥有的地 址空 间的 1/ 1 6。 这个 大学 可 灵 活地 对本 校各系继 续 分配地址块， 而各系还

可 再划分本系各 教 研 室的 小地 址块 。 CIDR的 地 址 块的地 址范围有时 不 易看 清， 这是因为网

络前 缀和 主机号的 界 限 不是 恰好 出现在 整数字 节 处。 但 只要 写出 地址的 二进制表示 ， 弄清网

络前 缀的位 数， 就能 够知道地 址块的 范围。

图 4-13表示这个 ISP 共拥有 64个 C类网络。 如 果 不采 用 CIDR技术， 则在与 该 ISP的

一

一

一

路 由器交换路 由信 息的每

一

个 路 由器的转发表中， 就需要有 64行， 每

一

行 指 出了到 哪

个

一
网 络 的下
一
块的 下

跳。 但 采 用地 址 聚 合后， 在转发表中 只需要 用

行来指出到 20 6.0 .64.0 / 1 8 地 址

跳。 这个 大学 共有 4个系。 在 ISP内的路 由器的转发表中， 也仅需 用 20 6.0 .68

.0 /22

这

个 项目， 就 能把外部发 送到这个 大学各系的所有分 组， 都转发到 大 学的路 由器。 这个 路

一

由 器 好 比是 大学的 收发 室。 凡 寄给 大学任何

个系的 邮件， 邮 递 员都 不必送到 大学的各个 系，

一

而是 把这些 邮件 集中 投递到 大学的 收发 室， 然后 由 大学的收发 室 再进行下

步的分发。 这样

就加快了 邮递员的 投递工作（相 当 于缩 短了转发表的 查找时 间）。

从 图 4-13的表格中可看出， 网络 前缀越短的 地址块所包含的 地址数就越 多。

• 128  •

一系

二 系

地 址 块

单 位
ISP  206.0.64 0/ 1 8
大 学 206 0 68.0/22
一 系 206.0.68.0/23
二 系 206.0. 70.0/24
三系 206.0.7 1 .0/25
四 系 206.0 7 1  1 28/25

二 进制表示 的地址块

1 1 00 1 1 1 0 00000000 0 1  *
1 1 00 I 1 1 0 00000000 0 I 000 1 *
不
1 1 00 1 1 1 0 00000000 0 l 000 1 0
1 1 00 1 1 1 0 00000000 0 I 000 1 1  0 *
1 I 00 1 1 1 0 00000000 0 I 000 1 1 1  0*
1 1 00 I 1 1  0 00000000 0 I 000 1 1 1  1 *

相 当 千C类 网 络 数
64
4
2
I
1 /2
1 /2

一

表 中 星 号 ＊ 是
种 常
用 的 简 写 方 式 ， 衣
示 星 号 后 面 的 二 进
制主机 号 都 省 略 了

图 4- 1 3 ClDR 地址块 划 分举例

4 .  I P 地址的 特点

一

一
IP地 址具有以下
( 1 ) 每

些 重要特点。

一

个 IP地 址都 由网络前 缀和 主 机 号 l历 部 分 组成。 从这个意义上 说， IP 地 址 是

一

种 分等级的 地址结构 。 分两个等 级的 好处是 ： 第

一

， IP地 址 管理机 构 在 分配 IP地 址时 只分

配网络 前缀（ 第

级）， 而 剩下的 主机号（ 第 勹 级 ） 则 由 得到 该网络前 缀的单位 自行 分 配。

这样就 方便了 IP地 址的 管 理 ； 第 二， 路 由 器根据目的 主机所连接的网络 前缀 （ 即 地址块 ）

来 转发分组（ 而 不考虑目的 主 机 号）， 这 样 就 可 以 使 转 发 表中的 项目数 大 幅 度 减 少 ， 从 而 减

少 转发表所 占的 存储空间 ， 缩短查找转发表的 时 间 。

一

一

一

(2) 实 际上 IP地 址是标志

台 主机（ 或路 山 器 ） 和

条链路的接 口。 当

台 主机 同时 连

接 到两个网络上时， 该 主机就 必须 同时 具 有 两个 相 应 的 IP地 址， 其网络前 缀必须是不同的。

一

一

这种 主机称为 多归属 主机(multihomed host)

。 由 千

一

个路 由器 至 少 应当连接 到两个 网 络， 因

此

个路 由器 至 少 应当有两个不同的 IP 地址。 这好 比

个 建 筑正 好处在 北 京 路 和 上淘路 的

交叉口上， 那么这个 建 筑就 可以 拥有两个 门 牌 号码。 例 如， 北 京 路 4号和上 海路 3 7 号。

一

(3) 按照 互 联网的 观点，

个网络（ 或 子 网 ） 是 拒 具 有相 同网络前 缀的 主机的 集合， 因

—

此， 用 转发器 或交换机连接起来的 若干个局域网仍 为

个网络， 因为这 些 局 域 网 都 具 有 同 样

的网络前 缀。 具有不 同网络前 缀的 局 域网必须使 用 路 由 器进行 互连。

(4) 在 IP地 址中， 所有 分 配 到网络前 缀的 网 络 （ 不 管是 范 围 很 小的 局域网， 还 是可能 覆

一

盖很 大地 理 范 围的广域网 ）都是 平等的。 所 谓 平 等， 是指 互 联 网同等对 待 每
1

2

3

个 IP地 址。
1

图4-14 画出了三 个 局 域网 ( LAN

一

, LAN
2

和 LAN

连 构成的

个 互连网络 。 其 中 局 域网 LAN

一

是 由 两 个 网 段通过以 太网 交换机 互连的。图中 的

) 通过 三个路 由器 (R
一

， 民 和R3 ) 互

小 圆 圈 表示 需要有

个 IP 地址。 这是为 了强 调， IP 地址是标志

个主机连接在网络 上的接

口。 如 果我们把某条连接线 断开， 那么 相 应 的 I P 地址也就 不 存 在了。 但通常为了方 便， 这

•  1 29  •

样的小 圆 圈 可以不必画出。

LAN1

＇ ，

口，

z

,

1

z ' 2 . － ＿-i.-
l l?-i\\、三 网 络地址 IP
一 1

一 一 、 、 、

一1

地址

LAN3
- ＿l、. 1 .1 . 16/29

�. 1 . 1 .27

kk  l  l .  l .  l 9 ＼ 二;:1124/3 1
·_＿～1 I
L－

ll勹 l ll3

- N3  1 . 1 . 1 .28/3 1 八2 产歹

三谥乡 以 太 网 交换机

－－－

- IJ28

病玄， 等众，3-

: l .  l l

l .  ｝

路 由 器

＇

,,' ＝  ＝z

＼

/ z

1气/

',  /  ＼ [

t  1 ,＇',

图 4- 1 4 需要 IP 地址 的 地方用 小 圆 圈表示

我们应当 注 意到：
•  在同一个局 域网上的主机或路 由 器的 IP 地址中的网 络前缀必须是 同 样 的 ， 即必须

具有同 样 的 网 络号。

•  图 中的网络地址（用粗体字加下画线表示 ） 里 面的主机号必定是全 0。 例如 ， LAN 1
的网络地址1.1.1. 0/29 =  00000001  00000001  00000001  00000000, 在二进制表示的IP
地址中， 前29 位有下画线的数字是网络前缀 ， 最后 3 位为主机号 ， 是全 0。

•  图 4-14 中的所有设备都有 自 己的 MAC 地址（都未 画 出 ）。 请 注 意 ， 图 中以太网 交
换机连线上画出的小 圆 圈 ， 是主机或路 由 器的 IP 地址 ， 并不是以太网交换机的 IP

地址。 以太网交换机是链路层 设备 ， 只有 MAC 地址。

•  用以太网交换机（它 只在链路层工作 ） 连接的几个网段合起来仍然是一个局 域 网 ，

只使用同 样的网络前缀 ， 例如 LAN沪

•  路 由 器总是具有两个或两个以上的IP地址。 即路 由 器每个接 口 的IP地址的网络前

缀都不 同。

•  当 两个路 由 器直接相连时（例如通过一 条租用线路 ） ， 在连线两 端 的接 口 处， 可以
分配 也可以不分配IP地址。 如 分配 了 IP地址 ， 则 这一段连线就构成 了 一种只包含
一段线路的特殊 “ 网络 ＂（如 图 中的 N 1 , N2 和 N3 )。 之所以叫 作 “ 网络 “， 是 因 为
它 有 IP 地址。 这种网络仅 需两个 IP 地址 ， 因 此这里 就使用 了 ／31 地址块。 这种地
址块专 门 为点对点链路的两 端使用[RFC 3 021] ， 主 机号（只有 1 位 ） 可以是 0 或 l。
但为了 节 省 IP地址 资源， 对千点对点链路构成的特殊 “ 网络 ＂ ， 现在也常常不分配
IP 地址。 通常把这样的特殊网络叫 作 无编号网络( unnumbered network )或匿 名 网络
( an onymous network )[COM E 06]。

4.2.3 IP地 址 与 MAC地址

在学 习 IP地址时， 很重要的一点就是要弄懂 主机的IP地址与 MAC 地
址的区别。 在局 域网中， 由 于 MAC 地址 已 固 化在网卡 上的 R OM 中， 因 此

常常将 MAC 地址称为硬件地址或物理地址 。 在本书中， 物理地址 、 硬件地

视频讲解

• 13 0  •

址和 MAC 地址常常作 为同义词出现。 物理地址的反义词就是虚拟地址、 软件地址或逻辑地
址，

IP地址就属 于这类地址。

图 4-15 说明 了 这两种地址的区别。 从层次的角 度看， MAC 地址是数据链路层使用 的 地
址， 而 IP地址是网络层和 以上各层使 用 的地址， 是一种逻辑地址（称 IP地址为逻辑地址是

因 为 IP地址是用软件实现的）。

应 用 层 数据 I
IP 地址I �——— TCP 报文 �

1 首 部 1

厅

音旷
;,

部I

IP 数据报

MAC 帧

I
，｝

网 络层 及 以 上
使 用 IP 地址
一 一 一 - - - － - － － － － － － － - － － － － － － 一 一 一 一 一 一 一 一 - - 一

I 尾 部1 数 据 链 路 层

使 用 MAC 地址

图 4- 1 5

IP 地址与 MAC 地址 的 区 别

在发送数据时， 数据从高层下到低层， 然后才到通信链路上传输。 使用IP地址的 IP数
据报一 旦交给数据链路层， 就被封装成 MAC 帧。 MAC 帧在传送时使用的源地址和目的地
址都是 MAC 地址， 这两个 MAC 地址都写 在 MAC 帧的首部中。

连接在通信链路上的设备 （ 主机或路 由 器 ） 在收到 MAC 帧时， 根据 MAC 帧 首部中的
MAC 地址决定收下或丢 弃。 只有在剥 去 MAC 帧的首部和尾部后把 MAC 层的数据上交给
网络层后， 网络层才能在 IP数据报的首部中找到源 IP地址和目的IP地址。

总之， IP 地址放在 IP数据报的首部， 而 MAC 地址 则 放在 MAC 帧的首部。 在网络层

和网络层以上使用的是 IP 地址， 而数据链路层及以下使用的是 MAC 地址。 在 图 4-15 中，
当 IP数据报插入到数据链路层的 MAC 帧以后， 整个的IP 数据报就成为 MAC 帧的数据，
因 而在数据链路层看不见数据报的IP地址。

图4-16( a)画 的是 三 个局 域网用两个路 由 器R 1 和 民 互 连起来。 现在主机 凡 要和主机 H2

通信。 这两台主机的 IP地址分别是 IP 1 和 IP2, 而它们的 MAC 地址分别为 MAC 1 和 MAC扣
一经过 凡 转发一 再经过 凡 转发- H2。 路 由 器 R 1 因 同时连接到两个局 域

通信的路径是： H 1

网上， 因 此它 有两个 MAC 地址， 即 MAC3 和 MAC4。 同理， 路 由 器 民 也有两个 MAC 地址
MAC扛0 MAC妒

图4-16(b)特别强调 了 IP 地址与 MAC 地址所使用的位置的不 同 。 表 4-4 归 纳 了 这种区

别。

表 4-4 图 4-1 6(b) 中 不 同层次 、 不 同 区 间 的源地址和 目 的地址

在 网 络层

在数据链路层

写 入 I P 数据报首部的地址

写 入 MAC 帧首部的地址

源地址

目 的地址

从 凡 到 R 1

从 凡 到 R2

从 民 到 H2

IP 1

IP 1

IP 1

IP2

IP2

IP2

源地址

MAC 1

MAC4

MAC6

目 的地址

MAC3

MAC5

MAC2

• 131  •

主IP l

F二二
一、 三c,

路 由 器 R I

路 由 器 R2

M A亿

MAC 5 I `-严 | MAC(

局 坡 网—

(a) 网 络 配 置

主 机 H2

[P2  I
b  -I

局 坡 网

:  l'J\ l l甘

1到 IP2

由 器 R1 厂二尸产： 路 由 器 R2
勹
- － － － － － － 芷
芷.

4
示

- - - - - - - -

IP 层 上 的 虑拟 互 联 网

三MAC尸 三

MAC 帧

MAC 帧

MAC 帧

(b) 不 同 层 次 、 不 同 区 间 的脱 地 址 和 目 的地址

图 4- 1 6 从 不 同 层 次上看 IP 地址和 MAC 地址

这 里要强调 指出以下 几点：

]
( 1 ) 在 IP 层 抽 象的 互联网上 只 能 看到 IP 数据 报。 虽 然 IP 数据 报要经 过路 由 器R

2

和 R

的两 次转发， 但在它的 首部 中的源 地 址 和目的 地址始终 分 别 是 IP

2

1

“

。 图 中的 数据 报 上

2

1
和 IP

写 的

从 IP

到 IP

”就 表示前 者是 源 地 址 而后 者是 目 的 地址。 数据 报 中间 经 过 的 两 个路 由

器的 IP 地址并不出现 在 IP 数据 报的 首部 中。

(2) 虽 然 在 IP数据 报首部有 源 站 IP 地址， 但路 由器 只 根据目的站 的 IP 地址进行 转发 。
(3) 在局域网的 链路层 ， 只能 看见 MAC 帧。 I P 数据报被 封 装 在 M AC 帧 中 。 MAC 帧
在 不同网络 上传送时， 其 MAC 帧 首 部中的源 地 址 和 目的 地址要发 生 变化 ， 如 图 4- 1 6(b)所

1

示。 开始在 凡到 凡间传送时， MAC 帧 首部中 写的是从 M AC 地址 M AC

3

发送到 M AC 地址

MAC

, 路 由器 凡收到此 MAC 帧 后， 在 数据 链路 层， 要 剥 去 原 来的 MAC 帧 的 首部和 尾 部 ，）

在转发时， 在 数据 链路 层， 要重 新 添 加 上 MAC 帧的 首部和 尾部。 这时 首部 中的 源地址和 目

4

5

的地 址分 别变 成为 MAC

和 MAC

。 路 山器 民 收到此 帧 后 ， 再 次 更换 M AC 帧的 首 部和 尾

6

和 MAC

2
。 MAC 帧的 首 部 的 这 种 变化 ，

部， 首部 中的源 地址和目的 地址分 别 变成为 MAC

在 上面的 IP层上是 看不 见的。

一

(4) 尽 管 互 连在

起 的网络的 MAC 地址体 系各不 相同， 但 IP 层 抽 象的 互联网却 屏 蔽 了

下 层 这 些很复杂的 细节 。 只要我们在网络 层上讨论 问 题 ， 就能 够使用 统 一的 、 抽 象的 IP 地

址研究主机和 主机或路 由器 之 间的通 信。

以 上这些概念是计算机网络的 精髓所 在 ， 对 这些重要 概念 务必 仔 细 思 考 和 掌 握 。

细心的读者 会发现 ， 还有两 个 重 要 问 题 没有 解决 ：

( 1 ) 主 机或路 由器 怎样知道 应 当 在 MAC 帧的首部 填 入什么 样的 MAC 地址 ？
(2) 路 由器 中的 转发 表 是 怎 样 得 出的 ？

•  1 32  •

第一个问题就是下一 节所要讲的内容， 而第二个问题将在后面的4.5 节详细 讨论。

4.2.4 地址解析协 议 ARP

在实际应 用中， 我们经常 会 遇到这样 的问题 ： 已 经 知 道 了 一个机器
（ 主机或路 由 器） 的 IP 地址， 需要找 出 其相应的 MAC 地址。 地址解析协
议AR P[RFC 826,  ST D37]就 是用来解决这样的问题的。 图4-17 说明 了 协议
ARP的作 用。

视 频讲解

荨三

1P

．

网

络

层

．

MAC 地址

I  ARP 请求或 回 答 分组 I

发送

仁

4

太 网 首 部 数 据 1 FCS  |
ARP 分组封装 在 以 太 网 中

图 4- 1 7协议 ARP 的 作 用

还有一个 旧 的协议叫 作逆地址解 析协议 RAR P, 它的作用是使只知 道 自 己 MAC 地址的
主机能够通过协议 RARP 找 出 其 IP地址。 现在的协议 DHCP（见第6 章 的 6.6 节） 已经包
含 了 协议 RARP 的功能。 因 此本 书 不再介 绍 协议 RARP。

下面就介绍协议AR P的要 点 。
我们知 道， 网 络层使用 的是 IP 地址， 但在实际网 络的链路上传送数据帧时， 最终还是
必须 使 用链路层的 MAC 地址 。 IP 地址和下面链路层的 MAC 地址之间 由 于 格式不 同而不存
在简单的映射关系（例如， IP 地址有32 位， 而链路层的 MAC 地址 是 48 位 ）。 此外， 在一
个网 络上可能经常会有新的主 机加 入进来， 或撤走 一 些主机。 更换网 络适配器也 会 使 主机的
MAC 地址 改变（请 注 意 ， 主 机的 MAC 地址实际上就是其网络适 配器的 MAC 地址）。 地址
解析协议AR P解决这个问题的方法 是 在 主 机的ARP 高速缓存中存 放一个从IP地址到 MAC
地址的映射表， 并且这个映射表还经 常 动 态更新 （ 新增或超 时删 除）。

每一台主机都设有一个AR P高速缓 存(ARP cache)， 里面存有本局域网 上的各主机和路
由 器的IP 地址到 MAC 地址的映射 表， 这些都是该主 机目前知 道的一 些 MAC 地址。 那么主
机怎样 知 道这些 MAC 地址 呢？我们可以通过下面的例子来说明 。

当 主机A 要 向 本局域网上的某台主机 B 发送 IP数据报时， 就 先在其 ARP 高速缓存中
查 看有无主机B的IP 地址 。 如 有， 就在AR P 高速缓 存中查 出 其对应的 MAC 地址， 再把这
个 MAC 地址 写 入 MAC 帧， 然 后 通 过 局 域 网把该 MAC 帧发往此 MAC 地址。

也有可能查 不到主机B的 IP 地址。 这可能是主 机B才入网， 也 可能是 主机A刚刚 加 电，
其 高速缓存还是空的。 在这种情况下 ， 主机 A 就 自 动 运 行 ARP , 然后按以下步 骤找 出 主机
B的 MAC 地址 。

(1) ARP进程在本局 域网上广 播发送一个ARP请求分组（具体格式可参 阅 [COM E 06]的
第23 章）。 图 4-l8(a)是主机A 广播发送 ARP 请求分组的示意 图。 ARP 请求分组的主要内
容 是 ： “ 我的 IP 地址是 2 09 . 0. 0.5 , MAC 地址是 00- 00-CO-l5-AD-l 8。 我想知 道 IP 地址为
2 09. 0. 0.6 的主机的 MAC 地址 。 ”

(2) 在本局 域网上的所有主机上运 行的AR P进 程都收到此ARP请求分组。

• 133  •

(3)主机B的 IP地址 与 AR P请 求分组中要查 询 的 IP地址 一致 ， 就收下这个AR P请 求
分组， 并向主机A 发送AR P响应分组， 同时在这个ARP响应分组中写入 自 己的 MAC 地址 。
由 于其余所有主机的IP地址都与AR P请求分组中要查询的IP地址不一致 ， 因 此都不理睬这
个ARP请求分组， 如图4-18(b)所示 。 ARP响应分组的主要内容是： “ 我的IP地址是2 09. 0. 0.6,
我的 MAC 地址是 08- 00-2B-OO-EE-OA。 ” 请注意： 虽然ARP请求分组是广播发送的， 但ARP
响应分组是普通的单播， 即从一个源地址发送到一个目的地址 。

我 的IP地址是 209.0.0.5 , MAC地址是 00-00-C0- 1 5 -AD- 1 8 。
我想知道主机 209.0.0.6 的MAC地址 。

00-00-CO- l 5-AD- l 8

(a) 主机 A 广播发送 ARP 请求分组

我 的IP地址是 209.0.0.6, MAC地址 是 08-00-2B-OO-EE-OA。

z

08-00-2B-OO-EE-OA

(b) 主机 B 向 A 发送 ARP 响 应 分组

图 4- 1 8 地址解析协议 ARP 的 工 作 原 理

(4) 主机A收到主机B的AR P响应分组后， 就在其 ARP 高速缓存中写入 主机B的 IP

地址到 MAC 地址的映射 。

当 主机A向B发送数据报时 ， 很可能以后不久 主机B还要向A发送数据报 ， 因 而主机
B 也可能要向A发送AR P请 求分组 。 为了 减少网络上的通信 最 ， 主 机A 在发送其AR P请
求分组时， 就把 自 己的 IP地址到 MAC 地址的映 射 写 入ARP 请求分组。 当 主机B收到A的
AR P 请求分组时 ， 就把主机 A 的这一地 址 映 射 写 入 主机 B 自 己的 AR P 高速缓存中。 以后
主机B向A发送数据报时就很方便 了 。

可见AR P高速缓存非常有用。 如果不使用AR P高速缓存 ， 那么任何一台主机只要进行
一次通信 ， 就必须在网络上用广播方式发送 ARP 请求分组， 这就会使网 络上的通信 量大大
增 加 。 ARP 把 已 经 得到 的地址 映 射 保 存 在高速缓 存 中 ， 这样就使得该主机下次再和具有同
样目的地址的主机通信时， 可以直接从高速缓存中找到所需的 MAC 地址而不必再用广 播方

式发送AR P请 求分组。

ARP 对保存在高速缓存中的每一个映射地址 项目都设置 生 存 时 间 （例如 ， 10 ~ 2 0 分
钟 ） 。 凡超过生 存时间的项目就从高速缓存中删 除掉 。 设置这种地址 映 射 项 目 的生存 时间是
很重要的。 设想有一种情况： 主机A和B通信 。 A的ARP高速缓存里保存有B的 MAC 地
址 ， 但 B 的网络适配器突 然坏 了 ， B立即更换了 一块 ， 因 此 B 的 MAC 地址就 改变 了 。 假

• 134  •

定 A还要和 B 继 续通信。 A在 其 ARP高速 缓存中 查找到 B原 先的 MAC地 址， 并使用 该
MAC地 址向 B发送数 据 帧。 但 B原 先的 MAC地 址 已经 失效了， 因 此 A 无法 找到主机 B。

一

但是过了

段 不长的 生 存时间， A的 ARP高速 缓存中 已经 删 除了 B原 先的 MAC地 址， 于

是 A重 新广播发送 ARP 请 求 分 组， 又 找到了 B。

一

请注意， ARP用 于解 决同

个局域网上的 主机或路 由器的 IP地 址和 MAC地 址的 映射

一

一
问题。 如 果 所要 找的 主机和源 主机 不在同

个 局域网 上， 例如， 在前 面的图 4-16中， 主机

凡就 无法解 析出另

个 局域网 上主机 压的 MAC地 址（实 际 上 主机 儿也 不需要知道 远程 主

一

机 压的 MAC地 址）。 主机 凡发送给 压的 IP数 据 报首 先需要通过与 主机 凡连接在同

1

个

局域网上的路 由器 凡来转发， 因 此主机 凡必须知道路 由器R

3

3

1

的 IP地 址。 于是 儿使用

]

ARP把路 由器R

的 IP地 址 IP

解 析为 MAC地 址 MAC
2

, 然后把 IP数 据 报传送到路 由器R

o

以后， 凡从转发表知道 应把 IP数 据 报转发到路 由器R

2

5

, 再 使用 ARP解 析出 民的 MAC地

址 MAC

， 把 IP数 据 报转发到路 由器R

。 路 由器 民用同样方 法解 析出目的 主机 儿的 MAC

2

沪

地 址 MAC

, 使 IP数 据 报最 终交付主机 H

从 IP地 址到 MAC地 址的解 析是自 动进行的， 主机的 用 户 对这种地址解析过程 是不知

一

道 的。 只要主机或路 由器要和本网络上的另

个 已知 IP地 址的主机或路 由器进行通信， 协

议 ARP就 会自 动地把这个 IP地 址解 析为链路 层所需要的 MAC地 址， 然后插入到 MAC 帧

中。

下 面我 们 归 纳出使用 ARP的 四种 典型情况（如图4-19 所示）。

H

H I

H2

R 1

3鲤 R2

N, -o- ｀已尸 N2  -

N3

图 4- 1 9 使 用 ARP 的 四 种 典型情况

1

一

一

(1) 发送方是 主机（如 H

)， 要把 IP数 据 报发送到同

1

这时 凡发送 ARP 请 求 分 组（在网络 N

1

上广播）， 找到目的 主机 H

个网络上的另
2
一
一
的 MAC地 址。

台 主机 （如 H

2

)。

(2) 发送方是 主机 （如 H

)， 要把 IP数 据 报发送到另

1

一
个网络 上的

1

台 主机（如 儿或

凡）。 这时 凡发送 ARP 请求分组（在网络 N

)

上广播）， 找到 N

上的

个路 由器 凡的 MAC

地 址。 剩 下的 工作 由路 由器 民来完成。R

1

要 做的 事情是下 面的(3)或(4)。

一

(3) 发送方是路 由器（如R

)， 要把 IP数 据 报转发到与 凡连接在同

2

个网络 N2 上的 主

机 （ 如 儿）。 这时 凡发送 ARP 请求 分 组 （在 N
一

(4) 发送方是路 由器（如R

1

上广播）， 找到目的 主机 凡的 MAC地 址。

3

一

)， 要把 IP数 据 报转发到网络 N

台 主机 （如 H4 )。
个网络 上的。 这时 民发送 ARP 请 求 分 组（在 N2上广播）， 找到连

上的

个路 由器 民的 MAC地 址。 剩 下的 工作 由这个路 由器 民来完成。

在 许 多情况下需要 多 次使用 ARP, 但这 只是 以上 几种情况的反复使用 而 已。

有的读者可能 会产生这样的 问题 ： 既 然在网络链路上传送的 帧最 终是按照 MAC地 址找
到目的 主机的， 那么为什么我 们还要使用两种 地址 ( Ip地 址和 MAC地 址）， 而 不 直接使用

一

MAC地 址进行通信 ？ 只用

个 MAC地 址进 行通信 似 乎可以 免 除使用 ARP。

这个 问题必须弄清 楚。

由 于 全 世 界 存 在 着各式各样的网络， 它 们 使用 不同的 MAC 地 址。 要使这 些 异 构网络

• 135  •

一

2

儿与 民 不是连接在 同
接在 N

上的

能够 互相通信就必须进行 非 常复 杂的 MAC 地址转换 工 作， 因此 由用户或用户 主机来 完 成
一
这 项 工作 几 乎是不可能的 事。 即使是对分 布在 全 世界的以 太网 MAC地 址进行 寻 址， 也是
一

极 其 困 难的。 然 而 IP编 址把这个 复 杂 问题解 决了。 连接到 互 联网的主机 只需各自 拥有

个 IP 地 址， 它们之间的通信就 像连接在 同

个网 络上那样简单方 便， 即使必须多 次调用

ARP来 找到 MAC地 址， 但这个过程都是 由计算机 软件自 动进行的， 对用户来说是看不见的 。

因此， 在 虚拟的 IP网络上用 IP地 址进行通信给 广 大的计算机用户带来了很 大的方 便。

4.2.5

IP 数据报的格式

IP数 据 报的格式说 明协议 IP都具有什么 功能。 在协议 IP的标准中，

描述 首部格式的宽 度是 3 2位（ 即 4字 节）。图4-20 是 IP数 据报的 完整格式

视频讲解

[RFC 791,  STD5]。

位 - 4 --+- 4 -f--— 8
版 本 1首 部 长 度

区 分 服 务

标 识

1 6

总 长 度

片 偏 移

标志 1

生 存 时 间

协 议

首 部 检 验 和

源 地 址

目 的 地 址

可 选 字 段 （ 长 度 可 变 ）

填 充

数 据 部 分

首 部

I

数 据 部 分

-小俨．少·｀．八 ·`．．气·•

发送 在 前

IP 数据 报

图 4-20

IP 数据报的格式

一

从图4-20 可看出 ， 一个 IP数 据 报 由首部和数 据两部分 组成。 首部的 前

一

部分 长度是 固

定的， 共 20 字 节， 是所有 IP数 据 报必须具有的。 在 首部的 固定部分的后面是

些 可选字 段 ，

其 长度是可变的。 下面介绍 首部各字段 的意义。

1 .  I P 数据 报 首 部的 固定部分中的 各字 段

一

(1) 版本 占 4位， 指协议 IP的 版本。 通信 双方使用的协议 IP的 版本必须

致。 这

里讨论的协议 IP 版本号为 4（ 即 IPv4 )。 关千 IPv6（ 即 版本 6的协议 IP )， 我们将在后面的
4.5 节讨论。

(2) 首部长度

占 4位， 可表示的 最 大 十进制数值是 15。 请注意， 首部 长度字段所表
示数的单位是 3 2位字 长 ( 1个 3 2位 字长是 4 字节） 。 因为 IP 首部的 固定部分是 20 字 节，
因此 首部 长度字段的最 小值是 5（ 即 二进制表示的 首部 长度是 0 10 1 )。 而当首部 长度字段为
最 大值 1111时（ 即 十进制的 1 5 )， 就表 明 首部 长度达到最 大值 1 5个 3 2位字 长， 即 60
字 节。 当 IP分 组的 首部 长度不是 4字 节的 整数 倍时， 必 须 利用最 后的 填充字段 加以 填 充。

因此 IP数 据 报的数 据部分 永远在 4字 节的 整数 倍时开始， 这样在实现协议 IP时较为方便。

首部 长度 限制为 60 字 节的 缺点是有 时可能不够用， 但这样 做是 希 望用户尽 量 减 少开销。 最

常用的 首部 长度是 20 字 节， 不使用任何可 选字段。

• 136  •

(3)

8

一
区分服务

占

位， 用 来获 得 更 好的服务。 这个字段在 旧标准中 叫作 服 务 类 型 ，

但 实 际上

Services)

直没有被 使 用过。 1998 年 IET F把这个字段 改名为 区分服务 DS (Differentiated
般 的情况下都 不

。 只 有在 使用 区 分服 务 时， 这个字段才 起 作 用（见 8

.4.4 节）。 在

一

使 用这 个字段 [RFC 2474, RFC 3 1 68

(4)

, RFC 3260 ]。

总 长 度

总 长 度指首部 和 数据之和的 长 度， 单 位为字 节。 总 长度字段为 16 位 ，

6

因此数 据 报的 最 大 长 度 为 i

- l  =  65535字 节。 然 而 实 际上传送这样 长的数据 报在 现实中

是极 少遇到的。

一

一

我们 知道 ， 在 IP层下面的 每

种数据链路 层 协议都 规定 了

一

个数据 帧 中的 数据 字 段的

最 大 长度， 这 称为 最 大传送单元 MTU(Maximum  Transfer  Unit)。当

一

个 IP数据 报 封装成链

路层的 帧 时， 此 数据 报 的 总 长 度 （即 首 部 加 上数 据部 分）

定 不能 超过下面的数据链路层所

规 定的 MTU 值。 例如， 最常 用的以 太 网就 规定 其 MTU 值是 1 50 0 字 节。 若所传送的数据 报

长 度 超过 数据链路层 的 MTU 值 ， 就必 须把过 长的数据 报进 行分 片处理。

一

虽 然 使用 尽 可能长的 IP 数 据 报 会 使传输 效 率 得 到 提高（这样每

个 IP数据 报中首部 长

度 占 数 据 报 总 长 度 的 比例 就 会 小 些 ）， 但数据 报短些也有 好处。 IP 数据 报越短， 路 由器转发

的 速 度 就 越快 。 为此， 协议 IP 规定 ， 在 互 联网 中所有的 主机和路 由器必 须能够接 受 长度 不
超 过 5 76 字节的数 据 报。 这 是 假定 上层 交 下来的 数 据 长 度有 5 1 2字 节（ 合理的 长度） ， 加上

最 长 的 I P 首 部 60 字 节， 再加上 4 字 节的 富 余量， 就 得到 5 76字 节。 当主机 需要发送 长度 超

一

过 5 76 字 节 的数 据 报 时， 应 当 先 了 解

下， 目的 主机能 否接 受所要发送的数据 报 长 度。 否则 ，

就 要进 行 分 片。
一

在 进 行 分 片 时（见后 面的

＂

”

“

”

片 偏移

字段 ）， 数 据 报首部中的

总 长度

字段是指 分片

后的 每

个分片的 首部 长度 与 该 分 片的数据 长度的总和。

一

一

(5) 标识(identification)

”
占 1 6 位。 IP 软件在 存储器中 维 持

“

个计数器 ， 每产生

个

数 据 报 ， 计数 器 就 加 1 , 并将此 值 赋给标识字段。 但这个
无连接 服 务 ， 数 据 报不 存在按序接收的 问题。 当数据 报 由于 长 度 超过 网络的 MTU 而必须分

并不是序号， 因为 IP是

标识

片时 ， 这个标识字段的 值 就 被 复制 到所 有的数据 报 片的标识字段中。 相同的标识字段的 值 使

分 片 后的各数据 报 片 最后能 正 确地 重装成为 原 来的数据 报。

(6)

标志(flag)

占 3 位， 但 目前 只有两位有意义。

•  标志字段中的最 低 位记为 MF (More  Fragment)。 M F = l即表示后面
”

的数 据报。 MF = O表示 这 已 是 若 干数据 报 片中的最后

“
个。

一

一

”

”

还有分片

•  标 志 字段中间的

位 记为 DF (Don't  Fragment)， 意 思是

不能 分片

。 只有 当 D F =

0 时才 允许 分 片。

(7) 片 偏 移

占 13 位。 片 偏移 指 出： 较 长的分 组在 分 片 后， 某 片在原 分 组中的相对
位置 。 也 就是说， 相对 千 用 户 数据字段的 起 点， 该 片从 何处开始。 片 偏移以 8 个字 节为 偏移
定是 8 字 节 ( 64 位） 的

个 数据 报 片外， 其 他每个 分 片的 长度

一

一

单位。 这就是说， 除最 后
一

整 数 倍 。

个 例 子。

下面 举
【 例 4-1 】 一个数 据 报的 总 长度为 3 8 20 字 节， 其数据部 分为 3 80 0 字 节长（使用 固定

首 部 ）， 盂要分 片为 长度不 超过 1 420 字 节的数据 报 片。 因 固定首部 长度为 20 字 节， 因此 每
个 妏据 报 片的数据部 分 长度不能 超过 140 0 字 节。 于是分为 3个数据 报 片， 其数据部分的 长

度 分 别为 1 400 ,

1 40 0和 10 0 0 字节。 原始数据 报首部被 复制为各数据 报 片的首部， 但必须修

• 137  •

改有关字段的 值。图4-2 1给出分 片后 得出的结 果 （ 请注意 片 偏 移的数 值）。

共分部据数

节

。

。

需要分片 的数据报 首部 ｝  ｝  ｝
_,,-
' ,

子=n- o

＇ ， 产＃ 廿

- z ，

＇ ，

夕 ，

, ＇ ，'

夕

2

'

' 2

＇

/1 400 ／K
，三

,

二 入

＇

上

数据屾 勹三二

字节 0

1 399

数据报片 l
片偏移 ＝ 0/8 = 0

1 400
数据报片 2
片偏移 ＝ 1400/8 = 1 75

3

字。。8

，

;'

二

。

8

3

2

0

7

｀

、

、

、

、

、

、

、

、

、

，
，
，
 ，

3

首

部

/

／
8

＝

偏片

移

、

、

、

、

、

＝

9

9

、

、

、

、

,
'
,
'

，
＇
，
＇

，
＇
，
＇

、

勹

2799

2800

3799

图 4-2 1 数据报的分 片举例

表 4-5是本例中数据 报 首部与分 片有关的字段中的数 值， 其中标识字段的 值是任意给定

的 ( 1 2345 )。 具有 相同标识的数据 报 片在目的 站就可 无 误地重装成原来的数据 报。

表 4-5

I P 数据报首部中 与 分片有关的字段中 的数值

总 长 度

标识

原始数据报

数据报片 l

数据报片 2

数据报片 3

3820

1 420

1 420

1 020

1 2345

1 2345

1 2345

1 2345

。

MF

I

。

1

DF

。
。
。
。

片偏移

。
。

1 75

350

现在 假定数据 报 片 2经过某个网络时还 需要 再进行分 片， 即划分为数据 报 片 2-1

（ 携带

数据 80 0 字 节） 和数据 报 片 2-2 （ 携带数据 60 0 字 节）。 那么这两个数据 报 片的 总 长度 、 标

识 、 M F 、 D F和 片 偏 移分别为 ：

8 20 , 1 2345, l ,

 0 ,

 1 75 ;   620 ,  1 2345, 1 ,  0 ,

 275。

(8

) 生 存时 间

占 8 位， 生 存时间字段常用的 英 文 缩 写是 TTL(Time  To  Live)， 表 明

这是数据 报在网络中的 寿命。 由发出数据 报的源点设 置这个字段。 其目的是 防 止 无法交付的

2

)

3

数据 报 无 限制地在 互 联网中 兜 圈 子（例如从路 由 器R

转发到R

1

, 再转发到R

一

, 然后 又转发

到R

)， 因 而 白 臼消 耗网络 资源。 最初的设计以 秒作为 TTL 值的单位。 每经过

一

个路 由 器

时， 就把 TTL 减 去数据 报在路 由 器所消 耗掉的

段时间。 若数据 报在路 由 器消 耗的时间 小

于 1 秒， 就把 TTL 值减 1。 当 TTL 值减为 零时， 就 丢弃这个数据 报。

”
然 而随 着 技术的进步， 路 由 器处理数据 报所 需的时间不 断在 缩 短， 一 般都 远 远 小千 l

“

秒， 后来就把 TTL字段的 功能 改为

跳数限制

（ 但名 称不变 ）。 路 由 器在 每 次转发数据 报

之前就把 TTL 值减 l。 若 TTL 值 减 小到 零， 就 丢 弃这个数据 报， 不 再转发。 因 此， 现在

TTL的 单 位不 再是 秒， 而是 跳 数。 TTL的意义是指 明数据 报在 互联网中 至多可经过多 少个

路 由 器。 显 然， 数据 报能在 互 联网中经过的路 由 器的最 大数 值是 255。 若把 TTL的初始值

一

设 置为 1， 就表 示这个数据 报 只能在本 局域网中传送。 因为这个数据 报

传送到 局域网 上的

某个路 由 器， 在被转发之前 TTL 值就 减 小到 零， 所以 会被这个路 由 器丢 弃。

(9) 协议

占 8 位， 协议字段指出 此数据 报携带的数据使用 何种协议， 以 便使目的 主

机的 IP层知 道 应将数据部分 上交给 哪个协议进行处理。

•  1 38  •

一

常用的
协议名

协议字段值

些协议和相 应的协议字段 值如下 [W-IANA]芞
ICMP
TCP
6

IGMP
2

IGP
9

UDP

EGP

IP 2

4

1Pv6
4 1

1 7

ESP
50

AH
5 1

ICMP-I Pv6
5 8

OSPF

89

(10 ) 首部检验和

一

是 因为数 据报每经过

占 16位。 这个字段 只检验数据 报的 首部 ， 但不包括数据 部分。 这
一
些字段 ， 如 生 存

个路 由器 ， 路 由器都要重 新计算

下首部 检验和（

一

一

时间 、 标志 、 片 偏移等都 可能发 生 变化）。 不 检 验数据部分 可 减 少计算的 工作量。 为 了进

步 减少计算 检 验和的 工作量 ，

IP首部的 检验和 不采用复杂的 CRC 检验码 而 采用 下面的 简 单

计算方 法： 在发送方 ， 先把 IP数据 报 首部划分为许多 16 位字的 序列 ， 并把 检验和字段 置 零。

＠

用反 码 算术 运算

把所有 16位字相 加后 ， 将 得到的和的反 码 写 入 检 验和字段。 接收方收到

一

数 据报后 ， 把首部的所有 1 6 位字再使 用反 码算术 运算相 加

次。 将 得到的和 取反 码 ， 即 得

出接收方 检验和的计算 结 果。 若首部 未发 生任何变化 ， 则此 结 果必为 O , 千是就 保 留这个数

据 报 ； 否则 即 认为出差错 ， 并将此数 据 报 丢 弃。图4-22 说明了 IP数 据 报首部 检验和的计算
过程。

发送端

数
据
报
首
部

l 6 位 1

字 l
字 2 |
|
检 验 和 1
字 n |  l6位 1

16. 位 1
全 o
：

|

反 码 算 术

运 算 求 和 I

1 6 位 1

取 反 码 』

检 验 和 1

1 6 位 I

数 据 部 分 不 参 与 检验 和 的 计 算

数 据 部 分

字 l

1 6 位 1

接收端
|
字 2 1
1 6 位 1
16 位 1 ：
检 验 和 1
字 n G 位 1
厂一

1 6 位 1

反 码 算 术
运 算 求 和

取 反 码 n

结 果 1

1 6 位 1

』

若 结 果 为 0， 则 保 留 ；
否 则 ， 丢 弃 该 数 据 报

图 4-22 IP 数据报首部检验和的计算过程

(11) 源 地址
(12) 目的 地址

占 32位。 发送 IP数 据报的 主 机的 IP地 址。

占 32位。 接收 IP数 据 报的 主 机的 IP地 址。

注 ： 原来如协议字段值这样的数值都是 由 互联 网 赋 号 管 理机构 !ANA 负 责 指派， 并 公 布在有关的 RFC 文档 中 的 。

IANA

由 美 国 政 府 建 立 ， 升 始 由 Jon Postel 负 责 管理。 由 于 Jon Postel 千 1 998 年 去 世 ， 同 时 也 山 千 互 联 网 的商 业 化 和 国 际化 ， 许 多 国 家

CD

一

一一

希 望 由

个 新的 、 私 营 的 、 非 营 利 的 国 际 公 司

互 联 网 名 称与 数 字地址分配机构 I CANN [W-ICANN] 取 代 IANA 。 但 后 来

!CANN 并没有取代 IANA , 而 是 保 留 了 1ANA ， 并 且 和 IANA 进 行 了 分工 。 因 此现 在 就 出 现 了 IANA/I CANN 或 ICANN/IAN A 这

一

样 的写 法 。 这 两 个 机构 都 负 责 IP 地址和

些重要 参数的管 理 。 现在有关互联 网 的重要参数 已 经 不 在 RFC 文 档 公 布 [RFC 3232] ,

曲 改为 在 网 址 www.iana.org 上查询 在线的数据 库 。 从 20 1 6 年起 ， 升始进 行 1ANA 的管理权逐步 向 ICANN 转移的工作 。

＠ 注 ： 这里的 IP 表示特殊的 I P 数据报

[P 数据报再封装到 IP 数 据 报 中 ( I P Encapsulation within IP ) 。

＠ 注 ： 两 个 数进 行 二 进制反码求和的运 算 很 简 单。 它 的规 则 是 从 低 位 到 高 位 逐 列 进 行 计 算 。 0 和 0 相 加 是 0 , 0 和 l 相加

一

一

是 1 ,

1 和 1 相 加 是 0 但要产生

个 进 位 I , 加 到 下

列 。 若 最 高位 相 加 后 产 生进位 ， 则 最 后 得到 的结果要在最低位加 1 。 请注意 ，

反码 ( one's complement ) 和 补码(two's complement) 是 不

样的 。

一

• 139  •

2.IP数据报首部的可变部分

IP数据报首部的可变部分就是 一 个选项字段 c 选项字段用来支持排错、 测量以及安全
等措施， 内容很丰富。 此字段的长度可变， 从1字节到 40字节不等， 取决千所选择的项
目。某些选项项目只需要 l字节， 它只包括 1字节的选项代码。 而有些选项需要多个字节，
这些选项 一 个个拼接起来， 中间不需要有分隔符 ， 最后用全 0的填充字段补齐为 4字节的
整数倍。

增加首部的可变部分是为了增加 IP数据报的功能， 但这同时也使得 IP数据报的首部长
度成为可变的。 这就增加了每 一 个路由器处理数据报的开销。 实际上这些选项很少被使用。
很多路由器都个考虑 IP首部的选项宁段， 因此新的 IP版本 IPv6就把 IP数据报的首部长度
做成固定的了。 这里就不讨论这些选项的细节了。 有兴趣的读者可参阅 RFC791。

4.3 IP层转发分组的过程

4.3.1 埜于终点的转发

我们在图 4-7中已经描述了分组在互联网中逐跳转发的概念。 分组在互
联网上传送和转发是基于分组首部中的目的地址的， 因此这种转发方式称为

基千终点的转发。

视频讲解

因此， 分组每到达 一 个路由器， 路由器就根据分组中的终点（目的地 址）查找转发表，

然后就得知下 一 跳应当到哪 一 个路由器。

但是， 路由器中的转发表却不是按目的 IP地址来直接查出下 一 跳路由器的。 这是因为
互联网中的主机数目实在太大了。 如果用目的地址直接查找转发表， 那么这种结构的转发表

就会非常庞大， 使得查找过程非常之慢。 这样的转发表也就没有实用价值了。 因此必须想办

法压缩转发表的大小。

我们知道， 32位的 IP地址是由两级组成的。 前一 部分是前缀， 表示网络， 后 一 部分表
示主机。 所以司以把查找目的主机的方法变通 一 下， 即不是直接查找目的主机， 而是先查找
目的网络（网络前缀），在找到了目的网络之后， 就把分组在这个网络上直接交付目的主机。

由千互联网上的网络数远远小千主机数， 这样就可以大大压缩转发表的大小， 加速分组在路

由器中的转发。 这就是基千终点的转发过程。

读者可能还会想到 一 个问题， 就是分组首部中没有地方可以用来指明
“
， 那么待转发的分组又怎样能够找到下 一 跳路由器呢？

的 IP地址

“

下一 跳路由器

当路由器收到 一 个待转发的分组， 在从转发表得出下 一 跳路由器的 IP地址后， 不是把
这个地址填入分组首部， 而是送交数据链路层的网络接口软件。 网络接口软件负责把下 一 跳
路由器的 IP地址转换成 MAC地址（必须使用 ARP)， 并将此 MAC地址放在链路层的
MAC帧的首部， 然后利用这个 MAC地址传送到下 一 跳路由器的链路层， 再取出 MAC帧
的数据部分， 交给网络层。 由此可见， 当发送 一 连串的分组时， 上述的这种查找转发表、 调
用 ARP解析出 MAC地址、 把 MAC地址写入 MAC帧的首部等过程， 都是必须做的（当然
都是由机器自动完成的） 。

那么，能不能在转发表中不使用 IP地址而直接使用 MAC地址呢？不行。 我们 一 定要

弄清楚， 使用抽象的 IP地址， 本来就是为了隐蔽各种底层网络的复杂性而便千分析和研究
问题， 这样就不可避免地要付出些代价， 例如在选择路由时多了 一 些开销。 但反过来， 如果

• 140 •

