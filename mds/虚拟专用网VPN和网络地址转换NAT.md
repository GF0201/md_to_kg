中的 IP(IP-in- IP)。

(3) 基千核心的发现技术。 这种方法对千 多 播 组的大 小 在较大范围 内 变化时都适合。 这
种方法是对每 一个多 播 组 G 指定一个核心(core)路由器， 给 出 它的IP单播地址。 核 心 路由器
按照前面讲过的方法创 建出对应于多 播 组 G 的转发树。 如果有 一个路由器 R 1 向 这个核心 路
由器发 送 数据 报， 那么它 在途中经过的 每 一个路由器都 要检查其内 容。 当数据 报到达参加了
多 播 组 G 的路由器 凡 时， 民 就 处理这个数据 报。 如果 民发 出 的是一个多 播 数据 报，其目

的地址是 G 的组地址， 民 就 向 多 播 组 G 的成员转发 这个多 播 数据 报。 如果 民发 出 的数据
报是一个请求加入多 播 组 G 的数据 报， 民 就把这个信 息加到它的 路由中， 并 用隧道技 术 向
R 1 转发 每一个多 播 数据 报的一个副本。 这 样， 参加到多 播 组 G 的 路由器就从核 心 向 外增多
了， 扩大了多 播转发树的覆 盖范围。

目前 还没 有 在 整个互联网范围 使用的多 播 路由选择协议。 下面是一些建议 使用的多 播

路由选择协议。

距 离 向 量 多 播路由选择协议 DVMRP(Distance  Vector M ulticast Routing  Protocol)是在互
联网上 使用的第一个多 播 路由选择协议[RFC 1075]。 由 千 在 UN IX系 统中实现R IP的 程序叫
作 routed, 所以 在 routed 的前面加表示多 播的字母 m , 叫作 m routed, 它 使用 DVM RP 在 路
由器之间传 播 路由信 息。

基于核心的转发树 CBT (Core Based Tree)  [RFC  2189,  2201]。 这个协议 使用核 心 路由器
作为转发 树的根节点。 一个大的 自 治 系 统 AS 可划分为几个区域， 每一个区域 选择一个核 心
路由器 （也叫作中心 路由器 center router, 或 汇 聚点 路由器 rendezvous router )。

开放最短通路优先的 多播扩展 MOSPF (M ulticast extensions to OSPF)  [RFC 1585]。 这个
协议是单播 路由选择协议 OSPF 的扩 充， 使用于一个 机 构 内 。 M OSPF 使用多 播链路状态 路
由选择 创 建 出 基于源 点的多 播转发树。

协议 无 关 多 播－稀疏方式 PIM-SM (Protocol

Independent M ulticast-Sparse M ode)  [RFC
7761,  STD83] 。 这是唯 一成为互联网标准的一个协议 ， 它 使用和 CBT 同样的方法构成多 播
转发 树。 采用 “ 协议无 关 ” 这个名 词是强调： 虽 然 在建立 多 播转发 树时是使用单播 数据 报来
和远 程 路由器联系 的， 但 这 并 不 要求使用特定的单播 路由选择协议 。 这个协议适用千组成员

的分布 非常 分散 的情 况 。

协议 无 关 多 播 － 密 集 方 式 PIM-DM (Protocol Independent M ulticast-Dense M ode)  [RFC

3973]。 这 个 协议 适 用千 组成 员 的分布 非常集中的情况， 例如 组成员 都 在 一个 机构 之 内 。
PIM-DM 不 使用 核 心 路由 器， 而 是 使用洪 泛方式转发 数据 报。

4 . 8  虚拟专用网 VPN和 网络地址转换 NAT

4.8. 1

VPN

虚拟专用 网

由于IP地址的 紧缺， 一个 机构 能够 申 请到的 IP地址 数往往远小 千本 机构所拥有的主机

数。 考虑到互联网并 不 很 安 全， 一个 机构 内 也 并 不需 要把所有的主机 接入到外部的互联网。
实际上， 在许 多情况 下， 很 多 主机 主要 还是和本 机构内的其他 主机进行 通信 （例如， 在大 型
商 场 或 宾 馆中， 有 很 多 用 于 营 业 和管理的计 算 机。 显 然这 些计 算 机 并 不都需 要 和互联网相
连）。假定在 一个 机构 内 部的计 算 机 通信 也是采用 TCP/ IP协议， 那么从原则上讲， 对于这 些

• 185  •

仅在机构 内 部使用的计算机就可以由本机构 (cid:7152) 行分配其 IP地址。 这 就是说， 让这 些计算机

使用仅在本机构有效的 IP地址（ 这种地址称为本地地址）， 而 不需要向互(cid:7110)网的管理机构 申
请 全 球唯 一的 IP 地址（ 这种地址称为全球地址 ）。 这样就可以大大(cid:7188)约 宝 贵的全球 IP地址
资 源。

但是 ， 如果任 意 选 择一 些 IP 地址作 为本机构 内部使用的本地地址， 那么在某种情况下
可(cid:7126)会 引 起一 些麻烦。 例如， 有时机构 内部的某 台 主机需要和互(cid:7110)网连接， 那么这种仅在 内
部使用的本地地址就有可(cid:7126)和互 (cid:7110)网中某个 IP 地址重合， 这样就会出现地址的二 义 性问题。

为了解决这 一问题， RFC 1 91 8 指明了一 些 专 用 地址( private addre s

)。 这 些地址只(cid:7126)用
千 一个机构的 内 部通信 ， 而不(cid:7126)用千和互(cid:7110)网上的主机通信。 换 言 之， 专用地址只(cid:7126)用作本
地地址而不(cid:7126)用作 全球地址。 在互(cid:7116) 网 中 的 所有 路 由 器 ， 对 目 的地址是专 用 地址 的 数 据报一
律不进行转发。 201 3年4 月 ， RFC 6890 全面地给出了所有特殊用途的 IPv4 和 IPv6 地址，
但三个 IPv4 专用地址块的指派并无变化 ， 即

(1 ) 10 .0 .0 .0 /8, 即从10 .0 .0 .0 到10 . 255. 255. 255。

( 2) 1 72.1 6.0 .0 /1 2, 即从1 72.1 6.0 .0 到1 72.31 . 255. 255。

(3) 1 9 2.1 68.0 .0 /1 6， 即从1 9 2.1 68.0 .0 到1 9 2.1 68. 255. 255。
上面的三个地址块分别相当千 原 来的一个A 类网络 、 1 6 个连续的 B 类网络和 256 个连
续的C 类网络。 A 类地址本来 早 已用完了， 而 上 面的地址10 .0 .0 .0 本来 是 分配给A RPA N ET

的。 由 千A RPAN ET 已经关 闭 停 止运行了， 因此这个地址就用作 专用地址。

采用这样的专用 IP 地址的互连网络称为专 用 互(cid:7116) 网或本地互(cid:7116)网 ， 或更简单 些 ， 就 叫

作 专 用 网。 显然 ， 全 世 界 可(cid:7126)有很多的专用互连网络 具有相 同的 IP 地址， 但这 并不会 引 起

麻 烦 ， 因为这 些 专 用地址仅在本机构 内 部使用。 专 用 IP 地址也 叫 作 可 重 用 地址( re us able

addre s

)。

有时一个很大的机构的许多部门分布的范 围很广（ 例如， 在世 界各 地）， 这 些部门经常
要互相 交 换 信 息 。 这 可以有两种方法。 (1 ) 租用 电 信 公 司 的通信 线路为本机构专用。 这种方

法虽然 简单方便， 但线路的租 金 太 高 ， 一 (cid:7183) 难千承 受。 ( 2) 利 用公用的互(cid:7110)网作 为本机构各

专用网之间的通信 载体， 这样的专用网又称为虚拟专 用 网 VPN ( Virtual Private  N e twork )。

这 里 之所以称 为

“ 专用网

”

是 因 为这种网络是 为本机构的主机用千机构 内 部的通信 ，

而不是用于和网络外 非本机构的主机通信。 如果专用网不 同 网点之间的通信 必须经过公用的

互 (cid:7110) 网 ， 但又有保 密的要求， 那么所 有通过互(cid:7116)网传送 的 数 据都必须加 密。 加密需要采用的
＂， 但实 际 上并不是 ， 因为现在并没有真 正使
协 议将在 7.6.1 (cid:7188)讨论。
用通信 专线， 而 VPN 只 是 在效果上和真正的专用网一样。 一个机构要构建 (cid:7164) 己的 VPN 就必
须为它的每一个场所 购 买 专门的硬件和软件， 并进行配置， 使每一个场所的 VPN 系 统都知
道其 他场所的地址。

表示 “

“ 虚拟

好像是

”

图4-64 以两个场所为例说明如何使用 IP隧 道技 术 实现虚拟专用网。

假定 某个机构在两个相 隔 较远的场所 建 立了专用网 A 和 B, 其网络地址分别 为专 用 地

址10 .1 .0 .0 和10 . 2.0 .0 。 现在这 两个场所需要通过公用的互(cid:7110)网构成一个 VPN 。

显然 ， 每一个场所 (cid:7168) 少要有一个路 由 器具有合法的全球 IP地址， 如图 4-64( a )中的路由
器 凡 和 R2。 这 两个路 由器和互 (cid:7110) 网 的接口地址必须是 合法的全球 IP地址。 路 由 器 民 和 R2

在专用网 内 部网络的接口地址则是 专用网的本地地址。

• 1 86  •

s
s
加 密 的从 X 到 Y 的 内 部数 据 报

源地址： 125.1.2.3
目 的地址： 194.4.5.6

外 部数据报 的 数据部分

数据报首部

外 部数据报

x

场所 A

、

10.1.0.0

10.1.0.1 '-

』/产

(a) 使 用 隧 道 技 术

场所 A

虚拟专用 网 VPN

X

、
10.1.0.1 '-.._

10.l .0.0

场所 B /

＿

_

/

二/三::J

1心

么
雪
区
r

场

所

B

1-

。

0

2

厂
l0
二一/

10

＿＿
Y

_

3

＼

)

(b) 构 成 虚 拟 专 用 网

图 4-64 用 隧道技术实现虚拟 专 用 网

在每一个场所 A 或 B 内 部的通信 量 都 不经过互(cid:7110)网。 但如果场所 A 的主机 X 要和另 一
个场所 B 的主机 Y 通信 ， 那么就必须经过路 由 器 R , 和 R2。 主机 X 向主机 Y 发送的 IP 数据
报的源地址是10 .1 .0 .1 , 而目的地址是10 .2.0 .3。 这个数据报先作为本机构的 内 部数据报从 X
发送到与互(cid:7110)网连接的路由器 R,。 路 由 器 R, 收到 内 部数据报后， 发现其目的网络必须通过

互 (cid:7110)网才(cid:7126)到达， 就把整个的 内 部数据报进行加密（这样就保证了 内 部数据报的安 全）， 然
后重新加上数据报的首部， 封 装成为在互(cid:7110) 网 上发送的外部数据 报， 其 源地址是 路 由 器 R ,
的全球地址1 25.1 .2.3, 而目的地址是 路 由 器 民 的全球地址1 94.4.5. 6 。 路 由 器 民 收到数据报

后将其数据部分取出进行解密 ， 恢复出原 来的 内 部数据报（目的地址是10 .2.0 .3)， 交付主 机

Y。 可见， 虽然 X 向 Y 发送的数据报通过了公用的互(cid:7120)网， 但在效果上就好像是在本部门
的专用网 上传送一样。 如果主机 Y 要向 X 发送数据报， 那么所进行的步骤也是类似的。

请注意， 数据报从 R, 传送到 民 可(cid:7126)要经过互(cid:7110)网中的很多个网络和路由器。 但从逻辑
上看， 在 民 到 民 之间好像是 一条直通的点对点链路， 图 4-64( a )中的 ＂ 隧道 ” 就是 这个意 思。
如 图 4-64( b )月示的、 由 场所 A 和 B 的 内 部网络所构成的虚拟专用网 VPN 又称为内 (cid:7116)

网 ( intranet或 intrnnet VPN , 即 内 (cid:7110)网 VPN)， 表示场所A 和 B 都属于同 一个机构。

有 时 一个机构的 VPN 需要有 某 些外 部机构（通常就是 合作伙 伴 ） 参加进 来 。 这样的

VPN 就称为外 (cid:7116) 网 ( extranet或 extranet VPN , 即外(cid:7110)网 VPN)。

请 注 意 ， 内 (cid:7110)网和外 (cid:7110)网都采用了互(cid:7110)网技术， 即 都是 基于 TCP/IP 协 议的。
还有一种类型的 VPN , 就是 远程接入 VPN (remote  access  VPN )。 我们知道， 有的公 司
可(cid:7126)并没 有分布在不 同场所的部门 ， 但却有很多流动 员 工 在外地工作。 公 司 需要和他们保持
(cid:7110)系， 有时 还可(cid:7126)一 起开 电 话会 议或视频会议。 远程接入 VPN 可以满 足这种需求。 在外地
工作的员 工 通过拨号 接入互(cid:7110)网， 而驻 留 在 员 工个人 电(cid:7143)中的 VPN 软 件可以在 员 工的个人

电(cid:7143)和公 司 的主机之 间 建立 VPN 隧 道， 因而外地员 工与公 司 通信 的 内 容也是 保 密的， 员 工

• 187  •

们 感到好像就是使用公司内部的本地网络。

关 于 VPN 隧道的保 密问题 ， 在 后 面的 7.5.1 节 还有进 一 步的论述。

4. 8.2  网 络地址转换

下 面讨论另 一种情 况 ， 就是在 专用网内部的一些 主机本来已经 分配到
了 本地IP 地 址 （即仅 在本专用网内 使用的专用地址）， 但现在又想 和互联网

上 的 主机 通信 （ 并 不需要加密） ， 那么应当采取 什么措施呢？

视频讲解

最 简 单的办法就是设法再 申 请一些 全球 IP地址。 但这 在 很 多 情 况 下是不容 易做到的。

目 前 使用得最多 的方法是采用网络地址转换。

网络地址转换 NAT (Network Address  Translation)方法是在 1994 年提出的。 这种方法需
要在 专用 网连接到互联网的 路由 器上安装 NAT 软件。 装 有 NAT 软件的路由 器叫作 NAT 路
由 器， 它 至 少 有 一 个 有效的外部 全球 IP地址。 这样 ， 所有 使用本地地址的 主机 在和外界 通
信时， 都 要 在 NAT 路由 器上将其本地地址转换成全球IP地址 ， 才能和互联网连接。

图 4-65 给 出了NAT 路由 器的工作原理。 在图中， 专用网 192.168.0.0 内所有 主机的 IP

地址 都是本地IP地址 192.168.x.x。 NAT 路由 器至少 要 有一个 全球 IP地址， 才能和互联网相
连 。 在 本例中 ， NAT 路由 器的 全球 IP地址是1 72.38. 1 .5 （当 然， NAT 路由 器可 以 有多 个 全
球IP 地 址 ）。

专 用 网 192.168.0.0/16

图 4-65 NAT 路 由 器的 工 作 原 理

NAT 路由 器收 到从专用网内部的 主机A 发 往 互联网上 主机B的IP数据 报 0 : 源地址 S
=  192. 1 68.0.3， 而目的地址 D =  213. 1 8.2.4。 NAT 路由 器 通过内部的 NAT 转换表， 把专用网
的 IP 地址 192.168.0.3 , 转换为 全球IP地址 172.38.1.5 后， 改 写到数据 报的首部中作为新的
源地址 ， 然后把新的数据 报 ＠ 转发出去。 主机 B 收到 IP 数据 报 ＠ 后 ， 发 回 应答 ＠，B发送
的 IP 数据报的源地址就是自 己的地址： S =  213.18.2.4, 目的地址就是刚才收到的数据 报的

源地址 ， 因 此现在 D =  172.38.1.5。 请注意，B 并 不知道A 的专用地址 192.168.0.3。 实际上，
即 使知道了 ， 也 不能 使用， 因为互联网上的路由 器不能转发 目的地址是任何专用地址的IP
数据 报。 当 NAT 路由器收到B发来的 IP 数据 报 ＠时， 还 要进 行 一 次 IP 地址的转换。 通过
NAT 转换表 ， 把收 到的 IP数据 报 使用 的 目的地址 D =  172.38.1.5 转换为专用网内部的目的
地 址 D = 192.168.0.3 （即 主机A 真 正的本地IP地址）， 变成了 数据 报 0 , 然后发送到A。

由 此可见， 当 NAT 路由器具 有 n 个 全球 IP地址时， 专用网内最 多可 以同时 有 n 台主机
接入到 互联网。 这样就可 以 使专用网内较 多 数量的 主机， 轮流 使用 NAT 路由 器 有限 数量的

•  1 88  •

全球 IP地址。

显 然， 通过 NAT 路由器的通信 必 须 由专用网内的 主机发起。 设 想 如果有专用网 上外面
的 主机要发起 通信， 当IP数据 报到达 NAT 路 由器时， NAT 路由器就不知道应当把 目 的IP
地址转换成专用网内的哪一个本地 IP地址。 这 就表 明 ， 专用网 内 部的 主机不 能直接充 当 服
务 器用。

为了 更加有效地利用 NAT 路 由器上的 全球IP地址， 现在常用的 NAT 转换 表把运输层
的端 口号也利用上 。 这 样， 就可以使 多个 拥有本地地址的 主机， 共用 NAT 路由 器上的一个
全球IP地址， 因而可 以同时和互联网上的不 同 主机进行 通信 [COM E06]。

由千运输 层的端 口号将在 下一 章 5.1.3 节讨论， 因此 ， 建议在 学 完 运输层的有 关内容后 ，

再学 习 下 面的内容。 但从系 统性方 面考虑， 把下 面的这 部 分内容放 在本 章中 介 绍 较 为合适。

使用端 口 号的 NAT 也 叫 作网 络 地址 与 端 口 号转换 NAPT (Network Address  and  Port
Translation)， 而 不 使用端 口 号的 NAT 就叫 作 传 统 的 NAT (traditional  NAT) 。 但在 许 多 文 献 中
并 没 有 这 样区分， 而 是不加区分地都 使 用 NAT 这个更加简 洁 的缩 写 词 。 表 4-9 说 明 了
NAPT 的地址转换 机制。

表 4-9 NAPT 地址转换表举例

方 向

字 段

原先的 I P 地址和端 口 号

转换后的 I P 地址和端 口 号

从专用 网 发 往 互联 网

源 IP 地址TCP 源喘 口

1 92. 1 68.0.3 30000

从专用 网 发往互联网

源 IP 地址TCP 源端 口

I 92 1 68 0 4 30000

从互联 网 发 往专用 网

目 的 IP 地址TCP 目 的 端 口

1 72 38. 1 5 -4000 I

从互联网 发 往专用 网

目 的 IP 地址TCP 目 的瑞 口

1 72 38. 1 5 40002

1 72 38 I 5 .4000 1

1 72.38. 1 5 40002

1 92 1 68.0 3 30000

I 92 1 68 0 4 30000

从表 4-9 可 以看 出， 在专用网内 主机 192.168.0.3 向互联网发送 IP 数据 报 ， 其 TCP 端 口
号选择为30000。 NAPT 把源IP地址和 TCP端 口号都进行转换（ 如果 使用 UDP, 则 对 UDP
的端 口号进行转换 。 原理是一样的） 。 另 一 台主机 1 92. 1 68.0.4 也 选择了同样的 TCP端 口 号
30000 。 这 纯属巧合 （端 口号仅 在 本 主机中才 有意 义） 。 现在 NAPT 把专用网内不 同的源 IP

地址都转换为同样的 全球 IP地址。 但 对源主机所采用的 TCP端 口号 （ 不 管 相同 或 不 同 ），
则 转换为不 同的新的端 口号 。 因 此 ， 当 NAPT 路由器收到从 互 联网发来的应答时， 就可 以

从 IP数据 报的数据 部 分找出运输 层的端 口 号， 然后根据 不 同的目的端 口号， 从 NAPT 转换
表中找到正确的 目的 主机 。

应当指出， 从 层次的角 度 看， NAPT 的 机制有些特 殊。 普 通 路由 器 在转发 IP 数据报时，

对于源 IP地址或 目的 IP地址都是不改变的。 但 NAT 路 由器在转发 IP数据报时， 一 定要 更
换 其 IP地址（ 转换源 IP地址或 目的 IP地址）。 其 次， 普 通 路由 器 在转发 分组时是工作在网
络 层的。 但 NAPT 路由器还要 查 看 和转换 运输层的端 口号 ， 而 这 本来应 当 属 于 运 输 层 的范
畴。 也 正 因为这 样， NAPT 曾 遭 受 了一 些 人的批评 ， 认为NAPT 的操作没有严格 按 照 层 次的
关 系 。 但 不管怎样， NAT （包括 NAPT ) 已成为互联网的一个重 要 构 件 [RFC3022] 。

4 . 9   多协议标签交换 M PLS

IETF 于1997 年成立 了M PLS 工 作 组， 为的是开发出一种新的协议。 这种新的协议就是
多协议标签交换M PLS (M ultiProtocol Label  Switching) 。 “ 多 协议 ” 表示 在M PLS 的上层 可 以

• 189  •

