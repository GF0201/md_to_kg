｀

被叫方

SIP

代理
服务器

主叫方

INVITE

OK

ACK

- I

SIP

登记器

圣

i t

INVITE

OK

ACK

查找

回答

电话交谈
BYE

图8-17 跟踪被叫方的机制

如果被叫没 有在这个 SIP登记器进行过登记， 那么这个 SIP登记器就发回重定向报(cid:4825)，

指示SIP代理服务器向另

一

个 SIP登记器重(cid:4842)进行DNS查询， 直到找到被叫为止。 图 8-17

给出了这种情况下主叫(cid:4851)发出确认之前的呼叫过程。

SIP还有

一

个配套协议是会话描述协议SDP( S essio n  D es cripti o n  P roto col)。 SDP在电话

会议的情况下特别重要， 因为电话会议的参加者应当能够动态地加入和退出。 SDP详细地

指明了媒体编码、 协议的端口号以及多播地址。 SDP现在也是互联网建议标准[RFC 8866]。

由于 SIP问世较晚， 因此它现在比H.3 23占有的市场份额要小。 对今后作为IETF标准

的SIP协议的进展情况应当引起我们的注意。

8.4  改进

“

尽最大努力交付

＂

的服务

使互联网更好地传送多媒体信息的另

一

种(cid:4851)法， 是改变互联网平等对待所有分组的思

想， 使得对时延有较严格要求的实时音频／视频分组， 能够从网络得到更好的服务质量QoS。

下面我们先介绍提供服务质量的

一

般(cid:4852)法。

8.4.1  使互联网提供服务质量

根据ITU-T在建议书 E .800 中 给出的定义， 服务质量QoS是服务性能的总效果， 此效
果决定了 一个用户对服务的满意程度。 因此在最简单的意义上， 有服务质量的服务就是能够
满足用户的应用需求的服务， 或者说， 可提供

致的、 可预计的数据交付服务。

一

在涉及

一

些具体问题时， 服务质量可用若干基本的性能指标来描述， 包括可用性、 差

错率、 响应时间、 吞吐量、 分组丢失率、 连接建立时间、 故障检测和改正时间等。 服务提供

者可向其用户保证某

一

种等级的服务质晕。

我们已多次强调过， 互联网的网络本身只能提供

“

＂
尽最大努力交付

的服务。 而要传

送多媒体信息， 网络又必须具有

一

定的服务质量。 下 面 通过图 8-18的例子说明应从哪些(cid:4851)

面 入手使互联网具有

一

定的服务质量[KUR017]。 图中 表示局域网上的两台主机凡和H2 通

•  3 90 •

过非常简单的 网络（ 路由器 R1 和 民 以及连接它们的链路） 分别向远地另外两台主机压和
儿发送数据。 连接 R1 和民的链路带宽是1.5 Mbit/s。 现在考虑以下四种情况。

1.5 Mbit/s链路

H2

H4

}；：：：：二三二MbIt/s链路

输出队列

图8-18 主机H 1 和H2 分别向主机H3 和儿发送数据

(1) 一 个1Mbit/s的实时音频数据和一 个FTP文件数据
假定凡向儿传送1Mbit/s的实时音频数据，

而压向儿传送低优先级的FTP文件数据。
两台主机发送的数据都在 路由器凡的 输出队列中排队 。 若 突然有一 个很大的FTP数据块来
到 R1, 就会把输出队列全部占满 。 后面到达 路由器 R1 的实时音频 分组就会被丢弃 。 显然这
是不合理的 。 因此需要增加一 个机制， 就是给不同性质的分组打上不同的标记。 这样当H 1
和压的分组进入路由器凡时， 凡就能够识别凡的实时数据分组， 并使这些分组以高优先
级进入输出队列， 而仅在队 列有多余空间时才准许低优先级的FTP的数据分组进入 。

(2) 一个1Mbit/s的实时音频数据和一 个 高优先级的FTP文件数据
假定 FTP的用户用高价从 ISP处购买了高优先级服务，

而 实时音频的用户只购买了低
优先级服务 。 因此， 仅根据分组自己的标记来确定 其服务等级还不 够 合理。 可见应当使路由
器增加一 种机制
分类(classification)， 即路由器根据某些准则（例如， 根据发送数据的地
址）对输入分组进行分类， 然后对不同类 别的通信量 给予不同的优先级 。

(3 ) 一 个数据率异常的实时音频数据和一个FTP文件数据
假定上述的主机儿的数据率突然不正常地增大到1.5 Mbit/s或更高（这可 能是出了故
障或恶意破坏网络的正常运行）， 那么就会使主机儿的 FTP的低优先级数据无法通过路山
器 R1
流 不要影响其他正常的数据流 在网络中通过。 例如， 可以将凡 的数据率限定 为 1Mbit/s。
路由器民 不停地监视凡的数据率。 只要儿的数据率超过规定的1 Mbit/s, 路由器民就把
其中的 某些分组丢弃， 使其 数据率不超过原来设定的门限。

。 因此， 应当使路由器能够对某个数据流进行通信量的管制(policing)， 使得这个数据

为 了更加合理地利用 网络资源， 应在 路由器中再 增加一 种机制—一 调度(scheduling)。

我们可以利用调度功能 给实时音频 和文件传送这两个应用分别 分配1Mbit/s 和 0 .5 Mbit/s的
带宽。 这就好像在带宽为 1.5Mbit/s 的链路中划分出两个逻辑链路， 其带宽分别 为 1Mbit/s
和 0 .5 Mbit/s, 因而对这两种应用都有 相应的服务质量保证。
(4) H冲DH2 都发送数据率为 1Mbit/s的实时数据
在 这种情况下， 到达路由器民的总数据率是2 Mbit/s, 已超过了1.5 Mbit/s链路的带宽。

若使这两台主机发出的数据流平等地共享1.5 Mbit/s链路的带宽， 则 每个数据流平均 将丢失
25％的分组， 因而都 变得 没有用了。 比较合理的做法是让 一 个数据流通过1.5 Mbit/s 的链路，
而阻止另 一 个数据流的通过。 这就需要另 一种机制 －—— 呼叫接纳(call admission)
。 这里借用
了电话网的术语， 进一步的讨论见后面的8.4.3节。 在使用呼叫接纳机制时， 一个数据流要
预先声明它所需的服务质量， 然后或者被准许进入 网络（能得到所需的服务质量）， 或者被

•  391 •

拒绝进入 网络（当所需的服务质量 不 能 得到满足时）。

上面简单地说明了为使互联网能 够 提供一 定的服务质量， 应当设法 增加一 些机制， 即：

分组的 类 别 、 管制、 调度以及呼叫接纳。 在后 面的几节我们将陆续讨论 这些问题。

8.4.2  调度和管制机制

调度 和管制机制是使互联网能够 提供服务质量的重要措施[STALlO]。 下面先讨论调度

机制。

1. 调度机制

这里所说的 “ 调度” 就是指排队的规则。 如果不采用专门的调度机制， 那么在 路由器
的队列采用的默认排队规则就是先进先出FIFO (First I n First  Out) 。 当队列已满时， 后 到达
的分组就被丢弃。 先进先 出的最大缺点就是不能区分时间敏感分组和一般数据分组， 并且也
不 公平， 因为这使得排在长分组 后 面的短分组要等待很长的时间。 就像在机场办理登机卡时，
正巧排 在你前面的一 个 人代表20个人的团队来办理登机卡， 这 时你只能耐心等待。

在先进先出的基础上 增加按优先级排队， 就能使优先级 高的分组优先得到服务。 图8-19
是按优先级排队的例子。 图中假定优先级 分为两种， 因此 有两个队列： 高优先级队列 和低优
先级队列。

路由器

1  |  |  |

高优先级队列

分组离开路山器

分类

＼三勹勹丿门

／

I

调度'

｀｀、 ）

,

l,＇，＇,'，l l l, l l l l l l l, l l l l, l l l l,'l l, l l l l,'，l l l l l,'l l l,＇l l l l l l l l l l l l, l l l l l l l l, l, l,'l, l l l l l, l l l l l l l l l, l l，咖 ll l l l l l l, l l l l l l l, l,＇，l

分组到达

氐

低优先级队列

忖卢

-------------------, ------------------' ？ ？

5高3

；

接受服务厅 勹 巨 5  巨
分组离开 心 心 卢 心 卢►t

-_· ___ -------_·_ ---r ------------------, -------------------r -- -► t

图8-19 按优先级排队的例子

假定分组的 到达是按照编号从小到大的顺序。 在到达 路由器 后 就由分类器（又称为分
类程序）对其进行优先级 分类， 然后 按照类 别进入相应的队列。 图中的圆圈表示调度， 其作
用是从队列中取走排在队首的分组。 “ 调度” 相当千排队论中的服务员。 只要高优先级队列
中 有分组 在 内， 就从高优先级队列中按照链路速率取 出排在队首的分组。 只 有当高优先级队
列已空时， 才能轮到低优先级队列中的 分组 输出 到链路上。 在图8-19 的 下方给 出三个 高优
先级的分组（灰色方块）与两个低优先级的分组（臼色方块）交替地到达路由器。 但 在 分组
离开 路由器时， 高优先级的 分组3 和5 都提前得到服务。 请注意， 低优先级的分组 2仍然比
高优先级的分组5 先 得到服务。 这 是因为在分组2得到服务时， 分组5 还没有到达 路由器。
当 高优先级的分组5 到达时， 路由器正在 发送分组 2, 因此 分组5 必须等待分组 2离开 路由
器后 才能得到服务。

•  392 •

简单地按优先级排队会带来

一

个缺点， 这就是在高优先级队列中总是有分组时， 低优

先级队列中的分组就长期得不到服务。 这就不太公平。 公平排队 FQ (Fair Qu euin g )可解决这
一

一

一

一问题。 公平排队是对每种类别的分组流设置

个队列， 然后轮流使每

个队列

次只能发

一

送

个分组。 对于空的队列就跳过去。 但公平排队也有不公平的地(cid:4851)， 这就是长分组得到的

服务时间长， 而短分组就比较吃亏， 并且公平排队并没有区分分组的优先级。

为了使高优先级队列中的分组有更多的机会得到服务， 可增加队列

“

权重

”

的概念，

这就是加权公平排队WFQ(W ei ght ed Fair Qu euin g )， 其工作原理如图 8-20所示。

厂门叮

1

V

1  路由器

分类器

图8-20 加权公平排队WFQ

加权公平排队WFQ 是这样工作的： 分组到达后就进行分类， 然后送交与其类别对应的

队列（图中假定分为三类）。 三个队列按顺序依次把队首的分组发送到链路。 遇到队列空就

跳过去。 但根据各类别的优先级不同， 每种队列分配 到的服务时间也不同。 可以给队列i指

一

派

个权重Wi 。 于是队列l 得到的平均服务时间为Wi/（邑w丿）， 这里Iw丿 是对所有的非空队列的

权重求和。 这样， 若路由器输出链路的数据率（即带宽）为R, 那么队列i将得到的有保证

的数据率凡应为

RI.  =

Rxw/
LW
丿

( 8- 1)

加权公平排队WFQ 在服务质量体系结构中占有重要的地位。 当前的许多路由器产品都

加入了WFQ调度的功能。 为了更好地理解WFQ的概念， 图 8-21给出了

一

个简单的例子，

并把先进先出 F IFO的情况也同时画出。 我们假定在WFQ的情况下， 分配 给分组流 l 的权
半）， 而分配 给其他 1 0个分组流的权重都

重是 0.5（即得到服务的时间占总的服务时间的

一

各为 0. 05。 这样， 分组流 2~ 11 共 1 0个分组流合起来的权重也是 0. 5。
一
一
个队列， 因此每个分组流的第

在使用先进先出规则时， 只有

个分组共 11 个分组排

在队首。 在图 8-21(a )和(b )两种情况下， F IFO 的结果都是

一

样的， 即队列 中前 11 分组发送

完毕后才能发送分组流 中剩下的分组。 在使用WFQ 时， 在图(a )中分组流 l 先可以 发送 1 0

个分组（但第11 个分组还不能发送）， 而在图(b)中分组流l和其他的分组流交替地发送。

不管是哪

一

种情况， 分组流l都能够得到更多时间的服务。

2. 管制机制

前面 提到了使用管制机制可以 提供服务质量。 对

一

个数据流， 我们可根据以 下三 个(cid:4851)

面 进行管制：

( 1)平均速率

个数据流的平均速率。 这里的平均速率是指在一定的
时间间隔内通过的分组数。 但这个时间间隔的选择也说明了这个指标的严格程度。 例如， 限

网络需要控制

一

•  3 93 •

定数据流的平均速率为每秒5 0个分组和平均速率为每分钟3000个分组， 虽然这两个指标的
平均值 都一 样， 但 其严格程度却不同。 假定有一 个数据流， 有 一 秒钟通过了1000 个分组，
但一 分钟平均下来仍不超过3000 个， 那么 这个数据流的平均速率符合后面一个指标， 但却
远远不满足前面的指标。

分组流
l
分组流2
． ． ．

分组流

l
FIFO

WFQ

l

分组流
分组流2． ． ．
分组流11

FIFO

WFQ

门l
[

2

－
门 I 2 |3 I 4 | 5 | 6  I 7 I 8 | 9|l0|ll| l |  l | l |  l 1  1 | l | 1 |  l | l

I

工 工 工

(a)

工 口］ 工 口］ 口］ 工 荨 t

工

[

2

11

L1 | 2 | 1  | 3 | 1  | 4 | 1 | 5 1 1  | 6-Ll Ul l | 8 | l | 9 | l |10| l |ll

t

图8-21

(b)

WFQ与FIFO的比较

(2)峰值速率

峰值速率限制 了数据流在非常短的时间间隔内的 流量。 数学上的 ＂ 瞬
时值” 在实际网络中无法测定。 因此这里所说的 “ 非常短的时间间隔＂ 需要指明时间间隔是
多少。 例如， 限定数据流的平均速率为每分钟 3000 个分组， 但同时限定 其峰值速率 不超过
每秒1000个 分组。 峰值速率也 同时受到链路带宽的限制。

(3)突发长度 网络也 限制在非常短的时间间隔内连续注入到网络中的分组数。
要在网络中对进入网络的 分组 流按以上三个指标进行管制， 可使用非常著名的漏桶管

制器( leaky bucket policer) （可简称为漏桶）， 其工作原理如图8-22所示。

注入漏桶的速卒为每秒r个权标

在任何时间间隔t内准许进入网络的分组数不能超过rt+ b

图8-22 漏桶管制 器的工作原理

漏桶 是一种抽象的机制。 在淜桶中可装入许多权标(token)

， 但最多装入b 个权标。 只要
漏桶中的权标数小千b个， 新的权标就以每秒r个权标的恒定速率加 入到漏桶中。 但若漏桶
已装满了b个权标， 则新的权标就不再装入，

而 漏桶的权标数达到最大值b。

漏桶管制分组 流进入网络的过程如下： 分组进入网络前， 先要进入一 个队列中等候漏

•  394 •

桶中的权标。 只要漏桶中有 权标， 就可从漏桶 取走

一

个权标， 然后就准许

一

个分组从队列进

入到网络。 若漏桶已(cid:4873)权标， 就要等(cid:4843)的权标注入到漏桶， 再 把这个权标拿走后才能准许下
”
一
个分组进入网络。 请注意： “准许进入网络

＂
已经进入了网络

， 因为分组进

并不等千说

”

入网络还需要时间， 这 取决于输出链路的带宽和分组在输出端的排队情况。

假定在时间间隔t中 把湿桶中的全部b 个权标都 取走， 但在这个时间间隔内漏桶又装入
了rt个(cid:4843)的权标， 因此在任何时间间隔t内准许进入网络的分组数的最大值为rt+  b。 控制

权标进入漏桶的速率r就可对分组进入网络的速率进行管制。

3. 漏桶机制与加权公平排队相结合

把漏桶机制与加权公平排队结合起来， 可以 控制队列中的最大时延。

现假定有n 个分组流输入到

一

个路由器， 复用后从

一

条链路输出。 每

一

个分组流使用

漏桶机制进行管制， 漏桶参数为bl 和ru i =  l, 2 ,…，n（如图8-23 所示）。

路由器

图8-23 用漏桶机制进行管制

前面已经讲过， WFQ 可以 使每

一

个分组流得到如公式( 8-1)所示的有保证 的数据率。 那

么当分组流通过漏桶后等待WFQ服务时，

一

个分组所经受的最大时延是多少？

现在考虑分组流l。 假定漏桶i已经装满了 bl 个权标。 这就表示分组流 i不需要等待就

可从漏桶中拿走bl 个权标， 因此bl 个分组可以 马上从路由器输出。 但分组流i得到的数据率

由公式( 8-1)给出。 这 bi 个分组中的最后
组所需的时间dmax' 即b汛余以 公式( 8-1)给出的传输速率：

一

个分组所经受的时延最大， 它等千传输这 bi 个分

biw
d  =
丿
max  Rxwi

1

( 8-2)

8.4.3 综合服务 IntServ与资源预留协议 RSVP

最初试图在互联网中将互联网提供的服务划分为不同类别的是 IETF提出的综合服务
I ntS er v (I nteg r ated  S er vices)  [ RFC  221 0-2215 ]和资源预留协议 RS VP(ReSo u rce  reser Vatio n

Proto col) [ RFC  2205 -2209] [ZHAN93 ]， 其中的某些 RFC (cid:4825)档已成为互联网的建议标准。

I ntS er v可对单个的应用会话 提供服务质量的保证 ， 其主要特点有 二：

( 1) 资源预留。

宽和缓存空间）。

( 2)呼叫建立。

一

一

个路由器需要知道给不(cid:4837)出现的会话 已经预留了多少资源（即链路带

个需要服务质量保证 的会话 ，

必须首先在源点到终点路径上的每 一

个

路由器预留足够的资源， 以 保证 其端到端的服务质量的要求。 因此， 在

一

个会话 开始之前必

•  3 95 •

一

须先有

个呼叫建立（又 称 为呼叫 接纳 ）过程， 它需 要 在 其 分组 传输路径上 的每

一

个路由器

都参加。 每

一

个路由器 都要确定该 会 话所 需的本地资源 是 否 够用 ， 同时还不要影 响到已经建

立的会 话 的服务 质量。

Int S er v定义 了两类 服务 ：
( 1) 有保证的 服务( g ua rant eed

个严格的上 限 。

ser vi ce)， 可保证

一

个分组 在 通过路由 器时的排队时延有

一

(2 ) 受 控 负 载的 服务 ( co nt rolled-loa d

ser vi ce)， 可 以使 应用 程序 得 到比通常 的

“

尽 最大努

”
力

更加可靠 的服务 。

Int S er v共有以 下 四 个组 成部 分：
( 1 ) 资源预留协议 RS VP , 它是I nt S er v的信令 协议。
(2 ) 接纳控制 (a dmi ssi o n cont rol)， 用来决定是否 同 意对某

一

资 源的请求。

( 3) 分类器 ( cla ssifi er)， 用来把进入 路由 器的 分组 进行分类 ， 并根据分类的结果把不同类

别 的 分组放入 特定的队列。

(4 ) 调度器 ( sch ed

uler)， 根据服务 质量要求决定分组发送的前后顺序 。

会话必须 首 先声 明它所 需 的服务 质佩 ， 以便 使 路由 器能够确定是否 有足够的资源来满

足该 会话 的需求。 资源预留协 议 RS VP 在 进行资 源预留时采 用了多播树 的(cid:4853) 式 。 发送端发送

PA TH报 (cid:4826) （即存储 路径状 态 报 (cid:4827) ）， 给所有的接收 端指明通信量的 特性 。 每 个 中 间的路由

器都要转 发PA TH报 (cid:4828) ， 而接 收 端用 RE S V报 (cid:4828) （即资源预留 请求报 (cid:4828) ） 进行响应。 路径上

的每个路由 器对 RES V 报 (cid:4826) 的请求都可以拒 绝或接受。 当请求被 某 个路由器拒 绝 时， 路由

一

一

器就发送
缓存空间就被 分配 给这个分组 流， 而相 关 的流(flow)状 态信息就保 留在路由 器 中 。

个差错报 (cid:4826)给接收 端， 从而终止 了这

信令 过程。 当 请求被接受 时， 链路带宽和

“

”
流

是在

多媒体通信 中 的

一

个常用 的名 词 ， 一 般定义 为

“

具有同 样的源 IP 地址 、 源端 口 号 、 目 的 I P

地址 、 目 的端 口 号 、 协议标识符及 服务质量需求的

一

连 串分组

”

。

图 8-24 用

一

个简 单 例子说 明 RS VP 协议的要点。 设 主机 凡要 向 互联网上 的四 台主 机

压～H 5 发送多播视频节 目 ， 在 图 中 这四 台主 机 右 边 标注 的数 据率 就 是这些主 机打 算 以 这样的
数 据率来接收 儿 发送的视频节 目 。 这个视频节 目 可使 用不 同的数 据率来接收 。 用较低数 据

率接收 时， 图 像 和声 音 的质量也就较差 了。

主机 凡 先以 多 播(cid:4853) 式 从 源 点 H 1 向 下游 (cid:4851)向 发送 PA T H 报 (cid:4828) ， 如 图 8-24 (a )所示。 当

PA TH报(cid:4829)传 送到多播路径 终点 的四 台 主机 （即叶 节 点） 时， 每

一

台 主机就向 多 播路径 的上

游 发送 RES V 报 (cid:4826) ， 指 明在接收 该 多 播节 目 时所 需的服 务 质量等级。 路由器若 (cid:4874) 法预留
RES V报(cid:4830)所请求 的资源 ， 就返 回 差错报(cid:4827) 。 若能 预留， 则 把下游传 来的 RES V报(cid:4826) 合 并构成
(cid:4842)的 RES V报 (cid:4826) ， 传送给 自 己 的上 游 路 由器， 最 后 传送到源点主机H 1 。 这些情况如 图 8-24 (b )

所示。 因 此， RS VP协议是面 向 终 点 的 。

需 要注 意的是， 路 由器 合 并下游 的 RES V 报 (cid:4826) 并不是 把 下 游 提 出 的预留 数 据率简单 地

相 加而是 取其 中 较大的数 值 。 例如 ， 路由 器凡 收 到两个预留 3 Mbit/ s的 RESV 报 (cid:4828) ， 但 凡
向 民 发送的 RES V报(cid:4826) 只 要求 预留 3 Mbit/ s而不是 6Mbit/ s（因为 向 下游 (cid:4851)向 发送数 据是采

用可以节 省 带宽的多播技 术 ） 。 同理 ， 凡 向 民 发送的 RESV 报 (cid:4826) 要求预留 100 kbit/ s而不是
1 50  kbit/ s。 最后， R1 向 源 点 儿 发送的 RESV 报 (cid:4826) 要求预留 3 Mbit/ s。 当 凡收 到返 回 的

RES V报 (cid:4828) 后， 就开始 发送视频数据报(cid:4825)了 。

•  3 96 •

H,

源 点
心1
!
） 三千一 －

R I

l

－ 表示 PATH

报

文）

H2

H3

50 kbit/s

I 00 kbit/s

凡 3 Mbit/s

R2

安｀
丁 I  H
报文

5

一 1

令

3 Mbit/s

(a) 源 点 用 多播发送 PATH

` s

3

2

,

^ __ ＿

H2

_，

50 kbit/s

H 1

户

1
源 点
三三硒芦二嘎气
,

3 Mbit/s  R

3 M bit/s  R

＼00

2

1

匕勹｀， 儿 1 00 kbit/s

二示 RESV报文

］

一—

_j江 二三 凡 3 Mbit/s
SV报文

(b) 各终 点 向 源 点 返 回 RE
图8-24 RSVP 协 议 的 工作原理

IntServ/RSVP 使 得互联网的体 系 结 构 发生 了根本 的 变化 ， 因为 IntServ/RSVP 使 得互联

网 不再 是提供 “ 尽 最大努力 交付 ＂ 的服务。 在有关 服务质量的协议 中， RSVP 是最复 杂 的。

IntServ/RSVP 所基于 的概念 是端 系 统 中与 分组 流有关 的状态 信息 。 各 路由器中的预 留 信
息 只 存储有 限 的时间 （ 这称为软状态 soft-state ) ， 因而 各终点对这些 预 留 信息 必须定期进行
更新 。 我们 还应注意到， RSVP 协 议 不 是运输层 协 议 而 是网络层 的控 制协议 。 RSVP 不携 带
应用数据。 图8-2 5 给 出 了在 路由器中实现 的IntServ 体 系 结 构 。

路 由 选 择 协 议

图8-25

lntServ 体 系 结 构 在 路 由 器 中 的 实 现

IntServ 体 系 结 构 分为 前 台 和后台 两个部 分。 前 台 部 分画 在下面， 包 括 两个功能 块， 即
分类器与 分组转 发 ， 分组的调度器。 每一 个进入路由器的分组 都要通过这两个功能块。 后台
部 分画 在上面（有 灰色阴 影 的部 分）， 包括 四个功能 块 和两个数据库 。 这四个功能 块 是：

•

路由选择协议 ， 负 责维持 路由选择 数据库 。 由 此可查找 出对应千每一 个目 的地址 和
每一 个 流的 下一 跳 地址。

•  RSVP 协 议 ， 为 每一 个 流预 留 必 要的资源 ， 并 不断 地更 新通信量控 制数据库 。
•  接纳控 制， 当一 个新的 流产 生 时， RSVP 就调 用接纳控 制功能块， 以 便 确定 是否 有

足 够 的资 源 可供 这个 流使 用。

•  397  •

． 管理代理， 用来修 改通信量控制数据库 和管理接纳 控制功能块 ， 包括 设置接纳 控制

策 略 。

综 合 服务I ntS erv 体系结构存在的主要问题是 ：
( 1) 状态信息的数量与流的数目 成正 比 。 例 如 ， 对于OC -4 8链路 C 2. 5 Gb it/ s) 上的主干
网路由 器， 通过 64 kbi t/ s的音频 流的数目 就超 过 39 000个。 如 果对数据率再 进行压 缩 ， 则流

的数目 就 更多。 因此在大 型 网络 中

， 按每个流进行资源预留会产 生 很 大的开销 。

( 2) I nt S erv 体系结构 复杂 。 若要得到有保证 的服务， 所有的路 由 器 都必须 装 有 RSVP、

接纳控制 、 分类器和调度器 。 这种路由器称 为RS VP路由器。 在应 用数据传送的路径 中 只要

一

有

个路由器不是 RSVP路由器， (cid:4821) 个的服务就 又变 为
( 3) 综 合 服务I ntS erv 所定义 的服务质量等级数量太 少 ， 不够灵活 。

“

”
尽最大 努力交付

了。

8.4.4  区 分服务 DiffServ

1 . 区分 服务的基本概念

由 于综 合 服务 I nt S er v和资源预留协议 RS VP 都较复杂 ， 很 难 在大 规模 的网络 中 实现，

因此IE T F 提出了

一

种(cid:4842)的策 略 ， 即区分 服务 DiffS erv (Diff erentiat ed  S erv ices)  [RFC  24 75 ]。

区 分服务有时也简写 为D S 。 因此， 具有区 分服务功能 的节 点就称 为D S 节 点。

区分服务D iffS erv 的要点如 下 ：

( 1) DiffS erv 力图不改变 网络的基 础 结构 ， 但在路由 器 中 增 加 区分 服务的功 能 。 因此，

D iffS erv 将IP 协议 中 原有 8位 的IPv4 的服务类 型 字段 和IPv 6的通信量类 字 段 重(cid:4842)定义 为

区分 服务 D S （如 图8-2 6所示）。 路由器根据 D S 字 段 的值来处 理分组的转 发。 因此， 利用

D S 字段的不同数值就可提供不 同等级的 服务质量。 根据互联网的建 议标准[RFC 24 74 ],  D S

字 段 现在只使用其 中 的前 6位 ， 即区分 服务码 点 D SCP(D iff erentiat ed  S er vices C od ePo int ),

再 后 面 的两位 目前不使用， 记为CU(C u rrently Un

u sed )。 因此由 D S 字段 的值所确 定的服务

质量实际 上就是由D S 字段 中 D SCP的值来确 定的。

位 0

5  6  7

I l

I  I | U I

I CP I
- os-

l

图 8-26

区 分服 务 码 点 DSCP 占 DS 字 段 的 前 6 位

在使用D S 字段之前， 互联网的ISP要和用户商 定

一

个服务等级 协定 SLA (S erv ice L ev el

A g reem ent )。 在 SLA

中 指明了被支 持 的服务类 别（可包括吞 吐量 、 分组丢失 率、 时延和时

延抖动 、 网络的可用性 等） 和每

一

类别所 容 许的通信量。

( 2) 网络被划分为许多 个 D S 域 (D S D omai n )。 一 个D S 域在

一

个管理实体 的控制下 实

现同样的区 分服务策 略 。 DiffS erv 将所有的复杂性放在 D S 域的边界节点 (b o u nda ry n o d e)中 ，

而使 D S 域内部 路 由 器工作得尽可能简单 。 边 界 节 点可以 是主机、 路由 器或防火墙 等。 为了

简单起见 ， 下 面 只讨 论边 界 节 点是 边 界 路由 器的情况（原理都是

一

样的）。 图 8-27给出了

D S 域、 边界路 由 器 (b o u nda ry ro ut er)和内部路 由 器 (i nt eri o r ro ut er)的示意图。 图 中 标有 B 的

路由 器都是边 界 路由 器。

•  39 8 •

-------------
DS 域

／

已;
＼心令、
才心 巴 巴 了广＼二三兰二

内 部路由器 )  B /

边界路由器

内 部且｀由器

）

DS 域

＼

图8-27 DS 域 、 边界路 由 器和 内 部路 由 器 的 示 意 图

(3) 边 界 路由器中的功能较多 ， 可 分为 分类器(classifier)和通信 量调节 器(conditioner) 两
大部 分 。 调 节器又 由标记器(marker) 、 整形 器(shaper)和测 定 器(meter) 三个部 分组成 。 分类器
根据分组 首部 中的一些字段 （ 如源 地址 、 目 的地址 、 源端 口 、 目 的端 口 或 分组 的标识等）对
分组 进行 分类， 然后 将 分组交 给标 记器。 标 记器根据分组 的 类别 设置 DS 字段 的值 。 以 后 在
分组 的转 发过程 中， 就根据DS 字段 的值使分组 得到相应 的服务。 测 定器根据事 先商 定的
SLA 不断 地测 定 分组 流的速率 （与事 前 商 定的数值 相比较 ）， 然后确定应采取 的行动 ， 例如，
可重 新打标 记或交 给整形 器进行 处 理 。 整 形 器中设有缓存 队列， 可以将 突 发的 分组 峰 值速率
平滑 为 较均 匀 的速率， 或 丢弃一 些 分组 。 在 分组 进入 内部 路由器后 ， 路由器就根据分组 的
DS 值进行 转 发。 图8-28 给 出了 边界 路由器中各 功能 块的关 系 。

、 、 、

r
、没穹＄
心二 蛔咖＇

`｀

11

“＿ －---·一

，
＇  卒芸沪
＇，＿－
！ ｀ 岫
、
、

了

边 界 路由器 ＼

、

、一＿

（ 入 口 ）

-----内 部路由器 - -
c_·--�--�--- ·'"···· ·

－

－＇，，＿

＇，边 界 路由器
( 出 口 ）

图8-28 边界路 由 器 中 的 各 功 能 块 的 关 系

(4) DiffServ 提供 了一种聚 合(aggregation) 功能。 DiffServ 不 是为 网 络中的每一 个 流维持
而 是把若干 个 流根据其 DS 值聚 合成少量的 流 。 路由器对相同
供转 发时使用的状 态信 息 ，
D S 值的 流 都按 相同的优先级进行转 发。 这就大 大简化 了网 络内部 的 路由器的转 发机制 。 区
分服务DiffServ 不需要使用RSVP 信 令 。

2. 每跳行为 PHB

DiffServ 定义 了在转 发 分组时体现服务水平 的每跳行为 PHB (Per-Hop  Behavior) 。 所谓
“ 行为 ” 就 是指 在转 发分组 时 路由器对分组 是怎 样处 理的 。 “ 行为 ＂ 的例子可以 是： “ 首先转
发这个分组 ” 或 “ 最后 丢弃这个分组 ” 。 “ 每跳 ” 是强 调 这里所说的行 为 只涉 及本 路由器转 发
的这一 跳 的行 为 ， 而 下一 个 路由器再怎 样处 理 则与本 路由器的处 理无 关 。 这和IntServ/RSVP
考虑 的服务质量 是“ 端 到端 ＂ 的很 不一 样。

IETF 的DiffServ 工 作 组 已经 定义 了 两种PHB , 即迅速转 发 PHB 和确保转 发 PHB 。
迅速转 发 PHB (Expedited  Forwarding  PHB)可记为 EF PHB , 或 EF [RFC  3246 , 建议标
。 EF 指明离开一 个 路由器的通信 量的数据率 必须等千或 大于 某一 数值。 因此EF PHB 用

准］

•  399 •

来构造 通过DS域 的一 个低丢 失 率、 低时延 、 低时延抖动 、 确保 带宽的端 到端 服务（即不排
队或 很少排队） 。 这种服务对端 点 来说像点对点 连接或 “ 虚拟租用 线 ” ， 又称为P remium（优
质） 服务 。 对应于 EF的区 分服务码 点 DSCP 的值 是101110 。

确保转 发 PHB (

A ssured Forw arding PHB )可记为 AFPHB 或 AF[RFC 25 97 , 建议 标 准］

AF用DSCP 的第 0~2位 把通信量划分为四个等级（分别 为 001, 010,  011 和100) ， 并 给每
一种等级提供最低数量的带宽和缓存空间 。 对于 其中的每一 个等级再用DSCP 的第 3~5 位
划分出三个 “ 丢 弃优先 级” （分别 为 010, 100 和110 , 从 最低丢弃优先 级到最高丢 弃优先 级） 。
当 发生 网络拥塞 时， 对千每一 个等级的 AF, 路由器就首先 把“ 丢弃优先 级” 较 高的 分组丢
弃 。

从 以上所述可看 出 ， 区 分服务D iffServ 比较灵 活 ， 因为它并 没有 定义特 定的服务或 服务

类 别 。 当 新的服务 类 别出 现而 旧 的服务 类 别 不再使用时， D iffServ 仍 然可以工作 。

本章的 重要概念

•  多媒体 信息 有两个重 要特 点： （1) 多媒体 信息 的信息 量往往 很大； （2) 在传输多媒

体 数据时， 对时延 和时延抖动 均有较 高的要求 。 在互联网上传输多媒体 数据时， 我
们 都是指含 有 “ 边 传输、 边播放 ” 的特 点 。

•  由多媒体 信息 构 成 的 分组在 发送时 是等时的 。 这些分组 在 到达接收端 时就 变成 为非
等时的 。 当接收端缓存 中的分组数达到一 定的数 量 后 ， 再以恒 定速率按顺序 将 这些
分组进行 还原播放 。 这样就产 生 了播放 时延 ， 同时也可以在很大程度上消 除 时延 的
抖动 。

•

•

•

在传送时延敏感 的实时数据时， 传输时延 和时延抖动 都必须受 到 限制 。 通常宁可丢
失少量分组， 也 不要接收太 晚 到达 的分组 。

目 前互联网提供的音频／视频服务有三 种 类型： （1) 流式存 储 音频／视频， 用户通过
互联网边 下载 、 边播放 。
发送 在接收 时也 是要求 能够 连续播 放 。
互联网 电视 会议 。
流媒体 ( streaming media)就是流式 音频／视频， 其特 点 是边 下载 、 边播放 。 若使用专
门的软件， 则可 将 其存 储 在硬盘 上成 为用户的文件 。

( 2) 流式 实况音频／视频， 其特 点 是在 发送方边 录 制、 边
(3) 交互式 音频／视频， 如互联网 电 话 或

•  媒 体 服务器（或称为 流式 服务器） 可以更好地支 持 流式 音频 和视频的传送 。 TCP
能够 保 证 流式 音频／视频 文件的播放 质量， 但开 始 播 放 的时间要比请求播放 的时间
滞 后一 些（ 必须先 在缓存 中存 储 一 定数量的 分组） 。 对千实时 流式 音频／视频文件的
传送则应当选 用UDP 。

•  实时 流式协议 R TSP 是为 了给 流式 过程 增 加更多 功能而 设计 的协议 。 R TSP 本 身 并
而 仅仅是使媒体播放 器能够 控 制多媒体 流的传送 。 R TSP 又称为 “ 互

不传送数据，
联网录 像机遥控协议 ” 。

•  狭 义 的 I P 电话 是指在 IP 网络上打 电话 。 广 义 的 IP 电话 则 不 仅是电话 通信，

而 且
还可以在 IP 网络上进行交互式多媒体 实时通信（包括话 音 、 视像等）， 甚至 还包括
即时传信 I M （如QQ 和Sk ype等） 。
IP 电 话 的通话 质量主要由两个因素 决 定： （1) 通话 双 方端 到端 的时延 和时延 抖
而 是取 决 千当 时 网
动 ； （2) 话 音 分组的丢 失 率。 但 这两个因素 都是不确定的，

•

•  400 •

。
