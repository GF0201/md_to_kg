06 09 0 1  03 06 0 1  02 0 1  07 0 1  00 --OBJECT IDENTIFIER类 型 ，长度 091 6 ,udplnDatagrams

05 00

--NULL类 型 ，长度 001 6

6. 8  应 用 进程跨越 网 络 的 通信

在 这 以 前 我 们 已 经 讨 论 了 互 联 网 使 用 的 几 种 常 用 的 应 用 层 协 议 ， 这 些 应 用 协 议 使 广 大

用 户 可 以 更 加方便地利 用 互 联 网 的 资 源 。
现在 的 问 题 是 ： 如 果 我们 还 有

一

直接使用 已经标准化 的 互联 网 应用 协 议 ， 那 么 我们 应 当 做 哪 些 工 作 ？ 要 回 答这个 问 题 ， 实 际

些 特 定 的 应 用 需 要 互 联 网 的 支 持 ， 但 这 些 应 用 又 不 能

一

一

上 就 是 要 了 解 下 面 要 介 绍 的 系统调 用 和 应 用 编程接 口 。 这些 问 题 需要
我 们 在 这 里 只 能给 出
些 初 步 的概念 。
6. 8.1  系 统调 用 和应用 编程接 口

门 专 门 的 课程来学 习 ，

大 多 数操 作 系 统 使 用 系统调用 (system call) 的 机 制 在 应 用 程 序 和 操 作 系 统之 间 传 递控制
般程序设计 中 的 函 数调 用 非 常 相 似 ， 只 是 系 统调 用 是 将控

权 。 对程序 员 来说 ， 系 统 调 用 和
制 权传 递给 了 操 作 系 统 。 图 6-26 说 明 了 多 个 应用 进程使用 系 统 调 用 的机制 。

一

．

间 中

在 用 户 地址 空
的 应 用 程序

由 应 用 程序 调 用 的 系 统 函 数

-— 系 统调用 接 口

间 中

包括 TCP/IP 协 议 软 件 的 操 作 系 统 内 核－－』 一－ 雷厂臣昙置

图 6-26多 个应用进程使用系 统 调 用的 机制

一

当 某 个 应 用 进 程 启 动 系 统 调 用 时 ， 控 制 权 就 从应 用 进 程 传 递 给 了 系 统 调 用 接 口 。 此接
口 再把控制权传递给计算机 的 操 作 系 统 。 操 作 系 统把这个调用 转给某个 内 部过程 ， 并执行所
请 求 的 操作 。 内 部过程
旦 执 行 完 毕 ， 控 制 权 就 又 通过 系 统 调 用 接 口 返 回 给应 用 进程 。 总 之 ，
只 要 应 用 进程 需 要从操作 系 统获 得 服务 ， 就要把控制 权传递给操 作 系 统 ， 操 作 系 统在 执 行 必
要 的 操 作 后 把控制 权返还给应 用 进程 。 因 此 ， 系 统 调 用 接 口 实 际 上就是应用 进程 的 控 制 权和
操 作 系 统 的控制权进行转换 的
些程序 ，
特 别 是 需 要 设 置 系 统 调 用 中 的 许 多 参 数 ， 因 此 这 种 系 统 调 用 接 口 又 称 为 应 用 编程接 口 API
(Application  Programming  Interface) 。 API 从程序设计 的 角 度 定 义 了 许 多 标 准 的 系 统 调 用 函 数 。
应 用 进程 只 要 使 用 标准 的 系 统调 用 函 数就 可 得 到 操 作 系 统 的 服务 。 因 此从程序设计 的 角 度 看 ，

个接 口 。 由 于 应 用 程序在使 用 系 统调 用 之前 要 编 写

一

一

也 可 以 把 API 看成是应 用 程序 和 操 作 系 统之 间 的 接 口 。

现 在 TCP/IP 协议软件 已 驻 留 在操 作 系 统 中 。 由 于 TCP/IP 协议族被设计成能运行 在 多
种操作 系 统 的 环 境 中 ， 因 此 TCP/I P 标 准 没 有规 定 应 用 程 序 与 TCP/IP 协议软 件 如 何接 口 的 细
节 ， 而 是 允 许 系 统 设 计 者 能 够选择有关 API 的 具 体 实 现细节 。 目 前 ， 只 有 几 种 可 供应 用 程
序使用 TCP/IP 的 应 用 编程接 口 API 。 这里最著 名 的 就 是 美 国 加 利 福 尼 亚 大 学伯 克利 分校为
种 API ， 它 又称 为套接字接 口 (socket interface) （ 或插 口 接
Berkeley  UNIX 操 作 系 统定 义 的
口 ） 。 微 软 公 司 在 其 操 作 系 统 中 采 用 了 套接字接 口 API , 形成 了

个 稍 有 不 同 的 API ， 并 称

一

一

•  3 1 6  •

Windows Socket ,

WinSock

AT&T

UNIX

V

一

API ,

。

为 其

系 统

定 义 了

种

简 写 为

TLI (Transport Layer Interface)
之 为
简 称 为
。

一

我们 知 道 ， 若 要 让 计 算 机 做 某 件 事 情 ， 就要 编 写 使 计 算 机 能 理解 的 程 序 。 在 网 络 环 境
一

一

下 的 计 算机应用 都 有

个共 同 特 点 ， 这就是 ： 位 千 不 同 地 点 的 计算机要通过 网 络进行通信 。

一
种 角 度 看 ， 计算机之 间 的 通信 就是本计算机要读取另

从 另
者要把数据从本计算机 写 入 到 另
用 到 上面所说 的 系 统调 用 。

个地 点 的 计算机 中 。 这种

“

“

“

＂

个 地 点 的 计 算机 中 的 数据 ， 或
的 过程都要
写 入
读取

和

6-27

一

UDP
这

在 讨 论 网 络编 程 时 常 常把套接字作 为应用 进程和运输层 协 议 之 间 的 接 口 ， 图
概 念 。 图 中 假 定 了 运输层使用
协议 （ 若使 用
协议 ， 情 况 也 是 类似 的 ， 只 是
是无连接 的 。 通信 的 两端 仍 然可 用 两个套接字来标 志 ） 。 现在套接字 已成为计算机操作

表 示

一

TCP

UDP

系 统 内 核 的

部 分 。

由

用应
控}

程
制}

一

-

}

－

；

­

一

由

操

作

麟

-

-

-

-

}-

序

＾
门
 丿

五

系

－

－

－

－

－

客 户

服 务 器

图 6-27 套接字成为应用 进 程 与 运输层 协 议 的 接 口

请 注 意 ： 在 套 接 字 以 上 的 进 程 是 受 应 用 程 序 控 制 的 ， 而 在 套接 字 以 下 的 运 输 层 协 议 软
协议进行通信 ， 它 就 必

件则 是 受计算机操作 系 统 的控制 。 因 此 ， 只 要应 用 程序使用

TCP/IP

须通过套接字 与 操作 系 统交 互 （ 这 就要使用 系 统 调 用 函 数 ） 并请求其服务 。 我们 应 当 注 意 到 ，
应 用 程序 的 开 发者 对套接字 以 上 的 应 用 进程 具 有完 全 的 控制 ， 但对 套接字 以 下 的运输层 却 只
有 很 少 的控制 ， 例 如 ， 可 以 选择运输层协议
些运输层 的 参 数 （ 如 最
socket

大 缓存 空 间 和 最 大 报 文 长 度 等 ） 。

UDP )

( TCP

以 及

或

一

一

＂

“

当 应 用 进程 （ 客 户 或 服 务 器 ） 需 要 使 用 网 络进行通信 时 ， 必 须 首 先 发 出

系 统调

一
用 ， 请求操作 系 统 为其创 建
信 所 需 要 的
作 系 统 为这些 资源 的 总 和 用

套接字
些 系 统 资 源 （ 存 储 器 空 间 、

个

一

CPU

。 这个 调 用 的 实 际 效 果 是请 求操 作 系 统把 网 络 通
时 间 、 网 络 带 宽 等 ） 分 配 给 该应 用 进程 。 操

(socket descriptor)

的 号 码 （ 小 的 整 数 ） 来
表 示 ， 然后 把这个套接字描述符 返 回 给应用 进程 。 此后 ， 应 用 进程所进行 的 网 络操 作 （ 建立

个 叫 作 套接字描述符

连接 、 收 发 数据 、 调 整 网 络通 信 参 数 等 ） 都 必 须 使 用 这个套接字描述符 。 所 以 ， 几乎所有 的
个 参 数 。 在 处 理 系 统调
网 络 系 统调 用 都把这个套接字描述符作为套接字 的 许 多 参数 中 的 第
close
用 的 时 候 ， 通过套接字描述符 ， 操 作 系 统 就 可 以 识 别 出 应该使用 哪 些 资 源来完成应用 进程所
请求 的 服 务 。 通 信 完 毕 后 ， 应 用 进程通过
系 统 调 用 通知操作 系 统 回
收 与 该 套接字描述符相 关 的 所 有 资源 。 由 此可见 ， 套接字是应用 进程为 了 获得 网 络通信服务

个 关 闭 套接 字 的

一

一

一

而 与 操 作 系 统进 行 交 互 时使用 的

6-28

socket
种机制 。

一

图

给 出 了 当 应 用 进程 发 出

系 统调 用 时 ， 操 作 系 统所创 建 的 套接字描述符与

一

一

套接字数据 结 构 的 关 系 。 由 千 在

个进程 中 可 能 同 时 出 现 多 个套接字 ， 因 此 需 要 有

个存放

套接字描述符 的 表 ， 而 每

个套接字描述符有

个 指 针 指 向 存放套接字 的 地址 。 在套接字 的
•  3 1 7  •

一

数据结构中有许多参数要填写。 图 6-28 中 已填 写 好的参数是协议 族 (PF _INE T

, 表示使用
Int ernet 的 TC P/ IP 协议 族） 和服务 (SOC K_ST RE AM , 表示使用流 式服务， 也 就是使用

TC P 服务）。 在 刚 刚创 建
本地和远地端 口 ） 都是未填写的， 因此它和任何机器中 的应用进 程 暂 时都还没有联系。

个新的套接 字 时， 有 灰色背 景的 四个项目 （ 本地和远地 IP 地址，

一

操 作 系 统

套接字 的 数据 结 构

一

（ 每

0 :
1 :
2 :
3 :
4 :

一
套接字 描 述 符 表
个进程

个 描 述 符 表 ）

＿ -
-
-
-
． ． ．

图 6-28 调 用 socket 创 建套接字

一

一

这里要特别强调

个名词 soc ket 可 表
下 ， 在第5 章 5 .3.2 节的最后， 我们曾指出， 同
示多种不 同的意思。 在本 节 讨论 s oc ket 系统调 用 时， 套接字 s oc ket 已不仅仅是 RFC 793 所
定义的如公式(5 -1 )所示的那样， 而是如图6-28 右 边所示的套接字的数据结构。

6. 8.2  几 种 常 用 的 系 统调 用

下 面我们以使用 TC P 的服务 为 例介绍 几种常用的系统调用。

1. 连接建立阶段

当 套接字被创 建后， 它的端 口 号 和 IP 地址都是空 的， 因此应用进程要调用 b i n d （ 绑
定） 来指明套接字的本地地址 （ 本地端 口 号和本地 IP 地址）。 在服 务器端调用 b i n d 时就是
把熟知端 口 号和本地 IP 地址填写 到 己创 建的套接字中。 这 就叫作把本地地址绑定到套接字。
在客户端也可以不调用 b i n d, 这 时 由 操 作系统内核自动分配

个动态端 口 号（通信结束 后

一

由 系统收回）。

服 务器在调用 b i n d 后， 还必须调用 l i s t e n （ 收 听） 把套接字 设置为被动方式， 以便

随 时接 受客户的服务请求。 UDP 服 务器 由 千只提供无连接服务， 不使用 l i s t e n 系统调用。

服务 器 紧接着就 调 用 a c c ep t （ 接受）， 以便把远地客户进程发来的连接请求提取出来。
一

一

系统调用 a c c e p t 的

个变量就是要指明是从哪

个 套接字发起的连接。
一

调 用 a c c ept 要完成的动作较多。 这是因为

个服务器必须能够同时处理多个连接。

这 样的服务器常称为并发 方式(c oncu rrent )工 作的服务器。 可以有多种方法实现这 种并发方式。
图6- 29 所示的是

种实现方法。

一

主 服务器进程 M （ 就是通常所 说的服务器进程 ）

一

调用 a c c e p t , 就为每

一

个新的连

接请求创 建

一

个新的套接字， 并把这个新创建的套接字的标识符返回给发起连接的客户方。

与此 同 时， 主服务器进程还要 创 建

一

个从属 服务器进程（如 图 6 -29 中的S 1 ) 来处理新建立

的连接。 这 样， 从属服 务器进程用这个新创 建的套接字和客户进程建立连接， 而 主服务器进

• 31 8  •

程用原来的套接字重新调用 a c c ep t , 继 续接受下

一

个连接请求 。 在已建 立的连接上， 从属

服务器进程就使用这个新创 建的套接字传送和接收数据 。 数据通信结束 后， 从属 服务器进程

就关 闭这个新创 建的套接字， 同时这个从属 服务器 也 被撤销 。

主 服 务器进程
、
、
、 、
、
、
、 、
、 、
、 、

、

、

、、

、 、

、、

、 、 、

、 、 、 、

、 、
、 、 、

、
、 、 、 、
、 从 属 服 务 器 进程
、 、 、
、

~、:\＼｀

、

-—＿ 服 务 器

应 用 进程

连接
套接字
—

连接
套接字

连接
套接字
—一贮

一

- （ 新 创 建 的 套接字 ）

图 6-29 并 发 方 式 工 作 的 服 务 器

--- 操 作 系 统

总之， 在 任

一

时刻， 服务器中总是有

一

个主服务 器进程和零 个或 多 个从属 服务器进程 。

主服务 器进程用 原来的套接字接受连接请 求， 而从属 服务器进程用新创 建的 套接字 （ 在 图

6 - 29 中注明是

“
连接套接字

”

) 和相应的客户建立连接 并 可进行 双向传送数据 。

以上 介 绍的是服务器为了接受客户端发起的连接请 求而进行的

一

些 系统 调 用 。 现在看

一

下客户端 的情况 。 当使用TCP 协议的客户已经调用 s o c ke t 创 建了 套接字后， 客户进程

就 调用 c o n n e c t , 以便和远地服务器建立连接（这就是主动打开， 相当于客户发出的连接

请求 ） 。 在 c o n n e c t 系统调用中， 客户必须指明远地端点（即远地服务器的IP 地址和端 口

号 ） 。

2 . 数据传送阶段

客户和服务器都在TCP连接上使用 s e n d 系统 调 用传送数据， 使用 r e c v 系统调用接

收数据 。 通常客户使用 s e n d 发送请求， 而服务器使用 s e n d 发送回答 。 服务器使用 r e cv

接收客户用 s e n d 调用发送的请求 。 客户在发完请求后用 r e cv 接收回答。

调用 s e n d 需要三个变量 ： 数据要发往的套接字的描述符、 要发送的数据的地址以及数

据的长度 。 通常 s e n d 调用把数据复制到操作系统内核的缓存中 。 若 系统的缓存已满， s e n d

就 暂时 阻 塞，直到缓存有空间存放新的数据 。

调用 r e cv也需要三 个 变量 ： 要使用的套接字的描 述 符、 缓存的地址以及 缓存 空间的长

度 。

3. 连接释放阶段

一

旦客户或服务器结束 使用套接字， 就把套接字撤 销 。 这 时就 调用 c l o s e 释 放连接和

撤 销 套接字 。

图6 -30 画出了上述的

一

些 系 统调用的使用顺序 。 有些系统调用在

一

个TCP连接中可能

会循环使用 。

• 319  •

客户 端

服 务 器 端

s o c ke t

i b i nd

s o c ke 七

it e n

i
i

连接 建立 请求

conne c t - - - - - - -=

i
-－－－－－－－－-－－－－－－－－－-－一气卢
-:I

二 ::c----------
------
------------------

i ◄--－ － － － － － －－ －－ － － － － － －－－ － － － － －－－-－ － － － － －－

recv

s e nd

c l o s e

c l j s e

图 6-30 系 统 调 用 使 用 顺序 的 例 子

UDP 服务器 由千 只 提供无连接服务， 因此不使用 l i s 七 e n 和 a c c e p t 系统调用。

6 . 9   P2P 应 用

我们在第1 章的 1.3.1 节 中已经简单地介绍了P 2P 应用的概念。 现在我们将进

一

步 讨论

P 2P 应用的若 干 工 作 原 理。

P 2P 应用就是指具有P 2P 体系结构的网络应用。 所谓P2P 体系结构就是在这样的网络

应 用 中 ， 没有（或只有极少数的） 固 定的服务器， 而 绝大 多 数的交互 都 是 使用对等方式

(P 2P方式） 进行的。

P2P 应用的范 围很广， 例如， 文件分发、 实时音频或视 频会议、 数据库系统、 网络服务

支持（如P 2P 打车软件、 P 2P 理 财等）。 限于篇 幅， 下 面只介绍 最常用的P 2P 文件分发的工

作原理。

P 2P 文件分发不需要使用 集 中 式的媒体服务器， 而所有的音频／视频文件都是在普通的

互联网用户之间传 输的。 这其实 是相当于有很多（有时达到上 百 万个 ） 分散在 各地的媒体服

务器（ 由 普通用户的计算机充当这种媒体服务器） 向其他用户提 供所要下 载的音 频／视频文

件。 这种P 2P 文件分发方式解决了 集中式媒体服务器可能出现的瓶颈问题。

目前在互联网流量 中， P2P 工 作方式下的文件分发已 占据了最大的份 额， 比 万维网应用

所 占的比例大得多。 因此单纯从流量的角度看， P 2P 文件分发应当是互联网上最重要的应用。

现在P 2P 文件分发不仅传送音频文件M P3 , 而且还传送视频文件 (10 ~ 1000 M B , 或更大） 、

各种软件和图像文件。

6.9.1  具 有 集 中 目 录服务器 的 P2P 工作 方 式

最早使用P 2P 工作方式的是N ap s ter。 这 个名称来自19 9 9年美国东 北大学的新生 Sh aw n
个叫作 N ap s ter 的软件。 利用这个软件就可通过互联网免 费 下 载各种MP 3

F anni n g 所写的

一

• 320  •

