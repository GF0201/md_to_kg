组成 员 关 系 报 文

| ___＿_

_

MLD 协 议

~' 」、 l4」 .

- .L Ll

ND 协 议

关千 IC MPv6 的进一 步 讨 论可参 阅 [FO RO I O] ， 这 里从略。

图4-3 8

ICMPv6 报 文的分类

4 . 6   互联 网 的 路 由 选择协议

本(cid:7188)将 讨 论 几种常用的路由选 择 协 议 ， 也就是 要 讨 论转发表中的路由是 怎样得出的。

按照4 .1 . 2(cid:7188)所 述的观点 ， 路由选 择 协 议 属 于 网络 层 控制层 面的 内 容。 不过本(cid:7188)仍然 按传统

的思路进行讨 论 ， 也就是 说 ， 路由选 择 协 议规定 了互(cid:7110) 网中有关的路由器应如何相 互交换信

息并生成出路由表。

4.6. 1  有关路 由 选择 协 议 的 几 个基本概念

1 . 理想 的 路 由 算法

路由选 择 协 议的核 心 就是 路由算法 ， 即 需要 何种算法来 获得路由表中的各 项目。 一个

理想的路由算法应具有如下的一 些特 点[BELL86] :

(1 ) 算 法 必 须 是 正 确 的 和 完 整 的 。 这 里 ， “ 正 确 ＂

的含 义 是 ： 沿 着 各 路由表所 指 引 的路

由 ， 分组一定(cid:7126)够最终到达目的网络和目的主机。

( 2) 算法在计算上应 简 单。 路由选择的计算不应使网络 通信 量 增加太多的额外开销。

(3) 算 法 应 (cid:7129) 适 应通信量和 网络拓扑 的 变 化 ， 这 就是说 ， 要有 (cid:7152) 适应 性。 当网络中的通

信 量发生变化 时， 算法(cid:7126)(cid:7149)适应地改变路由以均衡 各 链路的 负 载。 当某个或某些(cid:7188)点、 链路

发生 故 障不(cid:7126)工作 ， 或者 修理好了再投入运行时， 算法也(cid:7126)及时地改变路由。 有时称这种(cid:7149)
适应性为 ＂

稳健性 ”

(robus tne s

)。 3

(4 ) 算法应 具有稳定性 。 在网络 通信 量和网络 拓 扑相对稳定 的情况下 ， 路由算法应收敛

于 一个可以接受的解 ， 而不应使得出的路由不停地变化 。

( 5 ) 算 法 应 是 公 平 的 。 路由选择算法应对所有用户 （ 除对少数优 先级高的用户 ） 都是 平
等的。 例如， 若仅仅使某 一对用户 的端到 端时延 为最小 ， 但 却 不考 虑 其 他的广大用户 ， 这 就
明显地不符合 公平性的要求。

而网络的吞 吐 量最大。 虽 然 我们希 望得到

( 6 ) 算法 应 是最 佳 的 。 路由选择算法应当(cid:7126)够找出最好的路由 ， 使得分组平均时延最小
最佳 ＂ 的算法， 但 这 并不总是最重要的。 对于 某
些 网络 ， 网络的可 靠 性 有时要比最小 的分组平均时延 或 最大 吞 吐 量更加重要。 因此 ， 所 谓

“

“

“ 最 佳

只 (cid:7129) 是相对于某一种特定要求 下 得 出 的 较 为 合理的 选择而 已。

一个实 际的路由选择算法 ， 应尽可(cid:7126)接近 于 理想 的算法。 在不 同 的应用条件 下 ， 对以

CD 注 ： robustness 一 词 在 自 动 控 制 界 的 标 准 译 名 是

“

鲁 棒 性

”

， 但在 [MlNGCI94] 则 译 为

＂

稳健性

”

。

•  1 57  •

s
上 提 出 的 6 个方面也可有 不 同的侧 重 。

应 当 指 出 ， 路 由 选 择 是 个 非 常 复 杂 的 问 题 ， 因 为 它 是 网络 中 的所有(cid:7188) 点 共 同 协 调 工 作

的结 果 。 其次， 路由选 择的环境往往 是 不 断 变 化的， 而 这 种 变 化 有 时无法事 先 知 道， 例 如 ，

网 络 中 出 了 某些 故 障 。 此外， 当 网络发生拥 塞 时， 就特 别 需 要 有(cid:7126)缓解这种拥 塞的路由选择

策略， 但恰好 在 这种条件 下 ， 很 难 从网络 中 的各(cid:7188)点 获 得所 需 的 路 由 选择信 息 。

倘 若 从路 由 算法(cid:7126) 否 随 网络的通 信 量或 拓 扑 (cid:7153) 适 应 地进行 调 整 变 化 来 划 分， 则 只有两

大类， 即 静态 路 由 选择策略与动 态 路 由 选择策略。 静 态 路由选择也叫 作 非 (cid:7152) 适 应 路 由 选择，

其特 点 是 简 单和开 销 较小， 但不(cid:7126)及 时适应 网 络状 态的变化 。 对 千 很 简 单的小 网络， 完 全可
以采用 静 态路 由 选择， 用 人工配置每 一 条路由。 动 态 路 由 选 择也叫作 (cid:7152) 适 应路 由 选择， 其特

点是(cid:7126)较 好地适应网络状态的变化， 但 实 现起来较 为 复 杂 ， 开销也比较大。 因 此， 动 态 路由

选 择适 用 千 较 复杂的大网 络。

2 . 分层 次 的 路 由 选择协议

互 (cid:7112) 网 采 用 的路由选 择 协 议 主 要 是 (cid:7154) 适应的（即 动 态 的 ） 、 分布 式路 由 选 择 协 议。 由千

以下 两 个 原 因 ， 互 (cid:7113) 网 采 用 分层次的路 由 选择协议：

(

1 ) 互 (cid:7110) 网的规模 非 常 大。 如果 让 所有的路由器 知 道所 有 的网 络应怎样到达， 则 这种路

由表将 非 常大， 处理起来 也太花时间。 而所有这 些 路 由 器之间交 换 路由信 息 所 需的带 宽 就会

使互(cid:7110)网的通信 链路饱和。

( 2) 许多单位不愿 意外 界 了 解 (cid:7155) 己 单位网络的布 局细(cid:7188)和本部 门所 采 用 的路由选 择 协 议

（ 这属千本部 门 内 部的事 情 ）， 但 同 时 还 希 望连接到 互 (cid:7114) 网上。

为此， 可 以把整 个 互 (cid:7115) 网 划 分为许多较 小 的 (cid:7152) 治系统( autonomous

s ys te m) ， 一 (cid:7182)都记为
AS。 (cid:7149)治系统 AS 是在单一技术管理下的许多网络 、 I P 地址以及路由器， 而这些路由器使用
一种 (cid:7151) 治系统 内 部的路由选择协议和共 同的度量。 每一个 AS 对其他AS 表现出的是 一个单一
的 和一(cid:7174) 的 路 由 选择策略[RFC 4271 ]。 这样， 互 (cid:7110) 网 就把路由选择协议划分为两大类， 即 ：

(

1 ) 内 部 网 关协议 IGP (I nte rior Gate way Protocol)  即 在一 个 (cid:7151) 治 系 统 内 部使用 的路由
选 择 协 议， 而这与在互(cid:7110)网中的其他 (cid:7151) 治系统选 用 什么路由选择 协 议 无 关 。 目前这类路由选

择 协 议 使用 得最多的是 RI P 和 OSPF 协 议 (I S-I S 协 议也很流行， 但不介 绍了）。

( 2) 外部 网 关协议 EGP ( Exte rnal  Gate way  Protocol)

若源主机和目的主机处在不 同 的

(cid:7151) 治系统 中 （ 这 两个 (cid:7151) 治系统可(cid:7126)使用 不 同 的 内 部 网 关 协议）， 那么在不 同 (cid:7156) 治 系 统 AS 之

间的路由选 择， 就 需要 使 用 外 部网关协议 EGP。 目前使用 最多的外 部网 关 协 议是 B GP 的版

本4 ( BGP-4 ) 。

(cid:7157) 治系统 之间的路 由 选择也叫作域 间 路 由 选择( inte rdomain routing)， 而在(cid:7150) 治系统 内 部

的路由选择叫作 域 内 路 由 选择( intradomain routing)。

图 4 -39 是 两个 (cid:7151) 治系统 互 连在 一起的示 意图。 每个 (cid:7151) 治系统(cid:7149) 己决定在本 (cid:7151) 治系统 内
部运行哪 一 个 内 部路由选 择 协 议（ 例 如， 可以是 RI P, 也可以是 OSPF ) 。 但每个 (cid:7151) 治系统都
有一 个或多个路由器（ 图中的路由器 R ] 和 R2 ) 除运行本系统的 内 部路由选择 协 议外， 还要

运行 (cid:7151) 治系统间的路由选 择 协 议 ( BGP-4 ) 。

• 158 •

自 治 系 统 A

用 外 部 网 关 协 议
上 ＂ （ 例 如 ， BGP-4 )

、

用 内 部网关协议 -已

三气二一

，

自 治 系 统 B

R J
一
-已
＼二二

用 内 部网关协议

）

图 4-39 (cid:7158) 治 系 统 和 内 部 网 关协 议 、 外 部 网 关协议

这里我们要指出两点：

(1 ) 互 (cid:7110) 网的早 期 RFC 文 档中未使用

这 一 名 词。 但是 在
后 来 的 RFC 文 档 中 又 改用 “ 路由器 ” 这 一 名 词 ， 因此有的书把原 来 的I GP和 EGP分 别 改为
I RP（ 内 部路由器协议） 和 E RP（ 外部路由器协议）。 为了方便读者 查 阅 RFC 文 档 ， 本 书 仍
使用 RFC 原 先使用的名 字I GP和 EGP。

而是 使用

路由器

网关

“

”

“

”

( 2)  RFC 采用的名 词I GP和 EGP是协议 类别的名 称。 但 RFC 在使用 名 词 EGP时出现了
一 点 混乱 ， 因 为最早的一个外部网关协议的协议名 字正好也是 EGP[ RFC  8 27]。 后 来 发现该
RFC 提出的 EGP有不少缺点， 就设计了一种更好的外部网关协 议 ， 叫作边 界 网 关协议 BGP
( Borde r  Gate way Protocol) ， 用来 取代 旧 的 RFC 8 27 外部网 关 协 议 EGP。 实 际上 ， 旧 协 议
EGP和新协 议 BGP都属于外部网关协议 EGP这 一类别。 因此在遇到 名 词 EGP时， 应 弄 清
它是指 旧 协议 EGP（即 RFC 8 27) 还是指外部网 关 协 议 EGP这个类别。

总 之 ， 使用分层次的路由选择方法， 可将 互 (cid:7110) 网 的路由选 择 协 议 划 分为：
•  内 部 网 关协议I GP: 具 体的协 议有多种 ， 如 RIP和 OSPF 等。
•  外 部 网 关协议 EGP: 目前使用的协议是 B GP-4。
对千比较大的 (cid:7159) 治 系 统 ， 还可将 所有的网络 再进行 一 次 划 分。 例如 ， 可以构筑 一个链
路速率较高的主干 网和许多速率较低的 区 域 网 。 每个区 域 网 通过路由器连接到主干网。 当在
一个 区 域 内 找不到目的站时， 就通过路由器经过主干 网到达另 一个 区 域网 ， 或者 通过边界路
由器到 别的 (cid:7151) 治 系 统中去查找。 下 面对这 两类协 议 分 别 进行 介 绍。

4 . 6 . 2

RIP

内 部 网 关协 议
1 . 协议 R I P 的 工作原理

RIP ( Routing I nformation Protocol )是 内 部网关协 议I GP中最先得到广泛
使用的协 议[ RFC 10 58] ， 它的中文 译 名 是 路由信 息 协 议。 RIP是 一种分布 式
的基千距 离 向 量 的 路 由 选择协议 ， 是 互(cid:7110)网的标准 协 议 ， 其最大优 点就是简单。

视频讲解

RIP 协 议要求网络中的每一个路由器都要维护从它 (cid:7151) 已到 其他每一个目的网络的距离记

录 （ 因此， 这是一组距 离 ， 即

“ 距 离 向 量

” )。 协 议 RIP将 ＂ 距 离

“

定 义 如下：

从一路 由 器到直接连接的网络的距 离 定 义为 1 。 从 一主机到非直接连接的网络的距 离 定
义 为所经过的路由器数加 l 。 “ 加1 " 是 因 为到达目的 网络后 就进行直接交付（不 需要再经过
路 由 器） ， 而到 直接连接的网络的距 离 已经定 义为1 。
“ CD

协议 RIP的 ＂

距离

也称为 “

跳数

” ( hop count) ， 并且每经过一个网络 ， 跳数就加 l 。
“ 距离短 "。 RIP允许一条路径最多只(cid:7130)包 含1 5

RIP认为好的路由就是它通过的网络数 目少， 即

个网络。 因此

“

距离

”

等千1 6 时即相当千不可达。 可见 RIP 只适用千小型互(cid:7116)网。

G) 汀 ： 这 里 旧

距 院

实 际 」 指 的 是

最 短 距 离

， 但 为 方 便 起 见 任 行 省 略

＂

”

“

”

“

＂

最 短

习 字 。

• 1 59  •

例如在前面的图4- 7中， 主机 几 经过 5个路由器连接到 另 一个主机 H2, 中间经过了 6
个网 络或经过 6 跳。或者说 ， 凡 到 儿 的距 离是 6。 在 图中并没有画出网络。 在 讨 论路由选
择问题时， 在主机和路由器之间或在路由器之间的网络 ， 往往都用一条线段来 表示。 需要注
意的是 ， 到直接 连接的网络的距 离也可定义为0 。 但这 两种不 同的定义对实 现 协 议 RIP并无
影 响 ， 因为这对选择最佳路由的过程其实是 一样的。

RIP不(cid:7126)在两个 网 络 之间同 时使用多条路由。 RIP选择 一条具有最少 网络数的路由（即

最短路由） ， 哪 怕 还存在另 一条高速（ 低时延 ） 但网络数较 多 的路由 。

本(cid:7188)讨 论的 RIP协议和下一(cid:7188)要讨 论的 OSPF 协 议 ， 都是分布 式路由选 择 协 议 。 它们的
共 同 特点就是每一个路由器都要不断地和其他一 些路由器 交换路由信 息 。 我们一定要弄 清以
下三个要点 ， 即 和 哪些 路 由 器 交 换信息 ？ 交换什么信息 ？ 在什么时候交换信息 ？

协 议 RIP的特点是 ：
(1 ) 仅 和 相 邻路 由 器 交换信息。 如果两个路由器之间的通信不需要经过另 一个路由器 ，

那 么 这 两个路由器就是相 邻的。 协议 RIP规定， 不相 邻的路由器不交换 信 息 。

(2 ) 路 由 器 交换的信 息是 当 前本 路 由 器 所 知 道 的 全部信息 ， 即 (cid:7152) 己 现在 的 路 由 表。 也就
“ 我到本 (cid:7151) 治系统中所有网 络的（ 最短 ） 距 离 ， 以及到 每个网络应经

是 说 ， 交换的信 息是：
”。
过的下 一跳路由器

(3) 按 固 定 的 时 间 间 隔 交 换路由信 息 ， 例如 ， 每隔 30 秒。 然后路由器根据收到的路由
信 息 更 新路 由 表。 当网 络 拓 扑发生变化 时， 路由器也及时向相 邻路由器通告 拓 扑 变化后的路

由 信 息 。 网 络中的主机虽 然 也运行协 议 RIP, 但只被动地接收路由器发来 的路由信 息 。

这 里要 强 调 一点： 路由器 在刚 刚 开始 工作 时 ， 它的路由表是 空 的。 然后路由器就得出
到 直接相 连的几个网络的距 离 （ 这 些 距 离定 义 为 1)。 接 着 ， 每一个路由器也只和数 目 非 常
有 限 的相 邻 路由器交换并更新路由信 息 。 但经过 若 干次的更 新后 ， 所有的路由器最终都会知
道到达本(cid:7149)治系统中任何 一个网络的最短距 离和下一 跳路由器的地址。

”

看起来 协 议 RIP有些 奇怪 ， 因 为 “

然 而 事 实 证明 ， 通过这样的方式

我的路由表中的信 息要依 赖千你的 ， 而你的信 息 又
“ 我 告 诉 别 人一 些 信 息 ， 而别人又告诉
依 赖于我的 。
我 一 些 信 息 。 我 再把我 知 道的更新后的信 息告诉 别 人 ， 别 人也这 样把更 新后的信 息 再告 诉
” ， 最后在 (cid:7151) 治系统中所有的(cid:7188) 点 都得 到 了 正 确 的路由选 择 信 息 。 在 一 (cid:7182)情况下 ， 协 议
我
就是 在 (cid:7151) 治系统中所有 的(cid:7188)点都得到 正 确的路由
RIP 可以收敛 ， 并且过程也较 快。 “收敛

”

选 择 信 息的过程。

路由表中最主要的信 息就是 ： 到 某个网络的距 离 （即 最短距 离 ） ， 以及应经过的下 一 跳
地址。 路由表更新的原则是找出到每个目的网络的最短距离。 这种更 新 算法又称为距 离 向 量
算法。 下面就是协议 RIP使用的距 离向量算法。

2 距 离 向 量算法

对每一个 相 邻 路 由 器发送过来 的 RI P 报文 ， 执行以下步骤：
1 ) 对地址为 X 的相 邻 路由器发来 的 RIP报 文 ， 先修 改此报 文中的所有项 目 ： 把 “

(

下 一
＂ 距 离 ” 字 段的值加1 （ 见后面的解 释 l)。 每一个

跳 ” 字 段中的地址都改为 X , 并把所有的
项目都有三个关键数据 ， 即： 到目的 网 络 N e t, 距 离是 d , 下一 跳路由器是 X。

(2

) 对修 改后的 RIP报文中的每一个项目 ， 进行以下 步 骤：

若原 来 的路由表中没有目的网络 N et , 则把 该项 目 添加到路由表中（见解释 2)。

否则（即在路由表中有目的网络 N e t, 这 时就再查看下一 跳路由器地址）。

•  1 60

•

若下一 跳路由器地址是 X, 则把收到的项目 替 换 原路由表中的项目（ 见解释3) 。
否则（即 这个项目是 ： 到目的网络 N et, 但下 一 跳路由器不是 X) 。

若收到的项目中的距 离 d 小千路由表中的距 离 ， 则进行更新（见解释4),

否则什么也不做（见解释 5)。

(3)若3 分钟还没有收到 相 邻路由器的更新路由表 ， 则把此相 邻路由器记为不可达的路

由器， 即 把距 离 置为1 6（ 距 离 为1 6 表示 不可达）。

(4 ) 返回 。

上面给出的距 离向量算法的基础就是 Bellman-Ford 算法（或 Ford-Fulkers on 算法） 。 这

种算法的要点是 这样的：

设 X 是(cid:7188)点A 到 B 的最短路径上的一个(cid:7188)点。若把路径A- B 拆成两段路径A- X 和

X - B ， 则每一 段路径A- X 和 X - B 也都分别是(cid:7188)点A 到 X 和(cid:7188)点 X 到 B 的最短路径。

下面是对上述距 离向量算法的五点解 释 。

解释 1 : 这样做是 为了便于进行本路由表的更新 。 假设从位千地址 X 的相邻路由器发来
的 RIP报 文的某一个项目是 ： “ N et 2,3,  Y "， 意 思是 “ 我经过路由器 Y 到 网络 N et 2的距 离是
3 "' 那么本路由器就可推断出： “ 我经过 X 到 网络 N et 2的距 离 应为3 + 1  = 4 "。 千是 ， 本路
由器就把收到的 RIP报文的这 一个项目修 改为 " N et 2, 4 ,  X ", 作为下一 步和路由表中原有项
目进行比较时使用（ 只有比较后才(cid:7126)知道是 否需要更新） 。 读者 可注 意 到 ， 收到的项目中的
Y 对本路由器是 没有用的， 因为 Y 不是本路由器的下一 跳路由器地址 。

解释 2 : 表明这 是新的目的网络， 应当加入到路由表中 。 例如， 本路由表中没有到目的

网络 N et 2的路由， 那么在路由表中就要加入新的项目 “ N et 2,4, X ”

。

解释 3 : 为什么要 替 换 呢 ？ 因为这 是 最新的消 息 ， 要以最新的消 息 为准 。 到目的网络的
距 离有可(cid:7126)增大或 减 小 ， 但 也可 (cid:7130) 没有改变 。 例如 ， 不管 原 来 路由表中的项目是 “ N et 2, 3,
X " 还是 “ N et 2, 5,  X " ， 都要更新为现在的 " N et 2,4, X ”

。

解释 4 : 例如， 若路由表中 已有项目 “ N et 2, 5, P ", 就要更新为 “ N et 2,4 ,  X ”

。 因 为到 网

络 N et 2的距离 原 来 是 5, 现在减到4, 更短了。

解释 5 : 若距离更大了， 显然 不应更新。若距离不变， 更新后得不到好处， 因此也不更新。
【 例 4-4 】 已知路由器 凡 有表 4-8( a )所示的路由表 。 现在收到 相 邻路由器 凡 发来 的路

由更新信 息 ， 如表4-8( b )所示 。 试更新路由器 凡 的路由表。

表 4-8(a) 路 由 器 氏 的 路 由 表

目 的 网 络

距 离

下一跳路 由 器

Net2

Net3

3

4

R4

R5

表 4-8(b) 氏 发来 的 路 由 更新信息

目 的 网 络

距 离

下一跳路 由 器

Net l

Net2

Net3

3

4

I

R1

R2

直接交付

•  1 6 1  •

【 解 】 如同路由器 一样， 我 们 不 盄要知 道该网络 的 拓 扑。
先把表 4-8( b )中的距 离都加1, 并把下一 跳路由器都改为 凡， 得出表 4-8( c)。

表 4-8(c) 修改后的 表 4-8(b)

目 的 网 络

距 离

下一跳路 由 器

Net I

Net2

Net3

4-

5-

2

R4

R4

R

把这个表的每一行和表 4-8( a )进行比较 。
第 一行在表 4-8( a)中没有， 因此要把这 一行添加到表 4-8( a )中。
第 二 行的 N e t 2在表 4-8( a )中有， 且 下 一跳路由器也是 凡。 因此要更新（距 离 增 大了 ） 。
第三行的 N e t3 在表 4-8( a )中有， 但下一 跳路由器不 同 。 于是就要比较距 离 。 新的路由

信 息的距 离 是 2, 小 于 原 来 表中的4, 因此要更新。

这样， 得出更新后的 民 的路由表如表 4-8( d)所示。

表 4-8(d ) 路 由 器 氏 更新后 的 路 由 表

目 的 网 络

Net !

Net2

Net3
...

距 离

4

5

2

． ． ．

下一跳路 由 器

R4

R

R
． ． ．

协 议 RI P 让 一个(cid:7149)治系统中的所有路由器都和(cid:7149) 己的相 邻 路由器定 期 交换路由信 息，

并不断更新其路由表， 使得从每—个 路 由 器 到 每 —个 目 的 网 络 的 路 由 都是最短的（即 跳数最
少 ） 。 这 里 还应注 意： 虽 然所有的路 由 器最终都拥有了整个 (cid:7151) 治系统的全 局 路由信 息， 但由
于每 一个路由器的位置不 同 ， 它们的路由表当然也应当是不 同 的 。

现在 较新的 RI P 版本是 1 998 年 1 1 月 公 布的 RI P 2 [RFC  2453,  STD5 7]， 新版本协 议本

身并无多大变化 ， 但性 (cid:7131)上有些 改进。 RI P 2 可以支 持 无分类域间路由选 择 CIDR。 此外，
RI P 2还 提供简单的鉴 别 过程支持 多 播。

图 4-40 表明 RI P 报 文作为运输层用户 数据报 UDP 的数据部分进行传送（使用 UDP 的

端 口 5 20 。 端口的意 义见5. 2. 2(cid:7197) ） 。

1 贮气—— RIP已二二二

勹 ＼P
I  勹才昙P 用 丿 数据报

�

片
ri

图 4-40 RI P2 的 报 文 用 UDP 用 户 数据报传送

RI P 报 文 由 首部和 路由部分 组 成 。 在路 由 部分要 填入 (cid:7152) 治 系 统 号 ASN (Autonomous

•  1 6 2  •

Sys tem  N umberf) ， 这 是 考 虑使 RIP有可(cid:7126)收到本 (cid:7160) 治 系 统以外的路由选择 信 息 。 还要指出
目 的 网络地址（包 括 网络的子 网 掩码）、 下 一跳路 由 器 地址以及 到 此 网 络 的 距离 。 一个 RIP
报文最多可包 括 25个路由。 如超过， 必须再用一个 RIP报 文 来 传送。
3. 坏消息传播得慢

RIP存在的一个问题是 当 网 络 出 现故障时 ， 要经 过 比较长 的 时 间 才 (cid:7129)将此信息传 送 到 所
有 的 路 由 器。 我们可以用图 4-41 的简单例子来说明。 设三个网络 通过两个路由器 互 连起 来 ，
并 且 都 已 建 立 了各 (cid:7151) 的路由表。 图中路 山 器 交换的信 息 只 给出了我们感 兴趣的一行 内 容。 路
由器 R ) 中的 " N et l ,1 ， 直接
。 路由器 民 中的
" N et l ,  2,  R产 表示 ” 到 网 N et l 的距 离是 2, 下一跳经过 R产。

” 到 网 N et l 的距 离是1, 直接交付

表示

”

＂

正常情况

网 Net l 出 故障

I严庄竺直 叶 I二
|＿严主飞：J二
已 －
三 －

已～， 庄2丸，I

三竺庄沪彗＿

图 4-4 1 协 议 RIP 的缺 点 ： 坏 消 息 传 播 得 慢

现在假定路由器 民 到 网 N etl 的链路出了故 障 ， 凡 无法到达网 N etl 。 于是 路由器 R ] 把
到 网 N et l 的距 离 改为1 6, 表示不可达， 因而在 民 的路由表中的相 应项目变为 " Ne t l ,1 6,

”

。 但是 ， 很可(cid:7126)要经过 30 秒钟后 R 1 才把更新信 息发送给 R2。 然 而 R2 可(cid:7126) 已经先把

直接
(cid:7151) 己的路由表发送给了 R 1, 其中有 “ N e t l , 2,  R 产 这 一项。

R 1 收 到 民 的更新 报 文后 ， 误认为可经过 民 到 达 网 N et l, 千 是 把 收 到 的路由信 息
”, 表明 “ 我到 网 N et l 的距 离 是3, 下 一跳经过 R2 ", 并

" N et l ,   2,  R广 修 改为： “ N et l ,3， 民
把更新后的信 息发送给 R

同理 ， 凡 接着 又更新(cid:7149) 己的路由表为 " N etl , 4,  R 广

＇

， 以为 “ 我到 网 N et l 距 离是 4, 下

一 跳经过 R广。

沪

这样的更新一 直继续下去 ， 直到 R 1 和 民 到 网 N e t l 的距 离 都增 大 到1 6 时 ， 民 和 民 才
知道原 来 网 N etl 是 不可达的。 协 议 RIP的这 一 特 点 叫 作 ： 好消息传播得快 ， 而坏消息传播
得慢。 网络出故 障的传播时间 往 往 较长（ 例 如数分钟）。 这是 RIP的一个主 要 缺 点 。
但 如果一个路由器发现了更短的路由 ， 那么这种 更 新 信 息 就传播得很 快。

CD 注 ： 自 治 系 统 号 ASN 原 来规 定 为

一

个 1 6 位 的 号 码 （ 最 大 的 号 砃 是 65 5 3 5 ) ,

「�I

!ANA 分 配 ， 具 体 的 号 码 指 派 范 围 相 当

复 杂 ， 可 从网 七 查 出 [W-ASN ] 。 现 在 已经把 ASN 扩 展 到 3 2 位[RFC 6793] 。 自 2007 年 1 月 起 ， 32 位 自 治 系 统 号 A SN 在 全球互联

网 开 始 分配 和 使用 。 为 了 便 千 书 写 ， 在 3 2 位 ASN 中 使 用 两 段 点 分 十 进 制 记 法 ， 把 65 5 3 5 在 第 1 段 中 记 为 1 ， 例 如 ， ASN 1 3 1 074

可 以 记 为 ASN 2.4 。

• 1 63  •

为了使坏 消 息传播得 更 快 些 ， 可 以 采取多种措 施。 例如 ， 让 路由器记 录 收 到 某特定路

由信 息的接口 ， 而不让 同 一 路由信 息 再通过此接口向反方向传送。

总 之， 协 议 RIP 最大的优 点 就是 实现简 单 ， 开销较小。 但协议 RIP的缺点也较多。 首

先 ，
RIP限 制了网络的规模 ， 它(cid:7126)使用的最大距 离 为 15 (1 6 表示不可达）。 其次， 路 由 器之
间交换的路 由 信 息是 路 由 器中的完整 路 由 表 ， 因而随 着 网络 规 模的扩大 ， 开销也就增加。 最
后， “ 坏消 息传播得慢 “
， 使更新过程的收敛时间过长。 因此 ， 对千规模较大的网络就应当使
用下一(cid:7188)所述的 OSPF 协议。 然 而目前在规模较小的网络中， 使用协议 RIP的仍 占多数。

扫 一扫

4.6.3 内 部 网 关协议 OSPF

义

开
：

P
：

/i＼：/::

://

／s:；斤：
：

三三／

离向量 协 议。 协 议 OSPF 的特 点是：

OSPF 最主要的特 征就是使用 链路状态协议(link s tate  protocol )， 而不是 像 RIP那样的距

(1 ) 向本(cid:7149)治系统中所 有 路 由 器发送信 息 。 这 里 使 用 的方法是 洪泛法( flooding )， 这 就是
路由器通过所有输出端口向所有相 邻的路由器发送信 息 。 而每一个相 邻 路由器又再将此信 息
发往其所有的相 邻 路由器（ 但不再 发送给 刚 刚发来 信 息的那个路 由 器）。 这样 ， 最终整个 区
域中所有的路由器都得到 了 这个信 息的一个副 本。 更 具 体的做法后面还要讨 论。 我们应 注 意 ，
协 议 RIP是仅仅向 (cid:7161) 己相 邻的几个路由器发送信 息。

( 2) 发送的信 息就是 与本路由器 相 邻 的 所有路 由 器 的 链 路 状 态 ， 但这 只是 路由器所知道

的部 分 信 息。 所谓 “ 链 路状 态
＂ 度量

” ( metric )。 OSPF 将 这个

”

就是说明本路由器都 和 哪 些 路由器相 邻 (i)
, 以 及 该 链 路的
“ 度量 ” 用 来 表示 费 用 、 距 离 、 时延 、 带 宽 ， 等 等。 这 些都
＂
。 我们应注

由网络 管理人 员 来 决定， 因此较 为 灵 活。 有时为了方便就称这 个度量为
意， 对千协 议 RIP, 发送的 信 息 是： ” 到 所有网 络的距 离和下一 跳路 由器

” 代价
”
。

(3) 当链路状 态 发 生变化 或每隔 一 段时间 （ 如30 分钟）， 路 由 器向所有路由器用洪 泛法

发送链路状 态 信 息。

从上述 的前两点可以看出， OSPF 和 RIP的工作原理相 差较大。
由 千各 路 由 器之间频 繁 地交换 链 路 状 态 信 息 ， 因 此所 有的路由 器 最终都(cid:7126) 建 立 一个链
路 状 态 数 据库( link-s tate databas e ) ， 这个数据库 实 际 上 就 是 全 网 的 拓扑结构 图 。 这个拓 扑结
构图在全网范 围 内 是 — (cid:7174) 的 （ 这 称为链路状 态 数 据库 的 同 步）。 因 此， 每一个路 由 器都知道

＄ 注 ： 在 前 面 我 们 已 经 说 过 ， 在 讨 论 路 由 器 之 间 是 如 何 交 换 路 由 信 息 时 ， 最 好 将 路 由 器 之 间 的 网 络 简 化 为

一

条 链 路 。

＂

OSPF 的

”

链路状态

中 的

＂

”

链路

实 际 曰 就 是 指

“

和 这 两 个路 由 器 都 有接 口 的 网 络

”

。

• 1 64  •

全 网 共有多少个路由器， 以及哪 些路由器是相 连的， 其代价是多少， 等 等。 每一 个路由器使
用链路状态数据库中的数据， 构造出 (cid:7150) 己的路由表（ 例 如， 使用 Dijks tra 的最短路径路由算
法）。 我 们 注 意 到， 协 议 RIP 的每一个路由器虽然 知 道到所有的网络的距 离以及下一 跳路由
器， 但却 不 知 道全 网 的 拓扑结构（ 只有到了下一 跳路由器， 才(cid:7126)知 道再下一 跳应当怎样走）。
OSPF 的链 路 状 态 数 据 库 (cid:7126) 较 快地进行更新， 使各个 路 由器(cid:7126) 及 时 更 新 其 路 由 表。

OSPF 的更新过程收敛得快是 其重 要优点。

为了使 OSPF (cid:7126)够用千规模很大的网络， OSPF 将 一个 (cid:7162) 治系统 再划 分为若干个更小的
范 围， 叫作 区域( are a)。 图 4-4 2 就表示 一个(cid:7150) 治系统划分为四个 区 域。 每一 个 区 域都有 一个
32位的 区 域标识符（ 用点分十进制形式表示 ）。 当然 ， 一个区 域也不(cid:7126)太大， 在一个 区 域 内
的路由器最好不超过 200 个。

划 分 区 域的好处就是 把利 用洪 泛法交 换 链 路 状 态 信 息的范 围 局 限千每 一个 区 域 而不是
整个的(cid:7150) 治系统， 这 就减 少 了整个网络上的通信 量。 在一 个 区 域 内 部的路由器只知道本 区 域
的完整 网络 拓 扑， 而不知 道其 他 区 域的 网 络 拓 扑 的情况。 为了使每一个区 域(cid:7126)够和本 区 域以
外的区 域进行通信， OSPF 使用层 次结构 的 区域划 分 。 在 上层的 区 域叫作主干 区域( backbone

are a)。 主千 区 域的标识符规定为0 .0 .0 .0 。 主干 区 域的作用是用来 连通其他在下层的 区 域。 从
其 他区 域 来 的信 息 都 由 区域边界路 由 器( are a border  router)进行概括。 在图 4-4 2 中， 路由器
民， 凡 和 民 都是 区 域边 界路由器， 而显然 ， 每一个 区 域 (cid:7169) 少应当有 一 个 区 域边界路由器。
在主干 区 域 内 的路由器叫作主干路 由 器(backbone route r)， 如 R3, 凡， R5， 民 和 R7。 一个主干
路由器可以同 时是 区 域边 界路由器， 如 R3, 凡 和 R7。 在主干 区 域 内 还要有一个路由器专门
和本(cid:7149)治系统外的其他(cid:7150) 治系统交换路由信 息。 这样的路由器叫作 (cid:7152) 治 系统边界路 由 器（ 如

图4-4 2中的 R6)。

自 治 系 统 AS

至其他 自 治 系 统

图 4-42 OSPF 划 分 为 两种 不 同的 区 域

采用分层次划分 区 域的方法虽 然 使 交 换 信 息的种 类增 多 了 ， 同 时 也使 OSPF 协 议 更 加 复
杂了。 但这样做却(cid:7126)使每一个 区 域 内 部交换路由信 息的通信 量 大 大 减 小， 因而使 OSPF 协议
(cid:7126)够用千规模很大的(cid:7150) 治系统中。 这 里， 我 们 再 一次地看 到 划 分层次在网络设计中的重要 性。

除了以上的几个基本特 点外， OSPF 还具有下 列的一 些特 点：
(1 )  OSPF 允 许 管理员 给每条路由指派不 同 的代价。 例 如， 高带 宽的卫 星 链 路对千非实

时的业 务 可设置为较 低的代价， 但对千时延 敏 感的业 务 就可设置 为非常 高的代价 。 因此，
OSPF 对千 不 同 类 型 的 业务可计算 出 不 同 的 路 由 。 链 路的代价可以是1 (cid:7169) 65535 中的任何 一
个无量纲的数， 因此十分灵 活。 商用的网络 在使用 OSPF 时， 通常根据链 路带 宽 来 计算链路

•  1 65 •

的代价。 这种灵 活性是 RIP所没有的。

( 2) 如果到 同 一个目的网络有多条相 同 代价的路径 ， 那么可以将 通信 量分配给这 几条路
径 。 这 叫作多路径间的负 载均衡( load balancing)。 在代价相 同的多条路径 上分配通信 量是 通
信 量工程中的简 单 形 式。 RIP只(cid:7126)找出 到 某个网络的一条路径。

(3) 所有在 OSPF 路由器之间交换的分组（ 例如， 链路状 态更新分组） 都具有鉴别的功

(cid:7126) ， 因而保证了仅在可信 赖的路由器之间交换链路状 态 信 息。

(4 )  OSPF 支 持可变长度的子 网 划 分和无分类的编址 CI DR。
( 5 ) 由千网络中的链路状态可(cid:7126)经常发生变化 ， 因此 OSPF 让每一个链路状 态 都带 上一
个32 位的序号 ， 序 号 越 大状态就越新。 OSPF 规定 ， 链 路状 态 序 号 增 长的速率不得超过每 5

秒钟 1次。 这 样 ， 全部序 号 空间在 600 年 内 不会产 生重复 号。

2 .   OSPF 的 五种 分组 类型

OSPF 共有以下 五种分组类型：
(1 ) 类型 1, 问 候( He llo )分组 ， 用来 发现和维持邻 站的可达性。
( 2) 类型 2, 数据库描述(Databas
中的 所有链路状 态 项目的摘 要 信 息。

e De s cription )分组， 向邻站给出 (cid:7151) 己的链路状态数据库

(3) 类型3， 链路状态请求 ( Link State  Re que s t)分组， 向对方请 求发送某 些链路状 态 项目

的详细信 息。

(4) 类型 4 ， 链路状态更新( Link State  Update )分组， 用洪 泛法对全网更新链路状态。 这

种分组是最复杂的， 也是 OSPF 协 议最核 心的部分。 路由器使用 这种分组将 其链路状 态 通知

给邻 站。 链路状 态 更新分组共有五种不 同 的链路状 态 [ RFC 2328] ， 这 里从略。

( 5 ) 类型 5， 链路状态确认( Link State Acknowle dgme nt)分组 ， 对链路更新分组的确认。

OSPF 分组是作为IP数据报的数据部分来 传送的（ 如图4-43 所示）。 OSPF 不用 UDP而

是直接用 IP 数据报传送 （ 其IP数据报首部的协议字段值为 89 )。 OSPF 构成的数据报很短。
这 样做可减少路由信 息的通信 量。 数据报很短的另 一好处是 可以不必将长的数据报分片传送。
分 片传送的数据报只要丢 失一个， 就无法组装成原 来 的数据报 ， 而整个数据报就必须重传。

OSPF 分 组 首 部 1 类 型 l 至类 型 5 的 OSPF 分组

I P 数 据 报 首 部

＾、I

OSPF 分组

-心＾｀心?~～~～？~”“上

IP 数 据 报

图 4-43 OSPF 分组 用 IP 数据报 传送

OSPF 规定 ， 每两个相 邻 路由器每 隔 10 秒钟 要交换 一 次问候分组。 这 样就(cid:7126) 确知哪 些
是 最基本的要求 ， 因为只有可达邻 站的链路状

邻 站 是可达的。 对相 邻 路由器来说 ， ”可达

”

态 信 息 才存入链路状 态数据库（ 路 由 表就是 根据链路状 态数据库计算出 来 的）。 在 正常情况
下 ， 网 络中传送的绝 大多数 OSPF 分组都是问候分组。若有 40 秒钟没有 收到某个相 邻路由

器 发 来 的问候分组 ， 则可认为该相 邻 路由器是不可达的 ， 应 立即 修 改链路状 态数据库 ， 并重

新计算路由表。

其 他的 四种分组都是 用来 进行链 路 状 态数据 库 的 同 步。 所 谓 同 步就是 指 不 同 路 由器的

•  1 66  •

链 路状态数据库 的 内 容是一样的。 两个 同 步的路由器叫作 “ 完 全 邻 接 的 " ( fully adjacent )路
由器。 不是完全邻 接的路由器表明它们虽 然 在物理上是相 邻的 ， 但其链路状 态数据 库并没有
达到 一 (cid:7175)。

当 一个路由器 刚 开始工作时， 它 只(cid:7126)通过问候分组得知 它有哪 些相 邻的路 由 器 在工作 ，
＂
。 如果所有的路由器都把(cid:7149) 己 的本地链 路 状 态 信

以 及将数据发往相 邻 路由 器 所需的

代 价

”

息对全 网进行广 播 ， 那么各路由器 只要将这 些链路状 态 信 息 综 合起来 就可得 出 链 路 状 态数据

库 。 但 这样做开 销 太 大 ， 因此 OSPF 采用下面的办法。

OSPF 让每一个路由器用数据库描 述分组和相 邻路由器 交 换本数据库中 已有的链路状态
摘要信 息。 摘 要信 息 主要就是指 出 有哪 些 路 由 器的链路状态 信 息 （ 以 及 其 序 号 ） 已 经 写入了

数据库。 经过与相 邻 路由器交换数据库 描 述分组后 ， 路由器就使用链路状 态 请 求分组 ， 向对
方请 求发送 (cid:7151) 己 所 缺 少的某些链路状态项目的详细信 息。 通过一系列的这种分组交换 ， 全网
同 步的链路数据库就建立 了 。

在网络运 行的过程中 ， 只要一个路由器的链 路状 态发生变化 ， 该路由器就要使用链 路
状 态 更 新 分组 ， 用洪 泛法向全 网 更 新 链 路状 态 。 OSPF 使用的是可 靠 的 洪 泛 法 ， 其要点如
图 4-44 所示。 设路 由 器 R 用洪 泛 法发出 链路状态 更新分组。 图中用一 些小的箭 头 表示 更 新
分组。 第 一次先发给相 邻的三个路由器。 这 三个路由器将收到的分组再进行转发时 ， 要将其
上游路由器 除外。 可靠的洪 泛 法是在收到 更 新分组后要发送确认 （ 收到重复的更 新分组 只需
要发送一次确认 ）。 图中的空 心 箭 头表示确认分组。

t

t 2

t 3

t4

为了确 保链路状 态数据库 与全 网的状 态 保 持 一 (cid:7175) ， OSPF 还 规定每隔 一 段时间 ， 如 30

图 4-44 用 可靠 的 洪 泛法发送 更 新 分 组

分钟 ， 要刷新一次数据库中的链路状态。

由千一个路由器的链 路状 态 只 涉 及 与相 邻 路由器的连通状 态 ， 因而与 整个 互 (cid:7110) 网的规
模并无直接关系。 因此当互(cid:7110)网规模很大时 ， OSPF 协议要比距 离向量协议 RI P 好得多。 由
于 OSPF 没有

的问题， 据统计 ， 其响 应网络 变化 的时间小千 100 ms 。

坏消 息传播得慢

“

＂

若 N 个路由器连接在一个 以太网 上 ， 则每个路由器要向其他( N - l )个路由器发送链路
状 态 信 息 ， 因而共有 N( N— l )个链路状 态要在这个 以 太网上传送。 OSPF 协 议对这种多点接

•  1 67  •

入的局 域 网 采用了指定 的 路 由 器( de s

ignate d route r)的方法 ， 使广 播的信 息量大大减少。 指定

的路由器代表该 局 域 网上所有的链路向 连接 到 该 网络上的各 路由器发送状态 信 息。

4.6.4

BGP

外 部 网 关协 议

1 . 协议 B G P 的 主要特点

在外部 网 关协议 （或边 界 网 关协议 ） BGP 中 ， 现在使用的是第 4 个版

本 BGP-4（常简 写 为 BGP)。 虽 然最 近 陆 续发布了不少 BGP-4 的更新文 档 ，

视频讲解

但 目前 B GP-4 仍然是 草 案 标 准 [ RFC 4 271 ]。 协议 BGP 对互 (cid:7110)网非常重要。 我们知 道 ， 前面
两(cid:7188)所 介 绍 的路由选择 协 议 RIP和 OSPF, 都 只 (cid:7126)在一个(cid:7149)治系统 AS 内 部工 作 。 因此， 若
没有协议 BGP, 那么分布在全 世 界数 以 万 计 的AS 都将是 一个个没有(cid:7110)系的孤 岛。 正是由千
有了 BGP这种 黏 合 剂 ， 才使得这 么多的 AS 孤 岛(cid:7126)够 连接成 一 个 完 整的互(cid:7110)网。 从这个意
义 上 考 虑 ， 协 议 BGP应当是所有路 由 选择 协 议中最为重要的一个。

我们首 先应当弄清 ， 在不 同 (cid:7151) 治 系 统 AS 之 间的路 由 选择为什么不(cid:7126)使用前面讨 论过的

内 部网 关 协议 ， 如 RI P 或 OSPF ?

我们知 道， 内 部网 关 协 议 （ 如 RIP或 OSPF ) 主 要是设法使数据报在一个 AS 中尽可(cid:7126)
有效地从源 站传送到目的站。 在一个 AS 内 部也不需要考虑 其他方面的策 略。 然 而 B GP使
用的环 境 却 不 同 。 这 主要是 因 为 以下的两个原 因 ：

第 一 ， 互(cid:7116) 网 的 规模太大 ， 使得 (cid:7152) 治 系 统 AS 之 间 路 由 选择 非 常 困 难。 连接在互(cid:7110) 网 主
千 网上的路 由 器 ， 必须对任 何有效的 IP 地址都(cid:7126)在转发表中找到匹配的网络前缀 。 目前在
互 (cid:7115) 网 的主 干网路由器中， 一个转发 表的项目数甚 (cid:7168)可达到 50 万个网络前缀 。 如果使用链
路状 态 协议 ， 则每一个路 由器必须维 持 一个很大的链路状态数据库。 对千这样大的主干 网用
Dijks tra 算法计算最短路径时花 费 的时间也太长。 另 外 ， 由千(cid:7149)治系统 AS 各 (cid:7151) 运行 (cid:7151) 己选
定 的 内 部路由选 择 协 议 ， 并使用 本 AS 指明的路径度量 ， 因 此 ， 当一条路径通过几个不 同
AS 时 ， 要想对这样的路径计算出有意 义的代价是不太可(cid:7126)的。 例如， 对某 AS 来说 ， 代价
为1000 可(cid:7126)表 示 一条比较长的路由。 但对 另 － AS, 代价为1000 却 可(cid:7126)表示不可接受的坏
作为度量 来 寻找最佳路由也
路由。 因此， 对千 (cid:7151) 治系统 AS 之 间 的 路由选择 ， 要用
” 或
信 息（即 “ 可到达

” 代价
” 可达性
到达网络前缀 N 可经过 (cid:7151) 治系统ASx ”。

是 很 不现实的。 比 较 合 理的做法是 在 (cid:7151) 治系统 之 间 交换
” )。 例如， 告诉相 邻路 由 器： ”
“ 不可到达

”

”

第二 ， (cid:7152) 治 系统 AS 之 间 的 路 由 选择必须考虑有关 策略。 由千相 互 连接的网络的性(cid:7126)相

差 很大 ， 根据最短距 离 （即 最少跳数） 找出来 的路径， 可(cid:7126)并不合适。 也有的路径的使用代
价 很 高或很不安 全。 还有一种情况 ， 如(cid:7149)治 系 统 AS 1 要发送数据报给(cid:7149)治系统 AS2, 本来 最
好是经过(cid:7149)治系统 AS3。 但AS 3 不愿 意 让这 些数据报通过本 (cid:7151) 治系统的网络 ， 即使AS 1 愿 意
付 一定的费用。 但 另 一 方 面 ， (cid:7151) 治系统 AS3 愿 意 让 某 些相 邻 (cid:7151) 治系统的数据报通过 (cid:7151) 己的
网 络 ， 特 别是对那些付了服务 费的某 些(cid:7149)治系统 更 是 如此。 因此， (cid:7151) 治系统之 间的路由选择

协 议应当允 许使用多种路由选择 策 略。 这 些 策 略 包 括政治 、 安 全或经济方面的考 虑。 例如，

我 国 国 内 的站点在互相 传送数据报时不应经过国外 兜 圈子 ， 特 别是 ， 不要经过某些对我 国 的
安 全有威(cid:7124)的国家。 这 些 策 略 都是由 网 络 管理人员对每一个路由器进行设置的， 但这 些 策 略
并不是(cid:7149)治系统 之 间 的路 由 选 择 协 议本身 。 还可举出一 些 策 略的例子 ， 如：
仅在到达下 列
这 些地址时才经过 AS己 “ASx 和 ASy 相 比时应优先通过 ASx "， 等 等。 显然 ， 使用这 些 策

“

• 1 68  •

略是为 了 找出较好的路由而 不是最佳 路由 。

由千上述情况， 边界网关协议 BGP 只 能是力 求选择 出 一条能够到达 目的网络前缀且 比
较好的 路由 （ 不能兜 圈 子）， 而 并 非 要计算出 一条最佳 路由 。 这 里所 说的BGP 路由， 是指 经
过哪些 自 治 系 统 AS 可 以到达 目的网络前缀 。 当然， 这 选择出的比较好的路由 ， 也 有时 不严
格 地称为 最 佳路由 。 BGP 采 用了路径 向 量(path vector)路由选择协议， 它 与 距 离 向 量 协议
（ 如R IP) 和链路状态协议 （ 如 OSPF ) 都 有 很大的区 别 。

2 .  BGP 路由

在一个 自 治 系 统 AS 中 有 两种 不 同功 能的路由 器， 即边界路由器 （ 或边界 网 关） 和内 部
路由器 。 一个AS 至少 要 有一 个边界 路由 器和 相邻 AS 的边界 路由 器直接相连。 在讨论协议
BGP 时， 应特别注意 边界 路由 器的作用。 正是由于有了边界 路由 器，AS 之间才能利用协议
BGP 交换 可达性 路由信 息 。

当两 个边界 路由 器 （ 例如 图 4-45(a)中的 R 1 和 R2 ) 进 行 通信 时 ， 必 须先建立 TCP 连接
（ 端 口号为 179 , TCP 连接将 在第5 章中学 习 ）， 这种 TCP 连接又称为 半 永 久 性连接 （即双
方 交换完信 息 后 仍然保持 着连接状态）。 像 凡 和 民 之间的这种连接称为 eBGP 连接， 但 通
示外部 external。 现在， 边界 路由 器 R 1 可 通过eBGP 向 对等端 民 发
常就简 称为 eBGP, e
送BGP 路由 “ X, AS 1 ,  R产， 意 思是 “ 从R 1 经AS 1 可到达 X ” 。 这样， 通过eBGP连接，A S2
中的边界 路由 器 民 就知道了到达AS 1 中的前缀 X 的BGP 路由。

表

; •t ;'.

c

0  BGP 路 由

(a)

王》三 凡
＼之

尸界护；由 器

AS
－ － － － － － －

(b) 已 iBGP
R4
＼

2

前缀

AS

1

图 4-45 AS 之 间 的 eBGP 连接(a)和 AS 内 部 的 iBGP 连接(b)

但是， 仅 有边界 路由器 民 知道 ” 到AS 1 的前缀 X 的 BGP 路由 “ 是远远 不够的。 边界
路由器 民 应当把获得 的 BGP路由， 再转发给AS 内部的其他 路由器。 为此， 协议 BGP 规
定， 在 AS 内部， 两个 路由 器 之 间 还需要 建 立 iBGP （ 也就是 iBGP 连 接 ， i 表 示内部
internal ) ,  iBGP也 使用 TCP 连接传送 BGP 报 文 。 图 4-45(b)中
示边界 路由 器 民 在三个
iBGP 连接上， 向 AS2 内部的其他三个路由器转发 自 己收 到的 BGP 路由。 至此，AS2 内的所
有 路由 器都知道了这 条 BGP路由信 息 。 由此可见， 协议 BGP 并 非仅运行 在AS 之间， 而且
也 要运行 在AS 的内部 。

表

协议 BGP规 定， 在一个AS 内 部所有的 iBGP 必须是全 连通的。 即 使 两个路由器之间没

• 169  •

有 物理连接， 但 它 们 之 间 仍然 有 iBGP 连接（ 如 图4-46 所示）。

勺 －

AS

��;;,,d

三三/ 一二三

i BGP  AS
��:�三一／

i BGP

实 线 是 路 山 器之 间 的 物理连接

虚线是 路 由 器 之 间 的 i BGP 连接

图 4-46 在 A S 内 路 巾 器之 间 的 物 理 连 接 与 iBGP 连接

这 里要说明一下 。 图 4-45( a) 中 的 边界路 由 器 凡 通 告 给边界路由器 民 的 BGP 路由可(cid:7126)
有很 多条 （ 在 图中只画 出 了 一条 ）。 但 凡 根据本 AS 管 理 员 所 规 定的策 略 ， 可以拒 绝 某 些路
由 （收 到 这 种 路 由后即 删 除 掉 ） ， 而 在 iBGP 连接上仅转 发符合规定 策 略的 BGP 路由。

我 们 还 需 要指 出 ， 虽 然 eBGP 和 iBGP 的最后一个字 母 P 是代表 ” 协 议( Protocol) ", 但
eBGP 和 iBGP 并 不 是 两 个 不 同 的协议。 根据 RFC 42 71,  eBGP 是 在不 同 AS 的两个对等 端
之间的 BGP 连接 ， 而 iBGP 是 同 一 AS 的两个对等 端 之 间的 BGP 连接。 在这 两种不 同 连接
上传送的 BGP 报 文 ， 都遵 循 同样的协 议 BGP, 使用 同样的报 文 格 式和具有同样的属 性类型 。
唯 一 的 不 同点 就是 在发送 BGP 路 由 通告 时 的 规则有 所不 同 。 这 就 是 ， 从 eBGP对等端 收到
的 BGP路由 ， 可 通过 iBGP 告诉 同 一 AS 内 的对等端 。 反过来 也是可以的， 即从 iBGP 对等
端 收 到的 BGP 路 山 ， 可 通过 eBGP 告诉在不 同 AS 的对等 端 。 但是 ， 从 iBGP 对等端 收到
BGP 路由 ， 不 (cid:7132)转告 给 同 一个 AS 内 不 同 iBGP 的对等 端 。

图 4-4 7 形 象地说 明 了 eBGP 和 iBGP 的作用。 图 中画出了 四个 (cid:7151) 治系统 A S, 每一个
AS 都必须运行本AS 选择的 内 部 网 关 协 议 I GP, 例 如 OSP F 或 RIP。而协 议 BGP是 在 iBGP

连接 和 eBGP 连接之 上 运行的。

lGP 协 议

1

|

IGP 协议 r |

|

IGP 协议

AS 1

AS2

AS3

AS4

图 4-47 协 议 BGP 在 iBGP 和 eBGP 之上运行

扫 －扫

视频讲解

后面我 们经常要讲到 BGP 路由 ， 因此下 面 介 绍 一下 BGP路由的一 (cid:7183) 格 式 。 前面例子中

的 BGP 路 由 正 是 按照这种格式 书 写的。

BGP 路 由 ＝ “前缀 BGP属 性 ” = “前缀 AS-PATH, N EXT-HOP "

前缀的意 思 很明确 ， 就是通告的 BGP路由终点（ 子网前缀 ）。

BGP 属 性有好几种类型 ， 但最重要两个就是 这 里 列出的 AS-PATH 和 N EXT-HOP。
AS-PATH（ (cid:7152) 治系统路径） 是 通告的 BGP 路由所经过的 (cid:7151) 治系统。 BGP 路由每经过一
个 AS, 就将 其 (cid:7152) 治 系统号 AS N 加入到 AS-PATH 中（本(cid:7188)在举例中没有使用具体的 AS N
数 字 号 码 ， 而是用AS 1 , AS2 等符号 来 表示不 同的AS ) 。 从这 里 可以清 楚地看出， “ B GP 路 由 “
必须指出通过哪 些 (cid:7151) 治系统 AS, 但不指出路由中途要通过哪 些路由器。

N EXT-HOP（下一跳） 是 通告的 BGP 路由起点 。
细心的读者 会发现 ， 路由问题并未都解决完。 例 如 ， 在图4-48 中AS2 内 的路由器 凡 在

收到 BGP 路由 “ X, AS 1 ,  R 1 "后， 知道了 “ 从 R 1 出发就(cid:7126)到达 AS 1 中的前缀 X

”

。 但路由器

• 1 70

•

凡 应 当怎样构造(cid:7149) 己的转发表呢 ？ 这需要经过两次 递 归 查找。

R3

AS2  �、

G归） P

R4

=- - iBGP

..---�- - 八 eBUY
\

边 界路 由 器

BGP 路 由
的 起 点

BGP 路 由

l

AS l

I  -� __,,,

＼竺玉�x)

/

x

图 4-48 BGP 路 由 的 起 点 、 经过 的 A S 和 终 点

首先， 凡 要把这条 B GP路由的起点进行转换。 原 来 的 BGP路由是 “ R 1 - X ", 路由的
起点 民 并不在AS2 中。 AS2 中的路由器都不(cid:7126)识 别 R 1 。 因此现在 凡 要把 BGP路由的起点
改为 民 的对等端 R2, 把 BGP路由变为 “ R2- R 1 -X ”
。 由于 民 位千AS2 中， 因 此AS2 里 面
的所有路由器都(cid:7126)把分组转发到 R2, 然 后就(cid:7126)再经过 R 1, 最后到达前缀 X。

其次， 凡 要利 用 内 部网 关协 议 ， 找到从 凡 到 民 的最佳路由中的下一 跳。 在本例中，

查出下一 跳是 R3。 千是 凡 在转发表中增加了到达前缀 X 的下 一跳是 凡 这一项目。

x匹 配 1 下广 I 转 发 表 中 有 下 一跳 民 表：：缀 X 可 达 。

用类似的方法， 路由器 民 也在(cid:7149) 己的转发表中增加了到达前缀 X 的项目。

前缀 匹 配 1 下厂 I 转 发表 中 有 下 一 跳 R咦：月：缀 X 可达 。

这样， 路由器 凡 只要收到要到达前缀 X 的分组， 都按照 凡 - R3 - R2- R1 - X 的路径，

最后 到达前缀 X。

总 之， 每一个路由器 收到 一条新的 BGP 路由通告后 ， 必须经过上述步骤， 才(cid:7126)在 (cid:7151) 己
的相 应项目。

＂

的转发表中， 增加到达终点的 “ 下一跳
在实 际的转发表中， “前缀匹配

”

项目都用C IDR 记法表示。 由于路由器有两个以上的

“ 下一 跳

”

接口， 因 此
理时， 我们就用更简洁的符号 来 表示 。

项目用进入 该路由器的接口的 IP地址来 表示。 在讲解 协 议 BGP的原

3 三 种 不 同 的 (cid:7152) 治 系统 AS

在互 (cid:7110)网 中 (cid:7151) 治 系 统 AS 的数 量非常之多， 其连接图也是相 当复杂的。 但 归 纳起来， 可
以把AS 划分为图4-49 中所 示的三大类 ， 即 末梢AS (s tub AS) 、 穿越AS ( trans it AS )和对等
AS (pe e ring AS)。

穿 越 AS

图 4-49 几 种 不 同 类 型 的 AS

• 1 71

•

未 梢 AS 是 比较小的AS（如图中的 AS4, ASs 和 AS6 ) ， 其特 点是 这 些AS 或者 把分组发

送给其直接连接的 AS, 或者 从其直接连接的 AS 接收分组， 但不会把来 (cid:7149)其他 AS 的分组
再转发到 另 一个 AS。 末 梢 AS 必须向所连接的 AS 付 费 才(cid:7126)发送或接收分组。 图中链路旁
边的人 民 币 符 号¥表示需要对转发分组付 费。

末 梢 AS 也可以同时连接到两个或 两个以上的AS（如图4-49 中的AS 5 )。 这种末 梢 AS
就称为 多 归 属 AS ( multihome d  AS)。 多 归 属 AS 可以增 加 连接的可靠性 ， 因为若有一条连接
出现故 障 ， 那 么 还有 另 一 条 连接 可 用 。 作为未 梢 AS 的 AS 5 不(cid:7126)把 AS3 发送过来 的分组转发
到 AS2。 同理 ， AS5 也不(cid:7126)把 AS2 发送过来 的分组转发到 AS3。 这 就是说 ， 末 梢 AS 不是 穿
越 AS, 它不允 许 分组穿 越(cid:7150) 己的 (cid:7163) 治 系 统。 末 梢 AS5 也不(cid:7126)把 ( ASs-AS2- AS4 ) 这 样的

BGP路由信 息通告给 AS3。 如果 AS3 有分组要转发给 AS4, 可以通过对等 AS2 转发， 但不(cid:7126)
通过末 梢 AS沪

如图4-4 9 所 示的穿 越 AS 1 往往是 拥有很好的高速通信 干线的主干AS, 其任务就是为其

他的 AS 有偿转发分组。 通常都会有很 多 的 AS 连接到 穿 越 AS 上。

对等 AS（ 如图 4-49 中的 AS2 和 AS3 ) 是经过事先协 商的两个 AS, 彼此之间的发送或

接收分组都不收费 ， 这样大家转发分组都比较方 便。

这里我们要强 调 一下 ， BGP 路由必须避免 兜 圈 子的出现。 现观看图 4-49 所 示的几个(cid:7149)
治系统 AS。 AS 3 向 AS 1 通告可到达 AS6 的 BGP路由中的属 性 AS-PATH 是 [AS3 AS小 AS 1

在收到的 BGP 路由的属 性 AS-PATH 中的最前面 ， 添 加上 (cid:7151) 己的 AS, 通报给 AS2 :

[AS 1

AS3  AS6]。 AS 2 收到 BGP路由后 ， 向AS3 通报 BGP路由属 性 AS-PATH 是 [AS2 AS 1  AS3  AS小
当 AS3 收到 BGP路由后 ， 检查属性 AS-PATH 序 列中 已经有了(cid:7149) 己的 AS3, 如果AS3 接受这

个路由 ， 并 添 加上 本 AS 号 ， 则将在 属 性 AS-PATH 中出现两个 AS3（见有灰(cid:7187)底纹的两个
AS凸 [AS3 AS2  AS I AS3  AS6]。 这 就构成了一个兜 圈 子的 BGP路由 ， 因此 AS3 应立即 删 除
此 BGP路由 ， 因而避 免了 兜 圈 子路由的出现。 请记住 ， 在属 性 AS-PATH 中不 允 许出现相 同

的 AS。

AS3 还可向 AS2 通报可到达 AS6 的另 一条 BGP路 由 ， 其 AS-PATH 是 [AS3 AS6] 。 因此

AS2 知道有两条 BGP 路由可到达 AS6, 其 AS-PATH 是 [AS2 AS 1  AS3  AS6]和[AS2 AS3  AS小

4.  BGP 的 路 由 选择

假 如从一个 AS 到 另 外 一个 AS 中的前缀 X 只 有一条 BGP 路由 ， 那么就不存在选择

BGP 路由的问题 ， 因 为这 时 BGP路 巾 是唯 一的。

但如果到 前 缀 X 有两条或 更 多的 BGP路由可供选择 ， 那么就应 当根据以下的原则 ， 按

照这里给出的先后顺序 ， 选择一条较好 的 BGP路 由 。

•  本地偏好 LOCAL-PREF ( LOCAL PREF e re nce )值最高的路由要首先选择。
在 BGP 路由中的属 性里面有 一个选项叫作本地偏好 ， 在属 性中记为 LOCAL-PREF。 本
的 意 思是指 ， 从本 AS 开始的 、 到 同 一个前缀的不 同 BGP
地偏好也就是本地优先 ， “ 本地
路由中 ， 挑选一个较好的（即 偏好值最高的） 路由。 这可由路由器管理员或 网络 管理员 根据
政 治 上或经济上的策 略 来 设置。

”

例如在图4-50 中， AS 1 分别用高速和低速链路连接到 AS2 和 AS3, 并从这 两个 AS 获 悉 ，

可通过AS2或 AS3 到达 AS4。 但 AS 1 认为， 若有分组要从 AS 1 转发到AS4, 应优先选择路由
器 民 离开 AS 1 。 千是就把从 民 离 开 AS 1 的 BGP路由的属 性 LOCAL-P REF 值 设为300 , 而

•  1 72  •

把从 民 离开AS 1 的 BGP路由的 LOCAL-PREF 值设为 200 。 这 一信 息 通过 iBGP通告AS 1 内
部的所 有 路由器。 这样 ， 凡是有分组要转发到 AS4, 都优 先选择从 凡 离 开AS 1。

LOCAL-PR

F =  300  I

E

优 先选择 从

R1 到

AS2 的

BGP

路 由

图4-50 LOCAL-PREF 值较高的路 由 优先

但是 ， 即使所 有的通 信 量 都通过这条高速链路 ， 使得链路负 荷过重 ， 协 议 BGP 也无法

把一些 负 载调 整到 负 载较轻的那 条低速链路上。

如果从几条 BGP路由 中找不出本地偏 好值最 高的路由 ， 则执行下一 条。
•  选 择 具 有 AS 跳 数 最 少的路由。

现观察图4-51 的例子。 从AS 1 到 AS 5 共 有两 条 BGP路由 ， 即 AS , -AS2-AS3 -ASs 和

AS 1 -AS4-ASs。 根据选 择 具有 AS 跳数最少的原则 ， 我们应选择只通过1 个AS 的 BGP路

由 ， 即 AS 1 -AS4-ASs。 但是 没 有 想 到 ， 分组在 AS4 中 反而要经过更多次数的转发（或 许
AS4 是个很大的 AS) ， 可(cid:7126)要花 费更长的时间。 可 见 选 择经过 AS 数 量 最少的路由 AS 1 -

AS4

一AS5 未必更好。 这个例子 再次说明了协 议 BGP无法选择出 最佳路由。

I

经过

2 个 AS I

优 先选择经过

1 个 AS

BGP

的

路 由

图4-51 根据经过 AS 跳 数 的 多 少选择BGP 路 由

•  使用热土豆路由 选择算法。

如果按前两种方法都无法选择 最好的路 由 ， 那么就在要进入 BGP路由的AS, 执行热土

豆路由选择算法。 例如在 图4-52 中 ， 从 AS 1 出发， 共有两条 BGP路由可到 达AS3 :

B GP路由1 ： 从 民 离开AS 1 , 然 后进入AS2, 再到 AS 沪

BGP路由 2： 从 凡 离开AS 1 , 然后进入AS2, 再到 AS沪

R1 .,,,.,--

•臧

\ -

二-－\-－

AS3

))
＼

图4-52 热 土豆路 由 选择算法的应用 举 例 （ 图中 的 连 接 都 是 物理连接 ）

假 定 这 两条 BGP 路由的本地偏好 相 同 ， 同 时所经过的 AS 个数也相 同 。 在 这种情况下，

• 1 73  •

AS 1 中的每一个路 由 器 ， 就应采用热土 豆 路 由 选 择 算法。 这种算法把分组比喻为烫手的热土
豆 ， 要尽快地转发出去。 对于图 4-52 的例 子， 就是要使分组尽 快 离 开 AS 1 , 而不考虑从哪

个路由器 离 开 AS 1 。 或者说 ， 要让分组经过最少的转发次数离开本 AS。 这 时要使用 内 部网

关 协 议（如协 议 OSPF 或 RI P)。 对千不 同 的路由器 ， 得出的选 择结 果是不 同 的。

例 如 ， 对千AS 1 中的路由器 R 1, 若要使转发的分组尽 快 离 开 AS 1 , 应选择 凡 作为其下

一 跳 ， 因此应选择 BGP 路由 2。 这 样 ， R 1 的转发路径应 当是：

R尸 凡一 BGP 路由 2。

同 理 ， 对于 R2, 若要使转发的分组尽 快 离 开 AS 1, 应选择 民 作为其下 一跳， 因此应选
R2

择 BGP 路由 l 。 这样 ， 民 的转发路径应 当是：

一 R3 一BGP 路 由1 。

•  选择路由器 B GP 标识符的数值最小的路 由 。

当 以 上几种方法都无法找出最好的 BGP 路由时， 就可使用 BGP 标 识 符 来 选 择路 由 。 在
BGP 进行交互的报文中， 其首部有 一 4 字(cid:7188)的字段 ， 叫作 BGP 标识符 ， 记为 B GP ID。 这
个字段 被 赋 予 一个无符 号 整数作为运 行 BGP 的路 由器的唯 一 标 识 符。 具有多个接口的路由
器有多个I P 地址。 BGPID就使用该路 由器的I P 地址中数值最大的一个。

5.  BGP 的 四 种报文

在协议 B GP 刚运行时， BGP 连接的对等端要相 互交换整个的 BGP 路 由 表。 但 以后只

需要在 B GP 路 由发生变化 时， 才更新有变化 的部分。 这 样做对(cid:7188)省 网络 带 宽和减 少 路 由 器
的处理开销 方面都有好处。

在 RFC4 271 中规定了 BGP-4 的四种报文：
(1 )  OPEN （打开） 报文 ， 用来 与 BGP 连接对等端 建 立 关系。
( 2)  UPDATE（更新） 报文 ， 用来 通告某 一路由的信 息 ， 以 及 列出要撤销的路由。
(3 )  KEEP ALI VE（保活） 报文 ， 用来 周 期性地证 实与对等端的连通性。
(4 )  N OTI FI CATI ON （通知） 报文 ， 用来 发送检测 到的差错。

OPEN 报文是两个路由器之间建 立 了 TCP 连接后 接着就必须发送的报文 。 OPE N 报 文
的作用是相 互识 别对方 ， 协 商 一 些 协 议 参数（如计时器的时间）。 收到 OPEN 报文的路 由 器 ，
就发回 KEEPALI VE 报 文表示接受 建 立 BGP 连接。

UPDATE 报文是 BGP 协 议的核 心 ， 用来 撤销 它 以前 曾经通知过的路由 ， 或 宣 布增加新

的路由。 撤销 路由可 以 一 次撤销 许多条， 但增加新路由时， 每个更新报文只(cid:7126)增加一条。

虽 然 BGP 连接的两端 建立了 TCP 连接， 传输报文是可靠的， 但 TCP 上层的 BGP 是否
始终正 常工作还无法确知。 在对等 端 之间定期传送 BGP 路 由 表是不可取的 ， 因 为 B GP 路 由

表往往过千庞 大 ， 这样做会使网络的通信 量过大。 因此协议 BGP 采用的方法是让 B GP 连接
的两个对等端之间， 周 期性地交换 KEEPALI VE 报文 ， 以 表示 协 议 工作 正 常。 KEEPALI VE
报文只包 含 BGP 报文的通用首部 ( 1 9 字(cid:7188)长） ， 因此不会在网络 上产 生多少开销 。

每个路 由 器都 有 一个保持 时 间 计时器(Hold Time r)。 路由器每收到 一个 BGP 报文 ， 这个
计时器就重置一次 ， 继续从0 开始计时。 如果在商定的保持时间内 没有收到对等端发来 的任
何 一种 BGP 报 文 ， 就认为对方 已 经 不(cid:7126)工作 了 。 发送 KEEPALI VE 报文的时间间隔取为双
方事先商定的保持时间(Hold Time)的1 /3。 例 如， 在 BGP 连接建 立 阶段 ， 双方商定保持时间
为1 80 秒 ， 那么 KEEPALI VE 报 文就每隔 60 秒发送一 次。 如果两个对等端 选 择的保持时间
不一 (cid:7175) ， 就选择数值较小的一个作 为 彼此使用的保持时间。 保持时间也可选择为0 。 在这种
情况下就永远 不发送 KEEPALI VE 报文 ， 表明这条 BGP 连接总是正常工作的。
BGP 可 以很容易地解决距离向量路由选择算法中的 “ 坏 消 息传播得慢 ”

这 一问题。 当 某

• 1 74  •

个路由器或 链路出故 障时， 可以从不止 一个邻 站 获 得路由信 息 ， 因此很容易选择 出 新的路由 。
在AS N 升级到4 字 (cid:7198)后 ， 号码AS N 的范 围 从0 ~  65535 扩 大到了0 ~ 4 29496 7295。 这
样就在互(cid:7110)网中存在两种不 同的 BGP 报文。 旧 BGP 报文使用 2 字(cid:7188)AS N , 而新 BGP 报 文
使用4 字 (cid:7198)的AS N, 这 时 BGP 路由中的路径 属 性记为 AS4-PATH 。 使用新的和 旧 的 BGP 报
文 的路由器若要进行通信 ， 必须解 决如何 正 确 识 别 其AS N 的问题 [RFC 6 793]。

B GP报 文是作为 TC P 报文的数据部分 来 传送的（ 如图4-53所示）。 四种类型的 BGP 报

文 具有 同样的首部。

IP 首部

图 4-53 BGP 报 文 用 TCP 报 文传送

在讨 论完路由选择之后 ， 我们再来 介 绍 路由器的构成。

4.6.5

路 由 器 的 构成

1 . 路 由 器 的结构

路由器是 一种 具有多个输入端 口和多个输出端口的专用计算机 ， 其任

扫一 扫

譬回

芍
烂
器

务 是 转发分组 。 从路由器某个输入端 口收到的分组， 按照分组要去的目的
地 （即 目的网络）， 把该分组从路由器的某个合适的输出端口转发给下一 跳路由器 。 下 一 跳

视 频 讲 解

路由器也按照这种方法处理分组 ， 直到 该分组到达终点为止 。 路由器的转发分组正是 网络层
的主要工作 。 图4-54 给出了一种典 型的路由器的构成框图。

路 由 选择处理机

I
I
I
I
I
I
I
'

制控二I

I
I一

面
件
路 由 选 择 、 管理

软

层

（

}

一

分
层据

组
面

转

发
硬

（

件

）

）

交换结构

－

图 4-54 典 型 的 路 由 器 的 结构 （ 图 中 的 数字 I ~ 3 表示 相 应层 次 的 构件 ）

从图 4-54 可以看出， 整个的路由器结构可划 分为两大部分： 路 由 选择部分和 分组转发

部分 。

路由选 择部分也叫作控制 部 分 ， 或控制 层 面 ， 其核 心构件是 路由选 择处理机 。 路由选

择处理机的任务是根据所选定的路由选择 协 议构造出路由表 ， 同 时经常或定期 地和相 邻路由

• 1 75  •

器交换路由信 息而不断地更新和维护 路 由 表 。

分组转发部分是 本(cid:7188)所要 讨 论的 问 题 ， 也 就是 数 据层 面 ， 它由三部分组成： 交 换结构 、
一组输入端 口 和一组输 出 端 口 （ 请 注 意 ： 这 里的端 口 就 是 硬 件接口） 。 小 型路由 器的端口只
有几个。 但某 些 I SP使用的边缘路由器的高速10 Gbit/s 端 口 ， 则可 以有多达 几 百个之多。
下面分 别 讨 论每一 部分的组成。 例 如 ，
10  Gbit/s 端口就有 960 个。 路由器 整个的系统 容 量 为 80 Tbit/s

Juniper （ 陷 博 网 络 ） 公 司 的边缘 路由器 MX 20 20 的

。

。
请 注 意 “

交换结构(s witching fabric)又称为交 换组织， 它的作用就 是根据转发表(forwarding table)
对分组进行处理， 将 某个输入端 口 进入的分组 从 一 个合适的输 出 端 口 转发 出 去 。 交换结 构 本
身 就是 一种网络， 但这种 网 络 完 全包含在路由器之中， 因 此 交换结 构可看成是 “ 在路 由 器 中
的 网 络

”

“

”

”

“ 路由选 择

“

”

”

和

转发

是 有 区 别 的 。 在互 (cid:7110)网 中 ，

就是 路 由 器根据转
转发
仅仅涉 及 一 个路 由 器 。 但
则 涉及很 多 路 由 器， 路由表则是 许 多 路 由 器协 同 工 作 的结 果 。 这 些路由器按照

发表把收到的 IP 数据报从路由器合 适 的 端 口 转发 出 去 。 ＂ 轧发
“ 路 由 选择
复 杂 的路由算法， 得 出 整个网 络的拓 扑 变 化情况， 因 而(cid:7126)够 动 态地 改变 所 选 择的路由， 并由
此构造 出 整个的路由表 。 路由表一 (cid:7183)仅包含从 目 的网 络到 下 一 跳 （ 用 IP 地址表 示） 的映射，
而转发表是 从路 由 表得 出 的 。 转发表 必 须 包含完成转发 功 (cid:7133) 所 必 需的信 息 。 这 就是 说， 在转
发表的每一 行必须包含从要到达 的 目 的 网 络到输 出 端 口 和某 些 MAC 地址信 息 （ 如下 一 跳的
以太网地址） 的映射。 将转发表和路 由 表用 不 同的数据 结 构 实 现 会 带 来 一 些好处， 这 是 因为
在转发分组时， 转发表的结构应 当 使查找过程 最 优 化， 但路 由 表则需要对网络 拓 扑 变化的计

算最优化 。 路由表总是用软件实现 的 ， 但转发表则可用 特殊的硬件来实现。 请读者 注 意 ， 在

讨论路 由 选择 的 原理时 ， 往往不去区分转发表和 路 由 表 的 区别 ， 而可 以笼统地都使 用 路 由 表
这 一名 词 。

在 图 4-54 中， 路由器的输 入 和 输 出 端口里 面 都各 有三个方框， 用 方框中的1 , 2和3 分

别 代表物理层 、 数据链路层和网 络 层的处理模块。 物理层 进 行 比特 的 接收。 数据链路层则按

照链路层 协 议 接收传送分组的帧 。 在 把帧的首部和尾部剥 去 后 ， 分 组 就 被送入网络层的处理
模 块 。若接收到的分组是 路由器之 间 交 换路由信 息的分组 （ 如 RIP或 OSPF 分组等）， 则把
这种分组送 交路由器的路 由 选择 部分 中 的 路由选择处理机。 若接收到的 是数据分组， 则按照

分组首部中的 目 的地址杳找转发表， 根据 得 出 的结 果， 分组 就经过 交换 结 构到 达 合适的输 出

端口。 一个路由器的输入端 口 和输 出 端 口 就 做 在路 由 器的线路接 口 卡上 。

输入端 口 中的查找和 转 发 功 (cid:7134) 在 路 由 器 的交换 功 (cid:7133)中是最重 要 的。 为 了 使交 换 功(cid:7126)分
散化， 往往把复制的转发 表 放在 每 一个输 入端 口 中 （ 如 图 4-54 中 的虚线箭 头 所示）。 路 由 选
” ( s hadow copy) 。 分
择 处理机负 责对各 转发表的副 本进行 更 新 。 这 些 副 本 常称 为 “ 影子副本
散化 交换可 以 避 免 在路 由 器中的某 一 点 上 出 现瓶颈 。

以 上 介 绍 的查找转发表和转 发 分组 的 概 念 虽 然并不 复 杂 ， 但 在 具 体的实 现中还会遇到

不少困 难。 问题就在于路 由 器 必 须 以 很 高的速率转 发分组。 最理想 的情 况是 输 入端口的处理

速率(cid:7126)够跟上线路把分组传送到路由器的速率 。 这种速率称为线速 ( line s peed 或 wire s peed) 。
可 以粗略地估 算 一下。 设线路是 OC -4 8 链路， 即 2.5 Gbit/s 。 若分组长度为 256 字(cid:7188)， 那么
线速就应 当 达 到每秒(cid:7126)够处理100 刀 以 上的分组。 现在常用 Mpps （ 百万 分组每秒） 为单位
来说明一个路 由 器对收到的分组的处理速率有 多 高。 在 路由器的设计中， 怎样 提高查找转发
表的速率是 一个十分重要的研 究 课 题 。

•  1 76  •

当 一个分组正在查找转发表时，后面 又 紧跟 着从这个输入端 口 收 到 另 一个分组。 这 个
后到的分组就必须在 队 列 中排 队 等待 ， 因而产 生了一定的时延。 图 4-55 给出了在输入端口
的队 列中排 队的分组的示 意图。

输 入端 口 的处理

从
线
路
接
收
分

组

分

网 络 层 处 理

排 队二查 表 和 转 发

组

交
换
结
构

图4-55 输入端 口 对线路上收到的分组的处理

我们再 来 观察在输出端口上 的情况（如图4-56 所 示 ） 。 输出端口从交换结构接收分组，
然后把它们发送到路由器外面的线路上。 在网络层的处理模块中设有一个缓存区 ， 实 际上它
就是 一个 队 列 。 当 交换结构传送过来 的分组的速率超过输出链路的发送速率时， 来 不及发送
的分组就必须暂时存放在这个 队 列中。 数据链路层处理模块把分组加上链路层的首部和尾部，

交给物理层后发送到外部线路。

输 出 端 口 的处 理

交
换
结
构

网 络层 处 理
分组排 队

JillII]

缓 存 管 理

向
线
路
发
送
分
组

图4-56 输 出 端 口 把交换 结构传送过 来的分组发送到 线 路 上

从以上 的 讨 论可以看出， 分组在路 由 器的输入端 口和输出端口 都可(cid:7126)会 在 队 列 中排 队

等候处理。 若分组处理的速率赶不上分组进入队 列的速率， 则 队 列的存储 空 间 最终必定减少

到 零， 这 就使后面再进入队 列 的分组由于没有存储 空 间而只(cid:7126)被丢弃。 以前我们 提到过的分

组丢 失就是发生在路由器中的输入或输出队 列 产 生 溢 出 的时候。 当 然 ， 设备或线路出故 障也

可(cid:7126)使分组丢 失。

2 . 交换结构

交换结构是路由器 的 关键构件 [KU R01 7]。 正是 这个交换结构把分组从一个输入端 口转
移 到 某 个 合适的输出端 口。 实现这样的交换有多种 方法， 图 4-5 7 给出了三种 常用的交换方

法。 输入端口是A, B 和C, 输出端口是 X, Y 和 Z。 下面简单 介 绍 它们的特 点。

最早使用的路由器就是 利 用普 通的计算机， 用计 算机的CPU 作为路由器的路由选择处
理机。 路由器的输入和输出端口的功(cid:7126)和传统的操作 系 统中的 1/0 设备 一样。 当路由器的某
个输入端口收到 一个 分组时， 就用中断方 式通知路由选择处理机。 然后 分组就从输入端口复
制到存储器中。 路由器处理机从分组首部提取目的地址， 查找路由表， 再将 分组复制到合 适
的输出端口的缓存中。 若存储器的带 宽 （ 读或 写 ） 为每秒 M 个分组， 那么路由器的交换速
率（即 分组从输入端口传送到输出端口的速率 ） 一定小于 M/ 2。 这 是 因为存储器对分组的读

• 1 77 •

和 写需要花 费的时间是 同 一个数量级 。

线

(a) 通过 存 储 器

A

(b) 通过总 线

互 连 网络

(c) 通 过 互 连 网 络

图 4-57 三 种 常 用 的交换方法

许多现代的路 由 器也通过存 储器进行 交 换 ， 图 4-57( a)的示 意 图表示分组通过存储器进

行交换 。 与早 期的路 由 器的 区 别 就是 ， 目的地址的查找和分组在存储器 中 的缓存都是在输入
端口中进行的。 思 科(C is co)公 司 的C atalys t 8500 系列 交换机（有的公 司 把路 由 器也称为交换

机） 就采用了共 享存储器的方法。

图 4-57( b)是 通过总 线进行交换的示 意图。 采用这种方式时 ， 数据报从输入端 口通过共

享 总 线直接传送到 合适的输出端 口 ， 而不需要路 山 选择处理机的干 预。 但是 ， 由千总 线是 共
享的， 因此在 同 一时 间 只(cid:7126)有一个分组在总 线上传送。 当 分组到达输入端口时若发现总 线忙
（ 因 为总 线正 在传送另 一个分组 ） ， 则被 阻 塞而不(cid:7126)通过交换结构 ， 并在输入端口排 队 等 待 。
因为每一个要转发的分组都要通过这 一条总 线 ， 因此路 由 器的转发带 宽就受总线速率的限制。
现代的技 术 已经可以将 总 线的带 宽 提高到(cid:7126)够满 足 小 型 企 业 网的需求 。 例如 ， 思 科 公 司 的
6500 路 由 器用来 交换分组的(cid:7125) 板 总线速率 已达到32Gbit/s 。

图4-57( C )画 的是 通过纵横交换结构( cros

s bar s witch  fabric)进行交换。 这种交 换机构常称
为互连 网络( interconnection network) ， 它有 2N 条总线 ， 可以使 N个输入端 口 和 N个输出端
口相 连接， 这 取决千相 应的交叉(cid:7196)点是使水平总线和垂直总 线接通还是 断开。 当输入 端 口 收
到 一个分组时， 就将 它发送到与该输入端 口相 连的水平 总 线上 。 若通向所要转发的输出端 口
的垂直总 线是 空 闲的 ， 则在这个(cid:7192)点将 垂直总 线与水平总 线接通， 然后把该分组转发到这个
输出端 口 。 例如， 一个分组到 达输入端口A, 应转发到输出端口 Y。 这 时交换结构的控 制器
就把总 线A 和 Y 的交叉(cid:7188)点闭 合 ， 因此分组就从输入端口A 传送到了输出端口 Y。 请 注 意 ，
如果与此同 时还有一个分组要从输入端口 B 转发到输出端口 Z, 那 么 也可 同 时进行 ， 因 为A
- Y 和 B - Z 的转发是使用不 同的总 线的转发。 和前两种交换机制不 同 ， 这种纵横交换结构
是一种无阻塞的交换结构， 其特 点是 分组可以转发到任 何 一个输出端口， 只要这个输出端口
没有被别 的分组 占用。 如果这个输出端口（即对应的垂直总 线 ） 已 被 占 用（有另 一个分组正

• 178  •

在转发到 同 一个输出端 口 ） ， 那么后 到达的分组就必须 在输入端 口排 队 等 待。 采用这种交换
方式的路由器例 子如思科 公 司 的 1 2000 系列 交换路由器 ， 其 互 连网络的速率达 60 Gbit/s 。

4 . 7

I P 多播

4.7. 1

IP 多 播 的 基本概念

1 98 8 年 Ste ve De e ring 首次在其博 士 学位论文 中 提出IP多播的概念。1 99 2年3 月 I ETF
在互(cid:7110)网范 围 首次试验I ETF 会 议 声 音的多播 ， 当时有 20 个 网 点 可 同 时听到会议的声 音。 IP
多 播 是需要在互 (cid:7110) 网 上增加更多的智(cid:7126)才(cid:7126) 提供的一种服务 。 现在 IP 多播 ( multicas t, 以
前 曾 译为组播 ） 已成为互(cid:7110) 网的一个热门课题。 这 是由千有许多的应用需要由一个源 点发送
到 许多个终点 ， 即 一对多的通信。 例如 ， 实时信 息的交付（如新 闻 、 (cid:7122) 市行情等）、 软 件更
新 、 交互式会议等。 随 着 互(cid:7110)网的用户 数目的急剧 增加， 以及多媒体通信的开 展 ， 有更多的

业 务需要多播 来 支 持。

与单播相 比 ， 在一对多的通 信 中 ， 多播可大大(cid:7188)约 网 络 资 源。 图 4-58( a )是 视 频 服 务 器
用单播方式向 90 台 主机传送同样的视频(cid:7188)目。 为此， 需要发送 90 个单播 ， 即 同 一个视频分
组要发送 90 个副本。 图 4-58( b )是视频服务器用多播 方 式向属千同 一个多播组的 90 个成员
传送(cid:7188)目。 这 时， 视频服务器只需把视频分组当作多播数据报 来 发送， 并且 只 需 发 送 —次。
， 民 和 凡 各 转发 l
路由器

在转发分组时 ， 需要把收到的分组复制成3个副本 ， 分别 向

R 1

R2

个副本。 当分组到达目的局 域 网 时 ， 由千局 域网具有硬件多播功(cid:7126) ， 因此不 需要复制 分组 ，
在局 域网 上的多播组成员 都(cid:7126)收到这个视频分组。

视频服务器 M

送 90 次单播

发

R2

1 个压//

| V
R1 已三复伟
个
1炒 <
产
J1 个

I

R

产I f
。卢．
—=＝ ＝＝

3

l

立怼

1

多 播
3

一一一一一产女－一一一一一一一一一巨－－－－－
：三 ——-- , ^!'.b:m:tl
1 、、
I 三］
心

＇，  ；�
1 · · ·
:
， 编
编 俨． 编 ｀
么
、、-----------------------------------------------------

X(
· · ·
．，�｀

多 』心1

• • •

l
｀�

个

个

、

·

．

`

｀

，
:
＾ ，＇

共有 90 个主机接收视频节 目

(a)

单 播

．

多 播 组成 员 共有 90 个
多 播

(b)

＼

，

、

图 4-58 单 播 与 多 播 的 比 较

当多播组的主机数很大时（ 如成千 上万个 ） ， 采用多播方式就可明显地减 轻 网络中各种
资 源的消 (cid:7107)。 在互(cid:7110)网范 围的多播要靠路由器 来 实现 ， 这 些路由器必 须 增加一 些(cid:7126)够识 别多
播数据报的软件。 (cid:7126)够运行多播 协 议的路由器称为多播路 由 器( multicas t router )。 多播路由器

当然 也可以转发普通的单播IP数据报。

为了适应 交互 式 音 频和视频信 息的多播 ， 从1 99 2 年起， 在互(cid:7110)网 上开始试验虚拟的多

播主干 网 MBO N E ( Multicas t Backbone  On the I nte r N Et )。 MBO N E 可把分组传播给地点分散
但属千一个组的许 多 台 主机。 现在多播主千网 已经有了相 当大的规模。

• 1 79  •

