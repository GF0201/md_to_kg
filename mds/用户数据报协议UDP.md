号 ， 这个数 目对 一个计算 机来 说是足 够 用 的。

由此可见， 两个计算 机中的进 程 要互 相通信， 不仅必须知道对方的IP地址 （为了找到
对 方的计 算 机）， 而且 要知道对方的端 口 号 （为了找到 对 方 计 算 机中的应用 进 程）。 这 和我
们 寄 信 的过程类似。 当我们 要给 某 人 写 信时， 就必须 在信 封上 写 明他的 通信 地 址 （这 是为
了 找到他的住所， 相当 于IP地址）， 并 且 还 要 写上收 件 人的姓 名 （这 是因为在同一住所中可
能 有好几个 人， 这 相当千 端 口号）。 在信封 上 还应写 明 自 己的地址和姓 名 。 当收 信 人 回 信时，
很 容 易 在信 封上找到发 信 人 的地址和姓 名 。 互联网上的计 算 机 通信是采用 客 户 －服务 器方式。
客 户 在发 起 通信 请求时， 必须先知道对方服务器的 IP地址 （用来找到 目的 主机） 和端 口号
（用来找到目的进 程）。 因此运输 层的端 口号 分为下面的 两 大 类。

(1) 服 务 器 端 使 用 的端 口 号

这 里又 分为 两 类， 最重 要的一 类 叫 作熟知端 口 号(well-
known  port  number)或全球通用 端 口 号， 数值为0~1023。 这 些熟知端 口 号最初公布 在文档中
[RFC 1700,  STD2]， 但后来因为互联网发展太快， 这种标准 文 档无法随时更新， 因此在 RFC
3232 中就把 RFC1700列为陈 旧 的， 而当 前最新的熟知端 口 号可 在网 址 www.iana.org 上 查到。
IANA把这 些熟知端 口号指派给了 TCP/ IP最重要的一些应用 程序， 让所 有的用 户 都知道。
当 一种新的应用 程序出现后，IANA 必须为它指派一个熟知端 口 ， 否则互联网上的其他 应用
进 程就无法和它 进行 通信。 和电话 通信对 比， 熟 知 端 口 号 相当 千所有 人 都应知晓的重 要 电话
号码， 如报警 电话 110, 急救 电话 120 等。

5-2 给出了 一些常用 的熟知端 口 号。

表

表 5-2 常用 的熟知端 口 号

应 用 程序 I  FTP

I  TELN ET

I  SMTP

I  DNS

I  TFTP

I  HTTP

I  SNMP

I  SNMP (trap)

I  HTTPS

熟 知 端 口 号 I

2 1

23

25

53

69

80

1 6 1

1 62

443

另 一 类 叫 作登记端 口 号， 数值为 1024~49151。 这 类 端 口号是为没有熟知端 口号 的应用

程序 使用 的。 要 使用这 类端 口 号必须 在IANA按照规 定的手 续登记， 以 防 止 重 复。

(2) 客户 端 使 用 的端 口 号

数值为 49152~65535。 由于这 类端 口号 仅 在客 户 进 程运行
时才 动 态 选择， 因此又 叫 作短 暂 端 口 号 ＠。 这 类端 口 号就是临时端 口号 ， 留给客 户 进 程选择
临时 使用 。 当 服务 器进 程收 到 客 户 进 程的报文时， 就知道了客 户 进 程所使用的端 口号 ， 因而
可 以把数据发送给客 户 进 程。 通信结束后， 刚才已使用过的客 户 端 口 号就被 系 统收 回 ， 以便
给其他 客 户 进 程 使用。

下 面 将 分别讨论UDP和 TCP。 UDP比 较简 单， 本 章 主要讨论TCP。

用 户 数据报协议

5 . 2

U D P

5 .2. 1  UDP 概述

用户 数据报协议 UDP只在IP的数据 报 服务之上增加了 很少一 点的功能，

这 就是复 用 和分用 的功 能 以及 差错检测的功 能。 UDP的 主要特点是：

视 频 讲 解

CD 注 ： 短 暂 端 口 (ephemeral port)[STEY94, p . 1 3]表示这种端 口 的存 在 时 间 是短 期 的 。 客 户 进 程 并 不在 意 操 作 系 统给它分配的

是 哪

个 端 口 号 ， 因 为客 户 进程之所 以 必 须 有

个瑞 口 号 （ 在 本地主 机 中 必 须 是 唯

的 ） ， 是 为 了 让运输层 的 实体 能 够 找 到 自 己 。

这和熟知 端 口 不 同 。 服 务 器 机 器

接通 电 源 ， 服 务 器 程 序 就运 行起来。 为 了 让 互 联 网 上 所 有 的 客 户 程序都能找到服务器程序 ， 服

一

一

务 器程序所使用 的端 口 （ 即 熟 知端 口 ） 就 必 须 是 固 定 的 ， 并 且 是众所周 知 的 。

一

一

•  215  •

(1)  UDP是无连接的 ， 即发送 数据 之前不 需 要 建立连接 （当 然， 发送 数据 结束时也 没有

连接可释放 ） ， 因此减少 了 开销 和发送数据 之前的时延。

(2)  UDP 使用尽 最 大 努 力 交 付 ， 即 不保证可靠交付 ， 因此 主机不需要维持 复 杂的连接状

态表 （这 里面有许 多 参 数）。

(3)  UDP是面 向 报文的。 发送方的 UDP 对应用程序 交 下来的报文 ， 在添加首部后就 向
下 交付IP 层。 UDP对应用 层交 下来的报 文， 既 不 合 并 ， 也 不拆分， 而是保 留 这 些报文的边
界。 这 就是说 ， 应用 层交给 UDP 多 长的报 文 ， UDP 就照样发送 ， 即一 次发送一个报文 ， 如
图 5-3所示。 在 接收 方的 UDP, 对IP 层交 上来的 UDP用户 数据 报 ， 在去 除首部后就原封 不
动地交付 上 层的应用进 程 。 也就是 说 ， UDP 一 次交付 一个完 整的报 文。 因此， 应用 程序必
须 选择合适 大小的报 文。 若 报 文 太长， UDP把它 交给IP 层后， IP 层 在传送时可能 要进行分
片 ， 这 会降低IP 层的效率。 反之 ， 若报文 太短， UDP把它 交 给IP 层后， 会 使IP数据 报的
首部的相对长度太 大 ， 这 也降低了IP 层的 效率。

应 用 层

运输层

IP 首 部

JP 数据 报 的 数据 部分

IP 层

图5-3 UDP 是面向报 文的

(4)  UDP没有拥 塞控制 ， 因此网络出现的 拥塞 不会 使源主机的发送速率 降低。 这 对某些
实时应用是很重 要的。 很 多 的实时应用 （如 IP 电 话 、 实时视频会议等） 要求源主机 以恒 定
的速率发送 数据 ， 并 且 允 许 在网络发生 拥塞时丢 失 一些 数据 ， 但却 不允 许 数据 有太 大的时延。
UDP 正好适合 这 种 要求。

(5) UDP支持一对一 、 一对 多 、 多对一和 多对 多的交互通信。
(6) UDP的首部开销 小 ， 只有 8 个字节 ， 比 TCP的 20 个字节的首部 要短。
下面举例 说明 UDP的通信 和端 口号的关 系 （ 如 图 5-4 所示 ）。 主机 儿 中 有三个应用进
程分别 要 和 主机 H2 中的 两个应用进 程进行 通信。 通信 双 方的关 系是： P] 一凡， P2- P4, P3-P5 0
主机凡 的操作 系 统为这 三个进 程 分别 指派 了端 口， 其端 口号 分别为 a, b 和 c。 图 中位于应
用 层和运输 层之间的小方框代表端 口。 在端 口小 方框中间 还画 有队列， 表示端 口具 有缓存的
功能， 可 以把收 到的数据 暂时存 储一 下。 有时也可 以把队列画成双 向 的， 即分别表示存放来
自 应用 层或运输 层的数据 。 现 在假定主 机凡 中的进 程 已 经知道了 对方进 程 凡 和 P5 的端 口
号 分别为 x 和 y , 于是在 主机 凡 的运输 层就可 以组装成需要发送的 UDP用户 数据 报 ， 其中
最重 要的地址信 息（源端 口， 目的端 口） 分别是(a, x),  ( b,  x)和(c, y )。 在图 5-4 中把运输 层以下
的都省 略了。 因此， 进 程之间的 通信 现 在可 以看成是两个端 口之间的通信。

图中 在 两个运输 层之间有一 条 虚 线 ， 表 示 在 两个运输 层之间可 以进行 通信 ， 而 不是一
条连接。 但这 种 通信是不可靠的通信 ， 即所发送的报 文 在传输过程中 有可能丢 失 ， 同时也不
保证报文 都能按照发送的先后顺序 到 达终点。 这 正是 UDP 通信的特点 ： 简 单方便 ， 但 不可
靠。 如果想 要得到可靠的运输 层 通信 ， 那就 要 使用后面 要介 绍 的 TCP 进行 通信。 请注意 ，
在 两个运输 层的 UDP之间并 没有建立连接。

•  216 •

应 用 进程

运输层

复 用

分用

不 可 靠 的信 道 a�x
=〉

b�x
...

c--;::::y
工

请注 意 ： 运输层之 间 的这条虚线不是

条连接

图5-4 UDP 的通信和端 口 号的关系

一

应 用 层

端 口

运输层

图 5-4 的例子画出了多对一的通信（a-x, b - x) 。 如果改成 a-x, a-y, 则是 一对多的

情况了。

主机 H 1 中的3个应用进程， 把用户 数据通过各(cid:7149)的端口传送到了运输层后 ， 就共用一
个网络层协 议 ， 把收到的 UDP用户 数据报组装成不 同的IP数据报 ， 发送到 互(cid:7110)网。 这 就是

UDP的复用 功(cid:7126)。 主机 H2 的网络层收到3个IP数据报后 ， 提取出数据部分（即 UDP用户

数据报） ， 然后根据其首部中的目的端 口 号 ， 分别传送到相 应的端 口 ， 以便上层的应用进程

到 端口读取数据。 这 就是 UDP的分用 功(cid:7126)。

虽 然 某 些 实 时 应用 需 要使用没有拥 塞 控 制的 UDP, 但 当 很多的源主机 同 时都向网络发

送高速率的实时视频流时， 网络就有可(cid:7126)发生拥 塞 ， 结果大家都无法正常接收。 因此， 不使

用拥 塞 控 制功(cid:7126)的 UDP有可(cid:7126)会 引 起网络产 生严重的拥 塞问题。

还有一 些使用 UDP 的实时应用 ， 需 要对 UDP 的不可靠的传输进行适 当 的改进， 以减
少数据的丢 失。 在这 种情况下 ， 应用进程本身可以在不影 响应用的实时性的前 提下 ， 增加一
些 提高可靠性的措 施 ， 如采用前向纠 错或重传 已 丢 失的报文。

5 .2 .2  UDP 的 首 部格式

用户 数据报 UDP有两个字段： 数据字段和首部字 段。 首部字 段很简单 ， 只有 8 个字(cid:7194)

（ 如图 5-5 所 示） ， 由4个字段组成， 每个字段 的 长度 都 是 2字(cid:7195)。 各 字 段 意 义 如下：

(1 ) 源端 口
( 2) 目 的端 口
(3) 长度
(4 ) 检验和

源端口号。 在需要对方 回 信 时选用。 不 需 要时可用全0 。
目的端口号。 这 在终点交付报文时必须使用。
UDP用户 数据报的长度 ， 其最小值是 8（ 仅有首部）。

检测 UDP用户 数据报在传输中是否有错。 有错就丢弃。

4

4

I

I

2

字节

· · 勿 _ ＿ - - － - -

－ － － － 竺

2
--

2

2

，
俨 一 一 一 一 一 一
1 伪 首 部
• - - - - - -

-

1

IP 首 部

图5-5 UDP 用 户 数 据 报的首部和 伪 首 部

•  21 7 •

如果接收方 UDP 发现收到的报文中的目的端口号不正确（即 不存在对应于该端口号的
” 差 错报 文 给
讨 论 trace route 时， 就是 让发送的 UDP

应用进程） ， 就丢弃 该报文 ， 并由网际控制报 文 协 议 IC MP发送 “ 端口不可达
发送方 。 我们在上一 章4 .4 . 2(cid:7188)
用户数据报故意使用一个非法的 UDP端 口 ， 结果IC MP就返 回
因而达到了测 试的目的 。

“ 端口不可达 ＂ 差 错报文 ，

”IC MP的应用举例

＂

UDP用户 数据报首部中检验和的计算方法有些特殊。 在计算检验和时， 要在 UDP用户
” 是 因为 这种伪 首部并不是 UDP用户 数
数据报之前增加 1 2个字(cid:7188)的伪 首部 。 所 谓 “ 伪 首部
据报真 正 的首部。 只是在计算检验和时， 临 时添加在 UDP 用户 数据报前面 ， 得到 一个临时
的 UDP用户 数据报 。 检验和就是按照这个临时的 UDP用户 数据报 来 计算的 。 伪 首部既不向
下传送也不向上递交， 而仅仅是 为 了计算检验和 。 图 5-5 的最上面给出了伪首部各 字段的 内

容 。

UDP计算检验和的方法和计算IP数据报首部检验和的方法相 似 。 但不 同 的是 ： IP数据

报的检验和只检验IP数据报的首部， 但 UDP的检验和是 把首部和 数 据部分—起都检验 。 在

发送方 ， 首先是先把全零放入检验和字段 。 再把伪 首部以及 UDP 用户 数据报看成是 由许多
1 6 位的字 串 接起来 的。若 UDP用户 数据报的数据部分不是 偶数个字(cid:7188) ， 则要填 入一个全零
字(cid:7188)（但此字(cid:7194)不发送） 。 然 后 按 二进制反码计算出这 些1 6 位字的和 。 将此和的二进制反码

写入检验和字段后 ， 就发送这样的 U DP用户 数据报 。 在接收方 ， 把收到的 UDP用户数据报
连同 伪 首部（以及可(cid:7126)的填 充 全 零 字 (cid:7194)） 一起 ， 按 二进制反码求这 些 1 6 位字的和 。 当无差
错时其结果应为全 l 。 否则就表明有差错出现 ， 接收方就应丢弃这个 UDP 用户 数据报（也
可以上交给应用层 ， 但附上出现了差错的警告）。 图 5-6 给出了一个计算 UDP检验和的例子 。
这 里假定用户 数据报的长度是 1 5 字(cid:7188) ， 因此要添加一个全0 的字(cid:7188) 。 读者 可 以 (cid:7151) 己检验 一
下在接收端是 怎样对检验和进行检验 的 。 不难看出， 这种简单的差 错检验方法的检错(cid:7126) 力并

不强 ， 但 它的好处是简单 ， 处理起来 较 快。

1 53 . 19.8

. 1 04

字1 2

伪

部

节u节

字

首
首

o

1 7 1
I  1 7

全

,4L尸

』

1087

8

部

D
字

p
节

7

4;T

据

数

15

.3.14. 1 1

1 5

13

全 0

数据 1 数据 数据 1 数 据
o

数据 1 数 据 数据 匡

填 充

.3

一

1 7 1

I 00 I I 00 I 000 I 00 I I  --- I 5 3. I 9
00001000 01 I0 1 000  --- 8.104
IO I O  I O  11 000000 I I
00001110 0000 1 011  --- 14. 1 1
00000000 000 I 000 1  --- 0 禾廿 17
00000000 0000 I 1 1 I  --- 1 5
00000 1 00 00 1 11 I I 1 -
00000000 0000 1 1 0  I  --- 1 3
00000000 00001 I 1 1   --- 1 5
00000000 00000000  --- 0 （ 检验和 ）
0 1 0 I O I 00 0 I 000 l O I  --- 数据
0 1 0 1  00 I 1  0 1 0 1 0 I 00  --- 数据
0 100 I 0 0  I O 1 0 0  1 I I O  --- 数据
0 1 000 1 1 1  00000000  --- 数 据 和 0 （ 填 充 ）

1087

今

按二进制反码运算求和 I 00 I O 1 1 0 1 1  I O I I O 1  --- 求 和 得出 的结果

将得出 的 结果求反码 0 1 1 0 1 00 1  000 1 00 1 0  --- 检验和

图5-6 计算 UDP 检验和的例 子

如图 5-6 所示 ， 伪 首部的第 3 字段是 全零 ； 第 4 字 段是 I P 首部中的协议 字段的值 。 以

前 曾 讲过 ， 对千 UDP, 此协 议 字 段值为1 7; 第 5 字段是 UDP用户 数据报的长度。 因此， 这

样的检验和 ， 既检查了 U DP用户 数据报的源端口号和目的端口号以及 UDP用户 数据报的数

据部分 ， 又检查了IP数据报的源IP地址和目的地址 。

•  21 8  •

5 . 3   传输控制协议 TC P 概述

由千 TCP 协 议比较复杂 ， 因 此 本(cid:7188) 先对 TCP 协议进行一(cid:7184)的介 绍 ， 然

后再逐步深入讨 论 TCP 的可靠 传 输 、 流量控 制和拥 塞控制等问题。

5 .3 . 1   TCP

扫 - - 扫

视频讲解

最主 要 的 特 点

TCP 是 TCP/IP 体系中非 常 复杂的一个协议。 下面介 绍 TCP 最主要的特点。
(

)  TCP 是 面 向 连 接 的 运输层协议。 这就是说 ， 应用程序在使用 TCP 协议之前， 必须先
建立 TCP 连接。 在传送数据完 毕后， 必须释放 已经建立的 TCP 连接。 也就是说 ， 应用进程
之 间的通信好像在

： 通话前要先 拨 号 建 立连接， 通话结束后要挂机释放连接。

“ 打 电 话

”

(2) 每一条 TCP 连接只 (cid:7126)有两个端 点(endpoint) ， 每一条 TCP 连接只 (cid:7126)是 点对点的（一

对一）。 这个问题后面还要进一 步 讨 论。

(3)  TCP 提供可靠交付的服务。 通过 TCP 连接传送的数据 ， 无差错 、 不丢 失 、 不重复 ，

并且按 序到达。

(4)  TCP 提供 全双工通信 。 TCP 允 许 通信 双 方的应用进程在任 何 时候 都(cid:7126)发送数据。
TCP 连接的两端 都设有发送级存和接收 缓存， 用来 临 时存放双向通信的数据。 在发送时 ，
应用程序在把数据传送给 TCP 的缓存后， 就可以做 (cid:7151) 己的事 ， 而 TCP 在合适的时候把数据
发送出去。 在接收 时 ， TCP 把 收到的数据放入 缓存， 上层的应用进程在合适的时候读取缓
存中的数据。

“

面向字(cid:7188)流

(5) 面 向 字(cid:7195)流。 TCP 中的 “ 流 ”

(stream)指的是 流入到进程或从进程流 出 的 字(cid:7195)序列。
” 的含义是： 虽然 应用程序和 TCP 的交 互是 一次一个数据块（大小不等） ， 但
TCP 把应用程序 交下来 的数据仅仅看成是 一 连串 的无结构 的字(cid:7195)流。 TCP 并不知道所传送的
字(cid:7188)流的含义。 TCP 不保证接收 方应用程序所 收到的数据块和发送方应用程序所发出的数据
块具有对应大小的关系（例如， 发送方应用程序交给发送方的 TCP 共 1 0 个数据块 ， 但接收
方的 TCP 可(cid:7126) 只 用了 4 个数据块就把收到的字(cid:7188)流交付上层的应用程序）。 但接收 方应用程
序 收到的字(cid:7188)流必须和发送方应 用程序发出的字(cid:7188)流 完 全 一样。 当然 ， 接收方的应用程序必
须有(cid:7126)力 识 别 收到的字(cid:7188)流 ， 把它还原成有意 义的应用层数据。 图 5-7 是 上述概念的示 意 图。

送 方

发

匾 应用 进程

字 节 流

回 表示 TCP 报 文段的首 部

曰 表示 序 号 为 x 的数据字节

＿

0－

流节

字

＿

l_

2一

3一

TCP连接像

条管道 ， 把字节流可靠地按序

送到 目 的进程

一

图 5-7 TCP 面 向 字节 流 的 概 念

传

•  2 1 9  •

1

