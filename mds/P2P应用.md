客户 端

服 务 器 端

s o c ke t

i b i nd

s o c ke 七

it e n

i
i

连接 建立 请求

conne c t - - - - - - -=

i
-－－－－－－－－-－－－－－－－－－-－一气卢
-:I

二 ::c----------
------
------------------

i ◄--－ － － － － － －－ －－ － － － － － －－－ － － － － －－－-－ － － － － －－

recv

s e nd

c l o s e

c l j s e

图 6-30 系 统 调 用 使 用 顺序 的 例 子

UDP 服务器 由千 只 提供无连接服务， 因此不使用 l i s 七 e n 和 a c c e p t 系统调用。

6 . 9   P2P 应 用

我们在第1 章的 1.3.1 节 中已经简单地介绍了P 2P 应用的概念。 现在我们将进

一

步 讨论

P 2P 应用的若 干 工 作 原 理。

P 2P 应用就是指具有P 2P 体系结构的网络应用。 所谓P2P 体系结构就是在这样的网络

应 用 中 ， 没有（或只有极少数的） 固 定的服务器， 而 绝大 多 数的交互 都 是 使用对等方式

(P 2P方式） 进行的。

P2P 应用的范 围很广， 例如， 文件分发、 实时音频或视 频会议、 数据库系统、 网络服务

支持（如P 2P 打车软件、 P 2P 理 财等）。 限于篇 幅， 下 面只介绍 最常用的P 2P 文件分发的工

作原理。

P 2P 文件分发不需要使用 集 中 式的媒体服务器， 而所有的音频／视频文件都是在普通的

互联网用户之间传 输的。 这其实 是相当于有很多（有时达到上 百 万个 ） 分散在 各地的媒体服

务器（ 由 普通用户的计算机充当这种媒体服务器） 向其他用户提 供所要下 载的音 频／视频文

件。 这种P 2P 文件分发方式解决了 集中式媒体服务器可能出现的瓶颈问题。

目前在互联网流量 中， P2P 工 作方式下的文件分发已 占据了最大的份 额， 比 万维网应用

所 占的比例大得多。 因此单纯从流量的角度看， P 2P 文件分发应当是互联网上最重要的应用。

现在P 2P 文件分发不仅传送音频文件M P3 , 而且还传送视频文件 (10 ~ 1000 M B , 或更大） 、

各种软件和图像文件。

6.9.1  具 有 集 中 目 录服务器 的 P2P 工作 方 式

最早使用P 2P 工作方式的是N ap s ter。 这 个名称来自19 9 9年美国东 北大学的新生 Sh aw n
个叫作 N ap s ter 的软件。 利用这个软件就可通过互联网免 费 下 载各种MP 3

F anni n g 所写的

一

• 320  •

音 乐 。 Napster 的 出 现使 MP3 成 为 网 络音 乐 事 实 上 的 标 准

。

Napster 能够搜 索 音 乐 文 件 ， 能够提供检索 功 能 。 所有 音 乐 文 件 的 索 引 信 息 都 集 中 存放

心

在 Napster 目 录服 务 器 中 。 这 个 目 录 服务器起着 索 引 的 作 用 。 使 用 者 只 要 查找 目 录服务器 ，
就 可 知 道应从 何 处 下 载所要 的 MP3 文 件 。 在 2000 年 ， Napster 成为互 联 网 上 最 流 行 的 P2P
应用 ， 并 占 据 互 联 网 上 的 通信 量 中 相 当 大 的 比例 。

这 里 的 关键就是运行 Napster 的 所有用 户 ， 都 必 须 及 时 向 Napster 的 目 录服务器报告 自
个 动 态 数据 库 ，

己 已 经存有 哪 些 音 乐 文件 。 Napster 目 录 服务器就 用 这 些 用 户 信 息 建立 起
集 中 存储 了 所有 用 户 的 音 乐 文件信 息 （ 即 对 象名 和 相 应 的 IP 地址 ） 。 当 某 个用 户 想 下 载 某 个
MP3 文 件 时 ， 就 向 目 录服 务 器 发 出 查 询 （ 这个 过程 仍 是 传 统 的 客 户 －服务器方 式 ） ， 目 录 服
务器检索 出 结 果后 向 用 户 返 回 存 放这
文 件 的 计 剪机 IP 地址 ， 千 是这 个用 户 就可 以 从 中 选
个地址 下 载想 要 得 到 的 MP3 文 件 （ 这 个 下 载过程就是 P2P 方式 ） 。 可 以 看 出 ， Napster
取

一

一

一

的 文 件传输是分散 的 ( P2P 方式 ） ， 但文件 的 定位 则 是集 中 的 （ 客 户 —服务器方式 ） 。

图 6-3 1 是 Napster 的 工 作 过程 的 示 意 图 。 假 定 Napster 目 录 服务器 已 经 建立 了 其用 户 的

动态数据 库 。 图 中 给 出 了 某个用 户 要 下 载 音 乐 文 件 的 主 要交互过程 。

Napster 集 中 式
目 录 服 务 器

I  B
勹

一1

。

'

图 6-3 1 Napster 的 工 作 过 程

0 用 户 X 向 Napster 目 录 服务器查询 （ 客 户 －服务器方 式 ） 谁 有 文 件 MP3# 。
f)  Napster 目 录服 务器 回 答 X : 有三个地 点 有 文 件 MP3# ， 即 A, B 和 C （ 给 出 了 这三 个
一

地 点 的 IP 地址 ） 。 千 是用 户 X 得 知 所 需 的 文件 MP3＃的 三 个 下 载 地 点 。

＠ 用 户 X 可 以 随机地选择三 个地 点 中 的 任

个 ， 也 可 以 使 用 PING 报 文 寻 找 最方 便 下
个 。 在 图 6-3 1 中 ， 我们假 定 X 向 A 发送 下 载 文 件 MP3＃ 的请求报文 。 现在

载 的

一

X 和 A 都使用 P2P 方式通信 ， 互 相 成为对等方 ， X 是 临 时 的 客户 ， 而对等方 A 是

临 时 的 服 务 器 。

0 对 等 方 A （ 现在 作 为服务器 ） 把 文 件 MP3＃发送给 X 。
这 种 集 中 式 目 录 服 务 器 的 最 大 缺 点 就 是 可 靠 性差 ， 而 且 会 成 为 其 性 能 的 瓶 颈 （ 尤 其 是
在 用 户 数 非 常 多 的情 况 下 ） 。 更 为 严 重 的 是 这 种 做 法 侵 犯 了 唱 片 公 司 的 版 权 。 虽 然 Napster
网 站 并没有直接非法 复 制 任 何 MP3 文件 ( Napster 网 站 不存储任何 MP3 文 件 ， 因 而 并没 有

CD 注 ： 通常 CD 光盘 中 的 音 乐 都 采 用 wav 格 式 ， 即 采 用 标 准 的 PCM 编 码 。 MP3 则进 行 了 压缩 ， 把

一

些 人 耳朵 不 太 能 够 听

出 来 的 部分频率分噩压缩 掉 了 。 压缩 比

一

般 在 I :4 到 1 : 1 2 之 间 。 例 如 ， 压缩 比 为 1 : 1 0 就 表 明 ］ 0M B 的 wav 格 式音 乐 ， 可压缩成

1  MB 的 MP3 格式 ， 而 音 质 的 下 降 并 不 太 明 显 。

•  32 1  •

直接侵 犯版权） ， 但法 院还是判 决 N ap st er 属于
N ap st er 网站就 被 迫 关 闭了 。

“

间接 侵 害 版权

”

， 因此在 2000 年 7 月底

6. 9.2  具 有 全 分 布 式结 构 的 P2P 文件共享程序

一

在 第

代 P2 P 文件共享网站 N ap st er 关 闭 后 ， 开始出现了以Gnut ell a 为代表的第二代

P2 P 文件共享程序 。 Gnut ell a 是

一

种 采用全分布方法定位 内容的 P2P 文件共享应用程 序 。

Gn ut ell a 与 N ap st er 最大的区别就是不使用集中式的 目 录服务器进行查询 ， 而是使用洪 泛法
在大量Gnut el la 用 户之间进行查询 。 为 了不使查询的通信量过大 ， Gnut ell a 设计 了

种 有 限

一

范 围 的洪泛查询 。 这 样可以减少倾注到互联网的查询流量 ， 但由 千查询的范 围受限 ， 因而这

也 影 响到查询定位的准确性 。

为了 更 加 有 效地在大量用户之间使用 P 2P 技术 下 载共享文件 ， 最近几年已经开发出很

多 种 第 三 代 P2P 共享文件程 序 [KUR 017] ， 它们使用分 散 定 位和分散传输技术 。 如 KaZaA ,
电骡 eMule , 比特洪流 BT ( Bit T o rrent )等 。

下 面对比特洪 流 BT 的主要特点进行简 单的介绍 。

在 P2P 的文件 分发应用中 ， 2001年 由 BrahmC oh en 开发的 Bi tT o rrent （中文意思是

比
个 。 取这 个名称的 原因就是 BitT o rrent 把参与某个文件分发的

) 是 很 具代表性的

一

”

特洪 流

“

所 有 对等方的 集合称为

一

个洪流(t o rrent ) 。 为了方便 ， 下 面我们使用 BitT o rrent 的简 称 BT 。

B T 把对 等方 下 载文件的数据单 元称为 文件 块(chu nk) ， 一个文件块的长度是固定不变的 ， 例

如 ， 典型的数值是 256 KB 。 当

一

个新的对等方加入某个 洪流时 ，

一

开始它并没有文件块 。

但新的对等方逐渐地能够下载到

一

些文件块 。 而与此同时 ， 它也为别的对等方上传

－

些文件

块 。 某 个对 等 方 获 得了整 个的文件 后 ， 可以立即退 出 这 个洪流 （相当千自私的用户） ， 也可

继 续 留 在 这个 洪 流中 ， 为其他的对等方上传文件块（相 当于无 私的用户 ） 。 加入或退出某个

洪 流 可 在 任何时间完成（即使在某个文件还没有 下 载完 毕时） ， 也是完全自 由 的 。

BT 的协议相 当 复 杂[W - BT ] 。 下 面 讨论其基本机制 。

一

每

个洪流都 有

一

个 基础设施 节点 ， 叫作追 踪器(t racker) 。 当

一

个对等方加入洪流时 ，

必 须 向 追 踪 器 登记（或称为注册 ） ， 并 周 期性地通知追踪器它仍在洪流中 。 追 踪器因而就 跟

踪 了 洪 流 中 的对等方 。 一个洪 流中可以拥有少到 几个多到几 百或几 千个对等方 。

一

一

我们 用 图 6-32 来进

步说 明 BT 的 工作原理 。 当

个新的对等方A 加入洪流时 ， 追踪
器 就 随 机地从参与的对等方集合中选 择 若干个（例如 ， 30 个） ， 并把这 些对等方的 IP 地址
告 诉A 。 千 是A 就和这些对等方建立 了TC P连接 。 我们称所有与A 建立了TC P连接的对
(n ei ghbo ri n gp eers ) 。 在图6 -32 中我们在上 面的覆盖网络中画出了A
等 方 为

相 邻对等方

”

”

有 三 个 相 邻 对 等方 ( B ,C 和 D ) 。 这些相邻对等方的数目是动态 变化的 ， 有的对等方可能不
久 就 离 开了 ， 但不久 后 又有新加入进来的对等方 。 请注意 ， 实 际的网络 拓 扑可能是非常复 杂

的 （ 参 见 图 6-32 覆盖网络 下 面的实际网络图） 。 我们知道 ， TC P连接只是个逻辑连接 ， 而每
一
个 TC P连接可能会穿越很多的网络 。 因此我们在讨论问题时 ， 可以利用实 际网络上 面的

一

个更 加 简 洁 的 覆盖网络 ， 这个覆盖网络 忽 略了实 际网络的许多细 节 ， 使问题的讨论 更加方

便 。 在 覆盖 网络中 ， A 的三 个相 邻对等方就看得很清楚 。
一

一

在 任 何 时 刻 ， 每

个对 等方可能只拥有某文件的

个文件块子 集 ， 而不同的对等方所

拥有 的 文件块 子 集也不会 完全相 同 。 对等方A 将通过TC P连接 周 期性地向其相邻对等方索

取 它 们 拥 有 的文件块列表 。 根据收到的文件块列表 ， A 就知道了应当请求哪

一

个相邻对等方

• 322  •

把哪些 自 己 缺 少 的 文件块发送过来 。

，

,

'

｀
，

，

＇

/

\
B

覆 盖 网 络

网下心实

络

，

、

、

'

,

'

｀

，

｀

,
＇

,
＇

C

。\

图 6-32 在 覆盖 网 络 中 对等 方 的 相 邻 关 系 的 示 意 图

图 6-33 是对等方之 间 互相 传送数据 块 的 示 意 图 。 例 如 ， A 向 B 、 C 和 D 索 取数据块 ，

一
但 B 同 时 也 向 C 和 D 传送 数据 块 ， D 和 C 还互 相 传 送 数据块 。 由 于 P2P 对等用 户 的 数 量 非

常 多 ， 因 此 ， 从不 同 的对等方 获得不 同 的 数 据块 ， 然 后 组装成整 个 的 文 件 ， 一般要 比 仅 从
个地方 下 载整 个 的 文件要快很 多 。

图例：

对 等 方 B

对 等 方 A

/

＼
厂

对等 方 D

＼ 二二
L  __J
对等方 C/

又 一 ］

图 6-33 对等方之 间 互相 传 送 文件数据块

一

然 而 A 必 须 做 出 两 个 重 要 决 定 。 第

， 哪 些 文 件 块 是 首 先 需 要 向 其 相 邻 对 等 方请求 的 ？

第 二 ， 在 很 多 向 A 请 求 文 件 块 的 相 邻 对 等 方 中 ， A 应 当 向 哪 些 相 邻 对等方发送所请 求 的 文
件块 ？

一

对 千 第

个 问 题 ， A 要 使 用 叫 作 最稀有 的优先(rarest first) 的 技 术 。 我 们 知 道 ， 凡 是 A 所
缺 少 的 而 正 好 相 邻 对 等 方 已 拥 有 的 文件块 ， 都应 当 去 索 取 。 可 能其 中 的 某 些 文 件 块 ， 很 多 相
邻 对 等方 都 有 （ 即 文件块 的 副 本 很 多 ） ， 这就是
不 稀 有 的
文 件 块 ， 以 后 可慢慢请 求 。 如
果 A 所缺少 的 文件块在 相 邻 对等 方 中 的 副 本很少 ， 那 就是
。 因 此 ， A 首 先应 当
很稀有 的
请 求 副 本 最 少 的 文 件 块 （ 即 最 稀 有 的 ） 。 否 则 ， 一 旦 拥 有 最 稀 有 文 件 块 的 对 等 方 退 出 了 洪 流 ，
就会影响 A 对所缺 文件块 的 收 集 。

一

“

“

＂

“

对 千 第 二 个 问 题 ， BT 采用 了

种 更加机灵 的 算法 ， 其基本 思 想 就 是 ： 凡 当 前有 以 最 高

数据 率 向 A 传 送 文 件 块 的 某 相 邻 对 等 方 ， A 就优先把所请 求 的 文件块传送给该相 邻对 等 方 。

具 体来 说 ， A 持续地测 量 从 其 相 邻 对 等 方接收数据 的 速 率 ， 并确 定速率最 高 的 4 个 相 邻 对 等
方 。 接 着 ， A 就把文件块发送给这 4 个 相 邻 对等 方 。 每 隔 1 0 秒 钟 ， A 还 要 重 新计算数据 率 ，

•  323  •

然 后 可 能 修 改这 4 个 对 等 方 。 在 BT 的 术 语 中 ， 这 4 个 对 等 方 叫 作 已 疏 通 的 或 无障碍的

一

(unchoked)对等方 。 更 重要 的 是 ， 每 隔 30 秒 ， A 要 随机地找

个 另 外 的 相 邻 对 等方 B , 并 向

其发送文件块 。 这样 ， A 有 可 能 成为 B 的 前 4 位上传 文件块 的 提供者 。 在此情况下 ， B 也
有 可 能 向 A 发 送 文 件 块 。 如 果 B 发送 文件块 的 速 率 足 够快 ， 那 么 B 也有 可 能进入 A 的 前 4
位 上 传 文件块 的 提供者 。 这样做 的 结 果 是 ， 这些对等 方相 互之 间 都 能够 以 令人满意 的 速 率 交

换 文 件 块 。
6.9.3  P2P 文件分发 的 分析

一

一

个 例 子 开 始 ， 来讨 论 P2P 文件分发 中 的 几个重要概念 [KUR0 1 7] 。

我 们 从
在 图 6-34 中 ， 有 N 台 主 机要从互联 网 上 的 服务 器 下 载

个 大 文 件 ， 其长度为 F bit 。 在
图 中 我们 把这个 文 件 也 记 为 F。 按 照 习 惯 ， 从 互 联 网 传 送 数据 到 主 机 ， 叫 作 下载(download) ,
而 反 过 来 传 送 数据 ， 即 从主 机 向 互 联 网 传 送 ， 则 称 为 上传(upload)或上载 。 服 务 器 的 文 件 是
供 互联 网 上 的 用 户 享用 的 ， 因 此服 务 器 的 文 件 只 是单方 向 上传 到 互 联 网 。 我们 把服务器 的 上
单 位 是 bit/s 。 再假 定 主机与 互联 网 连接 的 链 路 的 上传速率和 下 载速 率 分别 为
和 心 单 位都是 bit/s 。 我们 还 假 定 互联 网 的 核 心 部 分 不 会 产 生 拥 塞 。 瓶颈 只 会 发 生 在 服 务
u
器 的 接入链路 ， 或者是某些主机 的接入链 路 。J

传 速率记为
i

Us ,

l/
l 了

dN  J

/

UN

）

J三三～

～
d2

\

互 联 网

U3

JI/ d3 ＃

U4

文 件 F

u s
畸-「

服 务 器

图 6-34 文件 分 发 的 例 子

我 们 先 在 传 统 的 客 户 －服 务 器 方 式 下 ， 计算给所有主机分发完毕 的 最 短 时 间 Tc

s

o

从服务器端考虑 ， N 台 主机共 需要从服务器得 到 的 数据 总 量 （ 比特数 ） 是 NF。 如 果服

Us

务 器 能 够 不 停 地 以 其 上 传 速 率

s

向 各 主 机 传 送 数 据 ， 一 直 到 各 主 机 都 收 到 文 件 F, 就 需 要

舒

es

时 间 NF/u

, 单位 是 秒 。 由 此可见 ， T

不 可 能 小 千 NF/u

如 果 N 台 主 机都 以 各 自 的 下 载速率不停地 下 载 文 件 F, 那 么 下 载速率最慢 的 主机 （ 设

min

min

一

其 下 载速 率为 d

) 的 下 载 文件 时 间 ( Fld

m

) ， 将 是 N 个 下 载 时 间 中 最 大 的

个 。 由 此可 见 ，

几 也 不 可 能 小 千 Fld

s

in 。
m

=

es

如 果 NF/u
min

?:  Fld

in , 则 瓶颈在服务器端 的接 入链路 。 这 时 T
s

NF/u
es

舒

=

min

如 果 Fld

?:  NF/u

, 则瓶颈 在 下 载最慢 的 主 机 的接入链路 。 这 时 T

F/d

o

•  324  •

由此可得出所有主机都 下载完文件 F 的最少时间是

�s  = max { !ff, 三｝

( 6- 2)

从以上分析可以看出， 若公式(6 - 2)括 号中的第

一
项大于第二项， 则 几 就与主机数 N 成

正 比。 如果主机数增大1000 倍， 那么 文件的分发时间也要增大1000 倍 。

下 面讨论在P2P 方式下 ， 文件全部分发完毕的最少时间 Tp2p。 然而在P2P 方式下 ， 文

件分发所需的时间较难计算， 这 是 因为每

一

台 主机在接收文件的同时， 还利用自己的上传能

力向其他主机传送文件。 文件传送所需的时间取 决千主机向对等方传送文件的具体方式。 但

是， 我们还是可以导出文件分发所需的最少时间的表达式。

在文件分发开始时， 只有服务器有文件 F。 服 务器必须把文件 F 的每

一

个比特通过接入

链 路传送到互联网（至少要传送

一

次）。 因此文件分发的最少时间不可能小千 Flus。 和客户－

服务器方式相比， 在P2P 方式下， 服务器不需要

一

一

遍

遍地发送文件 F , 因为互联网上的其

他主机（即对等方） 可以代 替服务器向其他对等方分发文件 F。

在P2P 方式下 ， 下 载速率最慢的主机（设其下载速率为 dnun) 下 载文件 F 的时间是 Fldrmn '

这 是 N 个对等方下 载时间中最大的

结论和 客户－服务器方式是

一

样的。

一

个。 可见文件分发的最少时间不可能 小 于 Fldmin。 这 个

整个系统中所有主机（包括服务器） 的上传速率之和是 UT =  Us

U I

U2

UN。 因此，

文件分发的最少时间也不可能 小 千 NF/uT。

+

+

+ .. .  +

这样， 我们得出在P2P 方式下所有主机都 下 载完文件 F 的最少时间的下 限是

TP2P >  max {：，t，曰

( 6- 3)

在公式(6-3)的推 导过程中， 我们假定每

一

个对等方只要收到

一

个比特就立即上 传到 互

联网的其他对等方。 但实 际上是把收到的若 干个比特组成

一

个数据块后 再上传出去。 但是 当

文件 F 很大时， 我们 也可以在公式(6 -3)中取等 号， 作为文件 F 的最少分发时间 TP2P 的近似

值。

有

一

中的最后

种情况最值得我们注 意 。 这 就 是对等方的数目 N 非常大， 因此在公式(6- 3)的括 号
一
项的值将大千前两项的值。 这样， TP2P 值的下限就 近似为 NF/uT o

一

我们再假定

些数据。 设所有的对等方的上传速率都是 U , 并且 Flu

= l 小时， 所有对
等方的下载速率都不小于服务器的上传速率， 因而不会对我们的计算产生影响。 我们再设服
=30 时， 用公式(6 -3)算出所有主机都 下载完文件 F 的最少时
定小 于1 小时）。 如果采用客户－服务器

=lOu。 当 N
务器的上传速率 Us
间的下 限是 Tp2p = 0.7 5  Flu  = 0.7 5 小时 （ 这个数值
方式， 则当 N

=30 时， 所有主机都 下 载 完文件 F 的最少时间是 Tes

= NF/us

= 3 小时。

一

6.9.4  在 P2P 对等方 中 搜索 对 象

在P2P 文件 系 统中， 对等方用户的数量非常多， 并且处 于

一

种无序的状态。 任何

一

个

对等方可以随时加入进来或随时退出。 在这种情况下， 怎样有 效地找到所需的文件， 也就是

怎样有 效地定位对等方及其 资源， 乃是P2P 系统中的

一

个十分重要的问题。

限千篇 幅， 我们在这里只简单介绍

一

下 怎样利用散 列 函 数来定位对等方。

• 32 5  •

我们知道， Gnut ell a 是

一

种采用全分布方法定位内容的P2P 文件共享应用程序， 它解决

了 集 中式目录服务器所造成的瓶颈问题。 然而Gnut ell a 是在非结构化的覆盖网络 中 采用查询

洪 泛的方法来进行查找的， 因此查找的效率较低。 现在比较好的查找方法是设法构建

一

种分

布式数据库， 以进行对等方及其 资源的定位。 这 种分布式数据库在概念上并不 复 杂， 只要能

够 支持大量对等方（可能 有几 百 万个） 进行索 引 查找即可。 存储在数据库 中的信息只有两个

部分 ：

(1 ) 要查找的资源名 K（例如， 电影或歌 曲 的名字）。 资源名也可称为关键字。
(2 ) 存放该对 象的节 点的 IP 地址 N。 有的IP 地址还附带有端 口 号。

存放在数据 库中的信息就是大量成对出现的（ 资源名 K , 节点的IP 地址N )。 在查找某

资源名 K 时， 只要在数据库 中查找到 匹配的 资源名 K , 数据库就能够返回对应的节点的 IP

地址N 。 所以问题的关键就是要设法把每个 资源名 K 存放在

一

个非常便千查找的地方。

细心的读者可能会联想到曾在前面 6.1 节 讨论的 DN S 域名系统。 DNS 是根据主 机的域

名来查找其 I P 地址， 这 和P2P 的情 况 有相似之处。 但 我们知道， 主机的域名是结构化的命

名系统， 因此域名服务器可以 划分为 几 种不同的级别 （如根服务器等） 便于查找。 但 P2P

系统则不同， 其 资源名是非结构化的。 因此不能 套用 DN S 的那种查找方法。

前面已经讲过， N ap st er 在

一

个 集 中 式目录服务器中构建的查找数据库 虽然很简 单， 但

性能上却 有瓶颈。 在 P2P 系统 中， 应怎样构建分布式的P2P 数据库？让每个对等方都拥有
所有对等方I P 地址的列表是不可行的。 让所有成对出现的（ 资源名 K ,IP 地址 N ) 随机地分

散到各对等方也是不可行的。 因为这 将使查找对 象的次数过大， 无法使用。 现在广 泛使用的

索 引 和查找技术 叫作分布式散列表 DHT

( Dis tri but ed  Hash  Tabl e)。 DHT 也 可译为分布式哈希

表 ， 它是 由 大量 对等方共同维护的散列表。 基于 DHT 的具体算法已 有不 少 ， 如Chord ,
(Cont ent  Address abl e N etw ork)， 以及 Kad emi li a 等。 下 面简 单介绍 广 泛使用的
P astry, CAN

Chord 算法， 这是美国麻省 理 工大学千2001年提出的[S TO I Ol ]。

分布式散列表 DHT 利用散列 函 数， 把 资源 名 K 及其存放的节点 IP 地址 N 都分别映 射

为资源名标识符 KI D 和节 点标识符NI D。 如果所有的对等方都使用散列 函数S HA - I（我们

一

在下

章 7.3.1 节 还要介绍 SHA-1 在网络安全方面的应用）， 那么 通过 散列得出的标识符

1 60

KID 和 NI D 都是1 60 位二进制数字， 且其数值 范 围在[O ,2

—l]之间。 虽然从理论上讲， 散

列 函数 S HA-1 是多对

的 函 数， 但实际上不同输入得到相同的输 出的概率是极 小的。 此外，
通过S HA-1 映 射得到的标识符能够比较均 匀而稀疏地分布在Chord 环上。 为便千讨论， 我

一

们假定现在标识符只有 5 位 二进制 数字， 也就是说， 所有经散列 函数得出的标识符的数值范

围都在[O, 31 ]之间。Chord 把节点按标识符数值从小到大沿顺时针排列成

一

个环 形覆盖网络

（ 见图6 -35 (a)）， 并按照下 面的规则进行 映 射 ：

(1 ) 节点标识符NI D 按照其标识符 值 映 射到Chord 环上对应的点， 见图6 -35 (a)中标有

N ID 的 小 圆点， 如N 4 ,N 7 , N lO , N20 , N26 和 N30 。

一

个NI D , 见图6 -36 (a)

(2 ) 资源名标识符 KID则按照其标识符值映射到与其值最接近的下

中标有 KI D 的 小方块。 所谓

“

最接近的下

一

个

“

NI D 就是指： 从 KID 值 开始， 按顺时针方

向 沿Chord 环 遇到的下

一

个 NI D。 例 如， K31 和 K2 应放在N 4 , 因为在环上从31 和2 按顺

时针方向遇到的下

一

个N ID 是N 4 。 同理， K8 , K12 , K23 和 K2 9 应分别放在N lO ,N20 , N26

和N30 。 如果碰巧同时出现 K2 9 和N2 9 （这 种概率极小）， 那么 K2 9 就应当放在N2 9 。

请注意 ： 在图6 -35 中， K31 和 K2 都放在N 4 , 这 表示要查找存放 资源 K31 或 K2 的节

• 326  •

点的 IP 地址， 就应当到节点 N4 去 查找。 请 注意， 资源 K31 和 K2 并 非存放在节点 N4 。

这 就是说， 每个 资源 由Cho rd 环 上与其标识符值最 接近的 下

个 节点提供服务。 我们
下 ， Cho rd 环并非实 际的网络。 在Cho rd 环上相邻的节点， 在地理上很可能相距 非

一

一

再 强 调
常远。 亘

：

：

言

4

22
2 1

1 2
9  1 8 , 勹 . , 1 C   1 4  1 3

)

l'

II

2
J

，

(a) KID 和 NID 映射在环上

(b) N 1 3 加 入 ， N26退 出

图 6-3 5基于 DHT的 Chord环

Cho rd 环 上的每

一

个 节点都要维护两个指针变量，

一

个指向其后继 节点， 而 另

一

个指向
一

其前任节点。 例如， 在图6 -35 (a)中， N l O 的后继 节点是 N20 ( N l O 沿顺时针方向的下
节点）， 其前任节点是 N7 ( N l O 沿逆时针方向的前
个新的节点N l3 加入
进来， 那么 N20 的前任 节点就变为Nl3, 因而 K l 2 就要从 N20 的位置移到N l3, 同时 N l O
的后继 节点就 变为 Nl3（见图6 -35 (b )）。 此外， 如果 节点 N 26 退出， 那么 K23 就要移到

个节点）。 如果

个

一

一

N30, 而N30 的前任节点就变为 N20, 同时 N20 的后继 节点变为 N30 。

在这样的Cho rd 环 上查找 资源， 从理论上讲， 任何

一

个节点， 只要从其后继 节点

一

个

个地遍历 查找 下 去，
查找报文 N/2 个， 或遍历 O( N)个节点 ( N 为环上的总 节点数）。 显然， 这种顺序 查找的方法

定可以找到所查询的 资源。 可见要定位

个 资源， 平均需要沿环发送

一

一

效率很低。

为了加速 查找， 在Cho rd 环上可以增加

些指针表( fin ge r t ab le )， 它 又称为路 由 表或 查
找器表。 若Cho rd 环上的标识符有 m 位（现在 m = 5 )， 则在节点 n 上的指针表可设置不超
过 m 个指针， 指向其后继的 节点。 我们先看 图 6- 36 中节点N 4 的指针表。 指针表中的第 2

一

列是从 N4 可以指向的多个后继 节点。 本来每

一

个节点仅仅指向沿顺时针方向的下

一

个后继

l

节点， 但现在则指向多个后继 节点（在本 例中就是N 7 , N I O 和N 20 )。 第1列的第i 行是计
- l )， 用来得出后继 节点。 例如， 第4 行 i = 4, 算出 ( N4 + i - 1 ) = N4 + 8 =  1 2,
算 (N 4 + 2
而Cho rd 环上的节点 1 2 的后继 节点是 N20 。 图中还画出了从N 4 到这几个后继 节点的连线
（这些连线就是Cho rd 环上的 弦， Cho rd 名字 由此得出）。 还有
点要注意的是， 在N 20 的
指针表中的第5 行， N 20 + 16  = 36, 但按照模 2
点是N 4 。

= 4, 恰好 节点4 的后继 节

运算， 36 mod  2

一

5

5

假定在图6 -36 中的节点N 4 要 查找 K29 。 如果用遍历各 节点的方法， 则要 查找 5 次，

即 N7 -N I O -N 20 �N 26 �N30 。 但若利用指针表， 则 N4 首先在自己的指针表中寻找在不
到 29 且最接近 29 的节点， 即 N20, 然后把定位 资源 K29 的请求发送给N 20 。 在 N20 的指

针表中继续类似的寻找。 结果是： 最接近 29 的节点是 N30 。 这就是存放资源 K29 的节点。

这种查找方法类似于二分查找， 只用了两次查找， 定位

一

个 资源仅需 O(lo g2N)步。

• 327  •

N4 的指针表

N20 的指针表

2

图 6-36 节 点 N4 和 N20 的 指 针表

在 P2P 网 络 中 ， 对 等 方 可 能 相 当 频 繁 地 加 入 或 退 出 系 统 ， 这就 需 要 很 好 地 维 护 这 个 分
布 式 数据 库 （ 维护 各节 点 的 指 针 和 指 针 表 ） ， 而 这 种 维 护 的 工 作 量可 能会 很 大 。 当 对 等 方 数
量 非 常大 时 ， 究竟采用 何 种 查 询 机制 更 加 合理 ， 则 需要 根据 具 体情况来确 定 。

一

P2P 技 术 还 在 不 断地 改进 ， 但 随 着 P2P 文 件 共 享 程 序 日 益 广 泛 地 使 用 ， 也 产 生 了

系

一

列 的 问 题 有 待 千 解 决 。 这 些 问 题 已 迫 使 人们 要 重 新 思 考 下

代 互 联 网 应 如 何 演 进 。 例 如 ，

一

音 频／视 频 文 件 的 知 识 产权就 是 其 中 的

个 问 题 。 又 如 ， 当 非法 盗 版 的 、 或不健康 的 音 频／视

频 文 件在 互 联 网 上利 用 P2P 文件共享程序广泛传播 时 ， 要对 P2P 的 流量进行有 效 的 管 理 ，

在 技 术 上 还 是 有 相 当 的 难 度 。 由 于 现在 P2P 文 件 共 享 程 序 的 大 量使 用 ， 已 经 消 耗 了 互联 网
主干 网 上 大 部 分 的 带 宽 。 因 此 ， 怎 样制 定 出 合理 的 收 费 标准 ， 既 能够 让广 大 网 民接 受 ， 又 能
使 网 络运 营 商赢利 并 继 续 加 大 投 入 ， 也 是 目 前迫切 需要解 决 的 问 题 。
本章的 重要概念

一

•  本 章 所讨论 的应用 程序 是 为 了 解 决 互联 网 上 的 某

类应用 问 题 的 软件 ， 而这些应用
问 题 的 解 决又必 须通过位 于 不 同 主机 中 的 多 个应用 进程之 间 的 通 信 和 协 同 工作 来 完

成 。 应 用 层 协 议 规 定 了 应用 进程在通信 时所遵循 的 各种规则 。 应用 层协 议 是 为 应 用

程 序 的 实 现服务 的 。

•  应用 层 的 许 多 协议 都 是 基 于 客 户 服务器 方 式 的 。 客 户 是 服务请求方 ， 服 务 器 是 服务

提供方 。

一

•  域 名 系 统 DNS 是 互 联 网 使 用 的 命 名 系 统 ， 用 来把 便 千 人 们 使用 的机器名 字转换为

IP 地址 。 DNS 是

个联机分布式数据库 系 统 ， 并采用 客 户 服务器方式 。

•  域 名 到 IP 地 址 的 解 析 是 由 分布 在 互联 网 上 的 许 多 域 名 服务器程序 （ 即 域 名 服务器 ）

共 同 完成 的 。
一

一

•  互联 网 采 用 层 次树状结 构 的 命 名 方 法 ， 任 何

一

台 连接在互联 网 上 的 主机或路 由 器 ，

个 唯
都 有
点 没有对应关 系 。

的 层 次结 构 的 名 字 ， 即 域 名 。 域 名 中 的 点 和 点 分十进制 IP 地址 中 的

•  域 名 服 务 器 分 为 根 域 名 服 务 器 、 顶 级 域 名 服 务 器 、 权 限 域 名 服 务 器 和 本 地 域 名 服

务器 。

•  文件传送协议 FTP 使用 TCP 可靠的运输服务 。 FTP 使 用 客户 服务器方式 。 一 个 FTP

服务器进程可 同 时 为 多 个 客 户 进程提供服务 。 在 进 行 文件传输时 ， FTP 的 客 户 和 服

务 器之 间 要建 立 两 个 并 行 的 TCP 连接 ： 控 制 连接 和 数 据 连接 。 实 际用 于 传 输 文 件

•  3 2 8  •

