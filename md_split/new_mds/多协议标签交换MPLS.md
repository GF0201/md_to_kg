全球IP地址。
显然，通过NAT路由器的通信必须由专用网内的主机发起。设想如果有专用网上外面
的主机要发起通信，当IP数据报到达NAT路由器时，NAT路由器就不知道应当把目的IP
地址转换成专用网内的哪一个本地IP地址。这就表明，专用网内部的主机不能直接充当服
务器用。
为了更加有效地利用NAT路由器上的全球IP地址，现在常用的NAT转换表把运输层
的端口号也利用上。这样，就可以使多个拥有本地地址的主机，共用NAT路由器上的一个
全球IP地址，因而可以同时和互联网上的不同主机进行通信[COME06]。
由千运输层的端口号将在下一章5.1.3节讨论，因此，建议在学完运输层的有关内容后，再学习下面的内容。但从系统性方面考虑，把下面的这部分内容放在本章中介绍较为合适。
使用端口号的NAT也叫作网络地址与端口号转换NAPT(NetworkAddressandPort
Translation)，而不使用端口号的NAT就叫作传统的NAT(traditionalNAT)。但在许多文献中
并没有这样区分，而是不加区分地都使用NAT这个更加简洁的缩写词。表4-9说明了
NAPT的地址转换机制。
表4-9NAPT地址转换表举例方向字段原先的IP地址和端口号转换后的IP地址和端口号从专用网发往互联网源IP地址TCP源喘口192.168.0.330000从专用网发往互联网源IP地址TCP源端口I921680430000从互联网发往专用网目的IP地址TCP目的端口17238.15-4000I从互联网发往专用网目的IP地址TCP目的瑞口17238.154000217238I5.40001172.38.1540002192168.0330000I921680430000从表4-9可以看出，在专用网内主机192.168.0.3向互联网发送IP数据报，其TCP端口
号选择为30000。NAPT把源IP地址和TCP端口号都进行转换（如果使用UDP,则对UDP
的端口号进行转换。原理是一样的）。另一台主机192.168.0.4也选择了同样的TCP端口号
30000。这纯属巧合（端口号仅在本主机中才有意义）。现在NAPT把专用网内不同的源IP地址都转换为同样的全球IP地址。但对源主机所采用的TCP端口号（不管相同或不同），
则转换为不同的新的端口号。因此，当NAPT路由器收到从互联网发来的应答时，就可以从IP数据报的数据部分找出运输层的端口号，然后根据不同的目的端口号，从NAPT转换
表中找到正确的目的主机。
应当指出，从层次的角度看，NAPT的机制有些特殊。普通路由器在转发IP数据报时，对于源IP地址或目的IP地址都是不改变的。但NAT路由器在转发IP数据报时，一定要更
换其IP地址（转换源IP地址或目的IP地址）。其次，普通路由器在转发分组时是工作在网
络层的。但NAPT路由器还要查看和转换运输层的端口号，而这本来应当属于运输层的范
畴。也正因为这样，NAPT曾遭受了一些人的批评，认为NAPT的操作没有严格按照层次的
关系。但不管怎样，NAT（包括NAPT)已成为互联网的一个重要构件[RFC3022]。
4.9多协议标签交换MPLSIETF于1997年成立了MPLS工作组，为的是开发出一种新的协议。这种新的协议就是
多协议标签交换MPLS(MultiProtocolLabelSwitching)。“多协议”表示在MPLS的上层可以•189•采用多种协议。IETF还综合了许多公司的类似技术，如思科公司的标签交换(TagSwitching),
以及Ipsilon公司的IP交换(IPSwitching)等。2001年1月MPLS终于成为互联网的建议标准
[RFC3031,3032]。
MPLS利用面向连接技术，使每个分组携带一个叫作标签(label)CD的小整数（这叫作打
上标签）。当分组到达交换机（即标签交换路由器）时，交换机读取分组的标签，并用标签
值来检索分组转发表。这样就比查找路由表来转发分组要快得多。
人们经常把MPLS与异步传递方式ATM(AsynchronousTransferMode)联系起来，这仅
仅是因为它们都采用了面向连接的工作方式。以前很多人都曾认为网络的发展方向是以
ATM为核心的宽带综合业务数字B-ISDN。然而价格低廉得多的高速IP路由器仍然占领了
市场，最终导致ATM技术和B-ISDN未能够成为网络的发展方向。MPLS并没有取代IP,
而是作为一种IP增强技术，被广泛地应用在互联网中。
MPLS具有以下三个方面的特点：（1)支持面向连接的服务质量。
(2)支持流量工程，均衡网络负载。
(3)有效地支持虚拟专用网VPN。
下面讨论MPLS的基本工作原理。
4.9.1MPLS的工作原理1．基本工作过程在传统的IP网络中，分组每到达一个路由器，都必须查找转发表，并
按照“最长前缀匹配＂的原则找到下一跳的IP地址（请注意，前缀的长度
是不确定的）。当网络很大时，查找含有大量项目的转发表要花费很多的时间。在出现突发视频讲解性的通信量时，往往还会使缓存溢出，这就会引起分组丢失、传输时延增大和服务质量下降。
MPLS的一个重要特点就是在MPLS域的入口处，给每一个IP数据报打上固定长度
”标签＂，然后对打上标签的IP数据报用硬件进行转发，这就使得IP数据报转发的过程大
大地加快了气采用硬件技术对打上标签的IP数据报进行转发就称为标签交换。“交换”也
表示在转发时不再上升到第三层查找转发表，而是根据标签在第二层（链路层）用硬件进行
转发。MPLS可使用多种链路层协议，如PPP、以太网、ATM以及帧中继等。图4-66是
MPLS协议的基本原理的示意图。
MPLS域(MPLSdomain)是指该域中有许多彼此相邻的路由器，并且所有的路由器都是
支持MPLS技术的标签交换路由器LSR(LabelSwitchingRouter)。LSR同时具有标签交换和
路由选择这两种功能，标签交换功能是为了快速转发，但在这之前LSR需要使用路由选择
功能构造转发表。
CD江：label的标准译名本来是献中的译名“标签＂。
““标号””＠注：有的公司愿意用第三层交换因而编者小主张使用这一术语。
•190•[MJNGCI94]，但此译名未被普遍接受。本书曾采用译名＂“标记，现在改用多数文“＂表示第三层的路由选择功能加上第二层的交换功能。但这样的术语不够明确，-－----------
-·MPLS域－－、、、一一J二二MPLS
入口节点A少｀、、、、、、灶f
\JJrf[
 誓rJ的／}一，上
分签
和
五
组/-------------/LS，/点节靠
Eg标签交换路由器LSR二普通IP分组二项打上标签的分组己已普通路由器图4-66MPLS协议的基本原理图4-66中给出了MPLS的基本工作过程，解释如下：
(1)MPLS域中的各LSR使用专门的标签分配协议LDP(LabelDistributionProtocol)交换
报文，并找出和特定标签相对应的路径，即标签交换路径LSP(LabelSwitchedPath)。例如
在图中的路径A-B-C-D。各LSR根据这些路径构造出转发表。这个过程和路由器构造
自己的路由表相似[RFC3031]，限千篇幅，这里不讨论转发表构造的详细步骤。但应注意的
是，MPLS是面向连接的，因为在标签交换路径LSP上的第一个LSR就根据IP数据报的初
始标签确定了整个的标签交换路径，就像一条虚连接一样。
(2)当一个IP数据报进入到MPLS域时，MPLS入口节点(ingressnode)就给它打上标签
（后面我们就会知道，这实际上是插入一个MPLS首部），并按照转发表把它转发给下一个
LSR。以后的所有LSR都按照标签进行转发。
给IP数据报打标签的过程叫作分类(classification)。严格的第三层（网络层）分类只使用了IP首部中的字段，如源IP地址和目的IP地址等。大多数运营商实现了第四层（运输层）分类（除了要检查IP首部外，运输层还要检查TCP或UDP首部中的协议端口号），而有些运
营商则实现了第五层（应用层）分类（更进一步地检查数据报的内部并考虑其有效载荷）。
(3)由千在全网内统一分配全局标签数值是非常困难的，因此一个标签仅仅在两个标签
交换路由器LSR之间才有意义。分组每经过一个LSR,LSR就要做两件事：一是转发，二
是更换新的标签，即把入标签更换成为出标签。这就叫作标签对换(labelswapping)＠。做这
两件事所需的数据都已清楚地写在转发表中。例如，图4-66中的标签交换路由器B从入接
口0收到一个入标签为3的IP数据报，查找了如下的转发表：|入尸I入尸I出尸I出＊尸I标签交换路由器B就知道应当把该IP数据报从出接口1转发出去，同时把标签对换为1。
当IP数据报进入下一个LSR时，这时的入标签就是刚才得到的出标签。因此，标签交换路由器C接着在转发该IP数据报时，又把入标签l对换为出标签2。
CD汁：这里使用[RFC3031]中的标准词汇。”对换和交换的意思相近，但对换更强调两个标签互相对换（把入标签更换为出标签）。虽然MPLS中的LS是表示标签交换”，但标签交换路由器LSR实现的功能是
“”＂““＂标签对换。
“”•191•(4)当IP数据报离开MPLS域时，MPLS出口(cid:7195)点(egresnode)就把MPLS的标签去除，把IP数据报交付非MPLS的主机或路由器，以后就按照普通的转发方法进行转发。
上述的这种“由入口LSR确定进入MPLS域以后的转发路径”称为显式路由选择(explicitrouting)，它和互(cid:7110)网中通常使用的“
区别。
下面再讨论MPLS中的几个重要概念。
2.转发等价类FEC每一个路由器逐跳进行路由选择“有着很大的MPLS有个很重要的概念就是转发等价类FEC(ForwardingEquivalenceClass)。所谓“转发等价类”就是路由器按照同样方式对待的IP数据报的集合。这里”
待按照同样方式对
表示从同样接口转发到同样的下一跳地址，并且具有同样服务类别和同样丢弃优先级等。
”FEC的例子是：(1)目的IP地址与某一个特定IP地址的前缀匹配的IP数据报（这就相当于普通的IP路由器）；(2)所有源地址与目的地址都相同的IP数据报；(3)具有某种服务质量需求的IP数据报。
总之，划分FEC的方法不受什么限制，这都由网络管理员来控制，因此非常灵活。入
口节点并不是给每一个IP数据报指派一个不同的标签，而是将属于同样FEC的IP数据报
都指派同样的标签。FEC和标签是一一对应的关系。
图4-67给出一个把FEC用千负载均衡的例子。图4-67(a)的主机凡和H2分别向压和
儿发送大量数据。路由器A和C是数据传输必须经过的。但传统的路由选择协议只(cid:7126)选择最短路径A-B-C，这就可(cid:7130)导(cid:7175)这段最短路径过载。
H1三、八一c/三凡
H2＝厂＼占一一只三H4(a)传统路由选择协议使最短路径A一B-C过载三H4(b)利用FEC使通信擢较为均衡图4-67FEC用千负载均衡图4-67(b)表示在MPLS的情况下，入口(cid:7188)点A可设置两种FEC:“源地址为凡而目的
地址为H产和＂
源地址为压而目的地址为H4"，把前一种FEC的路径设置为H！-A-B­
C-H3,而后一种的路径设置为H2-A-D-E-C-H4。这样可使网络的负载较为均衡。网
络管理员采用(cid:7149)定义的FEC就可以更好地管理网络的资源。这种均衡网络负载的做法也称为流量工程TE(TrafficEngineering广或通信量工程。
CD许：流量工程是对网络上的通估屉进行测星、建模和控制，使网络运行的性能得到最优化。
•192•s
4.9.2MPLS首部的位置与格式MPLS并不要求下层的网络都使用面向连接的技术。因此一对MPLS路由器之间的物理
连接，既可以由一个专用电路组成，如OC-48线路，也可以使用像以太网这样的网络。但
是这些网络并不提供打标签的手段，而IPv4数据报首部也没有多余的位置存放MPLS标签。
这就需要使用一种封装技术：在把IP数据报封装成以太网帧之前，先要插入一个MPLS首
部。从层次的角度看，MPLS首部就处在第二层和第三层之间（如图4-68所示）。在把加上MPLS首部的IP数据报封装成以太网帧时，以太网的类型字段在单播的情况下设置为
884716（下标16表示这是十六进制的数字），而在多播的情况下为884816。这样，接收方可
以用帧的类型来判决这个帧是携带了MPLS标签还是一个常规的IP数据报。
尸:匕插入M
数据链路层图4-68MPLS首部的位置图4-69给出了MPLS首部的格式。可见“给IP数据报打上标签“其实就是在以太网的
帧首部和IP数据报的首部之间插入一个4字节的MPLS首部。具体的标签就在“标签值”
这个字段中。
位以太网帧I帧首部1MPLS首部IIP首部IIP数据部分1帕尾部1发送在前IIP数据报I图4-69MPLS首部的格式MPLS首部共包括以下四个字段：
(1)标签值占20位。由于一个MPLS标签占20位，因此从理论上讲，在设置MPLS时可以使用标签的所有20位，因而可以同时容纳高达220个流（即1048576个流）。
但是，实际上几乎没有哪个MPLS实例会使用很大数目的流，因为通常需要管理员人工管
理和设置每条交换路径。
(2)试验
(3)S
(4)生存时间TTL占3位，目前保留用千试验。
占1位，S(Stack)表示栈，在有“标签栈”时使用。
占8位，用来防止MPLS分组在MPLS域中兜圈子。
一4.9.3新代的MPLSMPLS问世后就在互联网中得到了大量的部署。虽然MPLS能够更快地转发分组，但其
有关的控制协议（如LDP)却比较复杂，其扩展性差，运行维护也较困难。协议LDP也无
法做到基千时延或带宽等要求的流量调度。为了根据需要灵活地选择流量的转发路径，就还
需要再使用资源预留协议RSVP（见8.4.3节）。但RSVP的信令非常复杂，每个节点都要维
护一个庞大的链路信息数据库。此外，RSVP不支持等价多路径路由选择ECMP(Equal-Cost
MultipathRouting)，而只会选择一条最优路径进行转发。
•193•为了解决上述问题，一种保留了MPLS的主要特点，但更加简单的新的源路由选择协
议出现了。这就是段路由选择协议(SegmentRouting)，简称为SR。但不少人都使用＂
段路
由协议”这样更加简单的名称。在SR中，＂段(s
egment)"就是标签，也就是转发指令的一
种标识符。SR的工作原理仍然是基于标签交换的，不过现在不需要使用协议LDP,因此简化了设备运行的协议数量。SR由源(cid:7188)点为发送的报文指定路径，并将路径转换成有序的段列表(SegmentList)，即MPLS标签栈，它被封装在分组首部。网络中的其他(cid:7188)点就执行首部中的指令（即标签）进行转发。
整个网络设有控制器，也就是SDN控制器（见4.10(cid:7188)）。控制器收集并掌握全网的拓扑信息和链路状态信息，计算出分组应传送的整个路径。控制器负责给分组分配SR标签，这些标签指明了分组从源点到终点的路径。当分组到达某个网络(cid:7188)点时，(cid:7188)点就根据分组携
带的标签转发到下一个(cid:7188)点。
现在SR还向IPv6演进，这就是SRv6。它直接利用IPv6字段作为标签寻址。而前面介绍的在MPLS基础上的SR则称为SR-MPLS。
4.10软件定义网络SDN简介SDN的概念最初由斯坦福大学N.McKeown于2009年首先提出。当时还只是在学术界
进行探讨的一种新的网络体系结构。但随后几年发展很快，不少企业相继采用。其中最成功
的案例就是谷歌建于2010~2012年的数据中心网络B4。几年来网络B4运行的结果证明，基千SDN的专用广域网确实可以大大提高网络带宽利用率，网络运行更加稳定，管理更加高效简化，运行费用也明显降低了。目前，SDN已经引起人们的密切关注。
在本章开始的4.1.2(cid:7188)，我们初步介绍了网络层数据层面和控制层面的基本概念。现在有关SDN的资料已相当丰富。限千篇幅，下面我们只(cid:7126)对SDN进行简单的介绍。
我们知道，在SDN中，数据层面中的交换机是由控制层面进行控制的，图4-70表明这
种控制是通过协议OpenFlow来实现的。协议OpenFlow是一个得到高度认可的标准，在讨
论SDN时往往与OpenFlow一起讨论。因此，有人会误认为SDN就是OpenFlow。其实这
二者有着很大的区别。SDN不是协议，更不是一种产品。SDN是一个体系结构，是一种设
计、构建和管理网络的新方法或新概念，其要点就是把网络的控制层面和数据层面分离，而让控制层面利用软件来控制数据层面中的许多设备。可以把协议OpenFlow看成是在SDN体系结构中控制层面和数据层面之间的通信接口，它使得控制层面的控制器可以对数据层面中的物理设备或虚拟设备，进行直接访问和操纵。这种控制在逻辑上是集中式的，是基千流的控制。
AP1AP2控制层面（网络操作系统）协议OpenFlow数据层面图4-70协议OpenFlow是控制层面和数据层面的接口协议OpenFlow1.0是2009年底发表的最早的版本，之后每年都进行更新，经过12次•194•