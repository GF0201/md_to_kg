在转发到同一个输出端口），那么后到达的分组就必须在输入端口排队等待。采用这种交换
方式的路由器例子如思科公司的12000系列交换路由器，其互连网络的速率达60Gbit/s。
4.7IP多播4.7.1IP多播的基本概念1988年SteveDeering首次在其博士学位论文中提出IP多播的概念。1992年3月IETF
在互(cid:7110)网范围首次试验IETF会议声音的多播，当时有20个网点可同时听到会议的声音。IP
多播是需要在互(cid:7110)网上增加更多的智(cid:7126)才(cid:7126)提供的一种服务。现在IP多播(multicast,以
前曾译为组播）已成为互(cid:7110)网的一个热门课题。这是由千有许多的应用需要由一个源点发送
到许多个终点，即一对多的通信。例如，实时信息的交付（如新闻、(cid:7122)市行情等）、软件更
新、交互式会议等。随着互(cid:7110)网的用户数目的急剧增加，以及多媒体通信的开展，有更多的业务需要多播来支持。
与单播相比，在一对多的通信中，多播可大大(cid:7188)约网络资源。图4-58(a)是视频服务器
用单播方式向90台主机传送同样的视频(cid:7188)目。为此，需要发送90个单播，即同一个视频分
组要发送90个副本。图4-58(b)是视频服务器用多播方式向属千同一个多播组的90个成员
传送(cid:7188)目。这时，视频服务器只需把视频分组当作多播数据报来发送，并且只需发送—次。
，民和凡各转发l
路由器在转发分组时，需要把收到的分组复制成3个副本，分别向R1R2个副本。当分组到达目的局域网时，由千局域网具有硬件多播功(cid:7126)，因此不需要复制分组，
在局域网上的多播组成员都(cid:7126)收到这个视频分组。
视频服务器M送90次单播发R21个压//|V
R1已三复伟
个
1炒<
产
J1个IR产If
。卢．
—=＝＝＝3l立怼1多播
3一一一一一产女－一一一一一一一一一巨－－－－－
：三——--,^!'.b:m:tl
1、、
I三］
心＇，；�
1···
:
，编
编俨．编｀
么
、、-----------------------------------------------------X(
···
．，�｀多』心1•••l
｀�个个、．·`｀，
:
＾，＇共有90个主机接收视频节目(a)单播．多播组成员共有90个
多播(b)＼，、图4-58单播与多播的比较当多播组的主机数很大时（如成千上万个），采用多播方式就可明显地减轻网络中各种
资源的消(cid:7107)。在互(cid:7110)网范围的多播要靠路由器来实现，这些路由器必须增加一些(cid:7126)够识别多
播数据报的软件。(cid:7126)够运行多播协议的路由器称为多播路由器(multicastrouter)。多播路由器当然也可以转发普通的单播IP数据报。
为了适应交互式音频和视频信息的多播，从1992年起，在互(cid:7110)网上开始试验虚拟的多播主干网MBONE(MulticastBackboneOntheInterNEt)。MBONE可把分组传播给地点分散
但属千一个组的许多台主机。现在多播主千网已经有了相当大的规模。
•179•在互(cid:7110)网上进行多播就叫作IP多播。IP多播所传送的分组需要使用多播IP地址。
我们知道，在互(cid:7117)网中每一台主机必须有一个全球唯一的IP地址。如果某台主机现在想接收某个特定多播组的分组，那么怎样才(cid:7126)使这个多播数据报传送到这台主机？
显然，这个多播数据报的目的地址一定不(cid:7126)写入这台主机的IP地址。这是因为在同一
时间可(cid:7126)有成千上万台主机加入到同一个多播组。多播数据报不可(cid:7126)在其首部写入这样多的
主机的IP地址。在多播数据报的目的地址写入的是多播组的标识符，然后设法让加入到这个多播组的主机的IP地址与多播组的标识符关(cid:7110)起来。
其实多播组的标识符就是IP地址中的D类地址。D类IP地址的前四位是111o,因此
D类地址范围是224.0.0.0到239.255.255.255。我们就用每一个D类地址标志一个多播组。
这样，D类地址共可标志228
个多播组，也就是说，在同一时间可以允许有超过2.6亿的多
播组在互(cid:7110)网上运行。多播数据报也是“尽最大努力交付
，不保证－定(cid:7126)够交付多播组内
的所有成员。因此，多播数据报和一(cid:7183)的IP数据报的区别就是它使用D类IP地址作为目的
地址，并且首部中的协议字段值是2,表明使用网际组管理协议IGMP。
＂显然，多播地址只(cid:7129)用千目的地址，而不(cid:7129)用千源地址。此外，对多播数据报不产生ICMP差错报文。因此，若在PING命令后面键入多播地址，将永远不会收到响应。
IP多播可以分为两种。一种是只在本局域网上进行硬件多播，另一种则是在互(cid:7110)网的
范围进行多播。前一种虽然比较简单，但很重要，因为现在大部分主机都是通过局域网接入
到互(cid:7110)网的。在互(cid:7110)网上进行多播的最后阶段，还是要把多播数据报在局域网上用硬件多播
交付多播组的所有成员（如图4-58(b)所示）。下面就先讨论这种硬件多播。
4.7.2在局域网上进行硬件多播互(cid:7110)网号码指派管理局IANA拥有的以太网地址块的高24位为00-00-5E,因此TCP/IP
协议使用的以太网地址块的范围是从00-00-5E-00-00-00到00-00-5E-FF-FF-FF。在第3章
3.3.5(cid:7188)已讲过，以太网MAC地址字段中的第1字(cid:7199)的最低位为1时即为多播地址，这种
多播地址数占IANA分配到的地址数的一半。但IANA只拿出2“个地址，即01-00-5E-00-
00-00到Ol-00-5E-7F-FF-FF的地址作为以太网多播地址。或者说，在48位的多播地址中，
前25位都固定不变，只有后23位可用作多播。但D类IP地址可供分配的有28位。这28
位中只有后23位才映射以太网多播地址中的后23位，因此是多对一的映射关系（如图4-59
所示），即28位中的前5位不(cid:7126)用来构成以太网多播地址。例如，
IP多播地址
224.128.64.32(即E0-80-40-20)和另一个IP多播地址224.0.64.32（即E0-00-40-20)转换成
以太网的多播地址都是01-00-5E-00-40-20。因此收到多播数据报的主机，还要在IP层利用
IP数据报首部的IP地址进行过滤，把不是本主机要接收的数据报丢弃。
28位162431这5位不使用\\｀
;,':08,言兀三三三00000001101:111E
1010表示多播0000000；上°尸前25位固定不变一;/三二上后23位来自D类1P地址勹图4-59D类lP地址与以太网多播地址的映射关系——•180•下面就讨论进行IP多播所需要的协议。
4.7.3IGMP网际组管理协议
1.IP多播需要两种协议和多播路由选择协议图4-60是在互(cid:7118)网上传送多播数据报的例子。图中标有IP地址的四台
主机都参加了一个多播组，其组地址是226.15.37.123。显然，多播数据报
应当传送到路由器R)，民和R3,而不应当传送到路由器凡，因为与凡连接的局域网上现在
没有这个多播组的成员。但这些路由器又怎样知道多播组的成员信息呢？这就要利用一个协
议，叫作网际组管理协议IGMP(InternetGroupManagementProtocol)。
视频讲解128.56.24.34
参加多播组
226.15.37.123135.27.?4.52
早慧三2!＝三\MP三二］
／沁～归、三八1`＿督14.56.130._l�.
尸三）P早凳
三一一二二沁°乌1443二＝」参加多播组
226.15.37.123lGM2!R4�图4-60IGMP使多播路由器知道多播组成员信息图4-60强调了IGMP的本地使用范围。请注意，IGMP并非在互(cid:7110)网范围内对所有多播组成员进行管理的协议。IGMP不知道IP多播组包含的成员数，也不知道这些成员都分布在哪些网络上。IGMP协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机（严格讲，是主机上的某个进程）参加或退出了某个多播组。
显然，仅有IGMP协议是不(cid:7126)完成多播任务的。连接在局域网上的多播路由器还必须和互(cid:7110)网上的其他多播路山器协同工作，以便把多播数据报用最小代价传送给所有的组成员。
这就需要使用多播路由选择协议。
然而多播路由选择协议要比单播路由选择协议复杂得多。我们可以通过一个简单的例
子来说明。我们假定图4-61中有两个多播组。多播组M1的成员有主机A,B和C,而多播组队的成员有主机D,E和F。这些主机分布在三个网络上CN1,N2和N3)。
飞多播组MI
(A,B,C）多播组M2
(D,E,F)-----------------
、～·'，“%
I\、
Rl三A,//,',N-
｀｀．仁
IG三一-己尸＿＿＿N,、、、、三，＇，＇--．N
FI
、、、----�，夕、、-D
、、、、、、一,B三//二一'-'，2'r',，',-----------------～-、-、～~-－－-，_又笃．另、l｀｀｀～俨｀｀图4-61用来说明多播路由选择的例子路由器R不应当向网络N3转发多播组M]的分组，因为网络凡上没有多播组M1的成
员。但是每一台主机可以随时加入或离开一个多播组。例如，如果主机G现在加入了多播•181•组M1,那么从这时起，路由器R就必须也向网络N3转发多播组M1的分组。这就是说，多播转发必须动态地适应多播组成员的变化（这时网络拓扑并未发生变化）。请注意，单播路由选择通常在网络拓扑发生变化时才需要更新路由。
再看一种情况。主机E和F都是多播组M2的成员。当E向F发送多播数据报时，路由
器R把这个多播数据报转发到网络N3。但当F向E发送多播数据报时，路由器R则把多播
数据报转发到网络N2。如果路由器R收到来(cid:7151)主机A的多播数据报(A不是多播组M2的成员，但也可向多播组发送多播数据报），那么路由器R就应当把多播数据报转发到N2和N3。由此可见，多播路由器在转发多播数据报时，不(cid:7129)仅仅根据多播数据报中的目的地址，而是还要考虑这个多播数据报从什么地方来和要到什么地方去。
还有一种情况。主机G没有参加任何多播组，但G却可向任何多播组发送多播数据报。
例如，G可向多播组M1或M2发送多播数据报。主机G所在的局域网上可以没有任何多播
组的成员。显然，多播数据报所经过的许多网络，也不一定非要有多播组成员。总之，多播
数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络。
正因为如此，IP多播就成为比较复杂的问题。下面介绍这两种协议的要点。
2.网际组管理协议IGMPIGMP已有了三个版本。
1989年公布的RFC1112CIGMPvl)早已成为了互(cid:7110)网的标准协议(STD5)。2002年10月公布的建议标准IGMPv3是最新的[RFC3376]。
和网际控制报文协议ICMP相似，IGMP使用IP数据报传递其报文（即IGMP报文加
上IP首部构成IP数据报），但它也向IP提供服务。因此，我们不把IGMP看成是一个单独
的协议，而是属于整个网际协议IP的一个组成部分。
从概念上讲，IGMP的工作可分为两个阶段。
第一阶段：当某台主机加入新的多播组时，该主机应向多播组的多播地址发送一个
IGMP报文，声明(cid:7151)己要成为该组的成员。本地的多播路由器收到IGMP报文后，还要利用
多播路由选择协议把这种组成员关系转发给互(cid:7110)网上的其他多播路由器。
第二阶段：组成员关系是动态的。本地多播路由器要周期性地探询本地局域网上的主
机，以便知道这些主机是否还继续是组的成员。只要有一台主机对某个组响应，那么多播路
由器就认为这个组是活跃的。但一个组在经过几次的探询后仍然没有一台主机响应，多播路
由器就认为本网络上的主机已经都离开了这个组，因此也就不再把这个组的成员关系转发给其他的多播路由器。
IGMP设计得很仔细，避免了多播控制信息给网络增加大瞿的开销。IGMP采用的一些具体措施如下：(1)在主机和多播路由器之间的所有通信都使用IP多播。只要有可(cid:7126)，携带IGMP报文的数据报都用硬件多播来传送。因此在支持硬件多播的网络上，没有参加IP多播的主机不会收到IGMP报文。
(2)多播路由器在探询组成员关系时，只需要对所有的组发送一个请求信息的询问报文，
而不需要对每一个组发送一个询问报文（虽然也允许对一个特定组发送询问报文）。默认的
询问速率是每125秒发送一次（通信量并不太大）。
(3)当同一个网络上连接有几个多播路由器时，它们(cid:7126)够迅速和有效地选择其中的一个来探询主机的成员关系。因此，网络上多个多播路由器并不会引起IGMP通信量的增大。
•182•(4)在IGMP的询问报文中有一个数值N,它指明一个最长响应时间（默认值为10秒）。
当收到询问时，主机在0到N之间随机选择发送响应所需经过的时延。因此，若一台主机
同时参加了几个多播组，则主机对每一个多播组选择不同的随机数。对应于最小时延的响应
最先发送。
(5)同一个组内的每一台主机都要监听响应，只要有本组的其他主机先发送了响应，(cid:7149)己就可以不再发送响应了。这样就抑制了不必要的通信量。
多播路由器并不需要保留组成员关系的准确记录，因为向局域网上的组成员转发数据报是使用硬件多播。多播路由器只需要知道网络上是否(cid:7169)少还有一台主机是本组成员即可。
实际上，对询问报文每一个组只需有一台主机发送响应。
如果一台主机上有多个进程都加入了某个多播组，那么这台主机对发给这个多播组的每个多播数据报只接收一个副本，然后给主机中的每一个进程发送一个本地复制的副本。
最后我们还要强调指出，多播数据报的发送者和接收者都不知道（也无法找出）一个
多播组的成员有多少，以及这些成员是哪些主机。互(cid:7119)网中的路由器和主机都不知道哪个应
用进程将要向哪个多播组发送多播数据报，因为任何应用进程都可以在任何时候向任何一个
多播组发送多播数据报，而这个应用进程并不需要加入这个多播组。
IGMP的报文格式可参阅有关文档[RFC3376]，这里从略。
3.多播路由选择协议虽然在TCP/IP中IP多播协议已成为建议标准，但多播路由选择协议（用来在多播路由器之间传播路由信息）则尚未标准化。
在多播过程中一个多播组中的成员是动态变化的。例如在收听网上某个广播(cid:7188)目时，随时会有主机加入或离开这个多播组。多播路由选择实际上就是要找出以源主机为根(cid:7188)点的
多播转发树。在多播转发树上，每一个多播路由器向树的叶(cid:7188)点方向转发收到的多播数据报，但在多播转发树上的路由器不会收到重复的多播数据报（即多播数据报不应在互(cid:7119)网中兜圈
子）。不难看出，对不同的多播组对应千不同的多播转发树。同一个多播组，对不同的源点
也会有不同的多播转发树。
已有了多种实用的多播路由选择协议，它们在转发多播数据报时使用了以下的三种方法：(1)洪泛与剪除。这种方法适合于较小的多播组，而所有的组成员接入的局域网也是相
邻接的。一开始，路由器转发多播数据报使用洪泛的方法（这就是广播）。为了避免兜圈子，
ePathBroadcasting)的策略。RPB的要点是：每一个
采用了叫作反向路径广播RPB(Revers
路由器在收到一个多播数据报时，先检查数据报是否是从源点经最短路径传送来的。进行这
种检查很容易，只要从本路由器寻找到源点的最短路径上（之所以叫作反向路径，因为在计
算最短路径时是把源点当作终点的）的第一个路由器是否就是刚才把多播数据报送来的路由
器。若是，就向所有其他方向转发刚才收到的多播数据报（但进入的方向除外），否则就丢弃而不转发。如果本路由器有好几个相邻路由器都处在到源点的最短路径上（也就是说，存
在几条同样长度的最短路径），那么只(cid:7126)选择一条最短路径，选择的准则就是看这几条最短
路径中的相邻路由器谁的IP地址最小。图4-62的例子说明了这一概念。
•183•．转发多播数据报．贮X收到后即丢弃夕＿-－－－-,',暴~、+、-剪除没有
、组成员的树枝已图4-62反向路径广播RPB和剪除为简单起见，在图4-62中的网络用路由器之间的链路来表示。我们假定各路由器之间
的距离都是1。路由器R1收到源点发来的多播数据报后，向民和民转发。民发现民就在(cid:7149)已到源点的最短路径上，因此向民和凡转发收到的数据报。民发现民不在(cid:7149)已到源点R7一R1一凡一R2的最短路径上，因此丢弃民发来的数据报。其他路由器也这样转发。凡到源点有两条最短
一源点；R7-R5-R3-R1-源点。我们再假定凡的IP地址比民的
路径：
IP地址小，所以我们只使用前一条最短路径。因此R7只转发凡传过来的数据报，而丢弃
民传过来的数据报。最后就得出了用来转发多播数据报的多播转发树（图中用粗线表示），
以后就按这个多播转发树来转发多播数据报。这样就避免了多播数据报兜圈子，同时每一个
路由器也不会接收重复的多播数据报。
如果在多播转发树上的某个路由器发现它的下游树枝（即叶(cid:7188)点方向）已没有该多播
组的成员，就应把它和下游的树枝一起剪除。例如，在图4-62中虚线椭圆表示剪除的部分。
当某个树枝有新增加的组成员时，可以再接入到多播转发树上。
(2)隧道技术(tunneling)。隧道技术适用千多播组的位置在地理上很分散的情况。例如
在图4-63中，网N1和网N2都支持多播。现在N1中的主机向N2中的一些主机进行多播。
但路由器凡和民之间的网络并不支持多播，因而R1和民不(cid:7126)按多播地址转发数据报。为
此，路由器凡就对多播数据报进行再次封装，即再加上普通数据报首部，使之成为向单一
目的站发送的单播(unicast)数据报，然后通过＂隧道”(tunnel)从民发送到R'和N沪
中的
N
多播数据报
2
数据1首部1，首部隧道中通行的
单播IP数据报图4-63隧道技术在多播中的应用单播数据报到达路由器民后，再由路由器民剥去其首部，使它又恢复成原来的多播数
据报，继续向多个目的站转发。这一点和英吉利海峡隧道运送汽车的情况相似。英吉利海峡
隧道不允许汽车在隧道中行驶。但是，可以把汽车放置在隧道中行驶的电气火车上来通过隧道。过了隧道后，汽车又可以继续在公路上行驶。这种使用隧道技术传送数据报又叫作IP•184•中的IP(IP-in-IP)。
(3)基千核心的发现技术。这种方法对千多播组的大小在较大范围内变化时都适合。这
种方法是对每一个多播组G指定一个核心(core)路由器，给出它的IP单播地址。核心路由器
按照前面讲过的方法创建出对应于多播组G的转发树。如果有一个路由器R1向这个核心路
由器发送数据报，那么它在途中经过的每一个路由器都要检查其内容。当数据报到达参加了
多播组G的路由器凡时，民就处理这个数据报。如果民发出的是一个多播数据报，其目的地址是G的组地址，民就向多播组G的成员转发这个多播数据报。如果民发出的数据
报是一个请求加入多播组G的数据报，民就把这个信息加到它的路由中，并用隧道技术向
R1转发每一个多播数据报的一个副本。这样，参加到多播组G的路由器就从核心向外增多
了，扩大了多播转发树的覆盖范围。
目前还没有在整个互联网范围使用的多播路由选择协议。下面是一些建议使用的多播路由选择协议。
距离向量多播路由选择协议DVMRP(DistanceVectorMulticastRoutingProtocol)是在互
联网上使用的第一个多播路由选择协议[RFC1075]。由千在UNIX系统中实现RIP的程序叫
作routed,所以在routed的前面加表示多播的字母m,叫作mrouted,它使用DVMRP在路
由器之间传播路由信息。
基于核心的转发树CBT(CoreBasedTree)[RFC2189,2201]。这个协议使用核心路由器
作为转发树的根节点。一个大的自治系统AS可划分为几个区域，每一个区域选择一个核心
路由器（也叫作中心路由器centerrouter,或汇聚点路由器rendezvousrouter)。
开放最短通路优先的多播扩展MOSPF(MulticastextensionstoOSPF)[RFC1585]。这个
协议是单播路由选择协议OSPF的扩充，使用于一个机构内。MOSPF使用多播链路状态路
由选择创建出基于源点的多播转发树。
协议无关多播－稀疏方式PIM-SM(ProtocolIndependentMulticast-SparseMode)[RFC
7761,STD83]。这是唯一成为互联网标准的一个协议，它使用和CBT同样的方法构成多播
转发树。采用“协议无关”这个名词是强调：虽然在建立多播转发树时是使用单播数据报来
和远程路由器联系的，但这并不要求使用特定的单播路由选择协议。这个协议适用千组成员的分布非常分散的情况。
协议无关多播－密集方式PIM-DM(ProtocolIndependentMulticast-DenseMode)[RFC3973]。这个协议适用千组成员的分布非常集中的情况，例如组成员都在一个机构之内。
PIM-DM不使用核心路由器，而是使用洪泛方式转发数据报。
4.8虚拟专用网VPN和网络地址转换NAT4.8.1VPN虚拟专用网由于IP地址的紧缺，一个机构能够申请到的IP地址数往往远小千本机构所拥有的主机数。考虑到互联网并不很安全，一个机构内也并不需要把所有的主机接入到外部的互联网。
实际上，在许多情况下，很多主机主要还是和本机构内的其他主机进行通信（例如，在大型
商场或宾馆中，有很多用于营业和管理的计算机。显然这些计算机并不都需要和互联网相
连）。假定在一个机构内部的计算机通信也是采用TCP/IP协议，那么从原则上讲，对于这些•185•