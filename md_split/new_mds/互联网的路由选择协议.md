组成员关系报文|___＿__MLD协议~'」、l4」.-.LLlND协议关千ICMPv6的进一步讨论可参阅[FOROIO]，这里从略。
图4-38ICMPv6报文的分类4.6互联网的路由选择协议本(cid:7188)将讨论几种常用的路由选择协议，也就是要讨论转发表中的路由是怎样得出的。
按照4.1.2(cid:7188)所述的观点，路由选择协议属于网络层控制层面的内容。不过本(cid:7188)仍然按传统的思路进行讨论，也就是说，路由选择协议规定了互(cid:7110)网中有关的路由器应如何相互交换信息并生成出路由表。
4.6.1有关路由选择协议的几个基本概念1.理想的路由算法路由选择协议的核心就是路由算法，即需要何种算法来获得路由表中的各项目。一个理想的路由算法应具有如下的一些特点[BELL86]:(1)算法必须是正确的和完整的。这里，“正确＂的含义是：沿着各路由表所指引的路由，分组一定(cid:7126)够最终到达目的网络和目的主机。
(2)算法在计算上应简单。路由选择的计算不应使网络通信量增加太多的额外开销。
(3)算法应(cid:7129)适应通信量和网络拓扑的变化，这就是说，要有(cid:7152)适应性。当网络中的通信量发生变化时，算法(cid:7126)(cid:7149)适应地改变路由以均衡各链路的负载。当某个或某些(cid:7188)点、链路发生故障不(cid:7126)工作，或者修理好了再投入运行时，算法也(cid:7126)及时地改变路由。有时称这种(cid:7149)
适应性为＂稳健性”(robustnes)。3(4)算法应具有稳定性。在网络通信量和网络拓扑相对稳定的情况下，路由算法应收敛于一个可以接受的解，而不应使得出的路由不停地变化。
(5)算法应是公平的。路由选择算法应对所有用户（除对少数优先级高的用户）都是平
等的。例如，若仅仅使某一对用户的端到端时延为最小，但却不考虑其他的广大用户，这就
明显地不符合公平性的要求。
而网络的吞吐量最大。虽然我们希望得到(6)算法应是最佳的。路由选择算法应当(cid:7126)够找出最好的路由，使得分组平均时延最小
最佳＂的算法，但这并不总是最重要的。对于某
些网络，网络的可靠性有时要比最小的分组平均时延或最大吞吐量更加重要。因此，所谓“““最佳只(cid:7129)是相对于某一种特定要求下得出的较为合理的选择而已。
一个实际的路由选择算法，应尽可(cid:7126)接近于理想的算法。在不同的应用条件下，对以CD注：robustness一词在自动控制界的标准译名是“鲁棒性”，但在[MlNGCI94]则译为＂稳健性”。
•157•s
上提出的6个方面也可有不同的侧重。
应当指出，路由选择是个非常复杂的问题，因为它是网络中的所有(cid:7188)点共同协调工作的结果。其次，路由选择的环境往往是不断变化的，而这种变化有时无法事先知道，例如，网络中出了某些故障。此外，当网络发生拥塞时，就特别需要有(cid:7126)缓解这种拥塞的路由选择策略，但恰好在这种条件下，很难从网络中的各(cid:7188)点获得所需的路由选择信息。
倘若从路由算法(cid:7126)否随网络的通信量或拓扑(cid:7153)适应地进行调整变化来划分，则只有两大类，即静态路由选择策略与动态路由选择策略。静态路由选择也叫作非(cid:7152)适应路由选择，其特点是简单和开销较小，但不(cid:7126)及时适应网络状态的变化。对千很简单的小网络，完全可
以采用静态路由选择，用人工配置每一条路由。动态路由选择也叫作(cid:7152)适应路由选择，其特点是(cid:7126)较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。因此，动态路由选择适用千较复杂的大网络。
2.分层次的路由选择协议互(cid:7112)网采用的路由选择协议主要是(cid:7154)适应的（即动态的）、分布式路由选择协议。由千以下两个原因，互(cid:7113)网采用分层次的路由选择协议：(1)互(cid:7110)网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互(cid:7110)网的通信链路饱和。
(2)许多单位不愿意外界了解(cid:7155)己单位网络的布局细(cid:7188)和本部门所采用的路由选择协议（这属千本部门内部的事情），但同时还希望连接到互(cid:7114)网上。
为此，可以把整个互(cid:7115)网划分为许多较小的(cid:7152)治系统(autonomoussystem)，一(cid:7182)都记为
AS。(cid:7149)治系统AS是在单一技术管理下的许多网络、IP地址以及路由器，而这些路由器使用
一种(cid:7151)治系统内部的路由选择协议和共同的度量。每一个AS对其他AS表现出的是一个单一
的和一(cid:7174)的路由选择策略[RFC4271]。这样，互(cid:7110)网就把路由选择协议划分为两大类，即：(1)内部网关协议IGP(InteriorGatewayProtocol)即在一个(cid:7151)治系统内部使用的路由
选择协议，而这与在互(cid:7110)网中的其他(cid:7151)治系统选用什么路由选择协议无关。目前这类路由选择协议使用得最多的是RIP和OSPF协议(IS-IS协议也很流行，但不介绍了）。
(2)外部网关协议EGP(ExternalGatewayProtocol)若源主机和目的主机处在不同的(cid:7151)治系统中（这两个(cid:7151)治系统可(cid:7126)使用不同的内部网关协议），那么在不同(cid:7156)治系统AS之间的路由选择，就需要使用外部网关协议EGP。目前使用最多的外部网关协议是BGP的版本4(BGP-4)。
(cid:7157)治系统之间的路由选择也叫作域间路由选择(interdomainrouting)，而在(cid:7150)治系统内部的路由选择叫作域内路由选择(intradomainrouting)。
图4-39是两个(cid:7151)治系统互连在一起的示意图。每个(cid:7151)治系统(cid:7149)己决定在本(cid:7151)治系统内
部运行哪一个内部路由选择协议（例如，可以是RIP,也可以是OSPF)。但每个(cid:7151)治系统都
有一个或多个路由器（图中的路由器R]和R2)除运行本系统的内部路由选择协议外，还要运行(cid:7151)治系统间的路由选择协议(BGP-4)。
•158•自治系统A用外部网关协议
上＂（例如，BGP-4)、用内部网关协议-已三气二一，自治系统BRJ
一
-已
＼二二用内部网关协议）图4-39(cid:7158)治系统和内部网关协议、外部网关协议这里我们要指出两点：(1)互(cid:7110)网的早期RFC文档中未使用这一名词。但是在
后来的RFC文档中又改用“路由器”这一名词，因此有的书把原来的IGP和EGP分别改为
IRP（内部路由器协议）和ERP（外部路由器协议）。为了方便读者查阅RFC文档，本书仍
使用RFC原先使用的名字IGP和EGP。
而是使用路由器网关“”“”(2)RFC采用的名词IGP和EGP是协议类别的名称。但RFC在使用名词EGP时出现了
一点混乱，因为最早的一个外部网关协议的协议名字正好也是EGP[RFC827]。后来发现该
RFC提出的EGP有不少缺点，就设计了一种更好的外部网关协议，叫作边界网关协议BGP
(BorderGatewayProtocol)，用来取代旧的RFC827外部网关协议EGP。实际上，旧协议
EGP和新协议BGP都属于外部网关协议EGP这一类别。因此在遇到名词EGP时，应弄清
它是指旧协议EGP（即RFC827)还是指外部网关协议EGP这个类别。
总之，使用分层次的路由选择方法，可将互(cid:7110)网的路由选择协议划分为：
•内部网关协议IGP:具体的协议有多种，如RIP和OSPF等。
•外部网关协议EGP:目前使用的协议是BGP-4。
对千比较大的(cid:7159)治系统，还可将所有的网络再进行一次划分。例如，可以构筑一个链
路速率较高的主干网和许多速率较低的区域网。每个区域网通过路由器连接到主干网。当在
一个区域内找不到目的站时，就通过路由器经过主干网到达另一个区域网，或者通过边界路
由器到别的(cid:7151)治系统中去查找。下面对这两类协议分别进行介绍。
4.6.2RIP内部网关协议
1.协议RIP的工作原理RIP(RoutingInformationProtocol)是内部网关协议IGP中最先得到广泛
使用的协议[RFC1058]，它的中文译名是路由信息协议。RIP是一种分布式
的基千距离向量的路由选择协议，是互(cid:7110)网的标准协议，其最大优点就是简单。
视频讲解RIP协议要求网络中的每一个路由器都要维护从它(cid:7151)已到其他每一个目的网络的距离记录（因此，这是一组距离，即“距离向量”)。协议RIP将＂距离“定义如下：从一路由器到直接连接的网络的距离定义为1。从一主机到非直接连接的网络的距离定
义为所经过的路由器数加l。“加1"是因为到达目的网络后就进行直接交付（不需要再经过
路由器），而到直接连接的网络的距离已经定义为1。
“CD协议RIP的＂距离也称为“跳数”(hopcount)，并且每经过一个网络，跳数就加l。
“距离短"。RIP允许一条路径最多只(cid:7130)包含15RIP认为好的路由就是它通过的网络数目少，即个网络。因此“距离”等千16时即相当千不可达。可见RIP只适用千小型互(cid:7116)网。
G)汀：这里旧距院实际」指的是最短距离，但为方便起见任行省略＂”“”“＂最短习字。
•159•例如在前面的图4-7中，主机几经过5个路由器连接到另一个主机H2,中间经过了6
个网络或经过6跳。或者说，凡到儿的距离是6。在图中并没有画出网络。在讨论路由选
择问题时，在主机和路由器之间或在路由器之间的网络，往往都用一条线段来表示。需要注
意的是，到直接连接的网络的距离也可定义为0。但这两种不同的定义对实现协议RIP并无
影响，因为这对选择最佳路由的过程其实是一样的。
RIP不(cid:7126)在两个网络之间同时使用多条路由。RIP选择一条具有最少网络数的路由（即最短路由），哪怕还存在另一条高速（低时延）但网络数较多的路由。
本(cid:7188)讨论的RIP协议和下一(cid:7188)要讨论的OSPF协议，都是分布式路由选择协议。它们的
共同特点就是每一个路由器都要不断地和其他一些路由器交换路由信息。我们一定要弄清以
下三个要点，即和哪些路由器交换信息？交换什么信息？在什么时候交换信息？
协议RIP的特点是：
(1)仅和相邻路由器交换信息。如果两个路由器之间的通信不需要经过另一个路由器，那么这两个路由器就是相邻的。协议RIP规定，不相邻的路由器不交换信息。
(2)路由器交换的信息是当前本路由器所知道的全部信息，即(cid:7152)己现在的路由表。也就
“我到本(cid:7151)治系统中所有网络的（最短）距离，以及到每个网络应经是说，交换的信息是：
”。
过的下一跳路由器(3)按固定的时间间隔交换路由信息，例如，每隔30秒。然后路由器根据收到的路由
信息更新路由表。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。网络中的主机虽然也运行协议RIP,但只被动地接收路由器发来的路由信息。
这里要强调一点：路由器在刚刚开始工作时，它的路由表是空的。然后路由器就得出
到直接相连的几个网络的距离（这些距离定义为1)。接着，每一个路由器也只和数目非常
有限的相邻路由器交换并更新路由信息。但经过若干次的更新后，所有的路由器最终都会知
道到达本(cid:7149)治系统中任何一个网络的最短距离和下一跳路由器的地址。
”看起来协议RIP有些奇怪，因为“然而事实证明，通过这样的方式我的路由表中的信息要依赖千你的，而你的信息又
“我告诉别人一些信息，而别人又告诉
依赖于我的。
我一些信息。我再把我知道的更新后的信息告诉别人，别人也这样把更新后的信息再告诉
”，最后在(cid:7151)治系统中所有的(cid:7188)点都得到了正确的路由选择信息。在一(cid:7182)情况下，协议
我
就是在(cid:7151)治系统中所有的(cid:7188)点都得到正确的路由
RIP可以收敛，并且过程也较快。“收敛”选择信息的过程。
路由表中最主要的信息就是：到某个网络的距离（即最短距离），以及应经过的下一跳
地址。路由表更新的原则是找出到每个目的网络的最短距离。这种更新算法又称为距离向量
算法。下面就是协议RIP使用的距离向量算法。
2距离向量算法对每一个相邻路由器发送过来的RIP报文，执行以下步骤：
1)对地址为X的相邻路由器发来的RIP报文，先修改此报文中的所有项目：把“(下一
＂距离”字段的值加1（见后面的解释l)。每一个跳”字段中的地址都改为X,并把所有的
项目都有三个关键数据，即：到目的网络Net,距离是d,下一跳路由器是X。
(2)对修改后的RIP报文中的每一个项目，进行以下步骤：若原来的路由表中没有目的网络Net,则把该项目添加到路由表中（见解释2)。
否则（即在路由表中有目的网络Net,这时就再查看下一跳路由器地址）。
•160•若下一跳路由器地址是X,则把收到的项目替换原路由表中的项目（见解释3)。
否则（即这个项目是：到目的网络Net,但下一跳路由器不是X)。
若收到的项目中的距离d小千路由表中的距离，则进行更新（见解释4),否则什么也不做（见解释5)。
(3)若3分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达的路由器，即把距离置为16（距离为16表示不可达）。
(4)返回。
上面给出的距离向量算法的基础就是Bellman-Ford算法（或Ford-Fulkerson算法）。这种算法的要点是这样的：设X是(cid:7188)点A到B的最短路径上的一个(cid:7188)点。若把路径A-B拆成两段路径A-X和X-B，则每一段路径A-X和X-B也都分别是(cid:7188)点A到X和(cid:7188)点X到B的最短路径。
下面是对上述距离向量算法的五点解释。
解释1:这样做是为了便于进行本路由表的更新。假设从位千地址X的相邻路由器发来
的RIP报文的某一个项目是：“Net2,3,Y"，意思是“我经过路由器Y到网络Net2的距离是
3"'那么本路由器就可推断出：“我经过X到网络Net2的距离应为3+1=4"。千是，本路
由器就把收到的RIP报文的这一个项目修改为"Net2,4,X",作为下一步和路由表中原有项
目进行比较时使用（只有比较后才(cid:7126)知道是否需要更新）。读者可注意到，收到的项目中的
Y对本路由器是没有用的，因为Y不是本路由器的下一跳路由器地址。
解释2:表明这是新的目的网络，应当加入到路由表中。例如，本路由表中没有到目的网络Net2的路由，那么在路由表中就要加入新的项目“Net2,4,X”。
解释3:为什么要替换呢？因为这是最新的消息，要以最新的消息为准。到目的网络的
距离有可(cid:7126)增大或减小，但也可(cid:7130)没有改变。例如，不管原来路由表中的项目是“Net2,3,
X"还是“Net2,5,X"，都要更新为现在的"Net2,4,X”。
解释4:例如，若路由表中已有项目“Net2,5,P",就要更新为“Net2,4,X”。因为到网络Net2的距离原来是5,现在减到4,更短了。
解释5:若距离更大了，显然不应更新。若距离不变，更新后得不到好处，因此也不更新。
【例4-4】已知路由器凡有表4-8(a)所示的路由表。现在收到相邻路由器凡发来的路由更新信息，如表4-8(b)所示。试更新路由器凡的路由表。
表4-8(a)路由器氏的路由表目的网络距离下一跳路由器Net2Net334R4R5表4-8(b)氏发来的路由更新信息目的网络距离下一跳路由器NetlNet2Net334IR1R2直接交付•161•【解】如同路由器一样，我们不盄要知道该网络的拓扑。
先把表4-8(b)中的距离都加1,并把下一跳路由器都改为凡，得出表4-8(c)。
表4-8(c)修改后的表4-8(b)目的网络距离下一跳路由器NetINet2Net34-5-2R4R4R把这个表的每一行和表4-8(a)进行比较。
第一行在表4-8(a)中没有，因此要把这一行添加到表4-8(a)中。
第二行的Net2在表4-8(a)中有，且下一跳路由器也是凡。因此要更新（距离增大了）。
第三行的Net3在表4-8(a)中有，但下一跳路由器不同。于是就要比较距离。新的路由信息的距离是2,小于原来表中的4,因此要更新。
这样，得出更新后的民的路由表如表4-8(d)所示。
表4-8(d)路由器氏更新后的路由表目的网络Net!Net2Net3
...距离452．．．下一跳路由器R4RR
．．．协议RIP让一个(cid:7149)治系统中的所有路由器都和(cid:7149)己的相邻路由器定期交换路由信息，并不断更新其路由表，使得从每—个路由器到每—个目的网络的路由都是最短的（即跳数最
少）。这里还应注意：虽然所有的路由器最终都拥有了整个(cid:7151)治系统的全局路由信息，但由
于每一个路由器的位置不同，它们的路由表当然也应当是不同的。
现在较新的RIP版本是1998年11月公布的RIP2[RFC2453,STD57]，新版本协议本身并无多大变化，但性(cid:7131)上有些改进。RIP2可以支持无分类域间路由选择CIDR。此外，
RIP2还提供简单的鉴别过程支持多播。
图4-40表明RIP报文作为运输层用户数据报UDP的数据部分进行传送（使用UDP的端口520。端口的意义见5.2.2(cid:7197)）。
1贮气——RIP已二二二勹＼P
I勹才昙P用丿数据报�片
ri图4-40RIP2的报文用UDP用户数据报传送RIP报文由首部和路由部分组成。在路由部分要填入(cid:7152)治系统号ASN(Autonomous•162•SystemNumberf)，这是考虑使RIP有可(cid:7126)收到本(cid:7160)治系统以外的路由选择信息。还要指出
目的网络地址（包括网络的子网掩码）、下一跳路由器地址以及到此网络的距离。一个RIP
报文最多可包括25个路由。如超过，必须再用一个RIP报文来传送。
3.坏消息传播得慢RIP存在的一个问题是当网络出现故障时，要经过比较长的时间才(cid:7129)将此信息传送到所
有的路由器。我们可以用图4-41的简单例子来说明。设三个网络通过两个路由器互连起来，
并且都已建立了各(cid:7151)的路由表。图中路山器交换的信息只给出了我们感兴趣的一行内容。路
由器R)中的"Netl,1，直接
。路由器民中的
"Netl,2,R产表示”到网Netl的距离是2,下一跳经过R产。
”到网Netl的距离是1,直接交付表示”＂正常情况网Netl出故障I严庄竺直叶I二
|＿严主飞：J二
已－
三－已～，庄2丸，I三竺庄沪彗＿图4-41协议RIP的缺点：坏消息传播得慢现在假定路由器民到网Netl的链路出了故障，凡无法到达网Netl。于是路由器R]把
到网Netl的距离改为16,表示不可达，因而在民的路由表中的相应项目变为"Netl,16,”。但是，很可(cid:7126)要经过30秒钟后R1才把更新信息发送给R2。然而R2可(cid:7126)已经先把直接
(cid:7151)己的路由表发送给了R1,其中有“Netl,2,R产这一项。
R1收到民的更新报文后，误认为可经过民到达网Netl,千是把收到的路由信息
”,表明“我到网Netl的距离是3,下一跳经过R2",并"Netl,2,R广修改为：“Netl,3，民
把更新后的信息发送给R同理，凡接着又更新(cid:7149)己的路由表为"Netl,4,R广＇，以为“我到网Netl距离是4,下一跳经过R广。
沪这样的更新一直继续下去，直到R1和民到网Netl的距离都增大到16时，民和民才
知道原来网Netl是不可达的。协议RIP的这一特点叫作：好消息传播得快，而坏消息传播
得慢。网络出故障的传播时间往往较长（例如数分钟）。这是RIP的一个主要缺点。
但如果一个路由器发现了更短的路由，那么这种更新信息就传播得很快。
CD注：自治系统号ASN原来规定为一个16位的号码（最大的号砃是65535),「�I!ANA分配，具体的号码指派范围相当复杂，可从网七查出[W-ASN]。现在已经把ASN扩展到32位[RFC6793]。自2007年1月起，32位自治系统号ASN在全球互联网开始分配和使用。为了便千书写，在32位ASN中使用两段点分十进制记法，把65535在第1段中记为1，例如，ASN131074可以记为ASN2.4。
•163•为了使坏消息传播得更快些，可以采取多种措施。例如，让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送。
总之，协议RIP最大的优点就是实现简单，开销较小。但协议RIP的缺点也较多。首先，
RIP限制了网络的规模，它(cid:7126)使用的最大距离为15(16表示不可达）。其次，路由器之
间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。最
后，“坏消息传播得慢“
，使更新过程的收敛时间过长。因此，对千规模较大的网络就应当使
用下一(cid:7188)所述的OSPF协议。然而目前在规模较小的网络中，使用协议RIP的仍占多数。
扫一扫4.6.3内部网关协议OSPF义开
：P
：/i＼：/::://／s:；斤：
：三三／离向量协议。协议OSPF的特点是：OSPF最主要的特征就是使用链路状态协议(linkstateprotocol)，而不是像RIP那样的距(1)向本(cid:7149)治系统中所有路由器发送信息。这里使用的方法是洪泛法(flooding)，这就是
路由器通过所有输出端口向所有相邻的路由器发送信息。而每一个相邻路由器又再将此信息
发往其所有的相邻路由器（但不再发送给刚刚发来信息的那个路由器）。这样，最终整个区
域中所有的路由器都得到了这个信息的一个副本。更具体的做法后面还要讨论。我们应注意，
协议RIP是仅仅向(cid:7161)己相邻的几个路由器发送信息。
(2)发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。所谓“链路状态
＂度量”(metric)。OSPF将这个”就是说明本路由器都和哪些路由器相邻(i)
,以及该链路的
“度量”用来表示费用、距离、时延、带宽，等等。这些都
＂
。我们应注由网络管理人员来决定，因此较为灵活。有时为了方便就称这个度量为
意，对千协议RIP,发送的信息是：”到所有网络的距离和下一跳路由器”代价
”
。
(3)当链路状态发生变化或每隔一段时间（如30分钟），路由器向所有路由器用洪泛法发送链路状态信息。
从上述的前两点可以看出，OSPF和RIP的工作原理相差较大。
由千各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都(cid:7126)建立一个链
路状态数据库(link-statedatabase)，这个数据库实际上就是全网的拓扑结构图。这个拓扑结
构图在全网范围内是—(cid:7174)的（这称为链路状态数据库的同步）。因此，每一个路由器都知道＄注：在前面我们已经说过，在讨论路由器之间是如何交换路由信息时，最好将路由器之间的网络简化为一条链路。
＂OSPF的”链路状态中的＂”链路实际曰就是指“和这两个路由器都有接口的网络”。
•164•全网共有多少个路由器，以及哪些路由器是相连的，其代价是多少，等等。每一个路由器使
用链路状态数据库中的数据，构造出(cid:7150)己的路由表（例如，使用Dijkstra的最短路径路由算
法）。我们注意到，协议RIP的每一个路由器虽然知道到所有的网络的距离以及下一跳路由
器，但却不知道全网的拓扑结构（只有到了下一跳路由器，才(cid:7126)知道再下一跳应当怎样走）。
OSPF的链路状态数据库(cid:7126)较快地进行更新，使各个路由器(cid:7126)及时更新其路由表。
OSPF的更新过程收敛得快是其重要优点。
为了使OSPF(cid:7126)够用千规模很大的网络，OSPF将一个(cid:7162)治系统再划分为若干个更小的
范围，叫作区域(area)。图4-42就表示一个(cid:7150)治系统划分为四个区域。每一个区域都有一个
32位的区域标识符（用点分十进制形式表示）。当然，一个区域也不(cid:7126)太大，在一个区域内
的路由器最好不超过200个。
划分区域的好处就是把利用洪泛法交换链路状态信息的范围局限千每一个区域而不是
整个的(cid:7150)治系统，这就减少了整个网络上的通信量。在一个区域内部的路由器只知道本区域
的完整网络拓扑，而不知道其他区域的网络拓扑的情况。为了使每一个区域(cid:7126)够和本区域以
外的区域进行通信，OSPF使用层次结构的区域划分。在上层的区域叫作主干区域(backbonearea)。主千区域的标识符规定为0.0.0.0。主干区域的作用是用来连通其他在下层的区域。从
其他区域来的信息都由区域边界路由器(areaborderrouter)进行概括。在图4-42中，路由器
民，凡和民都是区域边界路由器，而显然，每一个区域(cid:7169)少应当有一个区域边界路由器。
在主干区域内的路由器叫作主干路由器(backbonerouter)，如R3,凡，R5，民和R7。一个主干
路由器可以同时是区域边界路由器，如R3,凡和R7。在主干区域内还要有一个路由器专门
和本(cid:7149)治系统外的其他(cid:7150)治系统交换路由信息。这样的路由器叫作(cid:7152)治系统边界路由器（如图4-42中的R6)。
自治系统AS至其他自治系统图4-42OSPF划分为两种不同的区域采用分层次划分区域的方法虽然使交换信息的种类增多了，同时也使OSPF协议更加复
杂了。但这样做却(cid:7126)使每一个区域内部交换路由信息的通信量大大减小，因而使OSPF协议
(cid:7126)够用千规模很大的(cid:7150)治系统中。这里，我们再一次地看到划分层次在网络设计中的重要性。
除了以上的几个基本特点外，OSPF还具有下列的一些特点：
(1)OSPF允许管理员给每条路由指派不同的代价。例如，高带宽的卫星链路对千非实时的业务可设置为较低的代价，但对千时延敏感的业务就可设置为非常高的代价。因此，
OSPF对千不同类型的业务可计算出不同的路由。链路的代价可以是1(cid:7169)65535中的任何一
个无量纲的数，因此十分灵活。商用的网络在使用OSPF时，通常根据链路带宽来计算链路•165•的代价。这种灵活性是RIP所没有的。
(2)如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路
径。这叫作多路径间的负载均衡(loadbalancing)。在代价相同的多条路径上分配通信量是通
信量工程中的简单形式。RIP只(cid:7126)找出到某个网络的一条路径。
(3)所有在OSPF路由器之间交换的分组（例如，链路状态更新分组）都具有鉴别的功(cid:7126)，因而保证了仅在可信赖的路由器之间交换链路状态信息。
(4)OSPF支持可变长度的子网划分和无分类的编址CIDR。
(5)由千网络中的链路状态可(cid:7126)经常发生变化，因此OSPF让每一个链路状态都带上一
个32位的序号，序号越大状态就越新。OSPF规定，链路状态序号增长的速率不得超过每5秒钟1次。这样，全部序号空间在600年内不会产生重复号。
2.OSPF的五种分组类型OSPF共有以下五种分组类型：
(1)类型1,问候(Hello)分组，用来发现和维持邻站的可达性。
(2)类型2,数据库描述(Databas
中的所有链路状态项目的摘要信息。
eDescription)分组，向邻站给出(cid:7151)己的链路状态数据库(3)类型3，链路状态请求(LinkStateRequest)分组，向对方请求发送某些链路状态项目的详细信息。
(4)类型4，链路状态更新(LinkStateUpdate)分组，用洪泛法对全网更新链路状态。这种分组是最复杂的，也是OSPF协议最核心的部分。路由器使用这种分组将其链路状态通知给邻站。链路状态更新分组共有五种不同的链路状态[RFC2328]，这里从略。
(5)类型5，链路状态确认(LinkStateAcknowledgment)分组，对链路更新分组的确认。
OSPF分组是作为IP数据报的数据部分来传送的（如图4-43所示）。OSPF不用UDP而是直接用IP数据报传送（其IP数据报首部的协议字段值为89)。OSPF构成的数据报很短。
这样做可减少路由信息的通信量。数据报很短的另一好处是可以不必将长的数据报分片传送。
分片传送的数据报只要丢失一个，就无法组装成原来的数据报，而整个数据报就必须重传。
OSPF分组首部1类型l至类型5的OSPF分组IP数据报首部＾、IOSPF分组-心＾｀心?~～~～？~”“上IP数据报图4-43OSPF分组用IP数据报传送OSPF规定，每两个相邻路由器每隔10秒钟要交换一次问候分组。这样就(cid:7126)确知哪些
是最基本的要求，因为只有可达邻站的链路状邻站是可达的。对相邻路由器来说，”可达”态信息才存入链路状态数据库（路由表就是根据链路状态数据库计算出来的）。在正常情况
下，网络中传送的绝大多数OSPF分组都是问候分组。若有40秒钟没有收到某个相邻路由器发来的问候分组，则可认为该相邻路由器是不可达的，应立即修改链路状态数据库，并重新计算路由表。
其他的四种分组都是用来进行链路状态数据库的同步。所谓同步就是指不同路由器的•166•链路状态数据库的内容是一样的。两个同步的路由器叫作“完全邻接的"(fullyadjacent)路
由器。不是完全邻接的路由器表明它们虽然在物理上是相邻的，但其链路状态数据库并没有
达到一(cid:7175)。
当一个路由器刚开始工作时，它只(cid:7126)通过问候分组得知它有哪些相邻的路由器在工作，
＂
。如果所有的路由器都把(cid:7149)己的本地链路状态信以及将数据发往相邻路由器所需的代价”息对全网进行广播，那么各路由器只要将这些链路状态信息综合起来就可得出链路状态数据库。但这样做开销太大，因此OSPF采用下面的办法。
OSPF让每一个路由器用数据库描述分组和相邻路由器交换本数据库中已有的链路状态
摘要信息。摘要信息主要就是指出有哪些路由器的链路状态信息（以及其序号）已经写入了数据库。经过与相邻路由器交换数据库描述分组后，路由器就使用链路状态请求分组，向对
方请求发送(cid:7151)己所缺少的某些链路状态项目的详细信息。通过一系列的这种分组交换，全网
同步的链路数据库就建立了。
在网络运行的过程中，只要一个路由器的链路状态发生变化，该路由器就要使用链路
状态更新分组，用洪泛法向全网更新链路状态。OSPF使用的是可靠的洪泛法，其要点如
图4-44所示。设路由器R用洪泛法发出链路状态更新分组。图中用一些小的箭头表示更新
分组。第一次先发给相邻的三个路由器。这三个路由器将收到的分组再进行转发时，要将其
上游路由器除外。可靠的洪泛法是在收到更新分组后要发送确认（收到重复的更新分组只需
要发送一次确认）。图中的空心箭头表示确认分组。
tt2t3t4为了确保链路状态数据库与全网的状态保持一(cid:7175)，OSPF还规定每隔一段时间，如30图4-44用可靠的洪泛法发送更新分组分钟，要刷新一次数据库中的链路状态。
由千一个路由器的链路状态只涉及与相邻路由器的连通状态，因而与整个互(cid:7110)网的规
模并无直接关系。因此当互(cid:7110)网规模很大时，OSPF协议要比距离向量协议RIP好得多。由
于OSPF没有的问题，据统计，其响应网络变化的时间小千100ms。
坏消息传播得慢“＂若N个路由器连接在一个以太网上，则每个路由器要向其他(N-l)个路由器发送链路
状态信息，因而共有N(N—l)个链路状态要在这个以太网上传送。OSPF协议对这种多点接•167•入的局域网采用了指定的路由器(designatedrouter)的方法，使广播的信息量大大减少。指定的路由器代表该局域网上所有的链路向连接到该网络上的各路由器发送状态信息。
4.6.4BGP外部网关协议1.协议BGP的主要特点在外部网关协议（或边界网关协议）BGP中，现在使用的是第4个版本BGP-4（常简写为BGP)。虽然最近陆续发布了不少BGP-4的更新文档，视频讲解但目前BGP-4仍然是草案标准[RFC4271]。协议BGP对互(cid:7110)网非常重要。我们知道，前面
两(cid:7188)所介绍的路由选择协议RIP和OSPF,都只(cid:7126)在一个(cid:7149)治系统AS内部工作。因此，若
没有协议BGP,那么分布在全世界数以万计的AS都将是一个个没有(cid:7110)系的孤岛。正是由千
有了BGP这种黏合剂，才使得这么多的AS孤岛(cid:7126)够连接成一个完整的互(cid:7110)网。从这个意
义上考虑，协议BGP应当是所有路由选择协议中最为重要的一个。
我们首先应当弄清，在不同(cid:7151)治系统AS之间的路由选择为什么不(cid:7126)使用前面讨论过的内部网关协议，如RIP或OSPF?我们知道，内部网关协议（如RIP或OSPF)主要是设法使数据报在一个AS中尽可(cid:7126)
有效地从源站传送到目的站。在一个AS内部也不需要考虑其他方面的策略。然而BGP使
用的环境却不同。这主要是因为以下的两个原因：第一，互(cid:7116)网的规模太大，使得(cid:7152)治系统AS之间路由选择非常困难。连接在互(cid:7110)网主
千网上的路由器，必须对任何有效的IP地址都(cid:7126)在转发表中找到匹配的网络前缀。目前在
互(cid:7115)网的主干网路由器中，一个转发表的项目数甚(cid:7168)可达到50万个网络前缀。如果使用链
路状态协议，则每一个路由器必须维持一个很大的链路状态数据库。对千这样大的主干网用
Dijkstra算法计算最短路径时花费的时间也太长。另外，由千(cid:7149)治系统AS各(cid:7151)运行(cid:7151)己选
定的内部路由选择协议，并使用本AS指明的路径度量，因此，当一条路径通过几个不同
AS时，要想对这样的路径计算出有意义的代价是不太可(cid:7126)的。例如，对某AS来说，代价
为1000可(cid:7126)表示一条比较长的路由。但对另－AS,代价为1000却可(cid:7126)表示不可接受的坏
作为度量来寻找最佳路由也
路由。因此，对千(cid:7151)治系统AS之间的路由选择，要用
”或
信息（即“可到达”代价
”可达性
到达网络前缀N可经过(cid:7151)治系统ASx”。
是很不现实的。比较合理的做法是在(cid:7151)治系统之间交换
”)。例如，告诉相邻路由器：”
“不可到达””第二，(cid:7152)治系统AS之间的路由选择必须考虑有关策略。由千相互连接的网络的性(cid:7126)相差很大，根据最短距离（即最少跳数）找出来的路径，可(cid:7126)并不合适。也有的路径的使用代
价很高或很不安全。还有一种情况，如(cid:7149)治系统AS1要发送数据报给(cid:7149)治系统AS2,本来最
好是经过(cid:7149)治系统AS3。但AS3不愿意让这些数据报通过本(cid:7151)治系统的网络，即使AS1愿意
付一定的费用。但另一方面，(cid:7151)治系统AS3愿意让某些相邻(cid:7151)治系统的数据报通过(cid:7151)己的
网络，特别是对那些付了服务费的某些(cid:7149)治系统更是如此。因此，(cid:7151)治系统之间的路由选择协议应当允许使用多种路由选择策略。这些策略包括政治、安全或经济方面的考虑。例如，我国国内的站点在互相传送数据报时不应经过国外兜圈子，特别是，不要经过某些对我国的
安全有威(cid:7124)的国家。这些策略都是由网络管理人员对每一个路由器进行设置的，但这些策略
并不是(cid:7149)治系统之间的路由选择协议本身。还可举出一些策略的例子，如：
仅在到达下列
这些地址时才经过AS己“ASx和ASy相比时应优先通过ASx"，等等。显然，使用这些策“•168•略是为了找出较好的路由而不是最佳路由。
由千上述情况，边界网关协议BGP只能是力求选择出一条能够到达目的网络前缀且比
较好的路由（不能兜圈子），而并非要计算出一条最佳路由。这里所说的BGP路由，是指经
过哪些自治系统AS可以到达目的网络前缀。当然，这选择出的比较好的路由，也有时不严
格地称为最佳路由。BGP采用了路径向量(pathvector)路由选择协议，它与距离向量协议
（如RIP)和链路状态协议（如OSPF)都有很大的区别。
2.BGP路由在一个自治系统AS中有两种不同功能的路由器，即边界路由器（或边界网关）和内部
路由器。一个AS至少要有一个边界路由器和相邻AS的边界路由器直接相连。在讨论协议
BGP时，应特别注意边界路由器的作用。正是由于有了边界路由器，AS之间才能利用协议
BGP交换可达性路由信息。
当两个边界路由器（例如图4-45(a)中的R1和R2)进行通信时，必须先建立TCP连接
（端口号为179,TCP连接将在第5章中学习），这种TCP连接又称为半永久性连接（即双
方交换完信息后仍然保持着连接状态）。像凡和民之间的这种连接称为eBGP连接，但通
示外部external。现在，边界路由器R1可通过eBGP向对等端民发
常就简称为eBGP,e
送BGP路由“X,AS1,R产，意思是“从R1经AS1可到达X”。这样，通过eBGP连接，AS2
中的边界路由器民就知道了到达AS1中的前缀X的BGP路由。
表;•t;'.c0BGP路由(a)王》三凡
＼之尸界护；由器AS
－－－－－－－(b)已iBGP
R4
＼2前缀AS1图4-45AS之间的eBGP连接(a)和AS内部的iBGP连接(b)但是，仅有边界路由器民知道”到AS1的前缀X的BGP路由“是远远不够的。边界
路由器民应当把获得的BGP路由，再转发给AS内部的其他路由器。为此，协议BGP规
定，在AS内部，两个路由器之间还需要建立iBGP（也就是iBGP连接，i表示内部
internal),iBGP也使用TCP连接传送BGP报文。图4-45(b)中
示边界路由器民在三个
iBGP连接上，向AS2内部的其他三个路由器转发自己收到的BGP路由。至此，AS2内的所
有路由器都知道了这条BGP路由信息。由此可见，协议BGP并非仅运行在AS之间，而且
也要运行在AS的内部。
表协议BGP规定，在一个AS内部所有的iBGP必须是全连通的。即使两个路由器之间没•169•有物理连接，但它们之间仍然有iBGP连接（如图4-46所示）。
勺－AS��;;,,d三三/一二三iBGPAS
��:�三一／iBGP实线是路山器之间的物理连接虚线是路由器之间的iBGP连接图4-46在AS内路巾器之间的物理连接与iBGP连接这里要说明一下。图4-45(a)中的边界路由器凡通告给边界路由器民的BGP路由可(cid:7126)
有很多条（在图中只画出了一条）。但凡根据本AS管理员所规定的策略，可以拒绝某些路
由（收到这种路由后即删除掉），而在iBGP连接上仅转发符合规定策略的BGP路由。
我们还需要指出，虽然eBGP和iBGP的最后一个字母P是代表”协议(Protocol)",但
eBGP和iBGP并不是两个不同的协议。根据RFC4271,eBGP是在不同AS的两个对等端
之间的BGP连接，而iBGP是同一AS的两个对等端之间的BGP连接。在这两种不同连接
上传送的BGP报文，都遵循同样的协议BGP,使用同样的报文格式和具有同样的属性类型。
唯一的不同点就是在发送BGP路由通告时的规则有所不同。这就是，从eBGP对等端收到
的BGP路由，可通过iBGP告诉同一AS内的对等端。反过来也是可以的，即从iBGP对等
端收到的BGP路山，可通过eBGP告诉在不同AS的对等端。但是，从iBGP对等端收到
BGP路由，不(cid:7132)转告给同一个AS内不同iBGP的对等端。
图4-47形象地说明了eBGP和iBGP的作用。图中画出了四个(cid:7151)治系统AS,每一个
AS都必须运行本AS选择的内部网关协议IGP,例如OSPF或RIP。而协议BGP是在iBGP连接和eBGP连接之上运行的。
lGP协议1|IGP协议r||IGP协议AS1AS2AS3AS4图4-47协议BGP在iBGP和eBGP之上运行扫－扫视频讲解后面我们经常要讲到BGP路由，因此下面介绍一下BGP路由的一(cid:7183)格式。前面例子中的BGP路由正是按照这种格式书写的。
BGP路由＝“前缀BGP属性”=“前缀AS-PATH,NEXT-HOP"前缀的意思很明确，就是通告的BGP路由终点（子网前缀）。
BGP属性有好几种类型，但最重要两个就是这里列出的AS-PATH和NEXT-HOP。
AS-PATH（(cid:7152)治系统路径）是通告的BGP路由所经过的(cid:7151)治系统。BGP路由每经过一
个AS,就将其(cid:7152)治系统号ASN加入到AS-PATH中（本(cid:7188)在举例中没有使用具体的ASN
数字号码，而是用AS1,AS2等符号来表示不同的AS)。从这里可以清楚地看出，“BGP路由“
必须指出通过哪些(cid:7151)治系统AS,但不指出路由中途要通过哪些路由器。
NEXT-HOP（下一跳）是通告的BGP路由起点。
细心的读者会发现，路由问题并未都解决完。例如，在图4-48中AS2内的路由器凡在收到BGP路由“X,AS1,R1"后，知道了“从R1出发就(cid:7126)到达AS1中的前缀X”。但路由器•170•凡应当怎样构造(cid:7149)己的转发表呢？这需要经过两次递归查找。
R3AS2�、G归）PR4=--iBGP..---�--八eBUY
\边界路由器BGP路由
的起点BGP路由lASlI-�__,,,＼竺玉�x)/x图4-48BGP路由的起点、经过的AS和终点首先，凡要把这条BGP路由的起点进行转换。原来的BGP路由是“R1-X",路由的
起点民并不在AS2中。AS2中的路由器都不(cid:7126)识别R1。因此现在凡要把BGP路由的起点
改为民的对等端R2,把BGP路由变为“R2-R1-X”
。由于民位千AS2中，因此AS2里面
的所有路由器都(cid:7126)把分组转发到R2,然后就(cid:7126)再经过R1,最后到达前缀X。
其次，凡要利用内部网关协议，找到从凡到民的最佳路由中的下一跳。在本例中，查出下一跳是R3。千是凡在转发表中增加了到达前缀X的下一跳是凡这一项目。
x匹配1下广I转发表中有下一跳民表：：缀X可达。
用类似的方法，路由器民也在(cid:7149)己的转发表中增加了到达前缀X的项目。
前缀匹配1下厂I转发表中有下一跳R咦：月：缀X可达。
这样，路由器凡只要收到要到达前缀X的分组，都按照凡-R3-R2-R1-X的路径，最后到达前缀X。
总之，每一个路由器收到一条新的BGP路由通告后，必须经过上述步骤，才(cid:7126)在(cid:7151)己
的相应项目。
＂的转发表中，增加到达终点的“下一跳
在实际的转发表中，“前缀匹配”项目都用CIDR记法表示。由于路由器有两个以上的“下一跳”接口，因此
理时，我们就用更简洁的符号来表示。
项目用进入该路由器的接口的IP地址来表示。在讲解协议BGP的原3三种不同的(cid:7152)治系统AS在互(cid:7110)网中(cid:7151)治系统AS的数量非常之多，其连接图也是相当复杂的。但归纳起来，可
以把AS划分为图4-49中所示的三大类，即末梢AS(stubAS)、穿越AS(transitAS)和对等
AS(peeringAS)。
穿越AS图4-49几种不同类型的AS•171•未梢AS是比较小的AS（如图中的AS4,ASs和AS6)，其特点是这些AS或者把分组发送给其直接连接的AS,或者从其直接连接的AS接收分组，但不会把来(cid:7149)其他AS的分组
再转发到另一个AS。末梢AS必须向所连接的AS付费才(cid:7126)发送或接收分组。图中链路旁
边的人民币符号¥表示需要对转发分组付费。
末梢AS也可以同时连接到两个或两个以上的AS（如图4-49中的AS5)。这种末梢AS
就称为多归属AS(multihomedAS)。多归属AS可以增加连接的可靠性，因为若有一条连接
出现故障，那么还有另一条连接可用。作为未梢AS的AS5不(cid:7126)把AS3发送过来的分组转发
到AS2。同理，AS5也不(cid:7126)把AS2发送过来的分组转发到AS3。这就是说，末梢AS不是穿
越AS,它不允许分组穿越(cid:7150)己的(cid:7163)治系统。末梢AS5也不(cid:7126)把(ASs-AS2-AS4)这样的BGP路由信息通告给AS3。如果AS3有分组要转发给AS4,可以通过对等AS2转发，但不(cid:7126)
通过末梢AS沪如图4-49所示的穿越AS1往往是拥有很好的高速通信干线的主干AS,其任务就是为其他的AS有偿转发分组。通常都会有很多的AS连接到穿越AS上。
对等AS（如图4-49中的AS2和AS3)是经过事先协商的两个AS,彼此之间的发送或接收分组都不收费，这样大家转发分组都比较方便。
这里我们要强调一下，BGP路由必须避免兜圈子的出现。现观看图4-49所示的几个(cid:7149)
治系统AS。AS3向AS1通告可到达AS6的BGP路由中的属性AS-PATH是[AS3AS小AS1在收到的BGP路由的属性AS-PATH中的最前面，添加上(cid:7151)己的AS,通报给AS2:[AS1AS3AS6]。AS2收到BGP路由后，向AS3通报BGP路由属性AS-PATH是[AS2AS1AS3AS小
当AS3收到BGP路由后，检查属性AS-PATH序列中已经有了(cid:7149)己的AS3,如果AS3接受这个路由，并添加上本AS号，则将在属性AS-PATH中出现两个AS3（见有灰(cid:7187)底纹的两个
AS凸[AS3AS2ASIAS3AS6]。这就构成了一个兜圈子的BGP路由，因此AS3应立即删除
此BGP路由，因而避免了兜圈子路由的出现。请记住，在属性AS-PATH中不允许出现相同的AS。
AS3还可向AS2通报可到达AS6的另一条BGP路由，其AS-PATH是[AS3AS6]。因此AS2知道有两条BGP路由可到达AS6,其AS-PATH是[AS2AS1AS3AS6]和[AS2AS3AS小4.BGP的路由选择假如从一个AS到另外一个AS中的前缀X只有一条BGP路由，那么就不存在选择BGP路由的问题，因为这时BGP路巾是唯一的。
但如果到前缀X有两条或更多的BGP路由可供选择，那么就应当根据以下的原则，按照这里给出的先后顺序，选择一条较好的BGP路由。
•本地偏好LOCAL-PREF(LOCALPREFerence)值最高的路由要首先选择。
在BGP路由中的属性里面有一个选项叫作本地偏好，在属性中记为LOCAL-PREF。本
的意思是指，从本AS开始的、到同一个前缀的不同BGP
地偏好也就是本地优先，“本地
路由中，挑选一个较好的（即偏好值最高的）路由。这可由路由器管理员或网络管理员根据
政治上或经济上的策略来设置。
”例如在图4-50中，AS1分别用高速和低速链路连接到AS2和AS3,并从这两个AS获悉，可通过AS2或AS3到达AS4。但AS1认为，若有分组要从AS1转发到AS4,应优先选择路由
器民离开AS1。千是就把从民离开AS1的BGP路由的属性LOCAL-PREF值设为300,而•172•把从民离开AS1的BGP路由的LOCAL-PREF值设为200。这一信息通过iBGP通告AS1内
部的所有路由器。这样，凡是有分组要转发到AS4,都优先选择从凡离开AS1。
LOCAL-PRF=300IE优先选择从R1到AS2的BGP路由图4-50LOCAL-PREF值较高的路由优先但是，即使所有的通信量都通过这条高速链路，使得链路负荷过重，协议BGP也无法把一些负载调整到负载较轻的那条低速链路上。
如果从几条BGP路由中找不出本地偏好值最高的路由，则执行下一条。
•选择具有AS跳数最少的路由。
现观察图4-51的例子。从AS1到AS5共有两条BGP路由，即AS,-AS2-AS3-ASs和AS1-AS4-ASs。根据选择具有AS跳数最少的原则，我们应选择只通过1个AS的BGP路由，即AS1-AS4-ASs。但是没有想到，分组在AS4中反而要经过更多次数的转发（或许
AS4是个很大的AS)，可(cid:7126)要花费更长的时间。可见选择经过AS数量最少的路由AS1-AS4一AS5未必更好。这个例子再次说明了协议BGP无法选择出最佳路由。
I经过2个ASI优先选择经过1个ASBGP的路由图4-51根据经过AS跳数的多少选择BGP路由•使用热土豆路由选择算法。
如果按前两种方法都无法选择最好的路由，那么就在要进入BGP路由的AS,执行热土豆路由选择算法。例如在图4-52中，从AS1出发，共有两条BGP路由可到达AS3:BGP路由1：从民离开AS1,然后进入AS2,再到AS沪BGP路由2：从凡离开AS1,然后进入AS2,再到AS沪R1.,,,.,--•臧\-二-－\-－AS3))
＼图4-52热土豆路由选择算法的应用举例（图中的连接都是物理连接）假定这两条BGP路由的本地偏好相同，同时所经过的AS个数也相同。在这种情况下，•173•AS1中的每一个路由器，就应采用热土豆路由选择算法。这种算法把分组比喻为烫手的热土
豆，要尽快地转发出去。对于图4-52的例子，就是要使分组尽快离开AS1,而不考虑从哪个路由器离开AS1。或者说，要让分组经过最少的转发次数离开本AS。这时要使用内部网关协议（如协议OSPF或RIP)。对千不同的路由器，得出的选择结果是不同的。
例如，对千AS1中的路由器R1,若要使转发的分组尽快离开AS1,应选择凡作为其下一跳，因此应选择BGP路由2。这样，R1的转发路径应当是：R尸凡一BGP路由2。
同理，对于R2,若要使转发的分组尽快离开AS1,应选择民作为其下一跳，因此应选
R2择BGP路由l。这样，民的转发路径应当是：一R3一BGP路由1。
•选择路由器BGP标识符的数值最小的路由。
当以上几种方法都无法找出最好的BGP路由时，就可使用BGP标识符来选择路由。在
BGP进行交互的报文中，其首部有一4字(cid:7188)的字段，叫作BGP标识符，记为BGPID。这
个字段被赋予一个无符号整数作为运行BGP的路由器的唯一标识符。具有多个接口的路由
器有多个IP地址。BGPID就使用该路由器的IP地址中数值最大的一个。
5.BGP的四种报文在协议BGP刚运行时，BGP连接的对等端要相互交换整个的BGP路由表。但以后只需要在BGP路由发生变化时，才更新有变化的部分。这样做对(cid:7188)省网络带宽和减少路由器
的处理开销方面都有好处。
在RFC4271中规定了BGP-4的四种报文：
(1)OPEN（打开）报文，用来与BGP连接对等端建立关系。
(2)UPDATE（更新）报文，用来通告某一路由的信息，以及列出要撤销的路由。
(3)KEEPALIVE（保活）报文，用来周期性地证实与对等端的连通性。
(4)NOTIFICATION（通知）报文，用来发送检测到的差错。
OPEN报文是两个路由器之间建立了TCP连接后接着就必须发送的报文。OPEN报文
的作用是相互识别对方，协商一些协议参数（如计时器的时间）。收到OPEN报文的路由器，
就发回KEEPALIVE报文表示接受建立BGP连接。
UPDATE报文是BGP协议的核心，用来撤销它以前曾经通知过的路由，或宣布增加新的路由。撤销路由可以一次撤销许多条，但增加新路由时，每个更新报文只(cid:7126)增加一条。
虽然BGP连接的两端建立了TCP连接，传输报文是可靠的，但TCP上层的BGP是否
始终正常工作还无法确知。在对等端之间定期传送BGP路由表是不可取的，因为BGP路由表往往过千庞大，这样做会使网络的通信量过大。因此协议BGP采用的方法是让BGP连接
的两个对等端之间，周期性地交换KEEPALIVE报文，以表示协议工作正常。KEEPALIVE
报文只包含BGP报文的通用首部(19字(cid:7188)长），因此不会在网络上产生多少开销。
每个路由器都有一个保持时间计时器(HoldTimer)。路由器每收到一个BGP报文，这个
计时器就重置一次，继续从0开始计时。如果在商定的保持时间内没有收到对等端发来的任
何一种BGP报文，就认为对方已经不(cid:7126)工作了。发送KEEPALIVE报文的时间间隔取为双
方事先商定的保持时间(HoldTime)的1/3。例如，在BGP连接建立阶段，双方商定保持时间
为180秒，那么KEEPALIVE报文就每隔60秒发送一次。如果两个对等端选择的保持时间
不一(cid:7175)，就选择数值较小的一个作为彼此使用的保持时间。保持时间也可选择为0。在这种
情况下就永远不发送KEEPALIVE报文，表明这条BGP连接总是正常工作的。
BGP可以很容易地解决距离向量路由选择算法中的“坏消息传播得慢”这一问题。当某•174•个路由器或链路出故障时，可以从不止一个邻站获得路由信息，因此很容易选择出新的路由。
在ASN升级到4字(cid:7198)后，号码ASN的范围从0~65535扩大到了0~4294967295。这
样就在互(cid:7110)网中存在两种不同的BGP报文。旧BGP报文使用2字(cid:7188)ASN,而新BGP报文
使用4字(cid:7198)的ASN,这时BGP路由中的路径属性记为AS4-PATH。使用新的和旧的BGP报
文的路由器若要进行通信，必须解决如何正确识别其ASN的问题[RFC6793]。
BGP报文是作为TCP报文的数据部分来传送的（如图4-53所示）。四种类型的BGP报文具有同样的首部。
IP首部图4-53BGP报文用TCP报文传送在讨论完路由选择之后，我们再来介绍路由器的构成。
4.6.5路由器的构成1.路由器的结构路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任扫一扫譬回芍
烂
器务是转发分组。从路由器某个输入端口收到的分组，按照分组要去的目的
地（即目的网络），把该分组从路由器的某个合适的输出端口转发给下一跳路由器。下一跳视频讲解路由器也按照这种方法处理分组，直到该分组到达终点为止。路由器的转发分组正是网络层
的主要工作。图4-54给出了一种典型的路由器的构成框图。
路由选择处理机I
I
I
I
I
I
I
'制控二II
I一面
件
路由选择、管理软层（}一分
层据组
面转发
硬（件））交换结构－图4-54典型的路由器的结构（图中的数字I~3表示相应层次的构件）从图4-54可以看出，整个的路由器结构可划分为两大部分：路由选择部分和分组转发部分。
路由选择部分也叫作控制部分，或控制层面，其核心构件是路由选择处理机。路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由•175•器交换路由信息而不断地更新和维护路由表。
分组转发部分是本(cid:7188)所要讨论的问题，也就是数据层面，它由三部分组成：交换结构、
一组输入端口和一组输出端口（请注意：这里的端口就是硬件接口）。小型路由器的端口只
有几个。但某些ISP使用的边缘路由器的高速10Gbit/s端口，则可以有多达几百个之多。
下面分别讨论每一部分的组成。例如，
10Gbit/s端口就有960个。路由器整个的系统容量为80Tbit/sJuniper（陷博网络）公司的边缘路由器MX2020的。
。
请注意“交换结构(switchingfabric)又称为交换组织，它的作用就是根据转发表(forwardingtable)
对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去。交换结构本
身就是一种网络，但这种网络完全包含在路由器之中，因此交换结构可看成是“在路由器中
的网络”“””“路由选择“””和转发是有区别的。在互(cid:7110)网中，就是路由器根据转
转发
仅仅涉及一个路由器。但
则涉及很多路由器，路由表则是许多路由器协同工作的结果。这些路由器按照发表把收到的IP数据报从路由器合适的端口转发出去。＂轧发
“路由选择
复杂的路由算法，得出整个网络的拓扑变化情况，因而(cid:7126)够动态地改变所选择的路由，并由
此构造出整个的路由表。路由表一(cid:7183)仅包含从目的网络到下一跳（用IP地址表示）的映射，
而转发表是从路由表得出的。转发表必须包含完成转发功(cid:7133)所必需的信息。这就是说，在转
发表的每一行必须包含从要到达的目的网络到输出端口和某些MAC地址信息（如下一跳的
以太网地址）的映射。将转发表和路由表用不同的数据结构实现会带来一些好处，这是因为
在转发分组时，转发表的结构应当使查找过程最优化，但路由表则需要对网络拓扑变化的计算最优化。路由表总是用软件实现的，但转发表则可用特殊的硬件来实现。请读者注意，在讨论路由选择的原理时，往往不去区分转发表和路由表的区别，而可以笼统地都使用路由表
这一名词。
在图4-54中，路由器的输入和输出端口里面都各有三个方框，用方框中的1,2和3分别代表物理层、数据链路层和网络层的处理模块。物理层进行比特的接收。数据链路层则按照链路层协议接收传送分组的帧。在把帧的首部和尾部剥去后，分组就被送入网络层的处理
模块。若接收到的分组是路由器之间交换路由信息的分组（如RIP或OSPF分组等），则把
这种分组送交路由器的路由选择部分中的路由选择处理机。若接收到的是数据分组，则按照分组首部中的目的地址杳找转发表，根据得出的结果，分组就经过交换结构到达合适的输出端口。一个路由器的输入端口和输出端口就做在路由器的线路接口卡上。
输入端口中的查找和转发功(cid:7134)在路由器的交换功(cid:7133)中是最重要的。为了使交换功(cid:7126)分
散化，往往把复制的转发表放在每一个输入端口中（如图4-54中的虚线箭头所示）。路由选
”(shadowcopy)。分
择处理机负责对各转发表的副本进行更新。这些副本常称为“影子副本
散化交换可以避免在路由器中的某一点上出现瓶颈。
以上介绍的查找转发表和转发分组的概念虽然并不复杂，但在具体的实现中还会遇到不少困难。问题就在于路由器必须以很高的速率转发分组。最理想的情况是输入端口的处理速率(cid:7126)够跟上线路把分组传送到路由器的速率。这种速率称为线速(linespeed或wirespeed)。
可以粗略地估算一下。设线路是OC-48链路，即2.5Gbit/s。若分组长度为256字(cid:7188)，那么
线速就应当达到每秒(cid:7126)够处理100刀以上的分组。现在常用Mpps（百万分组每秒）为单位
来说明一个路由器对收到的分组的处理速率有多高。在路由器的设计中，怎样提高查找转发
表的速率是一个十分重要的研究课题。
•176•当一个分组正在查找转发表时，后面又紧跟着从这个输入端口收到另一个分组。这个
后到的分组就必须在队列中排队等待，因而产生了一定的时延。图4-55给出了在输入端口
的队列中排队的分组的示意图。
输入端口的处理从
线
路
接
收
分组分网络层处理排队二查表和转发组交
换
结
构图4-55输入端口对线路上收到的分组的处理我们再来观察在输出端口上的情况（如图4-56所示）。输出端口从交换结构接收分组，
然后把它们发送到路由器外面的线路上。在网络层的处理模块中设有一个缓存区，实际上它
就是一个队列。当交换结构传送过来的分组的速率超过输出链路的发送速率时，来不及发送
的分组就必须暂时存放在这个队列中。数据链路层处理模块把分组加上链路层的首部和尾部，交给物理层后发送到外部线路。
输出端口的处理交
换
结
构网络层处理
分组排队JillII]缓存管理向
线
路
发
送
分
组图4-56输出端口把交换结构传送过来的分组发送到线路上从以上的讨论可以看出，分组在路由器的输入端口和输出端口都可(cid:7126)会在队列中排队等候处理。若分组处理的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只(cid:7126)被丢弃。以前我们提到过的分组丢失就是发生在路由器中的输入或输出队列产生溢出的时候。当然，设备或线路出故障也可(cid:7126)使分组丢失。
2.交换结构交换结构是路由器的关键构件[KUR017]。正是这个交换结构把分组从一个输入端口转
移到某个合适的输出端口。实现这样的交换有多种方法，图4-57给出了三种常用的交换方法。输入端口是A,B和C,输出端口是X,Y和Z。下面简单介绍它们的特点。
最早使用的路由器就是利用普通的计算机，用计算机的CPU作为路由器的路由选择处
理机。路由器的输入和输出端口的功(cid:7126)和传统的操作系统中的1/0设备一样。当路由器的某
个输入端口收到一个分组时，就用中断方式通知路由选择处理机。然后分组就从输入端口复
制到存储器中。路由器处理机从分组首部提取目的地址，查找路由表，再将分组复制到合适
的输出端口的缓存中。若存储器的带宽（读或写）为每秒M个分组，那么路由器的交换速
率（即分组从输入端口传送到输出端口的速率）一定小于M/2。这是因为存储器对分组的读•177•和写需要花费的时间是同一个数量级。
线(a)通过存储器A(b)通过总线互连网络(c)通过互连网络图4-57三种常用的交换方法许多现代的路由器也通过存储器进行交换，图4-57(a)的示意图表示分组通过存储器进行交换。与早期的路由器的区别就是，目的地址的查找和分组在存储器中的缓存都是在输入
端口中进行的。思科(Cisco)公司的Catalyst8500系列交换机（有的公司把路由器也称为交换机）就采用了共享存储器的方法。
图4-57(b)是通过总线进行交换的示意图。采用这种方式时，数据报从输入端口通过共享总线直接传送到合适的输出端口，而不需要路山选择处理机的干预。但是，由千总线是共
享的，因此在同一时间只(cid:7126)有一个分组在总线上传送。当分组到达输入端口时若发现总线忙
（因为总线正在传送另一个分组），则被阻塞而不(cid:7126)通过交换结构，并在输入端口排队等待。
因为每一个要转发的分组都要通过这一条总线，因此路由器的转发带宽就受总线速率的限制。
现代的技术已经可以将总线的带宽提高到(cid:7126)够满足小型企业网的需求。例如，思科公司的
6500路由器用来交换分组的(cid:7125)板总线速率已达到32Gbit/s。
图4-57(C)画的是通过纵横交换结构(crossbarswitchfabric)进行交换。这种交换机构常称
为互连网络(interconnectionnetwork)，它有2N条总线，可以使N个输入端口和N个输出端
口相连接，这取决千相应的交叉(cid:7196)点是使水平总线和垂直总线接通还是断开。当输入端口收
到一个分组时，就将它发送到与该输入端口相连的水平总线上。若通向所要转发的输出端口
的垂直总线是空闲的，则在这个(cid:7192)点将垂直总线与水平总线接通，然后把该分组转发到这个
输出端口。例如，一个分组到达输入端口A,应转发到输出端口Y。这时交换结构的控制器
就把总线A和Y的交叉(cid:7188)点闭合，因此分组就从输入端口A传送到了输出端口Y。请注意，
如果与此同时还有一个分组要从输入端口B转发到输出端口Z,那么也可同时进行，因为A
-Y和B-Z的转发是使用不同的总线的转发。和前两种交换机制不同，这种纵横交换结构
是一种无阻塞的交换结构，其特点是分组可以转发到任何一个输出端口，只要这个输出端口
没有被别的分组占用。如果这个输出端口（即对应的垂直总线）已被占用（有另一个分组正•178•在转发到同一个输出端口），那么后到达的分组就必须在输入端口排队等待。采用这种交换
方式的路由器例子如思科公司的12000系列交换路由器，其互连网络的速率达60Gbit/s。
4.7IP多播4.7.1IP多播的基本概念1988年SteveDeering首次在其博士学位论文中提出IP多播的概念。1992年3月IETF
在互(cid:7110)网范围首次试验IETF会议声音的多播，当时有20个网点可同时听到会议的声音。IP
多播是需要在互(cid:7110)网上增加更多的智(cid:7126)才(cid:7126)提供的一种服务。现在IP多播(multicast,以
前曾译为组播）已成为互(cid:7110)网的一个热门课题。这是由千有许多的应用需要由一个源点发送
到许多个终点，即一对多的通信。例如，实时信息的交付（如新闻、(cid:7122)市行情等）、软件更
新、交互式会议等。随着互(cid:7110)网的用户数目的急剧增加，以及多媒体通信的开展，有更多的业务需要多播来支持。
与单播相比，在一对多的通信中，多播可大大(cid:7188)约网络资源。图4-58(a)是视频服务器
用单播方式向90台主机传送同样的视频(cid:7188)目。为此，需要发送90个单播，即同一个视频分
组要发送90个副本。图4-58(b)是视频服务器用多播方式向属千同一个多播组的90个成员
传送(cid:7188)目。这时，视频服务器只需把视频分组当作多播数据报来发送，并且只需发送—次。
，民和凡各转发l
路由器在转发分组时，需要把收到的分组复制成3个副本，分别向R1R2个副本。当分组到达目的局域网时，由千局域网具有硬件多播功(cid:7126)，因此不需要复制分组，
在局域网上的多播组成员都(cid:7126)收到这个视频分组。
视频服务器M送90次单播发R21个压//|V
R1已三复伟
个
1炒<
产
J1个IR产If
。卢．
—=＝＝＝3l立怼1多播
3一一一一一产女－一一一一一一一一一巨－－－－－
：三——--,^!'.b:m:tl
1、、
I三］
心＇，；�
1···
:
，编
编俨．编｀
么
、、-----------------------------------------------------X(
···
．，�｀多』心1•••l
｀�个个、·．`｀，
:
＾，＇共有90个主机接收视频节目(a)单播．多播组成员共有90个
多播(b)＼，、图4-58单播与多播的比较当多播组的主机数很大时（如成千上万个），采用多播方式就可明显地减轻网络中各种
资源的消(cid:7107)。在互(cid:7110)网范围的多播要靠路由器来实现，这些路由器必须增加一些(cid:7126)够识别多
播数据报的软件。(cid:7126)够运行多播协议的路由器称为多播路由器(multicastrouter)。多播路由器当然也可以转发普通的单播IP数据报。
为了适应交互式音频和视频信息的多播，从1992年起，在互(cid:7110)网上开始试验虚拟的多播主干网MBONE(MulticastBackboneOntheInterNEt)。MBONE可把分组传播给地点分散
但属千一个组的许多台主机。现在多播主千网已经有了相当大的规模。
•179•