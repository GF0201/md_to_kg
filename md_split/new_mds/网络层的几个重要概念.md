第4章网络层本章讨论网络互连问题。在介绍网络层提供的两种服务和两个层面后，就进入本章的一IP,IP核心内容网际协议这是本书的个重点内容。只有深入地掌握了协议ICMP的主要内容，才能理解互联网是怎样工作的。本章还要讨论网际控制报文协议
IP1Pv6VPN、几种常用的路由选择协议、
NAT的主要特点、多播的概念等。在讨论虚拟专用网
SDNMPLS和网络地址转换后，最后简单介绍多协议标签交换和软件定义网络的基本概念。
本章最重要的内容是：(1)虚拟互连网络和两种服务、两个层面的概念。
(2)IPMAC(3)地址与地址的关系。
IPCIDR传统分类的地址和无分类域间路由选择（后者是重点）。
(4)路由选择协议的工作原理。
4.1网络层的几个重要概念4.1.1网络层提供的两种服务“”“”
在计算机网络领域，网络层应该向运输层提供怎样的服务(面向连接还是无连接)曾引起了长期的争论。争论焦点的实质就是：在计算机通信中，可靠交付应当由谁来负责？是网络还是端系统？
C有些人认为应当借助千电信网的成功经验，让网络负责可靠交付大家知道'/传统电信网的主要业务是提供电话服务。电信网使用昂贵的程控交换机（其软件也非常复杂），用面向连接的通信方式，使电信网络能够向用户（实际上就是电话机）提供可靠传输的服务。
因此他们认为，计算机网络也应模仿打电话所使用的面向连接的通信方式。当两台计算机进一Q)行通信时，也应当先建立连接（但在分组交换中是建立一条虚电路VC(VirtualCircuit))'以预留双方通信所需的切网络资源。然后双方就沿着已建立的虚电路发送分组。这样的分一组的首部不需要填写完整的目的主机地址，而只需要填写这条虚电路的编号（个不大的整数），因而减少了分组的开销。这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，当然也不丢失、不重复。在通信结束后要释放建立的虚电路。
2图4-l(a)是网络提供虚电路服务的示意图。主机凡和H之间交换的分组都必须在事先建立的虚电路上传送。
一但互联网的先驱者却提出种崭新的网络设计思路。他们认为，电信网提供的端到端可靠传输的服务对传统的电话业务无疑是很合适的，因为那时电信网的终端（电话机）非常印注：虚电路表示这只是一条逻辑上的连接，分组都沿着这条逻辑连接（好像是一条物理连接）按照存储转发方式传送，而并不是真正建立了一条物理连接。请注意，电路交换的电话通信是先建立了一条真正的连接。因此分组交换的虚连接和电路交换的连接只是类似而已，并不完全一样。
•115•简单，没有智能，更没有差错处理能力。因此电信网必须负责把用户电话机话筒产生的话音信号可靠地传送到对方的电话机，使其耳机发出的声音符合话音质量的技术规范要求。但计算机网络的端系统是有智能的计算机。计算机有很强的差错处理能力（这点和传统的电话机有本质上的差别）。因此，互联网在设计上就采用了和电信网完全不同的思路。
互联网采用的设计思路是这样的：网络层要设计得尽量简单，向其上层只提供简单灵“”活的、无连接的、尽最大努力交付的数据报服务气这里的数据报(datagram)是互联网“”的设计者最初使用的名词，其实数据报（或IP数据报）就是我们经常使用的分组。在本一
书中，IP数据报和IP分组是同义词，可以混用。
网络在发送分组时不需要先建立连接。每个分组（也就是IP数据报）独立发送，与其前后的分组无关（不进行编号）。网络层不提供服务质量的承诺。也就是说，所传送的分组可能出错、丢失、重复和失序（即不按序到达终点），当然也不保证分组交付的时限。由千传输网络不提供端到端的可靠传输服务，这就使网络中的路由器比较简单，且价格低廉（与电信网的交换机相比较）。如果主机（即端系统）进程之间需要进行可靠的通信，那么
就由主机中的运输层负责（包括差错处理、流量控制等）。采用这种设计思路的好处是：网络造价大大降低，运行方式灵活，能够适应多种应用。互联网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。
1图4-l(b)给出了网络提供数据报服务的示意图。主机H向H2发送的分组各自独立地查找路由器中的转发表，逐跳传送到目的主机。在分组传送的过程中有丢失的可能。
(a)虚电路服务（所有的数据都在此虚电路上传送）Hi,I,,,已/:－(b)数据报服务（数据传送的路径是不确定的）图4-1网络层提供的两种服务OSI体系的支持者曾极力主张在网络层使用可靠传输的虚电路服务，也曾推出过网络层虚电路服务的著名标准ITU-T的X.25建议书。但现在X.25早已成为历史文献了。
表4-1归纳了虚电路服务与数据报服务的主要区别。
切注：尽最大努力交付(besteffortdelivery)当然不表示路由器可以任意丢弃分组，但这种交付方式实质上就是不可靠交付。
一“＂，顺便提下，文献中也常使用尽力而为的译名。这个译名固然较为简洁但似不够准确。
•116•对比的方面表4-1虚电路服务与数据报服务的对比虚电路服务数据报服务思路可靠通信应当由网络来保证可靠通信应听旧用尸主机来保证连接的建立必须有小点要终点地址分组的转发仅在连接建立阶段使用，每个分组使用短的虚电路号旬个分组都有终点的完整地址，即IP地址属千同一条虚电路的分组均按照同一路由进行转发每个分组独立合找转发表进行转发当节点出故障时所有通过出故障的节占的虚电路均不能工作出故障的节点可能会工失分组，一些路由可能分组的顺序总是按发送顺序到达终占到达终点的斯i序小一定按发送的顺序端到端的差错处理可以由网络负责，也可以由用户主机负责由用户主机负责会发生变化和流量控制4.1.2网络层的两个层面在上面4.1.1节中，我们已经讲过，不同网络中的两个主机之间的通信，要经过若干个一路由器转发分组来完成，分组查找路由器中的转发表，从指明的接口转发到下个路由器。
但转发表是怎样得出的呢？是从路由表导出的，而路由表又是山互联网中许多的路由器，按照共同选定的路由选择协议，通过许多次的相互交换路由信息而产生的。由此可见，在路由器之间传送的信息有以下两大类：一第类是转发源主机和目的主机之间所传送的数据，把源主机所发送的分组，像接力一一赛跑那样从个路由器转发到下个路由器，最后把分组传送到目的主机。
第二类则是传送路由信息，是根据路由选择协议所使用的路由算法，彼此不断地交换一一路由信息分组，目的是为了在路由器中创建路由表，并由此导出为转发分组而用的转发表。
这类信息的传送是为第类数据的传送服务的。
用图4-2的方法来描述，也就是把网络层抽象地划分为数据层面（或转发层面）和控制＂＂层面。这里所说的层面(plane)"和体系结构中的”“
“
层次(layer)"很相似，都是抽象的概念。
”此处的plane目前国内尚无标准译名，也可以译为面。曾有人译为平面，但本书不采“”用这个译名，因为这容易联想到是几何学中的平面（其实与这种平面并无关联）。名词层一面是目前文献中通用的抽象术语。在个路由器实体中，显然无法看见这种抽象的层面。
控制层面
------------
数据层面这两个层面的机制相差很大。在数据层面中，每个路由器根据本路由器生成的转发图4-2网络层的数据层面和拧制层面一表，把收到的分组，从查找到的对应接口转发出去。为了加快转发的速率，现在的路由器通
个分组的时间为纳秒(10-9秒）数量级。但在控制层面中的常都采用硬件进行转发，转发一•117•情况则不同。一个路由器不可能独自创建出路由表。路由器必须和相邻的路由器经常交换路
山信息，然后才能创建出本路由器的路由表。根据路由选择协议所用的路由算法计算路由要
使用软件，这就慢多了，一般是秒的数昌级。从以上所述不难看出，数据层面的问题比较单
纯，因为路由器在转发分组时，是独立地根据本路由器的转发表转发分组的，但控制层面就
比较复杂，因为路由器要创建路由表，就必须依靠许多路由器协同动作。不同的路由选择协
议定义了不同的协同动作方式。路由器的生产厂家在制造路由器时，已经在路由器内部嵌入
了路由选择的通信模块，使得路由器之间能够按照路由选择算法进行相庄之间的通信。
从互联网诞生之日起，路由器就是按照图4-2所示的模式工作的。本教材过去的几个版本在讲解路由器的结构时，虽然没有使用控制层面和数据层面的概念，但已经把路由器划分为路由选择和分组转发两大部分。其实这两部分的位置就分别处在图4-2所示的控制层面和数据层面之中。现在介绍网络层中控制层面和数据层面的概念，是因为最近在网络界提出的
软件定义网络SDN(SoftwareDefinedNetworkf'，正在对这两个层面的结构进行了重大的改
变。图4-3就是SDN提出的这两个层面的构成。
远程控制器控制层面
..．·-一·伞一一-----
数据层面图4-3软件定义网络SON中的控制层面和数据层面我们注意到，在传统的互联网中，每一个路由器中，既有转发表又有路由选择软件，因
此在图4-2中所画的虚线长方形方框也强调了这个特点。也就是说，每个路由器中，既有数
据层面也有控制层面。但在图4-3所示的SDN结构中，所有的路由器都变简单了。路由器
中的路由选择软件都不存在了，因此路由器之间不再相互交换路由信息。在网络的控制层面
有一个在逻辑上集中的远程控制器（但在物理上可以由不同地点的多个服务器组成）。远程
控制器掌握各主机和整个网络的状态，能够为每一个分组计算出最佳的路由，然后在每一个
路由器中生成其正确的转发表。路由器的工作很单纯，即收到分组，查找转发表，转发分组。
这样，网络又变成为集中控制的。本来互联网是分散控制的，为什么现在又提出集中
控制呢？其实，软件定义网络SDN的提出，并非现在要把整个互联网都改造为如图4-3所
示的集中控制模式，这是不现实的。然而在某些具体条件下，特别是像一些大型的专用数据
中心之间的广域网，若使用SDN模式来建造，就可以使网络运行的效率提高，同时还可以
获得更好的经济效益。因此，建议读者关注这一新动向。在本书4.10节将简要介绍SDN。
下面我们仍然按照传统互联网的机制，陆续介绍属千数据层面的协议IP,然后再讨论CD注：目前文献上出现的名词SDN尚无公认的权威定义。而SDN的英文写法也还有另外种，即SoftwareDefined“”Networking,按照这种写法，中文的译名似应为
＂“软件定义的连网，即突出强调了连网的方式。考虑到目前中文的文献资料都一是使用软件定义网络，故本书也采用这样的译名。
•118•属千控制层面的各种路由选择协议。
4.2网际协议IP网际协议IP(InternetProtocol)是TCP/IP体系中两个最主要的协议之一[STEV94][COME06][FORO10]，也是最重要的互联网标准协议之[RFC791,STD5]。网际协议IP又一称为Kahn-Cerf协议，因为这个重要协议正是RobertKahn和VintCerf二人共同研发的。这“”两位学者在2004年获得图灵奖（其地位相当于计算机科学领域的诺贝尔奖)。严格来说，这里所讲的IP其实是IP的第4个版本，记为IPv4。但在讲述协议IP的各种原理时，常省
略IP后面的版本号。在后面的4.5节我们再介绍较新的版本IPv6（版本1~3和版本5都未一曾使用过。顺便指出，所谓的IPv9只不过是某些人故意的炒作而已，不值提）。
与协议IP配套使用的还有三个协议：•地址解析协议ARP(AddressResolutionProtocol)
•网际控制报文协议ICMP(InternetControlMessageProtocol)
•网际组管理协议IGMP(InternetGroupManagementProtocol)一本来还有个协议叫作逆地址解析协议RARP
(ReverseAddressResolutionProtocol)，是和协议ARP配合使用的，但现在已被淘汰不使用了。
一图4-4画出了这三个协议和网际协议IP的关
层中，ARP画在最下面勹因为IP经一系。在这常要使用这个协议。
ICMP和IGMP画在这层的上部，因为它们要使用协议IP。这三个协议将在后面陆续介绍。由于网际协议IP是用来使互连起来的许多计算机网络能够进行通信的，因此
“
TCP/IP体系中的网络层常常被称为网际层(internet
这个名词的好处layer)，或IP层。使用网际层”应用层各种应用层协议(HTTP,FTP,SMTP等）TCP,UDP运输层网络层l压三
（网际层）lIP网络接口层与各种网络接口三物理硬件
，
:_----------------------------------------__:图4-4网际协议IP及其配套协议“”是强调了这是由很多网络构成的互连网络。目前比较普遍使用网络层这个名词。
在讨论网际协议IP之前，必须了解什么是虚拟互连网络。
4.2.1虚拟互连网络我们知道，如果要在全世界范围内把数以百万计的网络都互连起来，并一且能够互相通信，那么这样的任务定非常复杂。其中会遇到许多需要解决视频讲解的问题，如：句注：在互联网标准中，ARP彶列入链路层协议[RFC1122,STD3]，因此有些教科书就把ARP放在链路层中介绍[COME06][STEV94][KUROl7]。但是ARP并不知道自己是处在协议栈的哪一层。从程序调用的关系看，ARP实际上处在链路层和网络层之间[KOZI05]，但不少著名教材都是把ARP放在网络层中讲授的[TANEII][PETE12][FOROIO][STALIO]。从教学的观点看，如果从协议的底层自卜往上讲授，那么在学习链路层时就讲解ARP的工作原理，因涉及到IP地址的转换，似不易理解。
编者的意见是，既然协议ARP实际上处于链路层和网络层之间，从教学法的角度考虑，对千自底层计始讲的教材，放在网络层讲述似较为方便。实际上，重要的是搞沽ARP的工作原理，不必过千纠缠ARP究竟属于哪一层。
•119•