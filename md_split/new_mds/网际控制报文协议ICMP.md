4.4网际控制报文协议ICMP为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协
sageProtocol)[RFC792,STD5]。ICMP允许主机或路由器报
议ICMP(InternetControlMes
告差错情况和提供有关异常情况的报告。ICMP是互(cid:7110)网的标准协议。但ICMP不是高层协
议（看起来好像是高层协议，因为ICMP报文装在IP数据报中，作为其中的数据部分），而
是IP层的协议。ICMP报文作为IP层数据报的数据，加上数据报的首部，组成IP数据报发送出去。ICMP报文格式如图4-28所示。
前4个字节是统的格式位0类型
（这4一ICMP81631代码检验和个字节取决千报文的类型）ICMP
的数据部分（长度取决于类型）首部,数据报IP•图4-28ICMP报文的格式4.4.1ICMP报文的种类ICMP报文有两种，即ICMP差错报告报文和ICMP询问报文。
ICMP报文的前4字(cid:7188)是统一的格式，共有三个字段：类型、代码和检
验和。接着的4字(cid:7188)的内容与ICMP的类型有关。最后面是数据字段，其扫一扫视频讲解长度取决于ICMP的类型。表4-6给出了几种常用的ICMP报文类型。
表4-6几种常用的ICMP报文类型报文种类类型的值ICMP报文的类型ICMP差错报告报文询问报文3II125终点不可达时间超过参数问题改变路由(Redirect)8或0回送(Echo)请求或回送回答13或14时间戳(Timestamp)请求或时间戳回答ICMP标准在不断更新。已不再使用的ICMP报文有：“信息请求与回答报文”“地址掩码请求与回答报文”“路由器请求与通告报文”以及“源点抑制报文”[RFC6633]。
ICMP报文的代码字段用于进一步区分某种类型中的几种不同情况。检验和字段用来检验整个ICMP报文。我们应当还记得，IP数据报首部的检验和并不检验IP数据报的内容，因此不(cid:7126)保证经过传输的ICMP报文不产生差错。
表4-6给出的ICMP差错报告报文共有四种，即：(1)终点不可达当路由器或主机不(cid:7126)交付数据报时就向源点发送终点不可达报文。
•146•(2)时间超过当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向
源点发送时间超过报文。当终点在预先规定的时间内不(cid:7126)收到一个数据报的全部数据报片时，
就把已收到的数据报片都丢弃，并向源点发送时间超过报文。
(3)参数问题当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
(4)改变路由（重定向）路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（也就是说，找到了更好的路由）。
下面对改变路由报文进行简短的解释。我们知道，在互(cid:7110)网的主机中也要有一个转发
表。当主机要发送数据报时，首先查找主机(cid:7151)己的转发表，看应当从哪一个接口把数据报发
送出去。在互(cid:7110)网中主机的数量远大于路由器的数量，出于效率的考虑，这些主机不和连接
在网络上的路由器定期交换路由信息。在主机刚开始工作时，一(cid:7182)都在转发表中设置一个默
认路由器的IP地址。不管数据报要发送到哪个目的地址，都一律先把数据报传送给这个默
认路由器，而这个默认路由器知道到每一个目的网络的最佳路由（通过和其他路由器交换路由信息）。如果默认路由器发现主机发往某个目的地址的数据报的最佳路由应当经过网络上
的另一个路由器R,就用改变路由报文把这情况告诉主机。千是，该主机就在其转发表中增
加一个项目：到某某目的地址应经过路由器R（而不是默认路由器）。
所有的ICMP差错报告报文中的数据字段都具有同样的格式（如图4-29所示）。把收到
的需要进行差错报告的IP数据报的首部和数据字段的前8个字(cid:7194)提取出来，作为ICMP报
文的数据字段。再加上相应的ICMP差错报告报文的前8个字(cid:7188)，就构成了ICMP差错报告报文。提取收到的数据报的数据字段前8个字(cid:7194)是为了得到运输层的端口号（对千TCP和UDP)以及运输层报文的发送序号（对千TCP)。这些信息对源点通知高层协议是有用的（端口的作用将在5.1.3(cid:7194)中介绍）。整个ICMP报文作为IP数据报的数据字段发送给源点。
IP数据报的数据字段首部,IP数据报，装入ICMP报文的IP数据报图4-29
下面是不应发送ICMP差错报告报文的几种情况：ICMP差错报告报文的数据字段的内容•对ICMP差错报告报文，不再发送ICMP差错报告报文。
•对第一个分片的数据报片的所有后续数据报片，都不发送ICMP差错报告报文。
•对具有多播地址的数据报，都不发送ICMP差错报告报文。
•对具有特殊地址（如127.0.0.0或0.0.0.0)的数据报，不发送ICMP差错报告报文。
常用的ICMP询问报文有两种，即：
(1)回送请求或回送回答ICMP回送请求报文是由主机或路由器向一个特定的目的•147•主机发出的询问。收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。
(2)时间戳请求或时间戳回答在ICMP时间戳请求报文发出后，就(cid:7126)够收到对方响应的ICMP时间戳回答报文。利用在报文中记录的时间戳（如报文的发送时间和接收时间），发送方很容易计算出当前网络的往返时延。
4.4.2ICMP的应用举例ICMP的一个重要应用就是分组网间探测PING(PacketInterNetGroper)，用来测试两台
主机之间的连通性。PING使用了ICMP回送请求与回送回答报文。PING是应用层直接使
用网络层ICMP的一个例子。它没有通过运输层的TCP或UDP。
Windows操作系统的用户可在接入互(cid:7110)网后转入MSDOS（点击“开始”，点击“运
“cmd”)。看见屏幕上的提示符后，就键入“pinghostname"（这里的hostname
，再键入“行是要测试连通性的主机名或它的IP地址），按回车键后就可看到结果。
图4-30给出了从南京的一台PC到新浪网的邮件服务器mail.s
试结果。PC一连发出4个ICMP回送请求报文。如果邮件服务器mail.s
而且响应这个ICMP回送请求报文（有的主机为了防止恶意攻击就不理睬外界发送过来的这ina.com.cn的连通性的测ina.com.cn正常工作种报文），那么它就发回ICMP回送回答报文。由于往返的JCMP报文上都有时间戳，因此很容易得出往返时间。最后显示出的是统计结果：发送到哪个机器(Ip地址），发送的、收到的和丢失的分组数（但不给出分组丢失的原因），以及往返时间的最小值、最大值和平均值。从得到的结果可以看出，第三个测试分组丢失了。
c：寸ocurqentsandSettings-...XXR}pingmail.sina.com.cnPingingA.ail申sinaJCO门．en[202.108警43.2301with32bytesofdata:Replyfi-otr1202.108.43.230:bytes=32till'le=368AsTTL=-242
Replyf1地Off\202心108岭43.230:bytes.:.J2ti1Tte""3?4AsTTL.:::242
Requesttif!ledout畴
Replyf1物om202蟾108噶43.230:bytes=32tillle""3?4msTTL=242Pingstatisticsfol"202.108.43.230:Packets:Sent笾4步Received笠3,.Lost立1(25zl0$s)，nPPI..oxiAate1冯oundt｀噜iptiAsin111illi-sconds:Hininum=368ms,.Maximum=374111s鼻Avel'age=3?2As七仑图4-30用PING测试主机的连通性另一个非常有用的应用是traceroute（这是UNIX操作系统中的命令），用来跟踪一个分
组从源点到终点的路径。在Windows操作系统中这个命令是tracert。下面简单介绍这个命令的工作原理。
traceroute从源主机向目的主机发送一连串的IP数据报，数据报中封装的是无法交付的
。当E到达路径上的第一个UDP用户数据报也。第一个数据报P1的生存时间TTL设置为1也注：无法交付的UDP用户数据报使用了非法的端口号（见下音5.2.2节）。
•148•一路由器凡时，路由器R1先收下它，接着把TTL的值减1
把P1丢弃，并向源主机发送一个ICMP时间超过差错报告报文。
。由千TTL等千零了，因此凡就源主机接着发送第二个数据报P2,并把TTL设置为2。贮先到达路由器R1,R1收下后把TTL减l再转发给路由器R2。民收到P2时TTL为1,但减l后TTL变为零了。民就丢
弃P2,并向源主机发送一个ICMP时间超过差错报告报文。这样一直继续下去。当最后一
个数据报刚刚到达目的主机时，数据报的TTL是1。主机不转发数据报，也不把TTL值减l。但因IP数据报中封装的是无法交付的运输层的UDP用户数据报，因此目的主机要向源主机发送ICMP终点不可达差错报告报文（见5.2.2(cid:7188)）。
这样，源主机达到了(cid:7151)己的目的，因为这些路由器和最后目的主机发来的ICMP报文正
好给出了源主机想知道的路由信息一一到达目的主机所经过的路由器的IP地址，以及到达
其中的每一个路由器的往返时间。图4-31是从南京的一个PC向新浪网的邮件服务器
ina.com.cn发出tracert命令后所获得的结果。图中每一行有三个时间出现，是因为对mail.s
应于每一个TTL值，源主机要发送三次同样的IP数据报。
我们还应注意到，从原则上讲，IP数据报经过的路由器越多，所花费的时间也会越长。
但从图4-31可看出，有时正好相反。这是因为互(cid:7110)网的拥塞程度随时都在变化，也很难预料到。因此，完全有这样的可(cid:7127)：经过更多的路由器反而花费更短的时间。
C:寸ocuAentsandSettings\Xl.:R)t1•ace:rtflldil.sina.co111.enTracing.ro,,tetof!la.il.sina.co111.cn[202.108.43.2301
ovet·aSti.axi111ufltof30hops:124”$24”$23ns222.95.1?2.1
223AS24lllS22ns221.231.204.129
323!TIS22IIIS23AS221.231.2部．9
424AS23lllS24ns202.9?.2?.3?
522FlS23fllS24ns202.97.41.226
628MS28m$28ns202.9?.35.2550l'IIS58m$S1AS202.9?.36噜86？
8308ns311n$310AS219.158.32.1
938?ms305”$385ns219.158.13.1?
10164FIS164IIIS165ns202.96.12.154
11322ms320111::2988ns61.135.148.50
12321lllS322"'s320nsfl•eenail43-230.sind.con[202.108.43.2301T.racecomplete.图4-31用trace1i命令获得目的主机的路由信息4.51Pv6协议IP是互(cid:7110)网的核心协议。现在使用的协议IP（即1Pv4)是在20世纪70年代末期设计的。互(cid:7110)网经过几十年的飞速发展，在2011年2月3日，IANA开始停止向地区互(cid:7111)网注册机构RIR分配1Pv4地址，因为1Pv4地址已经全部(cid:7106)尽了。不久，各地区互(cid:7110)网地址
分配机构也相继宣布地址(cid:7106)尽。我国在2014年(cid:7168)2015年也逐步停止了向新用户和应用分配1Pv4地址，同时全面开始商用部署1Pv6。
解决IP地址(cid:7107)尽的根本措施就是采用具有更大地址空间的新版本的IP,即1Pv6。经过多年的研究和试验，2017年7月终于发布了1Pv6的正式标准[RFC8200,STD86]。
•149•