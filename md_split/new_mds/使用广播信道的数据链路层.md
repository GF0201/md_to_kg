3.3使用广播信道的数据链路层一广播估道可以进行对多的通信。下面要讨论的局域网使用的就是广播信道。局域网是在20世纪70年代末发展起来的。局域网技术在计算机网络中占有非常重要的地位。
3.3.1局域网的数据链路层一局域网最主要的特点是：网络为个单位所拥有，且地理范围和站点数目均有限。在局域网刚刚出现时，局域网比广域网具有较高的数据率、视频讲解较低的时延和较小的误码率。但随着光纤技术在广域网中普遍使用，现在广域网也具有很高的数据率和很低的误砃率。
一局域网具有如下的一
些优点：(1)具有广播功能，从个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。
(2)便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。
(3)提高了系统的可靠性(reliab巾ty)、可用性(availability)和生存性(survivability)。
局域网可按网络拓扑进行分类。图3-13(a)是星形网。由于集线器(hub)的出现和双绞线大量用千局域网中，星形以太网以及多级星形结构的以太网获得了非常广泛的应用。图3-13(b)是环形网，图3-13(c)为总线网，各站直接连在总线上。总线两端的匹配电阻吸收在总线上传播的电磁波信号的能量，避免在总线上产生有害的电磁波反射。总线网以传统以太网最为著名，但以太网后来又演变成了星形网。经过四十多年的发展，以太网的速率已大大
10Gbit/s（数据中心）和
提高。现在最常用的以太网的速率是1Gbit/s（家庭或中小企业）、
100Gbit/s（长距离传输），且其速率仍在继续提高。现在以太网已成为了局域网的同义词，因此本章从本节开始都是讨论以太网技术。
匹配电阻(a)星形网(b)环形网(c)总线网图3-13局域网的拓扑局域网可使用多种传输媒体。双绞线最便宜，原来只用于低速(1~2Mbit/s)基带局域
网。现在从10Mbit/s至10Gbit/s的局域网都可使用双绞线。双绞线已成为局域网中的主流
传输媒体。当数据率更高时，往往需要使用光纤作为传输媒体。
必须指出，局域网工作的层次跨越了数据链路层和物理层。由于局域网技术中有关数一据链路层的内容比较丰富，因此我们就把局域网的内容放在数据链路层这章中讨论。但这并不表示局域网仅仅和数据链路层有关。
一共享信道要着重考虑的个问题就是如何使众多用户能够合理而方便地共享通信媒体资源。这在技术上有两种方法：(1)静态划分信道，如在第2卓的2.4节中已经介绍过的频分复用、时分复用、波分复•84•用和码分复用等。用户只要分配到了信道就不会和其他用户发生冲突。但这种划分信道的方法代价较高，不适合千局域网使用。
(2)动态媒体接入控制，它又称为多点接入(multipleaccess)，其特点是信道并非在用户通信时固定分配给用户。这里又分为以下两类：•随机接入随机接入的特点是所有的用户可随机地发送信息。但如果恰巧有两个一或更多的用户在同时刻发送信息，那么在共享媒体上就要产生碰撞（即发生了冲一
突），使得这些用户的发送都失败。因此，必须有解决碰撞的网络协议。
•受控接入受控接入的特点是用户不能随机地发送信息而必须服从定的控制。
这类的典型代表有分散控制的令牌环局域网和集中控制的多点线路探询(poiling),或称为轮询。
属千随机接入的以太网将被重点讨论。受控接入则由于目前在局域网中使用得较少，本书不再讨论。
”由千以太网的数据率已演进到每秒吉比特甚至高达400吉比特，因此通常就用“传统以太网来表示最早流行的10Mbit/s速率的以太网。为了讨论原理，下面我们就从传统以太网开始。
1.以太网的两个主要标准以太网是美国施乐(Xerox)公司的PaloAlto研究中心（简称为PARC)千1975年研制成一功的。那时，以太网是种基带总线局域网，当时的数据率为2.94Mbit/s。以太网用无源电缆作为总线来传送数据帧，并以曾经在历史上表示传播电磁波的以太(Ether)来命名。1976年7月，Metcalfe和Boggs发表他们的以太网里程碑论文[METC76]。1980年9月，DEC公
司、英特尔(Intel)公司和施乐公司联合提出了10Mbit/s以太网规约的第个版本DIXVl一(DIX是这三个公司名称的缩写）。1982年又修改为第二版规约（实际上也就是最后的版一本），即DIXEthernetV2,成为世界上第
在此基础上，IEEE802委员会0个局域网产品的规约。
一的802.3工作组千1983年制定了第个IEEE的以太网标准IEEE802.3[W-IEEE802.3]，数据率为10Mbit/s。802.3局域网对以太网标准中的帧格式一一做了很小的点更动，但允许基于这两种标准的硬件实现可以在同个局域网上互操作。以太网的两个标准DIXEthernetV2与IEEE的802.3标准只有很小的差别，因此很多人也常把“”802.3局域网简称为以太网（本书也经常不严格区分它们，虽然严格说来，“以太网
“一一当是指符合DIXEthernetV2标准的局域网）。
＂出千有关厂商在商业上的激烈竞争，IEEE802委员会当初未能形成个统的、最佳的局域网标准，而是被迫制定了几个不同的局域网标准，如802.4令牌总线网、802.5令
牌环网等。为了使数据链路层能更好地适应多种局域网标准，IEEE802委员会就把局域网
的数据链路层拆成两个子层，即逻辑链路控制LLC(LogicalLinkControl)子层和媒体接入控
制MAC(MediumAccessControl)子层。与接入到传输媒体有关的内容都放在MAC子层，而＄注：IEEE802委员会[W-IEEE802]是专门制定局域网和城域网标准的机构。截至2020年7月，其下属仍在活动的工作组只有5个，即：802.l一高层局域网协议工作组；802.3——以太网工作组；802.11——无线局域网工作组；802.15无线个人区域网工作组；802.19—－无线共存工作组。其余的都已经暂时或完全停止了活动。
—•85•”应LLC子层则与传输媒体无关，不管采用何种传输媒体和MAC子层的局域网对LLC子层来
说都是透明的（如图3-14所示）。
逻辑链路控制媒体接入控制数据链路层站点l站点2图3-14局域网对LLC子层是透明的然而到了20世纪90年代后，激烈竞争的局域网市场逐渐明朗。以太网在局域网市场
中已取得了垄断地位，并且几乎成为了局域网的代名词。这里不必叙述后来陆续出现的多种
以太网标准的详细过程。目前使用最多的局域网只剩下DIXEthernetV2（简称为以太网），
而不是IEEE802委员会制定的几种局域网。IEEE802委员会制定的逻辑链路控制子层LLC
（即IEEE802.2标准）的作用已经消失了，很多厂商生产的适配器上就仅装有MAC协议而
没有LLC协议。本章在介绍以太网时就不再考虑LLC子层。这样对以太网工作原理的讨论会更加简洁。
2.适配器的作用首先我们从一般的概念上讨论一下计算机是怎样连接到局域网上的。
计算机与外界局域网的连接是通过适配器(adapter)。适配器本来是在主机箱内插入的一
块网络接口板（或者是在笔记本电脑中插入一块PCMCIA卡个人计算机存储器卡接口
适配器）。这种接口板又称为网络接口卡NIC(NetworkInterfaceCard)或简称为
。由“网卡”于现在计算机主板上都已经嵌入了这种适配器，不再使用单独的网卡了，因此本书使用适配
器这个更准确的术语。在这种通信适配器上面装有处理器和存储器（包括RAM和ROM)。
适配器和局域网之间的通信是通过电缆或双绞线以串行传输方式进行的，而适配器和计算机
之间的通信则是通过计算机主板上的1/0总线以并行传输方式进行的。因此，适配器的一个
重要功能就是要进行数据串行传输和并行传输的转换。由千网络上的数据率和计算机总线上
的数据率并不相同，因此在适配器中必须装有对数据进行缓存的存储芯片。在主板上插入适
配器时，还必须把管理该适配器的设备驱动程序安装在计算机的操作系统中。这个驱动程序
以后就会告诉适配器，应当从存储器的什么位置上把多长的数据块发送到局域网，或者应当
在存储器的什么位置上把局域网传送过来的数据块存储下来。适配器还要能够实现以太网协
议。
请注意，虽然我们把适配器的内容放在数据链路层中讲授，但适配器所实现的功能却
包含了数据链路层及物理层这两个层次的功能。现在的芯片的集成度都很高，以致很难把一
个适配器的功能严格按照层次的关系精确划分开。
适配器在接收和发送各种帧时，不使用计算机的CPU。这时计算机中的CPU可以处理其他任务。当适配器收到有差错的帧时，就把这个帧直接丢弃而不必通知计算机。当适配器
收到正确的帧时，它就使用中断来通知该计算机，并交付协议栈中的网络层。当计算机要发
送IP数据报时，就由协议栈把1P数据报向下交给适配器，组装成帧后发送到局域网。图3-15
表示适配器的作用。我们特别要注意，计算机的硬件地址（在本章的3.3.5节讨论）就在适•86•配器的ROM中，而计算机的软件地址
存储器中。
卫主丿竺IP地址（在第4章4.2.3节讨论），则在计算机的生成发送的数据
处理收到的数据
图3-15计算机通过适配器和局域网进行通信把帧发送到局域网
从局域网接收帧3.3.2CSMA/CD协议一最早的以太网是将许多计算机都连接到“根总线上。当初认为这种连接方法既简单又可靠，因为在那个时代普遍认为：
一＂有源器件不可靠，而无视频讲解源的电缆线才是最可靠的
总线的特点是：当。
台计算机发送数据时，总线上的所有计算机都能检测到这个数据。
一这种就是广播通信方式。但我们并不总是要在局域网上进行一一一上实现对的通信，可以使每台计算机的适配器都拥有一对多的广播通信。为了在总线
个与其他适配器都不同的地址。
在发送数据帧时，在帧的首部写明接收站的地址。现在的电子技术可以很容易做到：仅当数一据帧中的目的地址与适配器ROM中存放的硬件地址
适配器对不是发送给自己的数据帧就丢弃。这样，具有广播特性的总线上就实现了
“”“”““””致时，该适配器才能接收这个数据帧。
对的一一通信。
人们也常把局域网上的计算机称为主机工作站站点或站。在本书中，这几个名词都可以当成是同义词。
一为了通信的简便，以太网采取了以下两种措施：第，采用较为灵活的无连接的工作方式，即不必先建立连接就可以直接发送数据。
适配器对发送的数据帧不进行编号，也不要求对方发回确认。这样做可以使以太网工作起来非常简单，而局域网信道的质量很好，因通信质量不好产生差错的概率是很小的。因此，以太网提供的服务是尽最大努力的交付，即不可靠的交付。当目的站收到有差错的数据帧时
（例如，用CRC查出有差错），就把帧丢弃，其他什么也不做。对有差错帧是否需要重传则
些数据。于是由高层来决定。例如，如果高层使用TCP协议，那么TCP就会发现丢失了一一经过定的时间后，TCP就把这些数据重新传递给以太网进行重传。但以太网并不知道这是重传帧，而是当作新的数据帧来发送。
一一
我们知道，总线上只要有一时间只能允许在同
据被破坏。因此，如何协调总线上各计算机的工作就是以太网要解决的台计算机在发送数据，总线的传输资源就被占用。因此，
台计算机发送数据，否则各计算机之间就会互相干扰，使得所发送数一一
个重要问题。以太网采用最简单的随机接入，但有很好的协议用来减少冲突发生的概率。这好比有屋子的人在开讨论会，没有会议主持人控制发言。想发言的随时可发言，不需要举手示意。但我们还必须有个协议来协调大家的发言。这就是：如果你听见有人在发言，那么你就必须等别人讲一
完了才能发言（否则就干扰了别人的发言）。但有时碰巧两个或更多的人同时发言了，那么旦发现冲突，大家都必须立即停止发言，等听到没有人发言了你再发言。以太网采用的协•87•调方法和上面的办法非常像，它使用的协议是CSMA/CD,意思是载波监听多点接入／碰撞
检测(CarrierSenseMultipleAccesswithCollisionDetection)。
第二，以太网发送的数据都使用曼彻斯特(Manchester)编码的信号。我们在第2章的2.2.2节中已经简单地介绍过曼彻斯特编码了。我们知道，二进制基带数字信号通常就是高、一低电压交替出现的信号。使用这种信号的最大问题就是当出现长串连续的1或连续的0时，接收端就无法从收到的比特流中提取位同步（即比特同步）信号。如图3-16所示，曼彻斯一一一特编码的编码方法是把每“”个码元再分成两个相等的间隔。码元1是前
“”一后个间隔为高电压。码元0则正好相反，从高电压变到低电压（也可采用相反的约定，即个间隔为低电压而一l是前高后低而0是前低后高)。这样就保证了在每个比特的正中间出现的转换，而接收端就利用这种电压的转换很方便地把位同步信号提取出来。但是从曼彻斯特编码的波形图也不难看出其缺点，这就是它所占的频带宽度比原始的基带信号增加了倍次电压
一（因为每秒传送的码元数加倍了）。
，，比特流曼彻斯特差分曼彻斯特：}，:：1
:0:0:0:
:
}:二::::}，。1,
＇
＇
，
'1图3-16曼彻斯特编码下面介绍CSMA/CD协议的要点。
“＂””线上。协议的实质是＂
载波监听和”碰撞检测"。
多点接入就是说明这是总线型网络，许多计算机以多点接入的方式连接在“”＂一根总载波监听“
也就是”边发送边监听。这里必须指出，在通信领域，在大多数情况下，＂”Carrier的标准译名是
”Carrier有多种意思，如““
载波
“”“”“。但对千以太网，总线上根本没有什么载波。其实英语””
承运器传导管或“
运载工具”等。因此在以太网中，把Carrier译为载体或媒体可能更加准确些。考虑到载波这个译名已经在我国广泛流行了好几十年，本书也就继续使用这个不准确的译名。我们知道，载波监听就是不管在想要发送数据之前，还是在发送数据之中，每个站都必须不停地检测信道。在发送前检测信道，是为了避免冲突。如果检测出已经有其他站在发送，则本站就暂时不要发送数据。在发送中检测信道，是为了及时发现如果有其他站也在发送，就立即中断本站的发送。这就称为
碰撞检测。“”碰撞检测是适配器边发送数据边检测信道上的信号电压的变化情况。当两个或几个站同时在总线上发送数据时，总线上的信号电压变化幅度将会增大（互相叠加）。当适配一器检测到的信号电压变化幅度超过“”“
定的门限值时，就认为总线上至少有两个站同时在发送“”＂数据，表明产生了碰撞。所谓碰撞就是发生了冲突。因此碰撞检测也称为冲突检一一测。这时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。因此，任何个正在发送数据的站，“
得继续进行无效的发送，白臼浪费网络资源，然后等待一段随机时间后再次发送。
旦发现总线上出现了碰撞，其适配器就要立即停止发送，免
＂一既然每个站在发送数据之前已经监听到信道为空闲，那么为什么还会出现数据在总线上的碰撞呢？这是因为电磁波在总线上总是以有限的速率传播的。这和我们开讨论会时•88•相似。一听见会场安静，我们就立即发言，但偶尔也会发生几个人同时抢着发言而产生冲突
的情况。图3-17所示的例子可以说明这种情况。设图中的局域网两端的站A和B相距1km,
用同轴电缆相连。电磁波在1km电缆的传播时延约为5µs（这个数字应当记住）。因此，A
向B发出的数据，在约5µs后才能传送到B。换言之，B若在A发送的数据到达B之前发
送自己的帧（因为这时B的载波监听检测不到A所发送的信息），则必然要在某个时间和A
发送的帧发生碰撞。碰撞的结果是两个帧都变得无用。在局域网的分析中，常把总线上的单
程端到端传播时延记为r。发送数据的站希望尽早知道是否发生了碰撞。那么，A发送数据
后，最迟要经过多长时间才能知道自已发送的数据和其他站发送的数据有没有发生碰撞？从
图3-17不难看出，这个时间最多是两倍的总线端到端的传播时延(2i)，或总线的端到端往返
传播时延。由千局域网上任意两个站之间的传播时延有长有短，因此局域网必须按最坏情况
设计，即取总线两端的两个站之间的传播时延（这两个站之间的距离最大）为端到端传播时
延。
t=O--1kmt＂
t=2,—8-`；五尸］户
丿丿
丿t=2,-8｀f；国三三丿
户工
气
三
尸t=t-8
B检测到信道空闲
发送数据
t=,-8/2发生碰撞
t='[B检测到发生碰撞
停止发送图3-17传播时延对载波监听的影响显然，在使用CSMA/CD协议时，一个站不可能同时进行发送和接收（但必须边发送
边监听信道）。因此使用CSMA/CD协议的以太网不可能进行全双工通信而只能进行双向交
替通信（半双工通信）。
下面是图3-17中的一些重要的时刻。
在t=0时，A发送数据。B检测到信道为空闲。
在t=r-8时（这里r>8>0),A发送的数据还没有到达B时，由千B检测到信道是空闲的，因此B发送数据。
经过时间8/2后，即在t=r-8/2时，A发送的数据和B发送的数据发生了碰撞，但这时A和B都不知道发生了碰撞。
在t=r时，B检测到发生了碰撞，于是停止发送数据。
在t=2r-8时，A也检测到发生了碰撞，因而也停止发送数据。
A和B发送数据均失败，它们都要推迟一段时间再重新发送。
•89•一一由此可见，每一个站在自已发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。
这小段时间是不确定的，它取决千另一一个发送数据的站到本站的距离。因此，以太网不能保证在检测到信道空闲后的某一
时间内，定能够把自己的数据帧成功地发送出去（因为存在产生碰撞的可能）。以太网的这特点称为发送的不确定性。如果希望在以太网上发生碰撞的机会很小，必须使整个以太网的平均通信量远小千以太网的最高数据率。
从图3-17可看出，最先发送数据帧的A站，在发送数据帧后至多经过时间正就可知道所发送的数据帧是否遭受了碰撞。这就是6--0的情况。因此以太网的端到端往返时间江称
个很重要的参数。争用期又称为碰撞窗口(collision
为争用期(contentionperiod)，它是
window)。这是因为个站在发送完数据后，只有通过争用期的，即经过争用期这考验一一“”一段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。这时，就可以放心把这帧数据顺利发送完毕。
以太网使用截断二进制指数退避(truncatedbinaryexponentialbackoff)算法来确定碰撞后重传的时机。截断二进制指数退避算法并不复杂。这种算法让发生碰撞的站在停止发送数据一后，不是等待信道变为空闲后就立即再发送数据，而是退避个随机的时间。这点很容易理解，因为几个发生碰撞的站将会同时检测到信道变成了空闲。如果大家都同时重传，必然接连发生碰撞。如果采用退避算法，生成了最小退避时间的站将最先获发送权。以后其余的站的退避时间到了，但发送数据之前监听到信道忙，就不会马上发送数据了。
为了尽可能减小重传时再次发生冲突的概率，退避算法有如下具体的规定：(I)基本退避时间为争用期2r,具体的争用期时间是51.2µs。对千10Mbit/s以太网，
在争用期内可发送512比特，即64字节。也可以说争用期是512比特时间。1比特时间就是发送1比特所需的时间。所以这种时间单位与数据率密切相关。为了方便，也可以直接使
用比特作为争用期的单位。争用期是512比特，即争用期是发送512比特所需的时间。
一k(2)从离散的整数集合[O,I,…，（2-1)］中随机取出个数，记为r。重传应推后的时间就是r倍的争用期。上面的参数K按下面的公式(3-1)计算：k=Min［重传次数，1O](3-1)可见当重传次数不超过10时，参数K等于重传次数；但当重传次数超过10时，K就不一再增大而直等于10。
(3)当重传达16次仍不能成功时（这表明同时打算发送数据的站太多，以致连续发生冲突），则丢弃该帧，并向高层报告。
一例如，在第1次重传时，k=1,随机数r从整数{O,1}中选一个数。因此重传的站可选择的重传推迟时间是0或2r,在这两个时间中随机选择个。
若再发生碰撞，则在第2次重传时，k=2,随机数r就从整数{O,1,2,3}中选一因此重传推迟的时间是在0,2r.，士和6r这4个时间中随机地选取个。
一个数。
一同样，若再发生碰撞，则重传时k=3,随机数r就从整数{O,1,2,3,4,5,6,7}中选个数。依此类推。
若连续多次发生冲突，就表明可能有较多的站参与争用信道。但使用上述退避算法可使重传需要推迟的平均时间随重传次数而增大（这也称为动态退避），因而减小发生碰撞的概率，有利千整个系统的稳定。
一一我们还应注意到，适配器每发送个新的帧，就要执行次CSMA/CD算法。适配器•90•对过去发生过的碰撞并无记忆功能。因此，当好几个适配器正在执行指数退避算法时，很可一能有某个适配器发送的新帧能够碰巧立即成功地插入到信道中，得到了发送权，而已经推迟好几次发送的站，有可能很不巧，还要继续执行退避算法，继续等待。
一一现在考虑种情况。某个站发送了个很短的帧，但在发送完毕之前并没有检测出碰撞。假定这个帧在继续向前传播到达目的站之前和别的站发送的帧发生了碰撞，因而目的站将收到有差错的帧（当然会把它丢弃）。可是发送站却不知道这个帧发生了碰撞，因而不会一重传这个帧。这种情况显然是我们所不希望的。为了避免发生这种情况，以太网规定了一个最短帧长64字节，即512比特。如果要发送的数据非常少，那么必须加入
使帧长不小千64字节。对于10Mbit/s以太网，发送512比特的时间需要51.2µs,也就是些填充字节，上面提到的争用期。
由此可见，以太网在发送数据时，如果在争用期（共发送了64字节）没有发生碰撞，一一一
那么后续发送的数据就定不会发生冲突。换句话说，如果发生碰撞，就一
定是在发送的前64字节之内。由千检测到冲突就立即中止发送，这时已经发送出去的数据定小千64字节，因此凡长度小千64字节的帧都是由于冲突而异常中止的无效帧。只要收到了这种无效帧，就应当立即将其丢弃。
前面已经讲过，信号在以太网上传播1km大约需要5µs。以太网上最大的端到端时延一半（即25.6µs)，这相当千以太网的最大端到端长度约为5km。实际上
必须小千争用期的
的以太网覆盖范围远远没有这样大。因此，实用的以太网都能在争用期51.2µs内检测到可能发生的碰撞。以太网的争用期确定为51.2µs,不仅考虑到以太网的端到端时延，而且还包括其他的许多因素，如存在的转发器所增加的时延，以及下面要讲到的强化碰撞的干扰信号的持续时间等。
一下面介绍强化碰撞的概念。这就是当发送数据的站旦发现发生了碰撞时，除立即停止发送数据外，还要再继续发送32比特或48比特的人为干扰信号(jammingsignal)，以便让
所有用户都知道现在已经发生了碰撞（如图3-18所示）。对千10Mbit/s以太网，发送32
（或48)比特只需要3.2（或4.8)µs。
-----------------------------------l图3-18人为干扰信号的加入从图3-18可以看出，A站从发送数据开始到发现碰撞并停止发送的时间间隔是T。A站得知碰撞已经发生时所发送的强化碰撞的干扰信号的持续时间是TJ。图中的B站在得知B发生碰撞后，也要发送人为干扰信号，但为简单起见，图3-18没有画出B站所发送的人为B1一干扰信号。发生碰撞使A浪费时间T+T。可是整个信道被占用的时间还要增加个单程端到端的传播时延r。因此总线被占用的时间是TB+T.尸r。
•91•以太网还规定了帧间最小间隔为9.6µs,相当于96比特时间。这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。
根据以上所讨论的，可以把CSMA/CD协议的要点归纳如下：
(1)准备发送：适配器从网络层获得一个分组，加上以太网的首部和尾部（见后面的3.4.3节），组成以太网帧，放入适配器的缓存中。但在发送之前，必须先检测信道。
(2)检测信道：若检测到信道忙，则继续不停地检测，一直等待信道转为空闲。此时若在96比特时间内信道保持空闲（保证了帧间最小间隔），就发送这个帧。
(3)在发送过程中仍不停地检测信道，即网络适配器要边发送边监听。这里只有两种可能性：CD发送成功：如果在争用期内一直未检测到碰撞，就认为发送成功（如果接收方收到
了有差错的帧，就丢弃它，后续的工作由高层来处理）。发送完毕后，其他什么也不做。然
后回到(1)。
＠发送失败：在争用期内检测到碰撞。这时立即停止发送数据，并按规定发送人为干扰信号。适配器接着就执行指数退避算法，等待r倍512比特时间后，返回到步骤(2)，继
续检测信道。但若重传达16次仍不能成功，则停止重传而向上报错。
以太网每发送完一帧，一定要把已发送的帧暂时保留一下。如果在争用期内检测出发生了碰撞，那么还要在推迟一段时间后再把这个暂时保留的帧重传一次。
3.3.3使用集线器的星形拓扑传统以太网最初使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展
为使用更便宜和更灵活的双绞线。这种以太网采用星形拓扑，在星形的中心则增加了一种可
靠性非常高的设备，叫作集线器(hub)，如图3-19所示。双绞线以太网总是和集线器配合使
用的。每个站需要用两对无屏蔽双绞线（放在一根电缆内），分别用于发送和接收。双绞线
的两端使用RJ-45插头。由千集线器使用了大规模集成电路芯片，因此集线器的可靠性就大
大提高了。1990年IEEE制定出星形以太网lOBASE-T的标准802.3i。”1O"代表10Mbit/s的数据率，BASE表示连接线上的信号是基带信号，T代表双绞线。实践证明，这比使用具
有大量机械接头的无源电缆要可靠得多。由于使用双绞线电缆的以太网价格便宜和使用方便，
因此粗缆和细缆以太网现在都已成为历史，并已从市场上消失了。
站点集线器／RJ-45插头两对双绞线图3-19使用集线器的双绞线以太网但lOBASE-T以太网的通信距离稍短，每个站到集线器的距离不超过100m。这种性价
比很高的lOBASE-T双绞线以太网的出现，是局域网发展史上的一个非常重要的里程碑，从
此以太网的拓扑就从总线型变为更加方便的星形网络，而以太网也就在局域网中占据了统治
地位。
•92•使双绞线能够传送高速数据的主要措施是把双绞线的绞合度做得非常精确。这样不仅
可使特性阻抗均匀以减少失真，而且大大减少了电磁波辐射和无线电频率的千扰。在多对双
绞线的电缆中，还要使用更加复杂的绞合方法。
集线器的一些特点如下：
(1)从表面上看，使用集线器的局域网在物理上是一个星形网，但由千集线器使用电子
器件来模拟实际电缆线的工作，因此整个系统仍像一个传统以太网那样运行。也就是说，使
用集线器的以太网在逻辑上仍是一个总线网，各站共享逻辑上的总线，使用的还是
CSMA/CD协议（更具体些说，是各站中的适配器执行CSMA/CD协议）。网络中的各站必
须竞争对传输媒体的控制，并且在同一时刻至多只允许一个站发送数据。
(2)一个集线器有许多端口G)'例如，8至16个，每个端口通过RJ-45插头（与电话机
使用的插头RJ-11相似，但略大一些）用两对双绞线与一台计算机上的适配器相连（这种插
座可连接4对双绞线，实际上只用2对，即发送和接收各使用一对双绞线）。因此，一个集
线器很像一个多端口的转发器。
(3)集线器工作在物理层，它的每个端口仅仅简单地转发比特收到1就转发1,收
到0就转发O,不进行碰撞检测。若两个端口同时有信号输入（即发生碰撞），那么所有的
端口都将收不到正确的帧。图3-20是具有三个端口的集线器的示意图。
图3-20具有三个端口的集线器(4)集线器采用了专门的芯片，进行自适应串音回波抵消。这样就可使端口转发出去的较强信号不致对该端口接收到的较弱信号产生干扰（这种干扰即近端串音）。每个比特在转
发之前还要进行再生整形并重新定时。
集线器本身必须非常可靠。现在的堆叠式(stackable)集线器由4~8个集线器堆叠起来使
用。集线器一般都有少量的容错能力和网络管理功能。例如，假定在以太网中有一个适配器
出了故障，不停地发送以太网帧。这时，集线器可以检测到这个问题，在内部断开与出故障
的适配器的连线，使整个以太网仍然能够正常工作。模块化的机箱式智能集线器有很高的可
靠性。它全部的网络功能都以模块方式实现。各模块均可进行热插拔，出故障时不断电即可
更换或增加新模块。集线器上的指示灯还可显示网络上的故障情况，给网络的管理带来了很
大的方便。
IEEE802.3标准还可使用光纤作为传输媒体，相应的标准是lOBASE-F系列，F代表光CD注：集线器的端口(port)就是集线器和外接计算机的个硬件接口一(interface)。在运输层要经常使用软件端口(port)，它和集线器的硬件端口是两个不同的概念。本书以前曾把集线器的硬件端口称为接口，是为了避免和运输层的端口弄混。考虑到大多数文献使用的是port,因此现在改用译名端口“”。
•93•纤。它主要用作集线器之间的远程连接。
3.3.4以太网的信道利用率一一
下面我们讨论下以太网的信道利用率。
假定个10Mbit/s以太网同时有10个站在工作，那么每扫一扫f.熙贾目
月匕惑$
．心．石抵池牲视频讲解一j
个呫所生发送数据的平均速率似乎应当是总数据率的1/10（即1Mbit/s)。其实不然，因为多个站在以太网上同时工作就可能会发生碰撞。当发生碰撞时，信道资源实际上是被浪
一费了。因此，当扣除碰撞所造成的信道损失后，以太网总的信道利用率并不能达到100%。
个站在发送帧时出现了碰撞。经过图3-21的例子是以太网的信道被占用的情况。
一个争用期2T后(T是以太网单程端到端传播时延），可能又出现了碰撞。这样经过若干个争用期后，一个站就发送成功了。假定发送帧需要的时间是To。它等千帧长(bit)除以发送速率(10Mbit/s)。
发生碰撞—、I占用信道时间！争用期｝争用期｝
，...:争用期
2TTo一发送帧所需的平均时间图3-21以太网的信道被占用的情况一一我们应当注意到，成功发送个帧需要占用信道的时间是T。+t，比这个帧的发送时间一一要多个单程端到端时延T。这是因为当一
个站发送完最后个比特时，这个比特还要在以一太网上传播。在最极端的情况下，发送站在传输媒体的端，而比特在媒体上传输到另端所需的时间是t。因此，必须在经过时间T。+T后以太网的媒体才完全进入空闲状态，才能允许其他站发送数据。
从图3-21可看出，要提高以太网的信道利用率，就必须减小T与几之比。在以太网中定义了参数a,它是以太网单程端到端时延T与帧的发送时间T。之比：T-＿＿a。
T(3-2)--一当a
一0时，表示只要发生碰撞，就立即可以检测出来，并立即停止发送，因而信道
资源被浪费的时间非常非常少。反之，参数a越大，表明争用期所占的比例越大，这就使得
每发生
次碰撞就浪费了不少的信道资源，使得信道利用率明显降低。因此，以太网的参数
a的值应当尽可能小些。从（3-2)式可看出，这就要求(3-2)式分子T的数值要小些，而分母T。
的数值要大些。这就是说，当数据率定时，以太网的连线的长度受到限制（否则T的数值一会太大），同时以太网的帧长不能太短（否则To的值会太小，使a值太大）。
一一现在考虑种理想化的情况。假定以太网上的各站发送数据都不会产生碰撞（这显然
种特殊的调度方法），并且能够非常有效地利用网络
个站立即发送数据。这样，发送帧占用线路的时间
Smax旦空闲就有某一一一已经不是CSMA/CD,而是需要使用的传输资源，即总线是T。+T，而帧本身的发送时间是To。于是我们可计算出极限信道利用率为：•94•smaxT
飞＋rl+a(3-3)(3-3)式的意义是：虽然实际的以太网不可能有这样高的极限信道利用率，但(3-3)式指
出了只有当参数a远小千l才能得到尽可能高的极限信道利用率。反之，若参数a远大于l
（即每发生一次碰撞，就要浪费相对较多的传输数据的时间），则极限信道利用率就远小千
l，而这时实际的信道利用率就更小了。据统计，当以太网的利用率达到30％时就已经处千
重载的情况。很多的网络容量被网上的碰撞消耗掉了。
3.3.5以太网的MAC层1.MAC层的硬件地址在局域网中，硬件地址又称为物理地址或MAC地址（因为这种地址用在MAC帧中）。
视频讲解大家知道，在所有计算机系统的设计中，标识系统(identificationsystem)(i)都是一个核心
问题。在标识系统中，地址就是识别某个系统的一个非常重要的标识符。在讨论地址问题
时，很多人常常引用著名文献[SHOC78]给出的如下定义：“名字指出我们所要寻找的那个资源，地址指出那个资源在何处，路由告诉我们如何到达该处。”这个非形式的定义固然很简单，但有时却不够准确。严格地讲，名字应当与系统的所
在地无关。这就像我们每一个人的名字一样，不随我们所处的地点而改变。为此IEEE802
标准为局域网规定了一种48位的全球地址（一般都简称为“地址”)，这就是局域网上的每
一台计算机中固化在适配器的ROM中的地址。因此，请特别注意下面两点：(1)假定连接在局域网上的一台计算机的适配器坏了而我们更换了一个新的适配器，那
也就改变了，虽然这台计算机的地理位置一点也没有变化，么这台计算机的局域网的“地址”
所接入的局域网也没有任何改变。
(2)假定我们把位于南京的某局域网上的一台笔记本电脑携带到北京，并连接在北京的
某局域网上。虽然这台电脑的地理位置改变了，但只要电脑中的适配器不变，那么该电脑在
北京的局域网中的“地址”仍然和它在南京的局域网中的“地址”一样。
“由此可见，局域网上的某台主机的“地址”并不指明这台主机位千什么地方。因此，
或标识符[PERLOO]。不过，计算
严格地讲，局域网的
机的名字通常都是比较适合人记忆的不太长的字符串，而这种48位二进制的“地址”却很
不像一般计算机的名字。但现在人们还是习惯于把这种48位的“名字”称为“地址”。本书
也采用这种习惯用法，尽管这种说法并不严格。
应当是每一个站的名字地址”““请注意，如果连接在局域网上的主机或路由器安装有多个适配器，那么这样的主机或路由器就有多个“地址＂。实际上，这种48位“地址”应当是某个接口的标识符。
也注：名词咖ntification原来的标准译名是“标识”[MINGCI94]。2004年出版的《现代汉语规范词典》给出读音是“biaozhi（读音是“志”)，并且说明：现在规范词形写作“标志”。现在教育部国家语言文字工作委员会发布““”标识的第一批异形词整理表”规定今后不再使用“标识”而应当用“标志”。但[MINGCI94]又将flag译为“标志”。这样，若identification和flag均译为“标志”就会引起混乱。因此，本书采取这样的做法：作为动词用时，我们使用“标志”，但作为名词使用时，我们用“标识”(identification)和“标志”(flag)。请读者注意。
•95•在制定局域网的地址标准时，首先遇到的问题就是应当用多少位来表示个网络的地一址字段。为了减少不必要的开销，地址字段的长度应当尽可能地短些。起初人们觉得用两个
字节（共16位）表示地址就够了，因为这共可表示6万多个地址。但是，由于局域网的一迅速发展，而处在不同地点的局域网之间又经常需要交换信息，这就希望在各地的局域网中的站具有互不相同的物理地址。为了使用户在买到适配器并把机器连到局域网后马上就能工一作，而不需要等待网络管理员给他先分配个地址，IEEE802标准规定MAC地址字段可采一用6字节(48位）或2字节(16位）这两种中的种。6字节地址字段对局部范围内使用的局域网的确是太长了，但是由千6字节的地址字段可使全世界所有的局域网适配器都具有不相同的地址，因此现在的局域网适配器实际上使用的都是6字节MAC地址。
现在IEEE的注册管理机构RA(RegistrationAuthority)是局域网全球地址的法定管理机构[W-IEEERA]，它负责分配地址字段的6个字节中的前三个字节（即高位24位）。世界上凡要生产局域网适配器的厂家都必须向IEEE购买由这三个字节构成的这个号（即地址块），
这个号的正式名称是组织唯一标识符OUI(OrganizationallyUniqueIdentifier)，通常也叫作公
司标识符(company_id)
因为个公司可能购买了几个OUI，也可能有几个小公司合起来购买[RFC7042]。但应注意，24位的OUI不能够单独用来标志个OUI。例如，华个公司，一一一一为公司购买了多个OUI，其中的位）则是由厂家自行指派，称为扩展标识符(extendedidentifier)，只要保证生产出的适配器个是A8-E5-44气地址字段中的后三个字节（即低位24
24一没有重复地址即可。可见购买了个OUI，就可以生成出2个不同的6字节(48位）MAC地址，这种地址又称为EUI-48,这里EUI表示扩展的唯一标识符(ExtendedUniqueIdentifier)。EUI-48的使用范围并不局限千局域网的硬件地址，而是可以用千软件接口。在生产适配器时，这种6字节的MAC地址已被固化在适配器的ROM中。因此，MAC地址““也叫作硬件地址(hardwareaddress)或物理地址气可见
或适配器标识符EUI-48。当这种适配器嵌入到某台计算机（或手机）后，适配器上的标识实际上就是适配器地址MAC地址符EUI-48就成为这台计算机（或手机）的MAC地址了。
一IEEE规定地址字段的第I/G位为0时，地址字段表示一
字节的最低有效位为I/G位。I/G表示Individual/Group。当
个单个站地址。当I/G位为1时表示组地址，用来进行多播一一““””一
（以前曾译为组播）。需要指出，有的书把上述最低有效位写为第位一
，但第的定义是含糊不清的。这是因为在地址记法中有两种标准：第一种记法是把每字节的最低位（即最低有效位）写在最左边（第位）。IEEE802.3标准就采用这种记法。例如，十进制数11的二进制表示是1011,最高位写在最左边。但若使用IEEE802.3标准的记法，就应当记为1101,把最低位写在最左边。当我们阅读802.3标准的有关文档时，需要特别注意。第一一二种记法是把每字节的最高位（即最高有效位）写在最左边（这也叫第位）。在发送数汴：这里的是十六进制数字在局域网地址中的一种标准记法。每个二进制数字用一个十六进制数字表示，而每两个十六进制数字与它后面的两个十六进制数字之间用连字符隔开。另一种记法是在A8-E5-44CD如4后面写上一连串的十六进制数字，OxOxA8E544。
＠注：地址有平面地址(flataddress)和层次地址(hierarchicaladdress)两大类。平面地址也叫作非层次地址，就是在分配地址
时按顺序号一个个地挨着分配。层次地址是将整个地址再划分为几个部分，而每部分按一定的规律分配号码。像我们的电话号码就是一种层次号码，电信网中的交换机按照国家号一区号一局号一用户号的顺序可以准确地找到用户的电话。但局域网的字节的地址是一种平面地址。适配器根据全部的位地址决定接收或丢弃所收到的MAC帧。
648•96•据时，两种记法都是按照字节的顺序发送，但每一个字节中先发送哪一位则不同：第一种记
法先发送最低位，但第二种记法则先发送最高位。
IEEE还考虑到可能有人并不愿意向IEEE的RA购买OUI。为此，IEEE把地址字段第
一字节的最低第二位规定为G/L位，表示Global/Local。当G/L位为0时是全球管理（保证
在全球没有相同的地址），厂商向IEEE购买的OUI都属于全球管理。当地址字段的G/L位
为1时是本地管理，这时用户可任意分配网络上的地址。采用2字节地址字段时全都是本地管理。但应当指出，以太网几乎不理会这个G/L位。
这样，在全球管理时，对每一个站的地址可用46位的二进制数字来表示（最低位和最
低第二位均为0时）。剩下的46位组成的地址空间可以有246个地址，已经超过70万亿个，
可保证世界上的每一个适配器都可有一个唯一的地址。当然，非无限大的地址空间总有用完
的时候。但据测算，至少在近期还不需要考虑MAC地址耗尽的问题。
当路由器通过适配器连接到局域网时，适配器上的硬件地址就用来标志路由器的某个接口。路由器如果同时连接到两个网络上，那么它就需要两个适配器和两个硬件地址。
我们知道适配器有过滤功能。当适配器从网络上每收到一个MAC帧就先用硬件检查
MAC帧中的目的地址。如果是发往本站的帧则收下，然后再进行其他的处理。否则就将此
帧丢弃，不再进行其他的处理。这样做就不浪费主机的处理机和内存资源了。这里”发往本
站的帧“包括以下三种帧：(1)单播(unicast)帧（一对一），即收到的帧的MAC地址与本站的MAC地址相同
(2)广播(broadcast)帧（一对全体），即发送给本局域网上所有站点的帧（全l地址）。
(3)多播(multicast)帧（一对多），即发送给本局域网上一部分站点的帧。
所有的适配器都至少应当能够识别前两种帧，即能够识别单播和广播地址。有的适配
器可用编程方法识别多播地址。当操作系统启动时，它就把适配器初始化，使适配器能够识别某些多播地址。显然，只有目的地址才能使用广播地址和多播地址。
以太网适配器还可设置为一种特殊的工作方式，即混杂方式(promiscuousmode)。工作
在混杂方式的适配器只要“听到“
有帧在以太网上传输就都悄悄地接收下来，而不管这些帧
发往哪个站。请注意，这样做实际上是＂窃听“其他站点的通信而并不中断其他站点的通信。
网络上的黑客(hacker或cracker)常利用这种方法非法获取网上用户的口令。因此，以太网上
的用户不愿意网络上有工作在混杂方式的适配器。
但混杂方式有时却非常有用。例如，网络维护和管理人员需要用这种方式来监视和分
析以太网上的流量，以便找出提高网络性能的具体措施。有一种很有用的网络工具叫作嗅探
器(Sniffer)就使用了设置为混杂方式的网络适配器。此外，这种嗅探器还可帮助学习网络的
人员更好地理解各种网络协议的工作原理。因此，混杂方式就像一把双刃剑，是利是弊要看
你怎样使用它。
2.MAC帧的格式常用的以太网MAC帧格式有两种标准，一种是DIXEthernetV2标准（即以太网V2标
准），另一种是IEEE的802.3标准。这里只介绍使用得最多的以太网V2的MAC帧格式
（如图3-22所示）。图中假定网络层使用的是IP协议。实际上使用其他的协议也是可以的。
•97•广廿子兀662II'目的地址源地址
--------�-----------------------------------------------1
�类型IIIP数据报IP层46-1500FC勹MAC层
1----------------------------------------------;_____________�---------------------------------------------iI以太网MAC帧物理层发
送7字节----------le字贯
lOlOlOlOlOliIOlOlOlllOlOlOlOlOlOlO.．．前同步码帧开始
定界符图3-22以太网V2的MAC帧格式以太网V2的MAC帧较为简单，由五个字段组成。前两个字段分别为6字节长的目的地址和源地址字段。第三个字段是2字节的类型字段，用来标志上一层使用的是什么协议，
以便把收到的MAC帧的数据上交给上一层的这个协议。例如，当类型字段的值是Ox0800
时，就表示上层使用的是IP数据报。第四个字段是数据字段，其长度在46到1500字节之
间(46字节是这样得出的：最小长度64字节减去18字节的首部和尾部就得出数据字段的
最小长度）。最后一个字段是4字节的帧检验序列FCS（使用CRC检验）。当传输媒体的误
码率为1X10-8时，MAC子层可使未检测到的差错小千1X10-14。FCS检验的范围就是整个
的MAC帧，从目的地址开始到FCS为止的这五个字段，但不包括物理层插入的8字节的
前同步码和帧开始定界符。
这里我们要指出，在以太网V2的MAC帧格式中，其首部并没有一个帧长度（或数据
长度）字段。那么，MAC子层又怎样知道从接收到的以太网帧中取出多少字节的数据交付
上一层协议呢？我们在前面讲述图3-16的曼彻斯特编码时已经讲过，这种曼彻斯特编码的
一个重要特点就是：在曼彻斯特编码的每一个码元（不管码元是1或0)的正中间一定有一
次电压的转换（从高到低或从低到高）。当发送方把一个以太网帧发送完毕后，就不再发送
其他码元了（既不发送1,也不发送0)。因此，发送方网络适配器的接口上的电压也就不再
变化了。这样，接收方就可以很容易地找到以太网帧的结束位置。在这个位置往前数4字节
CFCS字段长度是4字节），就能确定数据字段的结束位置。
当数据字段的长度小于46字节时，MAC子层就会在数据字段的后面加入一个整数字
节的填充字段，以保证以太网的MAC帧长不小于64字节。我们应当注意到，MAC帧的首
部并没有指出在数据字段中是否有填充字段。接收端的MAC子层在剥去MAC帧的首部和
尾部后，就把剩下的部分交给上面的IP层。那么IP层怎样知道这里有没有填充字段呢？大
家知道，IP协议的首部有一个“总长度”字段。如果IP数据报的“总长度“超过或等千46
字节，那么肯定就没有填充字段。反之，如果“总长度“小千46字节，那么就很容易把填
充字段计算出。例如，若IP数据报的总长度为42字节，填充字段就应当是4字节。当
MAC帧把46字节的数据上交给IP层后，IP层就把其中最后4字节的填充字段丢弃。
从图3-22可看出，在传输媒体上实际传送的要比MAC帧还多8个字节。这是囚为当
一个站在刚开始接收MAC帧时，由于适配器的时钟尚未与到达的比特流达成同步，因此
MAC帧的最前面的若干位就无法接收，结果使整个的MAC成为无用的帧。为了接收端迅
速实现位同步，从MAC子层向下传到物理层时还要在帧的前面插入8个字节（由硬件生•98•成），它由两个字段构成。第个字段是7个字节的前同步码(1和0交替码），它的作用是一使接收端的适配器在接收MAC帧时能够迅速调整其时钟频率，使它和发送端的时钟同步，“”也就是实现位同步（位同步就是比特同步的意思）。第二个字段是帧开始定界符，定义为一10101011。它的前六位的作用和前同步码
“MAC帧的信息马上就要来了，请适配器注意接收。”MAC帧的FCS字段的检验范围不包样，最后的两个连续的1就是告诉接收端适配器：括前同步码和帧开始定界符。顺便指出，在使用SONET/SDH进行同步传输时则不需要用前一同步码，因为在同步传输时收发双方的位同步总是直保持着的。
还需注意，在以太网上传送数据时是以帧为单位传送的。以太网在传送帧时，各帧之一间还必须有
就都属于同一定的间隙。因此，接收端只要找到帧开始定界符，其后面的连续到达的比特流
个MAC帧。可见以太网不需要使用帧结束定界符，也不需要使用字节插入来保证透明传输。
一IEEE802.3标准规定凡出现下列情况之
(1)帧的长度不是整数个字节；
(2)用收到的帧检验序列FCS查出有差错；
(3)收到的帧的MAC客户数据字段的长度不在46的即为无效的MAC帧：~1500字节之间。考虑到MAC帧首部和尾部的长度共有18字节，可以得出有效的MAC帧长度为64~1518字节之间。
对于检查出的无效MAC帧就简单地丢弃。以太网不负责重传丢弃的帧。
一最后要提
一式的区别就是以下三点。
下，IEEE802.3标准规定的MAC帧格式与上面所讲的以太网V2MAC帧格“”第，IEEE802.3规定的MAC帧的第三个字段是长度／类型。由于以太网有效帧的“”“类型段就表示最大长度是1518字节。因此当这个字段值大千Ox0600时（相当千十进制的1536)，这个字
样。只有当这个字段值
，即MAC帧的数据部分长度。显然，在这种情况下，若数据。这样的帧格式就和以太网V2MAC帧格式完全小于Ox0600时才表示
字段的长度与实际的长度字段的值不
经讲过，由于以太网采用了曼彻斯特编码，长度字段本来并无实际意义。
致，则该帧为无效的MAC帧。实际上，前面我们已长度一““”一第二，当
LLC子层的LLC帧。
长度／类型字段值小千Ox0600时，数据字段必须装入上面的逻辑链路控制第三，在802.3标准的文档中，MAC帧的帧格式包括了8字节的前同步码和帧开始定界符。有些教科书也是这样引用的。不过这并不影响我们对以太网工作原理的理解。
由千现在广泛使用的局域网只有以太网，因此LLC帧已经失去了原来的意义（见本章””以太网的两个主要标准3.3.1节第1小节
但大家也常常把它称为IEEE802.3标准的MAC帧。
3.4扩展的以太网)。现在市场上流行的都是以太网V2的MAC帧，在许多情况下，我们希望把以太网的覆盖范围扩展。本节先讨论在物理层把以太网扩扫一扫展，然后讨论在数据链路层把以太网扩展。这种扩展的以太网在网络层看来一仍然是
3.4.1在物理层扩展以太网个网络。
以太网上的主机之间的距离不能太远（例如，lOBASE-T以太网的两台视频讲解•99•