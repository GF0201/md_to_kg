0609010306010201070100--OBJECTIDENTIFIER类型，长度0916,udplnDatagrams0500--NULL类型，长度00166.8应用进程跨越网络的通信在这以前我们已经讨论了互联网使用的几种常用的应用层协议，这些应用协议使广大用户可以更加方便地利用互联网的资源。
现在的问题是：如果我们还有一直接使用已经标准化的互联网应用协议，那么我们应当做哪些工作？要回答这个问题，实际些特定的应用需要互联网的支持，但这些应用又不能一一上就是要了解下面要介绍的系统调用和应用编程接口。这些问题需要
我们在这里只能给出
些初步的概念。
6.8.1系统调用和应用编程接口门专门的课程来学习，大多数操作系统使用系统调用(systemcall)的机制在应用程序和操作系统之间传递控制
般程序设计中的函数调用非常相似，只是系统调用是将控权。对程序员来说，系统调用和
制权传递给了操作系统。图6-26说明了多个应用进程使用系统调用的机制。
一．间中在用户地址空
的应用程序由应用程序调用的系统函数-—系统调用接口间中包括TCP/IP协议软件的操作系统内核－－』一－雷厂臣昙置图6-26多个应用进程使用系统调用的机制一当某个应用进程启动系统调用时，控制权就从应用进程传递给了系统调用接口。此接
口再把控制权传递给计算机的操作系统。操作系统把这个调用转给某个内部过程，并执行所
请求的操作。内部过程
旦执行完毕，控制权就又通过系统调用接口返回给应用进程。总之，
只要应用进程需要从操作系统获得服务，就要把控制权传递给操作系统，操作系统在执行必
要的操作后把控制权返还给应用进程。因此，系统调用接口实际上就是应用进程的控制权和
操作系统的控制权进行转换的
些程序，
特别是需要设置系统调用中的许多参数，因此这种系统调用接口又称为应用编程接口API
(ApplicationProgrammingInterface)。API从程序设计的角度定义了许多标准的系统调用函数。
应用进程只要使用标准的系统调用函数就可得到操作系统的服务。因此从程序设计的角度看，个接口。由于应用程序在使用系统调用之前要编写一一也可以把API看成是应用程序和操作系统之间的接口。
现在TCP/IP协议软件已驻留在操作系统中。由于TCP/IP协议族被设计成能运行在多
种操作系统的环境中，因此TCP/IP标准没有规定应用程序与TCP/IP协议软件如何接口的细
节，而是允许系统设计者能够选择有关API的具体实现细节。目前，只有几种可供应用程
序使用TCP/IP的应用编程接口API。这里最著名的就是美国加利福尼亚大学伯克利分校为
种API，它又称为套接字接口(socketinterface)（或插口接
BerkeleyUNIX操作系统定义的
口）。微软公司在其操作系统中采用了套接字接口API,形成了个稍有不同的API，并称一一•316•WindowsSocket,WinSockAT&TUNIXV一API,。
为其系统定义了种简写为TLI(TransportLayerInterface)
之为
简称为
。
一我们知道，若要让计算机做某件事情，就要编写使计算机能理解的程序。在网络环境
一一下的计算机应用都有个共同特点，这就是：位千不同地点的计算机要通过网络进行通信。
一
种角度看，计算机之间的通信就是本计算机要读取另从另
者要把数据从本计算机写入到另
用到上面所说的系统调用。
个地点的计算机中。这种“““＂个地点的计算机中的数据，或
的过程都要
写入
读取和6-27一UDP
这在讨论网络编程时常常把套接字作为应用进程和运输层协议之间的接口，图
概念。图中假定了运输层使用
协议（若使用
协议，情况也是类似的，只是
是无连接的。通信的两端仍然可用两个套接字来标志）。现在套接字已成为计算机操作表示一TCPUDP系统内核的部分。
由用应
控}程
制}一-}－；­一由操作麟----}-序＾
门
 丿五系－－－－－客户服务器图6-27套接字成为应用进程与运输层协议的接口请注意：在套接字以上的进程是受应用程序控制的，而在套接字以下的运输层协议软
协议进行通信，它就必件则是受计算机操作系统的控制。因此，只要应用程序使用TCP/IP须通过套接字与操作系统交互（这就要使用系统调用函数）并请求其服务。我们应当注意到，
应用程序的开发者对套接字以上的应用进程具有完全的控制，但对套接字以下的运输层却只
有很少的控制，例如，可以选择运输层协议
些运输层的参数（如最
socket大缓存空间和最大报文长度等）。
UDP)(TCP以及或一一＂“当应用进程（客户或服务器）需要使用网络进行通信时，必须首先发出系统调一
用，请求操作系统为其创建
信所需要的
作系统为这些资源的总和用套接字
些系统资源（存储器空间、个一CPU。这个调用的实际效果是请求操作系统把网络通
时间、网络带宽等）分配给该应用进程。操(socketdescriptor)的号码（小的整数）来
表示，然后把这个套接字描述符返回给应用进程。此后，应用进程所进行的网络操作（建立个叫作套接字描述符连接、收发数据、调整网络通信参数等）都必须使用这个套接字描述符。所以，几乎所有的
个参数。在处理系统调
网络系统调用都把这个套接字描述符作为套接字的许多参数中的第
close
用的时候，通过套接字描述符，操作系统就可以识别出应该使用哪些资源来完成应用进程所
请求的服务。通信完毕后，应用进程通过
系统调用通知操作系统回
收与该套接字描述符相关的所有资源。由此可见，套接字是应用进程为了获得网络通信服务个关闭套接字的一一一而与操作系统进行交互时使用的6-28socket
种机制。
一图给出了当应用进程发出系统调用时，操作系统所创建的套接字描述符与一一套接字数据结构的关系。由千在个进程中可能同时出现多个套接字，因此需要有个存放套接字描述符的表，而每个套接字描述符有个指针指向存放套接字的地址。在套接字的
•317•一数据结构中有许多参数要填写。图6-28中已填写好的参数是协议族(PF_INET,表示使用
Internet的TCP/IP协议族）和服务(SOCK_STREAM,表示使用流式服务，也就是使用TCP服务）。在刚刚创建
本地和远地端口）都是未填写的，因此它和任何机器中的应用进程暂时都还没有联系。
个新的套接字时，有灰色背景的四个项目（本地和远地IP地址，一操作系统套接字的数据结构一（每0:
1:
2:
3:
4:一
套接字描述符表
个进程个描述符表）＿-
-
-
-
．．．图6-28调用socket创建套接字一一这里要特别强调个名词socket可表
下，在第5章5.3.2节的最后，我们曾指出，同
示多种不同的意思。在本节讨论socket系统调用时，套接字socket已不仅仅是RFC793所
定义的如公式(5-1)所示的那样，而是如图6-28右边所示的套接字的数据结构。
6.8.2几种常用的系统调用下面我们以使用TCP的服务为例介绍几种常用的系统调用。
1.连接建立阶段当套接字被创建后，它的端口号和IP地址都是空的，因此应用进程要调用bind（绑
定）来指明套接字的本地地址（本地端口号和本地IP地址）。在服务器端调用bind时就是
把熟知端口号和本地IP地址填写到己创建的套接字中。这就叫作把本地地址绑定到套接字。
在客户端也可以不调用bind,这时由操作系统内核自动分配个动态端口号（通信结束后一由系统收回）。
服务器在调用bind后，还必须调用listen（收听）把套接字设置为被动方式，以便随时接受客户的服务请求。UDP服务器由千只提供无连接服务，不使用listen系统调用。
服务器紧接着就调用accept（接受），以便把远地客户进程发来的连接请求提取出来。
一一系统调用accept的个变量就是要指明是从哪个套接字发起的连接。
一调用accept要完成的动作较多。这是因为个服务器必须能够同时处理多个连接。
这样的服务器常称为并发方式(concurrent)工作的服务器。可以有多种方法实现这种并发方式。
图6-29所示的是种实现方法。
一主服务器进程M（就是通常所说的服务器进程）一调用accept,就为每一个新的连接请求创建一个新的套接字，并把这个新创建的套接字的标识符返回给发起连接的客户方。
与此同时，主服务器进程还要创建一个从属服务器进程（如图6-29中的S1)来处理新建立的连接。这样，从属服务器进程用这个新创建的套接字和客户进程建立连接，而主服务器进•318•程用原来的套接字重新调用accept,继续接受下一个连接请求。在已建立的连接上，从属服务器进程就使用这个新创建的套接字传送和接收数据。数据通信结束后，从属服务器进程就关闭这个新创建的套接字，同时这个从属服务器也被撤销。
主服务器进程
、
、
、、
、
、
、、
、、
、、、、、、、、、、、、、、、、、、、
、、、、
、、、、
、从属服务器进程
、、、
、~、:\＼｀、-—＿服务器应用进程连接
套接字
—连接
套接字连接
套接字
—一贮一-（新创建的套接字）图6-29并发方式工作的服务器---操作系统总之，在任一时刻，服务器中总是有一个主服务器进程和零个或多个从属服务器进程。
主服务器进程用原来的套接字接受连接请求，而从属服务器进程用新创建的套接字（在图6-29中注明是“
连接套接字”)和相应的客户建立连接并可进行双向传送数据。
以上介绍的是服务器为了接受客户端发起的连接请求而进行的一些系统调用。现在看一下客户端的情况。当使用TCP协议的客户已经调用socket创建了套接字后，客户进程就调用connect,以便和远地服务器建立连接（这就是主动打开，相当于客户发出的连接请求）。在connect系统调用中，客户必须指明远地端点（即远地服务器的IP地址和端口号）。
2.数据传送阶段客户和服务器都在TCP连接上使用send系统调用传送数据，使用recv系统调用接收数据。通常客户使用send发送请求，而服务器使用send发送回答。服务器使用recv接收客户用send调用发送的请求。客户在发完请求后用recv接收回答。
调用send需要三个变量：数据要发往的套接字的描述符、要发送的数据的地址以及数据的长度。通常send调用把数据复制到操作系统内核的缓存中。若系统的缓存已满，send就暂时阻塞，直到缓存有空间存放新的数据。
调用recv也需要三个变量：要使用的套接字的描述符、缓存的地址以及缓存空间的长度。
3.连接释放阶段一旦客户或服务器结束使用套接字，就把套接字撤销。这时就调用close释放连接和撤销套接字。
图6-30画出了上述的一些系统调用的使用顺序。有些系统调用在一个TCP连接中可能会循环使用。
•319•客户端服务器端socketibindsocke七iteni
i连接建立请求connect-------=i
-－－－－－－－－-－－－－－－－－－-－一气卢
-:I二::c----------
------
------------------i◄--－－－－－－－－－－－－－－－－－－－－－－－－－-－－－－－－－recvsendclosecljse图6-30系统调用使用顺序的例子UDP服务器由千只提供无连接服务，因此不使用lis七en和accept系统调用。
6.9P2P应用我们在第1章的1.3.1节中已经简单地介绍了P2P应用的概念。现在我们将进一步讨论P2P应用的若干工作原理。
P2P应用就是指具有P2P体系结构的网络应用。所谓P2P体系结构就是在这样的网络应用中，没有（或只有极少数的）固定的服务器，而绝大多数的交互都是使用对等方式(P2P方式）进行的。
P2P应用的范围很广，例如，文件分发、实时音频或视频会议、数据库系统、网络服务支持（如P2P打车软件、P2P理财等）。限于篇幅，下面只介绍最常用的P2P文件分发的工作原理。
P2P文件分发不需要使用集中式的媒体服务器，而所有的音频／视频文件都是在普通的互联网用户之间传输的。这其实是相当于有很多（有时达到上百万个）分散在各地的媒体服务器（由普通用户的计算机充当这种媒体服务器）向其他用户提供所要下载的音频／视频文件。这种P2P文件分发方式解决了集中式媒体服务器可能出现的瓶颈问题。
目前在互联网流量中，P2P工作方式下的文件分发已占据了最大的份额，比万维网应用所占的比例大得多。因此单纯从流量的角度看，P2P文件分发应当是互联网上最重要的应用。
现在P2P文件分发不仅传送音频文件MP3,而且还传送视频文件(10~1000MB,或更大）、各种软件和图像文件。
6.9.1具有集中目录服务器的P2P工作方式最早使用P2P工作方式的是Napster。这个名称来自1999年美国东北大学的新生Shawn
个叫作Napster的软件。利用这个软件就可通过互联网免费下载各种MP3Fanning所写的一•320•