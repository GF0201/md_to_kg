•本数字证书所使用的签名算法
•数字证书签发者的唯
标识符一一
•数字证书的有效期（有效期开始到结束的日期范围）一一标识符）•主体名（或主题名，公钥和数字证书拥有者的唯
•公钥（数字证书拥有者的公钥和使用算法的标识符，对应的私钥由证书拥有者保存）
个树状的认证系统（如图7-16(a)所示）。
X.509提出把多级认证中心链接起来的，构成
在多级认证系统的末端就是用户(A~E)。在X.509中并没有规定这种链接需要多少级，也
没有给每
级的认证中心都称为根认证中心(Root
CA)，即公认可信的认证中心（或无条件信任的），且其公钥是公开的。在这种树状的认证
个根CA。从根CA向下的所有链接都称为信任链，表示处在这条链
系统中，可以有不止
接上的认证机构都是可信的。
级的认证中心规定统
一的名称。但最高一一根证书....,,_者2KK心“－中间CA的证书？
中间CA中间CA的公钥根CA签发(a)(b)图7-16树状结构的多级认证系统(a)和证书链(b)一一一一一串链接就是图7-16(a)最右边的用户E。与这
条信任链对应的是证书链（如图7-16(b)所示），通过图中所示的链接，就可以查到本证书的
签发者，也可以知道用谁的公钥来验证本证书中的签名。在这条证书链中，根CA给中间
2
CA签发了中间证书，并使用根CA的私钥进行数字签名。中间CA2可以用根CA的公钥，条信任链的例子：根CA中间CA22对证书中的根CA签名进行验证。因此中间证书是可信的和不可篡改的。同理，中间CA
个用户签发了用户证书，并使用中间C心的私钥进行数字签名。用户可以用中
给下面的
的签名进行验证。因此，这个用户证书也是可信
间C心的公钥，对用户证书中的中间CA
的和不可篡改的。请注意，最顶层的根证书的数字签名是自签名（即自己的私钥给自己签
名）。根证书不需要其他的认证机构对其签名，是我们的信任链的起点。
2若证书链中的某个认证中心没有严格遵守证书所规定的要求（例如，把证书转让给了一一其他单位，但并未严格验证其身份），那么这个节点以下的证书是否还可信，就应重新验证。
个
用户若发现私钥被盗或遗失，应及时报告上级CA,以便撤销证书。每
公布千众的、用本CA的私钥签名证书撤销名单，并定期更新。
7.5互联网使用的安全协议个CA应当有前面几节所讨论的网络安全原理都可用在互联网中，目前在网络层、运输层和应用层都有相应的网络安全协议。下面分别介绍这些协议的要点。
•352•网络层安全协议7.5.11.IPsec协议族概述我们在第4章的4.8.1节中讨论虚拟专用网VPN时，提到在VPN中传送的信息都是经一名词”
“
IPsec并不是单
IPsec协议过加密的。现在我们就要介绍提供这种加密服务的IPsec。
一
的协议，而是能够在IP层提供互联网通信安全的协议族（不太严格的
个通用框架和若干加密算法，具有
IPsec允许通信双方从中选择合适的算法和参数（例如，密钥长
IPsec规定其所有的实现都必须包含IPsec所推度），以及是否使用鉴别。为保证互操作性，相当的灵活性和可扩展性。
也常见到）。实际上，IPsec包含了“荐的全部加密算法。
IPsec就是IP安全(security)"的缩写。在很多RFC文档中已给出了详细的描述。在这
（目前是建议标准）和提供些文档中，最重要的就是描述IP安全体系结构的RFC4301
IPsec协议族概述的RFC6071。
IPsec协议族中的协议可划分为以下三个部分：
(1)IP安全数据报格式的两个协议：鉴别首部AH(AuthenticationHeader)协议和封装安全有效载荷ESP(EncapsulationSecurityPayload)协议。
(2)有关加密算法的三个协议。
(3)互联网密钥交换IKE(InternetKeyExchange)协议。
下面我们要重点介绍IP安全数据报的格式，以便了解IPsec怎样提供网络层的安全通信。AH协议提供源点鉴别和数据完整性，但不能保密。而ESP协议比AH协议复杂得多，
它提供源点鉴别、数据完整性和保密。
IPsec支持1Pv4和1Pv6。在1Pv6中，AH和ESP都
部分。AH协议的功能都已包含在ESP协议中，因此使用ESP协议就可以是扩展首部的一不使用AH协议。下面我们将不再讨论AH协议，而只介绍ESP协议的要点。
一一使用ESP或AH协议的IP数据报称为IP安全数据报（或IPsec数据报），它可以在两台主机之间、两个路由器之间或台主机和个路由器之间发送。
IP安全数据报有以下两种不同的工作方式。
第种工作方式是运输方式(transportmode)。运输方式是在整个运输层报文段的前后分别添加若干控制信息，再加上IP首部，构成IP安全数据报（见图7-17(a)）。
一发
送
在
前IPsec首部IPsec尾部IPsec首部可IPsec尾部且IP首部IIP安全数据权的有效载荷•IP首部I
,IP安全数据报(a)运输方式
图7-17IP安全数据报的两种工作方式IP安全数据报的有效载荷IP安全数据报(b)隧道方式，一
第二种工作方式是隧道方式(tunnelmode)。隧道方式是在原始的IP数据报的前后分别添加若干控制信息，再加上新的IP首部，构成个IP安全数据报（见图7-17(b)）。
无论使用哪种方式，最后得出的IP安全数据报的IP首部都是不加密的。只有使用不加密
的IP首部，互联网中的各个路由器才能识别IP首部中的有关信息，把1P安全数据报在不安全•353•的互联网中进行转发，从源点安全地转发到终点。所谓“安全数据报”是指数据报的数据部分是经过加密的，并能够被鉴别的。通常把数据报的数据部分称为数据报的有效载荷(payload)。
由千目前使用最多的就是隧道方式，因此下面的讨论只限千隧道方式。
2.安全关联在发送IP安全数据报之前，在源实体和目的实体之间必须创建一条网络层的逻辑连接，即安全关联SA(SecurityAssociation)。这样，传统的互联网中无连接的网络层就变为了具有逻辑连接的一个层。安全关联是从源点到终点的单向连接，它能够提供安全服务。如要进行双向安全通信，则两个方向都需要建立安全关联。假定某公司有一个公司总部和一个在外地的分公司。总部需要和这个分公司以及在各地出差的n个员工进行双向安全通信。在这种情
共需要创建(2+2n)条安全关联SA。在这些安全关联SA上传送的就是IP安全数据况下，一报。
图7-18(a)是安全关联SA的示意图。公司总部和分公司都各有一个负责收发IP数据报的路由器R1和民（通常就是公司总部和分公司的防火墙中的路由器），而公司总部与分公
司之间的安全关联SA就是在路由器R1和民之间建立的。当然，路由器民和民都必须预
先装有IPsec。现假定公司总部的主机凡要和分公司的主机儿通过互联网进行安全通信。
公司总部主机凡发送给分公司主机压的IP数据报，必须先经过公司总部的路由器R]0然后经IPsec的加密处理后，成为IP安全数据报。这样就把原始的IP数据报隐藏在IP安全数据报中了。IP安全数据报经过互联网中很多路由器的转发，最后到达分公司的路由器R沪
路由器民对IP安全数据报解密，还原出原始的数据报，传送到终点主机H2。从逻辑上看，IP安全数据报在安全关联SA上传送，就好像通过一个安全的隧道。这就是＂”
隧道方式这一名词的来源。如果总部的主机凡要和总部的另一台主机儿通信，由于都在公司内部，不需要加密，因此不需要建立安全关联。凡发出的IP数据报只需通过总部内部的路由器R1一转发次即可送到H3。如果凡要上网查看天气预报，同样不需要建立安全关联，而是发送
一IP数据报，经过路由器R1转发到互联网中的下个路由器，最后到达互联网中预报气象的服务器。
•354•-－`、三(a)公司总部与分公司的安全通信公司总部
三互联网:H(b)公司总部与业务员的安全通信图7-18安全关联SA的示意图若公司总部的主机凡要和某外地业务员的便携机压进行安全通信，则情况将稍有不同
（如图7-18(b)所示）。可以看出，这时公司总部的路由器民和外地业务员的便携机压建立安全关联SA（即路由器和主机之间的安全关联）。公司总部凡发送的IP数据报，通过路由
器民后，就变成了IP安全数据报。经过互联网中许多路由器的转发，最后到达H
看出，现在是在路由器民和业务员的便携机儿之间构成了
事先安装在便携机H个安全隧道。外地业务员利用
中的IPsec对IP安全数据报进行鉴别和解密，还原凡发来的IP数据。可以一22报。
建立安全关联SA的路由器或主机，必须维护这条SA的状态信息。我们以图7-18中的一安全关联SA为例，说明其状态信息应包括的项目：(1)个32位的连接标识符，称为安全参数索引SPI(SecurityParameterIndex)。
(2)安全关联SA的源点和终点的IP地址（即路由器民和民的IP地址）。
(3)所使用的加密类型（例如，DES或AES)。
(4)加密的密钥。
(5)完整性检查的类型（例如，使用报文摘要MD5或SHA-1的报文鉴别码MAC)。
(6)鉴别使用的密钥。
1当路由器R要通过SA发送IP安全数据报时，就必须读取SA的这些状态信息，以便知道如何把IP数据报进行加密和鉴别。
3.IP安全数据报的格式一图7-19是IP安全数据报的格式。下面以隧道方式为例，结合各字段的作用，讨论下IP安全数据报是怎样构成的。图中的数字0至O表示IP安全数据报构成的先后顺序。
尸芦协议＝50IP安全数据报IP安全数据报的有效载荷O鉴别的部分＠加密的部分（填充为4字节的倍数）国气”;10报立lj码32位图7-19IP安全数据报的格式一0首先在原始的IP数据报（也就是ESP的有效载荷）后面添加ESP尾部。ESP尾部
个字段是填充字段，用全0填充。第二个字段是填充长度(8位），指出有三个字段。第一填充字段的字节数。为什么要进行填充呢？这是因为在进行数据加密时，通常都要求数据块
长度是若干字节（例如，4字节）的整数倍。当IP数据报长度不满足此条件时，就必须用0
一
进行填充。每个0为
个字节长。虽然填充长度(8位）的最大值是255,但实际上，填充
很少会用到这个最大值。ESP尾部最后
(8位）。这个字段的值指
明，在接收端，ESP的有效载荷应交给哪个协议来处理。如图7-19所示，IP安全数据报有个字段是个首部下一“”•355•三个首部。现在ESP尾部中的““首部,IP的协议值是4,因此运输方式，则“
ESP的有效载荷”下
“一“个首部一个首部下显然就是指ESP的有效载荷中的
“应填入的数值是4。如果不是隧道方式而是“原始的IP就应当是TCP或UDP报文段，“一下个首部”的值也要改为另外的数值。
＠按照安全关联SA指明的加密算法和密钥，对报）＋ESP尾部“”
（见图7-19中的
““加密的部分”
)进行加密。
“
ESP的有效载荷（即原始的IP数据＠对加密的部分完成加密后，就添加ESP首部。ESP首部有两个32位字段。第一个字段存放安全参数索引SPI。通过同一个SA的所有IP安全数据报都使用同样的SPI值。
第二个字段是序号，鉴别要用到这个序号，它用来防止重放攻击。请注意，当分组重传时序号并不重复。
0按照SA指明的算法和密钥，对的部分”
)生成报文鉴别码MAC。
“
ESP首部＋加密的部分”（见图7-19中的＂鉴别©把所生成的报文鉴别码MAC添加在ESP尾部的后面，和ESP首部、ESP的有效载荷、ESP尾部一起，构成IP安全数据报的有效载荷。
0生成新的IP首部，通常为20字节长，和普通的IP数据报的首部的格式是一样的。
需要注意的是，首部中的协议字段的值是50,表明在接收端，首部后面的有效载荷应交给ESP协议来处理。
当分公司的路由器民收到IP安全数据报后，先检查首部中的目的地址。发现目的地址就是R2,千是路由器民就继续处理这个IP安全数据报。
路由器凡找到IP首部的协议字段值（现在是50)，就把IP首部后面的所有字段（即IP安全数据报的有效载荷）都用ESP协议进行处理。先检查ESP首部中的安全参数索引SPL以确定收到的数据报属于哪一个安全关联SA（因为路由器R2可能有多个安全关联）。
路由器凡接着计算报文鉴别码MAC,看是否和ESP尾部后面添加的报文鉴别码MAC相符。
如是，即知收到的数据报的确是来自路由器R]。再检验ESP首部中的序号，以证实有无被入侵者重放。接着要用和这个安全关联SA对应的加密算法和密钥，对已加密的部分进行解密。再根据ESP尾部中的填充长度，去除发送端填充的所有O,还原出加密前的ESP有效载荷，也就是凡发送的原始IP数据报。
“一”根据解密后得到的ESP尾部中的值（现在是4)，把ESP的有效载荷交
给IP来处理。当找到原始的IP首部中的目的地址是主机压的IP地址时，就把整个的IP
数据报传送给主机H2。整个IP数据报的传送过程到此结束。
个首部下请注意，在图7-19的原始的IP首部中，是用主机H]和压的IP地址分别作为源““““地址和目的地址，而在IP安全数据报的址分别作为源地址和目的地址（这是图7-IP安全数据报不经过另一新的IP首部
中，是使用路由器凡和民的IP地
18(a)所示的情况）。但如果是图7-18(b)所示的情况，
““个路由器R2,那么在IP安全数据报的新的IP首部中，要用路由器R]和主机压的IP地址分别作为IP安全数据报的源地址和目的地址。
一从以上的讨论可以看出，设想有个IP安全数据报在互联网中被某人截获，如果截获者不知道此安全数据报的密码，那么他只能知道这是一个从路由器民发往路由器民的IP数据报，但却无法看懂其有效载荷中的数据含义。如果截获者篡改了数据报的源地址，那么
一安全数据报的鉴别功能可以保证源地址的真实性。假定截获者故意删除了安全数据报中的些字节，但由于接收端的路由器凡能够进行完整性检验，就不会接收这种含有差错的信息。
•356•如果截获者试图进行重放攻击，那么由千安全数据报使用了有效的序号，使得重放攻击也无法得逞。
4.IPsec的其他构件前面已经提到过，发送IP安全数据报的实体可能要用到很多条安全关联SA。那么这些
一个重要构件，叫作安全关联数据库SAD
SA存放在什么地方呢？这就要提及IPsec的
(SecurityAssociationDatabase)。所有需要运行IPsec的站点都必须有SAD。当主机要发送IP
安全数据报时，就要在SAD中查找相应的SA,以便获得必要的信息，来对该IP安全数据报实施安全保护。同样，当主机要接收IP安全数据报时，也要在SAD中查找相应的SA,以便获得信息来检查该分组的安全性。
前面已经提到了，主机所发送的数据报并非都必须进行加密，很多信息使用普通的数据报用明文发送即可。因此，除了安全关联数据库SAD,还需要另一个数据库，这就是安全策略数据库SPD(SecurityPolicyDatabase)。SPD指明什么样的数据报需要进行IPsec处理。
这取决千源地址、源端口、目的地址、目的端口，以及协议的类型等。因此，当一个IP数据报到达时，SPD指出应当做什么（使用IP安全数据报还是不使用），而SAD则指出，如果需要使用IP安全数据报，应当怎样做（使用哪一个SA)。
一个问题，安全关联数据库SAD中存放的许多安全关联SA是怎样建立起来的呢？
还有
一如果个虚拟专用网VPN只有几个路由器和主机，那么用人工键入的方法就可以建立起所需的安全关联数据库SAD。但如果一个VPN有好几百或几千个路由器和主机，人工键入的方法显然是不行的。因此，对千大型的、地理位置分散的系统，为了创建SAD,我们需要使用自动生成的机制，即使用互联网密钥交换IKE(InternetKeyExchange)协议。IKE的用途
就是为IP安全数据报创建安全关联SA。
IKE是个非常复杂的协议，IKEv2是其新的版本，在2014年10月已成为互联网的正式标准[RFC7296,STD79]。IKEv2以另外三个协议为基础：(1)Oakley是个密钥生成协议[RFC2412]。
(2)安全密钥交换机制SKEME(SecureKeyExchangeMEchanism)——是用于密钥交换的协议。它利用公钥加密来实现密钥交换协议中的实体鉴别。
(3)互联网安全关联和密钥管理协议ISAKMP(InternetSecureAssociationandKeyManagement
用于实现IKE中定义的密钥交换，使IKE的交换能够以标准化、格式化的报Protocol)文创建安全关联SA。
关于IKE的深入介绍可参阅有关文档，如RFC4945和RFC7427（都是建议标准）。
7.5.2运输层安全协议1.协议TLS的要点当万维网能够提供网上购物时，安全问题就马上被提到桌面上来了。例如，当顾客在不安全的互联网上购物时，他会要求得到下列安全服务：(1)顾客需要确保服务器属千真正的销售商，而不是某个冒充者。这就是应对身份进行鉴别。
(2)顾客与销售商需要确保报文的内容（例如账单）在传输过程中没有被篡改。这就是•357•应保证通信内容的数据完整性。
(3)顾客与销售商需要确保诸如信用卡上的敏感信息不被泄露。这就是要有机密性。
不仅在电子商务领域，即使在我们日常上网浏览各种信息时，我们所浏览的信息也是
属于个人隐私，不应作为网上的公开信息。因此，在很多情况下，客户端（浏览器）与服务
器之间的通信需要使用安全的运输层协议。曾经广泛使用的运输层安全协议有两个，即：
安全套接字层SSL(SecureSocketLayer)。
（2)运输层安全TLS(TransportLayerSecurity)。
（1)协议SSL是Netscape公司在1994年开发的安全协议，广泛应用于基于万维网的各种网
络应用（但不限于万维网应用）。SSL作用在端系统应用层的HTTP和运输层之间，在TCP一之上建立起个安全通道，为通过TCP传输的应用层数据提供安全保障。
1995年Netscape公司把协议SSL转交给IETF,希望能够把SSL进行标准化。
1999年IETF在SSL3.0的基础上设计了协议TLS1.0（改动极少），为所有基千TCP的网络应用提供
安全数据传输服务。为了应对网络安全的变化，
IETF及时地对TLS的版本进行升级，如
2006年的TLS1.1,2008年的TLS1.2。2014年10月，谷歌建议禁用SSL3.0,因为其设计上
有漏洞，用户的敏感信息有被窃取的可能。接着，Mozilla和微软也发出了同样的安全通告。
2018年8月IETF发布了经历了28个草案后才通过的最新版本TLS1.3[RFC8446,建议标准］
（不向后兼容）。在2020年，旧版本TLS1.0/1.1均被废弃。目前谷歌浏览器Chrome和火狐
浏览器Firefox都已开始使用更加安全的协议TLS1.3,但不少老客户端仍未抛弃
些旧版本。
应当说，到目前为止协议TLS1.2还是安全可用的，只是被发现了有潜在的安全隐患。因此，
现在能够使用的运输层安全协议就只剩下协议TLS1.2和协议TLS1.3了。
一“协议TLS的位置在运输层和应用层之间（如图7-20所示）。虽然协议SSL2.0/3.0均已
SSL/TLS"视为TLS的同义词。这是因为协议被废弃不用了，但现在还经常能够看到把
TLS本来就源千SSL（但并不兼容），而现在旧协议SSL被更新为新协议TLS。
I|应用程序
TLS（或SSl/TLS)TCPIP
图7-20协议TLS位千运输层和应用层之间应用层使用协议TLS最多的就是HTTP,但并非仅限千HTTP。因为协议TLS是对
TCP加密，因此任何在TCP之上运行的应用程序都可以使用协议TLS。例如，用于IMAP
邮件存取的鉴别和数据加密也可以使用TLS。TLS提供了
个简单的带有套接字的应用程
序接口API，这和TCP的API是相似的。
一当不需要运输层安全协议时，HTTP就直接使用TCP连接，这时协议TLS不起作用。
由于需要使用运输层安全协议的人越来越多，因此现在相当多的网站已是全站使用运输层安
全协议。例如，当我们使用百度网站浏览信息时，在浏览器的地址栏键入其官网地址
www.baidu.com后（不必在前面键入http:／／或https://)，就可以在屏幕上看到这样的响应：屾匡tps://wv..f\ft/.baidu.com可以看出，尽管用户在浏览器上没有键入https://,但百度网站总是提供安全的运输层
服务。提供安全运输层服务的标志是地址栏URL中的协议部分显示出的是https,并且在其•358•一个安全锁妯的标志。在http后面加上的s代表security,表明是使用HTTPS,即
左边还有
提供安全服务的HTTP协议(TCP的HTTPS端口号是443,而不是HTTP使用的端口号80)。
这时我们就可以放心和这样的网站进行通信，因为这个网站已经被鉴别了是真正的百度网站，并且之后在浏览器和百度服务器之间的所有交互报文都是加密的，因而通信的机密性得到了
”“保证。
现在我们使用某些主流浏览器访问不安全的网站时，浏览器会向用户发出
”的警告。下面给出当我们键入桔梗网的网址shu.jiegeng.com后所看到的响应：“不安全谷歌Chrome浏览器指出不安全不安主shu.jfegeng.com火狐Firefox浏览器提示无安全锁
©/;Jshujiegeng.com这就提醒我们在上网时要注意信息的安全。
一协议TLS具有双向鉴别的功能。但大多数情况下使用的是单向鉴别，即客户端（浏览
器）需要鉴别服务器。也就是说，浏览器A要确信即将访问的网站服务器B是安全和可信
的。这必须要有两个前提。首先，服务器B必须能够证明本身是安全和可信的。因此服务
个证书来证明自己。现在我们假定服务器B已经持有了有效的CA证书。这
器B需要有
一
正是运输层安全协议TLS的基石。其次，浏览器A应具有
些手段来证明服务器B是安全
和可信的。下面就来讨论这一点。
生产电脑操作系统的厂商为了方便用户，把当前获得公众信任的许多主流认证中心CA
的根证书，都已内置在其操作系统中。这些根证书上都有认证中心CA的公钥PKCA，而且
根证书都用CA的私钥SKcA进行了自签名（防止伪造）。用户为了验证要访问的服务器是否
安全和可信，只要打开电脑中的浏览器（操作系统自带的或用户自己装上的），就可查到操
作系统收藏的某个根认证中心的根CA证书，并可以利用证书上的公钥PKcA对B的证书进
行验证。若服务器B的证书是证书链上的某个中间CA签发的，那么浏览器A也可用类似
方法验证B的证书的真实性。
－“”由千浏览器与服务器的通信方式就是以前讲过的客户服务器方式，因此下面就用客户代表浏览器。
如图7-21所示，在客户与服务器双方已经建立了TCP连接后，就可开始执行协议TLS。
根据RFC8446,这里主要有两个阶段，即握手阶段和会话阶段。在握手阶段，TLS使用其
中的握手协议，而在会话阶段，TLS使用其中的记录协议。下面讨论协议TLS的要点。
B服务器客户Al＠用CA的公钥
鉴别B的证书
MS握手协议产生主密钥IO
t＠生成会话密钥kSKB(P凡(MS))=MS
0用B的私钥解密＠生成会话密钥记录协议数据传输（保密，完整性）图7-21TLS建立安全会话的工作原理•359•我们先介绍协议TLS的握手阶段。握手阶段要验证服务器是安全可信的，同时生成在后面的会话阶段所需的共享密钥，以保证双方交换的数据的私密性和完整性。这里要提醒读
者，在刚开始执行协议TLS时，通信双方的信道是不安全的。因此要弄清：
（1)双方怎样通
过不安全的信道得到会话时所需的共享密钥。这里没有采用密钥分发中心KDC来分配密钥，
而是采用自己生成共享密钥的方法。
(2)用什么方法保证所传送数据的机密性与完整性。
一一下，从TLS1.0更新到1.1和1.2版本时，每(1)协商加密算法O客户A向服务器B发送自己选定的加密算法（包括密钥交换算
法）。＠服务器B从中确认自己所支持的算法，同时把自己的CA数字证书发送给A。这里
次更新都增加了当时认为是更加安要说明
全可靠的加密算法。为了协议的向后兼容，对老版本中的不太安全的数十种算法也都保留下
来了。这就造成协商过程非常耗时，需要花费2倍RTT的时间（通常记为2-RTT)。因此最
新的TLS1.3版本把陈旧的很多种算法统统取消（例如MD5,SHA-I,DES,3DES等），只留
下几种最安全的算法。客户不是把自己所有的加密算法都告诉服务器，供服务器来挑选，而
是猜测服务器可能愿意使用什么加密算法，把自己选定的加密算法直接发送给服务器，让服
务器来确认。这就把“协商时间缩短为1-RTT。
”(2)服务器鉴别
(3)生成主密钥©客户A用数字证书中CA的公钥对数字证书进行验证鉴别。
B
O客户A按照双方确定的密钥交换算法生成主密钥MS(MasterSecret)。
(MS)，发送给服务器对主密钥MS加密，得出加密的主密钥PK一B©客户A用B的公钥PK
B。请注意，在有关TLS的文档中，密钥词使用的是Secret,而不是Key。
(4)服务器B用自己的私钥把主密钥解密出来：SKs(PK叭MS))=MS。这样，客户A和服务器B都拥有了为后面的数据传输使用的共同的主密钥MS。
一(5)为了使双方的通信更加安全，客户A和服务器B最好使用不同的密钥。千是主密钥
方被分割成4个不同的密钥，这就是图7-21中的＠和0：生成会话密钥。在这以后，每
都拥有这样4个密钥（请注意，这些都是对称密钥，即加密和解密用的是同个密钥）：一A•客户A发送数据时使用的会话密钥K
B
•客户A发送数据时使用的MAC密钥MAB•服务器B发送数据时使用的会话密钥K
•服务器B发送数据时使用的MAC密钥M
会话密钥不使用非对称密钥，因为对称密钥的运行速度快得多（相差3个数量级）。
下面讨论协议TLS的会话阶段。会话阶段要保证传送数据的机密性和完整性。
客户或服务器在发送数据时，都把长的数据划分为较小的数据块，叫作记录(record)。
一一一
个记录进行鉴别运算和加密运算。为了防止入侵者截取传输中的记录，或颠倒记然后对每
录的前后顺序，TLS的记录协议对每
个记录作为0号记录。发送下
允许序号绕回。然而此序号并非写在记录之中，而是在进行散列运算时，把序号包含进去。
例如，当客户A向服务器B发送个记录时序号就加1,但序号最大值不得超过2
A个记录按发送顺序赋予序号，把每方发送的第和该记录当-1,且不一一一一64个明文记录时，客户A先把MAC密钥M
A前的序号起拼接在此明文记录之后，然后进行散列运算，得出MAC。再把得出的MAC
进行加密，发送给服务器B。B使用同样的会话密钥和明文记录拼接起来，用会话密钥K
趴进行解密，然后分离出明文记录和MAC。B再把同样的MAC密钥M
序号拼接在此明文记录之后，进行散列运算，看得出的结果与前面得出的MAC值是否
致，
以鉴别收到的明文记录的完整性（内容和顺序均无误）。上述对记录加密的方法称为AEAD和该记录应有的一A•360•(AuthenticatedEncryptionwithAssociatedData)，即带关联数据的鉴别加密。
实际上，客户A所发送的加密的记录的前面，还必须添加三个不加密的字段，图7-22
一
给出了这三个字段的位置。类型字段指明所传送的记录出握手阶段的报文，还是应用程序传
送的报文，或最后要关闭TLS连接的报文（下小节将要解释）。长度字段给出的字节数可用来从TCP报文中提取TLS记录。
`1版本A
对这部分用K—
加密
1长度厂｀：勹:;
豆已图7-22TLS传送的记录格式2.协议TLS必须包含的措施以上介绍的只是协议TLS的要点。但若仅仅是这样，还不能提供足够的安全。因此，一对前面图7-21所示的双方的握手阶段，需要补充些措施。
(1)在客户A向服务器B发送自己选定的加密算法（包括密钥交换算法）时，还要向
服务器B发送客户的不重数。服务器B从中确认自己所支持的算法，同时把自己的CA数
字证书和服务器的不重数发送给客户A。
一(2)生成预主密钥客户A验证了服务器B的数字证书后，生成为下B钥使用的预主密钥PMS(Pre-MasterSecret)，并用B的公钥PKB步生成主密
对预主密钥PMS加密，把加密的预主密钥PK8(PMS)发送给服务器B。B用其私钥SK
这样，客户A和服务器B都拥有了为后面的数据传输使用的共同的预主密钥PMS。
进行解密，得出预主密钥PMS。
(3)生成主密钥客户A和服务器B各自使用同样的（已商定的）算法，使用预�
密钥PMS以及客户的不重数和服务器的不重数，生成主密钥MS。然后再将其划分为4个
方在发送数据时使用的会话密钥和MAC密一密钥。千是A和B各拥有相同的4个密钥（每
钥）。
一(4)客户A向服务器B发送的全部握手阶段报文的MAC。
(5)服务器B向客户A发送的全部握手阶段报文的MAC。
上述最后的(4)和(5)的作用是这样的。在A向B发送加密的预主密钥之前的握手信息是
没有加密的明文，因此可能受到入侵者的篡改。现在A和B都各自对全部握手阶段的报文
计算了散列值MAC。如果入侵者篡改了处在传输过程中的某个报文，那么上面(4)和(5)所得
“
一
致。这样A或B就可以立即中止当前的连接。
出的MAC值必然不
一个仅使用在(1)中客户和服务器各产生次的不重数，其目的是为了防止重放攻击
设想在A和B之间有
个入侵者，他截获了A和B交互的全部报文。虽然他未能解密A和
B交互的具体内容，但他可以在以后的某日，重新按照原来的顺序依次发送给B。如果没有
一
使用上述的不重数，那么B无法发现这是入侵者重放旧的报文。B也将和前次的握手过程
样，向A发回报文（实际上是发给了中间人入侵者）。这样造成的后果是很严重的。但使
个不同的不重数。这样就有个TCP连接中，客户A必须使用另一一一”用了不重数以后，在下
效地防止了重放攻击。
。
前面曾提到在关闭TLS连接之前，A或B应当先发送关闭TLS的记录，目的是防止入
侵者的截断攻击(truncationattack)。所谓截断攻击就是在A和B正在进行会话时，入侵者突
个要关闭TLS
然发送TCP的FIN报文段来关闭TCP连接。但如果A或B没有事先发送一•361•的记录，那么A或B见到TCP的FIN报文段时，就知道这是入侵者的截断攻击了。入侵者无法伪造关闭TLS的记录，因为虽然记录前面的三个字段都是明文，但每个记录的内容是加密的，并有MAC保证其完整性的。
在TLS1.3中使用了更加安全的椭圆曲线密码ECC(EllipticCurveCryptography)与
AES,使运算速度比旧的1.2版本有了很大的提高。TLS1.3还添加了0-RTT的功能。这就
是说，如果客户之前连接过某服务器，TLS1.3通过储存先前会话的秘密信息，不需要经过
1-RTT的握手过程，仅需0-RTT即可开始会话阶段，这样就更加提高了TLS的效率。当然，这样做必须要防止可能发生的重放攻击。
7.5.3应用层安全协议一限于篇幅，我们在这
电子邮件在传送过程中可能要经过许多路由器，其中的任何
发的邮件进行阅读。从这个意义上讲，电子邮件是没有什么隐私可言的。
节仅讨论应用层中有关电子邮件的安全协议。
一个路由器都有可能对转电子邮件这种网络应用也有其很特殊的地方，这就是发送电子邮件是个即时的行为。
一一这种行为在本质上与我们前两节所讨论的不同。当我们使用IPSec或SSL时，我们假设双
个会话并双向地交换数据。而在电子邮件中没有会话存在。当A向
方在相互之间建立起
B发送
个电子邮件时，A和B并不会为此而建立任何会话。而在此后的某个时间，如果B
读取了该邮件，他有可能会、也有可能不会回复这个邮件。可见我们所讨论的是单向报文的
安全问题。
一如果说电子邮件是即时的行为，那么发送方与接收方如何才能就用于电子邮件安全的
致意见呢？如果双方之间不存在会话，不存在协商加密／解密所使用的算法，加密算法达成
那么接收方如何知道发送方选择了哪种算法呢？
要解决这个问题，电子邮件的安全协议就应当为每种加密操作定义相应的算法，以便用户在其系统中使用。A必须要把使用的算法的名称（或标识）包含在电子邮件中。例如，
A可以选择用AES进行加密／解密，并选择用SHA-1作为报文摘要算法。当A向B发送电
子邮件时，就在自己的邮件中包含与AES和SHA-1相对应的标识。B在接收到该邮件后，首先要提取这些标识，然后就能知道在解密和报文摘要运算时应当分别使用哪种算法了。
一一加密算法在使用加密密钥时也存在同样的问题。如果没有协商过程，通信的双方如何
在彼此之间知道所使用的密钥？目前的电子邮件安全协议要求使用对称密钥算法进行加密和
个密钥并把它与
解密，并且这个
起发送给B。为了保护密钥不被外人截获，这个密钥需要用收信人B的公钥进行加
报文
密。总之，这个密钥本身也要被加密。
起发送。发信人A可以生成次性的密钥要跟随报文一一一还有个问题也需要考虑。很显然，要实现电子邮件的安全就必须使用某些公钥算法。
例如，我们需要对密钥加密或者对邮件签名。为了对密钥进行加密，发信人A就需要收信一人B的公钥，同样为了验证被签名的报文，收信人B也需要发信人A的公钥。因此，为了个具有鉴别和保密的报文，就需要用到两个公钥。但是A如何才能确认B的公钥，发送
B又如何才能确认A的公钥呢？不同的电子邮件安全协议有不同的方法来验证密钥。
而一下面我们介绍在应用层为电子邮件提供安全服务的协议PGP。
PGP(PrettyGoodPrivacy)是Zimmeann千1995年开发的。它是个完整的电子邮件安全软件包，包括加密、鉴别、电子签名和压缩等技术。PGP并没有使用什么新的概念，•362•一些加密算法（如RSA公钥加密算法或MD5报文摘要算法）综合在起
它只是把现有的
而已。由千包括源程序的整个软件包可以从互联网免费下载[W-PGP]，因此PGP在MS-DOS/
Windows以及UNIX等平台上得到了广泛的应用。现在PGP的网站以每个月百万页的规模，
为百多个国家的用户提供服务。
后来PGP公司与Zimmennann同意IETF制定PGP的公开互联网标准OpenPGP。2007一一年IETF发布了OpenPGP的建议标准[RFC4880]。
PGP的工作原理并不复杂。它提供电子邮件的安全性、发送方鉴别和报文完整性。
假定A向B发送电子邮件明文X,现在用PGP进行加密。A有三个密钥：自己的私钥
次性密钥K。B有两个密钥：自己的私钥SKB和A的公SKA,B的公钥PKB和自己生成的一钥PK炉A需要做以下几件事（如图7-23所示）。
,l@A生成图7-23在发送方A的PGP处理过程0用A的私钥SKA对明文邮件X进行签名。把签名拼接在明文邮件X后面。
一＠利用随机数A生成
＠用A生成的
0用B的公钥PKB对A生成的
一一次性密钥K（共享的对称密钥）。
次性密钥K对已签名的邮件加密。
一次性密钥K进行加密。
©把已加密的
请注意，图7-23中三个次性密钥和已加密的签名邮件，拼接在
一“＂加密的作用是不同的。第一起发送给B。
次加密是用A的私钥SKA对明文邮件的报文摘要进行加密，即进行数字签名，目的是保证邮件的完整性。第二次加密是用一A生成的
B的公钥PKB对A的次性密钥K对已签名的邮件加密，目的是保证邮件的机密性。第三次加密是用一次性密钥K加密，目的是保证对称密钥K的机密性。
B收到A发过来的报文后要做以下几件事（建议读者自行画出相应的图，这里从略）：
(1)在文档RFC4880中，对加密邮件的各种格式（如仅加密但不鉴别，或仅鉴别但不加密，或加密加上鉴别），均有详细的规定。因此B可以根据邮件的种类，准确地把已加密一的次性密钥和已加密的签名报文分离开。
(2)用B私钥SKB解出一次性密钥K（这是对称密钥，加密和解密都需要各使用一次）。
(3)用导出的一字签名。
次性密钥K对加密的签名邮件进行解密，分离出明文邮件X和A的数(4)用B手中的A的公钥PKA对A的数字签名进行解密。然后即可接着验证邮件的完整性，具体的做法与前面图7-9所述的相似，这里不再重复。
在PGP中，发件方和收件方是如何获得对方的公钥呢？当然，最安全的办法是双方面对面直接交换公钥，但在大多数情况下这并不现实。因此可以通过认证中心CA签发的证书来验证公钥持有者的合法身份。然而在PGP中不要求使用CA,而是允许用一种第三方签署的方式来解决该问题。例如，如果用户A和用户B分别和第三方C已经确认对方拥有的公•363•钥属实，则C可以用其私钥分别对A和B的公钥进行签名，为这两个公钥进行担保。当A一得到个经C签名的B的公钥时，可以用已确认的C的公钥对B的公钥进行鉴别。不过，用户发布其公钥的最常见的方式还是把公钥发布在他们的个人网页上，或仅仅通过电子邮件进行分发。
PGP很难被攻破。因此在目前可以认为PGP是足够安全的。
7.6系统安全：防火墙与入侵检测恶意用户或软件通过网络对计算机系统的入侵或攻击已成为当今计算机安全最严重的一威胁之。用户入侵包括利用系统漏洞进行未授权登录，或者授权用户非法获取更高级别权限。软件入侵方式包括通过网络传播病毒、蠕虫和特洛伊木马。此外还包括阻止合法用户正常使用服务的拒绝服务攻击，等等。而前面讨论的所有安全机制都不能有效解决以上安全问的计算机系统通过网络向攻击者泄漏题。例如，加密技术并不能阻止植入了“特洛伊木马秘密信息。
7.6.1防火墙”防火墙(firewall)作为一种访问控制技术，通过严格控制进出网络边界的分组，禁止任何不必要的通信，从而减少潜在入侵的发生，尽可能降低这类安全威胁所带来的安全风险。由千防火墙不可能阻止所有入侵行为，作为系统防御的第二道防线，入侵检测系统IDS(IntrusionDetectionSystem)通过对进入网络的分组进行深度分析与检测发现疑似入侵行为的网络活动，并进行报警以便进一步采取相应措施。
防火墙是一种特殊编程的路由器，安装在一个网点和网络的其余部分之间，目的是实施访问控制策略。这个访问控制策略是由使用防火墙的单位自行制定的。这种安全策略应当最适合本单位的需要。图7-24指出防火墙位千互联网和内部网络之间。互联网这边是防火“”可信的网络墙的外面，而内部网络这边是防火墙的里面。一般都把防火墙里面的网络称为
(trustednetwork)气而把防火墙外面的网络称为不可信的网络(untrustednetwork)。
“”防火墙的外面唱，＇防火墙，防火墙的里面．－－/、;／可信的网络＼｝分组过滤
路由器I)＼!＼｝
＼二图7-24防火墙在互连网络中的位置CD注：2004年II月，联合国总部建立了“互联网冶理工作组WGIG(WorkingGrouponInternetGovernance)",来解决互联网的诚信和安全问题。我国在2006年2月颁布的《国家中长期科学和技术发展规划纲要(2006—2020年）》中，提出以发展高可信网络为重点。现在高可信网络已成为研究热点。
•364•