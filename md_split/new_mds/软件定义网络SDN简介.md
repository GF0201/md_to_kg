为了解决上述问题，一种保留了MPLS的主要特点，但更加简单的新的源路由选择协
议出现了。这就是段路由选择协议(SegmentRouting)，简称为SR。但不少人都使用＂
段路
由协议”这样更加简单的名称。在SR中，＂段(s
egment)"就是标签，也就是转发指令的一
种标识符。SR的工作原理仍然是基于标签交换的，不过现在不需要使用协议LDP,因此简化了设备运行的协议数量。SR由源(cid:7188)点为发送的报文指定路径，并将路径转换成有序的段列表(SegmentList)，即MPLS标签栈，它被封装在分组首部。网络中的其他(cid:7188)点就执行首部中的指令（即标签）进行转发。
整个网络设有控制器，也就是SDN控制器（见4.10(cid:7188)）。控制器收集并掌握全网的拓扑信息和链路状态信息，计算出分组应传送的整个路径。控制器负责给分组分配SR标签，这些标签指明了分组从源点到终点的路径。当分组到达某个网络(cid:7188)点时，(cid:7188)点就根据分组携
带的标签转发到下一个(cid:7188)点。
现在SR还向IPv6演进，这就是SRv6。它直接利用IPv6字段作为标签寻址。而前面介绍的在MPLS基础上的SR则称为SR-MPLS。
4.10软件定义网络SDN简介SDN的概念最初由斯坦福大学N.McKeown于2009年首先提出。当时还只是在学术界
进行探讨的一种新的网络体系结构。但随后几年发展很快，不少企业相继采用。其中最成功
的案例就是谷歌建于2010~2012年的数据中心网络B4。几年来网络B4运行的结果证明，基千SDN的专用广域网确实可以大大提高网络带宽利用率，网络运行更加稳定，管理更加高效简化，运行费用也明显降低了。目前，SDN已经引起人们的密切关注。
在本章开始的4.1.2(cid:7188)，我们初步介绍了网络层数据层面和控制层面的基本概念。现在有关SDN的资料已相当丰富。限千篇幅，下面我们只(cid:7126)对SDN进行简单的介绍。
我们知道，在SDN中，数据层面中的交换机是由控制层面进行控制的，图4-70表明这
种控制是通过协议OpenFlow来实现的。协议OpenFlow是一个得到高度认可的标准，在讨
论SDN时往往与OpenFlow一起讨论。因此，有人会误认为SDN就是OpenFlow。其实这
二者有着很大的区别。SDN不是协议，更不是一种产品。SDN是一个体系结构，是一种设
计、构建和管理网络的新方法或新概念，其要点就是把网络的控制层面和数据层面分离，而让控制层面利用软件来控制数据层面中的许多设备。可以把协议OpenFlow看成是在SDN体系结构中控制层面和数据层面之间的通信接口，它使得控制层面的控制器可以对数据层面中的物理设备或虚拟设备，进行直接访问和操纵。这种控制在逻辑上是集中式的，是基千流的控制。
AP1AP2控制层面（网络操作系统）协议OpenFlow数据层面图4-70协议OpenFlow是控制层面和数据层面的接口协议OpenFlow1.0是2009年底发表的最早的版本，之后每年都进行更新，经过12次•194•更新，到2015年3月发布了版本1.5.1(283页），但目前较为成熟的是1.3版本。OpenFlow
的技术规范由开放网络基金会ONF(OpenNetwokingFoundation)负责制定。这是一个非营利
性的产业联盟，其任务是致力于SDN的发展和标准化。但请注意，SDN并未规定必须使用
OpenFlow,只不过是大部分SDN的产品采用了OpenFlow作为其控制层面与数据层面的接
口。
传统意义上的数据层面的任务就是根据转发表来转发分组。可以再把“转发“细分一
下。实际上这里有两个步骤。第一个步骤是＂匹配“，即查找转发表中的网络前缀，进行最
长前缀匹配。第二个步骤是“动作“，即把分组从指明的接口转发出去。这种“匹配＋动
作”的转发方式在SDN中得到了扩充，增加了新的内容，变成了广义的转发。这种广义的
转发使得“匹配＋动作“有了新的内容。
在SDN的广义转发中，“匹配“能够对不同层次（链路层、网络层、运输层）的首部
中的字段进行匹配，而“动作”则不仅是转发分组，而且可以把具有同样目的地址的分组从
不同的接口转发出去（为了负载均衡）。还可以重写IP首部（如同在NAT路由器中的地址
转换），或者可以人为地阻挡或丢弃一些分组（如同在防火墙中一样，见7.7.1节）。请注意，
这里为了讨论问题的方便，在讨论SDN的问题时，不管在哪一层传送的数据单元，都称为
分组。
这样，在SDN的广义转发中，这种完成“匹配＋动作”的设备，就不应当称为路由
器了，而是叫作“分组交换机”或“OpenFlow交换机”，或更简单些就称为“交换机”。这
种交换机并不局限在网络层工作（例如，可使用L2/L3交换机）。在SDN中，取代传统转发
表的是“流表”(flowtable)。因此，流表就是＂匹配＋动作”的转发表。
图4-71强调了一个重要概念：OpenFlow交换机中的流表是由远程控制器来管理的，而
远程控制器通过一个安全信道（见7.6.2节），使用OpenFlow协议来管理OpenFlow交换机
中的流表。这样，OpenFlow就有了双重意义。一方面，OpenFlow是SDN远程控制器与网
络设备之间的通信协议；另一方面，OpenFlow又是网络交换功能的逻辑结构的规约。我们
还应注意到，尽管网络设备可以由不同厂商来生产，同时也可以使用在不同类型的网络中，
但从SDN远程控制器看到的，则是统一的逻辑交换功能。
＿＿＿＿＿＿＿＿＿-OpenFlow协议网
络
设
备OpenFlow交换机SDN远程
控制器图4-71OpenFlow协议与OpenFlow交换机我们在4.5.1节介绍1Pv6首部的流标号时，曾初步地提到“流”的概念。在OpenFlow
的各种文档中都没有“流”的定义。其实从OpenFlow交换机的角度来看，一个流就是穿过
网络的一种分组序列，而在此序列中的分组都共享分组首部某些字段的值。例如，某个流可以是具有相同源IP地址和目的IP地址的所有分组。
图4-72给出了OpenFlow1.0版本的流表和分组的首部匹配字段（这是最简单的一个版
本，便于用来讲解工作原理）［KUR017]。每个OpenFlow交换机必须有一个或一个以上的
流表。每一个流表可以包括很多行，即多个流表项(flowentry)，它包括三个字段，即首部字•195•段值（又称为匹配字段）、计数器和动作。下面解释这三个字段的意思。
动作动作匹配
字段1入端口以太网VLANIPTCP/UDP1浒地址1目的地址1类型IID1仇先级1游地址1目的地址h加对服务类型丿五口1目的湍口
运输层一
•网络层链路层••瞿一图4-72OpenFlow1.0版本的流表和分组的首部匹配字段—首部字段值：这是一组字段，用来使入分组(incomingpacket)的对应首部与之相匹配，因此又称为匹配字段。匹配不上的分组就被丢弃，或发送到远程控制器做更多的处理。图
4-72所示的匹配字段有11个项目涉及三个层次的首部。这就是说，Openflow的匹配抽象与我们以前讲过的分层的原则明显不同。在Openflow交换机中，既可以处理链路层的帧，也可以处理网络层的IP分组和运输层的报文。
计数器：这是一组计数器，可包括已经与该表项匹配的分组数量，以及从该表项上次更新到现在经历的时间。
动作：这是一组动作，例如，当分组匹配某个流表项时把分组转发到指明的端口，或丢弃该分组，或把分组进行复制后再从多个端口转发出去，或重写分组的首部字段（第二、
三和四层的首部字段）。
为了更好地理解流表的匹配与动作，我们讨论下面几个例子[KUR017]。图4-73给出的简单网络有6台主机CH1~H6)，其IP地址标注在主机旁边，还有3台分组交换机(S1~S3)。每台交换机有4个端口（即接口，编号为1(cid:7170)4)。还有1台Openflow控制器来控制
这些分组交换机的＂匹配＋动作“
。
OpenFlow控制器10.3.0.610.3.0.5二
/HJl10.2.0.3H1--＼H2、l_＿lOlO2lOlOl简单转发的例子．个
图4-73OpenFlow"匹配＋动作～．七．网络“我们设定的转发规则是：来(cid:7151)凡或儿发往儿或儿的分i门都先从S3转发到S1,然后再从S1转发到S2,但不通过S3到S2的链路。根据这个转发规则，可以得出交换机S3的流表项是：•196•IP源地址＝10.3.*.*;IP目的地址＝10.2.*.*匹配动作转发(3)这里使用了通配符＊。例如，地址10.3.*．＊，表明这样的地址将匹配前16位为10.3的任何地址。”转发(3)"表明分组转发出去端口是交换机编号为3的端口。
交换机S1的流表项（这里和后面都省略了计数器字段）是：入端口＝I;IP源地址＝10.3.*.*;IP目的地址＝10.2**匹配和S3的流表项相比，这里多了“入端口＝l"。表明”匹配＂仅限于从编号l的端口进入交换机S1的分组。
交换机S2的流表项是：匹配IP源地址＝10.3.*.*;IP目的地址＝10.2.0.3IP源地址＝10.3.*.*;IP目的地址＝10.2.0.4动作转发(3)转发(4)负载均衡的例子在图4-73中，为了均衡链路S2-S1和链路S3-S的通信量，我们规定：凡是从H3发往主
机10.1.＊．＊的分组，其转发路径应为S2-S1。但凡是从儿发往主机10.1.＊．＊的分组，其转发路径应为S2-S3-S1。显然，采用基千IP目的地址的转发方法，是不(cid:7126)实现这种负载的均]衡的。但在本例中，只要在交换机S2的流表项中设置好合适的匹配项目即可。
交换机S2的流表项是：匹配入端口＝3;IP目的地址＝10.1.*.*入端口＝4;IP目的地址＝JO.I.**动作转发(2)转发(I)防火墙的例子假定我们在交换机S2中设置了防火墙，此防火墙的作用是仅仅接收来(cid:7151)与交换机S3相连的主机所发送的分组（不管是从哪一个端口进来的）。根据这样的规定可得出下列内容。
交换机S2的流表项是：匹配IP源地址＝10.3.*.*;IP目的地址＝10.2.0.3IP源地址＝10.3.*.*;IP目的地址＝I0.2.0.4动作转发(3)转发(4)虽然上面举出的例子非常简单，但已经可以看出这种广义转发的多样性和灵活性。广义转发的优点是显而易见的。
•197•下面通过图4-74简单介绍一下SDN的控制层面[KREN15][KUR017]。
网络控制应用程序l路由选择...接入控制
司
司[广
；控制面层l
'
，'
r
'
,
'N:，D}}一}．一．数据层面丿lll
』
l
l
l
l
l,
＇
j心知心
,
 ]S
网（络操，
＇控
作制
系器
统－}}＇叶，
勺
心
0
-l
l
lll
,
'，
＇：、
丿,l
l
」
,
'
，,_叩
穸
芯：
，、态sND告控I­
的换交八
，}机负载均衡,
''r,
,
',
＇
，了，＇
，
＇
，
＇）北向API南向API图4-74SON体系结构的构件从图4-74可以反映出SDN体系结构的四个关键特征：
基千流的转发。SDN控制的交换机分布在数据层面中，而分组的转发可以基于网络层、
运输层和链路层协议数据单元中的首部字段值进行。这和传统的路由器仅仅根据IP分组的
目的地址进行转发，有着很大的区别。SDN的转发规则都精确规定在交换机中的流表中。
所有交换机中的流表项，都是由SDN控制器进行计算、管理和安装的。
数据层面与控制层面分离。在许多英语文献中常使用“decouple"一词，相应的中文就
是“去耦＂。在传统的转发设备路由器中，其数据层面与控制层面都处在同一个设备中，因
此二者耦合得非常紧密。但在SDN中，则把这两个层面去耦合，使二者不在同一个设备中。
这点在图4-73中看得很清楚。数据层面有许多相对简单但快速的网络交换机。这些交换机
在其流表中执行“匹配＋动作”的规则。而控制层面则由若干服务器和相应的软件组成，
这些服务器和软件决定并管理这些交换机中的流表。
位千数据层面交换机之外的网络控制功能。SDN中的控制层面是用软件实现的，而且
软件是处在不同的机器上，并且可能还远离这些网络交换机。从图4-74可以看出，SDN控
制层面包含两个构件，一个是SDN控制器（也就是网络操作系统），另一个由若干个网络控
制应用程序组成。SDN控制器维护准确的网络状态信息（例如，远程链路、交换机和主机
的状态），把这些信息提供给运行在控制层面的各种控制应用程序，以及提供一些方法，使
得这些应用程序能够对底层的许多网络设备进行监视、编程和控制。需要注意的是，在图
4-73的SDN控制器中只画了一个服务器，但这只是强调在逻辑上是集中控制的。实际上，
在控制层面中总是使用多个分散的服务器协调地工作，以便实现可扩展性和高可用性。
可编程的网络。通过在控制层面的一些网络控制应用程序，使整个网络成为可编程的。
这些应用程序相当千SDN控制层面中的“大脑”,SDN控制器使用这些应用程序，在这些
网络设备中指明和控制数据层面。例如，路由选择网络控制应用程序能够确定在源点和终点之间的端到端路径（这需要执行某种算法，也需要使用由SDN控制器维护的节点状态和链
路状态信息）。网络应用程序还可以进行接入控制，即决定哪些分组在进入某个交换机时就
必须被阻挡住。此外，网络应用程序在转发分组时还可以执行负载均衡的措施。
从以上的简单例子可以看出，SDN把网络的许多功能都分散开了。数据层面的交换机、
SDN控制器以及许多网络控制应用程序，这些都可以是分开的实体，并且可以由不同的厂•198•商和机构来提供。这就和传统网络截然不同。在传统网络中，路由器或交换机是由单独的厂
商提供的，其控制层面和数据层面以及协议的实现，都是垂直集成在一个机器里面的。目前
出现的这种变化，有点像当初计算机的演变。早期的大型计算机，从硬件到软件以及应用程
序，都是由一个单独的厂家生产完成的。但后来演变到现在的个人电脑，其硬件机身、操作
系统以及上层的应用程序，可以由多个厂家分别生产和提供，这样的系统就变得更加开放，
其功能也更加丰富了。SDN也可能有这样的发展结果。
图4-74还给出了SDN控制器和下面数据层面的受控设备的通信接口，即南向API,以及SDN控制器和上面网络控制应用程序的接口，即北向API。
SDN控制器是最复杂的，它还可以划分为如图4-75所示的三个层次。
-------------------------D--－-－－－-－－－－－－－－－－－-－－－－－-－－－北向API到网络控制与网络控制应用程序的通信应用程序层的接口巨亘量］三．．．三霍卢言了；N
器lJ与数据层面中受控设备的通信通信层压．．．三／M／用/要/;////／/／／各／/:/／表／／换／3器口/用来／／／／：：／／述／／／／／／:／／理／•199•制应用程序把得到的网络事件进行通告，并采取相应的动作，例如，计算新的最低开销的路
径。这一层可以提供不同类型的API。例如，REST风格的API目前使用得较多。图中的
REST(REpresentationalStateTransfer)即表述性状态传递，是一种针对网络应用的设计和开
发方法[W-REST]。图中的Intent是对要进行的操作的一种抽象描述[W-INTENT]，可用它在
组件之间传递数据。
目前已经出现了一些开放源代码控制器，或简称为开源控制器(OpenSourceController),最有代表性的就是OpenDaylight和ONOS。这里就不再进行讨论了。
本章的重要概念••TCP/IP体系中的网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数
据报服务。网络层不提供服务质量的承诺，不保证分组交付的时限，所传送的分组
可能出错、丢失、重复和失序。进程之间通信的可靠性由运输层负责。
IP网是虚拟的，因为从网络层上看，IP网就是一个统一的、抽象的网络（实际上
是异构的）。
IP层抽象的互联网屏蔽了下层网络很复杂的细节，使我们能够使用统
一的、抽象的IP地址处理主机之间的通信问题。
•互联网上交付主机的方式有两种：在本网络上的直接交付（不经过路由器）和到其他网络的间接交付（经过至少一个路由器，但最后一次一定是直接交付）。
•一个IP地址在整个互联网范围内是唯一的。早期使用的是分类的IP地址，包括A
类、B类和C类地址（单播地址），以及D类地址（多播地址）。E类地址未使用。
•分类的IP地址由网络号字段（指明网络）和主机号字段（指明主机）组成。网络号字段最前面的类别位指明IP地址的类别。
•目前已广泛使用无分类域间路由选择CIDR记法把IP地址后面加上斜线”I"，斜
线后是前缀的位数。前缀（或网络前缀）指明网络，后缀指明主机。前缀相同的连
续的IP地址构成“CIDR地址块”。
••CIDR的32位地址掩码（或子网掩码）由一串l和一串0组成，其中1的个数是
前缀的长度。只要把IP地址和地址掩码按位进行AND运算，即可得出网络地址。
IP地址是一种分等级的地址结构。IP地址管理机构在分配IP地址时只分配网络前
缀（网络号），而主机号则由得到该网络前缀的单位自行分配。路由器仅根据目的
主机所连接的网络前缀（网络号）来转发分组。
IP地址标志一台主机（或路由器）和一条链路的接口。多归属主机同时连接到两
个或更多的网络上。这样的主机同时具有两个或更多的IP地址，其网络前缀必须
是不同的。由于一个路由器至少应当连接到两个网络，因此一个路由器至少应当有
两个不同的IP地址。
••按照互联网的观点，用转发器或网桥连接起来的若干个局域网仍为一个网络。所有
分配到网络前缀的网络（不管是范围很小的局域网，还是可能覆盖很大地理范围的广域网）都是平等的。
•MAC地址（即硬件地址或物理地址）是数据链路层和物理层使用的地址，而IP地
址是网络层和以上各层使用的地址，是一种逻辑地址（用软件实现的），在数据链
路层看不见数据报的IP地址。
IP数据报分为首部和数据两部分。首部的前一部分是固定长度，共20字节，是所••200•