2.IP数据报首部的可变部分IP数据报首部的可变部分就是一个选项字段c选项字段用来支持排错、测量以及安全
等措施，内容很丰富。此字段的长度可变，从1字节到40字节不等，取决千所选择的项
目。某些选项项目只需要l字节，它只包括1字节的选项代码。而有些选项需要多个字节，
这些选项一个个拼接起来，中间不需要有分隔符，最后用全0的填充字段补齐为4字节的
整数倍。
增加首部的可变部分是为了增加IP数据报的功能，但这同时也使得IP数据报的首部长
度成为可变的。这就增加了每一个路由器处理数据报的开销。实际上这些选项很少被使用。
很多路由器都个考虑IP首部的选项宁段，因此新的IP版本IPv6就把IP数据报的首部长度
做成固定的了。这里就不讨论这些选项的细节了。有兴趣的读者可参阅RFC791。
4.3IP层转发分组的过程4.3.1埜于终点的转发我们在图4-7中已经描述了分组在互联网中逐跳转发的概念。分组在互
联网上传送和转发是基于分组首部中的目的地址的，因此这种转发方式称为基千终点的转发。
视频讲解因此，分组每到达一个路由器，路由器就根据分组中的终点（目的地址）查找转发表，然后就得知下一跳应当到哪一个路由器。
但是，路由器中的转发表却不是按目的IP地址来直接查出下一跳路由器的。这是因为
互联网中的主机数目实在太大了。如果用目的地址直接查找转发表，那么这种结构的转发表就会非常庞大，使得查找过程非常之慢。这样的转发表也就没有实用价值了。因此必须想办法压缩转发表的大小。
我们知道，32位的IP地址是由两级组成的。前一部分是前缀，表示网络，后一部分表
示主机。所以司以把查找目的主机的方法变通一下，即不是直接查找目的主机，而是先查找
目的网络（网络前缀），在找到了目的网络之后，就把分组在这个网络上直接交付目的主机。
由千互联网上的网络数远远小千主机数，这样就可以大大压缩转发表的大小，加速分组在路由器中的转发。这就是基千终点的转发过程。
读者可能还会想到一个问题，就是分组首部中没有地方可以用来指明
“
，那么待转发的分组又怎样能够找到下一跳路由器呢？
的IP地址“下一跳路由器当路由器收到一个待转发的分组，在从转发表得出下一跳路由器的IP地址后，不是把
这个地址填入分组首部，而是送交数据链路层的网络接口软件。网络接口软件负责把下一跳
路由器的IP地址转换成MAC地址（必须使用ARP)，并将此MAC地址放在链路层的
MAC帧的首部，然后利用这个MAC地址传送到下一跳路由器的链路层，再取出MAC帧
的数据部分，交给网络层。由此可见，当发送一连串的分组时，上述的这种查找转发表、调
用ARP解析出MAC地址、把MAC地址写入MAC帧的首部等过程，都是必须做的（当然
都是由机器自动完成的）。
那么，能不能在转发表中不使用IP地址而直接使用MAC地址呢？不行。我们一定要弄清楚，使用抽象的IP地址，本来就是为了隐蔽各种底层网络的复杂性而便千分析和研究
问题，这样就不可避免地要付出些代价，例如在选择路由时多了一些开销。但反过来，如果•140•在转发表中直接使用MAC地址，那就会带来更多的麻烦，甚至无法找到对方的机器。
下面用具体例子来说明分组的转发过程。
【例4-2】图4-23中有三个子网通过两个路由器互连在一起。主机凡发送出一个分组，其目的地址是128.1.2.132。现在源主机是凡而目的主机是H2。试讨论分组怎样从源主机传
送到目的主机。
-＿－---
子网前缀凡',--
128.1.＇，,',/'128.I.2.192/26,'{:,、三-----己＼＄/，'＇｀部R1的分转发表詈卢扂N',
3，，
子网前缀128.1:3.64/26
，l281366'，尸＼=，
夺I凇L2130
R2、-----二1目的主机-------------------------－
128.1.2.132、、-----～｀～～、凡子网前缀
、
128.1.2.128/26
、
;
H2'l'图4-23源主机凡向目的地址儿发送分组【解】主机凡首先必须确定：目的主机是否连接在本网络上？如果是，那么问题很简单，就直接交付，根本不需要利用路由器；如果不是，就间接交付，把分组发送给连接在本网络上的路由器，以后要做的事情都由这个路由器来处理。
主机凡先把要发送的分组的目的地址和本网络N1的子网掩码按位进行AND运算，得出运算结果。如果运算结果等于本网络N1的前缀，就表明目的主机连接在本网络上；否则，
就必须把分组发送到路由器R1,由路由器凡完成后续的任务。
由千采用了CIDR记法，转发表中给出的都是网络前缀，而没有明显给出子网掩码。其实只要细心观察斜线后面的数字，就可知道相应的子网掩码。例如，／26的子网掩码就是点
分十进制的255.255.255.192。现在，要发送的分组的目的地址是128.1.2.132,本网络的掩码
是26个l，后面有6个0。如图4-24(a)所示，按位AND运算的结果是128.1.2.128,不等千本网络N1的前缀。这说明目的主机没有连接在本网络上。源主机凡必须把分组发送给路由器Rl，让路由器凡根据其转发表来处理这个分组。
(a)(b)128.目的主机IP地址.
10000000000000010000001010000100
128.1.2.192/26的掩码11111111111111111111111111000000
10000000000000010000001010000000
.按位AND运算
得出结果128.1322211.128/26128.目的主机IP地址.
10000000000000010000001010000100
128.1.2.128/26的掩码11111111111111111111111111000000
10000000000000010000001010000000
.按位AND运算
得出结果128.1322211..128/26图4-24目的地址和本网络的子网掩码按位进行AND运算•141•.路由器R1的部分转发表已在图4-23右上方给出了。转发表中第1列就是“前缀匹配”,这是因为查找转发表的过程就是寻找前缀匹配的过程。
现在先检查路由器民的转发表中的第1行。
源主机儿要发送的分组的目的地址是128.1.2.132。本网络128.1.2.192/26的前缀有26
位，因此本网络的掩码是26个l，后面是6个0。目的地址和子网掩码按位AND运算的结
果是128.1.2.128/26（见图4-24(a)）。很明显，AND运算结果与转发表第1行的前缀不匹配。
接着检查路由器民的转发表中的第2行。运算结果是128.1.2.128/26,如图4-24(b)所示。
这个结果和转发表第2行的前缀相匹配。因此按照转发表第2行指出的，在网络N2上进行
分组的直接交付（通过路由器R1的接口1)。这时路由器民调用ARP,解析出目的主机H2
的MAC地址，再封装成链路层的帧，直接交付连接在本网络N2上的目的主机H如果按照同样的方法，检查路由器R1的转发表中的第3行，不难得出不匹配的结果。
从以上例子可看出，查找转发表的过程就是逐行寻找前缀匹配的过程。我们再看下一扣个例子。
扫一扫4.3.2最长前缀匹配【例4-3】假定在图4-25的例子中，路由器凡收到一个目的地址为
128.1.24.1的分组，请给出分组的转发接口。请注意，公司B包含三个子网，但这些网络前缀并没有出现在路由器R的转发表中。这是因为公司
B采用了路由聚合，把三个子网的所有地址聚合为一个网络前缀128.1.24.0/22。
视频讲解公司B
128.1.25.0/24
28.1.26.0/24公司A
128.1.24.0/24前缀匹配路由器R舶128.l.24.0/22部分转发表[;:／:~4图4-25分组交给路由器民进行转发【解】我们把进入路由器凡的分组的目的地址分别和路由器凡的转发表第1行、第
2行子网掩码进行按位AND运算。运算结果都是＂匹配＂（建议读者自行验算一下）。那么，
哪一个结果是正确的呢？现在就来分析这个问题。
网络前缀128.1.24.0/22可以划分为4个更小的/24前缀（图4-26)。其中的一个前缀
128.1.24.0/24分配给公司A,另外3个前缀分配给公司B。公司B把得到的3个前缀聚
合成一个更大的前缀128.1.24.0/22,作为路由器R1的转发表中的一个项目。请注意，这
个前缀和原来的前缀在形式上是一样的，但实际的区别是很大的：在图4-26左边的网络
前缀中包含地址128.1.24.1,但公司B的聚合后的网络前缀则不包含这个地址。因此在本例
中，即分组应当从接口1转发到公司A。
那么为什么地址128.1.24.1不在公司B的聚合前缀128.1.24.0/22中，但匹配运算的结
中的项目128.1.24.0/22并未说明是由哪几个子网聚合果却是匹配呢？这是因为在转发
而成的。
表•142•地址128.1.24.1在其中
AE幻．24.0/2ih
五汀：24.0/2;懿旷'“公司网络前缀'.~··谓�,八，～＾＇｀＇，一一，｀＾＾｀＾矗八，＾＾＇，，—'B图4-26公司A和B分到的前缀4.1不在其中十分明显，进入路由器凡的分组的目的地址128.1.24.1处千公司A拥有的地址范围中，而不在公司B的地址范围内。分组应当通过接口1转发到公司A。
为了减少路由器R1中的项目数，公司B采用了地址聚合，把三个地址块聚合为一个地
址块128.1.24.0/22。这个聚合后得出的前缀和图中左边所示的前缀在形式上是一样的。这样
就导致图4-26所示的出现和两个网络前缀都匹配的现象。
我们可以注意到，现在公司B三个地址块得出的聚合地址块是128.1.24.0/22,但如果公
司B只分到两个地址块128.1.25.0/24和128.1.26.0/24,那么其聚合地址块仍然是
128.1.24.0/22。如果把公司A和公司B的地址块都聚合起来，得出的聚合地址块还是
128.1.24.0/22。这样的地址聚合可以发生在路由器R2中。
因此，在采用CIDR编址时，如果一个分组在转发表中可以找到多个匹配的前缀，那么
就应当选择前缀最长的一个作为匹配的前缀。这个原则称为最长前缀匹配(longestprefix
match)。网络前缀越长，其地址块就越小，因而路由就越具体(morespecific)。为了更加迅速
地查找转发表，可以按照前缀的长短，把前缀最长的排在第1行，然后按前缀长短的顺序往
下排列。用这种方法从第1行前缀最长的开始查找，只要检查到匹配的，就不必再继续往下
查找，可以立即结束查找。
实际的转发表有时还可能增加两种特殊的路由，就是主机路由和默认路由。
主机路由(hostroute)又叫作特定主机路由，这是对特定目的主机的IP地址专门指明的
一个路由。采用特定主机路由可使网络管理人员更方便地控制网络和测试网络，同时也可在
需要考虑某种安全问题时采用这种特定主机路由。在对网络的连接或转发表进行排错时，指
明到某一台主机的特殊路由就十分有用。假定这个特定主机的点分十进制IP地址是a.b.c.d,
那么在转发表中对应于主机路由的网络前缀就是a.b.c.d/32。我们知道，／32表示的子网掩码
是32个1。实际的网络不可能使用32位的前缀，因为没有主机号的IP地址是没有实际意
义的。但这个特殊的前缀却可以用在转发表中。不难看出，32个l的子网掩码和IP地址
a.b.c.d按位进行AND运算后，得出的结果必定是a.b.c.d,也就是说，找到了匹配。这时就
把收到的分组转发到转发表所指出的下一跳。主机路由在转发表中都放在最前面。
还有一种特殊路由是默认路由(defaultroute)。这就是不管分组的最终目的网络在哪里，都由指定的路由器R来处理。这在网络只有很少的对外连接时非常有用。在实际的转发表
中，用一个特殊前缀0.0.0.0/0来表示默认路由。这个前缀的掩码是全0(/0表示网络前缀是
0位，因此掩码是32个0)。用全0的掩码和任何目的地址进行按位AND运算，结果一定是全O,即必然是和转发表中的0.0.0.0/0相匹配的。这时就按照转发表的指示，把分组送交下一跳路由器R来处理（即间接交付）。
综上所述，可归纳出分组转发算法如下（假定转发表按照前缀的长短排列，把前缀长的放在前面）：•143•(1)从收到的分组的首部提取目的主机的IP地址D（即目的地址）。
(2)若查找到有特定主机路由（目的地址为D)，就按照这条路由的下一跳转发分组；否则从转发表中下一行（也就是前缀最长的一行）开始检查，执行(3)。
(3)把这一行的子网掩码与目的地址D按位进行AND运算。
若运算结果与本行的前缀匹配，则查找结束，按照下一跳”“所指出的进行处理（或直接交付本网络上的目的主机，或通过指定接口发送到下一跳路由器）。
否则，若转发表还有下一行，则对下一行进行检查，重新执行(3)。
否则，执行(4)。
(4)若转发表中有一个默认路由，则按照指明的接口，把分组传送到指明的默认路由器；否则，报告转发分组出错。
可以用一个简单的比喻来说明查找转发表和转发分组的过程。例如，从家门口开车到
机场，但没有地图，不知道应当走哪条路线。好在每一个道路岔口都有一个警察可以询问。
”（相
因此，每到一个岔口（相当于到了一个路由器），就问：”到机场应当朝哪个方向走？
当于查找转发表）。该警察并不告诉你去机场的详细路径。他仅仅指出到机场途经的下一个
警察位置的方向。其回答可(cid:7126)是：
回答可(cid:7126)是：“直行。”这样，每到一个岔口，就询问下一步走的方向。这样，在没有地图的
情况下，我们最终也可以到达目的地机场。
“向左转方向走。”你左转到了下一个岔口，再询问警察，顺便指出，在过去使用分类地址时，不存在最长前缀匹配的问题。在转发表中，不会出现目的地址和转发表中的两行或两行以上的网络地址匹配的情况。
4.3.3使用二叉线索查找转发表使用CIDR后，由千不知道目的网络的前缀，使转发表的查找过程变得更加复杂了。
当转发表的项目数很大时，怎样设法缩短转发表的查找时间就成为一个非常重要的问题。
例如，连接路由器的线路的速率为10Gbit/s,而分组的平均长度为2000bit,那么路由器
就应当平均每秒钟(cid:7126)够处理500万个分组（常记为5Mpps)。或者说，路由器处理一个分
C1ns=10-9s)。因此，查找每一个路由所需的时间是非常短的。
组的平均时间只有200ns
可见在转发表中必须使用很好的数据结构和先进的快速查找算法，这一直是人们积极研究
的热门课题。
对无分类编址的转发表的最简单的查找算法就是对所有可(cid:7126)的前缀进行循环查找，从
最长的前缀开始查找。例如，给定一个目的地址。对每一个可(cid:7126)的网络前缀，进行目的地址
和子网掩码的按位AND运算，得出一个网络前缀，然后逐行查找转发表中的网络前缀。所
找到的最长匹配就对应千要查找的路由。
这种最简单的算法的明显缺点就是查找的次数太多。最坏的情况是转发表中没有这个路由。在这种情况下，算法仍要进行32次（第1次用32位的前缀查找转发表中所有的行，
第2次用31位的前缀查找所有的行，这样一直查找下去）。
为了进行更加有效的查找，通常是把无分类编址的转发表存放在一种层次的数据结构
中，然后(cid:7149)上而下地按层次进行查找。这里最常用的就是二叉线索(binarytrie)CD,它是一种印注：线索(trie)来自rerrieval（检索），读音与“try"相同。
•144•特殊结构的树。IP地址中从左到右的比特值决定了从根(cid:7188)点逐层向下层延伸的路径，而二叉线索中的各个路径就代表转发表中存放的各个地址。
图4-27用一个例子来说明二叉线索的结构。图中给出了5个IP地址。为了简化二叉线
索的结构，可以先找出对应千每一个IP地址的唯—前缀(uniqueprefix)。所谓唯一前缀就是
在表中所有的IP地址中，该前缀是唯一的。这样就可以用这些唯一前缀来构造二叉线索。
在进行查找时，只要(cid:7126)够和唯一前缀相匹配就行了。
32位的IP地址唯前缀0I000110000000000000000000000000
010IO110000000000000000000000000
0II00001000000000000000000000000
10110000000000100000000000000000101110110000IOIO0000000000000000一
0I000101
0IIlO110
IO11I图4-27用5个前缀构成的二叉线索从二叉线索的根(cid:7188)点(cid:7150)顶向下的深度最多有32层，每一层对应千IP地址中的一位。一
个IP地址存入二叉线索的规则很简单：先检查IP地址左边的第一位，如为0,则第一层的(cid:7188)点就在根(cid:7188)点的左下方；如为1,则在右下方。然后再检查地址的第二位，构造出第二层
的(cid:7189)点。依此类推，直到唯一前缀的最后一位。由千唯一前缀一(cid:7182)都小于32位，因此用唯－前缀构造的二叉线索的深度往往不到32层。图中较粗的折线就是前缀0101在这个二叉线索中的路径。二叉线索中的小圆刚是中间(cid:7190)点，而在路径终点的小方框是叶(cid:7188)点（也叫作外
部(cid:7188)点）。每个叶(cid:7191)点代表一个唯一前缀。(cid:7188)点之间的连线旁边的数字表示这条边在唯一前
缀中对应的比特是0或1。
假定有一个IP地址是10011010110100000000000000000,需要查找该地址是否在此二叉线索中。我们从最左边查起。很容易发现，查到第三个字符（即前缀10后面的0)时，在二叉线索中就找不到匹配的，说明这个地址不在这个二叉线索中。
以上只是给出了二叉线索这种数据结构的用法，而并没有说明”与唯一前缀匹配”和
”与网络前缀匹配＂的关系。显然，要将二叉线索用千转发表中，还必须使二叉线索中的每
一个叶(cid:7188)点包含所对应的网络前缀和千网掩砃。当搜索到一个叶(cid:7188)点时，就必须将寻找匹配的目的地址和该叶(cid:7192)点的子网掩码进行按位AND运算，看结果是否与对应的网络前缀相匹
配。若匹配，就按下一跳的接口转发该分组。否则，就丢弃该分组。
总之，二叉线索只是提供了一种可以快速在转发表中找到匹配的叶(cid:7193)点的机制。但这是否和网络前缀匹配，还要和子网掩码进行一次逻辑AND运算。
为了提高二叉线索的查找速度，广泛使用了各种压缩技术。例如，在图4-27中的最后两个地址，其最前面的4位都是1011。因此，只要一个地址的前4位是1011,就可以跳过前面4位（即压缩了4个层次）而直接从第5位开始比较。这样就可以减少查找的时间。当
然，制作经过压缩的二叉线索需要更多的计算，但由千每一次查找转发表时都可以提高查找速度，因此这样做还是值得的。
•145•1
1
1
