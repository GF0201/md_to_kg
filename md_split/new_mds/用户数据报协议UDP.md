号，这个数目对一个计算机来说是足够用的。
由此可见，两个计算机中的进程要互相通信，不仅必须知道对方的IP地址（为了找到
对方的计算机），而且要知道对方的端口号（为了找到对方计算机中的应用进程）。这和我
们寄信的过程类似。当我们要给某人写信时，就必须在信封上写明他的通信地址（这是为
了找到他的住所，相当于IP地址），并且还要写上收件人的姓名（这是因为在同一住所中可
能有好几个人，这相当千端口号）。在信封上还应写明自己的地址和姓名。当收信人回信时，
很容易在信封上找到发信人的地址和姓名。互联网上的计算机通信是采用客户－服务器方式。
客户在发起通信请求时，必须先知道对方服务器的IP地址（用来找到目的主机）和端口号
（用来找到目的进程）。因此运输层的端口号分为下面的两大类。
(1)服务器端使用的端口号这里又分为两类，最重要的一类叫作熟知端口号(well-
knownportnumber)或全球通用端口号，数值为0~1023。这些熟知端口号最初公布在文档中
[RFC1700,STD2]，但后来因为互联网发展太快，这种标准文档无法随时更新，因此在RFC
3232中就把RFC1700列为陈旧的，而当前最新的熟知端口号可在网址www.iana.org上查到。
IANA把这些熟知端口号指派给了TCP/IP最重要的一些应用程序，让所有的用户都知道。
当一种新的应用程序出现后，IANA必须为它指派一个熟知端口，否则互联网上的其他应用
进程就无法和它进行通信。和电话通信对比，熟知端口号相当千所有人都应知晓的重要电话
号码，如报警电话110,急救电话120等。
5-2给出了一些常用的熟知端口号。
表表5-2常用的熟知端口号应用程序IFTPITELNETISMTPIDNSITFTPIHTTPISNMPISNMP(trap)IHTTPS熟知端口号I212325536980161162443另一类叫作登记端口号，数值为1024~49151。这类端口号是为没有熟知端口号的应用程序使用的。要使用这类端口号必须在IANA按照规定的手续登记，以防止重复。
(2)客户端使用的端口号数值为49152~65535。由于这类端口号仅在客户进程运行
时才动态选择，因此又叫作短暂端口号＠。这类端口号就是临时端口号，留给客户进程选择
临时使用。当服务器进程收到客户进程的报文时，就知道了客户进程所使用的端口号，因而
可以把数据发送给客户进程。通信结束后，刚才已使用过的客户端口号就被系统收回，以便
给其他客户进程使用。
下面将分别讨论UDP和TCP。UDP比较简单，本章主要讨论TCP。
用户数据报协议5.2UDP5.2.1UDP概述用户数据报协议UDP只在IP的数据报服务之上增加了很少一点的功能，这就是复用和分用的功能以及差错检测的功能。UDP的主要特点是：视频讲解CD注：短暂端口(ephemeralport)[STEY94,p.13]表示这种端口的存在时间是短期的。客户进程并不在意操作系统给它分配的是哪个端口号，因为客户进程之所以必须有个瑞口号（在本地主机中必须是唯的），是为了让运输层的实体能够找到自己。
这和熟知端口不同。服务器机器接通电源，服务器程序就运行起来。为了让互联网上所有的客户程序都能找到服务器程序，服一一务器程序所使用的端口（即熟知端口）就必须是固定的，并且是众所周知的。
一一•215•(1)UDP是无连接的，即发送数据之前不需要建立连接（当然，发送数据结束时也没有连接可释放），因此减少了开销和发送数据之前的时延。
(2)UDP使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的连接状态表（这里面有许多参数）。
(3)UDP是面向报文的。发送方的UDP对应用程序交下来的报文，在添加首部后就向
下交付IP层。UDP对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边
界。这就是说，应用层交给UDP多长的报文，UDP就照样发送，即一次发送一个报文，如
图5-3所示。在接收方的UDP,对IP层交上来的UDP用户数据报，在去除首部后就原封不
动地交付上层的应用进程。也就是说，UDP一次交付一个完整的报文。因此，应用程序必
须选择合适大小的报文。若报文太长，UDP把它交给IP层后，IP层在传送时可能要进行分
片，这会降低IP层的效率。反之，若报文太短，UDP把它交给IP层后，会使IP数据报的
首部的相对长度太大，这也降低了IP层的效率。
应用层运输层IP首部JP数据报的数据部分IP层图5-3UDP是面向报文的(4)UDP没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。这对某些
实时应用是很重要的。很多的实时应用（如IP电话、实时视频会议等）要求源主机以恒定
的速率发送数据，并且允许在网络发生拥塞时丢失一些数据，但却不允许数据有太大的时延。
UDP正好适合这种要求。
(5)UDP支持一对一、一对多、多对一和多对多的交互通信。
(6)UDP的首部开销小，只有8个字节，比TCP的20个字节的首部要短。
下面举例说明UDP的通信和端口号的关系（如图5-4所示）。主机儿中有三个应用进
程分别要和主机H2中的两个应用进程进行通信。通信双方的关系是：P]一凡，P2-P4,P3-P50
主机凡的操作系统为这三个进程分别指派了端口，其端口号分别为a,b和c。图中位于应
用层和运输层之间的小方框代表端口。在端口小方框中间还画有队列，表示端口具有缓存的
功能，可以把收到的数据暂时存储一下。有时也可以把队列画成双向的，即分别表示存放来
自应用层或运输层的数据。现在假定主机凡中的进程已经知道了对方进程凡和P5的端口
号分别为x和y,于是在主机凡的运输层就可以组装成需要发送的UDP用户数据报，其中
最重要的地址信息（源端口，目的端口）分别是(a,x),(b,x)和(c,y)。在图5-4中把运输层以下
的都省略了。因此，进程之间的通信现在可以看成是两个端口之间的通信。
图中在两个运输层之间有一条虚线，表示在两个运输层之间可以进行通信，而不是一
条连接。但这种通信是不可靠的通信，即所发送的报文在传输过程中有可能丢失，同时也不
保证报文都能按照发送的先后顺序到达终点。这正是UDP通信的特点：简单方便，但不可
靠。如果想要得到可靠的运输层通信，那就要使用后面要介绍的TCP进行通信。请注意，
在两个运输层的UDP之间并没有建立连接。
•216•应用进程运输层复用分用不可靠的信道a�x
=〉b�x
...c--;::::y
工请注意：运输层之间的这条虚线不是条连接图5-4UDP的通信和端口号的关系一应用层端口运输层图5-4的例子画出了多对一的通信（a-x,b-x)。如果改成a-x,a-y,则是一对多的情况了。
主机H1中的3个应用进程，把用户数据通过各(cid:7149)的端口传送到了运输层后，就共用一
个网络层协议，把收到的UDP用户数据报组装成不同的IP数据报，发送到互(cid:7110)网。这就是UDP的复用功(cid:7126)。主机H2的网络层收到3个IP数据报后，提取出数据部分（即UDP用户数据报），然后根据其首部中的目的端口号，分别传送到相应的端口，以便上层的应用进程到端口读取数据。这就是UDP的分用功(cid:7126)。
虽然某些实时应用需要使用没有拥塞控制的UDP,但当很多的源主机同时都向网络发送高速率的实时视频流时，网络就有可(cid:7126)发生拥塞，结果大家都无法正常接收。因此，不使用拥塞控制功(cid:7126)的UDP有可(cid:7126)会引起网络产生严重的拥塞问题。
还有一些使用UDP的实时应用，需要对UDP的不可靠的传输进行适当的改进，以减
少数据的丢失。在这种情况下，应用进程本身可以在不影响应用的实时性的前提下，增加一
些提高可靠性的措施，如采用前向纠错或重传已丢失的报文。
5.2.2UDP的首部格式用户数据报UDP有两个字段：数据字段和首部字段。首部字段很简单，只有8个字(cid:7194)（如图5-5所示），由4个字段组成，每个字段的长度都是2字(cid:7195)。各字段意义如下：(1)源端口
(2)目的端口
(3)长度
(4)检验和源端口号。在需要对方回信时选用。不需要时可用全0。
目的端口号。这在终点交付报文时必须使用。
UDP用户数据报的长度，其最小值是8（仅有首部）。
检测UDP用户数据报在传输中是否有错。有错就丢弃。
44II2字节··勿_＿--－--－－－－竺2
--22，
俨一一一一一一
1伪首部
•-------1IP首部图5-5UDP用户数据报的首部和伪首部•217•如果接收方UDP发现收到的报文中的目的端口号不正确（即不存在对应于该端口号的
”差错报文给
讨论traceroute时，就是让发送的UDP应用进程），就丢弃该报文，并由网际控制报文协议ICMP发送“端口不可达
发送方。我们在上一章4.4.2(cid:7188)
用户数据报故意使用一个非法的UDP端口，结果ICMP就返回
因而达到了测试的目的。
“端口不可达＂差错报文，”ICMP的应用举例＂UDP用户数据报首部中检验和的计算方法有些特殊。在计算检验和时，要在UDP用户
”是因为这种伪首部并不是UDP用户数
数据报之前增加12个字(cid:7188)的伪首部。所谓“伪首部
据报真正的首部。只是在计算检验和时，临时添加在UDP用户数据报前面，得到一个临时
的UDP用户数据报。检验和就是按照这个临时的UDP用户数据报来计算的。伪首部既不向
下传送也不向上递交，而仅仅是为了计算检验和。图5-5的最上面给出了伪首部各字段的内容。
UDP计算检验和的方法和计算IP数据报首部检验和的方法相似。但不同的是：IP数据报的检验和只检验IP数据报的首部，但UDP的检验和是把首部和数据部分—起都检验。在发送方，首先是先把全零放入检验和字段。再把伪首部以及UDP用户数据报看成是由许多
16位的字串接起来的。若UDP用户数据报的数据部分不是偶数个字(cid:7188)，则要填入一个全零
字(cid:7188)（但此字(cid:7194)不发送）。然后按二进制反码计算出这些16位字的和。将此和的二进制反码写入检验和字段后，就发送这样的UDP用户数据报。在接收方，把收到的UDP用户数据报
连同伪首部（以及可(cid:7126)的填充全零字(cid:7194)）一起，按二进制反码求这些16位字的和。当无差
错时其结果应为全l。否则就表明有差错出现，接收方就应丢弃这个UDP用户数据报（也
可以上交给应用层，但附上出现了差错的警告）。图5-6给出了一个计算UDP检验和的例子。
这里假定用户数据报的长度是15字(cid:7188)，因此要添加一个全0的字(cid:7188)。读者可以(cid:7151)己检验一
下在接收端是怎样对检验和进行检验的。不难看出，这种简单的差错检验方法的检错(cid:7126)力并不强，但它的好处是简单，处理起来较快。
153.19.8.104字12伪部节u节字首
首o171
I17全,4L尸』10878部D
字p
节74;T据数15.3.14.111513全0数据1数据数据1数据
o数据1数据数据匡填充.3一171I00II00I000I00II---I53.I9
0000100001I01000---8.104
IOIOIO11000000II
0000111000001011---14.11
00000000000I0001---0禾廿17
000000000000I11I---15
0000010000111II1-
000000000000110I---13
0000000000001I11---15
0000000000000000---0（检验和）
010IOI000I000lOI---数据
010100I101010I00---数据
0100I00IO1001IIO---数据
0100011100000000---数据和0（填充）1087今按二进制反码运算求和I00IO11011IOIIO1---求和得出的结果将得出的结果求反码0110100100010010---检验和图5-6计算UDP检验和的例子如图5-6所示，伪首部的第3字段是全零；第4字段是IP首部中的协议字段的值。以前曾讲过，对千UDP,此协议字段值为17;第5字段是UDP用户数据报的长度。因此，这样的检验和，既检查了UDP用户数据报的源端口号和目的端口号以及UDP用户数据报的数据部分，又检查了IP数据报的源IP地址和目的地址。
•218•5.3传输控制协议TCP概述由千TCP协议比较复杂，因此本(cid:7188)先对TCP协议进行一(cid:7184)的介绍，然后再逐步深入讨论TCP的可靠传输、流量控制和拥塞控制等问题。
5.3.1TCP扫--扫视频讲解最主要的特点TCP是TCP/IP体系中非常复杂的一个协议。下面介绍TCP最主要的特点。
()TCP是面向连接的运输层协议。这就是说，应用程序在使用TCP协议之前，必须先
建立TCP连接。在传送数据完毕后，必须释放已经建立的TCP连接。也就是说，应用进程
之间的通信好像在：通话前要先拨号建立连接，通话结束后要挂机释放连接。
“打电话”(2)每一条TCP连接只(cid:7126)有两个端点(endpoint)，每一条TCP连接只(cid:7126)是点对点的（一对一）。这个问题后面还要进一步讨论。
(3)TCP提供可靠交付的服务。通过TCP连接传送的数据，无差错、不丢失、不重复，并且按序到达。
(4)TCP提供全双工通信。TCP允许通信双方的应用进程在任何时候都(cid:7126)发送数据。
TCP连接的两端都设有发送级存和接收缓存，用来临时存放双向通信的数据。在发送时，
应用程序在把数据传送给TCP的缓存后，就可以做(cid:7151)己的事，而TCP在合适的时候把数据
发送出去。在接收时，TCP把收到的数据放入缓存，上层的应用进程在合适的时候读取缓
存中的数据。
“面向字(cid:7188)流(5)面向字(cid:7195)流。TCP中的“流”(stream)指的是流入到进程或从进程流出的字(cid:7195)序列。
”的含义是：虽然应用程序和TCP的交互是一次一个数据块（大小不等），但
TCP把应用程序交下来的数据仅仅看成是一连串的无结构的字(cid:7195)流。TCP并不知道所传送的
字(cid:7188)流的含义。TCP不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据
块具有对应大小的关系（例如，发送方应用程序交给发送方的TCP共10个数据块，但接收
方的TCP可(cid:7126)只用了4个数据块就把收到的字(cid:7188)流交付上层的应用程序）。但接收方应用程
序收到的字(cid:7188)流必须和发送方应用程序发出的字(cid:7188)流完全一样。当然，接收方的应用程序必
须有(cid:7126)力识别收到的字(cid:7188)流，把它还原成有意义的应用层数据。图5-7是上述概念的示意图。
送方发匾应用进程字节流回表示TCP报文段的首部曰表示序号为x的数据字节＿0－流节字＿l_2一3一TCP连接像条管道，把字节流可靠地按序送到目的进程一图5-7TCP面向字节流的概念传•219•1