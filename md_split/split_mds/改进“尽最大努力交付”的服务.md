### 分块 1
｀被叫方SIP代理
服务器主叫方INVITEOKACK-ISIP登记器圣itINVITEOKACK查找回答电话交谈
BYE图8-17跟踪被叫方的机制如果被叫没有在这个SIP登记器进行过登记，那么这个SIP登记器就发回重定向报(cid:4825)，指示SIP代理服务器向另一个SIP登记器重(cid:4842)进行DNS查询，直到找到被叫为止。图8-17给出了这种情况下主叫(cid:4851)发出确认之前的呼叫过程。
SIP还有一个配套协议是会话描述协议SDP(SessionDescriptionProtocol)。SDP在电话会议的情况下特别重要，因为电话会议的参加者应当能够动态地加入和退出。SDP详细地指明了媒体编码、协议的端口号以及多播地址。SDP现在也是互联网建议标准[RFC8866]。
由于SIP问世较晚，因此它现在比H.323占有的市场份额要小。对今后作为IETF标准的SIP协议的进展情况应当引起我们的注意。

### 分块 2
8.4改进“尽最大努力交付＂的服务使互联网更好地传送多媒体信息的另一种(cid:4851)法，是改变互联网平等对待所有分组的思想，使得对时延有较严格要求的实时音频／视频分组，能够从网络得到更好的服务质量QoS。
下面我们先介绍提供服务质量的一般(cid:4852)法。
8.4.1使互联网提供服务质量根据ITU-T在建议书E.800中给出的定义，服务质量QoS是服务性能的总效果，此效
果决定了一个用户对服务的满意程度。因此在最简单的意义上，有服务质量的服务就是能够
满足用户的应用需求的服务，或者说，可提供致的、可预计的数据交付服务。
一在涉及一些具体问题时，服务质量可用若干基本的性能指标来描述，包括可用性、差错率、响应时间、吞吐量、分组丢失率、连接建立时间、故障检测和改正时间等。服务提供者可向其用户保证某一种等级的服务质晕。
我们已多次强调过，互联网的网络本身只能提供“＂

### 分块 3
我们已多次强调过，互联网的网络本身只能提供“＂
尽最大努力交付的服务。而要传送多媒体信息，网络又必须具有一定的服务质量。下面通过图8-18的例子说明应从哪些(cid:4851)面入手使互联网具有一定的服务质量[KUR017]。图中表示局域网上的两台主机凡和H2通•390•过非常简单的网络（路由器R1和民以及连接它们的链路）分别向远地另外两台主机压和
儿发送数据。连接R1和民的链路带宽是1.5Mbit/s。现在考虑以下四种情况。
1.5Mbit/s链路H2H4}；：：：：二三二MbIt/s链路输出队列图8-18主机H1和H2分别向主机H3和儿发送数据(1)一个1Mbit/s的实时音频数据和一个FTP文件数据
假定凡向儿传送1Mbit/s的实时音频数据，而压向儿传送低优先级的FTP文件数据。
两台主机发送的数据都在路由器凡的输出队列中排队。若突然有一个很大的FTP数据块来
到R1,就会把输出队列全部占满。后面到达路由器R1的实时音频分组就会被丢弃。显然这
是不合理的。因此需要增加一个机制，就是给不同性质的分组打上不同的标记。这样当H1

### 分块 4
是不合理的。因此需要增加一个机制，就是给不同性质的分组打上不同的标记。这样当H1
和压的分组进入路由器凡时，凡就能够识别凡的实时数据分组，并使这些分组以高优先
级进入输出队列，而仅在队列有多余空间时才准许低优先级的FTP的数据分组进入。
(2)一个1Mbit/s的实时音频数据和一个高优先级的FTP文件数据
假定FTP的用户用高价从ISP处购买了高优先级服务，而实时音频的用户只购买了低
优先级服务。因此，仅根据分组自己的标记来确定其服务等级还不够合理。可见应当使路由
器增加一种机制
分类(classification)，即路由器根据某些准则（例如，根据发送数据的地
址）对输入分组进行分类，然后对不同类别的通信量给予不同的优先级。
(3)一个数据率异常的实时音频数据和一个FTP文件数据
假定上述的主机儿的数据率突然不正常地增大到1.5Mbit/s或更高（这可能是出了故
障或恶意破坏网络的正常运行），那么就会使主机儿的FTP的低优先级数据无法通过路山
器R1
流不要影响其他正常的数据流在网络中通过。例如，可以将凡的数据率限定为1Mbit/s。

### 分块 5
器R1
流不要影响其他正常的数据流在网络中通过。例如，可以将凡的数据率限定为1Mbit/s。
路由器民不停地监视凡的数据率。只要儿的数据率超过规定的1Mbit/s,路由器民就把
其中的某些分组丢弃，使其数据率不超过原来设定的门限。
。因此，应当使路由器能够对某个数据流进行通信量的管制(policing)，使得这个数据为了更加合理地利用网络资源，应在路由器中再增加一种机制—一调度(scheduling)。
我们可以利用调度功能给实时音频和文件传送这两个应用分别分配1Mbit/s和0.5Mbit/s的
带宽。这就好像在带宽为1.5Mbit/s的链路中划分出两个逻辑链路，其带宽分别为1Mbit/s
和0.5Mbit/s,因而对这两种应用都有相应的服务质量保证。
(4)H冲DH2都发送数据率为1Mbit/s的实时数据
在这种情况下，到达路由器民的总数据率是2Mbit/s,已超过了1.5Mbit/s链路的带宽。
若使这两台主机发出的数据流平等地共享1.5Mbit/s链路的带宽，则每个数据流平均将丢失
25％的分组，因而都变得没有用了。比较合理的做法是让一个数据流通过1.5Mbit/s的链路，

### 分块 6
25％的分组，因而都变得没有用了。比较合理的做法是让一个数据流通过1.5Mbit/s的链路，
而阻止另一个数据流的通过。这就需要另一种机制－——呼叫接纳(calladmission)
。这里借用
了电话网的术语，进一步的讨论见后面的8.4.3节。在使用呼叫接纳机制时，一个数据流要
预先声明它所需的服务质量，然后或者被准许进入网络（能得到所需的服务质量），或者被•391•拒绝进入网络（当所需的服务质量不能得到满足时）。
上面简单地说明了为使互联网能够提供一定的服务质量，应当设法增加一些机制，即：分组的类别、管制、调度以及呼叫接纳。在后面的几节我们将陆续讨论这些问题。
8.4.2调度和管制机制调度和管制机制是使互联网能够提供服务质量的重要措施[STALlO]。下面先讨论调度机制。
1.调度机制这里所说的“调度”就是指排队的规则。如果不采用专门的调度机制，那么在路由器
的队列采用的默认排队规则就是先进先出FIFO(FirstInFirstOut)。当队列已满时，后到达
的分组就被丢弃。先进先出的最大缺点就是不能区分时间敏感分组和一般数据分组，并且也

### 分块 7
的分组就被丢弃。先进先出的最大缺点就是不能区分时间敏感分组和一般数据分组，并且也
不公平，因为这使得排在长分组后面的短分组要等待很长的时间。就像在机场办理登机卡时，
正巧排在你前面的一个人代表20个人的团队来办理登机卡，这时你只能耐心等待。
在先进先出的基础上增加按优先级排队，就能使优先级高的分组优先得到服务。图8-19
是按优先级排队的例子。图中假定优先级分为两种，因此有两个队列：高优先级队列和低优
先级队列。
路由器1|||高优先级队列分组离开路山器分类＼三勹勹丿门／I调度'｀｀、）,l,＇，＇,'，lll,lllllll,llll,llll,'ll,llll,'，lllll,'lll,＇llllllllllll,llllllll,l,l,'l,lllll,lllllllll,ll，咖llllllll,lllllll,l,＇，l分组到达氐低优先级队列忖卢-------------------,------------------'？？
5高3；接受服务厅勹巨5巨

### 分块 8
5高3；接受服务厅勹巨5巨
分组离开心心卢心卢►t-_·___-------_·_---r------------------,-------------------r---►t图8-19按优先级排队的例子假定分组的到达是按照编号从小到大的顺序。在到达路由器后就由分类器（又称为分
类程序）对其进行优先级分类，然后按照类别进入相应的队列。图中的圆圈表示调度，其作
用是从队列中取走排在队首的分组。“调度”相当千排队论中的服务员。只要高优先级队列
中有分组在内，就从高优先级队列中按照链路速率取出排在队首的分组。只有当高优先级队
列已空时，才能轮到低优先级队列中的分组输出到链路上。在图8-19的下方给出三个高优
先级的分组（灰色方块）与两个低优先级的分组（臼色方块）交替地到达路由器。但在分组
离开路由器时，高优先级的分组3和5都提前得到服务。请注意，低优先级的分组2仍然比
高优先级的分组5先得到服务。这是因为在分组2得到服务时，分组5还没有到达路由器。
当高优先级的分组5到达时，路由器正在发送分组2,因此分组5必须等待分组2离开路由
器后才能得到服务。

### 分块 9
器后才能得到服务。
•392•简单地按优先级排队会带来一个缺点，这就是在高优先级队列中总是有分组时，低优先级队列中的分组就长期得不到服务。这就不太公平。公平排队FQ(FairQueuing)可解决这
一一一一问题。公平排队是对每种类别的分组流设置个队列，然后轮流使每个队列次只能发一送个分组。对于空的队列就跳过去。但公平排队也有不公平的地(cid:4851)，这就是长分组得到的服务时间长，而短分组就比较吃亏，并且公平排队并没有区分分组的优先级。
为了使高优先级队列中的分组有更多的机会得到服务，可增加队列“权重”的概念，这就是加权公平排队WFQ(WeightedFairQueuing)，其工作原理如图8-20所示。

### 分块 10
厂门叮1V1路由器分类器图8-20加权公平排队WFQ加权公平排队WFQ是这样工作的：分组到达后就进行分类，然后送交与其类别对应的队列（图中假定分为三类）。三个队列按顺序依次把队首的分组发送到链路。遇到队列空就跳过去。但根据各类别的优先级不同，每种队列分配到的服务时间也不同。可以给队列i指一派个权重Wi。于是队列l得到的平均服务时间为Wi/（邑w丿），这里Iw丿是对所有的非空队列的权重求和。这样，若路由器输出链路的数据率（即带宽）为R,那么队列i将得到的有保证的数据率凡应为RI.=Rxw/
LW
丿(8-1)加权公平排队WFQ在服务质量体系结构中占有重要的地位。当前的许多路由器产品都加入了WFQ调度的功能。为了更好地理解WFQ的概念，图8-21给出了一个简单的例子，并把先进先出FIFO的情况也同时画出。我们假定在WFQ的情况下，分配给分组流l的权
半），而分配给其他10个分组流的权重都重是0.5（即得到服务的时间占总的服务时间的一各为0.05。这样，分组流2~11共10个分组流合起来的权重也是0.5。
一
一

### 分块 11
一
一
个队列，因此每个分组流的第在使用先进先出规则时，只有个分组共11个分组排在队首。在图8-21(a)和(b)两种情况下，FIFO的结果都是一样的，即队列中前11分组发送完毕后才能发送分组流中剩下的分组。在使用WFQ时，在图(a)中分组流l先可以发送10个分组（但第11个分组还不能发送），而在图(b)中分组流l和其他的分组流交替地发送。
不管是哪一种情况，分组流l都能够得到更多时间的服务。
2.管制机制前面提到了使用管制机制可以提供服务质量。对一个数据流，我们可根据以下三个(cid:4851)面进行管制：(1)平均速率个数据流的平均速率。这里的平均速率是指在一定的
时间间隔内通过的分组数。但这个时间间隔的选择也说明了这个指标的严格程度。例如，限网络需要控制一•393•定数据流的平均速率为每秒50个分组和平均速率为每分钟3000个分组，虽然这两个指标的
平均值都一样，但其严格程度却不同。假定有一个数据流，有一秒钟通过了1000个分组，
但一分钟平均下来仍不超过3000个，那么这个数据流的平均速率符合后面一个指标，但却
远远不满足前面的指标。
分组流
l
分组流2
．．．分组流l

### 分块 12
远远不满足前面的指标。
分组流
l
分组流2
．．．分组流l
FIFOWFQl分组流
分组流2．．．
分组流11FIFOWFQ门l
[2－
门I2|3I4|5|6I7I8|9|l0|ll|l|l|l|l11|l|1|l|lI工工工(a)工口］工口］口］工荨t工[211L1|2|1|3|1|4|1|511|6-LlUll|8|l|9|l|10|l|llt图8-21(b)WFQ与FIFO的比较(2)峰值速率峰值速率限制了数据流在非常短的时间间隔内的流量。数学上的＂瞬
时值”在实际网络中无法测定。因此这里所说的“非常短的时间间隔＂需要指明时间间隔是
多少。例如，限定数据流的平均速率为每分钟3000个分组，但同时限定其峰值速率不超过
每秒1000个分组。峰值速率也同时受到链路带宽的限制。
(3)突发长度网络也限制在非常短的时间间隔内连续注入到网络中的分组数。
要在网络中对进入网络的分组流按以上三个指标进行管制，可使用非常著名的漏桶管制器(leakybucketpolicer)（可简称为漏桶），其工作原理如图8-22所示。

### 分块 13
注入漏桶的速卒为每秒r个权标在任何时间间隔t内准许进入网络的分组数不能超过rt+b图8-22漏桶管制器的工作原理漏桶是一种抽象的机制。在淜桶中可装入许多权标(token)，但最多装入b个权标。只要
漏桶中的权标数小千b个，新的权标就以每秒r个权标的恒定速率加入到漏桶中。但若漏桶
已装满了b个权标，则新的权标就不再装入，而漏桶的权标数达到最大值b。
漏桶管制分组流进入网络的过程如下：分组进入网络前，先要进入一个队列中等候漏•394•桶中的权标。只要漏桶中有权标，就可从漏桶取走一个权标，然后就准许一个分组从队列进入到网络。若漏桶已(cid:4873)权标，就要等(cid:4843)的权标注入到漏桶，再把这个权标拿走后才能准许下
”
一
个分组进入网络。请注意：“准许进入网络＂
已经进入了网络，因为分组进并不等千说”入网络还需要时间，这取决于输出链路的带宽和分组在输出端的排队情况。
假定在时间间隔t中把湿桶中的全部b个权标都取走，但在这个时间间隔内漏桶又装入

### 分块 14
假定在时间间隔t中把湿桶中的全部b个权标都取走，但在这个时间间隔内漏桶又装入
了rt个(cid:4843)的权标，因此在任何时间间隔t内准许进入网络的分组数的最大值为rt+b。控制权标进入漏桶的速率r就可对分组进入网络的速率进行管制。
3.漏桶机制与加权公平排队相结合把漏桶机制与加权公平排队结合起来，可以控制队列中的最大时延。
现假定有n个分组流输入到一个路由器，复用后从一条链路输出。每一个分组流使用漏桶机制进行管制，漏桶参数为bl和rui=l,2,…，n（如图8-23所示）。
路由器图8-23用漏桶机制进行管制前面已经讲过，WFQ可以使每一个分组流得到如公式(8-1)所示的有保证的数据率。那么当分组流通过漏桶后等待WFQ服务时，一个分组所经受的最大时延是多少？
现在考虑分组流l。假定漏桶i已经装满了bl个权标。这就表示分组流i不需要等待就可从漏桶中拿走bl个权标，因此bl个分组可以马上从路由器输出。但分组流i得到的数据率由公式(8-1)给出。这bi个分组中的最后
组所需的时间dmax'即b汛余以公式(8-1)给出的传输速率：一个分组所经受的时延最大，它等千传输这bi个分biw
d=

### 分块 15
d=
丿
maxRxwi1(8-2)8.4.3综合服务IntServ与资源预留协议RSVP最初试图在互联网中将互联网提供的服务划分为不同类别的是IETF提出的综合服务
IntServ(IntegratedServices)[RFC2210-2215]和资源预留协议RSVP(ReSourcereserVationProtocol)[RFC2205-2209][ZHAN93]，其中的某些RFC(cid:4825)档已成为互联网的建议标准。
IntServ可对单个的应用会话提供服务质量的保证，其主要特点有二：(1)资源预留。
宽和缓存空间）。
(2)呼叫建立。
一一个路由器需要知道给不(cid:4837)出现的会话已经预留了多少资源（即链路带个需要服务质量保证的会话，必须首先在源点到终点路径上的每一个路由器预留足够的资源，以保证其端到端的服务质量的要求。因此，在一个会话开始之前必•395•一须先有个呼叫建立（又称为呼叫接纳）过程，它需要在其分组传输路径上的每一个路由器都参加。每一个路由器都要确定该会话所需的本地资源是否够用，同时还不要影响到已经建立的会话的服务质量。

### 分块 16
IntServ定义了两类服务：
(1)有保证的服务(guaranteed个严格的上限。
service)，可保证一个分组在通过路由器时的排队时延有一(2)受控负载的服务(controlled-loadservice)，可以使应用程序得到比通常的“尽最大努”
力更加可靠的服务。
IntServ共有以下四个组成部分：
(1)资源预留协议RSVP,它是IntServ的信令协议。
(2)接纳控制(admissioncontrol)，用来决定是否同意对某一资源的请求。
(3)分类器(classifier)，用来把进入路由器的分组进行分类，并根据分类的结果把不同类别的分组放入特定的队列。
(4)调度器(scheduler)，根据服务质量要求决定分组发送的前后顺序。

### 分块 17
(4)调度器(scheduler)，根据服务质量要求决定分组发送的前后顺序。
会话必须首先声明它所需的服务质佩，以便使路由器能够确定是否有足够的资源来满足该会话的需求。资源预留协议RSVP在进行资源预留时采用了多播树的(cid:4853)式。发送端发送PATH报(cid:4826)（即存储路径状态报(cid:4827)），给所有的接收端指明通信量的特性。每个中间的路由器都要转发PATH报(cid:4828)，而接收端用RESV报(cid:4828)（即资源预留请求报(cid:4828)）进行响应。路径上的每个路由器对RESV报(cid:4826)的请求都可以拒绝或接受。当请求被某个路由器拒绝时，路由一一器就发送
缓存空间就被分配给这个分组流，而相关的流(flow)状态信息就保留在路由器中。
个差错报(cid:4826)给接收端，从而终止了这信令过程。当请求被接受时，链路带宽和“”
流是在多媒体通信中的一个常用的名词，一般定义为“具有同样的源IP地址、源端口号、目的IP地址、目的端口号、协议标识符及服务质量需求的一连串分组”。

### 分块 18
图8-24用一个简单例子说明RSVP协议的要点。设主机凡要向互联网上的四台主机压～H5发送多播视频节目，在图中这四台主机右边标注的数据率就是这些主机打算以这样的
数据率来接收儿发送的视频节目。这个视频节目可使用不同的数据率来接收。用较低数据率接收时，图像和声音的质量也就较差了。
主机凡先以多播(cid:4853)式从源点H1向下游(cid:4851)向发送PATH报(cid:4828)，如图8-24(a)所示。当PATH报(cid:4829)传送到多播路径终点的四台主机（即叶节点）时，每一台主机就向多播路径的上游发送RESV报(cid:4826)，指明在接收该多播节目时所需的服务质量等级。路由器若(cid:4874)法预留
RESV报(cid:4830)所请求的资源，就返回差错报(cid:4827)。若能预留，则把下游传来的RESV报(cid:4826)合并构成
(cid:4842)的RESV报(cid:4826)，传送给自己的上游路由器，最后传送到源点主机H1。这些情况如图8-24(b)所示。因此，RSVP协议是面向终点的。

### 分块 19
需要注意的是，路由器合并下游的RESV报(cid:4826)并不是把下游提出的预留数据率简单地相加而是取其中较大的数值。例如，路由器凡收到两个预留3Mbit/s的RESV报(cid:4828)，但凡
向民发送的RESV报(cid:4826)只要求预留3Mbit/s而不是6Mbit/s（因为向下游(cid:4851)向发送数据是采用可以节省带宽的多播技术）。同理，凡向民发送的RESV报(cid:4826)要求预留100kbit/s而不是
150kbit/s。最后，R1向源点儿发送的RESV报(cid:4826)要求预留3Mbit/s。当凡收到返回的RESV报(cid:4828)后，就开始发送视频数据报(cid:4825)了。
•396•H,源点
心1
!
）三千一－RIl－表示PATH报文）H2H350kbit/sI00kbit/s凡3Mbit/sR2安｀
丁IH
报文5一1令3Mbit/s(a)源点用多播发送PATH`s32,^__＿H2_，50kbit/sH1户1
源点
三三硒芦二嘎气

### 分块 20
源点
三三硒芦二嘎气
,3Mbit/sR3Mbit/sR＼0021匕勹｀，儿100kbit/s二示RESV报文］一—_j江二三凡3Mbit/s
SV报文(b)各终点向源点返回RE
图8-24RSVP协议的工作原理IntServ/RSVP使得互联网的体系结构发生了根本的变化，因为IntServ/RSVP使得互联网不再是提供“尽最大努力交付＂的服务。在有关服务质量的协议中，RSVP是最复杂的。
IntServ/RSVP所基于的概念是端系统中与分组流有关的状态信息。各路由器中的预留信
息只存储有限的时间（这称为软状态soft-state)，因而各终点对这些预留信息必须定期进行
更新。我们还应注意到，RSVP协议不是运输层协议而是网络层的控制协议。RSVP不携带
应用数据。图8-25给出了在路由器中实现的IntServ体系结构。
路由选择协议图8-25lntServ体系结构在路由器中的实现IntServ体系结构分为前台和后台两个部分。前台部分画在下面，包括两个功能块，即
分类器与分组转发，分组的调度器。每一个进入路由器的分组都要通过这两个功能块。后台

### 分块 21
分类器与分组转发，分组的调度器。每一个进入路由器的分组都要通过这两个功能块。后台
部分画在上面（有灰色阴影的部分），包括四个功能块和两个数据库。这四个功能块是：•路由选择协议，负责维持路由选择数据库。由此可查找出对应千每一个目的地址和
每一个流的下一跳地址。
•RSVP协议，为每一个流预留必要的资源，并不断地更新通信量控制数据库。
•接纳控制，当一个新的流产生时，RSVP就调用接纳控制功能块，以便确定是否有足够的资源可供这个流使用。
•397•．管理代理，用来修改通信量控制数据库和管理接纳控制功能块，包括设置接纳控制策略。
综合服务IntServ体系结构存在的主要问题是：
(1)状态信息的数量与流的数目成正比。例如，对于OC-48链路C2.5Gbit/s)上的主干
网路由器，通过64kbit/s的音频流的数目就超过39000个。如果对数据率再进行压缩，则流的数目就更多。因此在大型网络中，按每个流进行资源预留会产生很大的开销。

### 分块 22
(2)IntServ体系结构复杂。若要得到有保证的服务，所有的路由器都必须装有RSVP、接纳控制、分类器和调度器。这种路由器称为RSVP路由器。在应用数据传送的路径中只要一有个路由器不是RSVP路由器，(cid:4821)个的服务就又变为
(3)综合服务IntServ所定义的服务质量等级数量太少，不够灵活。
“”
尽最大努力交付了。
8.4.4区分服务DiffServ1.区分服务的基本概念由于综合服务IntServ和资源预留协议RSVP都较复杂，很难在大规模的网络中实现，因此IETF提出了一种(cid:4842)的策略，即区分服务DiffServ(DifferentiatedServices)[RFC2475]。
区分服务有时也简写为DS。因此，具有区分服务功能的节点就称为DS节点。

### 分块 23
区分服务有时也简写为DS。因此，具有区分服务功能的节点就称为DS节点。
区分服务DiffServ的要点如下：(1)DiffServ力图不改变网络的基础结构，但在路由器中增加区分服务的功能。因此，DiffServ将IP协议中原有8位的IPv4的服务类型字段和IPv6的通信量类字段重(cid:4842)定义为区分服务DS（如图8-26所示）。路由器根据DS字段的值来处理分组的转发。因此，利用DS字段的不同数值就可提供不同等级的服务质量。根据互联网的建议标准[RFC2474],DS字段现在只使用其中的前6位，即区分服务码点DSCP(DifferentiatedServicesCodePoint),再后面的两位目前不使用，记为CU(CurrentlyUnused)。因此由DS字段的值所确定的服务质量实际上就是由DS字段中DSCP的值来确定的。
位0567IlII|UIICPI

### 分块 24
位0567IlII|UIICPI
-os-l图8-26区分服务码点DSCP占DS字段的前6位在使用DS字段之前，互联网的ISP要和用户商定一个服务等级协定SLA(ServiceLevelAgreement)。在SLA中指明了被支持的服务类别（可包括吞吐量、分组丢失率、时延和时延抖动、网络的可用性等）和每一类别所容许的通信量。
(2)网络被划分为许多个DS域(DSDomain)。一个DS域在一个管理实体的控制下实现同样的区分服务策略。DiffServ将所有的复杂性放在DS域的边界节点(boundarynode)中，而使DS域内部路由器工作得尽可能简单。边界节点可以是主机、路由器或防火墙等。为了简单起见，下面只讨论边界节点是边界路由器的情况（原理都是一样的）。图8-27给出了DS域、边界路由器(boundaryrouter)和内部路由器(interiorrouter)的示意图。图中标有B的路由器都是边界路由器。
•398•-------------
DS域／已;
＼心令、

### 分块 25
•398•-------------
DS域／已;
＼心令、
才心巴巴了广＼二三兰二内部路由器)B/边界路由器内部且｀由器）DS域＼图8-27DS域、边界路由器和内部路由器的示意图(3)边界路由器中的功能较多，可分为分类器(classifier)和通信量调节器(conditioner)两
大部分。调节器又由标记器(marker)、整形器(shaper)和测定器(meter)三个部分组成。分类器
根据分组首部中的一些字段（如源地址、目的地址、源端口、目的端口或分组的标识等）对
分组进行分类，然后将分组交给标记器。标记器根据分组的类别设置DS字段的值。以后在
分组的转发过程中，就根据DS字段的值使分组得到相应的服务。测定器根据事先商定的
SLA不断地测定分组流的速率（与事前商定的数值相比较），然后确定应采取的行动，例如，
可重新打标记或交给整形器进行处理。整形器中设有缓存队列，可以将突发的分组峰值速率
平滑为较均匀的速率，或丢弃一些分组。在分组进入内部路由器后，路由器就根据分组的
DS值进行转发。图8-28给出了边界路由器中各功能块的关系。
、、、r
、没穹＄

### 分块 26
DS值进行转发。图8-28给出了边界路由器中各功能块的关系。
、、、r
、没穹＄
心二蛔咖＇`｀11“＿－---·一，
＇卒芸沪
＇，＿－
！｀岫
、
、了边界路由器＼、、一＿（入口）-----内部路由器--
c_·--�--�---·'"·····－－＇，，＿＇，边界路由器
(出口）图8-28边界路由器中的各功能块的关系(4)DiffServ提供了一种聚合(aggregation)功能。DiffServ不是为网络中的每一个流维持
而是把若干个流根据其DS值聚合成少量的流。路由器对相同
供转发时使用的状态信息，
DS值的流都按相同的优先级进行转发。这就大大简化了网络内部的路由器的转发机制。区
分服务DiffServ不需要使用RSVP信令。
2.每跳行为PHBDiffServ定义了在转发分组时体现服务水平的每跳行为PHB(Per-HopBehavior)。所谓
“行为”就是指在转发分组时路由器对分组是怎样处理的。“行为＂的例子可以是：“首先转
发这个分组”或“最后丢弃这个分组”。“每跳”是强调这里所说的行为只涉及本路由器转发

### 分块 27
发这个分组”或“最后丢弃这个分组”。“每跳”是强调这里所说的行为只涉及本路由器转发
的这一跳的行为，而下一个路由器再怎样处理则与本路由器的处理无关。这和IntServ/RSVP
考虑的服务质量是“端到端＂的很不一样。
IETF的DiffServ工作组已经定义了两种PHB,即迅速转发PHB和确保转发PHB。
迅速转发PHB(ExpeditedForwardingPHB)可记为EFPHB,或EF[RFC3246,建议标
。EF指明离开一个路由器的通信量的数据率必须等千或大于某一数值。因此EFPHB用准］•399•来构造通过DS域的一个低丢失率、低时延、低时延抖动、确保带宽的端到端服务（即不排
队或很少排队）。这种服务对端点来说像点对点连接或“虚拟租用线”，又称为Premium（优
质）服务。对应于EF的区分服务码点DSCP的值是101110。
确保转发PHB(AssuredForwardingPHB)可记为AFPHB或AF[RFC2597,建议标准］AF用DSCP的第0~2位把通信量划分为四个等级（分别为001,010,011和100)，并给每

### 分块 28
一种等级提供最低数量的带宽和缓存空间。对于其中的每一个等级再用DSCP的第3~5位
划分出三个“丢弃优先级”（分别为010,100和110,从最低丢弃优先级到最高丢弃优先级）。
当发生网络拥塞时，对千每一个等级的AF,路由器就首先把“丢弃优先级”较高的分组丢
弃。
从以上所述可看出，区分服务DiffServ比较灵活，因为它并没有定义特定的服务或服务类别。当新的服务类别出现而旧的服务类别不再使用时，DiffServ仍然可以工作。
本章的重要概念•多媒体信息有两个重要特点：（1)多媒体信息的信息量往往很大；（2)在传输多媒体数据时，对时延和时延抖动均有较高的要求。在互联网上传输多媒体数据时，我
们都是指含有“边传输、边播放”的特点。
•由多媒体信息构成的分组在发送时是等时的。这些分组在到达接收端时就变成为非
等时的。当接收端缓存中的分组数达到一定的数量后，再以恒定速率按顺序将这些
分组进行还原播放。这样就产生了播放时延，同时也可以在很大程度上消除时延的
抖动。
•••在传送时延敏感的实时数据时，传输时延和时延抖动都必须受到限制。通常宁可丢
失少量分组，也不要接收太晚到达的分组。

### 分块 29
失少量分组，也不要接收太晚到达的分组。
目前互联网提供的音频／视频服务有三种类型：（1)流式存储音频／视频，用户通过
互联网边下载、边播放。
发送在接收时也是要求能够连续播放。
互联网电视会议。
流媒体(streamingmedia)就是流式音频／视频，其特点是边下载、边播放。若使用专
门的软件，则可将其存储在硬盘上成为用户的文件。
(2)流式实况音频／视频，其特点是在发送方边录制、边
(3)交互式音频／视频，如互联网电话或•媒体服务器（或称为流式服务器）可以更好地支持流式音频和视频的传送。TCP
能够保证流式音频／视频文件的播放质量，但开始播放的时间要比请求播放的时间
滞后一些（必须先在缓存中存储一定数量的分组）。对千实时流式音频／视频文件的
传送则应当选用UDP。
•实时流式协议RTSP是为了给流式过程增加更多功能而设计的协议。RTSP本身并
而仅仅是使媒体播放器能够控制多媒体流的传送。RTSP又称为“互不传送数据，
联网录像机遥控协议”。
•狭义的IP电话是指在IP网络上打电话。广义的IP电话则不仅是电话通信，而且

### 分块 30
•狭义的IP电话是指在IP网络上打电话。广义的IP电话则不仅是电话通信，而且
还可以在IP网络上进行交互式多媒体实时通信（包括话音、视像等），甚至还包括
即时传信IM（如QQ和Skype等）。
IP电话的通话质量主要由两个因素决定：（1)通话双方端到端的时延和时延抖
而是取决千当时网
动；（2)话音分组的丢失率。但这两个因素都是不确定的，••400•。

