2.IP数据报首部的可变部分

IP数据报首部的可变部分就是 一 个选项字段 c 选项字段用来支持排错、 测量以及安全
等措施， 内容很丰富。 此字段的长度可变， 从1字节到 40字节不等， 取决千所选择的项
目。某些选项项目只需要 l字节， 它只包括 1字节的选项代码。 而有些选项需要多个字节，
这些选项 一 个个拼接起来， 中间不需要有分隔符 ， 最后用全 0的填充字段补齐为 4字节的
整数倍。

增加首部的可变部分是为了增加 IP数据报的功能， 但这同时也使得 IP数据报的首部长
度成为可变的。 这就增加了每 一 个路由器处理数据报的开销。 实际上这些选项很少被使用。
很多路由器都个考虑 IP首部的选项宁段， 因此新的 IP版本 IPv6就把 IP数据报的首部长度
做成固定的了。 这里就不讨论这些选项的细节了。 有兴趣的读者可参阅 RFC791。

4.3 IP层转发分组的过程

4.3.1 埜于终点的转发

我们在图 4-7中已经描述了分组在互联网中逐跳转发的概念。 分组在互
联网上传送和转发是基于分组首部中的目的地址的， 因此这种转发方式称为

基千终点的转发。

视频讲解

因此， 分组每到达 一 个路由器， 路由器就根据分组中的终点（目的地 址）查找转发表，

然后就得知下 一 跳应当到哪 一 个路由器。

但是， 路由器中的转发表却不是按目的 IP地址来直接查出下 一 跳路由器的。 这是因为
互联网中的主机数目实在太大了。 如果用目的地址直接查找转发表， 那么这种结构的转发表

就会非常庞大， 使得查找过程非常之慢。 这样的转发表也就没有实用价值了。 因此必须想办

法压缩转发表的大小。

我们知道， 32位的 IP地址是由两级组成的。 前一 部分是前缀， 表示网络， 后 一 部分表
示主机。 所以司以把查找目的主机的方法变通 一 下， 即不是直接查找目的主机， 而是先查找
目的网络（网络前缀），在找到了目的网络之后， 就把分组在这个网络上直接交付目的主机。

由千互联网上的网络数远远小千主机数， 这样就可以大大压缩转发表的大小， 加速分组在路

由器中的转发。 这就是基千终点的转发过程。

读者可能还会想到 一 个问题， 就是分组首部中没有地方可以用来指明
“
， 那么待转发的分组又怎样能够找到下 一 跳路由器呢？

的 IP地址

“

下一 跳路由器

当路由器收到 一 个待转发的分组， 在从转发表得出下 一 跳路由器的 IP地址后， 不是把
这个地址填入分组首部， 而是送交数据链路层的网络接口软件。 网络接口软件负责把下 一 跳
路由器的 IP地址转换成 MAC地址（必须使用 ARP)， 并将此 MAC地址放在链路层的
MAC帧的首部， 然后利用这个 MAC地址传送到下 一 跳路由器的链路层， 再取出 MAC帧
的数据部分， 交给网络层。 由此可见， 当发送 一 连串的分组时， 上述的这种查找转发表、 调
用 ARP解析出 MAC地址、 把 MAC地址写入 MAC帧的首部等过程， 都是必须做的（当然
都是由机器自动完成的） 。

那么，能不能在转发表中不使用 IP地址而直接使用 MAC地址呢？不行。 我们 一 定要

弄清楚， 使用抽象的 IP地址， 本来就是为了隐蔽各种底层网络的复杂性而便千分析和研究
问题， 这样就不可避免地要付出些代价， 例如在选择路由时多了 一 些开销。 但反过来， 如果

• 140 •

在转发表中直接使用MAC地址， 那就会带来更 多 的 麻烦， 甚至无法找到对方的 机 器。

下面用具体例子来 说明分组的转发过程。

【例4-2】 图4-23中 有三个子网通过两个路由器互连在一起 。 主机凡发送出一个分组，

其目的地址是128.1.2.132。 现在源 主机是凡而目的 主机是H2。 试讨论分组怎样从源主机传
送到目的 主机。

- ＿ － -

--
子网前缀凡',--
128.1.

＇，

,',

/'

128. I.2.192/26

,'

{:,、三---- -

己

＼

＄ /，'

＇

｀

部

R1的

分转发表詈卢扂

N ',
3 ， ，
子网前缀

128

.1 :3.64/26
，

l28 1 3 66

'，尸＼=

，
夺

I

凇L2130
R2

、-----

二1目的主机

----------------------- - - －
128.1.2.132

、、

-----～｀～～、凡 子网前缀
、
128.1.2.128/26
、
;
H2'l'

图4-23 源主机凡向目的地址儿发送分组

【解】 主机凡首先必须确 定： 目的主机是否连接在本网络上？如果是， 那么问题很简

单， 就直接交付， 根本 不需要利用路 由器；如果 不是， 就间接交付， 把分组发送给连接在本

网络上的 路由器， 以后要做的 事情都 由这个路由 器来处理。

主机凡先把 要发送的分组的目的地址和本网络 N 1 的子网掩码按位进行A ND运算， 得

出运算结果。 如果运算结果等于本网络 N 1 的前缀， 就表明 目的 主机连接在本网络上；否则，
就必须把分组发送到路由器R 1 , 由路由器凡完成后 续的 任务。

由千采用了C IDR记法， 转发表中给出的都是网络前缀， 而没有明显给出子网掩码。 其

实只要细心观察斜线后面的数字， 就可知道相应的子网掩码。 例如，／26 的子网掩码就是点
分十进制的 255.255.255.192。 现在， 要发送的分组的目的地址是128.1.2.132, 本网络的掩码
是26 个l， 后 面 有 6个 0。 如图4-24(a)所 示， 按位A ND运算的结果是128.1.2.128, 不等千

本网络 N1的前缀。 这 说明目的主机 没有连接在本网络上。 源主机凡必须把分组发送给路由

器Rl， 让路由 器凡根据其转发表来处理这个分组。

(a)

(b)

128.

目的主机IP地址

.
10000000  00000001  00000010  10000100
128.1.2.192/26的掩码 11111111  11111111  11111111  11000000
10000000 00000001  00000010  10000000
.

按位AND运算
得出结果

128 .

132

2

 2

1

1

.

128 /26

128.

目的主机IP地址

.
10000000  00000001  00000010  10000100
128.1.2.128/26的掩码11111111  11111111  11111111  11000000
10000000  00000001  00000010  10000000
.

按位AND运算
得出结果

128 .

 132

2

 2

1

1

.

.

128 /26

图4-24 目的地址和本网络的子网掩码按位进行AND运算

•  141  •

.

路由器 R 1 的部分转发表已在图 4-23右上方给出了。 转发表中第 1 列就是 “ 前缀 匹配 ” ,

这 是因为查找转发表的过程就是寻找前缀匹配的过程。
现在先检查路由器民的转发表中的第1行。
源 主机儿要发送的分组的目的地址是128.1.2.132。 本网络 128.1.2.192/26的前缀有 26
位， 因此本网络的掩码是26个l， 后面是6个 0。 目的地址和子网掩码按位AND运算的结
果是 128.1.2.128/26（见图4-24(a)）。 很明显，AND 运算结果与转发表第1行的前缀 不 匹配。
接着检查路由器民的转发表中的第2行。 运算结果是128.1.2.128/26, 如图4-24(b)所示。
这 个结果和转发表第 2行的前缀相 匹配。 因此按照转发表第 2行指出的， 在网络 N2上进行
分 组的直接交付 （通过路由器 R 1 的接口1 )。 这时路由器民调用ARP, 解析出目的 主机H2
的MAC地址， 再封装成链路 层的帧， 直接交付连接在本网络 N2上的 目的 主机H

如果按照同样的方法， 检查路由器R 1 的转发表中的第3行， 不难得出不匹配的结果。
从 以上例子可看出， 查找转发表的过程就是逐行 寻找前缀匹配的过程。 我们再看下一

扣

个例子。

扫 一 扫

4.3.2  最长前缀匹配

【例4-3】 假定在图4-25 的例子中， 路由器凡收 到一个 目的地址为
128.1.24.1 的分组， 请给出 分组的转发 接口。 请注意 ， 公司B包含三个子

网， 但这 些网 络前缀 并没有出现在 路由器R的转发表中。 这 是因为公司
B采用了 路 由聚合， 把三 个 子网的所有地址聚合为一个网络前缀 128.1.24.0/22。

视频讲解

公司B
128. 1.25.0/24
28.1.26.0/24

公司A
128.1.24.0/24

前缀匹配

路由器R舶 128.l.24.0/22

部分转发表[;:／:~4

图4-25 分组交给路由器民进行转发

【解】 我们把进入路由器凡的分组的目的地址分别和路由器凡的转发表第1行、 第
2 行子网掩码进行按位 AND 运算。 运算结果都是 ＂ 匹配 ＂ （建议读者自行验算一 下）。 那么，
哪一个结果是正确的呢？现在就来分析这 个问题。

网络前缀 128.1.24.0/22 可 以划分为 4 个 更小的/24 前缀 （图4-26)。 其中的一个前缀
128.1.24.0/24 分配给公司A, 另外 3 个前缀分配给公司B。 公司B把得到的 3 个前缀聚
合成一个更大的前缀 128.1.24.0/22, 作为路由器R 1 的转发表中的一个项目。 请注意 ， 这
个前缀和原来的前缀在形式上是一 样的， 但 实际的区别是很大的： 在图 4-26左边的网络
前缀中包含地址 128.1.24.1, 但公司B的聚合后的网络前缀则 不包含这个地址。 因此在本例
中， 即分组应当从 接口1 转发到公司A。

那么为什么地址 128.1.24.1 不在公司B的聚合前缀 128.1.24.0/22 中， 但匹配运算的结
中的项目 128.1.24.0/22 并未说明是由哪几个子网聚合

果却是匹配呢？这 是因为在转发
而成的。

表

• 142  •

地址128.1.24.1在其中
AE幻．24.0/2i

h
五汀：2

4.0/2;懿旷'“

公司

网络前缀

'. ~ · · 谓 �,八，～ ＾＇｀ ＇，一一 ，｀ ＾ ＾  ｀  ＾矗八，＾＾ ＇  ，， — 'B

图4-26 公司A和B分到的前缀

4.1不在其中

十分明显， 进入路由器凡的分组的目的地址 128.1.24.1 处 千公司A 拥有的地址范围中，

而 不 在公司B的地址范围内。 分组应当通过接口1 转发到公司A。

为了减少 路由器 R 1 中的项目数， 公司B采用了地址聚合， 把三个地址块聚合为一个地
址块128.1.24.0/22。 这个聚合后得出的前缀和图中左边所示的前缀在形式上是一样的。 这样
就导致图4-26所示的出现和两个网络前缀都匹配的现象。

我们可 以注意到， 现在公司B三 个地址块得出的聚合地址块是128.1.24.0/22, 但 如果公
司 B 只分到两 个 地 址 块 128.1.25.0/24 和 128.1.26.0/24 , 那 么其聚 合 地 址 块仍然是
128.1.24.0/22。 如果把公司 A 和公司 B 的地址块都聚合起来， 得 出的聚合地址块还是
128.1.24.0/22。 这样的地址聚合可 以发生 在 路由器R2中。

因此， 在采用 CIDR编址时， 如果一个分组在转发 表中可 以找到多个匹配的前缀， 那么
就 应当选择前缀最长的一个作为匹配的前缀。 这个原则称为最长前缀匹配(longest prefix
match)。 网络前缀越长，其地址块就越小， 因而 路由就越具体(m ore specific)。 为了更加迅速
地查找转发表， 可 以按照前缀的长短， 把前缀最长的排在第1行， 然后按 前缀长短的顺序往
下排列。 用这种方法从第1行前缀最长的开始查找， 只要检查到匹配的， 就 不必再继续往下
查找， 可 以立即结束查找。

实际的转发表 有时 还可能增加两种特殊的路由， 就是主机 路由和默认 路由。
主机路由(host route)又叫作特定主机路由， 这 是对特定目的 主机的IP地址专门指明的
一个 路由。 采用特定 主机 路由可使网络管理人员更方便地控制网络和测试网络， 同时也可在
需要考虑某种安全问题时采用这种特定 主机 路 由。 在对网络的连接或转发表进行排错时， 指
明到某一 台主机的特殊 路由就十分有用。假定这个特定 主机的点 分十进制 IP地址是 a.b. c. d,
那么 在转发表中对应于主机 路由的网络前缀就是a.b.c.d/32。 我们知道，／32 表示的子网掩码
是 32 个 1。 实际的网络 不可能使用 32 位的前缀， 因为没有主机号的IP地址是没有实际意
义的。 但这 个特殊的前缀却可 以用 在转发 表中。 不 难看出， 32 个 l 的子网掩码和IP地址
a.b.c.d 按位进行 AND 运算后， 得出的结果必定是a.b.c.d, 也就是说， 找到 了匹配。 这时就
把收到的分组转发到转发表所指出的下 一跳。 主机 路由在转发 表中都放在最前面。

还有一种特殊 路由是默认路由(default route)。 这 就是不管分组的最终目的网络 在哪里，

都 由指定的 路由器 R 来处理。 这 在网络只有 很少的对外连接时非常有用。 在实际的转发表
中， 用一个特殊前缀 0.0.0.0/0 来表示默认 路由。 这个前缀的掩码是 全0 (/0 表示网络前缀是
0 位， 因此掩码是 32 个 0 )。 用 全0 的掩码和任何目的地址进行按位AND 运算， 结果一 定

是 全O, 即必然是和转发表中的 0.0.0.0/0 相匹配的。 这时就按照转发表的指示， 把分组送 交

下一 跳 路由器R 来处理（即间接交付）。

综上所述， 可归纳出分组转发算法如下（假定转发表按 照前缀的长短排列， 把前缀长

的放在前面）：

• 143  •

(1) 从收到的分组的首部提取目的主机的IP地址D（即目的地址）。
( 2)若查找到有特定主机路由（目的地址为 D)， 就按照这条路由的下一 跳转发分组；

否则从转发表中下一行（也就是前缀 最长的一行） 开始检查， 执行(3)。
(3) 把这 一行的子网掩码与目的地址D按位进行AND运算。
若运算结果与本行的前缀匹配， 则查找结束， 按照

下 一 跳 ”

“

所指出的进行处理（或

直接交付本网络上的目的主机， 或通过指定接口发送到下一跳路由器）。
否则， 若转发表还有下一行， 则对下 一行进行检查， 重新执行(3)。

否则， 执行(4 )。

(4)若转发表中有一个默认路由， 则按照指明的接口， 把分组传送到指明的默认路由器；

否则， 报告转发分组出 错。

可以用一个简单的比喻来说明查找转发表和转发分组的过程。 例如， 从家门口开车到
机场， 但没有地图， 不知道应当走哪条路线。 好在每一个道路岔口都有一个警察可以询问。
”（相
因此， 每到 一个岔口（相 当于到 了一个路由器）， 就问： ”到机场应当朝哪个方向走？
当于查找转发表）。 该警察并不告诉你去机场的详细路径。 他仅仅指出 到机场途经的下一个
警察位置的方向。 其回答可(cid:7126)是：
回答可(cid:7126)是 ： “直行。 ” 这样， 每到 一个岔口， 就询问下一 步走的方向。 这样， 在没有地图的
情况下， 我们最终也可以到达目的地 机场。

“ 向左转方向走。”你左转到了下一个岔口， 再询问警察，

顺便指出， 在过去使用分类地址时， 不存在最长前缀匹配的问题。 在转发表中， 不会

出现目的地址和转发表中的两行或两行以上的网络地址匹配的情况。

4.3.3  使用二叉线索查找转发表

使用CIDR后， 由千不知道目的网络的前缀 ， 使转发表的查找过程变得更加复杂了。
当转发表的项目数很大时， 怎样设法缩短转发表的查找时间就成为 一个非常重要的问题。
例如， 连接路由器的线路的速率为10 Gbit/s, 而分组的平均长度为 2000 bit, 那么路由器
就应当平均每秒钟(cid:7126)够处理 500万个分组（常记为 5 Mpps)。 或 者说， 路由器处理一个分
C 1  ns  =  10-9 s)。 因此， 查找每一个路由所需的时间是非常短的。
组的平均时间只有200 ns
可见在转发表中必须使用很好的数据结构和先进的快速查找算法， 这 一直是人们积极研究
的热门课题。

对无分类编址的转发表的最简单的查找算法就是对所有可(cid:7126)的前缀 进行循环查找， 从
最长的前缀 开始查找。 例如， 给定 一个目的地址。 对每一个可(cid:7126)的网络前缀 ， 进行目的地址
和子网掩码的按位 AND 运算， 得出一个网络前缀 ， 然后逐行查找转发表中的网络前缀 。 所
找到的最长匹配就对应千要查找的路由。

这种最简单的算法的明显缺点就是查找的次数太多。 最坏的情况是 转发表中没有这个

路由。 在这种情况下， 算法仍要进行32次（第1 次用32位的前缀 查找转发表中所有的行，
第2次用31位的前缀查找所有的行， 这样 一直查找下去）。

为了进行更加有效的查找， 通常是 把无分类编址的转发表存放在一种层次的数据结构
中， 然后(cid:7149) 上而下地按层次进行查找。 这里最常用的就是 二叉线索(binary trie)CD, 它是 一种

印注： 线索 (trie)来自 rerrieval （检索）， 读音与

“

try" 相同。

• 1 44  •

特殊结构的树。IP 地址中从左到右的比特值决定 了从根(cid:7188)点逐层向下层延伸的路径， 而二

叉线索中的各个路径就代表转发表中存放的各个地址。

图4-27用一个例子来说明二叉线索的结构。 图中给出了5个IP地址。 为了简化二叉线
索的结构， 可以先找出对应千每一个IP地址的唯—前缀(unique prefix)。 所谓唯 一前缀 就是
在表中所有的 IP 地址中， 该前缀 是唯 一的。 这样就可以 用这些唯 一前缀 来构造二叉线索。
在进行查找时， 只要(cid:7126)够和唯 一前缀相匹配就行了。

32位的IP 地址

唯

前缀

0 I 00011 0 00000000 00000000 00000000
010 IO 11 0 00000000 00000000 00000000
0 I I 00001 00000000 00000000 00000000
10 110000 00000010 00000000 00000000

10111011 0000 IO IO 00000000 00000000

一
0 I 00

0101
0 I I

l O 11 0
IO 11 I

图4-27 用5个前缀构成的二叉线索

从二叉线索的根(cid:7188)点(cid:7150)顶向下的深度最多有 32层， 每一层对应千IP地址中的一位。 一
个IP地址存入二叉线索的规则很简单： 先检查IP地址左边的第 一位， 如为0, 则第 一层的

(cid:7188)点就在根(cid:7188)点的左下方；如为1, 则在右下方。 然后再检查地址的第 二位， 构造出第二 层
的(cid:7189)点。 依此类推， 直到唯 一前缀的最后 一位。 由千唯 一前缀 一 (cid:7182)都小于 32位， 因此用唯

－前缀构造的二叉线索的深度往往不到32层。 图中较粗的折线就是前缀0101在这个二叉线

索中的路径。 二叉线索中的小圆刚是中间(cid:7190)点， 而在路径终点的小方框是叶(cid:7188)点（也叫作外
部(cid:7188)点）。 每个叶(cid:7191)点代表 一个唯 一前缀。 (cid:7188)点之间的连线旁边的数字表示这条边在唯 一前
缀中对应的比特 是0 或1 。

假定有一个IP地址是 100 11 0  1

 0 1

1010  00000000  00000000, 需要查找该地址是 否在

此二叉线索中。 我们从最 左边查起。 很容易发现， 查到第三个字符（即前缀 10后面的0)

时， 在二叉线索中就找不到匹配的， 说明这个地址不在这个二叉线索中。

以上只是给出了二叉线索这种数据结构的用法， 而并没有说明

” 与唯 一前缀匹配 ” 和
”与网络前缀匹配 ＂ 的关系。 显然 ， 要将二叉线索用千转发表中， 还必须使二叉线索中的每
一个叶(cid:7188)点包含所对应的网络前缀和千网掩砃。 当搜索到 一个叶(cid:7188)点时， 就必须将寻找匹配

的目的地址和该叶(cid:7192)点的子网掩码进行按位AND 运算， 看结果是否与对应的网络前缀相匹
配。 若匹配， 就按下一跳的接口转发该分组。 否则， 就丢弃该分组。

总之， 二叉线索只是提供了 一种可以 快速在转发表中找到匹配的叶(cid:7193)点的机制。 但这

是 否和网络前缀匹配， 还要和子网掩码进行一次逻辑AND运算。

为了提高二叉线索的查找速度，广泛使用了各种压缩技术。 例如， 在图 4 -27 中的最后

两个地址， 其最前面的4 位都是1011 。 因此， 只要一个地址的前4 位是10 1

1, 就可以跳过

前面4 位（即压缩了4 个层次） 而直接从第5位开始比较。 这样就可以 减少查找的时间。 当
然 ， 制作经过压缩的二叉线索需要更多的计算， 但由千每一次查找转发表时都可以 提高查找

速度， 因此这样做还是值得的。

• 1 45 •

1
1
1
