•  本数字证书所使用 的 签 名 算法
•  数字证 书签发者 的 唯
标 识 符

一

一
•  数 字证 书 的 有 效期 （ 有 效期开始 到 结束 的 日 期 范 围 ）

一

一

标 识 符 ）

•  主 体 名 （ 或主 题 名 ， 公 钥 和 数字证书拥 有 者 的 唯
•  公 钥 （ 数字 证 书 拥 有 者 的 公钥 和 使用 算 法 的 标 识 符 ， 对应 的 私钥 由 证书 拥 有者保存 ）
个树状 的 认证系统 （ 如 图 7- 1 6(a)所示 ） 。
X.509 提 出 把 多 级 认 证 中 心 链 接 起 来 的 ， 构 成
在 多 级 认证 系 统 的 末端 就 是用 户 ( A ~ E ) 。 在 X.509 中 并没有规定这种链接 需 要 多 少 级 ， 也
没 有 给 每
级 的 认 证 中 心 都称 为根认证 中 心 (Root
CA) ， 即 公认 可 信 的 认证 中 心 （ 或无条件信 任 的 ） ， 且 其 公 钥 是 公 开 的 。 在 这 种 树 状 的 认 证
个根 CA 。 从 根 CA 向 下 的 所有链接都称为信任链 ， 表示处在这条链
系 统 中 ， 可 以 有 不 止
接 上 的 认证机构 都 是 可 信 的 。

级 的 认 证 中 心 规 定 统
一

的 名 称 。 但 最 高

一

一

根证书

.... ,,_ 者

2

KK 心

“

－

中 间 CA

的 证书

？
中 间 CA

中 间 CA

的 公钥

根 CA签 发

(a)

(b)

图 7-1 6树状结构 的 多 级 认证 系 统(a)和证书链(b)

一

一

一

一

一

串 链接就是

图 7- 1 6(a)最右 边 的

用 户 E 。 与 这
条信 任链对应 的 是证书链 （ 如 图 7- 1 6(b)所示 ） ， 通过 图 中 所示 的链接 ， 就可 以 查 到 本证 书 的
签发者 ， 也 可 以 知 道 用 谁 的 公 钥 来验 证 本 证 书 中 的 签 名 。 在 这 条 证 书 链 中 ， 根 CA 给 中 间
2
CA

签 发 了 中 间 证 书 ， 并 使用 根 CA 的 私 钥 进 行 数字 签 名 。 中 间 CA2 可 以 用 根 CA 的 公钥 ，

条信任链 的 例 子 ： 根 CA

中 间 CA2

2

对 证 书 中 的 根 CA 签 名 进 行验 证 。 因 此 中 间 证 书 是 可 信 的 和 不 可 篡 改 的 。 同 理 ， 中 间 CA
个用 户 签 发 了 用 户 证 书 ， 并 使 用 中 间 C心 的 私 钥 进 行 数 字 签 名 。 用 户 可 以 用 中
给 下 面 的
的 签 名 进行验证 。 因 此 ， 这个用 户 证 书 也 是 可 信
间 C心 的 公 钥 ， 对 用 户 证 书 中 的 中 间 CA
的 和 不 可 篡 改 的 。 请 注 意 ， 最 顶 层 的 根 证 书 的 数 字 签 名 是 自 签名 （ 即 自 己 的 私 钥 给 自 己签
名 ） 。 根证书不 需 要其他 的 认证机构对其签名 ， 是我们 的 信 任链 的 起 点 。

2

若 证 书 链 中 的 某 个认 证 中 心 没 有 严 格遵 守 证 书 所 规 定 的 要 求 （ 例 如 ， 把 证 书 转 让 给 了

一

一

其他单位 ， 但 并未严格验证其 身 份 ） ， 那 么 这 个节 点 以 下 的 证 书 是 否 还 可 信 ， 就 应 重 新验 证 。
个
用 户 若 发现私钥被盗或遗失 ， 应及 时 报 告 上 级 CA , 以 便撤销证书 。 每
公 布 千 众 的 、 用 本 CA 的 私 钥 签 名 证书 撤销 名 单 ， 并 定 期 更 新 。
7 .5  互联网使用 的 安 全协议

个 CA 应 当 有

前 面 几 节 所 讨 论 的 网 络 安 全 原 理 都 可 用 在 互 联 网 中 ， 目 前 在 网 络 层 、 运 输层 和 应 用 层

都 有 相 应 的 网 络安 全协议 。 下 面 分 别 介 绍 这些协议 的 要 点 。

•  352 •

网 络层 安 全协议

7 . 5 . 1

1 .  I Psec

协议族概述

我 们 在 第 4 章 的 4.8 . 1 节 中 讨 论虚拟专用 网 VPN 时 ， 提 到 在 VPN 中 传 送 的 信 息都是经

一

名 词

”
“
IPsec 并 不 是 单
IPsec 协 议

过 加 密 的 。 现在我们就要 介 绍 提 供这种 加 密 服务 的 IPsec 。
一
的 协议 ， 而 是 能够 在 IP 层提供互 联 网 通信 安 全 的协议族 （ 不太严格 的
个通用 框 架 和 若 干加 密 算法 ， 具 有
IPsec 允 许 通 信 双 方从 中 选择 合 适 的 算 法 和 参 数 （ 例 如 ， 密 钥 长
IPsec 规 定 其所 有 的 实现都必 须包含 IPsec 所 推

度 ） ， 以 及 是 否 使用 鉴 别 。 为保证 互操作 性 ，

相 当 的 灵活性和 可 扩 展 性 。

也 常 见 到 ） 。 实 际上 ，

IPsec 包含 了

“

荐 的 全 部 加 密 算法 。
IPsec 就 是

IP 安 全(security) " 的 缩 写 。 在 很 多 RFC 文 档 中 已 给 出 了 详细 的 描述 。 在 这
（ 目 前 是 建 议 标 准 ） 和 提供

些 文 档 中 ， 最 重 要 的 就 是 描 述 IP 安 全 体 系 结 构 的 RFC 430 1
IPsec 协议族概述 的 RFC 607 1 。

IPsec 协议族 中 的 协议 可划 分 为 以 下 三 个 部 分 ：
( 1 )   IP 安全数据报格 式 的 两 个协议 ： 鉴 别 首 部 AH (Authentication  Header)协议和 封 装 安

全有效载荷 ESP (Encapsulation Security Payload)协议 。

(2) 有 关 加 密 算 法 的 三 个协 议 。
(3) 互联 网 密钥 交换 IKE (Internet Key Exchange)协议 。
下 面我 们 要 重 点 介 绍 IP 安 全 数 据 报 的 格 式 ， 以 便 了 解 IPsec 怎 样 提 供 网 络 层 的 安全通

信 。 AH 协议提供源 点 鉴 别 和 数据 完 整性 ， 但 不 能保密 。 而 ESP 协议 比 AH 协议 复 杂 得 多 ，
它 提 供源 点 鉴 别 、 数 据 完 整 性和 保 密 。

IPsec 支 持 1Pv4 和 1Pv6 。 在 1Pv6 中 ， AH 和 ESP 都
部 分 。 AH 协 议 的 功 能都 已包 含在 ESP 协议 中 ， 因 此使用 ESP 协议就可 以

是 扩 展 首 部 的

一

不 使 用 AH 协议 。 下 面我们将不再讨论 AH 协议 ， 而 只 介绍 ESP 协议 的 要 点 。

一

一

使 用 ESP 或 AH 协 议 的 IP 数据报称为 IP 安全数据报 （ 或 IPsec 数 据 报 ） ， 它 可 以 在 两

台 主机之 间 、 两个路 由 器之 间 或

台 主机和

个路 由 器之 间 发送 。

IP 安全数据报有 以 下 两 种 不 同 的 工 作 方 式 。

第

种 工 作 方式 是 运输方式(transport mode) 。 运输方式是在 整个运输层 报 文 段 的 前 后 分

别 添加 若干控制 信 息 ， 再加 上 IP 首 部 ， 构成 IP 安 全数据报 （ 见 图 7- 1 7(a ) ） 。

一

发
送
在
前

IPsec 首 部

IPsec 尾部

IPsec 首 部

可

IPsec尾部

且

IP首 部 I

IP 安 全 数 据权 的 有 效 载 荷

•

IP首 部 I
,

IP 安 全数据报

(a) 运输方式
图 7- 1 7

IP 安全数据 报 的 两 种 工 作 方 式

IP 安 全 数 据

报 的 有 效 载 荷

IP 安 全数据报

(b) 隧道方式

，

一
第 二 种 工 作 方 式是隧道方式(tunnel mode) 。 隧 道 方 式 是 在 原 始 的 IP 数 据 报 的 前 后 分 别

添加若干控制 信 息 ， 再 加 上 新 的 IP 首 部 ， 构 成

个 IP 安 全数据报 （ 见 图 7- 1 7(b ) ） 。

无论使用 哪种方式 ， 最后得 出 的 IP 安 全数据报 的 IP 首部都是不加密 的 。 只 有使用不加密
的 IP 首部 ， 互联网 中 的各个路 由 器才能识 别 IP 首部中 的有关信 息 ， 把 1P 安全数据报在不安全

•  353  •

的互联网中进行转发， 从源点安全地转发到终点。 所谓

“

安全数据报

”

是指数据报的数据部分

是经过加密的， 并能够被鉴别的。 通常把数据报的数据部分称为数据报的有效载荷(p ayload )。

由 千目前使用最多的就是隧道方式， 因此下面的讨论只限 千 隧道方式。

2. 安 全 关联

在发送 IP 安全数据报 之前， 在源实体和 目 的实体之间必须创 建

一

条网络层的逻辑连接，

即 安 全 关联 SA (S ecu r it y Assoc iat ion )。 这样， 传统的互联网中 无连接的网络层就变为 了 具有

逻辑连接的

一

个层。 安全关联是从源点到 终点的单向 连接， 它能够提供安全服务。 如要进行

双向安全通信， 则两个方向都需要建立安全关联。 假定某公司有

一

个公司总部和

一

个在外地

的分公司。 总部需要和这个分公司以及在各地出 差的 n 个员工进行双向安全通信。 在这种情
共需要创建( 2 + 2n)条安全关联SA 。 在这 些安全关联SA 上传送的就是IP 安全数据

况 下 ，

一

报 。

图7-1 8( a)是安全关联SA 的示意图。 公司总部和分公司都各有

一

个 负 责收发 IP 数据报

的路 由 器 R 1 和 民（通常就是公司总部和分公 司 的 防 火墙中的路 由器 ）， 而公 司 总部与分公
司之间的安全关联SA 就是在路 由器 R 1 和 民 之间建立的。 当然， 路 由器 民 和 民 都必须预
先装有 IPs ec 。 现假定公 司 总部的主机 凡 要和分公司的主机 儿 通过互联网进行安全通信。

公 司 总部主机 凡 发送给分公司主机 压 的 IP 数据报 ， 必须先经过公司总部的路 由器 R] 0

然 后经 IPs ec 的加密 处理后， 成为 IP 安全数据报 。 这样就把原始的 IP 数据报 隐藏在 IP 安全

数据报 中了。 IP 安全数据报经过互联网中很多路 由器的转发， 最后到达分公司的路 由 器 R 沪
路 由器 民 对 IP 安全数据报 解 密， 还 原出原始的数据报 ， 传送到 终点主机 H2。 从逻辑上看 ，

IP 安全数据报在安全关联SA 上传送， 就好 像通过

一

个安全的隧道。 这 就是

＂

”
隧道方式

这

一名词的来源。 如果总部的主机 凡 要和总部的另

一

台主机 儿 通信， 由于都在公司 内部， 不

需要加密， 因此不需要建立安全关联。 凡 发出的 IP 数据报只需通过总部内部的路 由器 R 1

一

转发

次即可送到H3。 如果 凡 要上网查看天气预报 ， 同样不需要建立安全关联， 而是发送
一

IP 数据报 ， 经过路 由器 R 1 转发到互联网中的下

个路 由 器， 最后到达互联网中预报 气 象的

服务 器。

• 354  •

- － ` 、

三

(a) 公 司总 部 与 分 公 司 的 安 全通 信

公 司总 部
三

互 联 网

:

H

(b) 公 司 总 部 与 业 务 员 的 安 全通信

图 7- 1 8 安 全关 联 SA 的 示 意 图

若 公 司 总 部 的 主机 凡 要 和 某 外地业务 员 的 便携机 压 进行 安全通信 ， 则情况将稍 有 不 同
（ 如 图 7- 1 8(b)所 示 ） 。 可 以 看 出 ， 这 时 公 司 总 部 的 路 由 器 民 和 外地业务员 的 便携 机 压 建立

安 全 关 联 SA （ 即 路 由 器和 主机之 间 的 安全 关 联 ） 。 公 司 总 部 凡 发送 的 IP 数据报 ， 通过路 由
器 民 后 ， 就变成 了 IP 安 全 数据报 。 经 过 互 联 网 中 许 多 路 由 器 的 转 发 ， 最 后 到 达 H
看 出 ， 现在是在路 由 器 民 和 业务 员 的便携机 儿 之 间 构 成 了
事 先 安 装在便携机 H

个 安 全 隧道 。 外 地业务 员 利 用
中 的 IPsec 对 IP 安全数据报进行鉴别 和 解 密 ， 还 原 凡 发来 的 IP 数 据

。 可 以

一

2

2

报 。

建 立 安 全 关 联 SA 的 路 由 器或主机 ， 必 须 维护这条 SA 的 状态 信 息 。 我们 以 图 7- 1 8 中 的

一

安 全 关 联 SA 为 例 ， 说 明 其状态 信 息应包括 的 项 目 ：

( 1 )

个 32 位 的 连接 标识 符 ， 称为安全参数 索 引 SPI (Security Parameter Index) 。

(2) 安 全 关 联 SA 的 源 点 和 终 点 的 IP 地址 （ 即 路 由 器 民 和 民 的 IP 地址 ） 。
(3) 所使用 的 加 密 类 型 （ 例 如 ， DES 或 AES ) 。
(4) 加 密 的 密 钥 。
(5) 完整 性检 查 的 类 型 （ 例 如 ， 使用 报 文摘 要 MD5 或 SHA- 1 的 报 文 鉴 别 码 MAC ) 。
(6) 鉴别 使用 的 密 钥 。

1

当 路 由 器 R

要通过 SA 发送 IP 安 全 数据 报 时 ， 就 必 须 读 取 SA 的 这些状态信 息 ， 以 便

知 道 如 何把 IP 数据报进行加 密 和 鉴别 。

3 .   I P 安全数据报的格式

一

图 7- 1 9 是 IP 安全数据报 的 格 式 。 下 面 以 隧道方式为例 ， 结 合各 字 段 的 作 用 ， 讨 论

下

IP 安 全 数据 报 是 怎 样 构 成 的 。 图 中 的 数 字 0 至 O表示 IP 安 全数据报构 成 的 先 后 顺序 。

尸芦

协 议 ＝ 50

IP 安全数据报

IP 安 全 数 据 报 的 有 效 载 荷

O 鉴别 的 部 分

＠ 加 密 的 部分（填充为 4 字节 的 倍数）

国气”; 10 报立

lj 码

32 位

图 7- 1 9

IP 安全数据 报 的 格式

一

0 首 先 在 原 始 的 IP 数 据 报 （ 也就 是 ESP 的 有 效载荷 ） 后 面添加 ESP 尾 部 。 ESP 尾部
个字段是填充字段 ， 用 全 0 填 充 。 第 二个字段是填充长度 ( 8 位 ） ， 指 出

有三个字段 。 第

一

填充字段 的 字节 数 。 为 什 么 要进行填充 呢 ？ 这 是 因 为在进行数据 加 密 时 ， 通常都要 求数据块
长度是若干字节 （ 例 如 ， 4 字 节 ） 的 整数倍 。 当 IP 数据报长度不满足此条件时 ， 就必 须用 0
一
进 行 填 充 。 每 个 0 为
个 字 节 长 。 虽 然 填 充 长度 ( 8 位 ） 的 最 大 值 是 25 5 , 但 实 际 上 ， 填 充
很 少 会 用 到 这个 最 大 值 。 ESP 尾部最后
( 8 位 ） 。 这个字段 的 值指
明 ， 在接收端 ， ESP 的 有 效 载荷应交给哪个协议来处理 。 如 图 7- 1 9 所示 ，

IP 安 全数据报有

个 字 段 是

个 首 部

下

一

“

”

•  3 55  •

三个首部。 现在E SP 尾部中的

“

“

首部

, IP 的协议值是 4 , 因此

运 输方式， 则

“
E SP 的有效载荷

”

下
“

一

“

个首部

一

个首部

下

显然就是指E SP 的有 效载荷中的
“

应填入的数值是 4 。 如果不是隧道方式而是

“

原始的 IP

就 应当是TCP 或 UDP 报文段，

“

一

下

个首部

”

的值也要

改为另外的数值。

＠ 按照安全关联SA 指明的加密算法和密 钥， 对

报 ） ＋E SP 尾部

“

”
（见图7- 19 中的
“

“

加 密的部分

”
) 进行加密。

“
E SP 的有效载荷 （ 即原始的 IP 数据

＠ 对

加密的部分

完成加密 后， 就 添加E SP 首部。 E SP 首部有两 个 32 位字段。 第

一

个字段存放安全 参数索引SP I。 通过同

一

个SA 的所有 IP 安全数据报 都使用同样的SP I 值。

第二个字段是序号， 鉴别要用到这个 序 号， 它用来防 止重放攻击。 请注意， 当分组重传时序

号并不重复。

0 按照SA 指明的算法和密 钥， 对

的部分

”
) 生成报文鉴 别码MAC。

“
E SP 首部 ＋ 加 密的部分

”

（ 见图7- 19 中的

＂

鉴别

© 把所生成的报文鉴别码MAC 添加在E SP 尾部的后面， 和E SP 首部、 E SP 的有效载

荷、 E SP 尾部

一

起， 构成IP 安全数据报的有效载 荷。

0 生成新的 IP 首部， 通常为 20 字节长， 和普通的 IP 数据报的首部的格式是

一

样的。

需要注意的是， 首部中的协议 字段的 值是 50 , 表明在接收端， 首部后面的有效载 荷应交给

E SP 协 议 来处理。

当分公 司 的路 由器 民 收到I P 安全数据报后， 先检查首部中的目的地址。 发现目的地址

就是 R 2 , 千是路 由器 民 就继 续处理这 个IP 安 全数据报。

路 由器 凡 找到IP 首部的协议 字段值 （ 现在是 50 )， 就把I P 首部后面的所有字段（即

IP 安全数据报的有效载荷） 都用E SP 协 议进行处理。 先检查E SP 首部中的安全 参数索引

SP L 以确定收到的数据报 属于哪

一

个安全关联SA （ 因为路 由器 R 2 可能有多个安全关联）。

路 由器 凡 接着 计算报文鉴别码MAC , 看是 否 和E SP 尾部后面添加的报文鉴别码MAC 相符。

如是， 即知收到的数据报的确是来自路 由器 R ]。 再检验E SP 首部中的序号， 以证实有无被

入侵者重放。 接着要用和这个安全关联SA 对应的加密算法和密钥， 对已加 密的部分进行解

密。 再根据E SP 尾部中的填充长度， 去 除发送端填充的所 有 O , 还 原出加密前的E SP 有 效

载 荷， 也就是 凡 发送的原始IP 数据报 。

“

一

”

根据解密后得到的E SP 尾部中

的值 （现在 是 4 )， 把E SP 的有效载荷交
给 IP 来处理。 当找到原始的 IP 首部中的目的地址是主机 压 的IP 地址时， 就把整个的IP
数据报 传送给主机H2。 整个 IP 数据报的传送过程到此结束。

个 首 部

下

请注意， 在图7- 19 的

原始的IP 首部

中， 是用主机H] 和 压 的 IP 地址分别作为源

“

“

“

“

地址和目的地址， 而在IP 安全数据报的

址分别作为源地址和目的地址 （ 这是图7-

IP 安全数据报 不经过 另

一

新的 IP 首部
中， 是使用路 由器 凡 和 民 的 IP 地
1 8 (a )所示 的情况）。 但如果是图7- 1 8 (b )所示的情况，
“

“

个 路 由器 R 2 , 那么 在IP 安全数据报 的

新的 IP 首部

中， 要用

路 由器 R ] 和主机 压 的IP 地址分别作为I P 安全数据报的源地址和 目 的地址。
一

从以上的讨论可以看出， 设想有

个 IP 安 全数据报在互联 网中被某人截获 ， 如果截获

者不知 道此安全数据报的密码， 那么 他只能知道这是

一

个从路 由器 民 发往路 由器 民 的IP

数据报 ， 但却 无法看懂其有 效载 荷中的数据含 义。 如果截获 者篡改了数据报的源地址， 那么
一

安全数据报的鉴别功能 可以保证源地址的真实性。 假定截获者故意删 除了安全数据报 中的

些字节， 但 由于接收端的路 由器 凡 能够进行完整性检验， 就不会接收这种含有差 错的信息。

• 356  •

如果截获者试图进行重放攻击， 那么 由 千安 全数据报 使用了有效的序号， 使得重放攻击也 无

法得逞。

4 .   I Psec 的其他构件

前面 已经提到过， 发送 IP 安全数据报的实体可能要用到很多条安全关联SA 。 那么 这 些
一

个重要构件， 叫作安 全 关联 数 据 库 SA D
SA 存放在什么 地方呢？这 就要 提及 IPsec 的
(Secu r it y Associat ion  Data ba se)。 所有需要运行 IPsec 的站点都必须有SA D。 当主机要发送 IP
安 全数据报时， 就要在SA D 中查找相应的SA , 以便获得必要的信息， 来对该 IP 安全数据

报 实施安全保护。 同样， 当主机要接收 IP 安 全数据报 时， 也要在SA D 中查找相应的SA ,

以便获得信息来检查该分组的安全性。

前面 已经提到了， 主机所发送的数据报 并 非都 必 须进行加密， 很多信息使用普通的数

据报 用明文发送即可。 因此， 除 了 安全关联数据库SA D, 还需要另

一

个数据库， 这 就是 安

全策略数据库SP D (S ecu r it y Poli c y  Da ta b ase)。 SP D 指明什么 样的数据报 需要进行 IPs ec 处理。

这取决千源地址、 源端 口 、 目的地址 、 目的端 口 ， 以及协议的类型等。 因此， 当

一

个 IP 数

据报到达时， SP D 指出应 当 做 什么（使用IP 安全数据报 还是不使用）， 而SA D 则指出， 如

果需要使用 IP 安全数据报， 应 当 怎样做 （ 使用哪

一

个SA )。

一

个问题， 安 全关联数据库 SA D 中存放的许多安全关联SA 是怎样建立起来的呢？

还有
一

如果

个虚拟专用网 VPN 只有 几个路 由器和主机， 那么 用人工键入的方法就可以建立起所

需的安全关联数据库SA D。 但如果

一

个 VPN 有好 几百 或 几 千个 路 由器和主机， 人 工键入的

方法显然是不行的。 因此， 对千大型的 、 地理位 置分 散的系统， 为 了 创 建 SA D , 我们需要

使用自动生成的机制， 即使用互联网密钥交换 IKE (Int ernet  Ke y E xc h an ge)协议。 IKE 的用途
就是为IP 安全数据报 创 建安全关联SA 。

IKE 是个非 常 复杂的协议，

IKE v2 是其新的版本， 在 201 4年10 月已成为互联网的正式

标 准[ RFC7 29 6 , ST D79 ]。 IKE v2 以另外三个协议为基础 ：

( 1) Oa kle y  是个 密 钥 生成协议[RFC 241 2]。

( 2) 安全密钥交换机制S KE ME (Secu re  Ke y Exc h an ge  ME c ha nism) ——是用于密钥交换

的协议。 它利用公钥加密 来实 现 密 钥 交换协议中的实 体 鉴别。

(3) 互联网安全关联和密钥管理协议 ISAKMP( Inte rnet Secu re  Associa ti on a nd  Ke y Ma na geme nt
用于实现 IKE 中定义的密 钥交换， 使I KE 的交换能够以标准化、 格式化的报

P rot oc ol)

文创建安全关联SA 。

关于 IKE 的深入介绍可参 阅 有关文档， 如 RFC 49 45 和 RFC7427 （ 都是建议标 准）。

7 . 5 .2  运输层 安全协议

1

. 协议 TLS 的要点

当 万维网能够 提 供网上购物时， 安 全问题就 马上被提到 桌面上来了。 例如， 当 顾客在

不安全的互联网上购物时， 他会要求得到 下 列安 全服务 ：

(

1 ) 顾 客需要确保服务器属 千 真 正 的 销 售商， 而不是某 个 冒 充者。 这就是应对 身份进行

鉴别。

(2 ) 顾客与销 售商需要确保报文的内容（例如账单） 在传输过程中没有被篡改。 这就是

• 357  •

应保证通信 内 容 的 数据完整性 。

(3) 顾 客 与 销 售 商 需 要 确 保诸 如 信 用 卡上 的 敏感信 息 不被泄露 。 这就是要有机密性 。
不 仅 在 电 子 商 务 领 域 ， 即 使在 我 们 日 常 上 网 浏 览 各 种 信 息 时 ， 我们 所 浏 览 的 信 息 也 是
属 于个 人 隐 私 ， 不 应 作 为 网 上 的 公开 信 息 。 因 此 ， 在 很 多 情 况 下 ， 客 户 端 （ 浏 览 器 ） 与服务
器 之 间 的 通信 需 要 使 用 安 全 的 运输层 协 议 。 曾 经广泛使用 的 运输层 安 全 协议有两个 ， 即 ：
安全套接字层 SSL (Secure Socket Layer) 。
（2) 运输层 安全 TLS (Transport Layer Security) 。

（ 1 )

协议 SSL 是 Netscape 公 司 在 1 994 年开发 的 安全协议 ， 广泛应用 于 基 于 万 维 网 的 各 种 网
络应用 （ 但不 限 于 万维 网 应 用 ） 。 SSL 作 用 在端 系 统应用 层 的 HTTP 和 运输层之 间 ， 在 TCP

一

之上建立起

个安全通道 ， 为通过 TCP 传 输 的 应 用 层数据提供安全保障 。
1 995 年 Netscape 公 司 把协议 S SL 转交给 IETF , 希望 能够把 SSL 进行标准化 。

1 999 年

IETF 在 SSL 3 .0 的 基础上设计 了 协议 TLS 1 .0 （ 改动 极少 ） ， 为所有基千 TCP 的 网 络应用 提供
安 全 数 据 传 输 服 务 。 为 了 应对 网 络 安 全 的 变 化 ，
IETF 及 时 地对 TLS 的 版本 进 行 升 级 ， 如
2006 年 的 TLS 1 . 1 ,   2008 年 的 TLS 1 .2 。 20 1 4 年 1 0 月 ， 谷歌建议禁用 SSL 3 .0 , 因 为其设计上
有漏洞 ， 用 户 的敏感信 息有被窃 取 的 可 能 。 接着 ， Mozilla 和微软也发 出 了 同 样 的 安全通告 。
20 1 8 年 8 月 IETF 发布 了 经历 了 28 个草案后才通过的最新版本 TLS 1 .3  [RFC  8446 , 建议标准］
（ 不 向 后 兼 容 ） 。 在 2020 年 ， 旧 版本 TLS 1 .0/1 . 1 均被废弃 。 目 前谷歌浏 览 器 Chrome 和 火狐
浏 览器 Firefox 都 已开始使用 更加 安 全 的协议 TLS 1 .3 , 但不少 老客户 端仍未抛弃
些 旧 版本 。
应 当 说 ， 到 目 前 为止协议 TLS 1 .2 还 是安全可用 的 ， 只 是被发现 了 有潜在 的 安 全 隐 患 。 因 此 ，
现在能够使用 的 运输层 安 全协议就 只 剩 下协议 TLS 1 .2 和协议 TLS 1 .3 了 。

一

“

协议 TLS 的 位置在运输层和应用 层 之 间 （ 如 图 7-20 所示 ） 。 虽然协议 SSL 2 .0/3 .0 均 已
SSL/TLS " 视 为 TLS 的 同 义 词 。 这 是 因 为协议

被 废 弃 不 用 了 ， 但 现 在 还 经 常 能 够 看 到 把
TLS 本来就源千 SSL （ 但 并 不 兼 容 ） ， 而现在 旧 协 议 SSL 被更新为新协议 TLS 。

I

|

应用程序
TLS  （ 或 SSl/TLS )

TCP

IP
图 7-20 协 议 TLS 位千运输层和 应 用 层 之 间

应 用 层 使 用 协 议 TLS 最 多 的 就 是 HTTP , 但 并 非 仅 限 千 HTTP 。 因 为 协议 TLS 是 对
TCP 加 密 ， 因 此任何在 TCP 之上运 行 的 应 用 程序 都 可 以 使用 协议 TLS 。 例 如 ， 用 于 IMAP
邮 件存取 的 鉴 别 和 数 据 加 密 也 可 以 使 用 TLS 。 TLS 提供 了
个 简 单 的 带 有 套 接 字 的 应 用 程
序接 口 API ， 这和 TCP 的 API 是 相 似 的 。

一

当 不 需 要运输层 安 全协议 时 ， HTTP 就直接使用 TCP 连接 ， 这 时 协 议 TLS 不起作用 。

由 于 需 要 使 用 运输层 安 全协 议 的 人越来越 多 ， 因 此现在相 当 多 的 网 站 已 是全站使用 运输层 安
全 协 议 。 例 如 ， 当 我 们 使 用 百 度 网 站 浏 览 信 息 时 ， 在 浏 览 器 的 地 址 栏 键 入 其 官 网 地 址
www.baidu.com 后 （ 不 必 在 前面键入 http :／／或 https:// ) ， 就可 以 在屏幕上看到这样 的 响 应 ：

屾 匡tps://wv.. f\ft/.baidu.

com

可 以 看 出 ， 尽 管 用 户 在 浏 览 器 上 没 有 键 入 https:// , 但 百 度 网 站 总 是 提 供 安 全 的 运输 层
服 务 。 提供安 全运输层 服 务 的 标 志 是地址栏 URL 中 的 协 议 部 分 显 示 出 的 是 https , 并且在 其

•  358 •

一

个 安全锁 妯 的 标 志 。 在 http 后 面加 上 的 s 代 表 security , 表 明 是使 用 HTTPS , 即
左 边还有
提供安全服务的 HTTP 协议 ( TCP 的 HTTPS 端 口 号 是 443 , 而不 是 HTTP 使用 的端 口 号 80 ) 。
这 时 我 们 就 可 以 放 心 和 这 样 的 网 站进行通信 ， 因 为这 个 网 站 已 经 被 鉴 别 了 是真 正 的 百 度 网 站 ，

并 且 之 后 在 浏 览 器 和 百度服务器之 间 的所有 交 互 报 文 都 是 加 密 的 ， 因 而通信 的 机 密 性 得 到 了
”

“

保证 。

现 在 我 们 使 用 某 些 主 流 浏 览 器访 问 不 安 全 的 网 站 时 ， 浏 览 器 会 向 用 户 发 出
”

的 警 告 。 下 面给 出 当 我们 键入 桔梗 网 的 网 址 shu.j iegeng.com 后 所看 到 的 响 应 ：

“

不 安 全

谷 歌 Chrome 浏 览器指 出

不 安 全

不安主

shu.jfegeng.com

火狐 Firefox 浏 览 器提示无安全锁
©  /;J  shu jiegeng.com

这就提醒我们 在 上 网 时要注 意 信 息 的 安 全 。

一

协 议 TLS 具 有 双 向 鉴 别 的 功 能 。 但 大 多 数 情 况 下 使 用 的 是 单 向 鉴 别 ， 即 客 户 端 （ 浏 览
器 ） 需 要 鉴 别 服务器 。 也 就 是 说 ， 浏 览 器 A 要 确 信 即 将访 问 的 网 站 服务器 B 是 安 全 和 可 信
的 。 这 必 须 要 有 两 个 前提 。 首 先 ， 服务器 B 必 须 能够 证 明 本 身 是 安 全 和 可 信 的 。 因 此服务
个证书来证 明 自 己 。 现在我们假 定 服 务 器 B 已 经持有 了 有 效 的 CA 证 书 。 这
器 B 需 要 有
一
正 是运输层 安 全协议 TLS 的 基 石 。 其 次 ， 浏 览器 A 应具 有
些手段来证 明 服务器 B 是安 全
和 可信 的 。 下 面就来讨论这

一

点 。

生 产 电脑操作 系 统 的 厂 商 为 了 方便 用 户 ， 把 当 前 获 得 公 众信 任 的 许 多 主 流认证 中 心 CA
的根证书 ， 都 已 内 置在其操 作 系 统 中 。 这些根证 书 上 都有认证 中 心 CA 的 公钥 PKCA ， 而 且
根 证 书 都 用 CA 的 私 钥 SKcA 进 行 了 自 签 名 （ 防止伪造 ） 。 用 户 为 了 验证要访 问 的服务器是否
安 全 和 可 信 ， 只 要 打 开 电 脑 中 的 浏 览器 （ 操作 系 统 自 带 的 或用 户 自 己 装 上 的 ） ， 就 可 查 到 操
作 系 统 收 藏 的 某 个根认证 中 心 的 根 CA 证 书 ， 并 可 以 利 用 证书 上 的 公钥 PKcA 对 B 的 证 书 进
行验证 。 若 服 务器 B 的 证 书 是证 书 链 上 的 某 个 中 间 CA 签 发 的 ， 那 么 浏 览 器 A 也 可 用 类似
方法验证 B 的 证 书 的 真 实 性 。

－

“

”

由 千 浏 览 器 与 服 务 器 的 通 信 方 式 就 是 以 前 讲 过 的

客 户

服 务 器 方 式

， 因 此 下 面 就 用

客 户 代 表 浏 览 器 。

如 图 7-2 1 所示 ， 在 客 户 与服务 器双方 已 经建立 了 TCP 连接后 ， 就可开始执行协议 TLS 。
根据 RFC 8446 , 这 里 主 要 有 两 个 阶 段 ， 即 握手阶段和 会话阶段 。 在 握 手 阶 段 ， TLS 使 用 其
中 的 握手协议 ， 而 在 会话阶段 ， TLS 使用 其 中 的 记 录 协 议 。 下 面讨 论 协议 TLS 的 要 点 。

B

服 务 器

客 户 A

l

＠ 用 CA 的 公 钥
鉴 别 B 的 证 书
MS

握 手 协 议

产生主密钥

I  O
t

＠ 生成会话密钥

k

SKB(P凡(MS)) = MS
0 用 B 的 私 钥 解密

＠ 生成会话密钥

记录协 议

数据传输 （ 保密 ， 完整性 ）

图 7-2 1 TLS 建立安全会话 的 工 作 原 理

•  359 •

我们 先 介 绍 协 议 TLS 的 握 手 阶 段 。 握手 阶 段 要 验 证 服 务 器 是 安 全 可信 的 ， 同 时 生成在

后 面 的 会话阶段所 需 的 共 享 密 钥 ， 以 保证双方交换 的 数 据 的 私 密 性 和 完 整 性 。 这里 要 提 醒 读
者 ， 在 刚 开始执行协议 TLS 时 ， 通信双方 的 信 道 是 不 安 全 的 。 因 此要 弄 清 ：
（ 1 ) 双方怎样通
过 不 安 全 的 信 道 得 到 会 话 时 所 需 的 共 享 密 钥 。 这 里 没 有 采 用 密 钥 分 发 中 心 KDC 来分配密钥 ，
而 是 采 用 自 己生成共享 密钥 的 方 法 。

(2) 用 什 么 方法保证所传送数据 的 机 密 性 与 完 整 性 。

一

一

下 ， 从 TLS 1 .0 更新到 1 . 1 和 1 .2 版本 时 ， 每

( 1 ) 协商加 密算法 O 客 户 A 向 服务器 B 发送 自 己 选 定 的 加 密 算 法 （ 包括 密 钥 交 换 算
法 ） 。 ＠服务器 B 从 中 确 认 自 己 所 支持 的 算法 ， 同 时 把 自 己 的 CA 数 字 证 书 发送给 A 。 这 里
次更新都增 加 了 当 时 认 为 是 更 加 安

要 说 明
全 可 靠 的 加 密 算法 。 为 了 协 议 的 向 后 兼容 ， 对老版本 中 的 不 太 安 全 的 数十种算法也都保 留 下
来 了 。 这就造成协商过程 非 常 耗 时 ， 需 要 花 费 2 倍 RTT 的 时 间 （ 通常记为 2-RTT ) 。 因 此最
新 的 TLS 1 .3 版本把陈 旧 的 很 多 种 算法统统取消 （ 例 如 MD5, SHA- I ,  DES,  3DES 等 ） ， 只 留
下 几种 最 安 全 的 算 法 。 客 户 不 是 把 自 己所有 的 加 密 算法 都 告 诉服务器 ， 供服务器来挑选 ， 而
是 猜 测 服 务 器 可 能愿 意 使 用 什 么 加 密 算法 ， 把 自 己选定 的 加 密 算法直接发送给服务器 ， 让服
务器来确 认 。 这就把 “ 协商

时 间 缩 短为 1 -RTT 。

”

(2) 服务器鉴别
(3) 生成主密钥

© 客 户 A 用 数字证 书 中 CA 的 公 钥对数字 证 书进行验证鉴 别 。
B
O 客户 A 按照双方确 定 的密钥交换算法生成主密钥 MS (Master Secret) 。
(MS) ， 发送给服务器

对 主 密 钥 MS 加 密 ， 得 出 加 密 的 主 密 钥 PK

一

B

© 客户 A 用 B 的 公钥 PK
B 。 请注 意 ， 在 有 关 TLS 的 文档 中 ， 密 钥

词 使 用 的 是 Secret , 而 不 是 Key 。

(4) 服务器 B 用 自 己 的 私 钥 把主 密 钥解 密 出 来 ： SKs(PK叭MS)) = MS 。 这样 ， 客 户 A 和

服务器 B 都拥 有 了 为后 面 的 数据传输使用 的 共 同 的 主密钥 M S 。

一

(5) 为 了 使双 方 的 通 信 更加 安 全 ， 客 户 A 和服务器 B 最好使用 不 同 的密 钥 。 千是主密钥
方

被分割成 4 个 不 同 的 密 钥 ， 这就是 图 7-2 1 中 的 ＠ 和 0 ： 生成会话密钥 。 在这 以 后 ， 每
都拥 有这样 4 个密 钥 （ 请注 意 ， 这些都 是对称密钥 ， 即 加 密 和 解 密 用 的 是 同

个 密 钥 ） ：

一

A

•  客 户 A 发送数据 时使用 的 会 话 密 钥 K
B
•  客 户 A 发送数据 时 使 用 的 MAC 密 钥 M

A

B

•  服务器 B 发送数据 时 使用 的 会话密钥 K
•  服务器 B 发送数据 时 使 用 的 MAC 密 钥 M
会话密钥 不使用 非对称密 钥 ， 因 为 对称密钥 的 运行速度快得 多 （ 相 差 3 个数量级 ） 。
下 面讨 论 协 议 TLS 的 会话阶段 。 会话阶段要保证传送数据 的 机 密 性 和 完 整 性 。
客 户 或 服 务 器 在 发 送 数 据 时 ， 都 把 长 的 数据 划 分 为 较 小 的 数 据 块 ， 叫 作 记 录 (record) 。

一

一

一
个记录进行 鉴 别 运 算 和 加 密 运算 。 为 了 防 止入侵者 截取传输 中 的 记录 ， 或颠倒记

然 后 对 每
录 的 前 后 顺 序 ， TLS 的 记 录 协 议 对 每
个记录作为 0 号 记录 。 发送 下
允 许 序 号绕 回 。 然 而 此序 号 并 非 写 在 记录之 中 ， 而 是在进行散列运算时 ， 把序号包含进去 。
例 如 ， 当 客 户 A 向 服务 器 B 发送

个记录时序号就加 1 , 但序 号 最 大 值 不得超过 2
A

个记录按 发送顺序 赋 予 序 号 ， 把每

方 发 送 的 第

和该记录当

- 1 , 且 不

一

一

一

一

64

个 明 文记 录 时 ， 客 户 A 先把 MAC 密 钥 M
A

前 的 序 号

起拼接在此 明 文记 录 之 后 ， 然 后 进 行 散 列 运 算 ， 得 出 MAC 。 再 把得 出 的 MAC
进 行 加 密 ， 发 送 给 服 务 器 B 。 B 使用 同 样 的会话密钥

和 明 文 记录拼接起来 ， 用 会话 密 钥 K
趴 进行 解 密 ， 然 后 分 离 出 明 文 记录和 MAC 。 B 再把 同 样 的 MAC 密钥 M
序号拼接在此 明 文记录之后 ， 进行散列 运算 ， 看得 出 的 结 果 与 前 面得 出 的 MAC 值 是 否
致 ，
以 鉴 别 收 到 的 明 文 记 录 的 完 整 性 （ 内 容和 顺 序 均 无误 ） 。 上述对记录 加 密 的 方法称为 AEAD

和该记录应 有 的

一

A

•  360  •

(Authenticated Encryption with Associated Data) ， 即 带 关联数据的 鉴 别 加 密 。

实 际上 ， 客户 A 所 发 送 的 加 密 的 记 录 的 前 面 ， 还 必 须 添 加 三 个 不 加 密 的 字 段 ， 图 7-22
一
给 出 了 这三个字段 的 位置 。 类 型 字段指 明 所传送 的记录 出 握 手 阶段 的 报 文 ， 还是应用 程序传
送 的 报 文 ， 或 最后 要 关 闭 TLS 连接 的 报 文 （ 下

小 节将要解释 ） 。 长度字段给 出 的 字 节 数 可

用 来从 TCP 报 文 中 提取 TLS 记录 。

` 1

版 本

A
对 这 部 分用 K

—
加 密
1长度厂｀：勹:;
豆已

图 7-22 TLS 传 送 的记录格式

2 . 协议 TLS 必须包含的措施

以 上介 绍 的 只 是协议 TLS 的 要 点 。 但 若 仅 仅 是 这 样 ， 还 不 能 提 供 足 够 的 安 全 。 因 此 ，

一

对 前 面 图 7-2 1 所 示 的 双 方 的 握手阶段 ， 需 要 补 充

些措 施 。

( 1 ) 在 客 户 A 向 服 务 器 B 发送 自 己选定 的 加 密 算法 （ 包括密钥 交换算法 ） 时 ， 还 要 向
服 务 器 B 发送客户 的 不 重 数 。 服务器 B 从 中 确认 自 己 所 支 持 的 算法 ， 同 时 把 自 己 的 CA 数
字 证 书 和 服 务 器 的 不重数发送给客户 A 。

一

(2) 生成预主密钥

客 户 A 验证 了 服 务 器 B 的 数 字 证 书 后 ， 生 成 为 下

B

钥 使 用 的 预主密钥 PMS (Pre-Master  Secret) ， 并用 B 的 公 钥 PK

B

步 生 成 主 密
对 预 主 密 钥 PMS 加 密 ， 把

加 密 的 预主 密 钥 PK8(PMS)发送给服务器 B 。 B 用 其私 钥 SK
这样 ， 客 户 A 和 服 务 器 B 都 拥 有 了 为后 面 的 数据传输使用 的 共 同 的 预主密钥 PMS 。

进行解密 ， 得 出 预主 密 钥 PMS 。

(3) 生成主密钥

客 户 A 和 服务 器 B 各 自 使 用 同 样 的 （ 已 商 定 的 ） 算法 ， 使用 预�
密 钥 PMS 以 及 客 户 的 不 重 数 和 服 务 器 的 不 重 数 ， 生 成 主密钥 MS 。 然 后 再将 其 划 分 为 4 个
方在 发送数据 时使用 的会话密钥和 MAC 密

一

密钥 。 千 是 A 和 B 各拥 有 相 同 的 4 个密 钥 （ 每
钥 ） 。

一

(4) 客 户 A 向 服务器 B 发送 的 全 部 握 手 阶段报文 的 MAC 。
(5) 服 务器 B 向 客户 A 发送 的 全部握手阶段报 文 的 MAC 。
上述最后 的(4)和(5) 的 作 用 是 这样 的 。 在 A 向 B 发送加 密 的 预 主 密 钥 之前 的 握 手 信 息 是
没 有 加 密 的 明 文 ， 因 此 可 能 受 到 入 侵 者 的 篡 改 。 现在 A 和 B 都 各 自 对 全 部 握 手 阶 段 的 报 文
计 算 了 散列 值 MAC 。 如 果入侵者 篡 改 了 处在传输过程 中 的 某 个 报 文 ， 那 么 上面(4)和(5)所得
“
一
致 。 这样 A 或 B 就 可 以 立 即 中 止 当 前 的 连接 。
出 的 MAC 值 必 然 不
一

个仅使用

在 ( 1 ) 中 客户 和 服务 器 各 产 生

次 的 不 重 数 ， 其 目 的 是为 了 防 止

重放攻击
设 想 在 A 和 B 之 间 有
个入侵 者 ， 他截 获 了 A 和 B 交 互 的 全部报文 。 虽然他未能解密 A 和
B 交互 的 具体 内 容 ， 但他可 以 在 以 后 的 某 日 ， 重 新 按 照 原 来 的 顺 序 依 次 发送 给 B 。 如 果 没有
一
使 用 上述 的 不 重 数 ， 那 么 B 无 法 发 现 这 是入 侵 者 重 放 旧 的 报 文 。 B 也 将 和 前 次 的 握 手 过 程
样 ， 向 A 发 回 报文 （ 实 际上 是 发给 了 中 间 人入侵者 ） 。 这样 造成 的 后 果 是很 严重 的 。 但 使
个不 同 的 不 重 数 。 这样就有

个 TCP 连接 中 ， 客 户 A 必 须使用 另

一

一

一

”

用 了 不 重数 以 后 ， 在 下
效 地 防 止 了 重 放攻击 。

。

前 面 曾 提到 在 关 闭 TLS 连接之 前 ， A 或 B 应 当 先 发 送 关 闭 TLS 的 记 录 ， 目 的 是 防 止 入
侵 者 的 截断攻击(truncation attack) 。 所 谓 截 断攻击就是在 A 和 B 正 在 进 行 会话 时 ， 入 侵 者 突
个 要 关 闭 TLS
然 发送 TCP 的 FIN 报 文段来关 闭 TCP 连接 。 但 如 果 A 或 B 没 有 事 先 发 送

一

•  3 6 1   •

的 记 录 ， 那 么 A 或 B 见到 TCP 的 FIN 报 文 段 时 ， 就知道这是入侵者 的 截 断攻击 了 。 入 侵 者

无法伪 造 关 闭 TLS 的 记 录 ， 因 为 虽然 记 录 前面 的 三个字段都是 明 文 ， 但 每 个记录 的 内 容 是

加 密 的 ， 并 有 MAC 保证其完整性 的 。

在 TLS 1 .3 中 使 用 了 更 加 安 全 的 椭 圆 曲 线 密 码 ECC (Elliptic  Curve  Cryptography) 与
AES , 使运算速度 比 旧 的 1 .2 版本有 了 很大 的提 高 。 TLS 1 .3 还 添加 了 0-RTT 的 功 能 。 这就
是 说 ， 如 果 客 户 之 前连接过某服务器 ， TLS 1 .3 通过储存 先 前会 话 的秘密 信 息 ， 不 需 要经过
1 -RTT 的握手过程 ， 仅 需 0-RTT 即 可开始会话阶段 ， 这样就更加 提 高 了 TLS 的 效率 。 当 然 ，

这样做 必 须要 防止 可 能 发 生 的 重 放攻击 。
7.5.3  应用 层 安全协 议

一

限 于 篇 幅 ， 我们在这
电 子 邮 件 在 传 送 过 程 中 可 能 要 经 过 许 多 路 由 器 ， 其 中 的 任 何
发 的 邮件 进 行 阅 读 。 从这个 意 义 上讲 ， 电 子 邮件是没有什么 隐 私 可 言 的 。

节 仅 讨 论应用 层 中 有 关 电子 邮件 的 安 全协议 。

一

个 路 由 器 都 有 可 能 对 转

电 子 邮 件 这 种 网 络 应 用 也 有 其 很 特殊 的 地 方 ， 这 就 是 发 送 电 子 邮 件 是 个 即 时 的 行 为 。

一

一

这 种 行 为在本质 上 与 我们 前两 节 所讨 论 的 不 同 。 当 我们 使 用 IPSec 或 SSL 时 ， 我们假设双
个 会 话 并 双 向 地 交换数据 。 而 在 电 子 邮件 中 没有 会话存在 。 当 A 向
方在 相 互之 间 建 立 起
B 发送
个 电 子 邮件 时 ， A 和 B 并不会为此而建立任何会话 。 而在此后 的 某 个 时 间 ， 如 果 B
读 取 了 该 邮件 ， 他 有 可 能 会 、 也 有 可 能 不会 回 复这个 邮件 。 可见我们所讨 论 的 是单 向报文的
安全 问 题 。

一

如 果 说 电 子 邮 件 是 即 时 的 行 为 ， 那 么 发 送 方 与 接 收 方 如 何 才 能 就 用 于 电 子 邮 件 安 全 的
致 意 见 呢 ？ 如 果 双 方 之 间 不 存 在 会 话 ， 不 存 在 协 商 加 密／解密 所 使 用 的 算 法 ，

加 密 算 法达成
那 么 接 收方 如 何 知 道 发送 方选择 了 哪 种 算法 呢 ？

要 解 决这个 问 题 ， 电 子 邮 件 的 安 全 协 议 就 应 当 为 每 种 加 密 操 作 定 义相 应 的 算法 ， 以 便

用 户 在 其系 统 中 使用 。 A 必 须要把使用 的 算 法 的 名 称 （ 或标 识 ） 包含在 电 子 邮件 中 。 例 如 ，
A 可 以选择用 AES 进行 加 密／解密 ， 并选择用 SHA- 1 作 为 报 文 摘 要 算 法 。 当 A 向 B 发送 电
子 邮件 时 ， 就在 自 己 的 邮件 中 包 含 与 AES 和 SHA- 1 相 对应 的 标 识 。 B 在 接 收 到 该 邮件后 ，

首 先 要提取这些标识 ， 然 后 就 能 知 道 在 解 密 和 报 文 摘 要运算 时 应 当 分别 使用 哪 种 算法 了 。

一

一

加 密 算 法 在 使 用 加 密 密 钥 时 也 存 在 同 样 的 问 题 。 如 果 没 有 协 商 过程 ， 通 信 的 双 方 如 何
在彼此之 间 知 道所使用 的 密 钥 ？ 目 前 的 电 子 邮件 安 全协议要求使用 对称密钥算法进行加密和
个 密 钥 并 把 它 与
解 密 ， 并 且 这 个
起发送给 B 。 为 了 保 护 密 钥 不 被 外 人 截 获 ， 这 个 密 钥 需 要 用 收信 人 B 的 公 钥 进 行 加
报 文
密 。 总 之 ， 这个密钥本 身 也 要被加密 。

起 发送 。 发 信 人 A 可 以 生 成

次 性 的 密 钥 要 跟 随 报 文

一

一

一

还 有

个 问 题 也 需 要 考虑 。 很 显 然 ， 要 实 现 电 子 邮 件 的 安 全 就 必 须 使 用 某 些 公 钥 算 法 。
例 如 ， 我们 需 要 对 密 钥 加 密 或 者 对 邮 件 签名 。 为 了 对密 钥 进 行 加 密 ， 发 信 人 A 就 需 要 收信

一

人 B 的 公钥 ， 同 样为 了 验证被签名 的 报文 ， 收信人 B 也 需要 发 信 人 A 的 公 钥 。 因 此 ， 为 了

个 具 有 鉴 别 和 保 密 的 报文 ， 就 需 要 用 到 两 个 公 钥 。 但 是 A 如 何才 能确 认 B 的 公 钥 ，

发 送
B 又如 何才 能 确 认 A 的 公 钥 呢 ？ 不 同 的 电子 邮件 安 全 协 议有 不 同 的 方法来验证密 钥 。
而

一

下 面我们 介 绍 在应用 层 为 电 子 邮件提供 安 全 服 务 的 协 议 PGP 。
PGP  (Pretty  Good  Privacy)是 Zimme

ann 千 1 995 年 开发 的 。 它 是

个 完 整 的 电子 邮件

安 全 软件 包 ， 包 括加 密 、 鉴 别 、 电 子 签 名 和 压缩 等 技术 。 PGP 并 没 有 使 用 什 么 新 的 概念 ，

•  362  •

一

些加密 算 法 （ 如 RSA 公钥加密算法或 M D5 报文摘要算法） 综合在

起
它只是把现有的
而已。 由千包括源程序的整个软件包可以从互联网免费下 载[W -P GP]， 因此PGP 在MS -DO S /
W i nd ows 以 及 UN IX 等平 台 上得到了 广泛的应用。 现在PGP 的网站以每 个月 百 万页的规模，
为

百多个国家的用 户 提 供服 务 。
后 来PGP 公 司 与 Zimm ennann 同意 IE TF 制定P GP 的公开互联 网标准Op enP GP 。 2007

一

一

年 IE TF 发布 了Op enPGP 的建议标准[RFC4 880]。

PGP 的工作原 理并不 复 杂 。 它 提 供电子邮件的安全性、 发送方鉴别和报 文完整性。
假定A 向 B 发送 电 子邮 件明文 X, 现在用PGP 进行加 密。 A 有三 个 密 钥 ： 自己 的 私 钥
次性 密 钥 K。 B 有两 个 密 钥 ： 自 己的私钥S KB 和A 的公

S KA , B 的公钥P KB 和自 己生成 的

一

钥P K炉

A 需要做以 下 几 件事 （ 如 图 7 -23所示）。

,

l

@ A 生成

图 7-23 在 发送 方 A 的 PGP 处理过程

0 用A 的私 钥S KA 对 明文 邮 件 X进行签名。 把签 名 拼接在明文邮件 X 后 面。

一

＠ 利用随机数A 生 成
＠ 用A 生成的
0 用 B 的公钥P KB 对A 生成的
一

一

次性 密 钥 K （ 共享的对 称 密 钥）。

次性 密 钥 K 对已 签 名 的邮件加密。

一

次性 密 钥 K 进行加 密。

© 把已加密的
请注意， 图 7 -23 中 三个

次性密钥和 已加 密的签 名 邮件， 拼接在
一

“

＂

加密

的作用是不同的。 第

一

起发送给 B 。

次加密是用A 的私钥S KA 对明

文邮件的报 文摘要进行加 密， 即进行数字签名， 目的是保证邮件的完整性。 第二 次加 密是用

一

A 生成的
B 的公钥P KB 对A 的

次性 密 钥 K 对已 签 名的 邮件加密， 目的是保证邮件的机 密性。 第三次加 密是用

一

次性 密 钥 K 加密， 目的是保证对 称 密 钥 K 的机 密性。

B 收到A 发过 来的报 文后要做以 下 几件事 （ 建议读 者自行画出相应的图， 这里从略） ：
(1 ) 在文档 RFC 4 880 中， 对加密邮件的各种格式 （ 如仅加密但不鉴别， 或仅鉴 别但不

加 密， 或加密加上 鉴别）， 均 有 详 细的规定。 因此 B 可以根据邮件的种类， 准确地把 已加密

一

的

次性 密 钥和已 加 密的 签 名报 文 分离开。

( 2) 用 B 私钥S KB 解出

一

次性 密 钥 K （ 这是对称 密 钥， 加密和解密都 需要各 使用

一

次）。

(3) 用 导 出的

一

字 签 名。

次性 密 钥 K 对 加 密的签 名 邮件进行解密， 分离出明 文邮件 X 和A 的数

(4 ) 用 B 手中的A 的公 钥P KA 对A 的数字签 名进行解密。 然后即可接着验证邮件的完

整性， 具体 的做法与前面图7 -9 所 述 的 相似， 这里不 再 重 复。

在 PGP 中， 发件方和收件方是如何获 得对方的公 钥 呢？ 当 然， 最安全的 办 法 是 双方面

对面直接交换公钥， 但在大多数情况下 这并不现实。 因此可以通过认证中心CA 签发的证书

来验证公 钥持有者的合法 身份。 然而在PGP 中不要求使用CA , 而是允许用

一

种第三方签署

的方式来解决该问题。 例如， 如果用户A 和用户 B 分别和第三方C 已经确认对方拥有的公

• 363 •

钥 属 实， 则C 可以用其私钥分别对A 和 B 的公钥进行签 名， 为这 两个公 钥进行担 保 。 当A

一

得到

个经C 签 名的 B 的公钥时， 可以用已确认的C 的公钥对 B 的公 钥 进行 鉴 别 。 不过，

用户发布其公钥的最常见的方式还是把公钥发布在他们的个人网页上， 或仅仅通过电子邮件

进行分发 。

P GP 很难被攻破 。 因此在 目 前 可以认为PGP 是足够安全的 。

7 . 6   系统安全 ： 防火墙与 入侵检测

恶 意用户或软件通过网络对计算机系统的入 侵或 攻击已成为当今计 算机安全最严重的

一

威胁之

。 用户入侵 包 括利用系统漏 洞进行 未 授权登录， 或者授权用户非法获取更高级别权

限 。 软件入侵方式包括通过网络传 播病 毒、 蠕虫和特洛 伊 木 马 。 此外还包括 阻止合法用户正

常使用服务的拒 绝服务攻击， 等等 。 而前面讨论的所有安 全机制都不能有 效解决以上安全问

的计算机系统通过网络 向 攻击者泄漏

题 。 例如， 加 密技术 并不能 阻 止 植入了

“

特洛伊 木 马

秘 密信息 。

7.6.1 防火墙

”

防火墙( firew all) 作为

一

种访问控制技术 ， 通过严格控制进出网络边界的分组， 禁止任何不

必要的通信， 从而减少潜在入侵的发生， 尽可能 降低这类安全威胁所带来的安全 风 险 。 由千防

火墙不可能 阻 止所有入侵行为， 作为系统 防 御的第二道 防线， 入侵检测 系 统 I DS (I nt rusi on

Det ect i on S yst em )通过对进入网络的分组进行深 度分析与检 测发现疑似入侵行为的网络活动 ，

并进行报 警以便进

一

步采取相应措 施 。

防 火 墙是

一

种特殊编 程的路 由器， 安装在

一

个网点和网络的其余部分之间， 目 的是实

施访问控制策 略 。 这 个访问控制 策 略是 由使用防 火墙的单位自行制定的 。 这种安全 策略应当

最适合本单位的需 要 。 图7 -24 指出 防 火 墙位 千互联网和内部网络之间 。 互联网这 边是防 火

“

”

可 信 的网络

墙的外面， 而内部网络这 边是防 火墙的里面 。 一 般都把防 火墙里面的网络称为
(t rust ed  net w o rk)气 而把防 火墙外面的网络称为

不 可 信 的网络

(u nt rust ed n et w o rk) 。

“

”

防 火墙 的 外 面 唱

，

＇  防 火墙

，

防 火墙 的 里面． － － / 、;

／ 可 信 的 网 络 ＼

｝

分组过滤
路 由 器

I

)  ＼  !

＼

｝
＼二

图 7-24 防火墙在 互连 网 络 中 的位置

CD 注 ： 2004 年 I I 月 ， 联 合 国 总 部 建立 了

“

互 联 网冶 理 工 作 组 WGIG ( Working Group on Internet  Governance) ", 来解决互联

网 的 诚 信 和 安 全 问 题 。 我 国 在 2006 年 2 月 颁 布 的 《 国 家 中 长 期 科 学 和 技 术 发展 规 划 纲 要 ( 2006

—

2020 年 ） 》 中 ， 提 出 以 发展 高

可信 网 络 为 重 点 。 现 在 高 可信 网 络 已 成 为 研 究 热 点 。

•  364  •

