5 . 7   TCP 的 流量控制

5 . 7 . 1  利 用 滑动 窗 口 实 现流量控制

一 (cid:7185)说 来 ， 我 们 总 是 希 望 数据 传 输 得 更 快一 些 。 但 如果发送方把数据

l!J立

视频讲解

发 送 得 过 快 ， 接收方就可(cid:7126) 来 不 及 接收 ， 这 就 会 造 成 数 据 的 丢 失 。 所 谓 流 量 控 制 ( flow

control)就是让发 送 方 的 发送速率不要太 快 ， 要让接收方 来得及接收 。

利 用 滑 动 窗口机制可 以 很方 便 地在 TCP 连接上 实 现对 发 送方 的流量 控 制 。

下面通过图 5-21 的例子说明如何利用滑动 窗口机制进行流量控 制 。

seq =  I ,  DATA

B

:  A 发达 了 序 号 ］ 至 1 00 , 还 能 发送 300 字节

seq =  1 0 1 ,  DATA

二牙京仁 A 发达 了 序 号 20 1 否 300 ， 但丢 失 了 ！

:  A 发送 了 序 号 1 0 1 至 200 , 还 能 发送 200 字节

ACK =  I ,  ack = 20 I ,  rwnd = 300

:

允 许 A 发 送 序 号 20 1 至 500 共 300 字 节

seq = 30 1 ,  DATA

seq = 40 1 ,  DATA

seq = 20 1 ,  DATA

ACK =  I ,  ack = 50 1 ,  rwnd =  1 00

seq = 50 1 ,  DATA

ACK =  I ,  ack = 60 I ,  rwnd = 0

A 发送 了 ）字号 30 1 至 400 , 还 能 再 发送 1 00 字 节 新 数 据

A 发送 了 序 号 40 1 至 500 , 不 能 再 发 送 新 数 据 了

A 超 时 重 传 旧 的 数据 ， 但 不 能 发 送 新 的 数据

允 许 A 发 送 序 号 50 1 至 600 共 1 00 字 节

A 发送 了 序 号 50 1 至 600 , 不 能 再 发送 了

不 允 许 A 再 发 送 （ 到 厅 号 600 为 止 的 数 据 都 收 到 了 ）

图 5-2 1 利 用 可 变 窗 口 进 行 流量控制 举例

设A 向 B 发送数据 。 在 连接建立时， B 告 诉 了 A: “ 我的接收窗口 rwnd = 400 。 ”（ 这里
rwnd 表示 re ce ive r window 。) 因此， 发 送 方 的 发 送 窗 口 不 (cid:7129)超过接收方给 出 的 接收窗 口 ＠的
数 值 。 请注 意 ， TCP 的窗 口 单位是字(cid:7195) ， 不是报文段 。 TCP 连接建 立时的窗口协 商 过程在
图中没有显示 出 来 。 再 设 每 一个报 文 段 为 100 字(cid:7188)长 ， 而数据报 文 段 序 号 的初始值设为1
（ 见图中第 一个箭 头 上 面的序 号 s
e q =  I 。 图中右边的注释可帮 助理解 整个过程） 。 请 注 意 ，

图中箭 头 上面 大 写ACK 表示首 部中 的 确认位ACK, 小写 ack 表示确认字段的值 。

我们应注意到 ， 接收方的主机 B 进行了三次流量控制。 第 一次把窗口减小到 rwnd = 300 ,

第 二次又减到 rwnd =  100, 最后 减 到 rwnd =  O, 即 不 允 许 发送方 再发送数据 了 。 这种使发送
方 暂停 发 送的状态将持续到 主 机 B 重新 发出一个新的窗口值为止 。 我们还应注 意 到 ， B 向
A 发 送的三个报 文 段 都 设 置了ACK = l , 只 有在AC K =1 时确认号 字 段 才有意 义 。

现 在 我 们 考虑 一种情况 。 在 图 5-21 中 ， B 向A 发送了零 窗 口的报文段后不久 ， B 的接
收缓存 又有了一 些存储 空间。 于 是 B 向A 发送了 rwnd = 400 的报 文 段 。 然 而这个报 文 段在
传送过程 中 丢 失了 。 A 一 直 等 待收到 B 发送的非 零 窗口的通知， 而 B 也一 直 等 待 A 发送的
数据 。 如果没有其他措 施 ， 这种互 相 等 待的死锁 局 面将 一 直 延 续下 去 。
为 了 解 决 这个问题 ， TCP 为 每 一个连 接 设有一个持续 计 时器 ( pe rs

time r) 。 只 要

is te nce

CD 注 ： 从 rwnd 的 原文看 ， 中 文 译 名 应 当 是接收方窗 口 。 然 而 在 不 产 4 误 解 的 情 况 下 ， 也 可 简 称 为接收窗 口 。

•  236  •

TCP 连接的一方收 到对方的零 窗口通知 ， 就启 动 持 续 计时器。 若 持续计时器 设 置的时间 到
期 ， 就 发送一 个 零 窗 口 探测报文段（ 仅携 带 l 字 (cid:7194)的数据） 气 而对方 就 在 确 认 这个探测 报
文 段时给 出 了现在的窗 口 值。 如果窗 口 仍然 是 零 ， 那 么 收到 这个报文 段的一 方 就 重 新 设置持
续计时器。 如果窗 口 不 是 零 ， 那 么 死锁的僵 局就可以打 破了。

扫 ·j· 1

5.7.2  TCP 的传输效率
、 护扣＄
前面 已 经 讲 过 ， 应用进 程把数据传送到 TCP 的发送缓存后， 剩 下的发 �J.1.....飞§}
匝祧嗟担
送任 务就由 TCP来 控制了。 可以用不 同 的机制来 控制 TCP报 文 段的发送时 笝合氪倍也
机。 例如 ， 第 一种机制是 TCP维持 一个变量 ， 它等于最大报文段长度 MSS。
只要缓存中存放的数据达到 MSS 字 (cid:7194)时 ， 就组装成一个 TCP报 文 段发送 出去。 第 二 种机制
是由发送方的应 用 进程指 明 要求发送报 文 段 ， 即 TCP支 持的推送( pus h)操作。 第 三种机制是
发送方的一个计时器期 限 到了， 这时就把当前 已有的缓存数据装入报 文 段 （ 但长度不(cid:7138)超过
MSS) 发 送出去。

f见步扩 训 解

但是 ， 如 何控制 TCP发送报文 段的时机仍然 是 一个较为复杂的问题 [RFC 1
例如 ， 一个交互 式用户 使用一条 TELN ET 连接（运输层为 TCP协 议）。 假设用户 只 发 l
个字符， 加 上 20 字(cid:7188)的首部后， 得到 21 字 (cid:7194) 长 的 TCP报 文段。 再加 上 20 字节的 IP 首 部 ，
形成41 字(cid:7188)长的I P 数据报。 在接 收方 TCP立即发出确 认 ， 构成的数据报是 40 字 (cid:7194)长（ 假
定没有数据发送）。 若用户 要求远地主机 回送这 一字符， 则又要发 回 4 1 字 节长 的 IP 数 据 报
和40 字(cid:7188)长的确认IP数据报。 这样 ， 用户 仅发1 个字符时 ， 线路 上 就 需传送总长度 为1 62
字(cid:7188)共4 个报文 段 。 当线路带 宽并不 富 裕时 ， 这种传送方法的效率的确 不高。 因 此应 适 当 推

1 22] 。

迟发回 确认报 文 ， 并尽量使用捎 带 确认的方法。

在 TCP的实现中广 泛使用 Nagle 算法。 算法如下 ： 若发送应用进程把要发送的数据逐
个字(cid:7191)地送到 TCP 的发送缓存 ， 则 发送方就把第 一个数据字(cid:7194) 先发送出去 ， 把后 面 到 达 的
数据字(cid:7188)都缓存起来 。 当发送方收到对第 一个数据字符的确认后， 再把发 送缓 存 中 的所有数
据组装成一个报文 段发送出去， 同 时继 续对随后到达的数据进行缓存。 只有在收到对前一个
报 文 段的确认后才 继 续发送下一个报文 段 。 当 数据到达 较 快而 网络速率较慢 时 ， 用这样的 方
法可明显地减 少 所用的网络 带 宽 。 N agle 算法还规定 ， 当到达的数据 已 达到发送 窗 口 大小 的
一 半或 已 达 到 报 文 段的最大长度时， 就立即发送一个报文段。 这样做 ， 就可 以有效地 提高网
络的吞 吐 量 。

另 一个问题叫作糊涂 窗 口 综合征( s illy window  s yndrome )， 有时也会使 TCP的性 (cid:7139) 变坏。

设 想 一种情况： TCP 接收方的缓存 已 满 ， 而交互 式的应用进程一次 只 从接收 缓存 中 读 取 l
个字(cid:7194)（ 这样就使接收缓存空间仅(cid:7148)出1 个字(cid:7188)） ， 然后向发送方发送确认， 并把窗 口 设置
为1 个字 节（ 但 发送的数据 报是40 字(cid:7188)长）。 接着 ， 发送方又发来 l 个字(cid:7188)的数据（ 请 注 意 ，
发送方发送的 IP数据报是 4 1 字(cid:7194)长）。 接收方发回 确 认 ， 仍然 将 窗 口 设置为1 个字 节。 这

样进行下去 ， 使网络的效率很低。

要 解 决 这个 问 题 ， 可以让 接 收 方等待 一 段 时 间 ， 使得或 者 接收缓存 已有足 够 空 间 容纳
一个最长的报文 段 ， 或者 等到接收缓 存 已 有 一半空 闲 的 空间 。 只要出现这两种情况之 一 ， 接

CD 注 ： TCP 规 定 ， 即 使 设置 为 零 窗 口 ， 也 必 须接 收 以 下 几 种 报 文 段 ： 零 窗 口 探刷 报 又 段 、 确 认 报 义 段 和 携 沿 紧 急 数拟 的 报

文 段 。

•  237 •

收 方就发出确认报 文 ， 并向发送方通知 当前的窗口大小。 此外 ， 发送方也不要发送太小的报
文 段 ， 而是把数据积累成足够大的报文 段 ， 或达到接收方缓存的空间的一 半 大小。

上 述两种方法可配合使用。 使得在发送方不发送很小的报 文 段的 同 时 ， 接 收方也不要

在 缓存 刚 刚有了 一点小的空间就 急 忙把这个很小的窗口大小信 息 通知给发送方。

5 . 8   TCP 的 拥 塞控制

一

5 . 8. 1  拥 塞控制 的

般 原 理

在 计算机网络中的链路容量（即 带 宽） 、 交换(cid:7188)点中的缓存和处理机等 ，

扫 一扫

寄恩畸启视 频讲解

都是网络的资源。 在某段时间，若对网络中某一 资源的需求超过 了 该资源所(cid:7126)
提供的可用 部分 ， 网 络的性(cid:7126)就要变坏。 这 种情况就叫作拥塞( conge s tion )。 可 以把出现网络拥
塞的条件写成如下的关系 式：

区 对 负 源的需求 ＞ 可用 资 掠

(5-7)

若 网 络中有许多资 源 同 时呈 现 供应 不 足 ， 网络的性(cid:7126)就要明显变 坏 ， 整个网络的吞 吐

量将 随输入负 荷的增大而下 降。

有人可(cid:7126)会说： “ 只 要任 意 增加一 些 资 源 ， 例如 ， 把(cid:7188)点缓存的存储 空 间 扩大 ， 或把链

路 更 换 为 更 高速率的链路 ， 或把(cid:7188) 点处理机的运算速度 提高 ， 就可 以 解决 网 络 拥 塞 的 问题。 ”
其 实不然。 这 是 因 为网络拥 塞是 一个非常复杂的问题。 简单地采用上述做法， 在许 多 情 况下 ，
不但 不(cid:7126)解决拥 塞问题 ， 而且还可(cid:7126)使网络的性(cid:7126)更坏。

网络 拥 塞往往是 由很多 因 素 引 起的。 例如 ， 当 某个(cid:7188)点缓存的容量 太 小 时 ， 到达该(cid:7192)

点的分 组 因 无存储 空 间 暂存而不 得 不 被丢弃。 现在设想将 该(cid:7188)点缓存的容量扩 展 到 非常大 ，

千 是 凡 到达该节点的分组均可在(cid:7188)点的缓存队 列 中排 队 ， 不 受任 何 限制。 由 千输 出 链 路的容

量 和处理机的处理速度并未 提高 ， 因此在这 队 列 中的绝大多数分组的排 队 等 待 时间将 会 大 大

增 加 ， 结 果 上层 软 件 只 好把它们进行重传（ 因 为早就超时 了 ）。 由此可见， 简单地扩 大 缓存

的存 储 空间同样 会造成网络 资 源的严重浪 费 ， 因 而解决不了 网络 拥 塞的问题。

又 如 ， 处理机处理的速率太低可(cid:7126) 引 起网络的拥 塞 。 简 单地将处理机的速率提高， 可
(cid:7126)会 使上述情况缓解 一 些 ， 但 往往又会将瓶颈转移到 其 他地方。 问题的实 质 往往是 整个 系 统
的各个部分不匹配。 只有所有的部分都平 衡 了 ， 问题才 会得到解决。

拥 塞 常常 趋 千 恶化 。 如果一个路由 器 没有足够的缓存空 间 ， 它就会丢弃 一 些 新 到 的分
组。 但 当 分组被 丢 弃 时 ， 发送这 一 分组的 源点就会重传这 一分组， 甚 (cid:7169)可(cid:7126)还要 重 传 多 次。
这样会 引 起更多的分组流入网络 和 被网络中的路由器丢弃。 可见拥 塞 引 起的重传 并 不 会 缓 解
网 络的拥 塞 ， 反 而 会加剧 网络的拥 塞。

拥 塞 控 制与流 量 控 制的关 系 密 切 ， 它 们 之间也存在着 一 些 差 别 。 所 谓 拥 塞控制 就 是 防
止过 多 的 数据注入到 网 络 中 ， 这样可 以使 网络 中 的 路 由 器 或链路不 (cid:7173)千过载。 拥 塞控制所要
做的都有 一个前提 ， 就是 网 络 (cid:7129) 够承 受 现 有 的 网络负荷。 拥 塞控 制是 一个全局 性 的 过程 ， 涉
及 所 有的主 机 、 所有的路由器 ， 以 及与降低网络传输性(cid:7126)有关的所有因 素。 但 TC P 连接的

端 点 只 要 迟 迟 不(cid:7126)收到对方的确认信 息 ， 就猜想 在 当 前网络中的某处很可(cid:7126)发生了拥 塞 ， 但

这 时却 无法知道 拥 塞 到 底发生在网络的何处， 也无法知道发生 拥 塞的具 体 原 因。 （ 是 访问某

个服务 器的通 信 量过大？ 还是 在 某个地区 出 现 (cid:7160) 然 灾 害？ ）

相 反 ， 流量控制 往 往 是 指 点 对 点 通 信 量 的 控 制 ， 是个端 到 端 的问题 （ 接收 端 控 制发送

•  238  •

