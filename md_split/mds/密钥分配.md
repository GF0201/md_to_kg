A 收到 数据 后 ， 用 自 己 的 私 钥 SK
加 密 数据 已被 中 间 人 C 截 获并解密 了

份 ， 但 A 和 B 却 都 不 知 道 。

一

解 密 ， 以 为 和 B 进 行 了 保密通信 。 其 实 ， B 发送给 A 的

A

一

由 此可 见 ， 公 钥 的 分 配 以 及 认证 公 钥 的 真 实 性 也 是

个 非 常 重 要 的 问 题 。 关 于 这 点 我

们 在 后 面 ( 7.4.2 节 ） 还 要讨 论 。
7 .4  密钥 分配

一

由 于 密 码 算 法 是 公 开 的 ， 网 络 的 安 全 性 就 完 全 基 于 密 钥 的 安 全 保 护 上 。 因 此 在 密 码 学
密钥 管理 。 密 钥 管理包括 ： 密 钥 的 产 生 、 分 配 、 注入 、 验证和

个 重 要 的 分 支

中 出 现 了
使 用 。 本节 只 讨 论 密 钥 的 分 配 。

密 钥 分配 （ 或密 钥 分 发 ） 是 密 钥 管 理 中 最 大 的 问 题 。 密 钥 必 须 通 过 最 安 全 的 通 路 进 行
分配 。 例 如 ， 可 以 派 非 常 可 靠 的 信 使携 带 密 钥 分配给互相通信 的 各用 户 。 这种 方法称为网外
分配方式 。 但 随 着 用 户 的 增 多 和 网 络 流侬 的 增 大 ， 密 钥 更换 频 繁 （ 密钥 必 须 定 期更 换 才 能 做
到 可靠 ） ， 派信 使 的 办法 已 不 再适 用 ， 而 应 采 用 网 内 分配方式 ， 即 对密 钥 自 动 分 配 。
7.4.1  对称密钥 的 分配

一

一

对称密钥 分配存在 以 下 两个 问 题 。

一
， 如 果 n 个 人 中 的 每

第

两人 共享

个 需要 和 其 他 n - l 个人通信 ， 就 需 要 n(n - l )个 密 钥 。 但每
个密钥 ， 因 此密 钥 数是 n(n - 1 )/2 。 这常称 为 矿 问 题 。 如 果 n 是 个 很 大 的 数 ， 所

需 要 的 密 钥 数量 就 非 常 大 。

第 二 ， 通 信 的 双 方 怎 样 才 能 安 全 地得 到 共 享 的 密 钥 呢 ？ 正 是 因 为 网 络 不 安 全 ， 所 以 才

需 要 使用 加 密 技 术 。 但密钥 又 需 要 怎 样传送 呢 ？

一
大 家 都 信 任 的机构 ， 其任务就是给需要进行秘密 通信 的 用 户 临 时分配

目 前 常 用 的 密 钥 分配方式是 设立密钥 分配 中 心 KDC (Key  Distribution  Center) o   KDC 是
个会话密钥 （ 仅使 用
次 ） 。 在 图 7- 1 3 中 假 定 用 户 A 和 B 都 是 KDC 的 登 记 用 户 。 A 和 B 在 KDC 登 记 时 就 已经
＂
和 KB 。 为简 单 起
。 密 钥 分配分为三个步骤 （ 如 图 7- 1 3 中 带箭

在 KDC 的 服 务 器 上 安 装 了 各 自 和 KDC 进行通信 的 主密钥(master key)  K
见 ， 下 面在叙述时把
简 称 为
头 直 线 上 的 O , ＠ 和 ＠所示 ） 。

主 密 钥

密 钥

A

“

“

＂

一

A

密 钥 分配 中 心
KDC

B

＠

时 间

图 7- 1 3 KDC 对会话密 钥 的 分 配

0 用 户 A 向 密 钥 分 配 中 心 KDC 发送 时 用 明 文 ， 说 明 想 和 用 户 B 通信 。 在 明 文 中 给 出

•  348  •

A 和 B 在 KDC 登 记 的 身份 。

“ 一

一

”

AB

@ KDC 用 随机数产生

A
的会话密 钥 K

供 A 和 B 的 这 次会话使 用 ， 然 后 向

AB

一
A 发送 回 答报 文 。 这个 回 答报 文 用 A 的 密 钥 K
AB
B
个票据(ticket)
K

和 请 A 转给 B 的

加 密 。 这个报 文 中 包含这次会话使用 的 密 钥
, 该票据包括 A 和 B 在 KDC 登 记 的 身 份 ， 以及这次

次

密
CD

会话将要使用 的 密 钥 K

B

。 票据 用 B 的 密 钥 K

加 密 ， A 无法知道此票据 的 内 容 ， 因 为 A 没

有 B 的 密 钥 K

B
， 当 然 A 也 不 需 要 知 道此票据 的 内 容 。
AB
© 当 B 收到 A 转来 的 票 据 并 使 用 自 己 的 密 钥 K
。

也 知 道 KDC 为这次和 A 通 信 所 分 配 的 会 话 密 钥 K

AB

解 密 后 ， 就 知 道 A 要和 他通信 ， 同 时

此后 ， A 和 B 就可 使 用 会 话 密 钥 K

进 行这 次通信 了 。

请注 意 ， 在 网 络上 传 送 密 钥 时 ， 都是经过加 密 的 。 解 密 用 的 密 钥 都不 在 网 上传送 。

KDC 还 可 在报 文 中 加 入 时 间 戳 ， 以 防 止 报 文 的 截 取 者 利 用 以 前 已 记 录 下 的 报 文 进 行 重

AB

A

扣

一

放攻击 。 会话密钥 K

是

次 性 的 ， 因 此机 密 性较 高 。 而 KDC 分配给用 户 的 密 钥 K

和 K

都 应 定 期 更 换 ， 以减少攻击者破译 密 钥 的 机会 。

®

目 前最 出 名 的对称密钥分配协议是 Kerberos V5

[RFC 4 1 20, 4 1 2 1 , 建议标准］ ， 是 美 国 麻

省 理 工 学 院 (MIT) 开 发 的 。 Kerberos 既 是 鉴 别 协 议 ， 同 时 也 是 KDC , 它 已 经 变 得 很 普 及 。

Kerberos 使用 比 DES 更 加 安全 的 高 级 加 密 标 准 AES 进 行 加 密 。 下 面 用 图 7- 1 4 介 绍 Kerberos

一

V4 的 大致工作过程 （ 其原理和 V5 大体

样 ， 但 稍 简 单 些 ） 。

Kerberos

TGS

B

A  。 A

。

。

图 7- 1 4 Kerberos 的 工 作 原 理

Kerberos 使用 两个服务 器 ： 鉴别服务器 AS (Authentication  Server) 、 票据授予服务器 TGS

CD 注 ： 目 前在 网 络 安全领域中 ticket

词还没有标准译名 ， 也有 人译为

票

执照

“ 票证

或

签条

。

Kerberos

＠ 注 ：

是希腊神话 中 具有 三个 头 的狗 ， 它 为

Hades

（ 哈得斯 ， 主 宰 阴 间 的 冥 王 ） 看 门 。

一

＂

” “

”

”

＂

”

•  349  •

( Tic ket

在 图 7 -

-Granti ng S erver)。 Kerb eros 只用千客户与服务器之间的鉴别 ， 而不用于人对人的鉴别。
14 中 ， A 是请求服 务的客户 ， 而 B 是被请求的服务器。 A 通过 Kerb eros 向 B 请求服

务。 Kerb eros 需要通过以下六个 步 骤鉴别的确是A（而 不是其他人 冒 充A) 向 B 请求服务
后 ， 才向 A和 B 分配会话使用的 密 钥。 下面简单解释各 步 骤。

OA 用明文（包括登记的 身 份） 向 鉴别服务器AS 表明自己的 身 份。 AS 就 是 KDC , 它

掌 握各实体登记的 身 份和 相应的 口 令。 AS 对A 的 身 份进行验 证。 只有验证结果 正确 ， 才 允

许A 和 票据授 予服务 器 TGS 进行联系。

＠ 鉴别服务器AS 向A 发送用A 的对称 密 钥 KA 加 密的报 文 ， 这个报文包含A 和 TGS

通信 的会话 密 钥 Ks以及AS 要发送给 TGS 的票据（这个票据是用 TGS 的对称密 钥 KTG 加密

的 ）。 A 并不保存 密 钥 KA , 但当这个报 文到达A 时 ， A 就键入其 口 令。 若 口 令 正确 ， 则 该

口 令和适 当的算法

一

起就能 生成密 钥 KA。 这个 口 令随即被销 毁。 密 钥 KA 用来对AS 发送过

来的报文进 行解密。 这 样就 提取出会话 密 钥 Ks（这 是A 和 TGS 通信要使用的） 以及要转发

给 TGS 的票据（这 是用密 钥 KTG 加 密的）。

@A 向 TGS 发送三项内容 ：

•  转发鉴别服务器AS 发来的票据。

•  服务器 B 的名字。 这表明A 请求 B 的服务。 请注意 ， 现在A 向 TGS 证明自己的

身份并非通过键入 口 令（因为入 侵者能够从网上 截 获 明文 口 令） ， 而是通过 转发

AS 发出的票据（只有A 才能 提取出）。 票据是加密的 ， 入侵者伪造不了。

•  用 从 加 密的时间 戳 T。 它用来 防 止入侵者的重放攻击。

0  TGS 发送两个 票据 ， 每

个都包 含A 和 B 通信的会话 密 钥 KAB。 给A 的 票据用 Ks
加 密 ； 给 B 的票据用 B 的密 钥 KB 加 密。 请注意 ， 现在入侵者不能 提取 KAB ， 因为不知道 Ks

一

和 KB。 入 侵 者也不能重放 步 骤 ＠ ， 因为入侵者不能把时 间 戳 更换为

一

个新的（因为不知道

Ks)。 如 果入 侵者在 时 间 戳到期之前， 非常迅速地发送步 骤 ＠的报 文 ， 那么 对 TGS 发送过来

的两个 票 据 仍 然 不能解密。

0A 向 B 转发 TGS 发来的票据 ， 同时发送用 KAB 加 密的时 间 戳 T。

O B 把时间戳 T 加1 来证实收到了票据。 B 向A 发送的报文用 密 钥 KAB加 密。

以后 ， A 和 B 就使用 TGS 给出的会话密 钥 KAB 进行通信。

顺便指出 ， Kerb eros 要求所有使用 Kerb eros 的主机必须在时钟上进行
“

“

所谓

松散的

同 步 是要求所有主机的时钟误差 不能太大 ， 例如 ， 不能超过 5 分钟的数量级。

“

“

松散的

同步。

这 个要求是为 了 防止重放攻击。 TGS 发出的票据都设置较短的有效期。 超过有效 期的票据就

作废 了 。 因此入侵者即使截获 了某个票据 ， 也不能长期保 留用来进行以后的重放攻击。

7.4.2  公钥 的 分 配

在公钥 密 码体制中 ， 公钥的分配方法并不简单。 本 节就 讨论 这个问题。

我们不 妨 先假定大家都各自保存有自己的私 钥 ， 而把各自的公 钥发布在网上。 假定 A

和 B 都 是公司。 有个捣 乱者给 A 发送邮件 ， 声称自己是 B , 要购买A 生产的设备 ， 货到付

款 ， 并给出了 B 的收货地址。 邮件中还附上

“

B 的公钥

＂
（其实是捣 乱者的公钥）。 最后用

捣 乱 者的私钥对邮件进行了签 名。 A 收到邮件后 ， 就用邮件中给出的捣乱者的公钥 ( A 以为

自 己使用 了 B 的公钥） ， 对邮件中的签 名进行了鉴别 ， 就误认为 B 真的是要购买设备。 当A

• 350  •

“

＂

把生产 的 设备运到 B 的 地址后 ， B 才 知 道被 愚 弄 了 ！ 捣乱者甚至还可伪造
（ 其 实是捣乱者 的 公 钥 ） 。

站 ， 上 面 有

B 的 公 钥

一

那 么 ， 有 没 有 可 靠 的 方法来获得 B 的 公 钥 ， 并 且 能 确 信 公 钥 是 真 的 ？

一

个 冒 充 B 的 网

有

种 非常 可 靠 的 方 法 ， 就 是 公 司 A 派人亲 自 去 公 司 B , 直接 向 公 司 B 索 要其 公钥 。

这样拿到 的 B 的 公 钥 当 然 是 可 信 任 的 。 但这种很不方便 的 办 法 显 然 不 能普遍推广 使 用 。

一

现 在 流 行 的 办 法 ， 这就是找

个 可信 任 的 第 三方机构 （ 第 三方机构 既 不 是 需 要 B 的 公

一

一

钥 的 公 司 A , 也 不 是 拥 有 公钥 的 公 司 B ) ， 给拥 有 公钥 的 实体 发
书 (digital certificate) ， 有 时 也 可 简 称为证书 。 数 字 证 书 就 是对 公钥 与 其对应 的 实 体 （ 人或机
器 ） 进行绑定(binding)
个 证 明 。 因 此它 常称 为公钥 证书 。 这种 签 发证 书 的 机构 就 叫 作 认证
中 心 CA (Certification Authority) ， 它 由 政府或知 名 公 司 出 资 建立 （ 这样 就 可 以 得 到 大 家 的 信
任 ） 。 每 个证 书 中 写 有 公 钥 及 其拥 有 者 的 标 识 信 息 （ 人 名 、 地址 、 电 子 邮 件 地 址 或 I P 地址

个 具有 数字签名 的 数 字证

等 ） 。 更 重 要 的 是 ， 证 书 中 有 CA 使 用 自 己私 钥 的 数 字签名 ， 这就 是认证 中 心 CA 把 B 的 未

签 名 的 证 书进行散列 函 数运 算 ， 再用 CA 的 私钥 对 散 列 值进 行 D 运算 （ 也就 是对散列值进

一

行签名 ） 。 这样就得 到 了 CA 的 数字签 名 。 把 CA 的 数 字 签 名 和 未签 名 的 B 的 证 书放在

起 ，

就 最 后 构 成 了 已签 名 的 B 的 数字证书 （ 如 图 7- 1 5 所示 ） 。 图 中 的 数字证书 只 给 出 了 最重 要 的
几 个项 目 。 这样 的 证 书无法伪 造 。 任 何 用 户 都可从可信 任 的 地方 （ 如 代表政府 的报纸 ） 获得

认 证 中 心 CA 的 公 钥 ， 以验证证书 的 真伪 。 这种数字证 书 是 公开 的 ， 不 需 要 加 密 。 现在我 国
的 认 证 中 心 已 有 不 少 ， 例 如 ， 在 金 融 领 域 ， 中 国 金 融 认 证 中 心 CFCA (China  Financial
一
Certification Authority)是 由 中 国 人 民银行牵头 ， 联 合 1 4 家 全 国 性 商 业银行 共 同 建立 的 金融认
证机构 ， 其权威性是毋庸置疑 的 。 在 国 际 上 ， 威瑞信 公 司 VeriSign 是发行数字证书产 品 的

家 具有权威性 的 公 司 。

未签 名 的

证书 拥 有者 ： B

－ － － －

－

－

－ －

－ － － － －

B 的 数 字证书 卢:芦｀言
散 列 运算｝

CA 用 私钥

2竺竺贮

－

－

－ － － －

－ －

固 定长 度散 列 匠亘叶旦旦

| CA 的数字签 名 + -

图 7- 1 5 已 签名 的 B 的 数 字 证 书 的 产生过程

已签 名 的 B 的 数字证 书

t厂勹雷者
厂三亘二

B

CA 的数字 签名

－

－

－

-

一

公 司 A 拿到 B 的 数 字 证 书 后 ， 可 以 对 B 的 数 字证 书 的 真 实 性进 行 核 实 。 A 使 用 数字证
个数值 。 再对 B

书 上 给 出 的 CA 的 公钥 ， 对数字证 书 中 CA 的 数 字签 名 进 行 E 运算 ， 得 出

一

一

的 数 字 证 书 （ 把 CA 的 数 字签 名 除 外 的 部 分 ） 进行散列 运 算 ， 又 得 出
数值 。 若
似 的 方法 ， 对 订 单 的 真实 性 进行 核 实 （ 使用 B 的 数字 证 书 中 给 出 的 B 的 公 钥 ） 。

个数值 。 比较这两个
致 ， 则 数字 证 书 是 真 的 。 当 A 收到包含有 B 的 数字签名 的 订 货 单 时 ， 也 能用 类

为 了 使 CA 发 布 的 数字 证 书 在各 行 各业 中 能够通用 ， 数字证 书 的 格式就必 须标准化 。 为
ITU-T 制 定 了 X.509 协议标 准 ， 后 来 I ETF 采用 了 现在 的 版本 ， 即 X.509 V3  [RFC  5280] ,

此 ，
作 为 互 联 网 的 建议 标 准 ( 1 47 页 ） 。 X.509 又 称 为 互 联 网 公 钥 基 础 结 构 PKl
Infrastructure) 。

一

个 数 字证 书 必 须包括 以 下 这 些重 要 字 段 ：

X.509 规定 了
•  X.509 的 版 本
•  数字证书 名 称及序 列 号

(Public  Key

•  35 1  •

•  本数字证书所使用 的 签 名 算法
•  数字证 书签发者 的 唯
标 识 符

一

一
•  数 字证 书 的 有 效期 （ 有 效期开始 到 结束 的 日 期 范 围 ）

一

一

标 识 符 ）

•  主 体 名 （ 或主 题 名 ， 公 钥 和 数字证书拥 有 者 的 唯
•  公 钥 （ 数字 证 书 拥 有 者 的 公钥 和 使用 算 法 的 标 识 符 ， 对应 的 私钥 由 证书 拥 有者保存 ）
个树状 的 认证系统 （ 如 图 7- 1 6(a)所示 ） 。
X.509 提 出 把 多 级 认 证 中 心 链 接 起 来 的 ， 构 成
在 多 级 认证 系 统 的 末端 就 是用 户 ( A ~ E ) 。 在 X.509 中 并没有规定这种链接 需 要 多 少 级 ， 也
没 有 给 每
级 的 认 证 中 心 都称 为根认证 中 心 (Root
CA) ， 即 公认 可 信 的 认证 中 心 （ 或无条件信 任 的 ） ， 且 其 公 钥 是 公 开 的 。 在 这 种 树 状 的 认 证
个根 CA 。 从 根 CA 向 下 的 所有链接都称为信任链 ， 表示处在这条链
系 统 中 ， 可 以 有 不 止
接 上 的 认证机构 都 是 可 信 的 。

级 的 认 证 中 心 规 定 统
一

的 名 称 。 但 最 高

一

一

根证书

.... ,,_ 者

2

KK 心

“

－

中 间 CA

的 证书

？
中 间 CA

中 间 CA

的 公钥

根 CA签 发

(a)

(b)

图 7-1 6树状结构 的 多 级 认证 系 统(a)和证书链(b)

一

一

一

一

一

串 链接就是

图 7- 1 6(a)最右 边 的

用 户 E 。 与 这
条信 任链对应 的 是证书链 （ 如 图 7- 1 6(b)所示 ） ， 通过 图 中 所示 的链接 ， 就可 以 查 到 本证 书 的
签发者 ， 也 可 以 知 道 用 谁 的 公 钥 来验 证 本 证 书 中 的 签 名 。 在 这 条 证 书 链 中 ， 根 CA 给 中 间
2
CA

签 发 了 中 间 证 书 ， 并 使用 根 CA 的 私 钥 进 行 数字 签 名 。 中 间 CA2 可 以 用 根 CA 的 公钥 ，

条信任链 的 例 子 ： 根 CA

中 间 CA2

2

对 证 书 中 的 根 CA 签 名 进 行验 证 。 因 此 中 间 证 书 是 可 信 的 和 不 可 篡 改 的 。 同 理 ， 中 间 CA
个用 户 签 发 了 用 户 证 书 ， 并 使 用 中 间 C心 的 私 钥 进 行 数 字 签 名 。 用 户 可 以 用 中
给 下 面 的
的 签 名 进行验证 。 因 此 ， 这个用 户 证 书 也 是 可 信
间 C心 的 公 钥 ， 对 用 户 证 书 中 的 中 间 CA
的 和 不 可 篡 改 的 。 请 注 意 ， 最 顶 层 的 根 证 书 的 数 字 签 名 是 自 签名 （ 即 自 己 的 私 钥 给 自 己签
名 ） 。 根证书不 需 要其他 的 认证机构对其签名 ， 是我们 的 信 任链 的 起 点 。

2

若 证 书 链 中 的 某 个认 证 中 心 没 有 严 格遵 守 证 书 所 规 定 的 要 求 （ 例 如 ， 把 证 书 转 让 给 了

一

一

其他单位 ， 但 并未严格验证其 身 份 ） ， 那 么 这 个节 点 以 下 的 证 书 是 否 还 可 信 ， 就 应 重 新验 证 。
个
用 户 若 发现私钥被盗或遗失 ， 应及 时 报 告 上 级 CA , 以 便撤销证书 。 每
公 布 千 众 的 、 用 本 CA 的 私 钥 签 名 证书 撤销 名 单 ， 并 定 期 更 新 。
7 .5  互联网使用 的 安 全协议

个 CA 应 当 有

前 面 几 节 所 讨 论 的 网 络 安 全 原 理 都 可 用 在 互 联 网 中 ， 目 前 在 网 络 层 、 运 输层 和 应 用 层

都 有 相 应 的 网 络安 全协议 。 下 面 分 别 介 绍 这些协议 的 要 点 。

•  352 •

