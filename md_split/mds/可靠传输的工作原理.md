以及网络技术的进 步， 同 一个名 词 socket 却可表 示 多 种 不 同的意思。 例如：

(1) 允 许 应用 程序访问连网协议的应 用 编程接 口 API (Application Program m ing Interface),

即运输 层和应用 层之间的一种 接口， 称为socketAPI, 并 简 称为socket。

(2) 在 socketAPI 中使用的一个函 数名 也叫作 socket。
(3) 调用 socket 函 数的端点 称为socket, 如 “ 创 建一个数据 报 socket ”。
(4) 调用 socket 函 数时，其返 回 值 称为socket 描述符， 可简 称为socket。
(5) 在操作系 统 内 核中连网协议的Berkeley 实现， 称为socket 实现。
上 面的这些 socket 的意 思 都 和本章所引 用的 RFC 793 定义的 socket （ 指端 口号 拼 接到

IP地址） 不 同。 请读者加 以注意。

5.4  可靠传输 的 工作原理

我们知道， TCP发送的报 文 段是交给IP层传送的。 但IP层只能提供尽最大努力 服务，
也就是说 ， TCP 下 面的网络所提供的是不可靠的传 输。 因此， TCP必须采用适当的措施 才
能 使得 两个运输 层之间的 通信 变 得 可靠。
理想的传输条件 有 以下 两个特点 ：
(1) 传输信道不产生差错。
(2) 不管发送方 以多 快的速 度发送数据 ， 接收方总是来得及 处理收到的数据 。
在这样的理想传输条件下， 不需要采取 任何措施就能够 实现可靠传输。
然 而实际的网络 都 不具备 以上 两个理想 条件。 但我们 可 以 使用一些可靠传 输 协 议， 当
出现差错时让发送方重传出现差错的数据 ， 同时在 接收 方来 不及 处理收 到的数据时， 及时告
诉发送方适当降低发送 数据 的速率。 这样一来， 本来不可靠的传输信道就能够 实现可靠传输
了。 下面从最简 单的停止等待 协议 气井起。

5 .4. 1  停止等待协议

全双 工 通信 的双 方 既是发送方也是接收方。 下面为了讨论问题的方便， 我们仅考 虑 A
发送 数据 而B 接收 数据 并 发送确认。 因此A 叫作发送方， 而B叫作接收方。 因为这 里是讨
论可靠传输的原理， 因此把传送的数据 单元都称为分组， 而 并 不考虑 数据 是在哪一个 层次上
传送的气 “ 停 止等待 ” 就是每发送完一个分组就停 止发送， 等待 对方的确认。 在收到确认
后再发送下一个分组。

1 . 无差错情况

停 止等待协议可用 图 5-8 来 说 明。 图 5-8(a)是最简 单的无差错情况。 A发送分 组M l ， 发
完就暂停发送， 等待 B的确认。 B收到了M 1 就 向 A 发送确认。 A 在收到了对M 1 的确认后，

O 注 ： 在 计算 机 网 络 发展初期 ， 通信 链 路 不 太可靠， 因 此在链路层传送数 据 时 都要 采 用 可 靠 的 通信 协议。 其 中 最简 单 的 协

议就是这种
层 使 用 的可靠传输协 议 要 复 杂 得 多 （ 见后 面 5.6 节 ）。

停止等待协议

“

”

。 在运输层 并 不 使 用 这 种 协议 ， 这里 只 是为 了 引 出 可靠传输 的 问 题才从最简 单 的 概念讲起 。 在 运 输

＠ 注 ： 运输层传 送 的 协 议 数据 单 元 叫 作 报文段 ， 网络层传 送 的 协议数据单元 叫 作 IP 数据报 。 但在

般讨论 问 题 时 ， 都 可

把 它 们 简 称 为 分组。

一

• 221 •

就再发送下 一个分组 M2。 同样 ， 在收到 B 对 M2 的确认后， 再发送 M狂

A

发送 M 1 k

发送 M2 巨-

发送 M3 巨�.

8

I
确 认 M 1

确认 M 2

确认 M3

A

M

B

, 丁-＿－．．．-一＿一＿ 、＿一X＿一＿ ＿-一＿＿ ＿ －

超时重传 M ,.4它J
发送

|  / 确 认 M 1

发送 M 2

(a) 无差错情况

l t
(b) 超时重传

2 . 出 现差错

图5-8 停 止 等 待 协 议

图 5-8( b) 是分组在传输过程中出现 差 错的情况。 B 接收 M ] 时检测出了差 错 ， 就丢弃 M 1,
其 他什么也不做 （ 不通知A 收到有差错的分组） 印。 也可(cid:7126)是 M ] 在传输过程中丢 失了， 这
时 B 当 然 什么都不知道。 在 这 两种情况下 ， B 都不会发送任 何信 息 。 可 靠传输协 议是 这样
设计的： A 只要超过了一段时间仍然 没有收到 确认， 就认为刚 才发送的分组丢 失了， 因而重
传前面发送过的分组。 这 就叫作超时重传。 要实现超时重传， 就要在每发送完 一个分组时设
置一个超 时计时器。 如果在超时计时器到 期之前收到了对方的确认， 就撤销 己设置的超时计
时器。 其 实 在 图 5-8( a)中， A 为每一个 已发送的分组都设置了一个超时计时器 。 但A 只要在
超时计时器到 期 之前收到了相 应的确认， 就撤销 该超时计时器。 为简单起见， 这 些细(cid:7188)在图

5-8( a)中都省 略了。

这 里 应注意 以下 三点
第 一 ， A 在发送完 一个分组后 ， 必须 暂 时保 留 已 发 送 的 分组 的 副 本 （ 在发生超时重传时

使 用 ） 。 只有在收到相 应的确认后才(cid:7126)清 除 暂 时保 留 的分组副本。

第 二 ， 分组和 确认分组都必须进行编 号 气 这样才(cid:7126)明确是 哪 一个发送出去的分组收到

了确认， 而哪 一个分组还没有收到确认。

第 三 ， 超 时计时器设置的重传时 间 应 当 比 数 据在 分组传输 的 平 均 往 返 时 间 更 长 一 些 。
图 5-8( b)中的一段虚线表示 如果 M ] 正 确 到达 B 同 时A 也正确收到确认的过程。 可见重传时
间应设定为比平均往返时间更长一 些 。 显然 ， 如果重传时间设定得很长 ， 那么通信的效率就

CD 注 ： 在可靠传输的协议中 ， 也 可 以 在检测 出 有差错时 发送 ＂ 否认报又 “ 给对方。 这样做 的好处是(cid:7135)够让发送方及早知道

出 现 了 差错 。 不过 由 于这样处理会使协议复杂化， 现在实 用 的 可靠传输协议都不 使 用 这种 否认报文 了 。

＠ 注 ： 编 号 并不是 一个非常 简 单 的 问 题 。 分组编号使用 的位数总是有限 的 ， 同 一个号码会重复使用 。 例 如 ，

1 0 位的编号
范 围 是 0 - 1 023 。 当编号增加到 1 023 时 ， 再增加 一个 号 就 又 回 到 O , 然后重复使用 这些号码 。 我们 的家用 电 表 、 水表 ， 以及汽
车 中 的里程表 ， 都有类似 的 问 题 。 因 此 ， 在所发送的分组 中 ， 必须(cid:7136)够区分开哪些是新发送的 ， 哪些是重传 的 。 对千简单链路上
传送的帧 ， 如采用 停止等 待协议 ， 只 要用 1 位编号 即 可 ， 也就是发送完 0 号 帧 ， 收到确认后， 再发送 l 号 帧 ， 收到确认后 ， 再发
送 0 号 帧 。 但是在运输层 ， 这种编号方法有时并不(cid:7135)保证可靠传输 （ 见 习 题 5- 1 8 ) 。

•  222 •

会 很低 。 但 如果重传 时 间 设 定得太短， 以致产生 不必要的重传 ， 就浪 费 了网络资源。 然而 ，

在运输 层重传 时间的准确设 定是非常复杂的， 这 是 因 为已发送出的分组到底会经过哪 些 网 络 ，

以及 这 些网络将 会产生 多 大 的 时延 （ 这 取 决 千 这 些网络当 时的拥 塞情况 ） ， 这 些都是不确定
因 素 。 图 5-9 中把往 返 时间当作固 定的 （这 显 然 不符合网络的实 际情况）， 只是为了 讲述原
理的方便。 关 千 重 传 时间应 如何 选择， 在后面的 5.6.3 节 还 要进 一 步讨论。

3. 确认丢失和确认迟到

图 5-9(a) 说明的是另一种情况 。 B 所发送的对 M 1 的确认丢 失 了 。 A 在设 定的超 时 重 传
时 间 内 没有收 到确认， 并 无法知道是自 已发送的分组出错 、 丢 失 ， 或者是B 发送的确认丢
失 了 。 因 此A 在超时计 时 器到期 后就 要重 传 M 1 。 现在应注意 B 的动作。假定 B 又收到了
重 传的分组M 1 。 这时应采取 两 个行动 。
第一 ， 丢弃这个重 复的分组M 1
第二 ， 向 A 发送 确认。 不能认为已经发送过确认就 不再发送 ， 因 为A 之所以 重传 M 1

, 不向 上 层重 复 交付。

就表 示A 没有收到对M 1 的确认。

A,

B

MI

送

发

丁3
l­
L

＿

-

-

超

时

重

M

-

-

发送 M

超 时 重

M

B

A

l：

确 认 M

l

I

传

送 M

发

2

—

I

传
发

送 M

收下迟 到 的 确 认
2
但什么 也 不 做

(a)

确 认 丢 失

(b)

确 认 迟 到

图5-9 确 认 丢 失和 确 认 迟 到

图5-9(b)也是一种可能出现的情 况 。 传 输过程中 没有出现差错， 但 B 对分组 M ] 的确认
迟到了 。 A 会收到重 复的确认。 对重 复的确认的处理很简 单： 收 下 后就丢 弃 ， 但 什么也 不做 。
B 仍然会收到重 复的M 1

, 并 且 同样 要 丢 弃 重 复的M j ， 并 重传确认分组。
通常A 最终总是可 以收到对所有发出的分组的确认 。 如果A 不断重传 分组但总是收 不

到确认， 就 说明通信 线 路太差 ， 不能进 行 通 信 。

使用上述的确认和 重 传 机制， 我们就可 以在不可靠的传输网络上实现可靠的通信 。
像上述的这种可靠 传输协议常称 为 自 动 重传请求 ARQ (Automatic Repeat  reQuest) 。 意 思
是重传的请求是自 动进 行的， 因 此也可见到自 动请求重传这样的译 名 。 接收方不需要请求发

送方重传 某 个出错的分组 。

4. 信道利 用 率

停 止等待 协议的优点是简 单 ， 但缺点是信道利用率太低 。 我们 可 以用图 5-10 来 说明这

个问题。 为简 单起 见 ，假定在A 和 B之间有一 条直通的信道来传送分组。

•  223  •

图 5- 1 0 停 止 等 待 协 议的信 道 利 用 率太低

假定 A 发送分组需 要的时间是 TD 。 显 然， 几等千分组长度 除 以 数据 率 。 再假定 分组 正
确到达 B 后，B 处理分组的时间可 以 忽 略不计， 同时立 即发 回 确认 。假定 B发送确认分组
需 要时间 TA 。 如果A 处理确认分组的时间也 可 以 忽 略不计， 那么A 在经过时间(To + RTT +
八）后就可 以 再发送下一个分组， 这 里的 RTT 是往返 时间。 因为仅仅是在时间 几 内 才用来
传送 有用的数据 （ 包括分组的首部）， 因此信道的利用率 U 可用 下式计算 ：

TD

(5-3)

U =

L + RTT + T

请注意 ， 更细致的计 算 还可 以 在上式分子的时间 几 内 扣 除传送 控制信 息（ 如首部） 所

D

A

花 费的时间。 但 在进行粗略计算时， 用近似的式(5-3)就可 以 了 。

我们知道， 式(5-3 )中的往返时间RTT 取 决 千所使用的信道。 例如，假定 1200 km 的信
道的往返 时间RTT = 20 m s , 分组长度是1200 bit , 发送速率是1 Mbit/s 。 若 忽 略 处理时间和
一般 都远小千 T矿， 则 可算出信道的利用率 U =  5.66% 。 但若把发送速率 提 高到 10
TA  ( TA
Mbit/s , 则 U = 5.96 X  10-3 。 信道在绝 大 多 数 时间内 都是空 闲 的。

从图 5-10 还可看出， 当往返时间RTT 远 大于分组发送时间 几 时， 信道的利用率就会
非常低 。 还应注意 的是， 图 5-10 并 没有考虑出现差错后的分组重传 。 若出现重传， 则 对传
送 有用的数据 信 息来说， 信道的利用率就 还 要 降低 。

为了提 高传 输 效 率， 发送方可 以 不使用低 效 率 的停 止等待 协议， 而是采用流水线传输
（如图5-11 所示） 。 流水线传输就是发送方可连续发送 多个分组， 不必每发完一个分组就停
顿 下来等待 对方的确认 。 这 样可 使信道上一直有数据 在不间断地传送 。 显 然， 这种传输方式
可 以 获得 很高的信道利用率 。

//饕荨鬟�:

当使用流水线传输时， 就 要 使用下面介绍 的连续ARQ 协议 和滑动 窗 口 协议 。

图 5- 1 1 流水线传输可提高信 道 利 用 率

5.4.2  连续 ARQ 协 议

滑 动 窗 口协议 比较复杂， 是TCP协议的精髓所在 。 这 里先给出连续ARQ 协议最基本的

概念， 但不涉及许 多 细节问题 。 详细的滑动 窗 口协议将 在后面的 5.6节中讨论。

图 5-12(a)表 示发送方维 持的发送 窗 口 ， 它 的意 义是： 位 千发送窗 口内 的 5 个分组都可

• 224 •

连续发送出去， 而不需要等待对方的确认。 这样， 信 道利 用率就 提高了。

在讨 论 滑 动 窗 口时， 我们应当注 意 到 ， 图中还有一个时间坐 标 （ 但以后 往 往 省 略 这样
是 指 “ 向着时间增大的方向
向着时

的时间坐标）。 按照习惯，

向前

， 而

则是

向后

“

“

“

“

”

”

间 减少的方向

”
。 分组发送是按照分组序 号从小到大发送的。

分

组

的 序 号

送 窗 口二二I

I

发

I 6  |  7  |  8  |  9  | 1 0 | l l  I 1 2  |

(a)

发

送 窗 口 是 5

送 窗 口 一 向 前
7
5

4

6

发
3

2

8

9
  1 0

1 1

1 2

伽 t

(b) 收 到

个确 认 后

送 窗 口 向 前滑动

发

图 5- 1 2

一
连续 ARQ 协议 的 工 作 原理

连续 A RQ 协 议 规 定 ， 发送方每收到 一个确认， 就把发送窗口向前滑动 一个分组的位置。
图 5-1 2( b )表示发送方 收到了对第 1 个分组的确认， 千是把发送窗 口 向前移动 一个分组的位
置。 如果 原 来 已经发送 了前5个分组， 那么现在就可以发送窗口内 的第 6个分组了。

接收 方 一 (cid:7183) 都 是 采用 累 积 确 认的方 式。 这 就是说， 接收 方 不必对收 到的分组逐个发送
确认， 而是在收到 几个分组后 ， 对按 序 到 达 的 最 后—个分组发送确认， 这 就表示： 到 这个分
组为止的所有分组都 已 正 确 收到了。

累 积确认有优点也有缺点。 优点是 容 易 实现， 即 使确认丢 失也不必重传 ； 但缺点是不

(cid:7126)向发送方及时反 映 接收 方 已 经 正 确收到 所有分组的信 息。

例如， 如果发送方发送了前 5 个分组， 而中间的第 3 个分组丢 失 了。 这 时接收方只(cid:7126)

对前两个分组发出确认。 发送方无法知 道后 面三个分组的下落， 而只好把后 面的三个分组都
再重传一次。 这 就 叫作 Go-back-N （ 回 退 N)， 表示需要再退 回 来 重传已发送过的 N 个分组。
可见当通信线路质 量 不好时， 连续A RQ 协 议会带 来 负 面的影 响。

在深入讨 论 TCP的可靠传输问题之前， 必须先了解 TCP的报文段首部的格式。

5.5  TCP 报文段 的 首 部格式

TCP 虽然 是 面向字(cid:7188)流的， 但 TCP传送的数据单元 却 是 报文 段。 一个
TCP 报 文 段分为首部和数据 两部分， 而 TCP的全部功(cid:7126)都体现在它首部中

各 字段的作用。 因此， 只有弄清 TCP首部各 字段的作用才(cid:7126)掌握 TCP的工

作 原理。 下面讨 论 TCP报 文段的首部格 式。

TCP报文段首部的前 20 个字(cid:7188)是 固定的（ 如图 5- 13 所 示）， 后 面有4n 字(cid:7188)是 根据需要

而增加的选项 ( n 是 整数）。 因此 TCP首部的最小长度是 20 字(cid:7188)。

首部固定部分各 字 段的意 义如下：

(

) 源端 口 和 目 的 端 口

各 占 2个字(cid:7188)， 分别 写入源端口号和目的端口号。 和前面图

5-5 所示的 UDP的分用相 似， TC P 的分用功(cid:7126)也是 通过端口实现的。

( 2) 序号

号 增加到 232 -1 后 ， 下一个序 号 就 又 回 到0 。 也就是 说， 序 号使用 mod 232

占4 字(cid:7188)。 序 号 范 围是 [O, 232 — l ]， 共 232（即4 294  967  296) 个序 号。 序
运算。 TCP是 面

•  225 •

1
