为了解决上述问题， 一种保 留 了 MPLS 的主要特 点， 但 更加简单的新的源路由选择 协
议出现了。 这 就是 段 路 由 选择协议( Se gme nt Routing )， 简称为 S R。 但不少人都使用 ＂
段路
由协议 ” 这样更加简单的名 称。 在 S R 中， ＂ 段( s
e gme nt ) " 就是 标 签， 也就是转发指令的一
种标 识 符 。 S R 的工作原理仍然 是 基于标签交换的， 不过现在不需要使用协议 LDP, 因此简

化 了设备运行的协 议数量。 S R 由源(cid:7188)点为发送的报文指定 路径， 并将路径转换成有序的段

列 表( Se gme nt Lis t )， 即 MPLS 标 签 栈， 它 被 封 装在分组首部。 网络中的其他(cid:7188)点就执行首

部中的指令（即 标签） 进行转发。

整个网络设有控制器， 也就是 SDN 控 制器（见 4 .10 (cid:7188)）。 控 制器收集并掌 握 全 网的拓

扑 信 息和链路状 态 信 息， 计算出分组应传送的整个路径。 控 制器 负 责 给分组分配 S R 标签，

这 些标 签指明了分组从源点到终点的路径。 当分组到达某个网络(cid:7188)点时， (cid:7188)点就根据分组携
带的标签转发到下 一个(cid:7188)点。

现在 S R 还 向IPv6 演进， 这 就是 S Rv6。 它直接利用IPv6 字段作为标签 寻 址。而前面介

绍的在 MPLS 基础 上的 S R 则称为 S R-MPLS。

4 . 1 0   软件定 义 网 络 S DN 简 介

SDN 的概念最初由斯坦福大学 N . McKe own 于 200 9 年首先 提出。 当时还只是在学术 界
进行探讨的一种新的网络体系结构。 但随后几年发展很 快， 不少 企业相 继采用。 其中最成功
的案例就是 谷 歌 建于 2010 ~  201 2年的数据中心 网络 B4 。 几 年 来 网络 B4 运行的结果证明，

基千 SDN 的专用广域网确 实可以大大 提高网络 带 宽 利 用率， 网络运行更加稳定， 管理更加

高效简化 ， 运行费用也明显 降 低了。 目前， SDN 已经 引 起人们的密 切 关注 。

在本章 开始的 4 .1 . 2 (cid:7188)， 我们初 步介绍 了网络层数据层面和控制层面的基本概 念 。 现在

有关 SDN 的资 料 已相 当丰 富 。 限千篇 幅， 下 面我们只(cid:7126)对 SDN 进行简单的介 绍 。

我们知道， 在 SDN 中， 数据层面中的交换机是由控制层面进行控制的， 图4-70 表明这
种控制是 通过协 议 Ope nFlow 来 实现的。 协议 Ope nFlow 是 一个得到高度认可的标 准， 在讨
论 SDN 时往往与 Ope nF low 一起 讨 论。 因此， 有人会误认为 SDN 就是 Ope nFlow。 其实 这
二者 有着很大的 区 别 。 SDN 不是 协 议， 更 不是 一种产 品 。 SDN 是 一个体系结构， 是 一种设
计 、 构建和管理网络的新方法或新概 念， 其要点就是 把网络的控 制层面和数据层面分离， 而

让 控 制层面 利用软件 来 控 制数据层面中的许多设备。 可以把协 议 Ope nFlow 看成是在 SDN

体系结构中控制层面和数据层面之 间 的通信 接口， 它使得控 制层面的控制器可以对数据层面

中的物理设备或 虚拟设备， 进行直接访问和操 纵。 这种控制在逻辑上是集 中 式 的， 是 基千 流

的控制。

AP 1

AP2

控制层面 （ 网 络操作 系 统 ）

协议 OpenFlow

数据层面

图 4-70 协议 OpenFlow 是控制 层 面 和 数据 层 面 的 接 口

协 议 Ope nFlow 1 .0 是 200 9 年底发表的最早的版本， 之后每年都进行更新， 经过1 2次

• 1 94  •

更新， 到 2015 年 3 月 发布了版本 1.5.1 (283 页 ）， 但 目前较为成熟的是1.3 版本。 OpenFlow
的技术规范 由开放 网络基金会 ONF (Open Netwoking Foundation)负 责制 定。 这 是一个非营利
性的产 业联盟，其任务是致力 于 SDN 的发 展 和标 准 化。 但请注意 ， SDN 并未规 定必须 使用
OpenFlow, 只 不过是大部分 SDN 的产 品 采用了 OpenFlow 作为其 控制 层面与数据 层面的接
口 。

传 统意 义上的 数据 层面的 任务就是根据 转发表来转发 分组。 可 以再把 “ 转发 “ 细 分一
下。 实际上这 里 有 两个步 骤。 第一个步骤是 ＂ 匹配 “， 即 查找转发表中的网络前缀， 进 行最
长前缀 匹配。 第二个步 骤是 “ 动 作 “， 即把分组从指明的接口 转发出去。 这种 “ 匹配 ＋ 动
作” 的转发 方式 在 SDN 中得到了扩充， 增加了 新的内 容， 变成了广义的转发。 这种广 义的
转发 使得 “ 匹配 ＋ 动作“ 有了新的内 容。

在 SDN 的广 义转发中， “ 匹配 “ 能够 对 不 同 层次 （链路 层 、 网络 层、 运输 层） 的首部
中的字段进 行 匹配， 而 “ 动 作” 则不仅是转发 分组， 而且可 以把具 有 同样 目的地址的分组从
不同的接口 转发出去 （为了负 载均 衡）。 还可以重 写 IP首部 （ 如 同 在 NAT 路由器中的地址
转换）， 或者可 以 人为地阻挡 或丢 弃 一 些 分组 （如同 在防 火墙中一样， 见 7.7.1 节）。 请注意 ，
这 里为了讨论问题的方便， 在讨论 SDN 的问题时， 不管 在哪一 层传送的数据 单元， 都称为
分组。

这 样， 在 SDN 的广 义转发中， 这种完成 “ 匹配 ＋ 动 作” 的设 备， 就 不应当称为路由
器了， 而是叫作 “ 分组交换机 ” 或 “ OpenFlow 交换 机 ”， 或更简 单些就称为 “ 交换 机 ”。 这
种 交换 机 并 不局 限 在网络 层工 作 （例如， 可 使用 L2/L3 交换 机）。 在 SDN 中， 取代传统转发
表的是 “ 流表 ” (flow table)。 因此， 流表就是 ＂匹配 ＋ 动作” 的转发表。

图4-71 强调了一个重 要概念： OpenFlow 交换 机中的流表是由远程 控制器来管理的， 而
远 程 控制器 通过一个安全信道 （见 7.6.2 节）， 使用 OpenFlow 协议来管理 OpenFlow 交换 机
中的流表。 这 样， OpenFlow 就 有了双 重意 义。 一方面， OpenFlow 是 SDN 远 程 控制器与网
络设 备 之 间 的 通信 协议；另一方面， OpenFlow 又是网络 交换 功 能的逻 辑 结 构的规 约。 我们
还应注意 到， 尽管网络设备 可 以 由不同厂 商来生产， 同时也可以 使用 在 不 同 类 型 的网络中，
但从 SDN 远程 控制器看到的， 则是统一的逻辑 交换功 能。

＿＿＿＿＿＿＿＿＿-

OpenFlow 协议

网
络
设
备

OpenFlow 交 换 机

SDN 远程
控制 器

图 4-7 1   OpenFlow 协 议 与 OpenFlow 交换机

我们 在 4.5.1 节 介 绍 1Pv6 首部的流标号时， 曾 初 步地提到 “ 流 ” 的概念。 在 OpenFlow
的各种文档中都 没有 “ 流 ” 的 定义。 其实从 OpenFlow 交换 机的角 度来看， 一个流就是穿过
网络的一种分组序列， 而在此序列中的分组都共享分组首部某些 字段的值。 例如， 某 个流 可

以是具 有 相同源 IP地址和 目的 IP地址的所有分组。

图4-72 给出了 OpenFlow 1.0 版本的流表和分组的首部匹配字段 （这 是最简 单的一个版
本， 便于用来讲解工作原理） ［KUR017]。 每个 OpenFlow 交换 机必须 有一个或一个以上的
流表。 每 一个流表可 以包括 很 多 行， 即 多个流表项(flow entry)， 它包括三个字段， 即首部字

• 195 •

段值 （ 又称为匹配字段）、 计数器和动作。 下面解释这 三个字段的意 思。

动 作

动 作

匹配
字段 1

入

端 口

以太网

VLAN

IP

TC P/UDP

1浒地 址1 目 的 地 址1类 型 I ID1仇先级1 游地址1目 的地 址h加对服 务 类 型丿五 口 1目 的湍 口
运输层 一
•

网 络 层

链 路 层

•  •

瞿 一

图 4-72 OpenFlow  1 .0 版 本 的 流 表 和 分 组 的 首 部 匹 配字段

—

首部字段值 ： 这 是 一组字段， 用 来 使入分组(incoming packe t)的对应首部与 之相匹配，

因 此又 称 为 匹 配 字 段。 匹配不上的分组就 被 丢弃， 或 发 送到 远程控 制器做更多的处理。 图
4-72 所 示的匹配字段有11 个项目涉及 三个层次的首部。 这 就是说， Ope nflow 的匹配抽 象

与我们以前讲过的分层的原则明显 不 同 。 在 Ope nflow 交换机中， 既可以处理链路层的帧，

也可以处理网络层的IP分组和运输层的报文。

计 数 器 ： 这 是 一组计数器， 可 包 括 已经与该表项匹 配的分组数量， 以及 从 该表项上 次

更新到现在经历的时间。

动 作 ： 这 是 一组动作， 例如， 当分组匹 配 某个流表项时把分组转发到指明的端 口， 或

丢弃该分组， 或把分组进行复制后再从 多个端口转发出去， 或重写分组的首部字段（第 二 、
三和四层的首部字段）。

为 了更好地理解流表的匹配与 动作， 我 们 讨 论下 面几个例子[KU R01 7]。 图4- 73 给出的

简单网络有 6 台 主机 C H 1 ~  H6)， 其IP地址标注在主机 旁边， 还有3 台 分组交换机 ( S 1 ~

S3)。 每台 交换机有4 个端 口 （即 接 口 ， 编号为1 (cid:7170) 4 )。 还有1 台 Ope nflow 控 制 器 来 控 制
这 些分组交换机的 ＂ 匹配 ＋ 动作

“
。

OpenFlow 控 制 器

10.3.0.6

1 0.3.0.5

二
/ HJl 1 0.2.0.3

H1--＼ H2、l

_  ＿

l O l O 2

l O  l O l

简 单转发 的 例 子

．个
图 4-73  OpenFlow " 匹 配 ＋ 动 作

～ ．七 ．

网 络

“

我们设定的转发规则是 ： 来 (cid:7151) 凡或 儿 发往 儿或 儿 的分i门 都先从 S3 转发到 S 1, 然

后再从 S 1 转发到 S2, 但不通过 S3 到 S2 的链 路。 根据这个转发规 则 ， 可以得出交换机 S3 的

流表项是 ：

• 1 96  •

IP 源地址 ＝ 1 0.3.*. * ;

IP 目 的 地址 ＝ 1 0.2.*.*

匹配

动作

转 发(3)

这里使用了通配符＊。 例如， 地址10 .3. * ． ＊ ， 表明这样的地址将 匹配前1 6 位为10 .3的任何地

址。 ”转发(3) " 表明分组转发出去端口是 交换机编号为3的端口。

交换机 S 1 的流表项 （ 这里和后面都 省 略 了计数器字段） 是：

入端 口 ＝ I ;

IP 源地址 ＝ 1 0.3.*. * ;

IP 目 的地址 ＝ 1 0.2 * *

匹配

和 S3 的流表项相 比， 这里多了

“入端 口 ＝ l "。 表明 ” 匹配 ＂ 仅 限于从编号 l 的端口进入交

换机 S 1 的分组。

交换机 S2 的流表项是：

匹配

IP 源地址 ＝ 1 0.3.*. * ;

IP 目 的地址 ＝ 1 0.2.0.3

IP 源地址 ＝ 1 0.3.*. * ;

IP 目 的地址 ＝ 1 0.2.0.4

动 作

转 发(3)

转 发 (4)

负载均衡的 例 子

在图4-73中， 为了均衡链路 S2- S 1 和链路 S3-S

的通信 量， 我们 规定： 凡是从 H3 发往主
机10 .1 . ＊ ． ＊的分组， 其转发路径应为 S2- S 1。 但凡是从 儿 发往主机10 .1 . ＊ ． ＊的分组， 其转发

路径应为 S2- S3 - S 1 。 显然 ， 采用基千 IP 目的地址的转发方法， 是 不(cid:7126)实现这种负 载的均

]

衡的。 但在本例中， 只要在交换机 S2 的流表项中设置好合 适的匹配项目即 可。

交换机 S2 的流表项是：

匹配

入端 口 ＝ 3 ;

IP 目 的 地址 ＝ 1 0. 1 .*.*

入端 口 ＝ 4 ;

IP 目 的地址 ＝ J O. I .* *

动作

转 发 (2)

转 发( I )

防火墙的例子

假定我们在交换机 S2 中设置了防 火墙， 此防火墙的作用是仅仅接收来 (cid:7151) 与交换机 S3相

连的主机所发送的分组（ 不 管 是从哪 一个端 口进来的）。 根据这样的规定可得出下列 内 容。

交换机 S2 的流表项是：

匹配

IP 源地址 ＝ 1 0.3.*.* ;

IP 目 的地址 ＝ 1 0.2.0.3

IP 源地址 ＝ 1 0. 3 .* . * ;

IP 目 的地址 ＝ I 0.2.0.4

动作

转 发 (3)

转 发(4)

虽 然 上 面举出的例子非常简 单 ， 但 已经可以看出这种 广 义 转发的多样性和灵 活 性。 广

义转发的优点是显而 易见的。

•  1 97  •

下面通过图4-74 简 单介绍 一 下 SDN 的 控制 层面[KREN15] [KUR017]。

网 络控制 应 用 程序l

路 由 选择 . . .  接入控制
司
司[

广
；

控

制

面

层

l
'
，

'
r
'
,
'

N

:，

D

}

}

一

}

．一

．

数

据

层

面

丿

l

l

l
』
l
l
l
l
l

,
＇
j

心

知心
,
 ]

S
网

（

络

操

，
＇

控
作

制
系

器
统

－

}

}

＇

叶，
勺
心
0
-

l
l
l

l

l
,
'，
＇

：

、
丿,

l
l
」
,
'
，

,

_

叩
穸
芯

：
，

、

态

s

ND

告控

I­
的

换交

八
，

}

机

负载均衡

,
'

'

r

,
,
'

,
＇
，

了，

＇
，
＇
，
＇

）

北

向

API

南

向

API

图 4-74

SON 体系结构 的构件

从图4-74 可 以反 映出 SDN 体系 结构的四个关键特征：
基千流的转发。 SDN 控制的 交换 机 分布 在数据 层面中， 而分组的转发 可 以基 于网络 层、
运输 层和链路 层协议 数据 单元中的首部字段值进 行。 这 和传 统的路由器仅仅根据 IP分组的
目的地址进 行 转发 ， 有 着 很大的区 别。 SDN 的转发 规 则 都精确规 定在 交换 机中的流表中。
所有 交换 机中的流表项， 都是由 SDN 控制器进 行 计 算 、 管理 和安装的。

数 据 层 面 与控制层 面分离。 在许 多 英语 文 献 中 常使用 “ decouple " 一 词 ， 相应的中文就
是 “ 去 耦 ＂。 在传 统的转发 设 备 路由器中，其数据 层面与 控制 层面 都处 在同一个设 备中， 因
此二 者耦合得非常紧 密。 但在 SDN 中， 则把这 两个 层面去 耦合， 使二者 不在同一个设备中 。
这 点 在图 4-73 中看得 很清 楚。 数据 层面有 许 多 相对简 单但快速的网络 交换 机。 这 些 交换 机
在其流表中执行 “ 匹配 ＋ 动 作” 的规则。 而 控制层 面则由若 干 服务 器和相应的软件 组成，
这 些服务 器和软件 决 定 并 管理这 些 交换 机中的流表。

位千数 据 层 面 交 换机之外的 网 络控制 功 能。 SDN 中的控制 层 面 是用 软件实现的， 而且
软件是处 在 不 同 的 机 器上， 并 且 可能 还远 离 这 些网络 交换 机。 从图 4-74 可 以看出， SDN 控
制 层 面包含两 个构件， 一个是SDN 控制器 （也就是网络操作系 统）， 另 一个由若 干个网络 控
制应用 程序组成。 SDN 控制器维 护 准 确的网络状态信 息 （例如， 远 程链路、 交换 机 和 主机
的状态）， 把这 些信 息 提供给运 行 在 控制 层面的各种 控制应用 程序， 以及提 供一些方法 ， 使
得 这 些 应用程序能够 对底 层的许 多 网络设 备 进行监 视 、 编程和 控制。 需要注意 的是， 在图
4-73 的 SDN 控制器中只画 了 一个服务 器， 但这只是强调 在逻辑上是集中 控制的。 实际上，
在 控制 层 面中总是使用多个分散的服务 器协调地工 作， 以便 实现可扩展 性和高可用性。

可 编 程的 网 络。 通过在 控制 层面的一些网络 控制应用 程序 ， 使整个网络成为可编程的。
这 些应用 程序相当 千 SDN 控制 层面中的 “ 大脑 ”, SDN 控制器 使用这些应用 程序， 在这 些
网络设 备中指明和 控制数据 层面。 例如， 路由选择网络 控制应用 程序能够确 定在源点 和终点

之间的端到端 路径 （这需要执 行 某种算法， 也需要 使用由 SDN 控制器维护的节点状 态 和链
路状态 信 息）。 网络应用 程序 还可 以进行 接入 控制， 即决 定哪些分组在进入某 个 交换 机时就
必须被 阻挡住。 此外， 网络应用 程序 在转发 分组时 还可以执行 负 载均衡的措施。

从 以上的简 单例子可 以看 出， SDN 把网络的许 多 功 能都 分散 开 了。 数据 层面的 交换 机 、
SDN 控制器 以及 许 多 网络 控制应用程序， 这 些都可 以是分开的实体， 并 且可 以 由 不同的厂

• 198 •

商 和 机构来提供 。 这 就 和传统网络截 然 不同。 在传统网络中， 路由 器或 交换 机是由单独的厂
商 提供的，其 控制 层面和数据 层面以及协议的实现， 都是垂直集成在一个 机器里面的。 目前
出现的这种变化， 有点 像当初 计 算 机的演变。 早期的大型 计 算 机， 从硬件 到 软件 以及 应用 程
序， 都是由 一个单独的厂 家生产完成的。 但后来演变 到现在的个 人 电脑，其硬件 机身 、 操 作
系 统 以及上 层的应用 程序， 可 以由 多个厂家 分别生产 和提供， 这 样的系 统就变 得 更加开放，
其功能也更加丰 富了。 SDN 也可能 有这 样的发 展结果 。

图4-74 还给 出了SDN 控制器和下 面 数据 层面的受 控 设 备的 通信 接口， 即南 向 API, 以

及 SDN 控制器和上面网络 控制应用 程序的接口， 即北 向API。

SDN 控制器是最复杂 的， 它 还可 以划分为如图4-75 所示的三个 层次 。

-------------------------D-- － - － － － - － － － － － － － － － － － - － － － － － - － － －

北 向 API

到 网 络控制

与 网络控制应用程序 的通信

应 用 程 序 层的接口 巨亘量］三

．． ．三

霍卢言了 ；

N
器

lJ

与 数据层面 中 受控设备的通信

通信层 压

．． ．三

／

M

／

用

/

要

/

;////／/／

／各／

/:

/／

表

／

／

换

／

3器口/用来／／／／：

：

／

／述

／

／

／／

／／

:

／

／

理

／

•  1 99  •

制应用 程序把得 到的网络 事 件进 行 通告 ， 并 采取 相应的动 作 ， 例如 ， 计 算新的最低开销的路
径。 这 一 层可 以提供 不 同类 型的 API。 例 如 ， REST 风 格的 API 目前 使用得较 多 。 图中的
REST  (REpresentational  State  Transfer) 即表述性状态传递 ， 是一种针 对网络应用的设计 和开
发 方法[W-REST]。 图中的 I ntent 是对要进行的操作的一种抽 象描述[W- INTENT] ， 可用它 在
组件之间传递 数据 。

目前已经出现了一 些开放源代码控制 器， 或简 称为开源控制 器(Open Source Controller) ,

最 有代表性的就是OpenDaylight 和 ONOS。 这 里就 不再进 行讨论了。

本章的 重要概念

•

•

TCP/ IP体系 中的网络 层向上只提供简 单灵 活的、 无连接的、 尽最大努 力 交付的数
据 报服务。 网络 层 不提供服务质 量的承诺 ， 不保证 分组交付的时限 ， 所传送的分组
可能出错、 丢 失、 重 复 和失序。 进 程之间通信的可靠 性 由运输层 负 责。
IP网是虚 拟的， 因为从网络 层上看， IP网就是 一 个统 一的、 抽 象的网络（ 实际上
是异 构的）。
IP层抽 象的互联网屏 蔽了下 层网络 很 复 杂 的细节 ， 使我们能够 使用统
一的、 抽 象的 IP地址 处理主机之间的通信问题。

•  互联网上 交付 主机的方式 有 两种： 在本网络上的直接交付（ 不经过路由器） 和 到其

他网络的间接交付（ 经过至少一 个 路由器， 但最后一 次 一 定是直接交付）。

•  一 个IP地址 在整 个互联网范围 内 是唯 一的。 早期 使用的是分类的 IP地址 ， 包括A
类、 B 类 和 C 类地址 （单播地址） ， 以及 D 类地址 （ 多 播地址）。 E 类地址未 使用。
•  分类的 IP地址 由网络号字段（ 指明网络） 和 主机号字段 （ 指明 主机） 组成。 网络

号 字段最前面的类别位指明 IP地址的类别。

•  目前已广泛 使用无分类域间路由选择 C IDR 记法把IP地址后面加上斜线 ” I " ， 斜
线后是前缀的位 数。 前缀（ 或网络前缀） 指明网络 ， 后缀指 明 主机。 前缀相同的连
续的 IP地址构成 “C IDR 地址块”。

•

•  C IDR 的 32 位地址 掩码 （或子网掩码） 由一 串 l 和 一 串 0 组成， 其中 1 的 个 数是
前缀的长度。 只要把 IP地址 和地址 掩码按位进 行 AND运算 ， 即可得出网络地址。
IP地址是一种分等级的地址结构。 IP地址管理机构 在分配IP地址时只分配网络前
缀 （ 网络号）， 而 主机号则由得 到 该网络前缀的单位 自行分配。 路由器仅根据 目的
主机所连接的网络前缀 （网络号） 来转发 分组。
IP地址标志 一 台主机（ 或 路由器） 和一 条链路的接口。 多 归属 主机 同时连接到 两
个或更 多 的网络上。 这 样的 主机同时具 有 两 个或更 多 的 IP地址 ， 其网络前缀必须
是不 同的。 由于一 个 路由器至少应当连接到 两个网络 ， 因 此一个 路由器至少应当有
两 个 不同的 IP地址。

•

•  按照互联网的观点 ， 用转发 器或网桥连接起来的若干 个 局 域网 仍为一个网络。 所有
分配到网络前缀的网络（ 不管是范围 很小的局 域网， 还是可能覆 盖 很大地理范围的

广 域网） 都是平等的。

•  MAC地址（ 即硬件地址或物理地址） 是数据 链路层 和 物理层 使用的地址 ， 而IP地
址是网络 层和以上各 层 使用的地址 ， 是一种逻辑地址 （用软 件 实现的） ， 在 数据 链
路 层看 不见数据 报的 IP地址。
IP数据报 分为首部和数据 两部分。 首部的前一部分是固 定长度 ， 共 20 字 节 ， 是所

•

•  200 •

