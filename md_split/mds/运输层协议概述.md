第 5 章 运输层

本 章 先概括 介 绍 运输层协 议的特 点、 进程之 间 的通信和端口等重要 概 念 ， 然后讲 述比
较简单的 UDP协议。 其余的篇 幅 都是 讨 论较为复杂但非常重要的 TCP协 议 CD和可靠传输的工
作 原理， 包 括 停 止 等 待 协 议和 A RQ 协议。 在详细讲述 TCP 报 文 段的首部格 式 之后， 讨 论

TCP的三个重要问题： 滑动 窗口、 流量控制和拥塞控制机制。 最后， 介 绍 TCP的连接管理。
运输层是 整个网络体系结构中的关键层次之一。 一定要弄清以下一 些 重要概 念：
(1 ) 运输层为相 互通信的应 用 进程 提供逻辑通信。
( 2) 端 口和套接字的意 义。

(3) 无连接的 UDP的特 点。

(4 ) 面向连接的 TCP的特点。

( 5 ) 在不可靠的网络 上实现可靠传输的工作原理， 停 止 等 待 协 议和A RQ 协 议。

( 6 )  TCP的滑动 窗口、 流最控制 、 拥 塞控 制和连接管 理。

运输层协议概述

5 . 1

5. 1 . 1   进程之 间 的 通信

从通信和信 息处理的角 度看， 运输层 向 它 上 面 的 应 用 层 提 供 通 信 服 务 ， 它 属千面向通

信部分的最高层， 同 时也是 用 户 功(cid:7126)中的最低层。 当网络边缘部分的两 台 主机使用网络 核 心

部分的功(cid:7126)进行端到端的通信时， 都要使用协议 栈中的运输层， 而网络 核 心部分中的路由器

在转发分组时只用到下三层的功(cid:7126)。

下面通过图 5-1 的示 意图来说明运输层的作用。 设 局 域网 LAN 1 上的主机 A 和局 域 网

LAN 2 上的主机 B 通过互 连的广 域网 WAN 进行通信。 我们知道，IP协议(cid:7126)够把源主机A 发

送出的分组， 按照首部中的目的地址， 送交到 目的主机 B, 那 么 ， 为什么 还需要运输层呢？

从IP层来说， 通信的两端是 两 台主机。 IP数据报的首部明确地标 志了这 两 台主机的IP

“ 两 台主机之间的通信

这种说法还不够明确。 真 正进行通信的实体是 在主机中的
地址。 但
哪个构件 呢？ 是主机中的应用进程， 是 一 台 主机中的应 用 进程和另 一 台 主机中的应 用 进程在
交换数据（即 通信）。 因此严 格地讲， 两 台 主机进行通信 就是两 台 主机中的应 用 进程互相通

”

信。 IP 协 议 虽 然(cid:7126)把分 组送到 目 的主 机， 但是这个分组还 停 留 在 主机的网络层而没有交付

主机中的应用进程。 通信 的 两端应 当 是两个主机 中 的 应 用 进程。 也就是说， 端 到 端 的 通信是
应用进程之间的通信 。 在一 台 主机中经常有多个应用进程同 时分别和另 一 台 主机中的多个应
用进程通信。 例如， 某用户 在使用 浏 览器查找某网站的信 息时， 其主机的应用层运行浏 览器

客 户 进程。 如果在浏 览 网 页的 同时， 还要用 电子邮件给网站发送反馈意见， 那 么 主机的应用

＄ 注 ： 运 输 层 最 近 又增 加 了 第 三 种 协 议 ， 即 流控制传输协议 SCTP (Stream  Control  Transmission  Protocol)  [RFC 4960 , 建 议

标准］ ， 它 具 有 TCP 和 UDP 协 议 的 共 同 优 点 ， 可 支 持

一

些 新 的 应 用 ， 如 IP 电 话 。 限 千 篇 幅 ， 这 里 不 再 介 绍 。

•  21 1  •

层就 还 要运行 电 子邮件的客户 进 程 。 在图5-1 中， 主机A 的应 用 进 程AP1 和 主机 B的应 用
进 程 AP3 通信， 而与此同时， 应 用 进 程 AP2 也 和对方的应用 进 程 AP4 通信 。 这表明运输 层
复 用 (m ultiplexing)和分用 (dem ultiplexing) 。 这 里的 “ 复用 “ 是指在发
有一个很重 要的功能
送方 不同的应用 进 程都可以 使用 同一 个运输 层协议传送 数据 （ 当然需要加上适当的首部 ）， 而
“ 分用 ” 是指接收方的运输 层在剥 去报 文的首部后能够把这些数据 正确 交付目的应用 进 程 气
图 5-1 中 两个运输 层之间有一个深 色 双 向 粗 箭 头 ， 写 明 ” 运输层提供应 用 进 程 间 的逻辑通
信 ” 。 ” 逻辑 通信 ” 的意 思是： 从应用 层来看， 只 要把应用 层报 文 交给下 面的运输 层，运输 层
就可 以把这 报 文传送到 对方的运输 层 （哪 怕 双方 相距 很远， 例如几千公 里 ）， 好像这种通信

就是沿水平 方 向 直接传送数据 。 但事实上这 两个运输层 之间并没有一条水平方 向的物理连接 。
数据的传送是沿着 图 中 的虚线方 向 （ 经过多个层 次 ） 传送的 。 “ 逻辑 通信 ” 的意 思是 “ 好 像
是这 样 通信， 但 事 实上 并 非真的这 样 通信 ” 。
三

主

的A

主

B 的 协议栈

应 用 进程

应 用 进程

运输层提供应用 进程 间 的逻辑通信

气享酰字心酗3酰翠咽霍覃芦霪霪霆麟单霹霉霆霉三叠“
I

层m....... :

·..................................... :

丿

IP

机
4

3

2

．

．

·

忙
…．
…．

．

豆[

．
．
＊

：
：：

'

.

1.

＇

主

A

艺Q

机

勹4

…·
2
+
…

3
…

．
．

.
•

．

1
L

}

tJ

B

主

`

机

'----L-----

－巴

、

:·

:

'

}

网 络 层 为主机之 间 的 通 信 提供服务

运输 层 为 应 用 层进程之 间 的 通信提供服务

＼

L

：

，：

图5- 1 运输 层为相 互通信的应 用 进程提供 了 逻辑通信

从这 里可 以看出 网 络 层和运输 层 有 明 显的区 别 。 网络层 为主机之 间 的通 信提供服 务 ，
而运输层则在 网络层的基础上 ， 为 应 用 进程之间的通信提供服务 。 然而 正 如后 面 还 要讨论的，
运输层 还具 有网络层无法代 替 的许 多其他重 要功能 。

运输 层 还 要 对收 到 的报文进 行 差错检测 。 大家 应 当 还记 得， 在 网 络 层， IP数据 报 首部

中的检验和字段， 只检验首部是否出现差错而 不检查数据 部 分 。

根据 应 用 程序的 不同需求，运输 层需 要 有两 种 不同的运输协议， 即面 向 连接的 TCP 和

无连接的 UDP, 这 两种 协议就是本章 要讨论的主要 内 容 。

我们 还应指出， 运 输层 向 高 层 用 户 屏 蔽 了 下 面 网 络核心的细节 （ 如网络拓 扑 、 所采用
的 路由选择协议等 ） ， 它 使 应 用 进程看见的就是好像在两个运输层实体之间 有一条端到端的
逻辑通信信道， 但这 条逻辑 通信 信道对上 层的表现却 因运输层 使用 的 不同协议 而 有很大的差
别 。 当运输 层采用 面 向 连接的 TCP 协议时， 尽 管下面的 网络是不可靠的 （ 只 提供尽最大努

＠ 注 ：

IP 层 也 有 复用 和 分 用 的 功 能 。 即 在 发送 方 使 用 不 同 协 议 的 数 据 都 可 以 封 装 成 IP 数据报发送 出 去 ， 而 在 接 收 方 的 IP

层 根 据 IP 首 部 中 的 协 议字段进行 分 用 ， 把 剥 去 首 部 后 的 数 据 交 付 应 当 接 收 这 些 数 据 的 协 议 。

•  212  •

力 服务）， 但这种逻辑 通信 信 道就相当于 一 条全双工的 可靠信道。 但当运输层采用无连 接 的
UDP 协议时， 这种逻辑 通信 信 道仍然 是 一条不可靠信道。

5 . 1 .2  运输层 的 两个主要协议

TCP/IP运输层的两个主要协 议都是 互(cid:7111)网的正 式标准， 即：
( 1) 用 户 数 据报协议 UDP( Us er Datagram Protocol) [RFC  768, STD6]
(2

)  f专输t空制协议 TCP( Trans mis

s ion C ontrol Protocol ) [RFC  793, STD7]

图 5- 2给出了这 两种协 议在协议栈 中 的位置。

UDP

应用 层

|

IP

TCP

与 各种 网 络接 口

图 5-2 TCP/IP 体 系 中 的 运输层协议

按照 OSI 的术语， 两个对等运输 实 体在通信时传送的数据单位叫作运输协议 数 据 单 元
TPDU  ( Trans port Protocol Data  Unit )。 但在 TCP/IP体系中 ， 则根据所使用的协议是 TCP或
UDP, 分 别 称 之为 TCP 报文段( s

e gment ) 或 UDP 用 户 数 据报。

UDP在传送数据之前不 需要先建立连接。 远地主机的运输层在收到 UDP报 文后， 不需

要给出任何确认。 虽 然 UDP不提供可靠交付， 但由于 UDP非常简 单， 在某些情况下 UDP
是 一种最有效的工作方式。

TCP 则提供 面 向 连接 的 服 务。 在传送数据之前必须先 建 立 连接， 数据传送结束后要释

放连接。 TCP 不 提供广播或多播服务。 由千 TCP要提供可靠的、 面向连接的运输服务， 因

此不可避免地增加了许多的开销， 如 确认、 流量控制、 计时器 以 及 连接管理等。 这 不仅使协

议数据单元的首部增大很多， 还要 占用许多的处理机 资 源。

表 5-1给出 了 一 些应用和应用层 协议主要使用的运输 层 协 议 ( UDP或 TCP)。

表 5-1 使用 UDP 或 TCP 协议 的各种应用和应用 层协议

应 用

应 用 层协议

运输层协议

名 字转 换

文 件 传 送

DNS （ 域 名 系 统 ）

TFTP （ 简 单 文件 传 送 协 议 ）

路 由 选 择 协 议

RIP  ( 路 由 信 息 协议 ）

IP 地址配置

网 络 管理

DHCP （ 动 态主 机配置协 议 ）

SNMP （ 简 单 网 络 管 理 协 议 ）

远 程 文 件 服 务 器

NFS （ 网 络 文 件 系 统 ）

IP 电 话

流 式 多 媒体通信

专 用 协 议

专 用 协 议

多 播

电 子 邮 件

lGMP （ 网 际组 管 理 协 议 ）

SMTP （ 简 单 邮件 传 送 协 议 ）

远程终端接入

TELNET （ 远程 终 端 协 议 ）

万 维 网

文 件 传 送

HTTP （ 超 文 本 传送 协 议 ）

FTP （ 文 件 传 送 协 议 ）

UDP

UDP

UDP

UDP

UDP

UDP

UDP

UDP

UDP

TCP

TCP

TCP

TCP

• 2 13 •

5 . 1 .3  运输层 的 端 口

前 面 已经 提到 过运输层的 复用和分用功(cid:7126)。 其实 在 日 常生 活 中 也有很多复 用和分用的
例子。 假定 一个机构的所有部门向外 单位发 出 的公 文 都 山 收发室 负 责 寄 出 ， 这相当千各部门
这个收发室。 当收发室 收到从外 单位寄 来 的公 文 时 ， 则 要完成 “ 分用
都 “ 复用
功(cid:7126) ， 即
按照信 封 上 写明的本机构的部门 地址把公 文 正确进行交付。

“

“

运输层的 复 用 和 分用功(cid:7126)也是类似的。 应用层所有的应用进程 都可以通过运输层再传

送到 IP层 （ 网络层）， 这 就是 复 用 。 运输层从IP层收到发送给各 应用进程的数据后 ， 必须
分别 交付指明的各 应用进程 ， 这 就是 分用 。 显然 ， 给应用层的每个应用进程赋 予 一个非常明
确的标志是 (cid:7171) 关重要的。

我们知道 ， 在单个计算机中的进程是 用进程标 识 符（ 一个不大的整数） 来 标 志的。 但
是 在互 (cid:7110) 网环境下 ， 用计算机操作系统所指派的这种进程标 识符来 标 志运行在应用层的各种

应用进程 则是不行的。 这 是 因 为在互(cid:7110)网上使用的计算机的操作系统种类很多 ， 而不 同 的操

作系统 又使用不 同 格式的进程标识符。 为了使运行不 同 操作系统的计算机的应用进程(cid:7126)够互
相 通信 ， 就必须用 统一的方法（ 而这种方法必须与特定操作 系 统无关） 对 TCP/IP 体系的应
用进程进行标 志。

但是 ， 把一个特定机器上运行的特 定进程 ， 指明为 互 (cid:7110) 网上通信 的最后 终点是 不可行
的。 这 是 因为进程的创 建和撤 销 都是 动 态的， 通信的一方几乎无法知道和识 别 对方机器上的
进程。 另 外 ， 我们往往需要利用目的主机 提供的功(cid:7126)来 识 别 终点， 而不需要知道具体 实现这
个功(cid:7126)的进程是哪 一个 （ 例如， 要和互 (cid:7110)网上的某个邮件服 务器(cid:7110)系， 但并不一定要知道这
个服务器功(cid:7126)是由目的主机上的哪 个进程实现的）。

抽 象的

解决这个问题的方法很巧 妙 ， 就是 在应用层和运输层之间的 界 面上 ， 设置 一个特 殊的
“ 门 ”。 应用层中的应用进程要通过运输层发送到 互 (cid:7110) 网 ， 必须要通过这个 门 。 而别
的主机上的应用进程要寻找本主 机中的某个应用进程 ， 也必须通过这个 门 。 这样 ， 我们就可
以把应用层和运输层的界面上这 些 “ 门
， 设为通信的抽 象 终 点 。 这 些抽 象终点的正 式 名 称
就是 协议端 口 ( protocol port ) ， 一 (cid:7182)就简称 为端 口 ( port )。 每一个端口用 一个称为端 口 号( port
numbe r)的正 整数 来 标 志 。 主机的操作系统 提供 了接口机制， 使得进程(cid:7126)够通过这种机制找
到 所要找的端口。

“

请 注 意 ， 这种在协议栈层 间 的 抽 象 的 协议端 口 是软件端 口 ， 和路由器或 交换 机上的硬

件 端口是 完 全不 同 的概 念。 硬件端口是 不 同 硬件设备进行交互的接口， 而软件端 口 是应 用 层

的 各种协议进程与 运输实体进行层 间 交互 的 地点。 不 同的系统 具 体 实现端口的方法可以是 不
同的 （ 取决于系统使用的操作系统 ）。

当 应用层要发送数据时 ， 应用进程就把数据发送到 适当的端 口， 然后运输层从 该 端口

读取数据 ， 进行后 续的处理 （ 把数据发送到目的主机）。 当运输层收到对方主机发来 的数据
时 ， 就把数据发送到适当的端口 ， 然 后应用进程就从该端口读取这 些数据。 显然 ， 端口必须
有一定容量的缓存来 暂时存放数据。

在后 面将讲到的 UDP和 TCP的首部格 式中（图 5-5 和图 5- 14) ， 都有源端 口 和 目 的端

口 这 两个重要字段。 这 两个端口就是运输层和应用层进行交互的地点。

TCP/IP的运输层用一个1 6 位端 口 号 来 标志 一个端口。 但 请注 意 ， 端 口 号只 具有本地意
义 ， 它只是 为了标 志 本计算机应用层中的各个进程在和运输层交互时的层间接口。 在互(cid:7110)网

不 同 计算机中， 相 同 的端口号是 没 有 关(cid:7116)的。 1 6 位的端口号 可 允 许有 65535 个不 同 的端口

•  214  •

号 ， 这个数 目对 一个计算 机来 说是足 够 用 的。

由此可见， 两个计算 机中的进 程 要互 相通信， 不仅必须知道对方的IP地址 （为了找到
对 方的计 算 机）， 而且 要知道对方的端 口 号 （为了找到 对 方 计 算 机中的应用 进 程）。 这 和我
们 寄 信 的过程类似。 当我们 要给 某 人 写 信时， 就必须 在信 封上 写 明他的 通信 地 址 （这 是为
了 找到他的住所， 相当 于IP地址）， 并 且 还 要 写上收 件 人的姓 名 （这 是因为在同一住所中可
能 有好几个 人， 这 相当千 端 口号）。 在信封 上 还应写 明 自 己的地址和姓 名 。 当收 信 人 回 信时，
很 容 易 在信 封上找到发 信 人 的地址和姓 名 。 互联网上的计 算 机 通信是采用 客 户 －服务 器方式。
客 户 在发 起 通信 请求时， 必须先知道对方服务器的 IP地址 （用来找到 目的 主机） 和端 口号
（用来找到目的进 程）。 因此运输 层的端 口号 分为下面的 两 大 类。

(1) 服 务 器 端 使 用 的端 口 号

这 里又 分为 两 类， 最重 要的一 类 叫 作熟知端 口 号(well-
known  port  number)或全球通用 端 口 号， 数值为0~1023。 这 些熟知端 口 号最初公布 在文档中
[RFC 1700,  STD2]， 但后来因为互联网发展太快， 这种标准 文 档无法随时更新， 因此在 RFC
3232 中就把 RFC1700列为陈 旧 的， 而当 前最新的熟知端 口 号可 在网 址 www.iana.org 上 查到。
IANA把这 些熟知端 口号指派给了 TCP/ IP最重要的一些应用 程序， 让所 有的用 户 都知道。
当 一种新的应用 程序出现后，IANA 必须为它指派一个熟知端 口 ， 否则互联网上的其他 应用
进 程就无法和它 进行 通信。 和电话 通信对 比， 熟 知 端 口 号 相当 千所有 人 都应知晓的重 要 电话
号码， 如报警 电话 110, 急救 电话 120 等。

5-2 给出了 一些常用 的熟知端 口 号。

表

表 5-2 常用 的熟知端 口 号

应 用 程序 I  FTP

I  TELN ET

I  SMTP

I  DNS

I  TFTP

I  HTTP

I  SNMP

I  SNMP (trap)

I  HTTPS

熟 知 端 口 号 I

2 1

23

25

53

69

80

1 6 1

1 62

443

另 一 类 叫 作登记端 口 号， 数值为 1024~49151。 这 类 端 口号是为没有熟知端 口号 的应用

程序 使用 的。 要 使用这 类端 口 号必须 在IANA按照规 定的手 续登记， 以 防 止 重 复。

(2) 客户 端 使 用 的端 口 号

数值为 49152~65535。 由于这 类端 口号 仅 在客 户 进 程运行
时才 动 态 选择， 因此又 叫 作短 暂 端 口 号 ＠。 这 类端 口 号就是临时端 口号 ， 留给客 户 进 程选择
临时 使用 。 当 服务 器进 程收 到 客 户 进 程的报文时， 就知道了客 户 进 程所使用的端 口号 ， 因而
可 以把数据发送给客 户 进 程。 通信结束后， 刚才已使用过的客 户 端 口 号就被 系 统收 回 ， 以便
给其他 客 户 进 程 使用。

下 面 将 分别讨论UDP和 TCP。 UDP比 较简 单， 本 章 主要讨论TCP。

用 户 数据报协议

5 . 2

U D P

5 .2. 1  UDP 概述

用户 数据报协议 UDP只在IP的数据 报 服务之上增加了 很少一 点的功能，

这 就是复 用 和分用 的功 能 以及 差错检测的功 能。 UDP的 主要特点是：

视 频 讲 解

CD 注 ： 短 暂 端 口 (ephemeral port)[STEY94, p . 1 3]表示这种端 口 的存 在 时 间 是短 期 的 。 客 户 进 程 并 不在 意 操 作 系 统给它分配的

是 哪

个 端 口 号 ， 因 为客 户 进程之所 以 必 须 有

个瑞 口 号 （ 在 本地主 机 中 必 须 是 唯

的 ） ， 是 为 了 让运输层 的 实体 能 够 找 到 自 己 。

这和熟知 端 口 不 同 。 服 务 器 机 器

接通 电 源 ， 服 务 器 程 序 就运 行起来。 为 了 让 互 联 网 上 所 有 的 客 户 程序都能找到服务器程序 ， 服

一

一

务 器程序所使用 的端 口 （ 即 熟 知端 口 ） 就 必 须 是 固 定 的 ， 并 且 是众所周 知 的 。

一

一

•  215  •

