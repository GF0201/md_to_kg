5 . 3   传输控制协议 TC P 概述

由千 TCP 协 议比较复杂 ， 因 此 本(cid:7188) 先对 TCP 协议进行一(cid:7184)的介 绍 ， 然

后再逐步深入讨 论 TCP 的可靠 传 输 、 流量控 制和拥 塞控制等问题。

5 .3 . 1   TCP

扫 - - 扫

视频讲解

最主 要 的 特 点

TCP 是 TCP/IP 体系中非 常 复杂的一个协议。 下面介 绍 TCP 最主要的特点。
(

)  TCP 是 面 向 连 接 的 运输层协议。 这就是说 ， 应用程序在使用 TCP 协议之前， 必须先
建立 TCP 连接。 在传送数据完 毕后， 必须释放 已经建立的 TCP 连接。 也就是说 ， 应用进程
之 间的通信好像在

： 通话前要先 拨 号 建 立连接， 通话结束后要挂机释放连接。

“ 打 电 话

”

(2) 每一条 TCP 连接只 (cid:7126)有两个端 点(endpoint) ， 每一条 TCP 连接只 (cid:7126)是 点对点的（一

对一）。 这个问题后面还要进一 步 讨 论。

(3)  TCP 提供可靠交付的服务。 通过 TCP 连接传送的数据 ， 无差错 、 不丢 失 、 不重复 ，

并且按 序到达。

(4)  TCP 提供 全双工通信 。 TCP 允 许 通信 双 方的应用进程在任 何 时候 都(cid:7126)发送数据。
TCP 连接的两端 都设有发送级存和接收 缓存， 用来 临 时存放双向通信的数据。 在发送时 ，
应用程序在把数据传送给 TCP 的缓存后， 就可以做 (cid:7151) 己的事 ， 而 TCP 在合适的时候把数据
发送出去。 在接收 时 ， TCP 把 收到的数据放入 缓存， 上层的应用进程在合适的时候读取缓
存中的数据。

“

面向字(cid:7188)流

(5) 面 向 字(cid:7195)流。 TCP 中的 “ 流 ”

(stream)指的是 流入到进程或从进程流 出 的 字(cid:7195)序列。
” 的含义是： 虽然 应用程序和 TCP 的交 互是 一次一个数据块（大小不等） ， 但
TCP 把应用程序 交下来 的数据仅仅看成是 一 连串 的无结构 的字(cid:7195)流。 TCP 并不知道所传送的
字(cid:7188)流的含义。 TCP 不保证接收 方应用程序所 收到的数据块和发送方应用程序所发出的数据
块具有对应大小的关系（例如， 发送方应用程序交给发送方的 TCP 共 1 0 个数据块 ， 但接收
方的 TCP 可(cid:7126) 只 用了 4 个数据块就把收到的字(cid:7188)流交付上层的应用程序）。 但接收 方应用程
序 收到的字(cid:7188)流必须和发送方应 用程序发出的字(cid:7188)流 完 全 一样。 当然 ， 接收方的应用程序必
须有(cid:7126)力 识 别 收到的字(cid:7188)流 ， 把它还原成有意 义的应用层数据。 图 5-7 是 上述概念的示 意 图。

送 方

发

匾 应用 进程

字 节 流

回 表示 TCP 报 文段的首 部

曰 表示 序 号 为 x 的数据字节

＿

0－

流节

字

＿

l_

2一

3一

TCP连接像

条管道 ， 把字节流可靠地按序

送到 目 的进程

一

图 5-7 TCP 面 向 字节 流 的 概 念

传

•  2 1 9  •

1

为了突出示 意 图的要点， 我 们 只 画出了一个方向的数据 流。 但请 注 意 ， 在 实 际的网络

中 ， 一个 TCP 报 文 段包含上千个字(cid:7188)是很常 见的， 而图中的各部分都只画出了几个字(cid:7188) ，

“

面向字(cid:7188)流 ” 的概念。 另 一点很重要的是： 图 5-7 中的 TCP
这 仅仅是 为了更方便地说明
连接是一条虚连接 （ 也就是逻辑连接 ） ， 而不是 一条真 正的物理连接。 TCP 报 文 段先要传送
到 IP层 ， 加上IP首部后 ， 再传送到数据 链路层；再加上数据 链路层的首部和尾部后 ， 才 离
开主机发送到物理链路。

从图 5- 7可看出， TCP和 UDP在发送报文 时所 采用的方式完 全不 同 。 TCP并 不关心应
用进程一 次把多长的报文发送到 TCP 的缓存中 ， 而是 根据对方给出的窗口值和 当前网络拥
塞 的程度（后面还将 深入讨 论） ， 来决定 一个报文段应包含多少个字(cid:7188) ( UDP 发送的报文 长
度是应用进程给出的）。 如果应用进程传送到 TCP缓存的数据 块太长 ， TCP就可 以把它 划 分
为短一 些的数据 块 再传送。 如果应用进程一次只发来 一个字(cid:7188) ， TCP 也可以等 待 积 累 足够
多的字(cid:7188)后再构成报文 段发送出去。 关千 TCP报 文 段的长度问题， 在后面还要进行讨论。

5 .3.2  TCP 的 连接

TCP把连接作为最 基 本 的 抽 象。 TCP的许多特 性都与 TCP是 面向连接的这个基本特 性

有关。 因此我们对 TCP连接需要有更清 楚的了解。

前面 已经讲过， 每一条 TC P 连接有两个端点。 那么， TCP连接的端点是 什么呢 ？ 不是
主机 ， 不是主机的 IP地址 ， 不是应用进程 ， 也不是运输层的协 议 端 口。 TCP连接的端点叫

作套接字( s ocke t )或插 口 。 根据 RFC 793的定 义： 端 口号 拼接到( concate nate d with ) IP地址即

构成了套接字。 因此 ， 套 接字的表示 方法是在点分十进制的 I P 地址后面写 上端口号 ， 中 间
用 冒 号或 逗 号 隔 开。 例如 ， 若 IP地址 是 1 92 .3.4 .5 而端 口号是 80 , 那么得到的套接字就是

( 192 .3.4 . 5 :  80 )。 总 之 ， 我们有

套接字 s ocke t =  (IP地址： 端口号）

( 5- 1)

每一条 TCP 连接唯一地被通信 两 端 的 两个端点 （即 套接字对 s ocke t pair ) 所确定。 即 ：

TCP连接 ： ： ＝ ｛s ocke t 1 ,  s ocke t2 }  =  { (IP1 :   port1

),  (IP2:  port2 )}

( 5-2

)

这 里 IP1 和 IP2 分别 是两个端点主机的IP地址 ， 而 port1 和 port2 分别 是 两个端点主机中

的端口号。 因此， TCP连接就是 两个套接字 s ocke t 1 和 s ocke t2 之 间的连接。 套 接字 s ocke t 是
个很抽 象的概念 ， 在下一 章的 6 . 8 (cid:7188)还要对套接字进行更 多的介绍。

总 之 ， TCP 连接就是 由协 议 软件 所提供的一种抽 象。 虽 然 有时为了方便， 我们也可以
说 ， 在一个应用进程和另 一个应用进程之 间 建立了一条 TCP连接， 但一定 要记住： TCP 连
接 的 端点 是个很抽 象 的 套 接字 ， 即 ( IP 地址 ： 端 口 号）。 也还应记住： 同 一个 IP 地址可以
有多个不 同的 TCP连接， 而 同 一个端 口号也可以出现在多个不 同的 TCP连接中。

本来 s ocke t 的意 思就是 插座（或插 口 ）。 选用 s ocke t 这个名 词是相 当准确的。 其实 一条
TCP 连接就像 一条 电 缆 线 ， 其两端 都各带有一个插 头。 把每一 端的插 头 插入位千主机的应
用层和运输层之 间 的插 座 ( s ocke t )后 ， 两个主机之 间 的进程就可以通过这条 电 缆 线进行可靠
通信 了。 但插座这个 名 词很容易 让 人 想起来 是个硬件 ， 而 s ocke t 是个软 件 名 词 ， 这样 ＂ 套
接字

就成为 s ocke t 的标 准 译 名 了。

”

请 注 意 ，

s ocke t 这个名 词有时容易使人把一些 概 念 弄 混淆 ， 因为随 着 互(cid:7110)网的不断发展

• 2 20

•

以及网络技术的进 步， 同 一个名 词 socket 却可表 示 多 种 不 同的意思。 例如：

(1) 允 许 应用 程序访问连网协议的应 用 编程接 口 API (Application Program m ing Interface),

即运输 层和应用 层之间的一种 接口， 称为socketAPI, 并 简 称为socket。

(2) 在 socketAPI 中使用的一个函 数名 也叫作 socket。
(3) 调用 socket 函 数的端点 称为socket, 如 “ 创 建一个数据 报 socket ”。
(4) 调用 socket 函 数时，其返 回 值 称为socket 描述符， 可简 称为socket。
(5) 在操作系 统 内 核中连网协议的Berkeley 实现， 称为socket 实现。
上 面的这些 socket 的意 思 都 和本章所引 用的 RFC 793 定义的 socket （ 指端 口号 拼 接到

IP地址） 不 同。 请读者加 以注意。

5.4  可靠传输 的 工作原理

我们知道， TCP发送的报 文 段是交给IP层传送的。 但IP层只能提供尽最大努力 服务，
也就是说 ， TCP 下 面的网络所提供的是不可靠的传 输。 因此， TCP必须采用适当的措施 才
能 使得 两个运输 层之间的 通信 变 得 可靠。
理想的传输条件 有 以下 两个特点 ：
(1) 传输信道不产生差错。
(2) 不管发送方 以多 快的速 度发送数据 ， 接收方总是来得及 处理收到的数据 。
在这样的理想传输条件下， 不需要采取 任何措施就能够 实现可靠传输。
然 而实际的网络 都 不具备 以上 两个理想 条件。 但我们 可 以 使用一些可靠传 输 协 议， 当
出现差错时让发送方重传出现差错的数据 ， 同时在 接收 方来 不及 处理收 到的数据时， 及时告
诉发送方适当降低发送 数据 的速率。 这样一来， 本来不可靠的传输信道就能够 实现可靠传输
了。 下面从最简 单的停止等待 协议 气井起。

5 .4. 1  停止等待协议

全双 工 通信 的双 方 既是发送方也是接收方。 下面为了讨论问题的方便， 我们仅考 虑 A
发送 数据 而B 接收 数据 并 发送确认。 因此A 叫作发送方， 而B叫作接收方。 因为这 里是讨
论可靠传输的原理， 因此把传送的数据 单元都称为分组， 而 并 不考虑 数据 是在哪一个 层次上
传送的气 “ 停 止等待 ” 就是每发送完一个分组就停 止发送， 等待 对方的确认。 在收到确认
后再发送下一个分组。

1 . 无差错情况

停 止等待协议可用 图 5-8 来 说 明。 图 5-8(a)是最简 单的无差错情况。 A发送分 组M l ， 发
完就暂停发送， 等待 B的确认。 B收到了M 1 就 向 A 发送确认。 A 在收到了对M 1 的确认后，

O 注 ： 在 计算 机 网 络 发展初期 ， 通信 链 路 不 太可靠， 因 此在链路层传送数 据 时 都要 采 用 可 靠 的 通信 协议。 其 中 最简 单 的 协

议就是这种
层 使 用 的可靠传输协 议 要 复 杂 得 多 （ 见后 面 5.6 节 ）。

停止等待协议

“

”

。 在运输层 并 不 使 用 这 种 协议 ， 这里 只 是为 了 引 出 可靠传输 的 问 题才从最简 单 的 概念讲起 。 在 运 输

＠ 注 ： 运输层传 送 的 协 议 数据 单 元 叫 作 报文段 ， 网络层传 送 的 协议数据单元 叫 作 IP 数据报 。 但在

般讨论 问 题 时 ， 都 可

把 它 们 简 称 为 分组。

一

• 221 •

