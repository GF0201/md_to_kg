第 4 章 网 络层

本章讨论网络 互连 问题。 在介 绍网络 层 提供的两种服务和两个 层 面后， 就进入本章的

一

IP,

IP

核心 内 容 网 际协议

这是本 书的

个重点 内 容。 只有 深入地掌握了协议

ICMP

的 主 要 内

容， 才能 理解 互联网是 怎样工作 的。 本章还 要讨论网 际控制 报 文协议
IP

1Pv6

VPN

、 几种常用 的路

由 选择协议 、
NAT

的 主要特点 、

多 播 的概念等。 在讨论 虚拟 专用网
SDN

MPLS

和网络地 址转换

后， 最 后简单介绍多协议标签 交换

和 软件 定 义 网络

的基本概念。

本章最 重要的 内 容是：

(1) 虚拟 互 连网络和 两种服务 、 两个 层 面 的概念。

(2)  IP

MAC

(3)

地 址 与

地 址 的关系。

IP

CIDR

传统分类 的

地 址和无分类域间路 由 选择

（后 者是重点 ）。

(4) 路 由 选择协议的工作原 理。
4 . 1  网 络层的几个重要概念

4. 1 . 1   网 络层提供的两 种 服 务

“

”

“

”
在计算机网络 领域， 网络 层 应 该 向 运输 层 提供 怎样 的服务

(

面向连接

还 是

无连

接

) 曾 引 起 了 长期的 争论。 争论 焦点的实 质就是： 在计算机通信中， 可 靠 交 付 应 当 由 谁来

负 责 ？是网 络还是 端系统 ？

C

有些人 认为 应 当 借助千 电信网 的成 功经 验， 让 网 络 负 责可 靠 交 付

大 家 知道 ' /传统电

信网的 主 要 业务是 提供电话服务。 电信网使 用 昂 贵的程 控 交换机（ 其 软件也 非常复杂 ）， 用

面 向连接 的通 信 方式， 使电 信 网络能够向用 户（实 际 上 就 是电话机 ） 提供可 靠传输 的服务。

因此 他 们 认 为， 计算机网络也 应 模 仿 打电 话所使用的 面向连接 的 通信方式。 当两台计算机进

一

Q)

行通 信时， 也 应当先 建 立连接（ 但在分 组 交换中是 建立

一

条虚电路 VC(Virtual  Circuit)

) '

以 预 留 双方通信所需的

切 网络 资 源。 然后 双方 就沿着 已 建立 的 虚电 路发送分 组。 这 样的分

一

组的首部不需要 填 写完 整的目 的主机地 址， 而 只需要 填 写这 条 虚电路的编号 （

个不 大的 整

数 ）， 因 而 减 少了分 组 的 开 销。 这种 通信方式如 果 再使用可 靠传输 的 网络协议， 就 可 使 所发

送 的分 组无差错按序 到 达 终点， 当 然也不 丢 失 、 不重复。 在通信结 束后要 释放 建立 的 虚电路。

2

图4-l (a)是网络 提 供 虚 电路服务 的 示意 图。 主机 凡和 H

之间 交换的分 组 都必 须在 事先 建立

的 虚电路上传送。

一

但互 联网 的 先 驱者 却 提出

种 崭 新的网络设计 思路。 他们 认为， 电 信网 提供的 端 到 端

可 靠传输 的服务 对传 统的电话 业务 无疑是很 合 适的， 因为 那时电信网 的 终 端 （电话机 ） 非常

印 注 ： 虚 电路 表 示 这 只 是 一 条逻辑上 的 连 接 ， 分组都沿着这条逻辑连接 （ 好像 是 一 条物理连接 ） 按 照 存储 转 发 方 式 传 送 ，

而 并不是真正建立 了 一 条物理连接 。 请 注 意 ， 电路交换 的 电 话通信 是 先 建立 了 一 条 真 正 的 连接 。 因 此 分 组 交 换 的 虚连接 和 电路 交

换 的 连 接 只 是类似而 已 ， 并 不 完 全 一 样 。

• 115 •

简单， 没有 智能， 更没有差错处理能力。 因此电信网必须 负 责把用户电话机话 筒产生的话音

信号可 靠地传送到对方的电话机， 使 其 耳机发出的 声 音符 合话 音 质量的技术规范要 求。 但计

算机网络的端系统 是有 智能的计算机 。 计算机有很强的差错处理能力 （这点和传 统的电话机

有本 质上的差别）。 因 此， 互 联网 在设 计 上就采用 了和电 信 网完 全不同的 思路。

互 联网采 用的设计思路是这 样的： 网络 层 要 设 计 得 尽 量 简单， 向 其 上 层 只 提 供 简单灵

“

”

活的 、 无连接的 、 尽 最 大 努 力交付的 数据 报 服 务 气 这 里的

数据 报

(datagram)是 互 联网

“

”

的设计者最初使 用的名 词， 其实数据 报 （或 IP 数据 报） 就是我们经常 使用的

分 组

。 在 本

一
书中， IP 数据 报和 IP 分组 是 同 义 词 ， 可 以混用 。

网络在发送分 组时 不需要 先 建立连接。 每

个分 组（也就是 IP数据 报 ） 独 立发送， 与

其前后的分 组 无关（ 不进行编号 ）。 网络 层 不提 供 服 务 质 量的 承诺。 也就是说， 所传送的分

组可能出 错、 丢 失、 重复和 失序（ 即 不 按序到达 终点 ）， 当然也 不 保证分 组交付的时 限。 由

千传输网络 不 提供端到端的可 靠传输 服务， 这就使 网 络中 的路 由器比较简单， 且 价格低 廉

（与电信网的 交换机相比较）。 如 果主 机（ 即端系统 ） 进程之间 需要进行可 靠的通信， 那么
就 由 主 机中的 运输 层 负 责 （包括差 错 处 理 、 流量 控制等 ） 。 采用这种设计 思路的好处是 ： 网

络 造价 大 大 降低， 运 行方式 灵 活， 能够适应多种 应用。 互 联网能够发 展到 今 日的规模， 充分

证 明了当初采用这 种设计思路的 正确 性。

1

图 4- l(b)给出了 网络 提供数据 报服务的示 意图。 主机 H

向 H2发送的分 组各自 独 立地 查

找路 由器中的 转发 表， 逐 跳传送到 目的 主机。 在分 组传送的过程中有 丢 失的可能。

(a) 虚 电路 服 务 （ 所 有的数据都 在 此 虚 电 路 上 传送 ）

Hi,I

,,,

已/:－

(b) 数据报 服 务 （ 数据 传送的路 径 是 不 确 定的 ）

图4- 1 网 络层提供的两种 服 务

OSI体系的 支 持者 曾 极 力 主 张在 网 络层使用可 靠传输的 虚电路 服务， 也 曾 推出过网络 层

虚电路 服务的 著名标准

ITU-T的 X.25 建议 书。 但现 在 X.25 早 已成为 历 史 文 献了。

表 4-1 归 纳了 虚电路 服务与数据 报服务的 主要 区别。

切 注 ： 尽 最 大 努 力 交付(best effort  delivery) 当 然 不表示路 由 器 可 以 任 意 丢 弃分组， 但 这 种 交 付方式实质 上就是不可靠交付。

一

“

＂

，

顺便提

下 ， 文献中 也常使用

尽 力 而为

的 译 名 。 这 个 译 名 固 然较为简洁

但似不够准确 。

• 116  •

对 比 的 方面

表 4-1 虚 电路服务与数据报服务的 对 比

虚 电路服务

数据报服务

思 路

可靠通信应 当 由 网 络 来 保 证

可 靠 通 信 应 听 旧 用 尸 主 机来 保 证

连 接 的 建 立

必 须 有

小 点 要

终 点 地址

分 组 的 转 发

仅 在 连 接 建 立 阶段使用 ， 每个 分组 使 用 短 的 虚 电 路 号 旬 个 分 组 都有 终 点 的 完 整 地址 ， 即 IP 地址

属 千 同 一 条 虚 电 路 的 分组均 按 照 同 一 路 由 进行 转 发

每 个 分 组 独立合找转 发 表 进 行 转 发

当 节 点 出 故 障 时

所有通过 出 故 障 的 节 占 的 虚 电 路均 不 能 工 作

出 故 障 的 节 点 可 能 会 工 失 分 组 ， 一 些 路 由 可 能

分 组 的 顺 序

总 是 按发送顺序 到 达 终 占

到 达终 点 的 斯i 序 小 一 定 按 发 送 的 顺 序

端 到 端 的 差 错 处 理

可 以 由 网 络 负 责 ， 也 可 以 由 用 户 主 机 负 责

由 用 户 主 机 负 责

会 发 生 变 化

和流量控制

4. 1 .2  网 络层的两个层 面

在上 面 4.1 .1 节中， 我们 已 经 讲过， 不同网 络中的 两个 主机 之 间的 通信， 要 经过 若干个

一

路 由 器转发分 组来 完成， 分 组查 找路 由 器中的转发 表， 从 指明的接 口转发 到 下

个路 由 器 。

但转发 表是 怎样 得出的 呢 ？是从路 由 表 导出的， 而路 由 表又是 山 互联网中 许 多的路 由 器， 按

照 共同 选定的路 由 选择协议， 通过许多 次的相互交换路 由信息 而 产生的 。 由此可见， 在路 由

器 之 间传送的 信息有以 下 两 大类：

一

第

类是 转发源 主机和目的 主机之 间 所传送 的 数据， 把 源 主机所 发送的 分组， 像接力

一

一

赛 跑 那样从

个路 由 器转 发到 下

个路 由 器， 最后 把分 组传送 到目的 主机 。

第 二类则是传送 路 由信 息， 是 根据路 由 选 择协议所 使用的路 由 算 法， 彼此不 断地交换

一

一

路 由信息分 组 ， 目的是为了在路 由 器中 创 建路 由 表 ， 并 由此 导出为转发分 组而用的转发表 。

这

类信息的传送是为 第

类数据的传送服务的 。

用图4-2的方 法来描述， 也就是把网络层 抽 象地 划分为 数据 层 面（或 转发层 面 ）和 控制

＂

＂

层 面 。 这 里所说的

层 面(plane) "和体系结 构中的

”

“
“
层 次(layer) "很相 似， 都是 抽 象的概念 。

”

此处的 plane目前 国 内 尚 无标准 译名， 也可以 译为

面

。 曾有人 译为

平面

， 但本 书不采

“

”

用这个 译名， 因为这容 易 联 想到是 几 何学中的平面 （ 其实与这 种平面并 无关 联 ） 。 名词

层

一

面

是目前 文 献中通用的 抽 象术语 。 在

个路 由 器实体 中 ， 显 然 无法看见这种 抽 象的层面 。

控制层面
- - - - - - - - - - - -
数 据 层 面

这 两个层 面的机制相差很 大 。 在数据层 面中， 每

个 路 由 器 根据本路 由 器生成的转发

图 4-2 网 络层 的 数据层面 和 拧 制 层 面

一

表， 把 收到的分 组， 从 查 找 到的对 应接口转发出 去 。 为了 加 快转发的速率， 现在的路 由 器通
个分 组的时 间 为纳秒 ( 10 -9 秒 ） 数量级 。 但 在 控制层面中的

常都采用硬件进行转发， 转发

一

•  1 1 7  •

情况则 不 同 。 一个路 由 器不可能独 自 创建出路 由表 。 路 由 器 必 须和相 邻的路 由 器经常交换路
山 信 息 ， 然后才能创建出本路 由 器的路 由 表 。 根据路 由 选择协议所 用的路 由算法计算 路 由 要
使 用软件， 这就慢多 了 ， 一般是 秒的数昌级 。 从以上所述不难看出， 数据层 面 的问题比较单
纯 ， 因 为路 由 器在转发分组时， 是独立地根据本路 由 器的转发表转发分组的 ， 但控制层面就
比较 复 杂 ， 因 为路 由 器要创建 路 由表 ， 就必须 依 靠 许多路 由 器协同动作 。 不 同 的路 由 选择协
议定义 了 不 同 的协 同 动 作方式。 路 由 器的生 产 厂 家 在制造路 由 器时， 已 经在路由 器内部嵌入
了 路 由 选 择的通信 模块 ， 使 得 路 由 器之间能够按 照 路 由 选择算法进 行 相 庄 之间的通信 。

从互联网 诞 生 之日 起 ， 路 由 器就 是 按 照 图 4-2 所示的模式工 作的。 本教材过去的几个版

本在讲解 路 由 器的结构时 ， 虽 然没有使 用控制层 面和数据 层 面的概念 ， 但 已经把路 由 器划分

为路 由 选择和分组转发两大部分。 其 实这两 部分的位置就 分 别 处在图 4-2 所示的控制层面和

数据层 面 之中 。 现在介 绍 网 络层 中 控制层面和数据层面的概念 ， 是 因 为最近在网络界提出的
软件定 义 网络 SDN ( Softwa re Defined  Netwo rk f' ， 正 在对这两个层 面的结构进行 了 重大的改
变 。 图4-3 就是 SDN 提出的这两个层 面 的 构 成 。

远 程 控 制 器

控制层面
.. ．· - 一 ·伞 一 一 - - - - -
数据层面

图 4-3 软 件 定 义 网 络 SON 中 的 控 制 层 面 和 数据 层 面

我们注 意到， 在传统的互联 网 中 ， 每一个 路 由 器 中 ， 既有转发表又有路 由 选择软件， 因
此在 图 4-2 中 所 画的虚线长方形方框 也 强 调 了 这个特点 。 也就是说 ， 每个路 由 器 中 ， 既有数
据层面 也有控制层 面 。 但在 图 4-3 所示的 SDN 结构 中 ， 所有的路 由 器都变简单了 。 路 由 器
中 的路 由 选择软件都不存在 了 ， 因 此路 由 器之间不再 相 互交换 路 由 信 息 。 在网 络的控制层 面
有一 个在逻 辑上集 中 的远程控制器 （ 但在物 理上可以 由 不 同 地 点 的多个服务器 组 成 ） 。 远 程
控制 器 掌 握各主机和整个 网 络的状态 ， 能够为每一个分组计算出最 佳 的 路 由 ， 然后在每一个
路 由 器 中 生 成 其 正 确 的转发表 。 路 由 器的工 作 很单纯 ， 即收 到 分组 ， 查找转发表 ， 转发分组。
这样 ， 网 络又变 成 为集 中 控制的 。 本来互联网 是 分散控制 的 ， 为什么现 在又提出集 中
控制呢 ？ 其实， 软件定义 网 络 SDN 的提出 ， 并非 现在要把 整 个互联网 都改造为如图 4-3 所
示的集 中 控制模式， 这是不现 实的。 然 而 在 某些具体条件下 ， 特 别 是像一 些大型的专 用数据
中 心 之间的广 域 网 ， 若使 用 SDN 模式来建 造 ， 就可以使 网 络运行的效率提 高 ， 同 时还可以
获 得 更好的经 济 效益 。 因 此 ， 建议读 者关注这一新动向。 在本书4.10 节将 简要介绍 SDN 。

下面 我们 仍 然 按 照 传统互联网 的机制 ， 陆续介绍 属 千 数据层 面的协议 IP, 然后再讨论

CD 注： 目 前 文 献 上 出 现的名 词 SDN 尚 无 公 认的权 威定义 。 而 SDN 的 英 文 写 法 也 还 有 另 外

种 ， 即 Software Defined

“

”

Networking , 按 照 这种 写 法 ， 中 文 的 译 名 似应 为
＂

“

软 件 定 义 的 连 网

， 即 突 出 强 调 了 连 网 的方式 。 考 虑 到 目 前 中 文 的 文 献 资 料 都

一

是使用

软 件定义 网 络

， 故本 书 也 采 用 这样的译 名 。

•  118  •

属 千控制层 面的各种路 由 选择协议 。
4.2  网 际协议 I P

网 际 协 议 IP (Internet  Protocol)是 TCP/IP 体系中 两 个 最主要的协议之

一

[STEV94]

[COME0 6][ FORO 10 ]， 也是最重要的 互联网标准协议之

[RFC 791 ,  STD5] 。 网 际协议 IP 又

一

称为 Kahn-Cerf协议， 因为这个重要协议 正是 Robert Kahn和 Vint Cerf 二人 共同 研发的 。 这

“

”

两位 学者在 20 0 4 年 获 得图灵 奖 （ 其地位相当于计算机 科 学 领域的

诺 贝 尔 奖

) 。 严格来说，

这里所 讲的 I P 其实是 IP的 第 4个 版本， 记为 IPv4 。 但在 讲述协议 IP的各种原 理时， 常 省
略 IP后 面的 版本号 。 在后 面的 4.5 节我们 再介绍较 新的 版本 IPv6（ 版本 1 ~  3和 版本 5都 未

一

曾使用过 。 顺便指出， 所 谓的 IPv9 只不过是某些人 故意的 炒作 而 已， 不 值

提） 。

与协议 I P 配套使 用的还有 三个协议：

•  地址解析协议 ARP (Address Resolution Protocol)
•  网际控制 报文协议 ICMP ( Internet Control Message Protocol)
•  网际组管理协议 IGMP (Internet Group Management Protocol)

一

本来还 有

个协议 叫作 逆地址解析协议 RARP
( Reverse  Address  Resolution  Protocol)， 是和协议

ARP 配 合使 用的， 但现在 已被 淘 汰不使用了 。

一

图 4-4 画出了这 三个协议和网 际协议 I P的关
层中， ARP 画在最 下 面 勹 因为 IP经

一

系 。 在这

常要使用这个协议 。

ICMP和 I GMP 画在 这

层的

上部， 因为它们 要使 用协议 IP 。 这三个协议将在

后面 陆 续介绍 。 由于网 际协议 I P 是用来使 互连 起

来 的 许 多 计 算 机 网 络 能够 进 行 通 信 的 ， 因此
“
TCP/IP体系中的网络 层常常被称为网际层 (internet
这 个名词的好处

layer)， 或 IP 层 。 使 用

网 际层

”

应 用 层

各 种 应 用 层 协 议

(HTTP,  FTP,  SMTP 等 ）

TCP, U DP

运输层

网 络 层

l  压三
（ 网 际 层 ）l

IP

网 络 接 口 层

与 各 种 网 络接 口

三

物理硬件
，
:_ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - _ _  :

图 4-4 网 际协 议 IP 及 其 配 套 协 议

“

”

是强调了 这是 由很多网 络 构 成的 互连网 络 。 目前比较普 遍使用

网络层

这个名词 。

在讨论网 际协议 IP之前， 必须了 解什 么是 虚拟 互连网络 。

4 .2. 1  虚拟互连 网 络

我们知道， 如 果要在 全 世 界 范 围内把数以 百 万计的网络都 互连 起来， 并

一

且能够 互相通信， 那么这样的任务

定非常复杂 。 其中 会 遇 到许多需要解 决

视 频 讲 解

的 问题， 如 ：

句 注 ： 在 互 联 网 标 准 中 ， A RP 彶 列 入 链 路 层 协 议 [ RFC 1 1 22 ,  STD3 ] ， 因 此 有 些 教 科 书 就 把 ARP 放 在 链 路 层 中 介 绍

[COME06]  [STEV94]  [ K U RO l  7] 。 但 是 A R P 并 不 知 道 自 己 是 处 在 协议 栈 的 哪 一 层 。 从 程序 调 用 的 关 系 看 ， AR P 实 际 上 处 在 链路

层 和 网 络 层 之 间 [ KOZI05 ] ， 但 不 少 著 名 教材 都 是 把 ARP 放 在 网 络 层 中 讲授 的 [TAN E I I ]  [PETE 1 2]  [FORO I O]  [STAL I O] 。 从 教学 的

观 点 看 ， 如 果 从 协 议 的 底 层 自 卜 往上讲授 ， 那 么 在 学 习 链 路 层 时 就 讲 解 ARP 的 工 作 原 理 ， 因 涉 及 到 I P 地 址 的 转 换 ， 似 不 易 理解 。

编 者 的 意 见 是 ， 既 然 协议 ARP 实 际 上 处 于 链 路层 和 网 络 层 之 间 ， 从 教 学法 的 角 度 考 虑 ， 对 千 自 底 层 计始 讲 的 教材 ， 放 在 网 络层

讲述似较为方便 。 实 际 上 ， 重 要 的 是 搞 沽 A R P 的 工 作 原 理 ， 不 必 过 千 纠 缠 ARP 究竟属 于 哪 一 层 。

• 1 19 •

